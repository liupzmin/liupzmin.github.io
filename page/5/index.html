<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="yandex-verification" content="3ac9ae36ddebb425">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"liupzmin.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.15.1","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="左手人文 | 右手科技">
<meta property="og:type" content="website">
<meta property="og:title" content="兔子先生">
<meta property="og:url" content="http://liupzmin.com/page/5/index.html">
<meta property="og:site_name" content="兔子先生">
<meta property="og:description" content="左手人文 | 右手科技">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="巴流">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://liupzmin.com/page/5/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/5/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>兔子先生 - 探寻计算机的历史与哲学密码</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="兔子先生" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">兔子先生</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">探寻计算机的历史与哲学密码</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档<span class="badge">60</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签<span class="badge">63</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="th fa-fw"></i>分类<span class="badge">32</span></a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="巴流"
      src="/images/gzh.jpg">
  <p class="site-author-name" itemprop="name">巴流</p>
  <div class="site-description" itemprop="description">左手人文 | 右手科技</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">60</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">63</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xpdXB6bWlu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;liupzmin"><i class="github fa-fw"></i></span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOmxpdXB6bWluQGdtYWlsLmNvbQ==" title="E-Mail → mailto:liupzmin@gmail.com"><i class="envelope fa-fw"></i></span>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i></a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2018/03/20/bigdata/logstash-consume-from-kafka-to-elasticsearch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/gzh.jpg">
      <meta itemprop="name" content="巴流">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
      <meta itemprop="description" content="左手人文 | 右手科技">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 兔子先生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/03/20/bigdata/logstash-consume-from-kafka-to-elasticsearch/" class="post-title-link" itemprop="url">利用logstash从kafka消费数据到elasticsearch</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-03-20 14:29:00" itemprop="dateCreated datePublished" datetime="2018-03-20T14:29:00+08:00">2018-03-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-07 09:32:12" itemprop="dateModified" datetime="2025-02-07T09:32:12+08:00">2025-02-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">大数据</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-几种方式"><a href="#1-几种方式" class="headerlink" title="1. 几种方式"></a>1. 几种方式</h2><p>目前要把kafka中的数据传输到elasticsearch集群大概有一下几种方法：</p>
<ul>
<li><p>logstash</p>
</li>
<li><p>flume</p>
</li>
<li><p>spark streaming</p>
</li>
<li><p>kafka connect</p>
</li>
<li><p>自己开发程序读取kafka写入elastic</p>
</li>
</ul>
<p>其中logstash看到网上说不太稳定，且我目前用过版本2.3 ，确实经常出现crash的情况，所以一开始并未考虑；首先尝试的是通过flume到es，因为目前kafka到HDFS中间用的是flume，想再加一个通道和sink到es，而且flume也有es的sink，但是我的flume是最新版1.8，elasticsearch也是最新版6.2.2，中间碰到了兼容性问题，未能成功；转而去研究kafka connect，按照《kafka权威指南》上的例子研究了一下，同样遇到兼容性问题，在我的版本组合中无法奏效，但我不想去修改已经安装好的flume或者es集群，spark streaming过于复杂，自己开发程序成本过高、且周期较长；最终去尝试logstash，结果配置非常容易，简单奏效，稳定性问题暂时无法看出，留待日后详测，现记录一下配置。</p>
<h2 id="2-logstash配置"><a href="#2-logstash配置" class="headerlink" title="2. logstash配置"></a>2. logstash配置</h2><h3 id="2-1-kafka-input-plugin"><a href="#2-1-kafka-input-plugin" class="headerlink" title="2.1 kafka input plugin"></a>2.1 kafka input plugin</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">input&#123;</span><br><span class="line">      kafka&#123;</span><br><span class="line">        bootstrap_servers =&gt; [&quot;192.168.1.120:9092,192.168.1.121:9092,192.168.1.122:9092&quot;]</span><br><span class="line">        client_id =&gt; &quot;test&quot;</span><br><span class="line">        group_id =&gt; &quot;logstash-es&quot;</span><br><span class="line">        auto_offset_reset =&gt; &quot;latest&quot; </span><br><span class="line">        consumer_threads =&gt; 5</span><br><span class="line">        decorate_events =&gt; &quot;true&quot;</span><br><span class="line">        topics =&gt; [&quot;auth&quot;,&quot;base&quot;,&quot;clearing&quot;,&quot;trademgt&quot;] </span><br><span class="line">        type =&gt; &quot;kafka-to-elas&quot;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中配置项<strong>decorate_events</strong> 颇为有用，如果只用了单个logstash，订阅了多个主题，你肯定希望在es中为不同主题创建不同的索引，那么<strong>decorate_events</strong> 就是你想要的，看官方解释：</p>
<h4 id="decorate-events"><a href="#decorate-events" class="headerlink" title="decorate_events"></a><code>decorate_events</code></h4><ul>
<li>Value type is  boolean</li>
<li>Default value is <code>false</code></li>
</ul>
<p>Option to add Kafka metadata like topic, message size to the event. This will add a field named <code>kafka</code> to the logstash event containing the following attributes: <code>topic</code>: The topic this message is associated with <code>consumer_group</code>: The consumer group used to read in this event <code>partition</code>: The partition this message is associated with <code>offset</code>: The offset from the partition this message is associated with <code>key</code>: A ByteBuffer containing the message key</p>
<p>大意是指定这个选项为<strong>true</strong>时，会附加kafka的一些信息到logstash event的一个名为<code>kafka</code>的域中，例如topic、消息大小、偏移量、consumer_group等，具体如下：</p>
<h3 id="Metadata-fields"><a href="#Metadata-fields" class="headerlink" title="Metadata fields"></a>Metadata fields</h3><p>The following metadata from Kafka broker are added under the <code>[@metadata]</code> field:</p>
<ul>
<li><code>[@metadata][kafka][topic]</code>: Original Kafka topic from where the message was consumed.</li>
<li><code>[@metadata][kafka][consumer_group]</code>: Consumer group</li>
<li><code>[@metadata][kafka][partition]</code>: Partition info for this message.</li>
<li><code>[@metadata][kafka][offset]</code>: Original record offset for this message.</li>
<li><code>[@metadata][kafka][key]</code>: Record key, if any.</li>
<li><code>[@metadata][kafka][timestamp]</code>: Timestamp when this message was received by the Kafka broker.</li>
</ul>
<p>Please note that <code>@metadata</code> fields are not part of any of your events at output time. If you need these information to be inserted into your original event, you’ll have to use the <code>mutate</code> filter to manually copy the required fields into your <code>event</code>.</p>
<blockquote>
<p>值得注意的是，在output的时候这些域的元数据信息并不是event的一部分，如果希望这些元数据插入到原生的event中，就需要利用<code>mutate</code>手动copy进event，我们接下来会在filter中利用<code>kafka</code>域的内容构建自定义的域。</p>
</blockquote>
<h3 id="2-2-构建-metadata-index"><a href="#2-2-构建-metadata-index" class="headerlink" title="2.2  构建[@metadata][index]"></a>2.2  构建<code>[@metadata][index]</code></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">   if [@metadata][kafka][topic] == &quot;auth&quot; &#123;</span><br><span class="line">      mutate &#123;</span><br><span class="line">         add_field =&gt; &#123;&quot;[@metadata][index]&quot; =&gt; &quot;auth-%&#123;+YYYY.MM.dd&#125;&quot;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125; else if [@metadata][kafka][topic] == &quot;base&quot; &#123;</span><br><span class="line">      mutate &#123;</span><br><span class="line">         add_field =&gt; &#123;&quot;[@metadata][index]&quot; =&gt; &quot;base-%&#123;+YYYY.MM.dd&#125;&quot;&#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">   &#125;else if [@metadata][kafka][topic] == &quot;clearing&quot; &#123;</span><br><span class="line"></span><br><span class="line">      mutate &#123;</span><br><span class="line">         add_field =&gt; &#123;&quot;[@metadata][index]&quot; =&gt; &quot;clearing-%&#123;+YYYY.MM.dd&#125;&quot;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;else&#123;</span><br><span class="line">      mutate &#123;</span><br><span class="line">         add_field =&gt; &#123;&quot;[@metadata][index]&quot; =&gt; &quot;trademgt-%&#123;+YYYY.MM.dd&#125;&quot;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   # remove the field containing the decorations, unless you want them to land into ES</span><br><span class="line">   mutate &#123;</span><br><span class="line">      remove_field =&gt; [&quot;kafka&quot;]</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>为每个主题构建对应的<code>[@metadata][index]</code>，并在接下来output中引用</p>
<h3 id="2-3-elasticsearch-output-plugin"><a href="#2-3-elasticsearch-output-plugin" class="headerlink" title="2.3 elasticsearch output plugin"></a>2.3 elasticsearch output plugin</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">output&#123;</span><br><span class="line">        elasticsearch&#123;</span><br><span class="line">               hosts =&gt; [&quot;192.168.1.123:9200&quot;,&quot;192.168.1.122:9200&quot;,&quot;192.168.1.121:9200&quot;]</span><br><span class="line">               index =&gt; &quot;%&#123;[@metadata][index]&#125;&quot;</span><br><span class="line">               timeout =&gt; 300</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动<code>logstash</code>就可以在<code>kibana</code>中观察到数据了。</p>
<h2 id="3-特殊的metadata"><a href="#3-特殊的metadata" class="headerlink" title="3. 特殊的metadata"></a>3. 特殊的metadata</h2><p><strong>The @metadata field</strong></p>
<p>In Logstash 1.5 and later, there is a special field called <code>@metadata</code>. The contents of <code>@metadata</code> will not be part of any of your events at output time, which makes it great to use for conditionals, or extending and building event fields with field reference and sprintf formatting.</p>
<p>The following configuration file will yield events from STDIN. Whatever is typed will become the <code>message</code> field in the event. The <code>mutate</code> events in the filter block will add a few fields, some nested in the <code>@metadata</code> field.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">input &#123; stdin &#123; &#125; &#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  mutate &#123; add_field =&gt; &#123; &quot;show&quot; =&gt; &quot;This data will be in the output&quot; &#125; &#125;</span><br><span class="line">  mutate &#123; add_field =&gt; &#123; &quot;[@metadata][test]&quot; =&gt; &quot;Hello&quot; &#125; &#125;</span><br><span class="line">  mutate &#123; add_field =&gt; &#123; &quot;[@metadata][no_show]&quot; =&gt; &quot;This data will not be in the output&quot; &#125; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  if [@metadata][test] == &quot;Hello&quot; &#123;</span><br><span class="line">    stdout &#123; codec =&gt; rubydebug &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Let’s see what comes out:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ bin/logstash -f ../test.conf</span><br><span class="line">Pipeline main started</span><br><span class="line">asdf</span><br><span class="line">&#123;</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2016-06-30T02:42:51.496Z,</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">          &quot;host&quot; =&gt; &quot;example.com&quot;,</span><br><span class="line">          &quot;show&quot; =&gt; &quot;This data will be in the output&quot;,</span><br><span class="line">       &quot;message&quot; =&gt; &quot;asdf&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The &quot;asdf&quot; typed in became the <code>message</code> field contents, and the conditional successfully evaluated the contents of the <code>test</code> field nested within the <code>@metadata</code> field. But the output did not show a field called <code>@metadata</code>, or its contents.</p>
<p>The <code>rubydebug</code> codec allows you to reveal the contents of the <code>@metadata</code> field if you add a config flag, <code>metadata =&gt; true</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stdout &#123; codec =&gt; rubydebug &#123; metadata =&gt; true &#125; &#125;</span><br></pre></td></tr></table></figure>

<p>Let’s see what the output looks like with this change:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ bin/logstash -f ../test.conf</span><br><span class="line">Pipeline main started</span><br><span class="line">asdf</span><br><span class="line">&#123;</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2016-06-30T02:46:48.565Z,</span><br><span class="line">     &quot;@metadata&quot; =&gt; &#123;</span><br><span class="line">           &quot;test&quot; =&gt; &quot;Hello&quot;,</span><br><span class="line">        &quot;no_show&quot; =&gt; &quot;This data will not be in the output&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">          &quot;host&quot; =&gt; &quot;example.com&quot;,</span><br><span class="line">          &quot;show&quot; =&gt; &quot;This data will be in the output&quot;,</span><br><span class="line">       &quot;message&quot; =&gt; &quot;asdf&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now you can see the <code>@metadata</code> field and its sub-fields.</p>
<p><img data-src="https://www.elastic.co/guide/en/logstash/6.2/images/icons/important.png" alt="Important"></p>
<p>Only the <code>rubydebug</code> codec allows you to show the contents of the <code>@metadata</code> field.</p>
<p>Make use of the <code>@metadata</code> field any time you need a temporary field but do not want it to be in the final output.</p>
<p>Perhaps one of the most common use cases for this new field is with the <code>date</code> filter and having a temporary timestamp.</p>
<p>This configuration file has been simplified, but uses the timestamp format common to Apache and Nginx web servers. In the past, you’d have to delete the timestamp field yourself, after using it to overwrite the <code>@timestamp</code> field. With the <code>@metadata</code> field, this is no longer necessary:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">input &#123; stdin &#123; &#125; &#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  grok &#123; match =&gt; [ &quot;message&quot;, &quot;%&#123;HTTPDATE:[@metadata][timestamp]&#125;&quot; ] &#125;</span><br><span class="line">  date &#123; match =&gt; [ &quot;[@metadata][timestamp]&quot;, &quot;dd/MMM/yyyy:HH:mm:ss Z&quot; ] &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123; codec =&gt; rubydebug &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Notice that this configuration puts the extracted date into the <code>[@metadata][timestamp]</code> field in the <code>grok</code> filter. Let’s feed this configuration a sample date string and see what comes out:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ bin/logstash -f ../test.conf</span><br><span class="line">Pipeline main started</span><br><span class="line">02/Mar/2014:15:36:43 +0100</span><br><span class="line">&#123;</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2014-03-02T14:36:43.000Z,</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">          &quot;host&quot; =&gt; &quot;example.com&quot;,</span><br><span class="line">       &quot;message&quot; =&gt; &quot;02/Mar/2014:15:36:43 +0100&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>That’s it! No extra fields in the output, and a cleaner config file because you do not have to delete a &quot;timestamp&quot; field after conversion in the <code>date</code> filter.</p>
<p>Another use case is the CouchDB Changes input plugin (See <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xvZ3N0YXNoLXBsdWdpbnMvbG9nc3Rhc2gtaW5wdXQtY291Y2hkYl9jaGFuZ2Vz">https://github.com/logstash-plugins/logstash-input-couchdb_changes<i class="fa fa-external-link-alt"></i></span>). This plugin automatically captures CouchDB document field metadata into the <code>@metadata</code> field within the input plugin itself. When the events pass through to be indexed by Elasticsearch, the Elasticsearch output plugin allows you to specify the <code>action</code>(delete, update, insert, etc.) and the <code>document_id</code>, like this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    action =&gt; &quot;%&#123;[@metadata][action]&#125;&quot;</span><br><span class="line">    document_id =&gt; &quot;%&#123;[@metadata][_id]&#125;&quot;</span><br><span class="line">    hosts =&gt; [&quot;example.com&quot;]</span><br><span class="line">    index =&gt; &quot;index_name&quot;</span><br><span class="line">    protocol =&gt; &quot;http&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2017/07/01/oracle/backup-restore/scheduler-for-rman-back/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/gzh.jpg">
      <meta itemprop="name" content="巴流">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
      <meta itemprop="description" content="左手人文 | 右手科技">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 兔子先生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/07/01/oracle/backup-restore/scheduler-for-rman-back/" class="post-title-link" itemprop="url">利用DBMS_SCHEDULER在Oracle 11gR2 RAC上执行rman备份</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-07-01 11:04:00" itemprop="dateCreated datePublished" datetime="2017-07-01T11:04:00+08:00">2017-07-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-07 09:32:12" itemprop="dateModified" datetime="2025-02-07T09:32:12+08:00">2025-02-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oracle-backup/" itemprop="url" rel="index"><span itemprop="name">oracle backup</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="利用DBMS-SCHEDULER在Oracle-11gR2-RAC上执行rman备份"><a href="#利用DBMS-SCHEDULER在Oracle-11gR2-RAC上执行rman备份" class="headerlink" title="利用DBMS_SCHEDULER在Oracle 11gR2 RAC上执行rman备份"></a>利用DBMS_SCHEDULER在Oracle 11gR2 RAC上执行rman备份</h1><p>RMAN backup in Oracle 11gR2 RAC is exactly same like RMAN backup in Oracle 11gR2 single node.<br>The only difference is: Typically, in case of Oracle single node database, we will schedule RMAN scripts with the help of CRON job and it will run according to our convenience, but in case of Oracle RAC if we schedule RMAN script and if unfortunately that RAC node goes down ( where we configured RMAN scripts ), then RMAN backup won’t run obviously.</p>
<p>So, Same strategy will not be work in Oracle RAC node. For RMAN consistent backups use dbms_scheduler &amp; we need to place RMAN scripts in shared directory. ( Or in my case, I have created identical scripts on both cluster node’s )</p>
<p><strong>注意：</strong>  <em>需要将脚本放在共享位置或者每个节点的相同位置</em></p>
<blockquote>
<p>看一下rman的备份脚本，此脚本将备份放在ASM中，将日志放在节点本地</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###############################################################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   rman_backup_rac.sh FOR RAC                                <span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   created by lp                                             <span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   2017/03/22                                                <span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   usage: rman_backup_rac.sh &lt;<span class="variable">$BACKUP_LEVEL</span>&gt;                 <span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">          BACKUP_LEVEL:                                      <span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">             F: full backup                                  <span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">             0: level 0                                      <span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">             1: level 1                                      <span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###############################################################</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">User specific environment and startup programs</span></span><br><span class="line">export ORACLE_HOME=/u01/app/oracle/product/11.2.0/dbhome_1</span><br><span class="line">export RMAN_BAK_LOG_BASE=/home/oracle/DbBackup</span><br><span class="line">export RMAN_BAK_DATA_BASE=+data/NXRAC/backup</span><br><span class="line">export ORACLE_SID=`ps -ef|grep pmon|grep -v ASM|grep -v grep|awk -F&#x27;_&#x27; &#x27;&#123;print $NF&#125;&#x27;`</span><br><span class="line">export TIMESTAMP=`date +%Y%m%d%H%M`;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">the destination of rman backuppiece</span></span><br><span class="line">export RMAN_DATA=$&#123;RMAN_BAK_DATA_BASE&#125;/rman</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">the destination of rman backup logs</span></span><br><span class="line">export RMAN_LOG=$&#123;RMAN_BAK_LOG_BASE&#125;/logs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if [[ ! -z $1 ]] &amp;&amp; echo $1 |grep -Ew &quot;[01F]&quot; &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">then</span><br><span class="line">                                export RMAN_LEVEL=$&#123;1&#125;</span><br><span class="line"></span><br><span class="line">                                # Check rman level</span><br><span class="line">                                if [ &quot;$RMAN_LEVEL&quot; == &quot;F&quot; ];</span><br><span class="line">                                        then  unset INCR_LVL</span><br><span class="line">                                        BACKUP_TYPE=full</span><br><span class="line">                                        else</span><br><span class="line">                                        INCR_LVL=&quot;INCREMENTAL LEVEL $&#123;RMAN_LEVEL&#125;&quot;</span><br><span class="line">                                        BACKUP_TYPE=lev$&#123;RMAN_LEVEL&#125;</span><br><span class="line">                                fi</span><br><span class="line">else</span><br><span class="line">                                echo &quot;$&#123;1&#125; wrong argument!&quot; &gt;$&#123;RMAN_LOG&#125;/wrong_argument_$&#123;TIMESTAMP&#125;.log</span><br><span class="line">                                exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">the prefix of rman backuppiece</span>                                 </span><br><span class="line">export RMAN_FILE=$&#123;RMAN_DATA&#125;/$&#123;BACKUP_TYPE&#125;_$&#123;TIMESTAMP&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">the logfile of shell script including the rman logs contents</span></span><br><span class="line">export SSH_LOG=$&#123;RMAN_LOG&#125;/$&#123;BACKUP_TYPE&#125;_$&#123;TIMESTAMP&#125;.log</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">the size of backuppiece</span></span><br><span class="line">export MAXPIECESIZE=4G</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###################################################################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">                                                                 <span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  the name of rman logs excluding the file expanded-name,        <span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  when the shell is complete,the content of this file will be    <span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  appended to the <span class="variable">$SSH_LOG</span> and the rman logfile will be deleted. <span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">                                                                 <span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###################################################################</span></span></span><br><span class="line">export RMAN_LOG_FILE=$&#123;RMAN_LOG&#125;/$&#123;BACKUP_TYPE&#125;_$&#123;TIMESTAMP&#125;_1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Check RMAN Backup Path</span></span><br><span class="line"></span><br><span class="line">if ! test -d $&#123;RMAN_LOG&#125;</span><br><span class="line">then</span><br><span class="line">mkdir -p $&#123;RMAN_LOG&#125;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">echo &quot;---------------------------------&quot; &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class="line">echo &quot;   &quot; &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class="line">echo &quot;Rman Begin  to Working .........&quot; &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class="line">echo &quot;Begin time at:&quot; `date` --`date +%Y%m%d%H%M` &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Startup rman to backup</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">ORACLE_HOME/bin/rman <span class="built_in">log</span>=<span class="variable">$&#123;RMAN_LOG_FILE&#125;</span>.<span class="built_in">log</span> &lt;&lt;<span class="string">EOF</span></span></span><br><span class="line">connect target /</span><br><span class="line">run &#123;</span><br><span class="line">CONFIGURE RETENTION POLICY TO RECOVERY WINDOW OF 7 DAYS;</span><br><span class="line">CONFIGURE BACKUP OPTIMIZATION ON;</span><br><span class="line">CONFIGURE CONTROLFILE AUTOBACKUP ON;</span><br><span class="line">CONFIGURE DEVICE TYPE DISK PARALLELISM 4 BACKUP TYPE TO BACKUPSET;</span><br><span class="line">CONFIGURE CONTROLFILE AUTOBACKUP FORMAT FOR DEVICE TYPE DISK TO &#x27;$&#123;RMAN_DATA&#125;/control_auto_%F&#x27;;</span><br><span class="line">ALLOCATE CHANNEL &#x27;ch1&#x27; TYPE DISK maxpiecesize=$&#123;MAXPIECESIZE&#125; CONNECT &#x27;SYS/passwd@node1&#x27;;</span><br><span class="line">ALLOCATE CHANNEL &#x27;ch2&#x27; TYPE DISK maxpiecesize=$&#123;MAXPIECESIZE&#125; CONNECT &#x27;SYS/passwd@node1&#x27;;</span><br><span class="line">ALLOCATE CHANNEL &#x27;ch3&#x27; TYPE DISK maxpiecesize=$&#123;MAXPIECESIZE&#125; CONNECT &#x27;SYS/passwd@mode2&#x27;;</span><br><span class="line">ALLOCATE CHANNEL &#x27;ch4&#x27; TYPE DISK maxpiecesize=$&#123;MAXPIECESIZE&#125; CONNECT &#x27;SYS/passwd@node2&#x27;;</span><br><span class="line">CROSSCHECK ARCHIVELOG ALL;</span><br><span class="line">DELETE NOPROMPT OBSOLETE;</span><br><span class="line">DELETE NOPROMPT EXPIRED BACKUP;</span><br><span class="line">BACKUP AS COMPRESSED BACKUPSET</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash"><span class="string">&#123;INCR_LVL&#125;</span></span></span><br><span class="line">DATABASE FORMAT &#x27;$&#123;RMAN_FILE&#125;_db_%U&#x27; TAG &#x27;$&#123;BACKUP_TYPE&#125;_$&#123;TIMESTAMP&#125;&#x27;;</span><br><span class="line">SQL &#x27;ALTER SYSTEM ARCHIVE LOG CURRENT&#x27;;</span><br><span class="line">BACKUP FILESPERSET 20 ARCHIVELOG ALL FORMAT &#x27;$&#123;RMAN_FILE&#125;_arc_%U&#x27; TAG &#x27;$&#123;ORACLE_SID&#125;_arc_$&#123;TIMESTAMP&#125;&#x27;</span><br><span class="line">DELETE  INPUT;  </span><br><span class="line">RELEASE CHANNEL ch1;</span><br><span class="line">RELEASE CHANNEL ch2;</span><br><span class="line">RELEASE CHANNEL ch3;</span><br><span class="line">RELEASE CHANNEL ch4;</span><br><span class="line">ALLOCATE CHANNEL ch00 TYPE DISK;</span><br><span class="line">BACKUP</span><br><span class="line">    FORMAT &#x27;$&#123;RMAN_DATA&#125;/cntrl_%U&#x27;</span><br><span class="line">    CURRENT CONTROLFILE;</span><br><span class="line">RELEASE CHANNEL ch00;</span><br><span class="line">&#125;</span><br><span class="line">exit;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">RC=$?</span><br><span class="line"></span><br><span class="line">cat $&#123;RMAN_LOG_FILE&#125;.log &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class="line">echo &quot;Rman Stop working @ time:&quot;`date` `date +%Y%m%d%H%M` &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class="line"></span><br><span class="line">if [ $RC -ne &quot;0&quot; ]; then</span><br><span class="line">    echo &quot;------ error ------&quot; &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class="line">else</span><br><span class="line">    echo &quot;------ Success during RMAN backup peroid------&quot; &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class="line">    rm -rf $&#123;RMAN_LOG_FILE&#125;.log</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">exit</span><br></pre></td></tr></table></figure>

<p><strong>DBMS_SCHEDULER:</strong></p>
<p>Here we are using DBMS_SCHEDULER instead of DBMS_JOB, because DBMS_SCHEDULER is RAC aware.</p>
<p><strong>Before jump into real DBMS_SCHEDULER configuration, we need to focus on an important thing, That:</strong></p>
<p>Both RAC nodes local time zone must be identical with DBMS_SCHEDULER default time.</p>
<p>On all RAC node, Ensure local time zone and set it accordingly.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[oracle@node2 ]$ cat /etc/sysconfig/clock</span><br><span class="line">ZONE=&quot;Asia/Shanghai&quot;</span><br></pre></td></tr></table></figure>
<p><strong>configure default time zone for DBMS_SCHEDULER</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">value</span> <span class="keyword">from</span> dba_scheduler_global_attribute <span class="keyword">where</span> attribute_name <span class="operator">=</span> <span class="string">&#x27;DEFAULT_TIMEZONE&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">VALUE</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line">PRC</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">exec</span> dbms_scheduler.set_scheduler_attribute (<span class="string">&#x27;DEFAULT_TIMEZONE&#x27;</span>, <span class="string">&#x27;Asia/Shanghai&#x27;</span>);</span><br><span class="line"></span><br><span class="line">PL<span class="operator">/</span><span class="keyword">SQL</span> <span class="keyword">procedure</span> successfully completed.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">value</span> <span class="keyword">from</span> dba_scheduler_global_attribute <span class="keyword">where</span> attribute_name <span class="operator">=</span> <span class="string">&#x27;DEFAULT_TIMEZONE&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">VALUE</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line">Asia<span class="operator">/</span>Shanghai</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Now we need to create credential so that are assigned to DBMS_SCHEDULER jobs so that they can authenticate with a local&#x2F;remote host operating system or a remote Oracle database.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">exec</span> dbms_scheduler.create_credential(credential_name <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;oracle&#x27;</span>, username <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;oracle&#x27;</span>, password <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;oracle&#x27;</span>);</span><br><span class="line"></span><br><span class="line">PL<span class="operator">/</span><span class="keyword">SQL</span> <span class="keyword">procedure</span> successfully completed.</span><br></pre></td></tr></table></figure>

<p>Now its time to create DBMS_SCHEDULER job for RMAN incremental level 0 backup, Here in this procedure I am going to create <em>RMAN_INC0_BACKUP</em> job with required attributes.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span></span><br><span class="line">dbms_scheduler.create_job(</span><br><span class="line">job_name            <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;RMAN_INC0_BACKUP&#x27;</span>,</span><br><span class="line">job_type            <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;EXECUTABLE&#x27;</span>,</span><br><span class="line">job_action          <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;/bin/sh&#x27;</span>,</span><br><span class="line">number_of_arguments <span class="operator">=</span><span class="operator">&gt;</span> <span class="number">2</span>,</span><br><span class="line">start_date          <span class="operator">=</span><span class="operator">&gt;</span> SYSTIMESTAMP,</span><br><span class="line">credential_name     <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;oracle&#x27;</span>,</span><br><span class="line">auto_drop           <span class="operator">=</span><span class="operator">&gt;</span> <span class="literal">FALSE</span>,</span><br><span class="line">enabled             <span class="operator">=</span><span class="operator">&gt;</span> <span class="literal">FALSE</span>);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="operator">/</span></span><br></pre></td></tr></table></figure>
<p>Set argument_position &amp; argument_value ( i.e. Path of the RMAN script ) for the same job:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span></span><br><span class="line">dbms_scheduler.set_job_argument_value(</span><br><span class="line">job_name            <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;RMAN_INC0_BACKUP&#x27;</span>,</span><br><span class="line">argument_position   <span class="operator">=</span><span class="operator">&gt;</span>  <span class="number">1</span>,</span><br><span class="line">argument_value      <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;/home/oracle/rman.sh&#x27;</span>);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">dbms_scheduler.set_job_argument_value(</span><br><span class="line">job_name            <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;RMAN_INC0_BACKUP&#x27;</span>,</span><br><span class="line">argument_position   <span class="operator">=</span><span class="operator">&gt;</span>  <span class="number">2</span>,</span><br><span class="line">argument_value      <span class="operator">=</span><span class="operator">&gt;</span> <span class="number">0</span>);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="operator">/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>Set start_date for the same job, In my case <em>RMAN_INC0_BACKUP</em> job will execute every week on sunday @03am, so job start date and its first run timing would  according to my convenience.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span></span><br><span class="line">dbms_scheduler.set_attribute(</span><br><span class="line">name      <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;RMAN_INC0_BACKUP&#x27;</span>,</span><br><span class="line">attribute <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;start_date&#x27;</span>,</span><br><span class="line"><span class="keyword">value</span>     <span class="operator">=</span><span class="operator">&gt;</span> trunc(sysdate)<span class="operator">+</span><span class="number">3</span><span class="operator">/</span><span class="number">24</span>);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="operator">/</span></span><br></pre></td></tr></table></figure>

<p>Test your backup job manually in SQL prompt by instantiating <em>RMAN_INC0_BACKUP</em> job.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">exec</span> dbms_scheduler.run_job(<span class="string">&#x27;RMAN_INC0_BACKUP&#x27;</span>);</span><br><span class="line">PL<span class="operator">/</span><span class="keyword">SQL</span> <span class="keyword">procedure</span> successfully completed.</span><br></pre></td></tr></table></figure>

<p>Verify running RMAN backup status by issuing following SQL query, It will show you RMAN backup details with start time &amp; end time.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> SESSION_KEY, INPUT_TYPE, STATUS,</span><br><span class="line">to_char(START_TIME,<span class="string">&#x27;mm/dd/yy hh24:mi&#x27;</span>) start_time,</span><br><span class="line">to_char(END_TIME,<span class="string">&#x27;mm/dd/yy hh24:mi&#x27;</span>) end_time,</span><br><span class="line">elapsed_seconds<span class="operator">/</span><span class="number">3600</span> hrs</span><br><span class="line"><span class="keyword">from</span> V$RMAN_BACKUP_JOB_DETAILS</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> session_key;</span><br></pre></td></tr></table></figure>

<p>In case of any error while test run, you can make sure details of error by issuing the following query, OR You can also query to <em>dba_scheduler_job_run_details</em> dictionary view for more details.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> JOB_NAME,STATUS,STATE,ERROR#,CREDENTIAL_NAME <span class="keyword">from</span> dba_scheduler_job_run_details <span class="keyword">where</span> CREDENTIAL_NAME <span class="keyword">like</span> <span class="string">&#x27;RMAN%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>After successfully completion of test run, Enable &amp; schedule it by following procedure by setting value to <em>repeat_interval</em> parameter, In my case <em>RMAN_INC0_BACKUP</em> job will execute every week on Sunday @03pm.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span></span><br><span class="line">dbms_scheduler.set_attribute(</span><br><span class="line">name      <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;RMAN_INC0_BACKUP&#x27;</span>,</span><br><span class="line">attribute <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;repeat_interval&#x27;</span>,</span><br><span class="line"><span class="keyword">value</span>     <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;freq=daily;byday=sun;byhour=03&#x27;</span>);</span><br><span class="line">dbms_scheduler.enable( <span class="string">&#x27;RMAN_INC0_BACKUP&#x27;</span> );</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="operator">/</span></span><br></pre></td></tr></table></figure>

<p>Ensure dbms_scheduler job details by issuing the following query OR you can also query to <em>dba_scheduler_jobs</em> and <em>dba_scheduler_job_args</em>.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> job_name,enabled,owner, state <span class="keyword">from</span> dba_scheduler_jobs <span class="keyword">where</span> job_name <span class="keyword">in</span> (<span class="string">&#x27;RMAN_INC0_BACKUP&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>Keep your eye on behavior of dbms_scheduler job by issuing the following query:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> job_name,RUN_COUNT,LAST_START_DATE,NEXT_RUN_DATE <span class="keyword">from</span> dba_scheduler_jobs <span class="keyword">where</span> job_name <span class="keyword">in</span> (<span class="string">&#x27;RMAN_INC0_BACKUP&#x27;</span>);</span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span>  <span class="keyword">from</span> dba_scheduler_job_args <span class="keyword">where</span> job_name <span class="keyword">like</span> <span class="string">&#x27;RMAN%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>In accordance with the above method to create a level 1 backup job <em>RMAN_INC1_BACKUP</em>，The only difference is the <em>repeat_interval</em>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span></span><br><span class="line">dbms_scheduler.set_attribute(</span><br><span class="line">name      <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;RMAN_INC1_BACKUP&#x27;</span>,</span><br><span class="line">attribute <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;repeat_interval&#x27;</span>,</span><br><span class="line"><span class="keyword">value</span>     <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;freq=daily;byday=mon,tue,wed,thu,fri,sat;byhour=03&#x27;</span>);</span><br><span class="line">dbms_scheduler.enable( <span class="string">&#x27;RMAN_INC1_BACKUP&#x27;</span> );</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="operator">/</span></span><br></pre></td></tr></table></figure>

<p><strong>Important Note:</strong><br>DBMS_SCHEDULER is smart enough to start backup on the node where the last backup was successfully executed.</p>
<p><strong>参考：</strong></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kYmF0cmlja3N3b3JsZC5jb20vaG93LXRvLWJhY2t1cC1vcmFjbGUtcmFjLTExZ3IyLWRhdGFiYXNlLXdpdGgtcm1hbi1iYWNrdXAtdXRpbGl0eS13aXRoLXRoZS1oZWxwLW9mLWRibXNfc2NoZWR1bGVyLXBhcnQtaS1ybWFuLWZ1bGwtZGF0YWJhc2UtYmFja3VwLw==">https://dbatricksworld.com/how-to-backup-oracle-rac-11gr2-database-with-rman-backup-utility-with-the-help-of-dbms_scheduler-part-i-rman-full-database-backup/<i class="fa fa-external-link-alt"></i></span></p>
<p><span class="exturl" data-url="aHR0cDovL2RiYXRyaWNrc3dvcmxkLmNvbS9ob3ctdG8tYmFja3VwLW9yYWNsZS1yYWMtMTFncjItZGF0YWJhc2Utd2l0aC1ybWFuLWJhY2t1cC11dGlsaXR5LXdpdGgtdGhlLWhlbHAtb2YtZGJtc19zY2hlZHVsZXItcGFydC1paS1ybWFuLWluY3JlbWVudGFsLWRhdGFiYXNlLWJhY2t1cC8=">http://dbatricksworld.com/how-to-backup-oracle-rac-11gr2-database-with-rman-backup-utility-with-the-help-of-dbms_scheduler-part-ii-rman-incremental-database-backup/<i class="fa fa-external-link-alt"></i></span></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2017/05/04/oracle/perf/SPM-in%20oracle11g-&-12c/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/gzh.jpg">
      <meta itemprop="name" content="巴流">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
      <meta itemprop="description" content="左手人文 | 右手科技">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 兔子先生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/05/04/oracle/perf/SPM-in%20oracle11g-&-12c/" class="post-title-link" itemprop="url">SQL Plan Management（SPM）in oracle 11g & 12c</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-05-04 21:29:00" itemprop="dateCreated datePublished" datetime="2017-05-04T21:29:00+08:00">2017-05-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-07 09:32:12" itemprop="dateModified" datetime="2025-02-07T09:32:12+08:00">2025-02-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oracle/" itemprop="url" rel="index"><span itemprop="name">oracle</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>本文主要介绍SPM的原理与运行机制，针对12c做一些补充记录，并添加一些11g和12c里面的知识点，以做备忘。</p>
</blockquote>
<h3 id="干预SQL执行计划的历史"><a href="#干预SQL执行计划的历史" class="headerlink" title="干预SQL执行计划的历史"></a>干预SQL执行计划的历史</h3><p>  SQL的执行效率，取决于它的执行计划是否高效。 优化器的算法是一个平衡，需要收集尽量少的信息，用尽量快的速度试图去得到一个最优的执行计划，这也决定了它不是万能的。 所以Oracle提供了一些辅助手段来“修复”优化器可能产生的错误，并不断改进这些方法。 </p>
<ul>
<li>Oracle 8： hint</li>
<li>Oracle 8i&amp;9i: stored outline</li>
<li>Oracle 10g: sql profile</li>
<li>Oracle 11g: sql plan manangement 、adaptive cursor sharing</li>
<li>Oracle 12c: sql plan manangement 、adaptive cursor sharing、Adaptive Execution Plans</li>
</ul>
<h3 id="SQL-Plan-Management"><a href="#SQL-Plan-Management" class="headerlink" title="SQL Plan Management"></a>SQL Plan Management</h3><h4 id="SPM组成"><a href="#SPM组成" class="headerlink" title="SPM组成"></a>SPM组成</h4><p>  SQL Plan Management（以下简称SPM）是一种优化器自动管理执行计划的预防机制，它确保数据库仅使用已知的、经过验证的执行计划。在Oracle 11g之前，执行计划一直是作为“运行时”生成的对象存在。虽然oracle提供了一些方法去指导它的生成，但Oracle一直没有试图去保存完整的执行计划。 从11g开始，执行计划就可以作为一类资源被保存下来，允许特定SQL语句只能选择“已知”的执行计划。</p>
<p>  同其他方法相比，SPM更加的灵活。如我们所熟知的，一条带有绑定变量的SQL语句，最好的执行计划会根据绑定变量的值而不同，11g以前的方法都无法解决这个问题。在11g中，与adaptive cursor sharing配合，SPM允许你同时接受多个执行计划。执行时，根据不同的变量值，SPM会花费很少的运算从中选择一条最合适的。</p>
<p>  SPM有以下三个主要组件：</p>
<ul>
<li><p>Plan capture</p>
<p>捕捉并存储与SQL执行计划相关的信息</p>
</li>
<li><p>Plan selection</p>
<p>使用SQL plan baselines选择合适的执行计划以避免性能退化</p>
</li>
<li><p>Plan evolution</p>
<p>向SQL plan baselines增加新的执行计划</p>
</li>
</ul>
<h4 id="SQL-Management-Base"><a href="#SQL-Management-Base" class="headerlink" title="SQL Management Base"></a>SQL Management Base</h4><p>   SMB是数据字典的一部分，位于SYSAUX表空间，其中存储着statement logs, plan histories, SQL plan baselines, and SQL profiles等内容。</p>
<p>   Plan History是优化器生成的所有执行计划的总称；SQL Plan Baseline是Plan History里那些被标记为“ACCEPTED”的执行计划的总称，称为SQL执行计划基线；SQL Statement Log是一系列的查询签名（signatures），用于在自动捕获执行计划时辨别重复执行的sql；关系如下图所示：</p>
<p>   <img data-src="http://qiniu.liupzmin.com/SMB.png" alt="SQL Management Base"></p>
<h3 id="Plan-capture（执行计划的捕获）"><a href="#Plan-capture（执行计划的捕获）" class="headerlink" title="Plan capture（执行计划的捕获）"></a>Plan capture（执行计划的捕获）</h3><h4 id="Automatic-Initial-Plan-Capture（自动捕获）"><a href="#Automatic-Initial-Plan-Capture（自动捕获）" class="headerlink" title="Automatic Initial Plan Capture（自动捕获）"></a>Automatic Initial Plan Capture（自动捕获）</h4><p>   开启自动捕获只需在初始化参数中将<strong>OPTIMIZER_CAPTURE_SQL_PLAN_BASELINES</strong>设置为<strong>TRUE</strong>(默认为FALSE)，开启之后数据库就会为每个重复执行的sql创建SQL Plan Baseline，甄别是否是重复执行的SQL就是利用的上文提到的SQL Statement Log，基线包括供优化器重新生成该执行计划的所有信息，例如SQL text, outline, bind variable values, and compilation environment，这个初始的执行计划会被自动标记为“accepted”，如果之后又有新的执行计划生成，那么该执行计划会被加入到Plan History但是会被标记为“unaccepted”。</p>
<p>   Oracle Database 12c Release 2 增加了自动捕获时sql过滤的功能，利用<strong>DBMS_SPM.CONFIGURE</strong>存储过程可以创建automatic capture filter。因此，你可以设置仅仅捕获你想要捕获的SQL，可以从<strong>DBA_SQL_MANAGEMENT_CONFIG</strong>视图中查询当前的设置：</p>
<p>   <img data-src="http://qiniu.liupzmin.com/SPM-CONFIG.png" alt="SPM CONFIG"></p>
<p>   自动捕获状态下执行计划的匹配算法如下：</p>
<ul>
<li>如果SQL plan baseline不存在，那么优化器会为该SQL创建SQL plan baseline和Plan History，并将捕获的plan标记为accepted，加入SQL plan baseline</li>
<li>如果SQL plan baseline存在，那么优化器的行为就依赖于解析时生产的基于成本的执行计划<ul>
<li>如果该plan与SQL plan baseline中的plan都不匹配，那么优化器将其标记为unaccepted加入Plan History</li>
<li>如果该plan匹配到SQL plan baseline中的plan，那么执行该plan，不对现有的SQL plan baseline与Plan History做任何改动</li>
</ul>
</li>
</ul>
<h4 id="Manual-Plan-Capture（手动捕获）"><a href="#Manual-Plan-Capture（手动捕获）" class="headerlink" title="Manual Plan Capture（手动捕获）"></a>Manual Plan Capture（手动捕获）</h4><p>   手动加载已存在的执行计划到SPM是最常用的方式，需要注意的是，默认情况下手动load的plan，会被自动标记为”accepted“，创建新的SQL plan baseline或加入到已有的SQL plan baseline中，oracle提供以下5种方式手动加载Execution Plan：</p>
<ul>
<li>From a SQL Tuning Set（DBMS_SPM.LOAD_PLANS_FROM_SQLSET）</li>
<li>From the cursor cache （DBMS_SPM.LOAD_PLANS_FROM_CURSOR_CACHE）</li>
<li>From the AWR repository (new to Oracle Database 12c Release 2)（DBMS_SPM.LOAD_PLANS_FROM_AWR）</li>
<li>Unpacked from a staging table（DBMS_SPM.UNPACK_STGTAB_BASELINE）</li>
<li>From existing stored outlines（DBMS_SPM.MIGRATE_STORED_OUTLINE）</li>
</ul>
<p>   <img data-src="http://qiniu.liupzmin.com/manual%20load%20plan%20into%20plan%20baseline.png" alt="Loading Plans into a SQL Plan Baseline"></p>
<p>  手动load的结果有2种情况，由baseline是否存在而决定：</p>
<ul>
<li>如果SQL Plan Baseline不存在，则数据库做如下事情<ol>
<li>Creates a plan history and plan baseline for the statement</li>
<li>Marks the initial plan for the statement as accepted</li>
<li>Adds the plan to the new baseline</li>
</ol>
</li>
<li>如果SQL Plan Baseline存在，则数据库做如下事情<ol>
<li>Marks the loaded plan as accepted</li>
<li>Adds the plan to the plan baseline for the statement without verifying the plan&#39;s performance</li>
</ol>
</li>
</ul>
<p>   手动load的plan会被自动标为accepted，因为优化器会假定任何由管理员手动加载的plan都是性能上可接受的；当然，你也可以在load的时候在<em>DBMS_SPM.LOAD_PLANS_FROM_%</em> 函数中将<strong>enable</strong>设为<strong>NO</strong>，从而达到禁用的目的。</p>
<p>  具体的load过程，本文暂不做讨论，详情请参阅官方文档 <span class="exturl" data-url="aHR0cDovL2RvY3Mub3JhY2xlLmNvbS9kYXRhYmFzZS8xMjIvVEdTUUwvbWFuYWdpbmctc3FsLXBsYW4tYmFzZWxpbmVzLmh0bSNUR1NRTDk0NjIx">Managing SQL Plan Baselines<i class="fa fa-external-link-alt"></i></span>，这里需要说明的一点是从AWR导入执行计划是oracle 12.2才开始加入的，12.2以前要想实现从AWR中导入执行计划，需要先创建SQL Tuning set，并从AWR中将plan load进STS，再使用DBMS_SPM.LOAD_PLANS_FROM_SQLSET将计划加载到SPM中。</p>
<p>  下面再谈一下，对于已存在SQL Plan Baseline的SQL，其后续的新的执行计划的捕获情况；</p>
<p>  不论使用哪种方式创建了SQL Plan Baseline，后续新的plan都会被加入到Plan History并被标记为”unaccepted“，此行为不依赖于<strong>OPTIMIZER_CAPTURE_SQL_PLAN_ BASELINES</strong>的设置，新加入的plan不会被使用，直到其经过验证比已accepted的plan性能更好，并演化为accepted加入SQL Plan Baseline。</p>
<h3 id="Plan-Selection（执行计划的选择）"><a href="#Plan-Selection（执行计划的选择）" class="headerlink" title="Plan Selection（执行计划的选择）"></a>Plan Selection（执行计划的选择）</h3><p>  SPM通过几个标记来实现对执行计划的控制，这些标记可以在视图<strong>DBA_SQL_PLAN_BASELINES</strong>中查到：</p>
<ul>
<li><p>Enabled（控制活动）</p>
<ul>
<li>YES（活动的，但不一定会被使用）</li>
<li>NO（禁用的，不活动的，肯定不被使用）</li>
</ul>
</li>
<li><p>Accepted（控制使用）</p>
<ul>
<li>YES（只有 “Enabled” 并且 “Accepted” 的计划才会被选择使用）</li>
<li>NO（如果是“Enabled” 那么只有被evolve成“Accepted”才有可能被执行）</li>
</ul>
</li>
<li><p>Fixed（控制优先级）</p>
<ul>
<li>YES（如果是“Enabled”并且“Accepted”，会优先选择这个计划，这个计划会被视为不需要改变的、固定的）</li>
<li>NO（普通的计划，无需优先）</li>
</ul>
</li>
<li><p>Reproduced（有效性）</p>
<ul>
<li>YES（优化器可以使用这个计划）</li>
<li>NO（计划无效，比如索引被删除）</li>
</ul>
</li>
<li><p>ADAPTIVE(12c引入，标记是否是Adaptive Plans)</p>
<ul>
<li>YES（是一个adaptive plan，在evolve的时候会被考虑，evolve时会测试执行，验证后final plan会变为accepted）</li>
<li>NO（adaptive plan被evolve后会被标记为NO）</li>
</ul>
<p>先来看一下SQL Plan Selection的决策树：</p>
</li>
</ul>
<p><img data-src="http://qiniu.liupzmin.com/SQL%20Plan%20Selection%20decision%20tree.png" alt="Decision Tree for SQL Plan Selection"></p>
<p>  当数据库为一条sql执行硬解析的时候，优化器会生成一个best-cost plan，如果初始化参数<strong>OPTIMIZER_USE_SQL_PLAN_BASELINES</strong>被设置成为<strong>TRUE</strong>（默认为TRUE），那么在执行best-cost plan之前会先检查是否存在对应的SQL Plan Baseline，匹配的时候使用SQL语句的signature，signature是一个由SQL文本规范化后的SQL标识符（case insensitivity and with whitespaces removed）（由此可见只要一条sql生成了baseline之后，那么无论大小写改变、空格多少都会被认为是一条sql），这个比较是内存操作，因此开销很小。</p>
<p>  如果baseline不存在，就按生成的计划执行。如果baseline存在，那么要查看history里是否有这个计划，如果没有，就将这个计划插入，并标记为ENABLED,NON-ACCEPTED。</p>
<p>  在baseline中查看是否有FIXED的计划存在，如果存在，执行FIXED的计划，如果存在多个FIXED的计划，根据统计信息重新计算cost，选择cost小的那个。</p>
<p>  如果FIXED的计划不存在，就选择ACCEPTED的计划执行。 如果存在多个ACCEPTED的计划，根据统计信息重新计算cost，选择cost小的那个。</p>
<p>  如果因为某些系统的改变（例如索引删除）导致已accepted的计划无法reproducible，那么优化器将使用新生成的best-cost plan，并将其加入plan history标记为unaccepted</p>
<p>  <em>* 注意，这里每次重新计算cost的代价不大，因为执行计划是已知的，优化器不必遍历所有的可能，只需根据算法计算出已知计划的cost便可。</em></p>
<p>  <em>* 注意，当sql plan baseline中有Fixed的时候，新生成的执行计划是不会被加入到plan history中的。</em></p>
<h3 id="Plan-Evolution（执行计划演化）"><a href="#Plan-Evolution（执行计划演化）" class="headerlink" title="Plan Evolution（执行计划演化）"></a>Plan Evolution（执行计划演化）</h3><p>  当优化器生成一个新的执行计划后，将其加入到plan history中作为一个unaccepted的plan，它需要被verified之后才可以使用，Verification是一个比较unaccepted和accepted（所有accepted中最小cost的）plan的执行性能的过程，verify的过程是实际执行该plan的过程，通过与accepted的plan比较elapse time, CPU time and buffer gets等性能统计信息来判断新plan的性能，如果新的plan的性能优于原plan或者相差无几，那么该plan会被标记为accepted加入SQL Plan Baseline，否则它仍然是一个unaccepted的plan，但是<em>LAST_VERIFIED</em>属性会被更新为当前时刻，12c之后的Automatic plan evolution过程还会考虑自上次被verify之后超过30天的plan，oracle认为如果系统有所改变，也许之前的plan会有更好的性能，当然这个功能可以通过<em>dbms_spm.alter_sql_plan_baseline</em>来禁止。</p>
<p>  12c之前没有自动Evolve的机制，从12.1开始automatic plan evolution由SPM Evolve Advisor来完成，11g时代的<em>DBMS_SPM.EVOLVE_SQL_PLAN_BASELINE</em>被废弃，下面将分别针对11g和12c来介绍Plan Evolution的过程：</p>
<h4 id="11g-DBMS-SPM-EVOLVE-SQL-PLAN-BASELINE"><a href="#11g-DBMS-SPM-EVOLVE-SQL-PLAN-BASELINE" class="headerlink" title="11g DBMS_SPM.EVOLVE_SQL_PLAN_BASELINE"></a>11g DBMS_SPM.EVOLVE_SQL_PLAN_BASELINE</h4><p>  11g可以使用Oracle Enterprise Manager或者DBMS_SPM.EVOLVE_SQL_PLAN_BASELINE函数来演化SQL Plan，语法如下：</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DBMS_SPM.EVOLVE_SQL_PLAN_BASELINE (</span><br><span class="line"> 	sql_handle   <span class="keyword">IN</span> VARCHAR2 :<span class="operator">=</span> <span class="keyword">NULL</span>,</span><br><span class="line"> 	plan_name    <span class="keyword">IN</span> VARCHAR2 :<span class="operator">=</span> <span class="keyword">NULL</span>,</span><br><span class="line"> 	time_limit   <span class="keyword">IN</span> <span class="type">INTEGER</span>  :<span class="operator">=</span> DBMS_SPM.AUTO_LIMIT,</span><br><span class="line"> 	verify       <span class="keyword">IN</span> VARCHAR2 :<span class="operator">=</span> <span class="string">&#x27;YES&#x27;</span>,</span><br><span class="line"> 	<span class="keyword">commit</span>       <span class="keyword">IN</span> VARCHAR2 :<span class="operator">=</span> <span class="string">&#x27;YES&#x27;</span>)</span><br><span class="line"><span class="keyword">RETURN</span> <span class="type">CLOB</span>;</span><br></pre></td></tr></table></figure>

<p>  这里由两个标记控制：</p>
<pre><code>- Verify 
    - YES (验证比较性能)
    - NO (不验证性能)
- Commit
    - YES (演化)
    - NO (只生成报告，不演化)
</code></pre>
<p>  这里可以通过不同的排列组合，达到不同的效果：</p>
<ul>
<li>自动接收所有性能更好的执行计划，并生成report (Verify-&gt;YES, Commit-&gt;YES)</li>
<li>自动接收所有新的执行计划，不验证性能，生成report (Verify-&gt;NO, Commit-&gt;YES)</li>
<li>比较性能，生成report，人工确认是否演化 (Verify-&gt;YES, Commit-&gt;NO)</li>
</ul>
<h4 id="12c-SPM-Evolve-Advisor-Task-Manually-Evolve-Task"><a href="#12c-SPM-Evolve-Advisor-Task-Manually-Evolve-Task" class="headerlink" title="12c SPM Evolve Advisor Task &amp; Manually Evolve Task"></a>12c SPM Evolve Advisor Task &amp; Manually Evolve Task</h4><h5 id="SPM-Evolve-Advisor-Task"><a href="#SPM-Evolve-Advisor-Task" class="headerlink" title="SPM Evolve Advisor Task"></a>SPM Evolve Advisor Task</h5><p>  从12.1开始，自动演化任务由SPM Evolve Advisor每天在维护窗口期内自动执行，SPM Evolve Advisor是一个自动任务（SYS_AUTO_SPM_EVOLVE_TASK），它每天做如下操作：</p>
<ol>
<li>Locates unaccepted plans</li>
<li>Ranks all unaccepted plans</li>
<li>Performs test executions of as many plans as possible during the maintenance window</li>
<li>Selects the lowest-cost plan to compare against each unaccepted plan</li>
<li>Accepts automatically any unaccepted plan that performs sufficiently better, using a cost-based algorithm, than the existing accepted plan</li>
</ol>
<p>  <em>* 需要注意的是，没有单独针对Automatic SPM Evolve Advisor task的scheduler client，Automatic SQL Tuning Advisor 和 Automatic SPM Evolve Advisor共用一个client，因此它们两个同时启用或同时禁用。</em></p>
<p>  自动任务属性可以通过<em>DBMS_SPM.SET_EVOLVE_TASK_PARAMETER</em>来配置，下面列举几个重要的属性：</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">COL PARAMETER_NAME FORMAT a25</span><br><span class="line">COL <span class="keyword">VALUE</span> FORMAT a42</span><br><span class="line"><span class="keyword">SELECT</span> PARAMETER_NAME, PARAMETER_VALUE <span class="keyword">AS</span> &quot;VALUE&quot;</span><br><span class="line"><span class="keyword">FROM</span>   DBA_ADVISOR_PARAMETERS</span><br><span class="line"><span class="keyword">WHERE</span>  ( (TASK_NAME <span class="operator">=</span> <span class="string">&#x27;SYS_AUTO_SPM_EVOLVE_TASK&#x27;</span>) <span class="keyword">AND</span></span><br><span class="line">       ( (PARAMETER_NAME <span class="operator">=</span> <span class="string">&#x27;ACCEPT_PLANS&#x27;</span>) <span class="keyword">OR</span></span><br><span class="line">         (PARAMETER_NAME <span class="keyword">LIKE</span> <span class="string">&#x27;%ALT%&#x27;</span>) <span class="keyword">OR</span></span><br><span class="line">         (PARAMETER_NAME <span class="operator">=</span> <span class="string">&#x27;TIME_LIMIT&#x27;</span>) ) );</span><br></pre></td></tr></table></figure>
<p>  12.2的默认值如下(各个属性的意义详见官方文档)：</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PARAMETER_NAME		    <span class="keyword">VALUE</span></span><br><span class="line"><span class="comment">------------------------- ------------------------------------------</span></span><br><span class="line">TIME_LIMIT		        <span class="number">3600</span></span><br><span class="line">ALTERNATE_PLAN_LIMIT	    <span class="number">10</span></span><br><span class="line">ALTERNATE_PLAN_SOURCE	    CURSOR_CACHE<span class="operator">+</span>AUTOMATIC_WORKLOAD_REPOSITORY</span><br><span class="line">ALTERNATE_PLAN_BASELINE   EXISTING</span><br><span class="line">ACCEPT_PLANS		        <span class="literal">TRUE</span></span><br></pre></td></tr></table></figure>
<p>  修改属性：</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">BEGIN</span></span><br><span class="line">  DBMS_SPM.SET_EVOLVE_TASK_PARAMETER(</span><br><span class="line">    task_name <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;SYS_AUTO_SPM_EVOLVE_TASK&#x27;</span></span><br><span class="line">,   <span class="keyword">parameter</span> <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;TIME_LIMIT&#x27;</span></span><br><span class="line">,   <span class="keyword">value</span>     <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;1200&#x27;</span></span><br><span class="line">);</span><br><span class="line">  DBMS_SPM.SET_EVOLVE_TASK_PARAMETER(</span><br><span class="line">    task_name <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;SYS_AUTO_SPM_EVOLVE_TASK&#x27;</span></span><br><span class="line">,   <span class="keyword">parameter</span> <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;ACCEPT_PLANS&#x27;</span></span><br><span class="line">,   <span class="keyword">value</span>     <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">);</span><br><span class="line">  DBMS_SPM.SET_EVOLVE_TASK_PARAMETER(</span><br><span class="line">    task_name <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;SYS_AUTO_SPM_EVOLVE_TASK&#x27;</span></span><br><span class="line">,   <span class="keyword">parameter</span> <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;ALTERNATE_PLAN_LIMIT&#x27;</span></span><br><span class="line">,   <span class="keyword">value</span>     <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;500&#x27;</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"><span class="operator">/</span></span><br></pre></td></tr></table></figure>

<p> 查看结果：</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> PARAMETER_NAME            <span class="keyword">VALUE</span></span><br><span class="line"><span class="comment">------------------------- ------------------------------------------</span></span><br><span class="line">ALTERNATE_PLAN_LIMIT      <span class="number">500</span></span><br><span class="line">ALTERNATE_PLAN_SOURCE     CURSOR_CACHE<span class="operator">+</span>AUTOMATIC_WORKLOAD_REPOSITORY</span><br><span class="line">ALTERNATE_PLAN_BASELINE   EXISTING</span><br><span class="line">ACCEPT_PLANS              <span class="literal">true</span></span><br><span class="line">TIME_LIMIT                <span class="number">1200</span></span><br></pre></td></tr></table></figure>

<p> 自动演化的报告可以通过函数<em>DBMS_SPM.REPORT_AUTO_EVOLVE_TASK</em>来查询：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; SET LONG 1000000 PAGESIZE 1000 LONGCHUNKSIZE 100 LINESIZE 100</span><br><span class="line">SQL&gt; SELECT DBMS_SPM.report_auto_evolve_task FROM   dual;</span><br><span class="line"></span><br><span class="line">REPORT_AUTO_EVOLVE_TASK</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">GENERAL INFORMATION SECTION</span><br><span class="line">---------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"> Task Information:</span><br><span class="line"> ---------------------------------------------</span><br><span class="line"> Task Name	          : SYS_AUTO_SPM_EVOLVE_TASK</span><br><span class="line"> Task Owner	          : SYS</span><br><span class="line"> Description	      : Automatic SPM Evolve Task</span><br><span class="line"> Execution Name       : EXEC_1173</span><br><span class="line"> Execution Type       : SPM EVOLVE</span><br><span class="line"> Scope		          : COMPREHENSIVE</span><br><span class="line"> Status 	          : COMPLETED</span><br><span class="line"> Started	          : 04/20/2017 22:00:05</span><br><span class="line"> Finished	          : 04/20/2017 22:00:09</span><br><span class="line"> Last Updated	      : 04/20/2017 22:00:09</span><br><span class="line"> Global Time Limit    : 3600</span><br><span class="line"> Per-Plan Time Limit  : UNUSED</span><br><span class="line"> Number of Errors     : 0</span><br><span class="line">---------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">SUMMARY SECTION</span><br><span class="line">---------------------------------------------------------------------------------------------</span><br><span class="line">  Number of plans processed  : 0</span><br><span class="line">  Number of findings	     : 0</span><br><span class="line">  Number of recommendations  : 0</span><br><span class="line">  Number of errors	         : 0</span><br><span class="line">---------------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<h5 id="Manually-Evolve-Task"><a href="#Manually-Evolve-Task" class="headerlink" title="Manually Evolve Task"></a>Manually Evolve Task</h5><p>  手动演化的过程大致如下图：</p>
<p>  <img data-src="http://qiniu.liupzmin.com/Evolving%20SQL%20Plan%20Baselines.png" alt="Evolving SQL Plan Baselines"></p>
<ol>
<li>Create an evolve task</li>
<li>Optionally, set evolve task parameters(在12.2.0.1中仅TIME_LIMIT有效)</li>
<li>Execute the evolve task</li>
<li>Implement the recommendations in the task</li>
<li>Report on the task outcome</li>
</ol>
<p>  个人认为4、5无绝对先后顺序</p>
<p>  具体操作，本文暂不讨论，请浏览<a href="https://liupzmin.com/2017/04/24/oracle/perf/Manually-Evolving-SQL-Plan-Baselines-in-Oracle-Database-12c-Release-2/">Manually Evolving SQL Plan Baselines in Oracle Database 12c Release 2</a></p>
<h3 id="Managing-the-SQL-Management-Base"><a href="#Managing-the-SQL-Management-Base" class="headerlink" title="Managing the SQL Management Base"></a>Managing the SQL Management Base</h3><p>   利用<em>DBMS_SPM.CONFIGURE</em>存储过程可以配置SMB，视图<em>DBA_SQL_MANAGEMENT_CONFIG</em>显示了各个配置项的状态。</p>
<p>   参数有如下几个：</p>
<ul>
<li>SPACE_BUDGET_PERCENT（SYSAUX表空间的最大使用率）</li>
<li>PLAN_RETENTION_WEEKS（没被使用的plan的最大保留weeks，默认是53周）</li>
<li>AUTO_CAPTURE_PARSING_SCHEMA_NAME（自动捕获过滤schema）</li>
<li>AUTO_CAPTURE_MODULE</li>
<li>AUTO_CAPTURE_MODULE</li>
<li>AUTO_CAPTURE_SQL_TEXT（自动捕获指定的sql）</li>
</ul>
<h4 id="修改SMB磁盘使用限额"><a href="#修改SMB磁盘使用限额" class="headerlink" title="修改SMB磁盘使用限额"></a>修改SMB磁盘使用限额</h4><p>  1.查询当前配置</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">  <span class="keyword">SELECT</span> PARAMETER_NAME, PARAMETER_VALUE <span class="keyword">AS</span> &quot;%_LIMIT&quot;, </span><br><span class="line">       ( <span class="keyword">SELECT</span> <span class="built_in">sum</span>(bytes<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span>) <span class="keyword">FROM</span> DBA_DATA_FILES </span><br><span class="line">         <span class="keyword">WHERE</span> TABLESPACE_NAME <span class="operator">=</span> <span class="string">&#x27;SYSAUX&#x27;</span> ) <span class="keyword">AS</span> SYSAUX_SIZE_IN_MB,</span><br><span class="line">       PARAMETER_VALUE<span class="operator">/</span><span class="number">100</span> <span class="operator">*</span> </span><br><span class="line">       ( <span class="keyword">SELECT</span> <span class="built_in">sum</span>(bytes<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span>) <span class="keyword">FROM</span> DBA_DATA_FILES </span><br><span class="line">         <span class="keyword">WHERE</span> TABLESPACE_NAME <span class="operator">=</span> <span class="string">&#x27;SYSAUX&#x27;</span> ) <span class="keyword">AS</span> &quot;CURRENT_LIMIT_IN_MB&quot;</span><br><span class="line"><span class="keyword">FROM</span> DBA_SQL_MANAGEMENT_CONFIG</span><br><span class="line"><span class="keyword">WHERE</span> PARAMETER_NAME <span class="operator">=</span> <span class="string">&#x27;SPACE_BUDGET_PERCENT&#x27;</span>;</span><br><span class="line"></span><br><span class="line">PARAMETER_NAME          <span class="operator">%</span>_LIMIT SYSAUX_SIZE_IN_MB CURRENT_LIMIT_IN_MB</span><br><span class="line"><span class="comment">-------------------- ---------- ----------------- -------------------</span></span><br><span class="line">SPACE_BUDGET_PERCENT         <span class="number">10</span>          <span class="number">211.4375</span>            <span class="number">21.14375</span></span><br></pre></td></tr></table></figure>

<p>  2.修改配额</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXECUTE</span> DBMS_SPM.CONFIGURE(<span class="string">&#x27;space_budget_percent&#x27;</span>,<span class="number">30</span>);</span><br></pre></td></tr></table></figure>

<p>  3.查看结果</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">SELECT</span> PARAMETER_NAME, PARAMETER_VALUE <span class="keyword">AS</span> &quot;%_LIMIT&quot;, </span><br><span class="line">       ( <span class="keyword">SELECT</span> <span class="built_in">sum</span>(bytes<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span>) <span class="keyword">FROM</span> DBA_DATA_FILES </span><br><span class="line">         <span class="keyword">WHERE</span> TABLESPACE_NAME <span class="operator">=</span> <span class="string">&#x27;SYSAUX&#x27;</span> ) <span class="keyword">AS</span> SYSAUX_SIZE_IN_MB,</span><br><span class="line">       PARAMETER_VALUE<span class="operator">/</span><span class="number">100</span> <span class="operator">*</span> </span><br><span class="line">       ( <span class="keyword">SELECT</span> <span class="built_in">sum</span>(bytes<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1024</span>) <span class="keyword">FROM</span> DBA_DATA_FILES </span><br><span class="line">         <span class="keyword">WHERE</span> TABLESPACE_NAME <span class="operator">=</span> <span class="string">&#x27;SYSAUX&#x27;</span> ) <span class="keyword">AS</span> &quot;CURRENT_LIMIT_IN_MB&quot;</span><br><span class="line"><span class="keyword">FROM</span>   DBA_SQL_MANAGEMENT_CONFIG</span><br><span class="line"><span class="keyword">WHERE</span>  PARAMETER_NAME <span class="operator">=</span> <span class="string">&#x27;SPACE_BUDGET_PERCENT&#x27;</span>;</span><br><span class="line"></span><br><span class="line">PARAMETER_NAME          <span class="operator">%</span>_LIMIT SYSAUX_SIZE_IN_MB CURRENT_LIMIT_IN_MB</span><br><span class="line"><span class="comment">-------------------- ---------- ----------------- -------------------</span></span><br><span class="line">SPACE_BUDGET_PERCENT         <span class="number">30</span>          <span class="number">211.4375</span>            <span class="number">63.43125</span></span><br></pre></td></tr></table></figure>

<h4 id="修改保留策略"><a href="#修改保留策略" class="headerlink" title="修改保留策略"></a>修改保留策略</h4><p>1.查看当前配置</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">SELECT</span> PARAMETER_NAME, PARAMETER_VALUE</span><br><span class="line">  <span class="number">2</span>  <span class="keyword">FROM</span>   DBA_SQL_MANAGEMENT_CONFIG</span><br><span class="line">  <span class="number">3</span>  <span class="keyword">WHERE</span>  PARAMETER_NAME <span class="operator">=</span> <span class="string">&#x27;PLAN_RETENTION_WEEKS&#x27;</span>;</span><br><span class="line"> </span><br><span class="line">PARAMETER_NAME                 PARAMETER_VALUE</span><br><span class="line"><span class="comment">------------------------------ ---------------</span></span><br><span class="line">PLAN_RETENTION_WEEKS                        <span class="number">53</span></span><br></pre></td></tr></table></figure>

<p>2.修改配置</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXECUTE</span> DBMS_SPM.CONFIGURE(<span class="string">&#x27;plan_retention_weeks&#x27;</span>,<span class="number">105</span>);</span><br></pre></td></tr></table></figure>

<p>3.查看结果</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">SELECT</span> PARAMETER_NAME, PARAMETER_VALUE</span><br><span class="line">  <span class="number">2</span>  <span class="keyword">FROM</span>   DBA_SQL_MANAGEMENT_CONFIG</span><br><span class="line">  <span class="number">3</span>  <span class="keyword">WHERE</span>  PARAMETER_NAME <span class="operator">=</span> <span class="string">&#x27;PLAN_RETENTION_WEEKS&#x27;</span>;</span><br><span class="line"> </span><br><span class="line">PARAMETER_NAME                 PARAMETER_VALUE</span><br><span class="line"><span class="comment">------------------------------ ---------------</span></span><br><span class="line">PLAN_RETENTION_WEEKS                       <span class="number">105</span></span><br></pre></td></tr></table></figure>


<h3 id="Monitoring-SQL-plan-baselines"><a href="#Monitoring-SQL-plan-baselines" class="headerlink" title="Monitoring SQL plan baselines"></a>Monitoring SQL plan baselines</h3><p>  视图DBA_SQL_PLAN_BASELINES展示了当前SQL plan baselines的信息：</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> SIGNATURE,</span><br><span class="line">     SQL_HANDLE,</span><br><span class="line">     SQL_TEXT,</span><br><span class="line">     PLAN_NAME,</span><br><span class="line">     PARSING_SCHEMA_NAME,</span><br><span class="line">     LAST_EXECUTED,</span><br><span class="line">     ENABLED,</span><br><span class="line">     ACCEPTED,</span><br><span class="line">     REPRODUCED,</span><br><span class="line">     EXECUTIONS</span><br><span class="line"><span class="keyword">from</span> dba_sql_plan_baselines;</span><br></pre></td></tr></table></figure>

<p>  结果如下：</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">                SIGNATURE SQL_HANDLE           SQL_TEXT                       PLAN_NAME                      PARSING_SC LAST_EXECUTED                       ENA ACC REP EXECUTIONS</span><br><span class="line"><span class="comment">----------------------- -------------------- ------------------------------ ------------------------------ ---------- ----------------------------------- --- --- --- ----------</span></span><br><span class="line">                                             here id<span class="operator">=</span><span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="number">1962643652257108320</span> SQL_1b3cb600d175d160 <span class="keyword">select</span> <span class="comment">/*liu*/</span> <span class="operator">*</span>  <span class="keyword">from</span> test wh SQL_PLAN_1qg5q038rbnb025a3834b SCOTT      <span class="number">13</span><span class="operator">-</span>APR<span class="number">-17</span> <span class="number">02.23</span><span class="number">.12</span><span class="number">.000000</span> PM        YES YES YES          <span class="number">0</span></span><br><span class="line">                                             ere id<span class="operator">=</span><span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="number">1962643652257108320</span> SQL_1b3cb600d175d160 <span class="keyword">select</span> <span class="comment">/*liu*/</span> <span class="operator">*</span>  <span class="keyword">from</span> test wh SQL_PLAN_1qg5q038rbnb097bbe3d0 HR         <span class="number">13</span><span class="operator">-</span>APR<span class="number">-17</span> <span class="number">02.35</span><span class="number">.09</span><span class="number">.000000</span> PM        YES YES YES          <span class="number">0</span></span><br><span class="line">                                             ere id<span class="operator">=</span><span class="number">1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>需要注意的一点是，该视图中LAST_EXECUTED和EXECUTIONS并不是实时更新的。</p>
</blockquote>
<p>  函数DBMS_XPLAN.DISPLAY_SQL_PLAN_BASELINE可以查看baseline中的执行计划，语法如下：</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> DBMS_XPLAN.DISPLAY_SQL_PLAN_BASELINE (</span><br><span class="line">  sql_handle      <span class="keyword">IN</span> VARCHAR2 :<span class="operator">=</span> <span class="keyword">NULL</span>,</span><br><span class="line">  plan_name       <span class="keyword">IN</span> VARCHAR2 :<span class="operator">=</span> <span class="keyword">NULL</span>,</span><br><span class="line">  format          <span class="keyword">IN</span> VARCHAR2 :<span class="operator">=</span> <span class="string">&#x27;TYPICAL&#x27;</span>)</span><br><span class="line"><span class="keyword">RETURN</span> dbms_xplan_type_table;</span><br></pre></td></tr></table></figure>

<p>  例如：</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">   <span class="operator">*</span> </span><br><span class="line"><span class="keyword">from</span> <span class="keyword">table</span>( </span><br><span class="line">    dbms_xplan.display_sql_plan_baseline( </span><br><span class="line">        sql_handle<span class="operator">=</span><span class="operator">&gt;</span><span class="string">&#x27;SQL_5671036d51fd678f&#x27;</span>, </span><br><span class="line">        format<span class="operator">=</span><span class="operator">&gt;</span><span class="string">&#x27;basic&#x27;</span>));</span><br><span class="line"><span class="comment">--或者        </span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">table</span>(dbms_xplan.display_sql_plan_baseline(<span class="string">&#x27;SQL_17574e83c195631c&#x27;</span>,<span class="keyword">null</span>,<span class="string">&#x27;BASIC +NOTE&#x27;</span>));</span><br></pre></td></tr></table></figure>

<p>  也可以通过V$SQL视图查看一条SQL是否使用SQL Base Line，如果使用了baseline，那么它的sql_plan_baseline列将会显示plan_name，因此可以连接DBA_SQL_PLAN_BASELINES和V$SQL视图：</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> s.SQL_ID, s.SQL_TEXT, b.plan_name, b.origin, b.accepted</span><br><span class="line"> <span class="keyword">from</span> dba_sql_plan_baselines b, v$<span class="keyword">sql</span> s</span><br><span class="line"><span class="keyword">where</span> s.EXACT_MATCHING_SIGNATURE <span class="operator">=</span> b.signature</span><br><span class="line">  <span class="keyword">and</span> s.SQL_PLAN_BASELINE <span class="operator">=</span> b.plan_name;</span><br></pre></td></tr></table></figure>

<p>  查看v$sql中的sql是否有baseline：</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> sql_handle,</span><br><span class="line">  plan_name</span><br><span class="line"><span class="keyword">FROM</span> dba_sql_plan_baselines</span><br><span class="line"><span class="keyword">WHERE</span> signature <span class="keyword">IN</span></span><br><span class="line">  ( <span class="keyword">SELECT</span> exact_matching_signature <span class="keyword">FROM</span> v$<span class="keyword">sql</span> <span class="keyword">WHERE</span> sql_id<span class="operator">=</span><span class="string">&#x27;1s6a8wn4p6rym&#x27;</span></span><br><span class="line">  );</span><br></pre></td></tr></table></figure>

<h3 id="Dropping-SQL-Plan-Baselines"><a href="#Dropping-SQL-Plan-Baselines" class="headerlink" title="Dropping SQL Plan Baselines"></a>Dropping SQL Plan Baselines</h3><p>1.查询要删除的baseline</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">SELECT</span> SQL_HANDLE, SQL_TEXT, PLAN_NAME, ORIGIN,</span><br><span class="line">  <span class="number">2</span>         ENABLED, ACCEPTED</span><br><span class="line">  <span class="number">3</span>  <span class="keyword">FROM</span>   DBA_SQL_PLAN_BASELINES</span><br><span class="line">  <span class="number">4</span>  <span class="keyword">WHERE</span>  SQL_TEXT <span class="keyword">LIKE</span> <span class="string">&#x27;SELECT /* repeatable_sql%&#x27;</span>;</span><br><span class="line"> </span><br><span class="line">SQL_HANDLE           SQL_TEXT             PLAN_NAME                      ORIGIN         ENA ACC</span><br><span class="line"><span class="comment">-------------------- -------------------- ------------------------------ -------------- --- ---</span></span><br><span class="line">SQL_b6b0d1c71cd1807b <span class="keyword">SELECT</span> <span class="comment">/* repeatable SQL_PLAN_bdc6jswfd303v2f1e9c20 AUTO-CAPTURE   YES YES</span></span><br><span class="line"><span class="comment">                     _sql */</span> <span class="built_in">count</span>(<span class="operator">*</span>) fro</span><br><span class="line">                     m hr.jobs</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.删除sql plan baseline</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">  v_dropped_plans number;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  v_dropped_plans :<span class="operator">=</span> DBMS_SPM.DROP_SQL_PLAN_BASELINE (</span><br><span class="line">     sql_handle <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;SQL_b6b0d1c71cd1807b&#x27;</span></span><br><span class="line">);</span><br><span class="line">  DBMS_OUTPUT.PUT_LINE(<span class="string">&#x27;dropped &#x27;</span> <span class="operator">||</span> v_dropped_plans <span class="operator">||</span> <span class="string">&#x27; plans&#x27;</span>);</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"><span class="operator">/</span></span><br></pre></td></tr></table></figure>

<p>3.确认删除</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> SQL_HANDLE, SQL_TEXT, PLAN_NAME, ORIGIN,</span><br><span class="line">       ENABLED, ACCEPTED</span><br><span class="line"><span class="keyword">FROM</span>   DBA_SQL_PLAN_BASELINES</span><br><span class="line"><span class="keyword">WHERE</span>  SQL_TEXT <span class="keyword">LIKE</span> <span class="string">&#x27;SELECT /* repeatable_sql%&#x27;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">no</span> <span class="keyword">rows</span> selected</span><br></pre></td></tr></table></figure>

<p><strong>参考文献：</strong></p>
<ol>
<li><span class="exturl" data-url="aHR0cHM6Ly9ibG9ncy5vcmFjbGUuY29tL0RhdGFiYXNlNENOL2VudHJ5L29yYWNsZV8xMWdfJUU5JTkyJTg4JUU1JUFGJUI5c3FsJUU2JTgwJUE3JUU4JTgzJUJEJUU3JTlBJTg0JUU2JTk2JUIwJUU3JTg5JUI5JUU2JTgwJUE3XyVFNCVCOCU4OV9zcWw=">Oracle 11g 针对SQL性能的新特性（三）- SQL Plan Management <i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2RvY3Mub3JhY2xlLmNvbS9kYXRhYmFzZS8xMjIvVEdTUUwvdG9jLmh0bQ==">Database SQL Tuning Guide<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL3d3dy5vcmFjbGUuY29tL3RlY2huZXR3b3JrL2RhdGFiYXNlL2ZvY3VzLWFyZWFzL2JpLWRhdGF3YXJlaG91c2luZy90d3Atc3FsLXBsYW4tbWFuYWdlbWVudC0xMWdyMi0xMzMwOTkucGRm"> White Paper:SQL Plan Management in Oracle Database 11g<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL3d3dy5vcmFjbGUuY29tL3RlY2huZXR3b3JrL2RhdGFiYXNlL2JpLWRhdGF3YXJlaG91c2luZy90d3Atc3FsLXBsYW4tbWdtdC0xMmMtMTk2MzIzNy5wZGY=">White Paper:SQL Plan Management with Oracle Database 12c Release 2<i class="fa fa-external-link-alt"></i></span></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2017/04/26/oracle/perf/SPM-Using-SPM-to-Correct-Regressed-SQL-Statements/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/gzh.jpg">
      <meta itemprop="name" content="巴流">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
      <meta itemprop="description" content="左手人文 | 右手科技">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 兔子先生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/04/26/oracle/perf/SPM-Using-SPM-to-Correct-Regressed-SQL-Statements/" class="post-title-link" itemprop="url">SPM Using SPM to Correct Regressed SQL Statements</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-04-26 16:19:00" itemprop="dateCreated datePublished" datetime="2017-04-26T16:19:00+08:00">2017-04-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-07 09:32:12" itemprop="dateModified" datetime="2025-02-07T09:32:12+08:00">2025-02-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oracle/" itemprop="url" rel="index"><span itemprop="name">oracle</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在<em>LOAD_PLANS_FROM_CURSOR_CACHE</em>函数中有一种语法组合如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DBMS_SPM.LOAD_PLANS_FROM_CURSOR_CACHE (</span><br><span class="line">   sql_id            <span class="keyword">IN</span>  VARCHAR2,</span><br><span class="line">   plan_hash_value   <span class="keyword">IN</span>  NUMBER   :<span class="operator">=</span> <span class="keyword">NULL</span>,</span><br><span class="line">   sql_handle        <span class="keyword">IN</span>  VARCHAR2,  <span class="comment">--注意这里</span></span><br><span class="line">   fixed             <span class="keyword">IN</span>  VARCHAR2 :<span class="operator">=</span> <span class="string">&#x27;NO&#x27;</span>,</span><br><span class="line">   enabled           <span class="keyword">IN</span>  VARCHAR2 :<span class="operator">=</span> <span class="string">&#x27;YES&#x27;</span>)</span><br><span class="line"> <span class="keyword">RETURN</span> PLS_INTEGER;</span><br></pre></td></tr></table></figure>

<p>Oracle对其中<em>sql_handle</em>的解释为：</p>
<p><em>SQL handle to use in identifying the SQL plan baseline into which the plans are loaded. The sql_handle must denote an existing SQL plan baseline. The use of handle is crucial when the user tunes a SQL statement by adding hints to its text and then wants to load the resulting plan(s) into the SQL plan baseline of the original SQL statement.</em></p>
<p>意思是说，使用sql_handle可以将cursor cache中的执行计划load进一个已存在的SQL Plan Baseline，这就意味着你可以不需要更改应用的代码，就可以让SQL跑出你期望的执行计划，前提是你有一个已经tuning好的plan在cacahe里，你就可以将这个plan load进原SQL的Baseline，下面将针对此调优方法展开详细论述：</p>
<blockquote>
<p>我要进行的实验是要一个原本走索引的sql，在不改变原sql的基础上，让它走全表扫描</p>
</blockquote>
<ol>
<li><p>创建测试环境</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> spm_test_tab (</span><br><span class="line">   		id           NUMBER,</span><br><span class="line">   		description  VARCHAR2(<span class="number">50</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="comment">/*+ APPEND */</span> <span class="keyword">INTO</span> spm_test_tab</span><br><span class="line"><span class="keyword">SELECT</span> level,</span><br><span class="line">      <span class="string">&#x27;Description for &#x27;</span> <span class="operator">||</span> level</span><br><span class="line"><span class="keyword">FROM</span>   dual</span><br><span class="line"><span class="keyword">CONNECT</span> <span class="keyword">BY</span> level <span class="operator">&lt;=</span> <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="comment">--创建索引</span></span><br><span class="line"><span class="keyword">CREATE</span> INDEX spm_test_tab_idx <span class="keyword">ON</span> spm_test_tab(id);</span><br><span class="line"><span class="comment">--收集统计信息</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"> 		dbms_stats.gather_table_stats(ownname <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;SYS&#x27;</span>,</span><br><span class="line"> 		tabname <span class="operator">=</span><span class="operator">&gt;</span><span class="string">&#x27;SPM_TEST_TAB&#x27;</span>,</span><br><span class="line"> 		estimate_percent <span class="operator">=</span><span class="operator">&gt;</span>DBMS_STATS.AUTO_SAMPLE_SIZE,</span><br><span class="line"> 		method_opt <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;FOR ALL COLUMNS SIZE AUTO&#x27;</span>,</span><br><span class="line"> 		granularity<span class="operator">=</span><span class="operator">&gt;</span><span class="string">&#x27;ALL&#x27;</span>,</span><br><span class="line"> 		cascade <span class="operator">=</span><span class="operator">&gt;</span> <span class="literal">TRUE</span>,</span><br><span class="line"> 		no_invalidate <span class="operator">=</span><span class="operator">&gt;</span> <span class="literal">false</span>);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="operator">/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>执行例句，查看其执行计划</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line"><span class="keyword">SELECT</span> description <span class="keyword">FROM</span>  spm_test_tab <span class="keyword">WHERE</span>  id <span class="operator">=</span> <span class="number">1113</span>;</span><br><span class="line">	</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">TABLE</span> (<span class="keyword">SELECT</span> DBMS_XPLAN.DISPLAY_CURSOR(<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="string">&#x27;advanced&#x27;</span>) <span class="keyword">from</span> dual);</span><br><span class="line">	</span><br><span class="line">SQL_ID  gsttbra9z0ddw, child number <span class="number">0</span></span><br><span class="line"><span class="comment">-------------------------------------</span></span><br><span class="line"><span class="keyword">SELECT</span> description <span class="keyword">FROM</span>  spm_test_tab <span class="keyword">WHERE</span>  id <span class="operator">=</span> <span class="number">1113</span></span><br><span class="line"></span><br><span class="line">Plan hash <span class="keyword">value</span>: <span class="number">3121206333</span></span><br><span class="line"></span><br><span class="line"><span class="comment">------------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span> Id  <span class="operator">|</span> Operation                   <span class="operator">|</span> Name             <span class="operator">|</span> <span class="keyword">Rows</span>  <span class="operator">|</span> Bytes <span class="operator">|</span> Cost (<span class="operator">%</span>CPU)<span class="operator">|</span> <span class="type">Time</span>     <span class="operator">|</span></span><br><span class="line"><span class="comment">------------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">0</span> <span class="operator">|</span> <span class="keyword">SELECT</span> STATEMENT            <span class="operator">|</span>                  <span class="operator">|</span>       <span class="operator">|</span>       <span class="operator">|</span>     <span class="number">2</span> (<span class="number">100</span>)<span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span>  <span class="keyword">TABLE</span> ACCESS <span class="keyword">BY</span> INDEX ROWID<span class="operator">|</span> SPM_TEST_TAB     <span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span>    <span class="number">25</span> <span class="operator">|</span>     <span class="number">2</span>   (<span class="number">0</span>)<span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span><span class="operator">*</span>  <span class="number">2</span> <span class="operator">|</span>   INDEX <span class="keyword">RANGE</span> SCAN          <span class="operator">|</span> SPM_TEST_TAB_IDX <span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span>       <span class="operator">|</span>     <span class="number">1</span>   (<span class="number">0</span>)<span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span> <span class="operator">|</span></span><br><span class="line"><span class="comment">------------------------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">Query Block Name <span class="operator">/</span> Object Alias (identified <span class="keyword">by</span> operation id):</span><br><span class="line"><span class="comment">-------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">  <span class="number">1</span> <span class="operator">-</span> SEL$<span class="number">1</span> <span class="operator">/</span> SPM_TEST_TAB<span class="variable">@SEL</span>$<span class="number">1</span></span><br><span class="line">  <span class="number">2</span> <span class="operator">-</span> SEL$<span class="number">1</span> <span class="operator">/</span> SPM_TEST_TAB<span class="variable">@SEL</span>$<span class="number">1</span></span><br><span class="line"></span><br><span class="line">Outline Data</span><br><span class="line"><span class="comment">-------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*+</span></span><br><span class="line"><span class="comment">    BEGIN_OUTLINE_DATA</span></span><br><span class="line"><span class="comment">    IGNORE_OPTIM_EMBEDDED_HINTS</span></span><br><span class="line"><span class="comment">    OPTIMIZER_FEATURES_ENABLE(&#x27;11.2.0.4&#x27;)</span></span><br><span class="line"><span class="comment">    DB_VERSION(&#x27;11.2.0.4&#x27;)</span></span><br><span class="line"><span class="comment">    ALL_ROWS</span></span><br><span class="line"><span class="comment">    OUTLINE_LEAF(@&quot;SEL$1&quot;)</span></span><br><span class="line"><span class="comment">    INDEX_RS_ASC(@&quot;SEL$1&quot; &quot;SPM_TEST_TAB&quot;@&quot;SEL$1&quot; (&quot;SPM_TEST_TAB&quot;.&quot;ID&quot;))</span></span><br><span class="line"><span class="comment">    END_OUTLINE_DATA</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    Predicate Information (identified <span class="keyword">by</span> operation id):</span><br><span class="line">    <span class="comment">---------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="number">2</span> <span class="operator">-</span> access(&quot;ID&quot;<span class="operator">=</span><span class="number">1113</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">Column</span> Projection Information (identified <span class="keyword">by</span> operation id):</span><br><span class="line">    <span class="comment">-----------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">      <span class="number">1</span> <span class="operator">-</span> &quot;DESCRIPTION&quot;[VARCHAR2,<span class="number">50</span>]</span><br><span class="line">      <span class="number">2</span> <span class="operator">-</span> &quot;SPM_TEST_TAB&quot;.ROWID[ROWID,<span class="number">10</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>从v$sql中查找语句的sql_id，并使用DBMS_SPM.LOAD_PLAN_FROM_CURSOR_CACHE创建SQL Plan Baseline</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">SYS<span class="variable">@DB41</span> <span class="number">2017</span><span class="operator">/</span><span class="number">04</span><span class="operator">/</span><span class="number">26</span> <span class="number">14</span>:<span class="number">57</span>:<span class="number">55</span><span class="operator">&gt;</span> <span class="keyword">SELECT</span> SQL_ID,SQL_FULLTEXT <span class="keyword">FROM</span> V$<span class="keyword">SQL</span> <span class="keyword">WHERE</span> SQL_FULLTEXT <span class="keyword">LIKE</span>  <span class="string">&#x27;%1113%&#x27;</span>;</span><br><span class="line"></span><br><span class="line">SQL_ID	      SQL_FULLTEXT</span><br><span class="line"><span class="comment">------------- --------------------------------------------------------------------------------</span></span><br><span class="line">gsttbra9z0ddw <span class="keyword">SELECT</span> description <span class="keyword">FROM</span>  spm_test_tab <span class="keyword">WHERE</span>  id <span class="operator">=</span> <span class="number">1113</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span></span><br><span class="line">   		v_sql_plan_id  pls_integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   		v_sql_plan_id :<span class="operator">=</span> dbms_spm.load_plans_from_cursor_cache(sql_id <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;gsttbra9z0ddw&#x27;</span>);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> SQL_HANDLE,PLAN_NAME,ENABLED,ACCEPTED</span><br><span class="line"><span class="keyword">FROM</span> dba_sql_plan_baselines</span><br><span class="line"><span class="keyword">WHERE</span> signature <span class="keyword">IN</span></span><br><span class="line">   	( <span class="keyword">SELECT</span> exact_matching_signature <span class="keyword">FROM</span> v$<span class="keyword">sql</span> <span class="keyword">WHERE</span> sql_id<span class="operator">=</span><span class="string">&#x27;gsttbra9z0ddw&#x27;</span></span><br><span class="line">   	);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> 	SQL_HANDLE		       		   PLAN_NAME		      		  ENA ACC</span><br><span class="line"><span class="comment">------------------------------ ------------------------------ --- ---</span></span><br><span class="line">SQL_c1c9aa52fd90f3ae	       SQL_PLAN_c3kdaabyt1wxfed3324c0 YES YES</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用ALTER_SQL_PLAN_BASELINE禁用原执行计划</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span></span><br><span class="line">   		v_sql_plan_id  pls_integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   		v_sql_plan_id :<span class="operator">=</span> dbms_spm.ALTER_SQL_PLAN_BASELINE(sql_handle <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;SQL_c1c9aa52fd90f3ae&#x27;</span>,</span><br><span class="line">   		plan_name <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;SQL_PLAN_c3kdaabyt1wxfed3324c0&#x27;</span>,</span><br><span class="line">   		attribute_name <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;enabled&#x27;</span>,</span><br><span class="line">   		attribute_value <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;NO&#x27;</span>);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">SQL_HANDLE		       		   PLAN_NAME		      		  ENA ACC</span><br><span class="line"><span class="comment">------------------------------ ------------------------------ --- ---</span></span><br><span class="line">SQL_c1c9aa52fd90f3ae	       SQL_PLAN_c3kdaabyt1wxfed3324c0  <span class="keyword">NO</span> YES</span><br></pre></td></tr></table></figure>
</li>
<li><p>加入hint使sql走全表扫描</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ FULL(SPM_TEST_TAB) */</span>description <span class="keyword">FROM</span>  spm_test_tab <span class="keyword">WHERE</span>  id <span class="operator">=</span> <span class="number">1113</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">TABLE</span> (<span class="keyword">SELECT</span> DBMS_XPLAN.DISPLAY_CURSOR(<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="string">&#x27;advanced&#x27;</span>) <span class="keyword">from</span> dual);</span><br><span class="line"></span><br><span class="line">SQL_ID	fr5dd23pfbjfz, child number <span class="number">0</span></span><br><span class="line"><span class="comment">-------------------------------------</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*+ FULL(SPM_TEST_TAB) */</span>description <span class="keyword">FROM</span>  spm_test_tab <span class="keyword">WHERE</span></span><br><span class="line">id <span class="operator">=</span> <span class="number">1113</span></span><br><span class="line"></span><br><span class="line">Plan hash <span class="keyword">value</span>: <span class="number">1107868462</span></span><br><span class="line"></span><br><span class="line"><span class="comment">----------------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span> Id  <span class="operator">|</span> Operation	  		<span class="operator">|</span> Name	 	   <span class="operator">|</span> <span class="keyword">Rows</span>  <span class="operator">|</span> Bytes <span class="operator">|</span> Cost (<span class="operator">%</span>CPU)<span class="operator">|</span> <span class="type">Time</span>	  <span class="operator">|</span></span><br><span class="line"><span class="comment">----------------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">0</span> <span class="operator">|</span> <span class="keyword">SELECT</span> STATEMENT  	<span class="operator">|</span>		 	   <span class="operator">|</span>	   <span class="operator">|</span>	   <span class="operator">|</span>    <span class="number">13</span> (<span class="number">100</span>)<span class="operator">|</span> 	      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span><span class="operator">*</span>  <span class="number">1</span> <span class="operator">|</span>  <span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span>	<span class="operator">|</span> SPM_TEST_TAB <span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span>    <span class="number">25</span> <span class="operator">|</span>    <span class="number">13</span>   (<span class="number">0</span>)<span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span><span class="operator">|</span></span><br><span class="line"><span class="comment">----------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">Query Block Name <span class="operator">/</span> Object Alias (identified <span class="keyword">by</span> operation id):</span><br><span class="line"><span class="comment">-------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">  	<span class="number">1</span> <span class="operator">-</span> SEL$<span class="number">1</span> <span class="operator">/</span> SPM_TEST_TAB<span class="variable">@SEL</span>$<span class="number">1</span></span><br><span class="line"></span><br><span class="line">Outline Data</span><br><span class="line"><span class="comment">-------------</span></span><br><span class="line"></span><br><span class="line">	 <span class="comment">/*+</span></span><br><span class="line"><span class="comment">     	BEGIN_OUTLINE_DATA</span></span><br><span class="line"><span class="comment">     	IGNORE_OPTIM_EMBEDDED_HINTS</span></span><br><span class="line"><span class="comment">     	OPTIMIZER_FEATURES_ENABLE(&#x27;11.2.0.4&#x27;)</span></span><br><span class="line"><span class="comment">     	DB_VERSION(&#x27;11.2.0.4&#x27;)</span></span><br><span class="line"><span class="comment">     	ALL_ROWS</span></span><br><span class="line"><span class="comment">     	OUTLINE_LEAF(@&quot;SEL$1&quot;)</span></span><br><span class="line"><span class="comment">     	FULL(@&quot;SEL$1&quot; &quot;SPM_TEST_TAB&quot;@&quot;SEL$1&quot;)</span></span><br><span class="line"><span class="comment">     	END_OUTLINE_DATA</span></span><br><span class="line"><span class="comment"> 	*/</span></span><br><span class="line"></span><br><span class="line">Predicate Information (identified <span class="keyword">by</span> operation id):</span><br><span class="line"><span class="comment">---------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">  		<span class="number">1</span> <span class="operator">-</span> <span class="keyword">filter</span>(&quot;ID&quot;<span class="operator">=</span><span class="number">1113</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">Column</span> Projection Information (identified <span class="keyword">by</span> operation id):</span><br><span class="line"><span class="comment">-----------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">  		<span class="number">1</span> <span class="operator">-</span> &quot;DESCRIPTION&quot;[VARCHAR2,<span class="number">50</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>在V$SQL中找到加入hint的语句的sql_id和plan_hash_value</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> SQL_ID,PLAN_HASH_VALUE,SQL_FULLTEXT <span class="keyword">FROM</span> V$<span class="keyword">SQL</span> <span class="keyword">WHERE</span> SQL_FULLTEXT <span class="keyword">LIKE</span>  <span class="string">&#x27;%1113%&#x27;</span>;</span><br><span class="line"></span><br><span class="line">SQL_ID	      PLAN_HASH_VALUE SQL_FULLTEXT</span><br><span class="line"><span class="comment">------------- --------------- --------------------------------------------------------------------------------</span></span><br><span class="line">fr5dd23pfbjfz	   <span class="number">1107868462</span> <span class="keyword">SELECT</span> <span class="comment">/*+ FULL(SPM_TEST_TAB) */</span>description <span class="keyword">FROM</span>	spm_test_tab <span class="keyword">WHERE</span>  id <span class="operator">=</span> <span class="number">1113</span></span><br><span class="line"><span class="number">08</span>vxbgd0qrm8s	    <span class="number">903671040</span> <span class="keyword">SELECT</span> SQL_ID,SQL_FULLTEXT <span class="keyword">FROM</span> V$<span class="keyword">SQL</span> <span class="keyword">WHERE</span> SQL_FULLTEXT <span class="keyword">LIKE</span>  <span class="string">&#x27;%1113%&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>利用SQL_ID和PLAN_HASH_VALUE创建一个新的accepted的plan，并通过SQL_HANDLE将修改过的plan与原SQL联系起来</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span></span><br><span class="line">   		v_sql_plan_id  pls_integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   		v_sql_plan_id :<span class="operator">=</span> dbms_spm.load_plans_from_cursor_cache(sql_id <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;fr5dd23pfbjfz&#x27;</span>,</span><br><span class="line">   		plan_hash_value <span class="operator">=</span><span class="operator">&gt;</span> <span class="number">1107868462</span>,</span><br><span class="line">   		sql_handle <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;SQL_c1c9aa52fd90f3ae&#x27;</span>);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="operator">/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查询DBA_SQL_PLAN_BASELINES会看到2个plan</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SQL_HANDLE		       		   PLAN_NAME		              ENA ACC</span><br><span class="line"><span class="comment">------------------------------ ------------------------------ --- ---</span></span><br><span class="line">SQL_c1c9aa52fd90f3ae	       SQL_PLAN_c3kdaabyt1wxfb65c37c8 YES YES</span><br><span class="line">SQL_c1c9aa52fd90f3ae	       SQL_PLAN_c3kdaabyt1wxfed3324c0 <span class="keyword">NO</span>  YES</span><br></pre></td></tr></table></figure>
</li>
<li><p>现在执行原sql查看其执行计划</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">SYS<span class="variable">@DB41</span> <span class="number">2017</span><span class="operator">/</span><span class="number">04</span><span class="operator">/</span><span class="number">26</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">44</span><span class="operator">&gt;</span> <span class="keyword">SET</span> AUTOTRACE TRACE</span><br><span class="line">SYS<span class="variable">@DB41</span> <span class="number">2017</span><span class="operator">/</span><span class="number">04</span><span class="operator">/</span><span class="number">26</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">57</span><span class="operator">&gt;</span> <span class="keyword">SELECT</span> description <span class="keyword">FROM</span>  spm_test_tab <span class="keyword">WHERE</span>  id <span class="operator">=</span> <span class="number">1113</span>;</span><br><span class="line"></span><br><span class="line">Execution Plan</span><br><span class="line"><span class="comment">----------------------------------------------------------</span></span><br><span class="line">Plan hash <span class="keyword">value</span>: <span class="number">1107868462</span></span><br><span class="line"></span><br><span class="line"><span class="comment">----------------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span> Id  <span class="operator">|</span> Operation	  	  <span class="operator">|</span> Name	 	 <span class="operator">|</span> <span class="keyword">Rows</span>  <span class="operator">|</span> Bytes <span class="operator">|</span> Cost (<span class="operator">%</span>CPU)<span class="operator">|</span> <span class="type">Time</span>	 <span class="operator">|</span></span><br><span class="line"><span class="comment">----------------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">0</span> <span class="operator">|</span> <span class="keyword">SELECT</span> STATEMENT  <span class="operator">|</span>		 	 	 <span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span>    <span class="number">25</span> <span class="operator">|</span>    <span class="number">13</span>   (<span class="number">0</span>)<span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span><span class="operator">*</span>  <span class="number">1</span> <span class="operator">|</span>  <span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span><span class="operator">|</span> SPM_TEST_TAB <span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span>    <span class="number">25</span> <span class="operator">|</span>    <span class="number">13</span>   (<span class="number">0</span>)<span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span> <span class="operator">|</span></span><br><span class="line"><span class="comment">----------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">Predicate Information (identified <span class="keyword">by</span> operation id):</span><br><span class="line"><span class="comment">---------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">  		<span class="number">1</span> <span class="operator">-</span> <span class="keyword">filter</span>(&quot;ID&quot;<span class="operator">=</span><span class="number">1113</span>)</span><br><span class="line"></span><br><span class="line">Note</span><br><span class="line"><span class="comment">-----</span></span><br><span class="line">  		<span class="operator">-</span> <span class="keyword">SQL</span> plan baseline &quot;SQL_PLAN_c3kdaabyt1wxfb65c37c8&quot; used <span class="keyword">for</span> this statement</span><br><span class="line"></span><br><span class="line">Statistics</span><br><span class="line"><span class="comment">----------------------------------------------------------</span></span><br><span class="line"><span class="number">7</span>  <span class="keyword">recursive</span> calls</span><br><span class="line"><span class="number">0</span>  db block gets</span><br><span class="line"><span class="number">45</span>  consistent gets</span><br><span class="line"><span class="number">0</span>  physical <span class="keyword">reads</span></span><br><span class="line"><span class="number">0</span>  redo size</span><br><span class="line"><span class="number">367</span>  bytes sent via <span class="keyword">SQL</span><span class="operator">*</span>Net <span class="keyword">to</span> client</span><br><span class="line"><span class="number">476</span>  bytes received via <span class="keyword">SQL</span><span class="operator">*</span>Net <span class="keyword">from</span> client</span><br><span class="line"><span class="number">2</span>  <span class="keyword">SQL</span><span class="operator">*</span>Net roundtrips <span class="keyword">to</span><span class="operator">/</span><span class="keyword">from</span> client</span><br><span class="line"><span class="number">0</span>  sorts (memory)</span><br><span class="line"><span class="number">0</span>  sorts (disk)</span><br><span class="line"><span class="number">1</span>  <span class="keyword">rows</span> processed</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>可见，执行计划已改变</strong></p>
<p><strong>注： 测试过程中发现，使用SQL Plan Baseline的sql无法再用SELECT * FROM TABLE (SELECT DBMS_XPLAN.DISPLAY_CURSOR(null,null,&#39;advanced&#39;) from dual)获取其上次的执行计划。</strong></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2017/04/26/oracle/perf/SPM-Loading-Plans-from-the-Shared-SQL-Area/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/gzh.jpg">
      <meta itemprop="name" content="巴流">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
      <meta itemprop="description" content="左手人文 | 右手科技">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 兔子先生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/04/26/oracle/perf/SPM-Loading-Plans-from-the-Shared-SQL-Area/" class="post-title-link" itemprop="url">SPM Loading Plans from the Shared SQL Area</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-04-26 11:29:00" itemprop="dateCreated datePublished" datetime="2017-04-26T11:29:00+08:00">2017-04-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-07 09:32:12" itemprop="dateModified" datetime="2025-02-07T09:32:12+08:00">2025-02-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oracle/" itemprop="url" rel="index"><span itemprop="name">oracle</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>从Cursor Cache中加载执行计划到SPM中，是最常用的一种方式，下面将介绍整个加载的步骤。</p>
</blockquote>
<ol>
<li><p>确认sql在Cursor Cache中</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">select</span> s.CHILD_NUMBER,</span><br><span class="line">      s.PLAN_HASH_VALUE,</span><br><span class="line">      s.HASH_VALUE,</span><br><span class="line">      s.PARSING_SCHEMA_NAME,</span><br><span class="line">      s.LAST_ACTIVE_TIME,</span><br><span class="line">      s.OPTIMIZER_COST,</span><br><span class="line">      s.sql_plan_baseline</span><br><span class="line"><span class="keyword">from</span> v$<span class="keyword">sql</span> s</span><br><span class="line"><span class="keyword">where</span> sql_id <span class="operator">=</span> <span class="string">&#x27;1s6a8wn4p6rym&#x27;</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> s.LAST_ACTIVE_TIME <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
<p> <em>*注意，不是所有在v$sql中看到的plan都被加载到SPM中，其中有个规律是，如果plan是相同的，即便是不同的schema，在SPM中都只有一条plan，而且这不同的schema执行同样的sql时，会使用同一个执行计划基线（前提是基线的plan能够在各自的schema中重新生成）</em></p>
</li>
<li><p>使用DBMS_SPM.LOAD_PLANS_FROM_CURSOR_CACHE加载执行计划</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span></span><br><span class="line">   		v_sql_plan_id  pls_integer;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">   		v_sql_plan_id :<span class="operator">=</span> dbms_spm.load_plans_from_cursor_cache(sql_id <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;59t5p5xv2bjjy&#x27;</span>);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="operator">/</span></span><br></pre></td></tr></table></figure>
<p> 该匿名块会将CURSOR_CACHE中所有的plan都加入到SQL Plan Baseline中，并默认为accepted，如需改变默认效果，请参阅<span class="exturl" data-url="aHR0cDovL2RvY3Mub3JhY2xlLmNvbS9kYXRhYmFzZS8xMjIvQVJQTFMvREJNU19TUE0uaHRtI0dVSUQtNEVGRTcyOEItOEEyQS00REY0LUFCRTYtRTdCMTMzQ0RCNURB">Oracle Database PL&#x2F;SQL Packages and Types Reference<i class="fa fa-external-link-alt"></i></span></p>
</li>
<li><p>查看DBA_SQL_PLAN_BASELINES确认load结果</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> dba_sql_plan_baselines</span><br><span class="line"><span class="keyword">WHERE</span> signature <span class="keyword">IN</span></span><br><span class="line">   	( <span class="keyword">SELECT</span> exact_matching_signature <span class="keyword">FROM</span> v$<span class="keyword">sql</span> <span class="keyword">WHERE</span> sql_id<span class="operator">=</span><span class="string">&#x27;59t5p5xv2bjjy&#x27;</span></span><br><span class="line">   	);</span><br></pre></td></tr></table></figure></li>
<li><p>删除掉不想要的Baseline</p>
<p> 如果能确定不想要的plan（当然，也可以在load的时候进行选择），那么可以通过<em>SPM.DROP_SQL_PLAN_BASELINE</em>删除</p>
<p> 先找到sql_handle,再查找该sql_handle下所有的plan，例如：</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> sql_handle</span><br><span class="line"><span class="keyword">FROM</span> dba_sql_plan_baselines</span><br><span class="line"><span class="keyword">WHERE</span> signature <span class="keyword">IN</span></span><br><span class="line">   	( <span class="keyword">SELECT</span> exact_matching_signature <span class="keyword">FROM</span> v$<span class="keyword">sql</span> <span class="keyword">WHERE</span> sql_id<span class="operator">=</span><span class="string">&#x27;59t5p5xv2bjjy&#x27;</span></span><br><span class="line">   	);</span><br></pre></td></tr></table></figure></li>
</ol>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> 	select SIGNATURE,</span><br><span class="line">      SQL_HANDLE,</span><br><span class="line">      SQL_TEXT,</span><br><span class="line">      PLAN_NAME,</span><br><span class="line">      PARSING_SCHEMA_NAME,</span><br><span class="line">      LAST_EXECUTED,</span><br><span class="line">      ENABLED,</span><br><span class="line">      ACCEPTED,</span><br><span class="line">      REPRODUCED,</span><br><span class="line">      EXECUTIONS,</span><br><span class="line">      optimizer_cost</span><br><span class="line">   from dba_sql_plan_baselines;</span><br><span class="line">where sql_handle =&#x27;SQL_fca270c30418ee86&#x27;;</span><br></pre></td></tr></table></figure>

<pre><code>确定不需要的plan有很多方式，如果你正在tuning该条sql，那么你对不好的执行计划的cost肯定印象深刻，那么就可以根据optimizer_cost确定PLAN_NAME，也可以通过*dbms_xplan.display_sql_plan_baseline*来浏览执行计划确定，接下来就可以删除该plan了：

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line"> 		v_dropped_plans number;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"> 		v_dropped_plans :<span class="operator">=</span> DBMS_SPM.DROP_SQL_PLAN_BASELINE (</span><br><span class="line">    	sql_handle <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;SQL_971c23013e9cf52a&#x27;</span>,</span><br><span class="line">    	plan_name <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;SQL_PLAN_9f71304z9tx9a42ef5257&#x27;</span></span><br><span class="line">	);</span><br><span class="line"> 		DBMS_OUTPUT.PUT_LINE(<span class="string">&#x27;dropped &#x27;</span> <span class="operator">||</span> v_dropped_plans <span class="operator">||</span> <span class="string">&#x27; plans&#x27;</span>);</span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>
</code></pre>
<ol start="5">
<li><p>演化（evolve）新的plan</p>
<p> 11g默认为已存在Baseline的SQL自动捕捉新的plan，但新的plan为unaccepted的状态，要使用新的plan，需要演化（evolve）为accepted，下面介绍11g的演化方法，12c请参阅<a href="https://liupzmin.com/2017/04/24/oracle/perf/Manually-Evolving-SQL-Plan-Baselines-in-Oracle-Database-12c-Release-2/">MANUALLY EVOLVING SQL PLAN BASELINES IN ORACLE DATABASE 12C RELEASE 2</a></p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span>  </span><br><span class="line"> 		l_plans_altered  <span class="type">clob</span>;  </span><br><span class="line"><span class="keyword">BEGIN</span>  </span><br><span class="line">	l_plans_altered :<span class="operator">=</span> dbms_spm.evolve_sql_plan_baseline(  </span><br><span class="line">	sql_handle      <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;SQL_fca270c30418ee86&#x27;</span>,  </span><br><span class="line">	plan_name       <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;SQL_PLAN_gt8mhsc21jvn62e14fda0&#x27;</span>,  </span><br><span class="line">	verify           <span class="operator">=</span><span class="operator">&gt;</span><span class="string">&#x27;YES&#x27;</span>,  </span><br><span class="line">	<span class="keyword">commit</span>      <span class="operator">=</span><span class="operator">&gt;</span><span class="string">&#x27;YES&#x27;</span>);  </span><br><span class="line">	DBMS_OUTPUT.put_line(<span class="string">&#x27;Plans Altered: &#x27;</span> <span class="operator">||</span> l_plans_altered);  </span><br><span class="line"><span class="keyword">END</span>;  </span><br><span class="line"><span class="operator">/</span>  </span><br></pre></td></tr></table></figure>

<p> 该匿名块会评估测试执行plan_name为<em>SQL_PLAN_gt8mhsc21jvn62e14fda0</em>的plan，并生成报告，如果它的性能优于现存的accepted的plan，那么它会被自动接受为accepted，否则便不会被接受。</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2017/04/24/oracle/perf/Manually-Evolving-SQL-Plan-Baselines-in-Oracle-Database-12c-Release-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/gzh.jpg">
      <meta itemprop="name" content="巴流">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
      <meta itemprop="description" content="左手人文 | 右手科技">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 兔子先生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2017/04/24/oracle/perf/Manually-Evolving-SQL-Plan-Baselines-in-Oracle-Database-12c-Release-2/" class="post-title-link" itemprop="url">Manually Evolving SQL Plan Baselines in Oracle Database 12c Release 2</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2017-04-24 21:29:00" itemprop="dateCreated datePublished" datetime="2017-04-24T21:29:00+08:00">2017-04-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-07 09:32:12" itemprop="dateModified" datetime="2025-02-07T09:32:12+08:00">2025-02-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oracle/" itemprop="url" rel="index"><span itemprop="name">oracle</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在oracle 12.1之前，是使用<em>EVOLVE_SQL_PLAN_BASELINE</em>函数来演化SQL plan baselines，从12c开始，演化的过程就被基于task的方法代替了，12c的演化过程主要包括以下几个阶段：</p>
<ul>
<li>CREATE_EVOLVE_TASK</li>
<li>EXECUTE_EVOLVE_TASK</li>
<li>REPORT_EVOLVE_TASK</li>
<li>IMPLEMENT_EVOLVE_TASK</li>
</ul>
<p>下面将演示以下12c执行计划基线演化的过程：</p>
<p>先来创建一个测试表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> spm_test_tab (</span><br><span class="line">  id           NUMBER,</span><br><span class="line">  description  VARCHAR2(<span class="number">50</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="comment">/*+ APPEND */</span> <span class="keyword">INTO</span> spm_test_tab</span><br><span class="line"><span class="keyword">SELECT</span> level,</span><br><span class="line">       <span class="string">&#x27;Description for &#x27;</span> <span class="operator">||</span> level</span><br><span class="line"><span class="keyword">FROM</span>   dual</span><br><span class="line"><span class="keyword">CONNECT</span> <span class="keyword">BY</span> level <span class="operator">&lt;=</span> <span class="number">10000</span>;</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<p>查询一条记录，并查看其执行计划</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> description</span><br><span class="line"><span class="keyword">FROM</span>   spm_test_tab</span><br><span class="line"><span class="keyword">WHERE</span>  id <span class="operator">=</span> <span class="number">99</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">TABLE</span> (<span class="keyword">SELECT</span> DBMS_XPLAN.DISPLAY_CURSOR(<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="string">&#x27;advanced&#x27;</span>) <span class="keyword">from</span> dual);</span><br><span class="line"></span><br><span class="line">PLAN_TABLE_OUTPUT</span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span></span><br><span class="line">SQL_ID	gat6z1bc6nc2d, child number <span class="number">0</span></span><br><span class="line"><span class="comment">-------------------------------------</span></span><br><span class="line"><span class="keyword">SELECT</span> description <span class="keyword">FROM</span>   spm_test_tab <span class="keyword">WHERE</span>  id <span class="operator">=</span> <span class="number">99</span></span><br><span class="line"></span><br><span class="line">Plan hash <span class="keyword">value</span>: <span class="number">1107868462</span></span><br><span class="line"></span><br><span class="line"><span class="comment">----------------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span> Id  <span class="operator">|</span> Operation	      <span class="operator">|</span> Name	     <span class="operator">|</span> <span class="keyword">Rows</span>  <span class="operator">|</span> Bytes <span class="operator">|</span> Cost (<span class="operator">%</span>CPU)<span class="operator">|</span> <span class="type">Time</span>	 <span class="operator">|</span></span><br><span class="line"><span class="comment">----------------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">0</span> <span class="operator">|</span> <span class="keyword">SELECT</span> STATEMENT  <span class="operator">|</span>		         <span class="operator">|</span>	     <span class="operator">|</span>	     <span class="operator">|</span>    <span class="number">13</span> (<span class="number">100</span>)<span class="operator">|</span> 	     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span><span class="operator">*</span>  <span class="number">1</span> <span class="operator">|</span>  <span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span><span class="operator">|</span> SPM_TEST_TAB <span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span>    <span class="number">40</span> <span class="operator">|</span>    <span class="number">13</span>   (<span class="number">0</span>)<span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span> <span class="operator">|</span></span><br><span class="line"><span class="comment">----------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">Query Block Name <span class="operator">/</span> Object Alias (identified <span class="keyword">by</span> operation id):</span><br><span class="line"><span class="comment">-------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">   <span class="number">1</span> <span class="operator">-</span> SEL$<span class="number">1</span> <span class="operator">/</span> SPM_TEST_TAB<span class="variable">@SEL</span>$<span class="number">1</span></span><br><span class="line"></span><br><span class="line">Outline Data</span><br><span class="line"><span class="comment">-------------</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/*+</span></span><br><span class="line"><span class="comment">      BEGIN_OUTLINE_DATA</span></span><br><span class="line"><span class="comment">      IGNORE_OPTIM_EMBEDDED_HINTS</span></span><br><span class="line"><span class="comment">      OPTIMIZER_FEATURES_ENABLE(&#x27;12.2.0.1&#x27;)</span></span><br><span class="line"><span class="comment">      DB_VERSION(&#x27;12.2.0.1&#x27;)</span></span><br><span class="line"><span class="comment">      ALL_ROWS</span></span><br><span class="line"><span class="comment">      OUTLINE_LEAF(@&quot;SEL$1&quot;)</span></span><br><span class="line"><span class="comment">      FULL(@&quot;SEL$1&quot; &quot;SPM_TEST_TAB&quot;@&quot;SEL$1&quot;)</span></span><br><span class="line"><span class="comment">      END_OUTLINE_DATA</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">Predicate Information (identified <span class="keyword">by</span> operation id):</span><br><span class="line"><span class="comment">---------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">   <span class="number">1</span> <span class="operator">-</span> <span class="keyword">filter</span>(&quot;ID&quot;<span class="operator">=</span><span class="number">99</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">Column</span> Projection Information (identified <span class="keyword">by</span> operation id):</span><br><span class="line"><span class="comment">-----------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">   <span class="number">1</span> <span class="operator">-</span> &quot;DESCRIPTION&quot;[VARCHAR2,<span class="number">50</span>]</span><br><span class="line"></span><br><span class="line">Note</span><br><span class="line"><span class="comment">-----</span></span><br><span class="line">   <span class="operator">-</span> <span class="keyword">dynamic</span> statistics used: <span class="keyword">dynamic</span> sampling (level<span class="operator">=</span><span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<p>查询sql_id</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> sql_id</span><br><span class="line"><span class="keyword">FROM</span>   v$<span class="keyword">sql</span></span><br><span class="line"><span class="keyword">WHERE</span>  plan_hash_value <span class="operator">=</span> <span class="number">1107868462</span>;</span><br><span class="line"></span><br><span class="line">SQL_ID</span><br><span class="line"><span class="comment">-------------</span></span><br><span class="line">gat6z1bc6nc2d</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>将该sql的执行计划从cursor cache中加载到SQL Plan Baseline</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> SERVEROUTPUT <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">  l_plans_loaded  PLS_INTEGER;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  l_plans_loaded :<span class="operator">=</span> DBMS_SPM.load_plans_from_cursor_cache(</span><br><span class="line">    sql_id <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;gat6z1bc6nc2d&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">  DBMS_OUTPUT.put_line(<span class="string">&#x27;Plans Loaded: &#x27;</span> <span class="operator">||</span> l_plans_loaded);</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"><span class="operator">/</span></span><br><span class="line">Plans Loaded: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">PL<span class="operator">/</span><span class="keyword">SQL</span> <span class="keyword">procedure</span> successfully completed.</span><br></pre></td></tr></table></figure>

<p>在DBA_SQL_PLAN_BASELINES中查询baseline的信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">COLUMN</span> sql_handle FORMAT A20</span><br><span class="line"><span class="keyword">COLUMN</span> plan_name FORMAT A30</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> sql_handle, plan_name, enabled, accepted </span><br><span class="line"><span class="keyword">FROM</span>   dba_sql_plan_baselines;</span><br><span class="line"></span><br><span class="line">SQL_HANDLE	     			PLAN_NAME			    ENA ACC</span><br><span class="line"><span class="comment">-------------------- ------------------------------ --- ---</span></span><br><span class="line">SQL_7b76323ad90440b9 SQL_PLAN_7qxjk7bch8h5tb65c37c8 YES YES</span><br></pre></td></tr></table></figure>
<p>创建一条索引，再次执行该sql，查看执行计划结果</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> INDEX spm_test_tab_idx <span class="keyword">ON</span> spm_test_tab(id);</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"> dbms_stats.gather_table_stats(ownname <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;SYS&#x27;</span>,</span><br><span class="line"> tabname <span class="operator">=</span><span class="operator">&gt;</span><span class="string">&#x27;SPM_TEST_TAB&#x27;</span>,</span><br><span class="line"> estimate_percent <span class="operator">=</span><span class="operator">&gt;</span>DBMS_STATS.AUTO_SAMPLE_SIZE,</span><br><span class="line"> method_opt <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;FOR ALL COLUMNS SIZE AUTO&#x27;</span>,</span><br><span class="line"> granularity<span class="operator">=</span><span class="operator">&gt;</span><span class="string">&#x27;ALL&#x27;</span>,</span><br><span class="line"> cascade <span class="operator">=</span><span class="operator">&gt;</span> <span class="literal">TRUE</span>,</span><br><span class="line"> no_invalidate <span class="operator">=</span><span class="operator">&gt;</span> <span class="literal">false</span>);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> description</span><br><span class="line"><span class="keyword">FROM</span>   spm_test_tab</span><br><span class="line"><span class="keyword">WHERE</span>  id <span class="operator">=</span> <span class="number">99</span>;</span><br><span class="line"></span><br><span class="line">Execution Plan</span><br><span class="line"><span class="comment">----------------------------------------------------------</span></span><br><span class="line">Plan hash <span class="keyword">value</span>: <span class="number">1107868462</span></span><br><span class="line"></span><br><span class="line"><span class="comment">----------------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span> Id  <span class="operator">|</span> Operation	  		<span class="operator">|</span> Name	 	   <span class="operator">|</span> <span class="keyword">Rows</span>  <span class="operator">|</span> Bytes <span class="operator">|</span> Cost (<span class="operator">%</span>CPU)<span class="operator">|</span> <span class="type">Time</span>	  <span class="operator">|</span></span><br><span class="line"><span class="comment">----------------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">0</span> <span class="operator">|</span> <span class="keyword">SELECT</span> STATEMENT  	<span class="operator">|</span>		 	   <span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span>    <span class="number">25</span> <span class="operator">|</span>    <span class="number">13</span>   (<span class="number">0</span>)<span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span><span class="operator">|</span></span><br><span class="line"><span class="operator">|</span><span class="operator">*</span>  <span class="number">1</span> <span class="operator">|</span>  <span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span>	<span class="operator">|</span> SPM_TEST_TAB <span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span>    <span class="number">25</span> <span class="operator">|</span>    <span class="number">13</span>   (<span class="number">0</span>)<span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span><span class="operator">|</span></span><br><span class="line"><span class="comment">----------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">Predicate Information (identified <span class="keyword">by</span> operation id):</span><br><span class="line"><span class="comment">---------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">   <span class="number">1</span> <span class="operator">-</span> <span class="keyword">filter</span>(&quot;ID&quot;<span class="operator">=</span><span class="number">99</span>)</span><br><span class="line"></span><br><span class="line">Note</span><br><span class="line"><span class="comment">-----</span></span><br><span class="line">   <span class="operator">-</span> <span class="keyword">SQL</span> plan baseline &quot;SQL_PLAN_7qxjk7bch8h5tb65c37c8&quot; used <span class="keyword">for</span> this statement</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Statistics</span><br><span class="line"><span class="comment">----------------------------------------------------------</span></span><br><span class="line"><span class="number">0</span>  <span class="keyword">recursive</span> calls</span><br><span class="line"><span class="number">3</span>  db block gets</span><br><span class="line"><span class="number">52</span>  consistent gets</span><br><span class="line"><span class="number">0</span>  physical <span class="keyword">reads</span></span><br><span class="line"><span class="number">0</span>  redo size</span><br><span class="line"><span class="number">365</span>  bytes sent via <span class="keyword">SQL</span><span class="operator">*</span>Net <span class="keyword">to</span> client</span><br><span class="line"><span class="number">484</span>  bytes received via <span class="keyword">SQL</span><span class="operator">*</span>Net <span class="keyword">from</span> client</span><br><span class="line"><span class="number">2</span>  <span class="keyword">SQL</span><span class="operator">*</span>Net roundtrips <span class="keyword">to</span><span class="operator">/</span><span class="keyword">from</span> client</span><br><span class="line"><span class="number">0</span>  sorts (memory)</span><br><span class="line"><span class="number">0</span>  sorts (disk)</span><br><span class="line"><span class="number">1</span>  <span class="keyword">rows</span> processed</span><br></pre></td></tr></table></figure>

<p>可见，在有索引的情况下执行计划依然走了全表扫描，说明SPM已发挥作用，现在查看一下DBA_SQL_PLAN_BASELINES</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> sql_handle, plan_name, enabled, accepted </span><br><span class="line"><span class="keyword">FROM</span>   dba_sql_plan_baselines</span><br><span class="line"><span class="keyword">WHERE</span>  sql_handle <span class="operator">=</span> <span class="string">&#x27;SQL_7b76323ad90440b9&#x27;</span>;</span><br><span class="line"></span><br><span class="line">SQL_HANDLE	     	 PLAN_NAME			    		ENA ACC</span><br><span class="line"><span class="comment">-------------------- ------------------------------ --- ---</span></span><br><span class="line">SQL_7b76323ad90440b9 SQL_PLAN_7qxjk7bch8h5t3652c362 YES <span class="keyword">NO</span></span><br><span class="line">SQL_7b76323ad90440b9 SQL_PLAN_7qxjk7bch8h5tb65c37c8 YES YES</span><br></pre></td></tr></table></figure>

<p>现在执行计划基线中已经有了一条未被accepted的计划，我们可以查看一下该计划的内容：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">   <span class="operator">*</span> </span><br><span class="line"><span class="keyword">from</span> <span class="keyword">table</span>( </span><br><span class="line">    dbms_xplan.display_sql_plan_baseline( </span><br><span class="line">        sql_handle<span class="operator">=</span><span class="operator">&gt;</span><span class="string">&#x27;SQL_7b76323ad90440b9&#x27;</span>, </span><br><span class="line">        plan_name<span class="operator">=</span><span class="operator">&gt;</span><span class="string">&#x27;SQL_PLAN_7qxjk7bch8h5t3652c362&#x27;</span>,</span><br><span class="line">        format<span class="operator">=</span><span class="operator">&gt;</span><span class="string">&#x27;basic +NOTE&#x27;</span>));</span><br><span class="line">        </span><br><span class="line"> <span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="keyword">SQL</span> handle: SQL_7b76323ad90440b9</span><br><span class="line"><span class="keyword">SQL</span> text: <span class="keyword">SELECT</span> description <span class="keyword">FROM</span>   spm_test_tab <span class="keyword">WHERE</span>	id <span class="operator">=</span> <span class="number">99</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line">Plan name: SQL_PLAN_7qxjk7bch8h5t3652c362	  Plan id: <span class="number">911393634</span></span><br><span class="line">Enabled: YES	 Fixed: <span class="keyword">NO</span>	Accepted: <span class="keyword">NO</span>	  Origin: AUTO<span class="operator">-</span>CAPTURE</span><br><span class="line">Plan <span class="keyword">rows</span>: <span class="keyword">From</span> dictionary</span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">Plan hash <span class="keyword">value</span>: <span class="number">2338891031</span></span><br><span class="line"></span><br><span class="line"><span class="comment">----------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span> Id  <span class="operator">|</span> Operation			    			<span class="operator">|</span> Name	       	   <span class="operator">|</span></span><br><span class="line"><span class="comment">----------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">0</span> <span class="operator">|</span> <span class="keyword">SELECT</span> STATEMENT		    		<span class="operator">|</span>		       	   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span>  <span class="keyword">TABLE</span> ACCESS <span class="keyword">BY</span> INDEX ROWID BATCHED<span class="operator">|</span> SPM_TEST_TAB     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span>   INDEX <span class="keyword">RANGE</span> SCAN		    		<span class="operator">|</span> SPM_TEST_TAB_IDX <span class="operator">|</span></span><br><span class="line"><span class="comment">----------------------------------------------------------------</span></span><br></pre></td></tr></table></figure>

<p>可见新的plan是走索引的，现在可以等待维护窗口期间由自动维护任务自动evolve，或者手动进行evolve，现在演示手动evolve，创建一个evolve task</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> SERVEROUTPUT <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">  l_return VARCHAR2(<span class="number">32767</span>);</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  l_return :<span class="operator">=</span> DBMS_SPM.create_evolve_task(sql_handle <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;SQL_7b76323ad90440b9&#x27;</span>);</span><br><span class="line">  DBMS_OUTPUT.put_line(<span class="string">&#x27;Task Name: &#x27;</span> <span class="operator">||</span> l_return);</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"><span class="operator">/</span></span><br><span class="line">Task Name: TASK_1169</span><br><span class="line"></span><br><span class="line">PL<span class="operator">/</span><span class="keyword">SQL</span> <span class="keyword">procedure</span> successfully completed.</span><br></pre></td></tr></table></figure>

<p>执行此任务</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> SERVEROUTPUT <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">  l_return VARCHAR2(<span class="number">32767</span>);</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  l_return :<span class="operator">=</span> DBMS_SPM.execute_evolve_task(task_name <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;TASK_1169&#x27;</span>);</span><br><span class="line">  DBMS_OUTPUT.put_line(<span class="string">&#x27;Execution Name: &#x27;</span> <span class="operator">||</span> l_return);</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"><span class="operator">/</span></span><br><span class="line">Execution Name: EXEC_1281</span><br><span class="line"></span><br><span class="line">PL<span class="operator">/</span><span class="keyword">SQL</span> <span class="keyword">procedure</span> successfully completed.</span><br></pre></td></tr></table></figure>

<p>查看任务报告</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> LONG <span class="number">1000000</span> PAGESIZE <span class="number">1000</span> LONGCHUNKSIZE <span class="number">100</span> LINESIZE <span class="number">100</span></span><br><span class="line"><span class="keyword">SELECT</span> DBMS_SPM.report_evolve_task(task_name <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;TASK_1169&#x27;</span>, execution_name <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;EXEC_1281&#x27;</span>) <span class="keyword">AS</span> output</span><br><span class="line"><span class="keyword">FROM</span>   dual;</span><br><span class="line"></span><br><span class="line">OUTPUT</span><br><span class="line"><span class="comment">----------------------------------------------------------------------------------------------------</span></span><br><span class="line">GENERAL INFORMATION SECTION</span><br><span class="line"><span class="comment">---------------------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"> Task Information:</span><br><span class="line"> <span class="comment">---------------------------------------------</span></span><br><span class="line"> Task Name	      	  : TASK_1169</span><br><span class="line"> Task Owner	          : SYS</span><br><span class="line"> Execution Name       : EXEC_1281</span><br><span class="line"> Execution Type       : SPM EVOLVE</span><br><span class="line"> <span class="keyword">Scope</span>		          : COMPREHENSIVE</span><br><span class="line"> Status 	          : COMPLETED</span><br><span class="line"> Started	          : <span class="number">04</span><span class="operator">/</span><span class="number">24</span><span class="operator">/</span><span class="number">2017</span> <span class="number">15</span>:<span class="number">04</span>:<span class="number">17</span></span><br><span class="line"> Finished	          : <span class="number">04</span><span class="operator">/</span><span class="number">24</span><span class="operator">/</span><span class="number">2017</span> <span class="number">15</span>:<span class="number">04</span>:<span class="number">25</span></span><br><span class="line"> <span class="keyword">Last</span> Updated	      : <span class="number">04</span><span class="operator">/</span><span class="number">24</span><span class="operator">/</span><span class="number">2017</span> <span class="number">15</span>:<span class="number">04</span>:<span class="number">25</span></span><br><span class="line"> <span class="keyword">Global</span> <span class="type">Time</span> Limit    : <span class="number">2147483646</span></span><br><span class="line"> <span class="keyword">Per</span><span class="operator">-</span>Plan <span class="type">Time</span> Limit  : UNUSED</span><br><span class="line"> Number <span class="keyword">of</span> Errors     : <span class="number">0</span></span><br><span class="line"><span class="comment">---------------------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">SUMMARY SECTION</span><br><span class="line"><span class="comment">---------------------------------------------------------------------------------------------</span></span><br><span class="line">  Number <span class="keyword">of</span> plans processed  : <span class="number">1</span></span><br><span class="line">  Number <span class="keyword">of</span> findings	     : <span class="number">1</span></span><br><span class="line">  Number <span class="keyword">of</span> recommendations  : <span class="number">1</span></span><br><span class="line">  Number <span class="keyword">of</span> errors	         : <span class="number">0</span></span><br><span class="line"><span class="comment">---------------------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">DETAILS SECTION</span><br><span class="line"><span class="comment">---------------------------------------------------------------------------------------------</span></span><br><span class="line"> Object ID	        : <span class="number">2</span></span><br><span class="line"> Test Plan Name     : SQL_PLAN_7qxjk7bch8h5t3652c362</span><br><span class="line"> Base Plan Name     : SQL_PLAN_7qxjk7bch8h5tb65c37c8</span><br><span class="line"> <span class="keyword">SQL</span> Handle	        : SQL_7b76323ad90440b9</span><br><span class="line"> Parsing Schema     : SYS</span><br><span class="line"> Test Plan Creator  : SYS</span><br><span class="line"> <span class="keyword">SQL</span> Text	        : <span class="keyword">SELECT</span> description <span class="keyword">FROM</span> spm_test_tab <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">99</span></span><br><span class="line"></span><br><span class="line">Execution Statistics:</span><br><span class="line"><span class="comment">-----------------------------</span></span><br><span class="line">		    Base Plan			          Test Plan</span><br><span class="line">		    <span class="comment">----------------------------  ----------------------------</span></span><br><span class="line"> Elapsed <span class="type">Time</span> (s):  <span class="number">.000037</span>			      <span class="number">.000005</span></span><br><span class="line"> CPU <span class="type">Time</span> (s):	    <span class="number">.000044</span>			      <span class="number">0</span></span><br><span class="line"> Buffer Gets:	    <span class="number">5</span>				      <span class="number">0</span></span><br><span class="line"> Optimizer Cost:    <span class="number">13</span>				      <span class="number">2</span></span><br><span class="line"> Disk <span class="keyword">Reads</span>:	    <span class="number">0</span>				      <span class="number">0</span></span><br><span class="line"> Direct Writes:     <span class="number">0</span>				      <span class="number">0</span></span><br><span class="line"> <span class="keyword">Rows</span> Processed:    <span class="number">0</span>				      <span class="number">0</span></span><br><span class="line"> Executions:	    <span class="number">10</span>				      <span class="number">10</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FINDINGS SECTION</span><br><span class="line"><span class="comment">---------------------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">Findings (<span class="number">1</span>):</span><br><span class="line"><span class="comment">-----------------------------</span></span><br><span class="line"> <span class="number">1.</span> The plan was verified <span class="keyword">in</span> <span class="number">0.03200</span> seconds. It passed the benefit criterion</span><br><span class="line">    because its verified performance was <span class="number">18.01480</span> times better than that <span class="keyword">of</span> the</span><br><span class="line">    baseline plan.</span><br><span class="line"></span><br><span class="line">Recommendation:</span><br><span class="line"><span class="comment">-----------------------------</span></span><br><span class="line"> Consider accepting the plan. <span class="keyword">Execute</span></span><br><span class="line"> dbms_spm.accept_sql_plan_baseline(task_name <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;TASK_1169&#x27;</span>, object_id <span class="operator">=</span><span class="operator">&gt;</span> <span class="number">2</span>,</span><br><span class="line"> task_owner <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;SYS&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">EXPLAIN PLANS SECTION</span><br><span class="line"><span class="comment">---------------------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">Baseline Plan</span><br><span class="line"><span class="comment">-----------------------------</span></span><br><span class="line"> Plan Id	  : <span class="number">1</span></span><br><span class="line"> Plan Hash <span class="keyword">Value</span>  : <span class="number">3059496904</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-----------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span> Id  <span class="operator">|</span> Operation	        <span class="operator">|</span> Name	       <span class="operator">|</span> <span class="keyword">Rows</span> <span class="operator">|</span> Bytes <span class="operator">|</span> Cost <span class="operator">|</span> <span class="type">Time</span>     <span class="operator">|</span></span><br><span class="line"><span class="comment">-----------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">0</span> <span class="operator">|</span> <span class="keyword">SELECT</span> STATEMENT    <span class="operator">|</span>		       <span class="operator">|</span>	<span class="number">1</span> <span class="operator">|</span>    <span class="number">25</span> <span class="operator">|</span>   <span class="number">13</span> <span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">*</span> <span class="number">1</span> <span class="operator">|</span>   <span class="keyword">TABLE</span> ACCESS <span class="keyword">FULL</span> <span class="operator">|</span> SPM_TEST_TAB <span class="operator">|</span>	<span class="number">1</span> <span class="operator">|</span>    <span class="number">25</span> <span class="operator">|</span>   <span class="number">13</span> <span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span> <span class="operator">|</span></span><br><span class="line"><span class="comment">-----------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">Predicate Information (identified <span class="keyword">by</span> operation id):</span><br><span class="line"><span class="comment">------------------------------------------</span></span><br><span class="line"><span class="operator">*</span> <span class="number">1</span> <span class="operator">-</span> <span class="keyword">filter</span>(&quot;ID&quot;<span class="operator">=</span><span class="number">99</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Test Plan</span><br><span class="line"><span class="comment">-----------------------------</span></span><br><span class="line"> Plan Id	  : <span class="number">2</span></span><br><span class="line"> Plan Hash <span class="keyword">Value</span>  : <span class="number">911393634</span></span><br><span class="line"></span><br><span class="line"><span class="comment">---------------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span> Id  <span class="operator">|</span> Operation			                 <span class="operator">|</span> Name		        <span class="operator">|</span> <span class="keyword">Rows</span> <span class="operator">|</span> Bytes <span class="operator">|</span> Cost <span class="operator">|</span> <span class="type">Time</span>	 <span class="operator">|</span></span><br><span class="line"><span class="comment">---------------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">0</span> <span class="operator">|</span> <span class="keyword">SELECT</span> STATEMENT		              <span class="operator">|</span> 		         <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span>    <span class="number">25</span> <span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span>   <span class="keyword">TABLE</span> ACCESS <span class="keyword">BY</span> INDEX ROWID BATCHED <span class="operator">|</span> SPM_TEST_TAB	 <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span>    <span class="number">25</span> <span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">*</span> <span class="number">2</span> <span class="operator">|</span>    INDEX <span class="keyword">RANGE</span> SCAN		              <span class="operator">|</span> SPM_TEST_TAB_IDX <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span>	   <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span> <span class="operator">|</span></span><br><span class="line"><span class="comment">---------------------------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">Predicate Information (identified <span class="keyword">by</span> operation id):</span><br><span class="line"><span class="comment">------------------------------------------</span></span><br><span class="line"><span class="operator">*</span> <span class="number">2</span> <span class="operator">-</span> access(&quot;ID&quot;<span class="operator">=</span><span class="number">99</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">---------------------------------------------------------------------------------------------</span></span><br></pre></td></tr></table></figure>

<p>报告中建议执行dbms_spm.accept_sql_plan_baseline接受新的plan，但我们应该使用IMPLEMENT_EVOLVE_TASK来接受新的plan</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> SERVEROUTPUT <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">  l_return NUMBER;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  l_return :<span class="operator">=</span> DBMS_SPM.implement_evolve_task(task_name <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;TASK_1169&#x27;</span>);</span><br><span class="line">  DBMS_OUTPUT.put_line(<span class="string">&#x27;Plans Accepted: &#x27;</span> <span class="operator">||</span> l_return);</span><br><span class="line"><span class="keyword">END</span>;</span><br><span class="line"><span class="operator">/</span></span><br><span class="line">Plans Accepted: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">PL<span class="operator">/</span><span class="keyword">SQL</span> <span class="keyword">procedure</span> successfully completed.</span><br></pre></td></tr></table></figure>

<p>查看DBA_SQL_PLAN_BASELINES，新的plan应该已经是accepted了</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> sql_handle, plan_name, enabled, accepted </span><br><span class="line"><span class="keyword">FROM</span>   dba_sql_plan_baselines</span><br><span class="line"><span class="keyword">WHERE</span>  sql_handle <span class="operator">=</span> <span class="string">&#x27;SQL_7b76323ad90440b9&#x27;</span>;</span><br><span class="line"></span><br><span class="line">SQL_HANDLE	     	 PLAN_NAME			    		ENA ACC</span><br><span class="line"><span class="comment">-------------------- ------------------------------ --- ---</span></span><br><span class="line">SQL_7b76323ad90440b9 SQL_PLAN_7qxjk7bch8h5t3652c362 YES YES</span><br><span class="line">SQL_7b76323ad90440b9 SQL_PLAN_7qxjk7bch8h5tb65c37c8 YES YES</span><br></pre></td></tr></table></figure>

<p>再次执行该sql，查看执行计划</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> AUTOTRACE TRACE LINESIZE <span class="number">130</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> description</span><br><span class="line"><span class="keyword">FROM</span>   spm_test_tab</span><br><span class="line"><span class="keyword">WHERE</span>  id <span class="operator">=</span> <span class="number">99</span>;</span><br><span class="line"></span><br><span class="line">Execution Plan</span><br><span class="line"><span class="comment">----------------------------------------------------------</span></span><br><span class="line">Plan hash <span class="keyword">value</span>: <span class="number">2338891031</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span> Id  <span class="operator">|</span> Operation			               <span class="operator">|</span> Name	          <span class="operator">|</span> <span class="keyword">Rows</span>  <span class="operator">|</span> Bytes <span class="operator">|</span> Cost (<span class="operator">%</span>CPU)<span class="operator">|</span> <span class="type">Time</span>     <span class="operator">|</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">0</span> <span class="operator">|</span> <span class="keyword">SELECT</span> STATEMENT		            <span class="operator">|</span>		           <span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span>    <span class="number">25</span> <span class="operator">|</span>     <span class="number">2</span>	 (<span class="number">0</span>)<span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span>  <span class="keyword">TABLE</span> ACCESS <span class="keyword">BY</span> INDEX ROWID BATCHED<span class="operator">|</span> SPM_TEST_TAB     <span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span>    <span class="number">25</span> <span class="operator">|</span>     <span class="number">2</span>	 (<span class="number">0</span>)<span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span><span class="operator">*</span>  <span class="number">2</span> <span class="operator">|</span>   INDEX <span class="keyword">RANGE</span> SCAN		            <span class="operator">|</span> SPM_TEST_TAB_IDX <span class="operator">|</span>     <span class="number">1</span> <span class="operator">|</span>       <span class="operator">|</span>     <span class="number">1</span>	 (<span class="number">0</span>)<span class="operator">|</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span> <span class="operator">|</span></span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">Predicate Information (identified <span class="keyword">by</span> operation id):</span><br><span class="line"><span class="comment">---------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">   <span class="number">2</span> <span class="operator">-</span> access(&quot;ID&quot;<span class="operator">=</span><span class="number">99</span>)</span><br><span class="line"></span><br><span class="line">Note</span><br><span class="line"><span class="comment">-----</span></span><br><span class="line">   <span class="operator">-</span> <span class="keyword">SQL</span> plan baseline &quot;SQL_PLAN_7qxjk7bch8h5t3652c362&quot; used <span class="keyword">for</span> this statement</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Statistics</span><br><span class="line"><span class="comment">----------------------------------------------------------</span></span><br><span class="line"><span class="number">0</span>  <span class="keyword">recursive</span> calls</span><br><span class="line"><span class="number">0</span>  db block gets</span><br><span class="line"><span class="number">4</span>  consistent gets</span><br><span class="line"><span class="number">0</span>  physical <span class="keyword">reads</span></span><br><span class="line"><span class="number">0</span>  redo size</span><br><span class="line"><span class="number">372</span>  bytes sent via <span class="keyword">SQL</span><span class="operator">*</span>Net <span class="keyword">to</span> client</span><br><span class="line"><span class="number">484</span>  bytes received via <span class="keyword">SQL</span><span class="operator">*</span>Net <span class="keyword">from</span> client</span><br><span class="line"><span class="number">2</span>  <span class="keyword">SQL</span><span class="operator">*</span>Net roundtrips <span class="keyword">to</span><span class="operator">/</span><span class="keyword">from</span> client</span><br><span class="line"><span class="number">0</span>  sorts (memory)</span><br><span class="line"><span class="number">0</span>  sorts (disk)</span><br><span class="line"><span class="number">1</span>  <span class="keyword">rows</span> processed</span><br></pre></td></tr></table></figure>

<p>由此可见，新的执行计划基线已被使用。</p>
<p>参考资料：<span class="exturl" data-url="aHR0cHM6Ly9vcmFjbGUtYmFzZS5jb20vYXJ0aWNsZXMvMTJjL2FkYXB0aXZlLXNxbC1wbGFuLW1hbmFnZW1lbnQtMTJjcjE=">Adaptive SQL Plan Management (SPM) in Oracle Database 12c Release 1 (12.1)<i class="fa fa-external-link-alt"></i></span></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2016/08/04/oracle/architecture/Dropping-Table-Columns-With-Unused/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/gzh.jpg">
      <meta itemprop="name" content="巴流">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
      <meta itemprop="description" content="左手人文 | 右手科技">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 兔子先生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/08/04/oracle/architecture/Dropping-Table-Columns-With-Unused/" class="post-title-link" itemprop="url">Dropping Table Columns With Unused</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-08-04 16:24:00" itemprop="dateCreated datePublished" datetime="2016-08-04T16:24:00+08:00">2016-08-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-07 09:32:12" itemprop="dateModified" datetime="2025-02-07T09:32:12+08:00">2025-02-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oracle/" itemprop="url" rel="index"><span itemprop="name">oracle</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><strong>日常管理中经常会碰到需要drop表中字段的情况，如果表中数据很少时还可以直接drop，但是如果是一张大表，那么drop一个列是很耗时且耗资源的事，那么我们可以先逻辑上删除此字段，再在空闲的时候彻底drop掉以释放空间。</strong></p>
<blockquote>
<p>注：本文摘自官方文档</p>
</blockquote>
<p>##1. Marking Columns Unused</p>
<p>If you are concerned about the length of time it could take to drop column data from all of the rows in a large table, you can use the ALTER TABLE...SET UNUSED statement. This statement marks one or more columns as unused, but does not actually remove the target column data or restore the disk space occupied by these columns. However, a column that is marked as unused is not displayed in queries or data dictionary views, and its name is removed so that a new column can reuse that name. All constraints, indexes, and statistics defined on the column are also removed.</p>
<p>To mark the hiredate and mgr columns as unused, execute the following statement:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> hr.admin_emp <span class="keyword">SET</span> UNUSED (hiredate, mgr);</span><br></pre></td></tr></table></figure>

<p>You can later remove columns that are marked as unused by issuing an ALTER TABLE...DROP UNUSED COLUMNS statement. Unused columns are also removed from the target table whenever an explicit drop of any particular column or columns of the table is issued.</p>
<p>The data dictionary views USER_UNUSED_COL_TABS, ALL_UNUSED_COL_TABS, or DBA_UNUSED_COL_TABS can be used to list all tables containing unused columns. The COUNT field shows the number of unused columns in the table.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> DBA_UNUSED_COL_TABS;</span><br><span class="line"></span><br><span class="line">OWNER                       TABLE_NAME                  COUNT</span><br><span class="line"><span class="comment">--------------------------- --------------------------- -----</span></span><br><span class="line">HR                          ADMIN_EMP                       <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p><em>For external tables, the SET UNUSED statement is transparently converted into an ALTER TABLE DROP COLUMN statement. Because external tables consist of metadata only in the database, the DROP COLUMN statement performs equivalently to the SET UNUSED statement.</em><br>##2. Removing Unused Columns</p>
<p>The ALTER TABLE...DROP UNUSED COLUMNS statement is the only action allowed on unused columns. It physically removes unused columns from the table and reclaims disk space.</p>
<p>In the ALTER TABLE statement that follows, the optional clause CHECKPOINT is specified. This clause causes a checkpoint to be applied after processing the specified number of rows, in this case 250. Checkpointing cuts down on the amount of undo logs accumulated during the drop column operation to avoid a potential exhaustion of undo space.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> hr.admin_emp <span class="keyword">DROP</span> UNUSED COLUMNS CHECKPOINT <span class="number">250</span>;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2016/07/27/oracle/lock-latch/enq-TM-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/gzh.jpg">
      <meta itemprop="name" content="巴流">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
      <meta itemprop="description" content="左手人文 | 右手科技">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 兔子先生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/07/27/oracle/lock-latch/enq-TM-2/" class="post-title-link" itemprop="url">enq之TM-contention解决之道——外键无索引导致锁争用（下）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-07-27 16:21:00" itemprop="dateCreated datePublished" datetime="2016-07-27T16:21:00+08:00">2016-07-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-07 09:32:12" itemprop="dateModified" datetime="2025-02-07T09:32:12+08:00">2025-02-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oracle/" itemprop="url" rel="index"><span itemprop="name">oracle</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>上篇文章简要介绍了一下当外键无索引时，更新删除主表的数据会造成子表的锁定，如果此时子表上有事务，那么进行更新删除的session变会等待，等待事件就是<code>enq: TM - contention</code></p>
<p>外键与 TM enqueue lock 的主要问题是 在早期版本中(9i之前) 当 子表child table上 的外键没有索引时 ， 若发生 父表 parent table 上记录被delete 或 update时 ， 会在child table上加 share lock， 这会 阻塞 child table 上的DML。<br>但是从 9i以后的当 子表child table上 的外键没有索引时， 父表parent table上的delete 、update 只在 实际这个DML执行的过程中要求<code>share (TM lmode=4)</code> lock，而不会在整个事务中 都要求保持 child table上的 share lock。</p>
<p><strong>还是先了解一下oracle中的锁模式吧，TM锁和TX锁都属于DML锁，这里介绍的是TM的锁模式</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Value   Name(s)                    Table method (TM lock)</span><br><span class="line">    0   No lock                    n/a</span><br><span class="line"></span><br><span class="line">    1   Null lock (NL)             Used during some parallel DML operations (e.g. update) by</span><br><span class="line">                                   the pX slaves while the QC is holding an exclusive lock.</span><br><span class="line"></span><br><span class="line">    2   Sub-share (SS)             Until 9.2.0.5/6 &quot;select for update&quot;</span><br><span class="line">        Row-share (RS)             Since 9.2.0.1/2 used at opposite end of RI during DML</span><br><span class="line">                                   Lock table in row share mode</span><br><span class="line">                                   Lock table in share update mode</span><br><span class="line"></span><br><span class="line">    3   Sub-exclusive(SX)          Update (also &quot;select for update&quot; from 9.2.0.5/6)</span><br><span class="line">        Row-exclusive(RX)          Lock table in row exclusive mode</span><br><span class="line">                                   Since 11.1 used at opposite end of RI during DML</span><br><span class="line"></span><br><span class="line">    4   Share (S)                  Lock table in share mode</span><br><span class="line">                                   Can appear during parallel DML with id2 = 1, in the PX slave sessions</span><br><span class="line">                                   Common symptom of &quot;foreign key locking&quot; (missing index) problem</span><br><span class="line"></span><br><span class="line">    5   share sub exclusive (SSX)  Lock table in share row exclusive mode</span><br><span class="line">        share row exclusive (SRX)  Less common symptom of &quot;foreign key locking&quot; but likely to be more</span><br><span class="line">                                   frequent if the FK constraint is defined with &quot;on delete cascade.&quot;</span><br><span class="line"></span><br><span class="line">    6   Exclusive (X)              Lock table in exclusive mode</span><br></pre></td></tr></table></figure>


<p>share lock就是mode为4的S锁</p>
<p><strong>Summary of Locks Obtained by DML Statements</strong></p>
<p><img data-src="http://qiniu.liupzmin.com/Summary-of-Locks-Obtained-by-DML-Statements.jpg" alt="Summary of Locks Obtained by DML Statements"></p>
<p><strong>TM 锁在下列场景中被申请：</strong></p>
<ul>
<li>在OPS(早期的RAC)中LGWR会以ID1&#x3D;0 &amp;  ID2&#x3D;0去申请该队列锁来检查 DML_LOCKS 在所有实例中是全0还是全非0</li>
<li>当一个单表或分区 需要做不同的表&#x2F;分区操作时，ORACLE需要协调这些操作，所以需要申请该队列锁。包括：</li>
<li>启用参考约束 referential constraints</li>
<li>修改约束从DIASABLE NOVALIDATE 到DISABLE VALIDATE</li>
<li>重建IOT</li>
<li>创建视图或者修改ALTER视图时可能需要申请该队列锁</li>
<li>分析表统计信息或validate structure时</li>
<li>一些PDML并行DML操作</li>
<li>所有可能调用kkdllk()函数的操作</li>
<li>太多太多了。。。</li>
</ul>
<p><strong>下面是各种锁之间的兼容性:</strong></p>
<p><img data-src="http://qiniu.liupzmin.com/lock-comp.png" alt="lock"></p>
<p>好了，开始动手做个试验吧，试验中我会引用KST trace的内容，关于KST，本文不做介绍，只拿来使用</p>
<p>首先，准备环境，本实验均在11.2.0.4环境下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> conn lp<span class="operator">/</span>lp</span><br><span class="line">Connected.</span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> prim(a <span class="type">int</span>,b varchar2(<span class="number">10</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">Table</span> created.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> prim <span class="keyword">add</span> <span class="keyword">constraint</span> PK_PRIM <span class="keyword">primary</span> key(a);</span><br><span class="line"></span><br><span class="line"><span class="keyword">Table</span> altered.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> child (ca <span class="type">int</span>,cb varchar2(<span class="number">10</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">Table</span> created.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> child <span class="keyword">add</span> <span class="keyword">constraint</span> FK_CHILD_CA <span class="keyword">foreign</span> key (ca) <span class="keyword">references</span> prim(a);</span><br><span class="line"></span><br><span class="line"><span class="keyword">Table</span> altered.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> prim <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;asdasd&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> created.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> prim <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">&#x27;asdasd&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> created.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> prim <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">&#x27;asdasd&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> created.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Commit</span> complete.</span><br></pre></td></tr></table></figure>

<p>这里要说一下，在外键是否存在<code>on delete cascade</code>时锁的获取还有区别，所以我们分别来测试，首先是没有索引没有cascade的情况下，各个语句的锁获取情况</p>
<h2 id="无索引，无cascade"><a href="#无索引，无cascade" class="headerlink" title="无索引，无cascade"></a>无索引，无cascade</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">distinct</span> sid <span class="keyword">from</span> v$mystat;</span><br><span class="line"></span><br><span class="line">       SID</span><br><span class="line"><span class="comment">----------</span></span><br><span class="line">        <span class="number">17</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> pid,spid <span class="keyword">from</span> v$process <span class="keyword">where</span> addr <span class="operator">=</span> ( <span class="keyword">select</span> paddr <span class="keyword">from</span> v$session <span class="keyword">where</span> sid<span class="operator">=</span>(<span class="keyword">select</span> <span class="keyword">distinct</span> sid <span class="keyword">from</span> v$mystat));</span><br><span class="line"></span><br><span class="line">       PID SPID</span><br><span class="line"><span class="comment">---------- ------------</span></span><br><span class="line">        <span class="number">36</span>   <span class="number">2761</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">set</span> &quot;_trace_events&quot;<span class="operator">=</span><span class="string">&#x27;10000-10999:255:36&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">System</span> altered.</span><br></pre></td></tr></table></figure>

<p>insert 父表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> prim <span class="keyword">values</span>(<span class="number">5</span>,<span class="string">&#x27;asdasd&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>查看kst信息:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> kst.event,kst.sid,kst.pid,kst.function,kst.data <span class="keyword">from</span> x$trace kst <span class="keyword">where</span> pid<span class="operator">=</span><span class="number">36</span> <span class="keyword">and</span> sid<span class="operator">=</span><span class="number">17</span>;</span><br><span class="line"></span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: acquire TM<span class="number">-0001563</span>c<span class="number">-00000000</span> mode<span class="operator">=</span>SX flags<span class="operator">=</span><span class="keyword">GLOBAL</span><span class="operator">|</span>XACT why<span class="operator">=</span>&quot;contention&quot;</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: SUCCESS</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: acquire TM<span class="number">-0001563e-00000000</span> mode<span class="operator">=</span>SX flags<span class="operator">=</span><span class="keyword">GLOBAL</span><span class="operator">|</span>XACT why<span class="operator">=</span>&quot;contention&quot;</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: SUCCESS</span><br><span class="line"><span class="number">10813</span> <span class="number">17</span> <span class="number">36</span> ktubnd ktubnd: Bind usn <span class="number">3</span> nax <span class="number">1</span> nbx <span class="number">0</span> lng <span class="number">0</span> par <span class="number">0</span></span><br><span class="line"><span class="number">10813</span> <span class="number">17</span> <span class="number">36</span> ktubnd ktubnd: Txn Bound xid: <span class="number">3.3</span><span class="number">.1150</span></span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: acquire TX<span class="number">-00030003</span><span class="number">-0000047</span>e mode<span class="operator">=</span>X flags<span class="operator">=</span><span class="keyword">GLOBAL</span><span class="operator">|</span>XACT why<span class="operator">=</span>&quot;contention&quot;</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: SUCCESS</span><br><span class="line"><span class="number">10811</span> <span class="number">17</span> <span class="number">36</span> ktbgcl1 <span class="number">3301000100000000</span> <span class="number">0000000000000000</span> <span class="number">69</span>dd140000000000 <span class="number">0200000000000000</span></span><br><span class="line"><span class="number">10811</span> <span class="number">17</span> <span class="number">36</span> ktbgcl1 <span class="number">3301000100000000</span> <span class="number">0000000000000000</span> <span class="number">0</span>de3140000000000 <span class="number">0810</span>c76a177f0000</span><br><span class="line"><span class="number">10005</span> <span class="number">17</span> <span class="number">36</span> kslwtbctx KSL WAIT BEG [<span class="keyword">SQL</span><span class="operator">*</span>Net message <span class="keyword">to</span> client] <span class="number">1650815232</span><span class="operator">/</span><span class="number">0x62657100</span> <span class="number">1</span><span class="operator">/</span><span class="number">0x1</span> <span class="number">0</span><span class="operator">/</span><span class="number">0x0</span> wait_id<span class="operator">=</span><span class="number">173</span> seq_num<span class="operator">=</span><span class="number">180</span> snap_id<span class="operator">=</span><span class="number">1</span></span><br><span class="line"><span class="number">10005</span> <span class="number">17</span> <span class="number">36</span> kslwtectx KSL WAIT <span class="keyword">END</span> [<span class="keyword">SQL</span><span class="operator">*</span>Net message <span class="keyword">to</span> client] <span class="number">1650815232</span><span class="operator">/</span><span class="number">0x62657100</span> <span class="number">1</span><span class="operator">/</span><span class="number">0x1</span> <span class="number">0</span><span class="operator">/</span><span class="number">0x0</span> wait_id<span class="operator">=</span><span class="number">173</span> seq_num<span class="operator">=</span><span class="number">180</span> snap_id<span class="operator">=</span><span class="number">1</span></span><br><span class="line"><span class="number">10005</span> <span class="number">17</span> <span class="number">36</span> kslwtectx KSL WAIT <span class="keyword">END</span> wait times (usecs) <span class="operator">-</span> snap<span class="operator">=</span><span class="number">4</span>, exc<span class="operator">=</span><span class="number">4</span>, tot<span class="operator">=</span><span class="number">4</span></span><br><span class="line"><span class="number">10005</span> <span class="number">17</span> <span class="number">36</span> kslwtbctx KSL WAIT BEG [<span class="keyword">SQL</span><span class="operator">*</span>Net message <span class="keyword">from</span> client] <span class="number">1650815232</span><span class="operator">/</span><span class="number">0x62657100</span> <span class="number">1</span><span class="operator">/</span><span class="number">0x1</span> <span class="number">0</span><span class="operator">/</span><span class="number">0x0</span> wait_id<span class="operator">=</span><span class="number">174</span> seq_num<span class="operator">=</span><span class="number">181</span> snap_id<span class="operator">=</span><span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>可见父表上的插入会获取父表和子表<code>mode</code>为<code>3</code>的<code>TM锁</code>，TM后跟的是object_id的十六进制，一个TX锁，让我们验证一下:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> v$lock <span class="keyword">where</span> type <span class="keyword">in</span>(<span class="string">&#x27;TM&#x27;</span>,<span class="string">&#x27;TX&#x27;</span>);</span><br><span class="line"></span><br><span class="line">ADDR              KADDR           SID  TY        ID1         ID2    IMODE   REQUEST    CTIME     BLOCK</span><br><span class="line"><span class="comment">----------------  -------------- ----  -- ---------- ----------- -------- --------- -------- ---------</span></span><br><span class="line"><span class="number">00007</span>FD97FFE54E8  <span class="number">00007</span>FD97FFE5548 <span class="number">17</span>  TM      <span class="number">87614</span>           <span class="number">0</span>        <span class="number">3</span>         <span class="number">0</span>        <span class="number">8</span>         <span class="number">0</span></span><br><span class="line"><span class="number">00000000</span>ACE37CD0  <span class="number">00000000</span>ACE37D48 <span class="number">17</span>  Tx     <span class="number">262162</span>         <span class="number">851</span>        <span class="number">6</span>         <span class="number">0</span>        <span class="number">8</span>         <span class="number">0</span></span><br><span class="line"><span class="number">00007</span>FD97EFE54E8  <span class="number">00007</span>FD97FFE5548 <span class="number">17</span>  TM      <span class="number">87612</span>           <span class="number">0</span>        <span class="number">3</span>         <span class="number">0</span>        <span class="number">8</span>         <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>我们来commit一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">10704 17 36 ksqrcli ksqrcl: release TX-00030003-0000047e mode=X</span><br><span class="line">10813 17 36 ktudnx ktudnx: dec cnt xid:3.3.1150 nax:0 nbx:0</span><br><span class="line">10704 17 36 ksqrcli ksqrcl: release TM-0001563e-00000000 mode=SX</span><br><span class="line">10704 17 36 ksqrcli ksqrcl: release TM-0001563c-00000000 mode=SX</span><br><span class="line">10021 17 36 kcrf_commit_force 2ee3140000000000 2fe3140000000000</span><br><span class="line">10005 17 36 kslwtbctx KSL WAIT BEG [log file sync] 7416/0x1cf8 1368878/0x14e32e 0/0x0 wait_id=175 seq_num=182 snap_id=1</span><br><span class="line">10005 17 36 ksliwat KSL FACILITY WAIT fac#=3 time_waited_csecs=1</span><br><span class="line">10005 17 36 ksliwat KSL POST RCVD poster=11 num=76 loc=&#x27;ksl2.h LINE:2374 ID:kslpsr&#x27; id1=138 id2=0 name=EV type=0 fac#=3 posted=0x3 may_be_posted=1</span><br><span class="line">10005 17 36 kslwtectx KSL WAIT END [log file sync] 7416/0x1cf8 1368878/0x14e32e 0/0x0 wait_id=175 seq_num=182 snap_id=1</span><br><span class="line">10005 17 36 kslwtectx KSL WAIT END wait times (usecs) - snap=11126, exc=11126, tot=11126</span><br><span class="line">10005 17 36 kslwtbctx KSL WAIT BEG [SQL*Net message to client] 1650815232/0x62657100 1/0x1 0/0x0 wait_id=176 seq_num=183 snap_id=1</span><br><span class="line">10005 17 36 kslwtectx KSL WAIT END [SQL*Net message to client] 1650815232/0x62657100 1/0x1 0/0x0 wait_id=176 seq_num=183 snap_id=1</span><br><span class="line">10005 17 36 kslwtectx KSL WAIT END wait times (usecs) - snap=3, exc=3, tot=3</span><br><span class="line">10005 17 36 kslwtbctx KSL WAIT BEG [SQL*Net message from client] 1650815232/0x62657100 1/0x1 0/0x0 wait_id=177 seq_num=184 snap_id=1</span><br></pre></td></tr></table></figure>

<p>可见获得的锁全部一一释放</p>
<p>insert子表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> child <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">&#x27;sadsada&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: acquire TM<span class="number">-0001563</span>c<span class="number">-00000000</span> mode<span class="operator">=</span>SX flags<span class="operator">=</span><span class="keyword">GLOBAL</span><span class="operator">|</span>XACT why<span class="operator">=</span>&quot;contention&quot;</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: SUCCESS</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: acquire TM<span class="number">-0001563e-00000000</span> mode<span class="operator">=</span>SX flags<span class="operator">=</span><span class="keyword">GLOBAL</span><span class="operator">|</span>XACT why<span class="operator">=</span>&quot;contention&quot;</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: SUCCESS</span><br><span class="line"><span class="number">10813</span> <span class="number">17</span> <span class="number">36</span> ktubnd ktubnd: Bind usn <span class="number">7</span> nax <span class="number">1</span> nbx <span class="number">0</span> lng <span class="number">0</span> par <span class="number">0</span></span><br><span class="line"><span class="number">10813</span> <span class="number">17</span> <span class="number">36</span> ktubnd ktubnd: Txn Bound xid: <span class="number">7.17</span><span class="number">.835</span></span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: acquire TX<span class="number">-00070011</span><span class="number">-00000343</span> mode<span class="operator">=</span>X flags<span class="operator">=</span><span class="keyword">GLOBAL</span><span class="operator">|</span>XACT why<span class="operator">=</span>&quot;contention&quot;</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: SUCCESS</span><br><span class="line"><span class="number">10005</span> <span class="number">17</span> <span class="number">36</span> kslwtbctx KSL WAIT BEG [<span class="keyword">SQL</span><span class="operator">*</span>Net message <span class="keyword">to</span> client] <span class="number">1650815232</span><span class="operator">/</span><span class="number">0x62657100</span> <span class="number">1</span><span class="operator">/</span><span class="number">0x1</span> <span class="number">0</span><span class="operator">/</span><span class="number">0x0</span> wait_id<span class="operator">=</span><span class="number">186</span> seq_num<span class="operator">=</span><span class="number">193</span> snap_id<span class="operator">=</span><span class="number">1</span></span><br><span class="line"><span class="number">10005</span> <span class="number">17</span> <span class="number">36</span> kslwtectx KSL WAIT <span class="keyword">END</span> [<span class="keyword">SQL</span><span class="operator">*</span>Net message <span class="keyword">to</span> client] <span class="number">1650815232</span><span class="operator">/</span><span class="number">0x62657100</span> <span class="number">1</span><span class="operator">/</span><span class="number">0x1</span> <span class="number">0</span><span class="operator">/</span><span class="number">0x0</span> wait_id<span class="operator">=</span><span class="number">186</span> seq_num<span class="operator">=</span><span class="number">193</span> snap_id<span class="operator">=</span><span class="number">1</span></span><br><span class="line"><span class="number">10005</span> <span class="number">17</span> <span class="number">36</span> kslwtectx KSL WAIT <span class="keyword">END</span> wait times (usecs) <span class="operator">-</span> snap<span class="operator">=</span><span class="number">3</span>, exc<span class="operator">=</span><span class="number">3</span>, tot<span class="operator">=</span><span class="number">3</span></span><br><span class="line"><span class="number">10005</span> <span class="number">17</span> <span class="number">36</span> kslwtbctx KSL WAIT BEG [<span class="keyword">SQL</span><span class="operator">*</span>Net message <span class="keyword">from</span> client] <span class="number">1650815232</span><span class="operator">/</span><span class="number">0x62657100</span> <span class="number">1</span><span class="operator">/</span><span class="number">0x1</span> <span class="number">0</span><span class="operator">/</span><span class="number">0x0</span> wait_id<span class="operator">=</span><span class="number">187</span> seq_num<span class="operator">=</span><span class="number">194</span> snap_id<span class="operator">=</span><span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>可见子表上的插入也会获取父表和子表<code>mode</code>为<code>3</code>的<code>TM锁</code></p>
<p>update父表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> prim <span class="keyword">set</span> a<span class="operator">=</span><span class="number">1</span> <span class="keyword">where</span> a<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: acquire TM<span class="number">-0001563</span>c<span class="number">-00000000</span> mode<span class="operator">=</span>SX flags<span class="operator">=</span><span class="keyword">GLOBAL</span><span class="operator">|</span>XACT why<span class="operator">=</span>&quot;contention&quot;</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: SUCCESS</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: acquire TM<span class="number">-0001563e-00000000</span> mode<span class="operator">=</span>S flags<span class="operator">=</span><span class="keyword">GLOBAL</span><span class="operator">|</span>XACT why<span class="operator">=</span>&quot;contention&quot;</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: SUCCESS</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqrcli ksqrcl: <span class="keyword">release</span> TM<span class="number">-0001563e-00000000</span> mode<span class="operator">=</span>S</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqrcli ksqrcl: SUCCESS</span><br><span class="line"><span class="number">10811</span> <span class="number">17</span> <span class="number">36</span> ktbgcl1 <span class="number">2</span>c01000100000000 <span class="number">0000000000000000</span> <span class="number">0</span>fe7140000000000 <span class="number">0200000000000000</span></span><br><span class="line"><span class="number">10811</span> <span class="number">17</span> <span class="number">36</span> ktbgcl1 <span class="number">2</span>c01000100000000 <span class="number">0000000000000000</span> <span class="number">27e9140000000000</span> b80fb86a177f0000</span><br><span class="line"><span class="number">10813</span> <span class="number">17</span> <span class="number">36</span> ktubnd ktubnd: Bind usn <span class="number">4</span> nax <span class="number">1</span> nbx <span class="number">0</span> lng <span class="number">0</span> par <span class="number">0</span></span><br><span class="line"><span class="number">10813</span> <span class="number">17</span> <span class="number">36</span> ktubnd ktubnd: Txn Bound xid: <span class="number">4.10</span><span class="number">.851</span></span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: acquire TX<span class="number">-0004000</span>a<span class="number">-00000353</span> mode<span class="operator">=</span>X flags<span class="operator">=</span><span class="keyword">GLOBAL</span><span class="operator">|</span>XACT why<span class="operator">=</span>&quot;contention&quot;</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: SUCCESS</span><br><span class="line"><span class="number">10005</span> <span class="number">17</span> <span class="number">36</span> kslwtbctx KSL WAIT BEG [<span class="keyword">SQL</span><span class="operator">*</span>Net message <span class="keyword">to</span> client] <span class="number">1650815232</span><span class="operator">/</span><span class="number">0x62657100</span> <span class="number">1</span><span class="operator">/</span><span class="number">0x1</span> <span class="number">0</span><span class="operator">/</span><span class="number">0x0</span> wait_id<span class="operator">=</span><span class="number">204</span> seq_num<span class="operator">=</span><span class="number">211</span> snap_id<span class="operator">=</span><span class="number">1</span></span><br><span class="line"><span class="number">10005</span> <span class="number">17</span> <span class="number">36</span> kslwtectx KSL WAIT <span class="keyword">END</span> [<span class="keyword">SQL</span><span class="operator">*</span>Net message <span class="keyword">to</span> client] <span class="number">1650815232</span><span class="operator">/</span><span class="number">0x62657100</span> <span class="number">1</span><span class="operator">/</span><span class="number">0x1</span> <span class="number">0</span><span class="operator">/</span><span class="number">0x0</span> wait_id<span class="operator">=</span><span class="number">204</span> seq_num<span class="operator">=</span><span class="number">211</span> snap_id<span class="operator">=</span><span class="number">1</span></span><br><span class="line"><span class="number">10005</span> <span class="number">17</span> <span class="number">36</span> kslwtectx KSL WAIT <span class="keyword">END</span> wait times (usecs) <span class="operator">-</span> snap<span class="operator">=</span><span class="number">5</span>, exc<span class="operator">=</span><span class="number">5</span>, tot<span class="operator">=</span><span class="number">5</span></span><br><span class="line"><span class="number">10005</span> <span class="number">17</span> <span class="number">36</span> kslwtbctx KSL WAIT BEG [<span class="keyword">SQL</span><span class="operator">*</span>Net message <span class="keyword">from</span> client] <span class="number">1650815232</span><span class="operator">/</span><span class="number">0x62657100</span> <span class="number">1</span><span class="operator">/</span><span class="number">0x1</span> <span class="number">0</span><span class="operator">/</span><span class="number">0x0</span> wait_id<span class="operator">=</span><span class="number">205</span> seq_num<span class="operator">=</span><span class="number">212</span> snap_id<span class="operator">=</span><span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>可以很清楚的看到在执行语句期间，注意仅仅是语句的执行期间，会附加一个mode为4的S锁到子表上，很快便释放了</p>
<p>delete父表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> prim <span class="keyword">where</span> a<span class="operator">=</span><span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: acquire TM<span class="number">-0001563</span>c<span class="number">-00000000</span> mode<span class="operator">=</span>SX flags<span class="operator">=</span><span class="keyword">GLOBAL</span><span class="operator">|</span>XACT why<span class="operator">=</span>&quot;contention&quot;</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: SUCCESS</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: acquire TM<span class="number">-0001563e-00000000</span> mode<span class="operator">=</span>S flags<span class="operator">=</span><span class="keyword">GLOBAL</span><span class="operator">|</span>XACT why<span class="operator">=</span>&quot;contention&quot;</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: SUCCESS</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqrcli ksqrcl: <span class="keyword">release</span> TM<span class="number">-0001563e-00000000</span> mode<span class="operator">=</span>S</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqrcli ksqrcl: SUCCESS</span><br><span class="line"><span class="number">10813</span> <span class="number">17</span> <span class="number">36</span> ktubnd ktubnd: Bind usn <span class="number">2</span> nax <span class="number">1</span> nbx <span class="number">0</span> lng <span class="number">0</span> par <span class="number">0</span></span><br><span class="line"><span class="number">10813</span> <span class="number">17</span> <span class="number">36</span> ktubnd ktubnd: Txn Bound xid: <span class="number">2.0</span><span class="number">.1117</span></span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: acquire TX<span class="number">-00020000</span><span class="number">-0000045</span>d mode<span class="operator">=</span>X flags<span class="operator">=</span><span class="keyword">GLOBAL</span><span class="operator">|</span>XACT why<span class="operator">=</span>&quot;contention&quot;</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: SUCCESS</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: acquire TM<span class="number">-0001563e-00000000</span> mode<span class="operator">=</span>S flags<span class="operator">=</span><span class="keyword">GLOBAL</span><span class="operator">|</span>XACT why<span class="operator">=</span>&quot;contention&quot;</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: SUCCESS</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqrcli ksqrcl: <span class="keyword">release</span> TM<span class="number">-0001563e-00000000</span> mode<span class="operator">=</span>S</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqrcli ksqrcl: SUCCESS</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3</span>b01000100000000 <span class="number">0000000000000000</span> bae9140000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">0200000000000000</span> <span class="number">0000000000000000</span> <span class="number">5</span>d04000000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">9</span>b12c00000000000 <span class="number">4401000000000000</span> <span class="number">0200000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3</span>b01000100000000 <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3</span>c01000100000000 <span class="number">0000000000000000</span> bae9140000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">0200000000000000</span> <span class="number">0000000000000000</span> <span class="number">5</span>d04000000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">9</span>b12c00000000000 <span class="number">4401000000000000</span> <span class="number">0200000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3</span>c01000100000000 <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3</span>d01000100000000 <span class="number">0000000000000000</span> bae9140000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">0200000000000000</span> <span class="number">0000000000000000</span> <span class="number">5</span>d04000000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">9</span>b12c00000000000 <span class="number">4401000000000000</span> <span class="number">0200000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3</span>d01000100000000 <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3e01000100000000</span> <span class="number">0000000000000000</span> bae9140000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">0200000000000000</span> <span class="number">0000000000000000</span> <span class="number">5</span>d04000000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">9</span>b12c00000000000 <span class="number">4401000000000000</span> <span class="number">0200000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3e01000100000000</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3</span>f01000100000000 <span class="number">0000000000000000</span> bae9140000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">0200000000000000</span> <span class="number">0000000000000000</span> <span class="number">5</span>d04000000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">9</span>b12c00000000000 <span class="number">4401000000000000</span> <span class="number">0200000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3</span>f01000100000000 <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"><span class="number">10005</span> <span class="number">17</span> <span class="number">36</span> kslwtbctx KSL WAIT BEG [<span class="keyword">SQL</span><span class="operator">*</span>Net message <span class="keyword">to</span> client] <span class="number">1650815232</span><span class="operator">/</span><span class="number">0x62657100</span> <span class="number">1</span><span class="operator">/</span><span class="number">0x1</span> <span class="number">0</span><span class="operator">/</span><span class="number">0x0</span> wait_id<span class="operator">=</span><span class="number">227</span> seq_num<span class="operator">=</span><span class="number">234</span> snap_id<span class="operator">=</span><span class="number">1</span></span><br><span class="line"><span class="number">10005</span> <span class="number">17</span> <span class="number">36</span> kslwtectx KSL WAIT <span class="keyword">END</span> [<span class="keyword">SQL</span><span class="operator">*</span>Net message <span class="keyword">to</span> client] <span class="number">1650815232</span><span class="operator">/</span><span class="number">0x62657100</span> <span class="number">1</span><span class="operator">/</span><span class="number">0x1</span> <span class="number">0</span><span class="operator">/</span><span class="number">0x0</span> wait_id<span class="operator">=</span><span class="number">227</span> seq_num<span class="operator">=</span><span class="number">234</span> snap_id<span class="operator">=</span><span class="number">1</span></span><br><span class="line"><span class="number">10005</span> <span class="number">17</span> <span class="number">36</span> kslwtectx KSL WAIT <span class="keyword">END</span> wait times (usecs) <span class="operator">-</span> snap<span class="operator">=</span><span class="number">3</span>, exc<span class="operator">=</span><span class="number">3</span>, tot<span class="operator">=</span><span class="number">3</span></span><br><span class="line"><span class="number">10005</span> <span class="number">17</span> <span class="number">36</span> kslwtbctx KSL WAIT BEG [<span class="keyword">SQL</span><span class="operator">*</span>Net message <span class="keyword">from</span> client] <span class="number">1650815232</span><span class="operator">/</span><span class="number">0x62657100</span> <span class="number">1</span><span class="operator">/</span><span class="number">0x1</span> <span class="number">0</span><span class="operator">/</span><span class="number">0x0</span> wait_id<span class="operator">=</span><span class="number">228</span> seq_num<span class="operator">=</span><span class="number">235</span> snap_id<span class="operator">=</span><span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>delete跟update比多了一次S锁的获取和释放，为何呢，是否和删除的行数有关？我们再多删一行试试</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">delete</span> <span class="keyword">from</span> prim <span class="keyword">where</span> a<span class="operator">=</span><span class="number">4</span> <span class="keyword">or</span> a<span class="operator">=</span><span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: acquire TM<span class="number">-0001563</span>c<span class="number">-00000000</span> mode<span class="operator">=</span>SX flags<span class="operator">=</span><span class="keyword">GLOBAL</span><span class="operator">|</span>XACT why<span class="operator">=</span>&quot;contention&quot;</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: SUCCESS</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: acquire TM<span class="number">-0001563e-00000000</span> mode<span class="operator">=</span>S flags<span class="operator">=</span><span class="keyword">GLOBAL</span><span class="operator">|</span>XACT why<span class="operator">=</span>&quot;contention&quot;</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: SUCCESS</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqrcli ksqrcl: <span class="keyword">release</span> TM<span class="number">-0001563e-00000000</span> mode<span class="operator">=</span>S</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqrcli ksqrcl: SUCCESS</span><br><span class="line"><span class="number">10813</span> <span class="number">17</span> <span class="number">36</span> ktubnd ktubnd: Bind usn <span class="number">6</span> nax <span class="number">1</span> nbx <span class="number">0</span> lng <span class="number">0</span> par <span class="number">0</span></span><br><span class="line"><span class="number">10813</span> <span class="number">17</span> <span class="number">36</span> ktubnd ktubnd: Txn Bound xid: <span class="number">6.15</span><span class="number">.1290</span></span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: acquire TX<span class="number">-0006000</span>f<span class="number">-0000050</span>a mode<span class="operator">=</span>X flags<span class="operator">=</span><span class="keyword">GLOBAL</span><span class="operator">|</span>XACT why<span class="operator">=</span>&quot;contention&quot;</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: SUCCESS</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: acquire TM<span class="number">-0001563e-00000000</span> mode<span class="operator">=</span>S flags<span class="operator">=</span><span class="keyword">GLOBAL</span><span class="operator">|</span>XACT why<span class="operator">=</span>&quot;contention&quot;</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: SUCCESS</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqrcli ksqrcl: <span class="keyword">release</span> TM<span class="number">-0001563e-00000000</span> mode<span class="operator">=</span>S</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqrcli ksqrcl: SUCCESS</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3</span>b01000100000000 <span class="number">0000000000000000</span> <span class="number">5</span>eea140000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">0600000000000000</span> <span class="number">0</span>f00000000000000 <span class="number">0</span>a05000000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm bc06c00000000000 <span class="number">0e01000000000000</span> <span class="number">2200000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3</span>b01000100000000 <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3</span>c01000100000000 <span class="number">0000000000000000</span> <span class="number">5</span>eea140000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">0600000000000000</span> <span class="number">0</span>f00000000000000 <span class="number">0</span>a05000000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm bc06c00000000000 <span class="number">0e01000000000000</span> <span class="number">2200000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3</span>c01000100000000 <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3</span>d01000100000000 <span class="number">0000000000000000</span> <span class="number">5</span>eea140000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">0600000000000000</span> <span class="number">0</span>f00000000000000 <span class="number">0</span>a05000000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm bc06c00000000000 <span class="number">0e01000000000000</span> <span class="number">2200000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3</span>d01000100000000 <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3e01000100000000</span> <span class="number">0000000000000000</span> <span class="number">5</span>eea140000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">0600000000000000</span> <span class="number">0</span>f00000000000000 <span class="number">0</span>a05000000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm bc06c00000000000 <span class="number">0e01000000000000</span> <span class="number">2200000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3e01000100000000</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3</span>f01000100000000 <span class="number">0000000000000000</span> <span class="number">5</span>eea140000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">0600000000000000</span> <span class="number">0</span>f00000000000000 <span class="number">0</span>a05000000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm bc06c00000000000 <span class="number">0e01000000000000</span> <span class="number">2200000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3</span>f01000100000000 <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3301000100000000</span> <span class="number">0000000000000000</span> <span class="number">5</span>eea140000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"><span class="number">10811</span> <span class="number">17</span> <span class="number">36</span> ktbgcl1 <span class="number">3301000100000000</span> <span class="number">0000000000000000</span> <span class="number">5</span>eea140000000000 <span class="number">0100000000000000</span></span><br><span class="line"><span class="number">10811</span> <span class="number">17</span> <span class="number">36</span> ktbgcl1 <span class="number">3301000100000000</span> <span class="number">0000000000000000</span> <span class="number">5</span>eea140000000000 e00fc76a177f0000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> kturCRBackoutOneChg <span class="number">0100000000000000</span> bc06c00000000000 <span class="number">0e01000000000000</span> <span class="number">2200000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3301000100000000</span> <span class="number">0100000000000000</span> <span class="number">0100000000000000</span></span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: acquire TM<span class="number">-0001563e-00000000</span> mode<span class="operator">=</span>S flags<span class="operator">=</span><span class="keyword">GLOBAL</span><span class="operator">|</span>XACT why<span class="operator">=</span>&quot;contention&quot;</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqgtlctx ksqgtl: SUCCESS</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqrcli ksqrcl: <span class="keyword">release</span> TM<span class="number">-0001563e-00000000</span> mode<span class="operator">=</span>S</span><br><span class="line"><span class="number">10704</span> <span class="number">17</span> <span class="number">36</span> ksqrcli ksqrcl: SUCCESS</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3</span>b01000100000000 <span class="number">0000000000000000</span> <span class="number">5</span>fea140000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">0600000000000000</span> <span class="number">0</span>f00000000000000 <span class="number">0</span>a05000000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm bc06c00000000000 <span class="number">0e01000000000000</span> <span class="number">2400000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3</span>b01000100000000 <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3</span>c01000100000000 <span class="number">0000000000000000</span> <span class="number">5</span>fea140000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">0600000000000000</span> <span class="number">0</span>f00000000000000 <span class="number">0</span>a05000000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm bc06c00000000000 <span class="number">0e01000000000000</span> <span class="number">2400000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3</span>c01000100000000 <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3</span>d01000100000000 <span class="number">0000000000000000</span> <span class="number">5</span>fea140000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">0600000000000000</span> <span class="number">0</span>f00000000000000 <span class="number">0</span>a05000000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm bc06c00000000000 <span class="number">0e01000000000000</span> <span class="number">2400000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3</span>d01000100000000 <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3e01000100000000</span> <span class="number">0000000000000000</span> <span class="number">5</span>fea140000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">0600000000000000</span> <span class="number">0</span>f00000000000000 <span class="number">0</span>a05000000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm bc06c00000000000 <span class="number">0e01000000000000</span> <span class="number">2400000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3e01000100000000</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3</span>f01000100000000 <span class="number">0000000000000000</span> <span class="number">5</span>fea140000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">0600000000000000</span> <span class="number">0</span>f00000000000000 <span class="number">0</span>a05000000000000</span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm bc06c00000000000 <span class="number">0e01000000000000</span> <span class="number">2400000000000000</span></span><br><span class="line"><span class="number">10812</span> <span class="number">17</span> <span class="number">36</span> ktrgcm <span class="number">3</span>f01000100000000 <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"><span class="number">10005</span> <span class="number">17</span> <span class="number">36</span> kslwtbctx KSL WAIT BEG [<span class="keyword">SQL</span><span class="operator">*</span>Net message <span class="keyword">to</span> client] <span class="number">1650815232</span><span class="operator">/</span><span class="number">0x62657100</span> <span class="number">1</span><span class="operator">/</span><span class="number">0x1</span> <span class="number">0</span><span class="operator">/</span><span class="number">0x0</span> wait_id<span class="operator">=</span><span class="number">236</span> seq_num<span class="operator">=</span><span class="number">243</span> snap_id<span class="operator">=</span><span class="number">1</span></span><br><span class="line"><span class="number">10005</span> <span class="number">17</span> <span class="number">36</span> kslwtectx KSL WAIT <span class="keyword">END</span> [<span class="keyword">SQL</span><span class="operator">*</span>Net message <span class="keyword">to</span> client] <span class="number">1650815232</span><span class="operator">/</span><span class="number">0x62657100</span> <span class="number">1</span><span class="operator">/</span><span class="number">0x1</span> <span class="number">0</span><span class="operator">/</span><span class="number">0x0</span> wait_id<span class="operator">=</span><span class="number">236</span> seq_num<span class="operator">=</span><span class="number">243</span> snap_id<span class="operator">=</span><span class="number">1</span></span><br><span class="line"><span class="number">10005</span> <span class="number">17</span> <span class="number">36</span> kslwtectx KSL WAIT <span class="keyword">END</span> wait times (usecs) <span class="operator">-</span> snap<span class="operator">=</span><span class="number">4</span>, exc<span class="operator">=</span><span class="number">4</span>, tot<span class="operator">=</span><span class="number">4</span></span><br><span class="line"><span class="number">10005</span> <span class="number">17</span> <span class="number">36</span> kslwtbctx KSL WAIT BEG [<span class="keyword">SQL</span><span class="operator">*</span>Net message <span class="keyword">from</span> client] <span class="number">1650815232</span><span class="operator">/</span><span class="number">0x62657100</span> <span class="number">1</span><span class="operator">/</span><span class="number">0x1</span> <span class="number">0</span><span class="operator">/</span><span class="number">0x0</span> wait_id<span class="operator">=</span><span class="number">237</span> seq_num<span class="operator">=</span><span class="number">244</span> snap_id<span class="operator">=</span><span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>可以发现除了语句执行时需要获取一次<code>S</code>锁之外，删多少行就要获取多少次<code>S</code>锁，从之前的锁兼容列表就可发现<code>S</code>锁和<code>SX（RX）</code>锁是不兼容的，而<code>SX（RX）</code>是insert update delete获取的锁模式，可以想象如果此时子表上有事务，或者S锁获得了尚未释放的时候，子表要进行事务获取<code>mode</code>为3的<code>SX（RX）</code>锁时，<strong>session都会产生等待</strong>。</p>
<p>看一下此时session获取的锁，记住这次结果，后面会有对比。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span>  <span class="keyword">from</span> v$lock <span class="keyword">where</span> type <span class="keyword">in</span>(<span class="string">&#x27;TM&#x27;</span>,<span class="string">&#x27;TX&#x27;</span>);</span><br><span class="line"></span><br><span class="line">ADDR             KADDR                   SID TY        ID1        ID2      LMODE    REQUEST      CTIME      BLOCK</span><br><span class="line"><span class="comment">---------------- ---------------- ---------- -- ---------- ---------- ---------- ---------- ---------- ----------</span></span><br><span class="line"><span class="number">00000000</span>ACE37CD0 <span class="number">00000000</span>ACE37D48         <span class="number">17</span> TX     <span class="number">393231</span>       <span class="number">1290</span>          <span class="number">6</span>          <span class="number">0</span>        <span class="number">195</span>          <span class="number">0</span></span><br><span class="line"><span class="number">00007</span>FD97FFE6520 <span class="number">00007</span>FD97FFE6580         <span class="number">17</span> TM      <span class="number">87612</span>          <span class="number">0</span>          <span class="number">3</span>          <span class="number">0</span>        <span class="number">195</span>          <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>可见语句执行完，已不持有子表上的任何锁</p>
<p>下面来模拟一下等待，</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">sid:<span class="number">31</span></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> child <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">&#x27;12312&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> created.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="keyword">distinct</span> sid <span class="keyword">from</span> v$mystat;</span><br><span class="line"></span><br><span class="line">       SID</span><br><span class="line"><span class="comment">----------</span></span><br><span class="line">        <span class="number">31</span></span><br><span class="line">        </span><br><span class="line">sid:<span class="number">1169</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">update</span> prim <span class="keyword">set</span> a<span class="operator">=</span><span class="number">1</span> <span class="keyword">where</span> a<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span>  <span class="keyword">from</span> v$lock <span class="keyword">where</span> type <span class="keyword">in</span>(<span class="string">&#x27;TM&#x27;</span>,<span class="string">&#x27;TX&#x27;</span>);</span><br><span class="line"></span><br><span class="line">ADDR             KADDR                   SID TY        ID1        ID2      LMODE    REQUEST      CTIME      BLOCK</span><br><span class="line"><span class="comment">---------------- ---------------- ---------- -- ---------- ---------- ---------- ---------- ---------- ----------</span></span><br><span class="line"><span class="number">00007</span>FD97FFE54E8 <span class="number">00007</span>FD97FFE5548         <span class="number">31</span> TM      <span class="number">87614</span>          <span class="number">0</span>          <span class="number">3</span>          <span class="number">0</span>        <span class="number">143</span>          <span class="number">1</span></span><br><span class="line"><span class="number">00000000</span>ABE6BE80 <span class="number">00000000</span>ABE6BEF8         <span class="number">31</span> TX     <span class="number">327713</span>       <span class="number">1114</span>          <span class="number">6</span>          <span class="number">0</span>        <span class="number">143</span>          <span class="number">0</span></span><br><span class="line"><span class="number">00007</span>FD97FFE54E8 <span class="number">00007</span>FD97FFE5548       <span class="number">1169</span> TM      <span class="number">87612</span>          <span class="number">0</span>          <span class="number">3</span>          <span class="number">0</span>         <span class="number">76</span>          <span class="number">0</span></span><br><span class="line"><span class="number">00007</span>FD97FFE54E8 <span class="number">00007</span>FD97FFE5548         <span class="number">31</span> TM      <span class="number">87612</span>          <span class="number">0</span>          <span class="number">3</span>          <span class="number">0</span>        <span class="number">143</span>          <span class="number">0</span></span><br><span class="line"><span class="number">00007</span>FD97FFE54E8 <span class="number">00007</span>FD97FFE5548       <span class="number">1169</span> TM      <span class="number">87614</span>          <span class="number">0</span>          <span class="number">0</span>          <span class="number">4</span>         <span class="number">76</span>          <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>此时查一下等待链</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span>  <span class="comment">--锁源头查找,带对象和sql以及event</span></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span>  <span class="keyword">WITH</span> sessions <span class="keyword">AS</span></span><br><span class="line">  <span class="number">2</span>   (<span class="keyword">SELECT</span> <span class="comment">/*+materialize*/</span></span><br><span class="line">  <span class="number">3</span>     sid,</span><br><span class="line">  <span class="number">4</span>     blocking_session,</span><br><span class="line">  <span class="number">5</span>     blocking_instance,</span><br><span class="line">  <span class="number">6</span>     row_wait_obj#,</span><br><span class="line">  <span class="number">7</span>     sql_id,</span><br><span class="line">  <span class="number">8</span>     inst_id,</span><br><span class="line">  <span class="number">9</span>     event</span><br><span class="line"> <span class="number">10</span>      <span class="keyword">FROM</span> gv$session)</span><br><span class="line"> <span class="number">11</span>  <span class="keyword">SELECT</span> LPAD(<span class="string">&#x27; &#x27;</span>, <span class="number">4</span> <span class="operator">*</span> (level <span class="operator">-</span> <span class="number">1</span>)) <span class="operator">||</span> s.inst_id <span class="operator">||</span> <span class="string">&#x27;.&#x27;</span> <span class="operator">||</span> sid sid,</span><br><span class="line"> <span class="number">12</span>         object_name,</span><br><span class="line"> <span class="number">13</span>         substr(sql_text, <span class="number">1</span>, <span class="number">40</span>) sql_text,</span><br><span class="line"> <span class="number">14</span>         event</span><br><span class="line"> <span class="number">15</span>    <span class="keyword">FROM</span> sessions s</span><br><span class="line"> <span class="number">16</span>    <span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> dba_objects d</span><br><span class="line"> <span class="number">17</span>      <span class="keyword">ON</span> (object_id <span class="operator">=</span> row_wait_obj#)</span><br><span class="line"> <span class="number">18</span>    <span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> gv$<span class="keyword">sql</span> q</span><br><span class="line"> <span class="number">19</span>      <span class="keyword">ON</span> (s.sql_id <span class="operator">=</span> q.SQL_ID <span class="keyword">and</span> s.inst_id <span class="operator">=</span> q.INST_ID)</span><br><span class="line"> <span class="number">20</span>   <span class="keyword">WHERE</span> sid <span class="keyword">IN</span> (<span class="keyword">SELECT</span> blocking_session <span class="keyword">FROM</span> sessions)</span><br><span class="line"> <span class="number">21</span>      <span class="keyword">OR</span> blocking_session <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line"> <span class="number">22</span>  <span class="keyword">CONNECT</span> <span class="keyword">BY</span> PRIOR sid <span class="operator">=</span> blocking_session</span><br><span class="line"> <span class="number">23</span>   <span class="keyword">START</span> <span class="keyword">WITH</span> blocking_session <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br><span class="line"></span><br><span class="line">SID        OBJECT_NAM SQL_TEXT                                 EVENT</span><br><span class="line"><span class="comment">---------- ---------- ---------------------------------------- ------------------------------</span></span><br><span class="line"><span class="number">1.31</span>                                                           <span class="keyword">SQL</span><span class="operator">*</span>Net message <span class="keyword">from</span> client</span><br><span class="line">    <span class="number">1.1169</span> CHILD      <span class="keyword">update</span> prim <span class="keyword">set</span> a<span class="operator">=</span><span class="number">1</span> <span class="keyword">where</span> a<span class="operator">=</span><span class="number">1</span>            enq: TM <span class="operator">-</span> contention</span><br></pre></td></tr></table></figure>

<p>从上面的分析我们知道，无论插入父表和子表，都会获取两张表上的<code>mode</code>为<code>3</code>的锁，而<code>mode</code>为<code>3</code>的锁和<code>mode</code>为<code>4</code>的锁是不兼容的，也就是说此时父表上连插入都无法进行</p>
<p>再开第三个session</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">sid:<span class="number">1167</span></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> prim <span class="keyword">values</span>(<span class="number">7</span>,<span class="string">&#x27;dasd&#x27;</span>); <span class="comment">--hang住了</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span>  <span class="keyword">from</span> v$lock <span class="keyword">where</span> type <span class="keyword">in</span>(<span class="string">&#x27;TM&#x27;</span>,<span class="string">&#x27;TX&#x27;</span>);</span><br><span class="line"></span><br><span class="line">ADDR             KADDR                SID TY        ID1        ID2      LMODE    REQUEST      CTIME      BLOCK</span><br><span class="line"><span class="comment">---------------- ---------------- ------- -- ---------- ---------- ---------- ---------- ---------- ----------</span></span><br><span class="line"><span class="number">00007</span>FD97D39F2A8 <span class="number">00007</span>FD97D39F308      <span class="number">31</span> TM      <span class="number">87614</span>          <span class="number">0</span>          <span class="number">3</span>          <span class="number">0</span>        <span class="number">476</span>          <span class="number">1</span></span><br><span class="line"><span class="number">00007</span>FD97D39F2A8 <span class="number">00007</span>FD97D39F308    <span class="number">1167</span> TM      <span class="number">87614</span>          <span class="number">0</span>          <span class="number">0</span>          <span class="number">3</span>         <span class="number">85</span>          <span class="number">0</span></span><br><span class="line"><span class="number">00000000</span>ABE6BE80 <span class="number">00000000</span>ABE6BEF8      <span class="number">31</span> TX     <span class="number">327713</span>       <span class="number">1114</span>          <span class="number">6</span>          <span class="number">0</span>        <span class="number">476</span>          <span class="number">0</span></span><br><span class="line"><span class="number">00007</span>FD97D39F2A8 <span class="number">00007</span>FD97D39F308    <span class="number">1169</span> TM      <span class="number">87612</span>          <span class="number">0</span>          <span class="number">3</span>          <span class="number">0</span>        <span class="number">409</span>          <span class="number">0</span></span><br><span class="line"><span class="number">00007</span>FD97D39F2A8 <span class="number">00007</span>FD97D39F308      <span class="number">31</span> TM      <span class="number">87612</span>          <span class="number">0</span>          <span class="number">3</span>          <span class="number">0</span>        <span class="number">476</span>          <span class="number">0</span></span><br><span class="line"><span class="number">00007</span>FD97D39F2A8 <span class="number">00007</span>FD97D39F308    <span class="number">1169</span> TM      <span class="number">87614</span>          <span class="number">0</span>          <span class="number">0</span>          <span class="number">4</span>        <span class="number">409</span>          <span class="number">0</span></span><br><span class="line"><span class="number">00007</span>FD97D39F2A8 <span class="number">00007</span>FD97D39F308    <span class="number">1167</span> TM      <span class="number">87612</span>          <span class="number">0</span>          <span class="number">3</span>          <span class="number">0</span>         <span class="number">85</span>          <span class="number">0</span>    </span><br><span class="line">    </span><br><span class="line">SID                  OBJECT_NAME                    SQL_TEXT                                 EVENT</span><br><span class="line"><span class="comment">-------------------- ------------------------------ ---------------------------------------- ----------------------------------------</span></span><br><span class="line"><span class="number">1.31</span>                                                                                         <span class="keyword">SQL</span><span class="operator">*</span>Net message <span class="keyword">from</span> client</span><br><span class="line">    <span class="number">1.1169</span>           CHILD                          <span class="keyword">update</span> prim <span class="keyword">set</span> a<span class="operator">=</span><span class="number">1</span> <span class="keyword">where</span> a<span class="operator">=</span><span class="number">1</span>            enq: TM <span class="operator">-</span> contention</span><br><span class="line">        <span class="number">1.1167</span>       CHILD                          <span class="keyword">insert</span> <span class="keyword">into</span> prim <span class="keyword">values</span>(<span class="number">7</span>,<span class="string">&#x27;dasd&#x27;</span>)        enq: TM <span class="operator">-</span> contention</span><br></pre></td></tr></table></figure>

<p> 可见<code>1167</code>的session被阻塞了。</p>
<h2 id="无索引，有cascade"><a href="#无索引，有cascade" class="headerlink" title="无索引，有cascade"></a>无索引，有cascade</h2> <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> child <span class="keyword">drop</span> <span class="keyword">constraint</span> FK_CHILD_CA;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Table</span> altered.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> child <span class="keyword">add</span> <span class="keyword">constraint</span> FK_CHILD_CA <span class="keyword">foreign</span> key (ca) <span class="keyword">references</span> prim(a) <span class="keyword">on</span> <span class="keyword">delete</span> cascade;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Table</span> altered.</span><br></pre></td></tr></table></figure>

<p>有cascade的时候，仅在delete语句上有所区别，下面仅列出delete语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">delete</span> <span class="keyword">from</span> prim <span class="keyword">where</span> a<span class="operator">=</span><span class="number">2</span> <span class="keyword">or</span> a<span class="operator">=</span><span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> deleted.</span><br><span class="line"></span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqgtlctx            ksqgtl: acquire TM<span class="number">-0001563</span>c<span class="number">-00000000</span> mode<span class="operator">=</span>SX flags<span class="operator">=</span><span class="keyword">GLOBAL</span><span class="operator">|</span>XACT why<span class="operator">=</span>&quot;contention&quot;</span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqgtlctx            ksqgtl: SUCCESS</span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqgtlctx            ksqgtl: acquire TM<span class="number">-0001563e-00000000</span> mode<span class="operator">=</span>SSX flags<span class="operator">=</span><span class="keyword">GLOBAL</span><span class="operator">|</span>XACT why<span class="operator">=</span>&quot;contention&quot;</span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqgtlctx            ksqgtl: SUCCESS</span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqcnv               ksqcnv: <span class="keyword">convert</span> TM<span class="number">-0001563e-00000000</span> <span class="keyword">from</span><span class="operator">=</span>SSX <span class="keyword">to</span><span class="operator">=</span>SX flags<span class="operator">=</span></span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqcnv               ksqcnv: SUCCESS</span><br><span class="line"> <span class="number">10813</span>      <span class="number">17</span>         <span class="number">36</span> ktubnd               ktubnd: Bind usn <span class="number">4</span> nax <span class="number">1</span> nbx <span class="number">0</span> lng <span class="number">0</span> par <span class="number">0</span></span><br><span class="line"> <span class="number">10813</span>      <span class="number">17</span>         <span class="number">36</span> ktubnd               ktubnd: Txn Bound xid: <span class="number">4.20</span><span class="number">.852</span></span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqgtlctx            ksqgtl: acquire TX<span class="number">-00040014</span><span class="number">-00000354</span> mode<span class="operator">=</span>X flags<span class="operator">=</span><span class="keyword">GLOBAL</span><span class="operator">|</span>XACT why<span class="operator">=</span>&quot;contention&quot;</span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqgtlctx            ksqgtl: SUCCESS</span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqcnv               ksqcnv: <span class="keyword">convert</span> TM<span class="number">-0001563e-00000000</span> <span class="keyword">from</span><span class="operator">=</span>SX <span class="keyword">to</span><span class="operator">=</span>SSX flags<span class="operator">=</span></span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqcnv               ksqcnv: SUCCESS</span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqcnv               ksqcnv: <span class="keyword">convert</span> TM<span class="number">-0001563e-00000000</span> <span class="keyword">from</span><span class="operator">=</span>SSX <span class="keyword">to</span><span class="operator">=</span>SX flags<span class="operator">=</span></span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqcnv               ksqcnv: SUCCESS</span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">3</span>b01000100000000 <span class="number">0000000000000000</span> bef2140000000000</span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">0400000000000000</span> <span class="number">1400000000000000</span> <span class="number">5403000000000000</span></span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               ef00c00000000000 <span class="number">2801000000000000</span> <span class="number">0</span>a00000000000000</span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">3</span>b01000100000000 <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">3</span>c01000100000000 <span class="number">0000000000000000</span> bef2140000000000</span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">0400000000000000</span> <span class="number">1400000000000000</span> <span class="number">5403000000000000</span></span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               ef00c00000000000 <span class="number">2801000000000000</span> <span class="number">0</span>a00000000000000</span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">3</span>c01000100000000 <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">3</span>d01000100000000 <span class="number">0000000000000000</span> bef2140000000000</span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">0400000000000000</span> <span class="number">1400000000000000</span> <span class="number">5403000000000000</span></span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               ef00c00000000000 <span class="number">2801000000000000</span> <span class="number">0</span>a00000000000000</span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">3</span>d01000100000000 <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">3e01000100000000</span> <span class="number">0000000000000000</span> bef2140000000000</span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">0400000000000000</span> <span class="number">1400000000000000</span> <span class="number">5403000000000000</span></span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               ef00c00000000000 <span class="number">2801000000000000</span> <span class="number">0</span>a00000000000000</span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">3e01000100000000</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">3</span>f01000100000000 <span class="number">0000000000000000</span> bef2140000000000</span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">0400000000000000</span> <span class="number">1400000000000000</span> <span class="number">5403000000000000</span></span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               ef00c00000000000 <span class="number">2801000000000000</span> <span class="number">0</span>a00000000000000</span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">3</span>f01000100000000 <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">3301000100000000</span> <span class="number">0000000000000000</span> bef2140000000000</span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">0000000000000000</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"> <span class="number">10811</span>      <span class="number">17</span>         <span class="number">36</span> ktbgcl1              <span class="number">3301000100000000</span> <span class="number">0000000000000000</span> bef2140000000000 <span class="number">0100000000000000</span></span><br><span class="line"> <span class="number">10811</span>      <span class="number">17</span>         <span class="number">36</span> ktbgcl1              <span class="number">3301000100000000</span> <span class="number">0000000000000000</span> bff2140000000000 e00fc76a177f0000</span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> kturCRBackoutOneChg  <span class="number">0100000000000000</span> ef00c00000000000 <span class="number">2801000000000000</span> <span class="number">0</span>a00000000000000</span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">3301000100000000</span> <span class="number">0100000000000000</span> <span class="number">0100000000000000</span></span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqcnv               ksqcnv: <span class="keyword">convert</span> TM<span class="number">-0001563e-00000000</span> <span class="keyword">from</span><span class="operator">=</span>SX <span class="keyword">to</span><span class="operator">=</span>SSX flags<span class="operator">=</span></span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqcnv               ksqcnv: SUCCESS</span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqcnv               ksqcnv: <span class="keyword">convert</span> TM<span class="number">-0001563e-00000000</span> <span class="keyword">from</span><span class="operator">=</span>SSX <span class="keyword">to</span><span class="operator">=</span>SX flags<span class="operator">=</span></span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqcnv               ksqcnv: SUCCESS</span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">3</span>b01000100000000 <span class="number">0000000000000000</span> c0f2140000000000</span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">0400000000000000</span> <span class="number">1400000000000000</span> <span class="number">5403000000000000</span></span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               ef00c00000000000 <span class="number">2801000000000000</span> <span class="number">0e00000000000000</span></span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">3</span>b01000100000000 <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">3</span>c01000100000000 <span class="number">0000000000000000</span> c0f2140000000000</span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">0400000000000000</span> <span class="number">1400000000000000</span> <span class="number">5403000000000000</span></span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               ef00c00000000000 <span class="number">2801000000000000</span> <span class="number">0e00000000000000</span></span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">3</span>c01000100000000 <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">3</span>d01000100000000 <span class="number">0000000000000000</span> c0f2140000000000</span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">0400000000000000</span> <span class="number">1400000000000000</span> <span class="number">5403000000000000</span></span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               ef00c00000000000 <span class="number">2801000000000000</span> <span class="number">0e00000000000000</span></span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">3</span>d01000100000000 <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">3e01000100000000</span> <span class="number">0000000000000000</span> c0f2140000000000</span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">0400000000000000</span> <span class="number">1400000000000000</span> <span class="number">5403000000000000</span></span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               ef00c00000000000 <span class="number">2801000000000000</span> <span class="number">0e00000000000000</span></span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">3e01000100000000</span> <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">3</span>f01000100000000 <span class="number">0000000000000000</span> c0f2140000000000</span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">0400000000000000</span> <span class="number">1400000000000000</span> <span class="number">5403000000000000</span></span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               ef00c00000000000 <span class="number">2801000000000000</span> <span class="number">0e00000000000000</span></span><br><span class="line"> <span class="number">10812</span>      <span class="number">17</span>         <span class="number">36</span> ktrgcm               <span class="number">3</span>f01000100000000 <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line"> <span class="number">10005</span>      <span class="number">17</span>         <span class="number">36</span> kslwtbctx            KSL WAIT BEG [<span class="keyword">SQL</span><span class="operator">*</span>Net message <span class="keyword">to</span> client] <span class="number">1650815232</span><span class="operator">/</span><span class="number">0x62657100</span> <span class="number">1</span><span class="operator">/</span><span class="number">0x1</span> <span class="number">0</span><span class="operator">/</span><span class="number">0x0</span> wait_id<span class="operator">=</span><span class="number">425</span> seq_num<span class="operator">=</span><span class="number">432</span> snap_id<span class="operator">=</span><span class="number">1</span></span><br><span class="line"> <span class="number">10005</span>      <span class="number">17</span>         <span class="number">36</span> kslwtectx            KSL WAIT <span class="keyword">END</span> [<span class="keyword">SQL</span><span class="operator">*</span>Net message <span class="keyword">to</span> client] <span class="number">1650815232</span><span class="operator">/</span><span class="number">0x62657100</span> <span class="number">1</span><span class="operator">/</span><span class="number">0x1</span> <span class="number">0</span><span class="operator">/</span><span class="number">0x0</span> wait_id<span class="operator">=</span><span class="number">425</span> seq_num<span class="operator">=</span><span class="number">432</span> snap_id<span class="operator">=</span><span class="number">1</span></span><br><span class="line"> <span class="number">10005</span>      <span class="number">17</span>         <span class="number">36</span> kslwtectx            KSL WAIT <span class="keyword">END</span> wait times (usecs) <span class="operator">-</span> snap<span class="operator">=</span><span class="number">4</span>, exc<span class="operator">=</span><span class="number">4</span>, tot<span class="operator">=</span><span class="number">4</span></span><br><span class="line"> <span class="number">10005</span>      <span class="number">17</span>         <span class="number">36</span> kslwtbctx            KSL WAIT BEG [<span class="keyword">SQL</span><span class="operator">*</span>Net message <span class="keyword">from</span> client] <span class="number">1650815232</span><span class="operator">/</span><span class="number">0x62657100</span> <span class="number">1</span><span class="operator">/</span><span class="number">0x1</span> <span class="number">0</span><span class="operator">/</span><span class="number">0x0</span> wait_id<span class="operator">=</span><span class="number">426</span> seq_num<span class="operator">=</span><span class="number">433</span> snap_id<span class="operator">=</span><span class="number">1</span></span><br></pre></td></tr></table></figure>

<p> 此时会申请一个mode为5的SSX锁，随后即转换为mode为3的SX锁，这也是在语句执行期间获取和转换的，并非事务期间，同样删除多少行就涉及到多少次获取转换，看一下此时锁获得情况</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span>  <span class="keyword">from</span> v$lock <span class="keyword">where</span> type <span class="keyword">in</span>(<span class="string">&#x27;TM&#x27;</span>,<span class="string">&#x27;TX&#x27;</span>);</span><br><span class="line"></span><br><span class="line">ADDR             KADDR                SID TY        ID1        ID2      LMODE    REQUEST      CTIME      BLOCK</span><br><span class="line"><span class="comment">---------------- ---------------- ------- -- ---------- ---------- ---------- ---------- ---------- ----------</span></span><br><span class="line"><span class="number">00007</span>FD97FFE6520 <span class="number">00007</span>FD97FFE6580      <span class="number">17</span> TM      <span class="number">87614</span>          <span class="number">0</span>          <span class="number">3</span>          <span class="number">0</span>        <span class="number">131</span>          <span class="number">0</span></span><br><span class="line"><span class="number">00000000</span>ACE37CD0 <span class="number">00000000</span>ACE37D48      <span class="number">17</span> TX     <span class="number">262164</span>        <span class="number">852</span>          <span class="number">6</span>          <span class="number">0</span>        <span class="number">131</span>          <span class="number">0</span></span><br><span class="line"><span class="number">00007</span>FD97FFE6520 <span class="number">00007</span>FD97FFE6580      <span class="number">17</span> TM      <span class="number">87612</span>          <span class="number">0</span>          <span class="number">3</span>          <span class="number">0</span>        <span class="number">131</span>          <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>是不是和没有cascade的时候不同了，这次最终会持有子表上的mode为3的锁，我们再深入的思考一点，SSX锁和SX锁是不兼容的，这样是否就意味着后进行的delete会被先进行的delete阻塞（不同session），好，现在就来模拟一下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">sid:<span class="number">1169</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">delete</span> <span class="keyword">from</span> prim <span class="keyword">where</span> a<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="number">0</span> <span class="keyword">rows</span> deleted.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span>  <span class="keyword">from</span> v$lock <span class="keyword">where</span> type <span class="keyword">in</span>(<span class="string">&#x27;TM&#x27;</span>,<span class="string">&#x27;TX&#x27;</span>);</span><br><span class="line"></span><br><span class="line">ADDR             KADDR                SID TY        ID1        ID2      LMODE    REQUEST      CTIME      BLOCK</span><br><span class="line"><span class="comment">---------------- ---------------- ------- -- ---------- ---------- ---------- ---------- ---------- ----------</span></span><br><span class="line"><span class="number">00007</span>FD97FFE54E8 <span class="number">00007</span>FD97FFE5548    <span class="number">1169</span> TM      <span class="number">87612</span>          <span class="number">0</span>          <span class="number">3</span>          <span class="number">0</span>         <span class="number">53</span>          <span class="number">0</span></span><br><span class="line"><span class="number">00007</span>FD97FFE54E8 <span class="number">00007</span>FD97FFE5548    <span class="number">1169</span> TM      <span class="number">87614</span>          <span class="number">0</span>          <span class="number">3</span>          <span class="number">0</span>         <span class="number">53</span>          <span class="number">0</span></span><br><span class="line"></span><br><span class="line">sid:<span class="number">1167</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">delete</span> <span class="keyword">from</span> prim <span class="keyword">where</span> a<span class="operator">=</span><span class="number">2</span>; <span class="comment">--session hang住了</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--查询此刻锁的持有情况</span></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span>  <span class="keyword">from</span> v$lock <span class="keyword">where</span> type <span class="keyword">in</span>(<span class="string">&#x27;TM&#x27;</span>,<span class="string">&#x27;TX&#x27;</span>);</span><br><span class="line"></span><br><span class="line">ADDR             KADDR                SID TY        ID1        ID2      LMODE    REQUEST      CTIME      BLOCK</span><br><span class="line"><span class="comment">---------------- ---------------- ------- -- ---------- ---------- ---------- ---------- ---------- ----------</span></span><br><span class="line"><span class="number">00007</span>FD97FFE6520 <span class="number">00007</span>FD97FFE6580    <span class="number">1169</span> TM      <span class="number">87612</span>          <span class="number">0</span>          <span class="number">3</span>          <span class="number">0</span>         <span class="number">85</span>          <span class="number">0</span></span><br><span class="line"><span class="number">00007</span>FD97FFE6520 <span class="number">00007</span>FD97FFE6580    <span class="number">1167</span> TM      <span class="number">87612</span>          <span class="number">0</span>          <span class="number">3</span>          <span class="number">0</span>         <span class="number">11</span>          <span class="number">0</span></span><br><span class="line"><span class="number">00007</span>FD97FFE6520 <span class="number">00007</span>FD97FFE6580    <span class="number">1167</span> TM      <span class="number">87614</span>          <span class="number">0</span>          <span class="number">0</span>          <span class="number">5</span>         <span class="number">11</span>          <span class="number">0</span></span><br><span class="line"><span class="number">00007</span>FD97FFE6520 <span class="number">00007</span>FD97FFE6580    <span class="number">1169</span> TM      <span class="number">87614</span>          <span class="number">0</span>          <span class="number">3</span>          <span class="number">0</span>         <span class="number">85</span>          <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>可见1167在请求mode为5的锁，且已被阻塞</p>
<p>查看等待链</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SID                  OBJECT_NAME                    SQL_TEXT                                 EVENT</span><br><span class="line"><span class="comment">-------------------- ------------------------------ ---------------------------------------- ----------------------------------------</span></span><br><span class="line"><span class="number">1.1169</span>                                                                                       <span class="keyword">SQL</span><span class="operator">*</span>Net message <span class="keyword">from</span> client</span><br><span class="line">    <span class="number">1.1167</span>           CHILD                          <span class="keyword">delete</span> <span class="keyword">from</span> prim <span class="keyword">where</span> a<span class="operator">=</span><span class="number">2</span>               enq: TM <span class="operator">-</span> contention</span><br></pre></td></tr></table></figure>

<p>因为delete完毕会持有子表上的SX锁，而SX锁与S锁不兼容，所以delete父表的session也会阻塞update父表的session，因为update会去请求子表的S锁，而此时子表上有SX锁，类似于子表上有事务在进行，这里就不在论述了，徒占篇幅。</p>
<h2 id="有索引，无cascade"><a href="#有索引，无cascade" class="headerlink" title="有索引，无cascade"></a>有索引，无cascade</h2><p>我看到有资料说，<code>如果有索引时,对父表的操作,会级联加一个TM RS锁(level 2)到子表上</code>。但我在试验中并未看到，也许是版本差异，我也未去求证，有索引时insert与无索引时在获取锁方面没有区别，这里仅列出update和delete</p>
<p>创建索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> child <span class="keyword">drop</span> <span class="keyword">constraint</span> FK_CHILD_CA;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Table</span> altered.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> child <span class="keyword">add</span> <span class="keyword">constraint</span> FK_CHILD_CA <span class="keyword">foreign</span> key (ca) <span class="keyword">references</span> prim(a);</span><br><span class="line"></span><br><span class="line"><span class="keyword">Table</span> altered.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">create</span>  index ind_child_ca <span class="keyword">on</span> child(ca);</span><br><span class="line"></span><br><span class="line">Index created.</span><br></pre></td></tr></table></figure>
<p>update父表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">update</span> prim <span class="keyword">set</span> a<span class="operator">=</span><span class="number">6</span> <span class="keyword">where</span> a<span class="operator">=</span><span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> updated.</span><br><span class="line"></span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqgtlctx            ksqgtl: acquire TM<span class="number">-0001563</span>c<span class="number">-00000000</span> mode<span class="operator">=</span>SX flags<span class="operator">=</span><span class="keyword">GLOBAL</span><span class="operator">|</span>XACT why<span class="operator">=</span>&quot;contention&quot;</span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqgtlctx            ksqgtl: SUCCESS</span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqgtlctx            ksqgtl: acquire TM<span class="number">-0001563e-00000000</span> mode<span class="operator">=</span>SX flags<span class="operator">=</span><span class="keyword">GLOBAL</span><span class="operator">|</span>XACT why<span class="operator">=</span>&quot;contention&quot;</span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqgtlctx            ksqgtl: SUCCESS</span><br><span class="line"> <span class="number">10811</span>      <span class="number">17</span>         <span class="number">36</span> ktbgcl1              <span class="number">2</span>b01000100000000 <span class="number">0000000000000000</span> fadc140000000000 <span class="number">0200000000000000</span></span><br><span class="line"> <span class="number">10811</span>      <span class="number">17</span>         <span class="number">36</span> ktbgcl1              <span class="number">2</span>b01000100000000 <span class="number">0000000000000000</span> cdf9140000000000 <span class="number">10</span>dfb76a177f0000</span><br><span class="line"> <span class="number">10813</span>      <span class="number">17</span>         <span class="number">36</span> ktubnd               ktubnd: Bind usn <span class="number">3</span> nax <span class="number">1</span> nbx <span class="number">0</span> lng <span class="number">0</span> par <span class="number">0</span></span><br><span class="line"> <span class="number">10813</span>      <span class="number">17</span>         <span class="number">36</span> ktubnd               ktubnd: Txn Bound xid: <span class="number">3.28</span><span class="number">.1117</span></span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqgtlctx            ksqgtl: acquire TX<span class="number">-0003001</span>c<span class="number">-0000045</span>d mode<span class="operator">=</span>X flags<span class="operator">=</span><span class="keyword">GLOBAL</span><span class="operator">|</span>XACT why<span class="operator">=</span>&quot;contention&quot;</span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqgtlctx            ksqgtl: SUCCESS</span><br><span class="line"> <span class="number">10005</span>      <span class="number">17</span>         <span class="number">36</span> kslwtbctx            KSL WAIT BEG [<span class="keyword">SQL</span><span class="operator">*</span>Net message <span class="keyword">to</span> client] <span class="number">1650815232</span><span class="operator">/</span><span class="number">0x62657100</span> <span class="number">1</span><span class="operator">/</span><span class="number">0x1</span> <span class="number">0</span><span class="operator">/</span><span class="number">0x0</span> wait_id<span class="operator">=</span><span class="number">471</span> seq_num<span class="operator">=</span><span class="number">478</span> snap_id<span class="operator">=</span><span class="number">1</span></span><br><span class="line"> <span class="number">10005</span>      <span class="number">17</span>         <span class="number">36</span> kslwtectx            KSL WAIT <span class="keyword">END</span> [<span class="keyword">SQL</span><span class="operator">*</span>Net message <span class="keyword">to</span> client] <span class="number">1650815232</span><span class="operator">/</span><span class="number">0x62657100</span> <span class="number">1</span><span class="operator">/</span><span class="number">0x1</span> <span class="number">0</span><span class="operator">/</span><span class="number">0x0</span> wait_id<span class="operator">=</span><span class="number">471</span> seq_num<span class="operator">=</span><span class="number">478</span> snap_id<span class="operator">=</span><span class="number">1</span></span><br><span class="line"> <span class="number">10005</span>      <span class="number">17</span>         <span class="number">36</span> kslwtectx            KSL WAIT <span class="keyword">END</span> wait times (usecs) <span class="operator">-</span> snap<span class="operator">=</span><span class="number">3</span>, exc<span class="operator">=</span><span class="number">3</span>, tot<span class="operator">=</span><span class="number">3</span></span><br><span class="line"> <span class="number">10005</span>      <span class="number">17</span>         <span class="number">36</span> kslwtbctx            KSL WAIT BEG [<span class="keyword">SQL</span><span class="operator">*</span>Net message <span class="keyword">from</span> client] <span class="number">1650815232</span><span class="operator">/</span><span class="number">0x62657100</span> <span class="number">1</span><span class="operator">/</span><span class="number">0x1</span> <span class="number">0</span><span class="operator">/</span><span class="number">0x0</span> wait_id<span class="operator">=</span><span class="number">472</span> seq_num<span class="operator">=</span><span class="number">479</span> snap_id<span class="operator">=</span><span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>可见有了索引之后，不再需要在语句级别获取子表上的S锁了</p>
<p>delete父表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">delete</span> <span class="keyword">from</span> prim <span class="keyword">where</span> a<span class="operator">=</span><span class="number">9</span>;</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> deleted.</span><br><span class="line"></span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqgtlctx            ksqgtl: acquire TM<span class="number">-0001563</span>c<span class="number">-00000000</span> mode<span class="operator">=</span>SX flags<span class="operator">=</span><span class="keyword">GLOBAL</span><span class="operator">|</span>XACT why<span class="operator">=</span>&quot;contention&quot;</span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqgtlctx            ksqgtl: SUCCESS</span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqgtlctx            ksqgtl: acquire TM<span class="number">-0001563e-00000000</span> mode<span class="operator">=</span>SX flags<span class="operator">=</span><span class="keyword">GLOBAL</span><span class="operator">|</span>XACT why<span class="operator">=</span>&quot;contention&quot;</span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqgtlctx            ksqgtl: SUCCESS</span><br><span class="line"> <span class="number">10811</span>      <span class="number">17</span>         <span class="number">36</span> ktbgcl1              <span class="number">2</span>c01000100000000 <span class="number">0000000000000000</span> <span class="number">66</span>f1140000000000 <span class="number">0200000000000000</span></span><br><span class="line"> <span class="number">10811</span>      <span class="number">17</span>         <span class="number">36</span> ktbgcl1              <span class="number">2</span>c01000100000000 <span class="number">0000000000000000</span> <span class="number">58</span>fa140000000000 <span class="number">78</span>efb76a177f0000</span><br><span class="line"> <span class="number">10813</span>      <span class="number">17</span>         <span class="number">36</span> ktubnd               ktubnd: Bind usn <span class="number">4</span> nax <span class="number">1</span> nbx <span class="number">0</span> lng <span class="number">0</span> par <span class="number">0</span></span><br><span class="line"> <span class="number">10813</span>      <span class="number">17</span>         <span class="number">36</span> ktubnd               ktubnd: Txn Bound xid: <span class="number">4.18</span><span class="number">.854</span></span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqgtlctx            ksqgtl: acquire TX<span class="number">-00040012</span><span class="number">-00000356</span> mode<span class="operator">=</span>X flags<span class="operator">=</span><span class="keyword">GLOBAL</span><span class="operator">|</span>XACT why<span class="operator">=</span>&quot;contention&quot;</span><br><span class="line"> <span class="number">10704</span>      <span class="number">17</span>         <span class="number">36</span> ksqgtlctx            ksqgtl: SUCCESS</span><br><span class="line"> <span class="number">10811</span>      <span class="number">17</span>         <span class="number">36</span> ktbgcl1              <span class="number">3301000100000000</span> <span class="number">0000000000000000</span> c0f2140000000000 <span class="number">0200000000000000</span></span><br><span class="line"> <span class="number">10811</span>      <span class="number">17</span>         <span class="number">36</span> ktbgcl1              <span class="number">3301000100000000</span> <span class="number">0000000000000000</span> <span class="number">58</span>fa140000000000 <span class="number">90</span>eec66a177f0000</span><br><span class="line"> <span class="number">10005</span>      <span class="number">17</span>         <span class="number">36</span> kslwtbctx            KSL WAIT BEG [<span class="keyword">SQL</span><span class="operator">*</span>Net message <span class="keyword">to</span> client] <span class="number">1650815232</span><span class="operator">/</span><span class="number">0x62657100</span> <span class="number">1</span><span class="operator">/</span><span class="number">0x1</span> <span class="number">0</span><span class="operator">/</span><span class="number">0x0</span> wait_id<span class="operator">=</span><span class="number">476</span> seq_num<span class="operator">=</span><span class="number">483</span> snap_id<span class="operator">=</span><span class="number">1</span></span><br><span class="line"> <span class="number">10005</span>      <span class="number">17</span>         <span class="number">36</span> kslwtectx            KSL WAIT <span class="keyword">END</span> [<span class="keyword">SQL</span><span class="operator">*</span>Net message <span class="keyword">to</span> client] <span class="number">1650815232</span><span class="operator">/</span><span class="number">0x62657100</span> <span class="number">1</span><span class="operator">/</span><span class="number">0x1</span> <span class="number">0</span><span class="operator">/</span><span class="number">0x0</span> wait_id<span class="operator">=</span><span class="number">476</span> seq_num<span class="operator">=</span><span class="number">483</span> snap_id<span class="operator">=</span><span class="number">1</span></span><br><span class="line"> <span class="number">10005</span>      <span class="number">17</span>         <span class="number">36</span> kslwtectx            KSL WAIT <span class="keyword">END</span> wait times (usecs) <span class="operator">-</span> snap<span class="operator">=</span><span class="number">4</span>, exc<span class="operator">=</span><span class="number">4</span>, tot<span class="operator">=</span><span class="number">4</span></span><br><span class="line"> <span class="number">10005</span>      <span class="number">17</span>         <span class="number">36</span> kslwtbctx            KSL WAIT BEG [<span class="keyword">SQL</span><span class="operator">*</span>Net message <span class="keyword">from</span> client] <span class="number">1650815232</span><span class="operator">/</span><span class="number">0x62657100</span> <span class="number">1</span><span class="operator">/</span><span class="number">0x1</span> <span class="number">0</span><span class="operator">/</span><span class="number">0x0</span> wait_id<span class="operator">=</span><span class="number">477</span> seq_num<span class="operator">=</span><span class="number">484</span> snap_id<span class="operator">=</span><span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>与update相同，都持有了子表上的SX锁，而SX与SX是相容的，所以不会再产生锁定问题</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span>  <span class="keyword">from</span> v$lock <span class="keyword">where</span> type <span class="keyword">in</span>(<span class="string">&#x27;TM&#x27;</span>,<span class="string">&#x27;TX&#x27;</span>);</span><br><span class="line"></span><br><span class="line">ADDR             KADDR                SID TY        ID1        ID2      LMODE    REQUEST      CTIME      BLOCK</span><br><span class="line"><span class="comment">---------------- ---------------- ------- -- ---------- ---------- ---------- ---------- ---------- ----------</span></span><br><span class="line"><span class="number">00007</span>FD97FFE54E8 <span class="number">00007</span>FD97FFE5548      <span class="number">17</span> TM      <span class="number">87614</span>          <span class="number">0</span>          <span class="number">3</span>          <span class="number">0</span>        <span class="number">182</span>          <span class="number">0</span></span><br><span class="line"><span class="number">00000000</span>ABD4E7C0 <span class="number">00000000</span>ABD4E838      <span class="number">17</span> TX     <span class="number">262162</span>        <span class="number">854</span>          <span class="number">6</span>          <span class="number">0</span>        <span class="number">182</span>          <span class="number">0</span></span><br><span class="line"><span class="number">00007</span>FD97FFE54E8 <span class="number">00007</span>FD97FFE5548      <span class="number">17</span> TM      <span class="number">87612</span>          <span class="number">0</span>          <span class="number">3</span>          <span class="number">0</span>        <span class="number">182</span>          <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h2 id="有索引，有cascade"><a href="#有索引，有cascade" class="headerlink" title="有索引，有cascade"></a>有索引，有cascade</h2><p><code>表现与无cascade时相同</code></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>外键无索引锁无cascade时，update&#x2F;delete父表，会在语句级别级联一个mode为4的S锁到子表，其中delete多少行就会级联多少次</li>
<li>外键无索引有cascade时，update父表仍会在语句级别级联mode为4的S锁到子表，delete时会先获取mode为5的SSX锁，在将其转换成mode为3的SX锁，而且删除多少行就会涉及到多少次转换</li>
<li>外键有索引无cascade时，update&#x2F;delete不会在语句级级联锁到子表，最终会持有父表和子表上的mode为3的SX锁（无索引时只有有cascade的delete时最终会持有子表上的SX锁）</li>
<li>外键有索引有cascade时，与无cascade表现相同</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2016/07/25/oracle/lock-latch/enq-TM-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/gzh.jpg">
      <meta itemprop="name" content="巴流">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
      <meta itemprop="description" content="左手人文 | 右手科技">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 兔子先生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/07/25/oracle/lock-latch/enq-TM-1/" class="post-title-link" itemprop="url">enq之TM-contention解决之道——外键无索引导致锁争用（上）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-07-25 16:21:00" itemprop="dateCreated datePublished" datetime="2016-07-25T16:21:00+08:00">2016-07-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-07 09:32:12" itemprop="dateModified" datetime="2025-02-07T09:32:12+08:00">2025-02-07</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>近日，开发负责人反映某生产环境业务处理缓慢，主要业务操作就是修改会员信息，登录查询后发现大量的session正在等待enq: TM - contention，且waiting的语句几乎都是update<br>session的即时信息没有保留，现在附上ash视图的一些统计信息，可以大概了解一下当时争用的场景</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="variable">@ash_wait_chains</span>.<span class="keyword">sql</span> username<span class="operator">||</span><span class="string">&#x27;:&#x27;</span><span class="operator">||</span>program2<span class="operator">||</span>event2 session_type<span class="operator">=</span><span class="string">&#x27;FOREGROUND&#x27;</span> sysdate<span class="number">-6</span><span class="operator">/</span><span class="number">24</span> sysdate<span class="number">-5</span><span class="operator">/</span><span class="number">24</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Display ASH Wait Chain Signatures script v0.2 BETA by Tanel Poder ( http://blog.tanelpoder.com )</span></span><br><span class="line"></span><br><span class="line"><span class="operator">%</span>This     SECONDS        AAS</span><br><span class="line"><span class="comment">------ ---------- ----------</span></span><br><span class="line">WAIT_CHAIN</span><br><span class="line"><span class="comment">------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span></span><br><span class="line">  <span class="number">72</span><span class="operator">%</span>       <span class="number">20073</span>        <span class="number">5.6</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) <span class="keyword">ON</span> CPU</span><br><span class="line"></span><br><span class="line">   <span class="number">8</span><span class="operator">%</span>        <span class="number">2293</span>         <span class="number">.6</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) enq: TM <span class="operator">-</span> contention  <span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) <span class="keyword">ON</span> CPU</span><br><span class="line"></span><br><span class="line">   <span class="number">8</span><span class="operator">%</span>        <span class="number">2141</span>         <span class="number">.6</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) log file sync  <span class="operator">-</span><span class="operator">&gt;</span> SYS:(LGWR) log file parallel write</span><br><span class="line"></span><br><span class="line">   <span class="number">7</span><span class="operator">%</span>        <span class="number">1879</span>         <span class="number">.5</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) log file sync  <span class="operator">-</span><span class="operator">&gt;</span> SYS:(LGWR) LGWR<span class="operator">-</span>LNS wait <span class="keyword">on</span> channel</span><br><span class="line"></span><br><span class="line">   <span class="number">2</span><span class="operator">%</span>         <span class="number">654</span>         <span class="number">.2</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) enq: TM <span class="operator">-</span> contention  <span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) enq: TM <span class="operator">-</span> contention  <span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) <span class="keyword">ON</span> CPU</span><br><span class="line"></span><br><span class="line">   <span class="number">1</span><span class="operator">%</span>         <span class="number">288</span>         <span class="number">.1</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) enq: TM <span class="operator">-</span> contention  <span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) enq: TM <span class="operator">-</span> contention  <span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) enq: TM <span class="operator">-</span> contention  <span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) <span class="keyword">ON</span> CPU</span><br><span class="line"></span><br><span class="line">   <span class="number">1</span><span class="operator">%</span>         <span class="number">149</span>          <span class="number">0</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) log file sync  <span class="operator">-</span><span class="operator">&gt;</span> SYS:(LGWR) <span class="keyword">ON</span> CPU</span><br><span class="line"></span><br><span class="line">   <span class="number">0</span><span class="operator">%</span>         <span class="number">128</span>          <span class="number">0</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) enq: TM <span class="operator">-</span> contention</span><br><span class="line"></span><br><span class="line">   <span class="number">0</span><span class="operator">%</span>         <span class="number">112</span>          <span class="number">0</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) log file sync</span><br><span class="line"></span><br><span class="line">   <span class="number">0</span><span class="operator">%</span>          <span class="number">86</span>          <span class="number">0</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) db file scattered read</span><br><span class="line"></span><br><span class="line">   <span class="number">0</span><span class="operator">%</span>          <span class="number">43</span>          <span class="number">0</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) enq: TM <span class="operator">-</span> contention  <span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) enq: TM <span class="operator">-</span> contention  <span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) enq: TM <span class="operator">-</span> contention  <span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) enq: TM <span class="operator">-</span> contention  <span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) <span class="keyword">ON</span> CPU</span><br><span class="line"></span><br><span class="line">   <span class="number">0</span><span class="operator">%</span>          <span class="number">37</span>          <span class="number">0</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) enq: TM <span class="operator">-</span> contention  <span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) enq: TM <span class="operator">-</span> contention</span><br><span class="line"></span><br><span class="line">   <span class="number">0</span><span class="operator">%</span>          <span class="number">25</span>          <span class="number">0</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) log file sync  <span class="operator">-</span><span class="operator">&gt;</span> SYS:(LGWR) LGWR wait <span class="keyword">on</span> LNS</span><br><span class="line"></span><br><span class="line">   <span class="number">0</span><span class="operator">%</span>          <span class="number">13</span>          <span class="number">0</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(plsqldev.exe) <span class="keyword">ON</span> CPU</span><br><span class="line"></span><br><span class="line">   <span class="number">0</span><span class="operator">%</span>          <span class="number">11</span>          <span class="number">0</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> SYS:(plsqldev.exe) <span class="keyword">ON</span> CPU</span><br><span class="line"></span><br><span class="line">   <span class="number">0</span><span class="operator">%</span>          <span class="number">10</span>          <span class="number">0</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) <span class="keyword">SQL</span><span class="operator">*</span>Net more data <span class="keyword">from</span> client</span><br><span class="line"></span><br><span class="line">   <span class="number">0</span><span class="operator">%</span>           <span class="number">9</span>          <span class="number">0</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) db file sequential read</span><br><span class="line"></span><br><span class="line">   <span class="number">0</span><span class="operator">%</span>           <span class="number">9</span>          <span class="number">0</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) enq: TM <span class="operator">-</span> contention  <span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) enq: TM <span class="operator">-</span> contention  <span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) enq: TM <span class="operator">-</span> contention  <span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) enq: TM <span class="operator">-</span> contention  <span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) enq: TM <span class="operator">-</span> contention  <span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) <span class="keyword">ON</span></span><br><span class="line">CPU</span><br><span class="line"></span><br><span class="line">   <span class="number">0</span><span class="operator">%</span>           <span class="number">6</span>          <span class="number">0</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) read <span class="keyword">by</span> other session  <span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) <span class="keyword">ON</span> CPU</span><br><span class="line"></span><br><span class="line">   <span class="number">0</span><span class="operator">%</span>           <span class="number">4</span>          <span class="number">0</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) enq: TM <span class="operator">-</span> contention  <span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) enq: TM <span class="operator">-</span> contention  <span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) enq: TM <span class="operator">-</span> contention</span><br><span class="line"></span><br><span class="line">   <span class="number">0</span><span class="operator">%</span>           <span class="number">3</span>          <span class="number">0</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) <span class="keyword">SQL</span><span class="operator">*</span>Net more data <span class="keyword">to</span> client</span><br><span class="line"></span><br><span class="line">   <span class="number">0</span><span class="operator">%</span>           <span class="number">3</span>          <span class="number">0</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) buffer busy waits [data block]</span><br><span class="line"></span><br><span class="line">   <span class="number">0</span><span class="operator">%</span>           <span class="number">3</span>          <span class="number">0</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> SYS:(oraagent.bin) Disk file operations I<span class="operator">/</span>O</span><br><span class="line"></span><br><span class="line">   <span class="number">0</span><span class="operator">%</span>           <span class="number">3</span>          <span class="number">0</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) log file sync  <span class="operator">-</span><span class="operator">&gt;</span> SYS:(LGWR) LGWR wait <span class="keyword">for</span> redo <span class="keyword">copy</span></span><br><span class="line"></span><br><span class="line">   <span class="number">0</span><span class="operator">%</span>           <span class="number">2</span>          <span class="number">0</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) enq: TX <span class="operator">-</span> <span class="type">row</span> lock contention</span><br><span class="line"></span><br><span class="line">   <span class="number">0</span><span class="operator">%</span>           <span class="number">2</span>          <span class="number">0</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) log file sync  <span class="operator">-</span><span class="operator">&gt;</span> SYS:(LGWR) LGWR wait <span class="keyword">for</span> redo <span class="keyword">copy</span>  <span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) <span class="keyword">ON</span> CPU</span><br><span class="line"></span><br><span class="line">   <span class="number">0</span><span class="operator">%</span>           <span class="number">2</span>          <span class="number">0</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) enq: TX <span class="operator">-</span> index contention  <span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) <span class="keyword">ON</span> CPU</span><br><span class="line"></span><br><span class="line">   <span class="number">0</span><span class="operator">%</span>           <span class="number">1</span>          <span class="number">0</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(plsqldev.exe) log file sync  <span class="operator">-</span><span class="operator">&gt;</span> SYS:(LGWR) log file parallel write</span><br><span class="line"></span><br><span class="line">   <span class="number">0</span><span class="operator">%</span>           <span class="number">1</span>          <span class="number">0</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> SYS:(plsqldev.exe) Disk file operations I<span class="operator">/</span>O</span><br><span class="line"></span><br><span class="line">   <span class="number">0</span><span class="operator">%</span>           <span class="number">1</span>          <span class="number">0</span></span><br><span class="line"><span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) enq: TX <span class="operator">-</span> <span class="type">row</span> lock contention  <span class="operator">-</span><span class="operator">&gt;</span> JSCHPROD:(JDBC Thin Client) <span class="keyword">ON</span> CPU</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">30</span> <span class="keyword">rows</span> selected.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到，TM锁的争用很多，再看一份当时awr报告的top10</p>
<p><img data-src="https://liupzminblog.files.wordpress.com/2016/12/qq20161218-02x.png"></p>
<p>虽然占DBTIME不多，但本来是很快的操作，短时间内给人的感觉就是业务处理缓慢<br>查一下当时等待事件的p1,p2,p3的值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> ash.SAMPLE_TIME,</span><br><span class="line">       ash.EVENT,</span><br><span class="line">       ash.SESSION_ID,</span><br><span class="line">       ash.BLOCKING_SESSION,</span><br><span class="line">       ash.P1TEXT,</span><br><span class="line">       ash.P1,</span><br><span class="line">       ash.P2TEXT,</span><br><span class="line">       ash.p2,</span><br><span class="line">       ash.p3text,</span><br><span class="line">       ash.p3,</span><br><span class="line">       ash.SESSION_STATE,</span><br><span class="line">       ash.SQL_OPNAME,</span><br><span class="line">       ash.SQL_ID</span><br><span class="line">       <span class="comment">--ash.*</span></span><br><span class="line">  <span class="keyword">from</span> v$active_session_history ash</span><br><span class="line"> <span class="keyword">where</span> ash.SAMPLE_TIME <span class="operator">&gt;</span></span><br><span class="line">       to_date(<span class="string">&#x27;20160425 10:00:00&#x27;</span>, <span class="string">&#x27;yyyymmdd HH24:MI:SS&#x27;</span>)</span><br><span class="line">   <span class="keyword">and</span> ash.SAMPLE_TIME <span class="operator">&lt;</span></span><br><span class="line">       to_date(<span class="string">&#x27;20160425 12:10:00&#x27;</span>, <span class="string">&#x27;yyyymmdd HH24:MI:SS&#x27;</span>)</span><br><span class="line">   <span class="keyword">and</span> ash.WAIT_CLASS <span class="operator">&lt;&gt;</span> <span class="string">&#x27;Idle&#x27;</span></span><br><span class="line">   <span class="keyword">and</span> ash.EVENT <span class="keyword">like</span> <span class="string">&#x27;enq: TM - contention&#x27;</span></span><br><span class="line"> <span class="keyword">order</span> <span class="keyword">by</span> sample_time <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>

<p>下面是部分结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">enq: TM - contention	1828	2401	name|mode	1414332421	object #	110417	table/partition	0	WAITING	UPDATE	ak25v8q8p6fzd</span><br><span class="line">enq: TM - contention	1873	2504	name|mode	1414332419	object #	110415	table/partition	0	WAITING	INSERT	7w0tma5up32wt</span><br><span class="line">enq: TM - contention	2504	1828	name|mode	1414332421	object #	110415	table/partition	0	WAITING	UPDATE	ak25v8q8p6fzd</span><br><span class="line">enq: TM - contention	772	4	name|mode	1414332421	object #	110417	table/partition	0	WAITING	UPDATE	ak25v8q8p6fzd</span><br><span class="line">enq: TM - contention	1781	1828	name|mode	1414332419	object #	110415	table/partition	0	WAITING	INSERT	7w0tma5up32wt</span><br><span class="line">enq: TM - contention	1828	772	name|mode	1414332421	object #	110415	table/partition	0	WAITING	UPDATE	ak25v8q8p6fzd</span><br><span class="line">enq: TM - contention	2401	1828	name|mode	1414332419	object #	110415	table/partition	0	WAITING	INSERT	7w0tma5up32wt</span><br><span class="line">enq: TM - contention	2504	772	name|mode	1414332421	object #	110415	table/partition	0	WAITING	UPDATE	ak25v8q8p6fzd</span><br><span class="line">enq: TM - contention	4	772	name|mode	1414332419	object #	110415	table/partition	0	WAITING	INSERT	7w0tma5up32wt</span><br><span class="line">enq: TM - contention	148	1781	name|mode	1414332420	object #	110428	table/partition	0	WAITING	UPDATE	9gd6xhd0xyhph</span><br><span class="line">enq: TM - contention	772	148	name|mode	1414332421	object #	110415	table/partition	0	WAITING	UPDATE	ak25v8q8p6fzd</span><br><span class="line">enq: TM - contention	1828	148	name|mode	1414332421	object #	110415	table/partition	0	WAITING	UPDATE	ak25v8q8p6fzd</span><br><span class="line">enq: TM - contention	1873	772	name|mode	1414332419	object #	110415	table/partition	0	WAITING	INSERT	7w0tma5up32wt</span><br></pre></td></tr></table></figure>

<p>可以看到p2的值为产生TM争用的对象id，经过查证，这些object均是session正在更新的表的子表，而且通过v$sql查看update语句均更改了主表的主键，问题到这里已经很明朗了，由于外键没加索引，导致了主表在更新主表主键或删除主表记录时对子表的锁定，而且这张主表被大量的子表引用，此时子表上也同时进行事务处理，所以造成了更新主表的session 不时hang住。</p>
<p>通过对所有子表的外键加索引，消除了争用，检测未加索引的外键语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> TABLE_NAME,</span><br><span class="line">       CONSTRAINT_NAME,</span><br><span class="line">       CNAME1 <span class="operator">||</span> NVL2(CNAME2, <span class="string">&#x27;,&#x27;</span> <span class="operator">||</span> CNAME2, <span class="keyword">NULL</span>) <span class="operator">||</span></span><br><span class="line">       NVL2(CNAME3, <span class="string">&#x27;,&#x27;</span> <span class="operator">||</span> CNAME3, <span class="keyword">NULL</span>) <span class="operator">||</span></span><br><span class="line">       NVL2(CNAME4, <span class="string">&#x27;,&#x27;</span> <span class="operator">||</span> CNAME4, <span class="keyword">NULL</span>) <span class="operator">||</span></span><br><span class="line">       NVL2(CNAME5, <span class="string">&#x27;,&#x27;</span> <span class="operator">||</span> CNAME5, <span class="keyword">NULL</span>) <span class="operator">||</span></span><br><span class="line">       NVL2(CNAME6, <span class="string">&#x27;,&#x27;</span> <span class="operator">||</span> CNAME6, <span class="keyword">NULL</span>) <span class="operator">||</span></span><br><span class="line">       NVL2(CNAME7, <span class="string">&#x27;,&#x27;</span> <span class="operator">||</span> CNAME7, <span class="keyword">NULL</span>) <span class="operator">||</span></span><br><span class="line">       NVL2(CNAME8, <span class="string">&#x27;,&#x27;</span> <span class="operator">||</span> CNAME8, <span class="keyword">NULL</span>) COLUMNS</span><br><span class="line">  <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> B.TABLE_NAME,</span><br><span class="line">               B.CONSTRAINT_NAME,</span><br><span class="line">               <span class="built_in">MAX</span>(DECODE(POSITION, <span class="number">1</span>, COLUMN_NAME, <span class="keyword">NULL</span>)) CNAME1,</span><br><span class="line">               <span class="built_in">MAX</span>(DECODE(POSITION, <span class="number">2</span>, COLUMN_NAME, <span class="keyword">NULL</span>)) CNAME2,</span><br><span class="line">               <span class="built_in">MAX</span>(DECODE(POSITION, <span class="number">3</span>, COLUMN_NAME, <span class="keyword">NULL</span>)) CNAME3,</span><br><span class="line">               <span class="built_in">MAX</span>(DECODE(POSITION, <span class="number">4</span>, COLUMN_NAME, <span class="keyword">NULL</span>)) CNAME4,</span><br><span class="line">               <span class="built_in">MAX</span>(DECODE(POSITION, <span class="number">5</span>, COLUMN_NAME, <span class="keyword">NULL</span>)) CNAME5,</span><br><span class="line">               <span class="built_in">MAX</span>(DECODE(POSITION, <span class="number">6</span>, COLUMN_NAME, <span class="keyword">NULL</span>)) CNAME6,</span><br><span class="line">               <span class="built_in">MAX</span>(DECODE(POSITION, <span class="number">7</span>, COLUMN_NAME, <span class="keyword">NULL</span>)) CNAME7,</span><br><span class="line">               <span class="built_in">MAX</span>(DECODE(POSITION, <span class="number">8</span>, COLUMN_NAME, <span class="keyword">NULL</span>)) CNAME8,</span><br><span class="line">               <span class="built_in">COUNT</span>(<span class="operator">*</span>) COL_CNT</span><br><span class="line">          <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> SUBSTR(TABLE_NAME, <span class="number">1</span>, <span class="number">30</span>) TABLE_NAME,</span><br><span class="line">                       SUBSTR(CONSTRAINT_NAME, <span class="number">1</span>, <span class="number">30</span>) CONSTRAINT_NAME,</span><br><span class="line">                       SUBSTR(COLUMN_NAME, <span class="number">1</span>, <span class="number">30</span>) COLUMN_NAME,</span><br><span class="line">                       POSITION</span><br><span class="line">                  <span class="keyword">FROM</span> USER_CONS_COLUMNS) A,</span><br><span class="line">               USER_CONSTRAINTS B</span><br><span class="line">         <span class="keyword">WHERE</span> A.CONSTRAINT_NAME <span class="operator">=</span> B.CONSTRAINT_NAME</span><br><span class="line">           <span class="keyword">AND</span> B.CONSTRAINT_TYPE <span class="operator">=</span> <span class="string">&#x27;R&#x27;</span></span><br><span class="line">         <span class="keyword">GROUP</span> <span class="keyword">BY</span> B.TABLE_NAME, B.CONSTRAINT_NAME) CONS</span><br><span class="line"> <span class="keyword">WHERE</span> COL_CNT <span class="operator">&gt;</span> <span class="keyword">ALL</span></span><br><span class="line"> (<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>)</span><br><span class="line">          <span class="keyword">FROM</span> USER_IND_COLUMNS I</span><br><span class="line">         <span class="keyword">WHERE</span> I.TABLE_NAME <span class="operator">=</span> CONS.TABLE_NAME</span><br><span class="line">           <span class="keyword">AND</span> I.COLUMN_NAME <span class="keyword">IN</span> (CNAME1, CNAME2, CNAME3, CNAME4, CNAME5,</span><br><span class="line">                CNAME6, CNAME7, CNAME8)</span><br><span class="line">           <span class="keyword">AND</span> I.COLUMN_POSITION <span class="operator">&lt;=</span> CONS.COL_CNT</span><br><span class="line">         <span class="keyword">GROUP</span> <span class="keyword">BY</span> I.INDEX_NAME);</span><br></pre></td></tr></table></figure>

<p>这是摘自TOM大师的语句，外键不加索引也是导致死锁的常见原因之一，因此对于主表经常进行更新删除操作的情况，外键一定要加索引。<br>至于外键未加索引是如何导致锁定的，以及为何加了索引后争用就消失了? 敬请关注enq: TM - contention解决之道——外键无索引导致锁争用 （下）</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2016/07/20/oracle/backup-restore/ORA-00600-13011/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/gzh.jpg">
      <meta itemprop="name" content="巴流">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
      <meta itemprop="description" content="左手人文 | 右手科技">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 兔子先生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/07/20/oracle/backup-restore/ORA-00600-13011/" class="post-title-link" itemprop="url">一次ORA-00600[13011]处理过程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-07-20 18:48:00" itemprop="dateCreated datePublished" datetime="2016-07-20T18:48:00+08:00">2016-07-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-07 09:32:12" itemprop="dateModified" datetime="2025-02-07T09:32:12+08:00">2025-02-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oracle-restore/" itemprop="url" rel="index"><span itemprop="name">oracle restore</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>一次掉电后，DG主库启动alert中报如下错误</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Errors in file /home/oracle/app/oracle/diag/rdbms/min/min/trace/min_m002_4099.trc  (incident=16328):</span><br><span class="line">ORA-00600: internal error code, arguments: [13011], [6443], [8463760], [14], [8488694], [0], [], [], [], [], [], []</span><br><span class="line">Incident details in: /home/oracle/app/oracle/diag/rdbms/min/min/incident/incdir_16328/min_m002_4099_i16328.trc</span><br><span class="line">Use ADRCI or Support Workbench to package the incident.</span><br><span class="line">See Note 411.1 at My Oracle Support for error and packaging details.</span><br><span class="line">Errors in file /home/oracle/app/oracle/diag/rdbms/min/min/trace/min_m002_4099.trc  (incident=16329):</span><br><span class="line">ORA-00600: internal error code, arguments: [kewrose_1], [600], [ORA-00600: internal error code, arguments: [13011], [6443], [8463760], [14], [8488694], [0], [], [], [], [], [], []</span><br><span class="line">], [], [], [], [], [], [], [], [], []</span><br><span class="line">Incident details in: /home/oracle/app/oracle/diag/rdbms/min/min/incident/incdir_16329/min_m002_4099_i16329.trc</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查看trace文件，部分内容如下</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">*** 2016-07-20 18:21:04.185</span><br><span class="line">*** SESSION ID:(169.43) 2016-07-20 18:21:04.185</span><br><span class="line">*** CLIENT ID:() 2016-07-20 18:21:04.185</span><br><span class="line">*** SERVICE NAME:(SYS$BACKGROUND) 2016-07-20 18:21:04.185</span><br><span class="line">*** MODULE NAME:(MMON_SLAVE) 2016-07-20 18:21:04.185</span><br><span class="line">*** ACTION NAME:(Auto-Purge Slave Action) 2016-07-20 18:21:04.185</span><br><span class="line"></span><br><span class="line">Dump continued from file: /home/oracle/app/oracle/diag/rdbms/min/min/trace/min_m000_2615.trc</span><br><span class="line">ORA-00600: internal error code, arguments: [13011], [6665], [8395075], [14], [8462787], [0], [], [], [], [], [], []</span><br><span class="line"></span><br><span class="line">========= Dump for incident 14804 (ORA 600 [13011]) ========</span><br><span class="line"></span><br><span class="line">*** 2016-07-20 18:21:04.186</span><br><span class="line">dbkedDefDump(): Starting incident default dumps (flags=0x2, level=3, mask=0x0)</span><br><span class="line">----- Current SQL Statement for this session (sql_id=c8taax4bfzsjc) -----</span><br><span class="line">delete from WRH$_RSRC_PLAN tab where (:beg_snap &lt;= tab.snap_id and         tab.snap_id &lt;= :end_snap and         dbid = :dbid)    and not exists (select 1 from WRM$_BASELINE b                    wh</span><br><span class="line">ere (tab.dbid = b.dbid) and                          (tab.snap_id &gt;= b.start_snap_id) and                          (tab.snap_id &lt;= b.end_snap_id))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>MOS中关于ORA-600 [13013]描述</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Format: ORA-600 [13013] [a] [b] &#123;c&#125; [d] [e] [f]</span><br><span class="line">Arg [a] Passcount</span><br><span class="line">Arg [b] Data Object number</span><br><span class="line">Arg &#123;c&#125; Tablespace Decimal Relative DBA (RDBA) of block containing the row to be updated</span><br><span class="line">Arg [d] Row Slot number</span><br><span class="line">Arg [e] Decimal RDBA of block being updated (Typically same as &#123;c&#125;)</span><br><span class="line">Arg [f] Code</span><br></pre></td></tr></table></figure>
<blockquote>
<p>确定object</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> owner,object_name,object_type  <span class="keyword">from</span> dba_objects <span class="keyword">where</span> object_id<span class="operator">=</span><span class="number">6665</span>;</span><br><span class="line"></span><br><span class="line">OWNER                          OBJECT_NAME                                                  OBJECT_TYPE</span><br><span class="line"><span class="comment">------------------------------ ------------------------------------------------------------ -------------------</span></span><br><span class="line">SYS                            WRH$_RSRC_PLAN                                               <span class="keyword">TABLE</span></span><br></pre></td></tr></table></figure>
<p>可见与trc文件中的sql中对象名吻合，都是<strong>WRH$_RSRC_PLAN</strong><br>查看trc文件中的<strong>PLAN TABLE</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">----- Plan Table -----</span><br><span class="line"></span><br><span class="line">============</span><br><span class="line">Plan Table</span><br><span class="line">============</span><br><span class="line">-----------------------------------------------------------+-----------------------------------+</span><br><span class="line">| Id  | Operation                       | Name             | Rows  | Bytes | Cost  | Time      |</span><br><span class="line">-----------------------------------------------------------+-----------------------------------+</span><br><span class="line">| 0   | DELETE STATEMENT                |                  |       |       |   626 |           |</span><br><span class="line">| 1   |  DELETE                         | WRH$_RSRC_PLAN   |       |       |       |           |</span><br><span class="line">| 2   |   FILTER                        |                  |       |       |       |           |</span><br><span class="line">| 3   |    INDEX RANGE SCAN             | WRH$_RSRC_PLAN_PK|    94 |  1598 |     8 |  00:00:01 |</span><br><span class="line">| 4   |     TABLE ACCESS BY INDEX ROWID | WRM$_BASELINE    |     1 |    33 |     2 |  00:00:01 |</span><br><span class="line">| 5   |      INDEX RANGE SCAN           | WRM$_BASELINE_PK |     1 |       |     1 |  00:00:01 |</span><br><span class="line">-----------------------------------------------------------+-----------------------------------+</span><br></pre></td></tr></table></figure>
<p>1.The most common cause of this error is an index corruption. The first step is to check the indexes for corruption, i.e. run</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> ANALYZE INDEX WRH$_RSRC_PLAN_PK VALIDATE STRUCTURE;</span><br><span class="line"></span><br><span class="line">Index analyzed.</span><br></pre></td></tr></table></figure>

<p>2.If the indexes do not report corruption, further test for corruption the base tables referenced in the execution plan or the statement producing the error:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> ANALYZE <span class="keyword">TABLE</span> WRH$_RSRC_PLAN VALIDATE STRUCTURE CASCADE;</span><br><span class="line">ANALYZE <span class="keyword">TABLE</span> WRH$_RSRC_PLAN VALIDATE STRUCTURE CASCADE</span><br><span class="line"><span class="operator">*</span></span><br><span class="line">ERROR <span class="keyword">at</span> line <span class="number">1</span>:</span><br><span class="line">ORA<span class="number">-01499</span>: <span class="keyword">table</span><span class="operator">/</span>index <span class="keyword">cross</span> reference failure <span class="operator">-</span> see trace file</span><br></pre></td></tr></table></figure>

<p>查看生成的trace文件内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">*** 2016-07-21 01:31:31.840</span><br><span class="line">*** SESSION ID:(52.5) 2016-07-21 01:31:31.840</span><br><span class="line">*** CLIENT ID:() 2016-07-21 01:31:31.840</span><br><span class="line">*** SERVICE NAME:(SYS$USERS) 2016-07-21 01:31:31.840</span><br><span class="line">*** MODULE NAME:(sqlplus@primary (TNS V1-V3)) 2016-07-21 01:31:31.840</span><br><span class="line">*** ACTION NAME:() 2016-07-21 01:31:31.840</span><br><span class="line"></span><br><span class="line">Table/Index row count mismatch</span><br><span class="line">table 2901 : index 3203, 296</span><br><span class="line">Index root = tsn: 1 rdba: 0x0080194a</span><br></pre></td></tr></table></figure>

<p>对于文件内容，简单介绍如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">trace文件中包含：</span><br><span class="line"></span><br><span class="line">&lt;description&gt;: tsn: &lt;tablespace number&gt; rdba: &lt;relative dba&gt;</span><br><span class="line"></span><br><span class="line">description有以下值：</span><br><span class="line"></span><br><span class="line">&quot;row not found in index&quot;</span><br><span class="line">&quot;Table/Index row count mismatch&quot;</span><br><span class="line">&quot;row mismatch in index dba&quot;</span><br><span class="line">&quot;Table row count/Bitmap index bit count mismatch&quot;</span><br><span class="line">&quot;kdavls: kdcchk returns %d when checking cluster dba 0x%08lx objn %d\n&quot;</span><br><span class="line"></span><br><span class="line">tsn:    Tablespace Number表示的是索引存储的表空间编号。</span><br><span class="line">rdba: 是索引段头相对于数据块的存储地址。</span><br></pre></td></tr></table></figure>

<p>运行以下sql查询索引的文件和块号</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> dbms_utility.data_block_address_file(</span><br><span class="line">         to_number(<span class="built_in">trim</span>(<span class="keyword">leading</span> <span class="string">&#x27;0&#x27;</span> <span class="keyword">from</span></span><br><span class="line">replace(<span class="string">&#x27;&amp;&amp;rdba&#x27;</span>,<span class="string">&#x27;0x&#x27;</span>,<span class="string">&#x27;&#x27;</span>)),<span class="string">&#x27;XXXXXXXX&#x27;</span>)</span><br><span class="line">       ) <span class="keyword">AS</span> rfile#,</span><br><span class="line">       dbms_utility.data_block_address_block(</span><br><span class="line">         to_number(<span class="built_in">trim</span>(<span class="keyword">leading</span> <span class="string">&#x27;0&#x27;</span> <span class="keyword">from</span></span><br><span class="line">replace(<span class="string">&#x27;&amp;&amp;rdba&#x27;</span>,<span class="string">&#x27;0x&#x27;</span>,<span class="string">&#x27;&#x27;</span>)),<span class="string">&#x27;XXXXXXXX&#x27;</span>)</span><br><span class="line">       ) <span class="keyword">AS</span> block#</span><br><span class="line"><span class="keyword">FROM</span> dual;</span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">SELECT</span> dbms_utility.data_block_address_file(</span><br><span class="line">  <span class="number">2</span>           to_number(<span class="built_in">trim</span>(<span class="keyword">leading</span> <span class="string">&#x27;0&#x27;</span> <span class="keyword">from</span></span><br><span class="line">  <span class="number">3</span>  replace(<span class="string">&#x27;&amp;&amp;rdba&#x27;</span>,<span class="string">&#x27;0x&#x27;</span>,<span class="string">&#x27;&#x27;</span>)),<span class="string">&#x27;XXXXXXXX&#x27;</span>)</span><br><span class="line">  <span class="number">4</span>         ) <span class="keyword">AS</span> rfile#,</span><br><span class="line">  <span class="number">5</span>         dbms_utility.data_block_address_block(</span><br><span class="line">  <span class="number">6</span>           to_number(<span class="built_in">trim</span>(<span class="keyword">leading</span> <span class="string">&#x27;0&#x27;</span> <span class="keyword">from</span></span><br><span class="line">  <span class="number">7</span>  replace(<span class="string">&#x27;&amp;&amp;rdba&#x27;</span>,<span class="string">&#x27;0x&#x27;</span>,<span class="string">&#x27;&#x27;</span>)),<span class="string">&#x27;XXXXXXXX&#x27;</span>)</span><br><span class="line">  <span class="number">8</span>         ) <span class="keyword">AS</span> block#</span><br><span class="line">  <span class="number">9</span>  <span class="keyword">FROM</span> dual;</span><br><span class="line">Enter <span class="keyword">value</span> <span class="keyword">for</span> rdba: <span class="number">0x0080194a</span></span><br><span class="line"><span class="keyword">old</span>   <span class="number">3</span>: replace(<span class="string">&#x27;&amp;&amp;rdba&#x27;</span>,<span class="string">&#x27;0x&#x27;</span>,<span class="string">&#x27;&#x27;</span>)),<span class="string">&#x27;XXXXXXXX&#x27;</span>)</span><br><span class="line"><span class="keyword">new</span>   <span class="number">3</span>: replace(<span class="string">&#x27;0x0080194a&#x27;</span>,<span class="string">&#x27;0x&#x27;</span>,<span class="string">&#x27;&#x27;</span>)),<span class="string">&#x27;XXXXXXXX&#x27;</span>)</span><br><span class="line"><span class="keyword">old</span>   <span class="number">7</span>: replace(<span class="string">&#x27;&amp;&amp;rdba&#x27;</span>,<span class="string">&#x27;0x&#x27;</span>,<span class="string">&#x27;&#x27;</span>)),<span class="string">&#x27;XXXXXXXX&#x27;</span>)</span><br><span class="line"><span class="keyword">new</span>   <span class="number">7</span>: replace(<span class="string">&#x27;0x0080194a&#x27;</span>,<span class="string">&#x27;0x&#x27;</span>,<span class="string">&#x27;&#x27;</span>)),<span class="string">&#x27;XXXXXXXX&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    RFILE#     BLOCK#</span><br><span class="line"><span class="comment">---------- ----------</span></span><br><span class="line">         <span class="number">2</span>       <span class="number">6474</span></span><br></pre></td></tr></table></figure>

<p>接下来运行如下查询，定位具体的segment</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> owner, segment_name, segment_type</span><br><span class="line"><span class="keyword">from</span>  dba_segments</span><br><span class="line"><span class="keyword">where</span> header_file <span class="operator">=</span> <span class="operator">&lt;</span>rfile#<span class="operator">&gt;</span></span><br><span class="line">  <span class="keyword">and</span> header_block <span class="operator">=</span> <span class="operator">&lt;</span>block#<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> owner, segment_name, segment_type</span><br><span class="line">  <span class="number">2</span>  <span class="keyword">from</span>  dba_segments</span><br><span class="line">  <span class="number">3</span>  <span class="keyword">where</span> header_file <span class="operator">=</span> <span class="number">2</span></span><br><span class="line">  <span class="number">4</span>    <span class="keyword">and</span> header_block <span class="operator">=</span> <span class="number">6474</span>;</span><br><span class="line">OWNER                          SEGMENT_NAME                                                                      SEGMENT_TYPE</span><br><span class="line"><span class="comment">------------------------------ --------------------------------------------------------------------------------- ------------------</span></span><br><span class="line">SYS                            WRH$_RSRC_PLAN_PK                                                                 INDEX</span><br></pre></td></tr></table></figure>

<p>看来仍然是上面分析过的索引，这里是因为表和索引的数据不一致，那么重建索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> WRH$_RSRC_PLAN <span class="keyword">drop</span> <span class="keyword">constraint</span> WRH$_RSRC_PLAN_PK cascade;</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> WRH$_RSRC_PLAN</span><br><span class="line">  <span class="keyword">add</span> <span class="keyword">constraint</span> WRH$_RSRC_PLAN_PK <span class="keyword">primary</span> key (DBID, SNAP_ID, INSTANCE_NUMBER, SEQUENCE#);</span><br></pre></td></tr></table></figure>
<p>再次分析表，发现错误消失了</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> ANALYZE <span class="keyword">TABLE</span> WRH$_RSRC_PLAN VALIDATE STRUCTURE CASCADE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Table</span> analyzed.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>至此，问题解决</p>
</blockquote>
<p>掉电仍是数据库的大敌，而此次并非只在这一张表上有讹误，还有其他一些WRH$表，这些表均属于sysaux表空间，这些表都是awr系列表，写入频繁，掉电容易引起数据的不一致性，但是，正因为是awr数据，并不是特别重要，修复起来也相对容易。  </p>
<blockquote>
<p>记录一下AWR Performance Tables介绍</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">The Oracle10g dynamic performance tables constitute the foundation of sophisticated automations such as Automatic Memory Management  (AMM ) as well as intelligent advisory tools such as ADDM and the SQL Tuning   Advisor.</span><br><span class="line"></span><br><span class="line">Remember, the AWR is a core feature of the 10g database kernel and automatically collects and stores important run-time performance information for our historical analysis.</span><br><span class="line"></span><br><span class="line">The tables that store this information are prefixed with wrh$ and are very similar in function to the STATSPACK tables.  This could make STATSPACK appear somewhat obsolete, although it is still available in the $ORACLE_HOME/rdbms/admin directory.</span><br><span class="line"></span><br><span class="line">Unlike the more cumbersome STATSPACK utility, which requires knowledge of the table structure and creation of complex query scripts, the 10g Enterprise Manager (OEM) automatically displays and interprets this valuable time-series performance data.</span><br><span class="line"></span><br><span class="line">The wrh$ AWR tables store important historical statistical information about the database in the form of periodic snapshots. Each snapshot is a capture of the in–memory x$ fixed view and other control structures at a certain point in time. Each of the AWR table names is prefixed with wrm$ (Metadata tables), wrh$ (History tables), or wri$ (Advisory tables).</span><br><span class="line"></span><br><span class="line"> 1. The wrm$ tables store metadata information for the Workload Repository.</span><br><span class="line"></span><br><span class="line"> 2. The wrh$ tables store historical data or snapshots.</span><br><span class="line"></span><br><span class="line"> 3. The wri$ tables: These 49 tables store data related to advisory functions.</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2014 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">NexT</span>
</div>
  <div class="powered-by">由 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZw==">NexT.Gemini</span> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xpdXB6bWlu" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js" integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  


  <script src="/js/third-party/fancybox.js"></script>


  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"liupzmin","repo":"liupzmin.github.io","client_id":"77654195445087c01c56","client_secret":"eda09eecd05b86f0ef995d8067ec751abeb753d9","admin_user":"liupzmin","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","ClientID":"ae0756501dfc5de89d35","ClientSecret":"26befb359f7a466031bb96b4b7e0715c41c63fb8","owner":"liupzmin","adminUser":"['liupzmin']","labels":"['Gitalk']","perPage":15,"pagerDirection":"last","createIssueManually":true,"distractionFreeMode":false,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"82ca3c470e333e0bd93410abdccf0f6d"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
