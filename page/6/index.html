<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="yandex-verification" content="3ac9ae36ddebb425">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"liupzmin.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.15.1","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="左手人文 | 右手科技">
<meta property="og:type" content="website">
<meta property="og:title" content="兔子先生">
<meta property="og:url" content="http://liupzmin.com/page/6/index.html">
<meta property="og:site_name" content="兔子先生">
<meta property="og:description" content="左手人文 | 右手科技">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="巴流">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://liupzmin.com/page/6/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/6/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>兔子先生 - 探寻计算机的历史与哲学密码</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="兔子先生" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">兔子先生</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">探寻计算机的历史与哲学密码</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档<span class="badge">60</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签<span class="badge">63</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="th fa-fw"></i>分类<span class="badge">32</span></a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="巴流"
      src="/images/gzh.jpg">
  <p class="site-author-name" itemprop="name">巴流</p>
  <div class="site-description" itemprop="description">左手人文 | 右手科技</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">60</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">63</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xpdXB6bWlu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;liupzmin"><i class="github fa-fw"></i></span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOmxpdXB6bWluQGdtYWlsLmNvbQ==" title="E-Mail → mailto:liupzmin@gmail.com"><i class="envelope fa-fw"></i></span>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i></a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2016/05/27/oracle/DG/DG-broker-note/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/gzh.jpg">
      <meta itemprop="name" content="巴流">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
      <meta itemprop="description" content="左手人文 | 右手科技">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 兔子先生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/05/27/oracle/DG/DG-broker-note/" class="post-title-link" itemprop="url">DG Broker管理dataguard注意事项</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-05-27 18:22:59" itemprop="dateCreated datePublished" datetime="2016-05-27T18:22:59+08:00">2016-05-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-07 09:32:12" itemprop="dateModified" datetime="2025-02-07T09:32:12+08:00">2025-02-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oracle/" itemprop="url" rel="index"><span itemprop="name">oracle</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><code>Once you start using the Broker you must always use the Broker to make any changes to your Data Guard configuration. This means that you must use Grid Control or the Broker CLI DGMGRL to change any Data Guard settings. If you use SQL*Plus to make configuration changes, the Broker will put things back the way it sees the world or this will lead to inconsistencies between the Broker configuration parameters and the database.</code></p>
<p>一旦开始使用Broker，就必须一直使用它修改DG的配置，这意味着必须使用grid control或者dgmgrl修改DG的配置，如果使用sqlplus修改配置，broker会将配置改回原样，或者导致broker配置参数与数据库之间不一致</p>
<blockquote>
<p>此例记录修改保护模式，由最高可用降级为最大性能</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">DGMGRL<span class="operator">&gt;</span> <span class="keyword">show</span> configuration;</span><br><span class="line">Configuration <span class="operator">-</span> minconf</span><br><span class="line">Protection Mode: MaxAvailability</span><br><span class="line">Databases:</span><br><span class="line">minstd <span class="operator">-</span> <span class="keyword">Primary</span> database</span><br><span class="line">min <span class="operator">-</span> Physical standby database</span><br><span class="line">Fast<span class="operator">-</span><span class="keyword">Start</span> Failover: DISABLED</span><br><span class="line">Configuration Status:</span><br><span class="line">SUCCESS</span><br><span class="line">DGMGRL<span class="operator">&gt;</span> EDIT DATABASE <span class="string">&#x27;minstd&#x27;</span> <span class="keyword">SET</span> PROPERTY <span class="string">&#x27;LogXptMode&#x27;</span><span class="operator">=</span><span class="string">&#x27;ASYNC&#x27;</span>;</span><br><span class="line">Property &quot;LogXptMode&quot; updated</span><br><span class="line">DGMGRL<span class="operator">&gt;</span> EDIT DATABASE <span class="string">&#x27;min&#x27;</span> <span class="keyword">SET</span> PROPERTY <span class="string">&#x27;LogXptMode&#x27;</span><span class="operator">=</span><span class="string">&#x27;ASYNC&#x27;</span>;</span><br><span class="line">Error: ORA<span class="number">-16805</span>: change <span class="keyword">of</span> LogXptMode property violates overall protection mode</span><br><span class="line">Failed.</span><br><span class="line">DGMGRL<span class="operator">&gt;</span> EDIT CONFIGURATION <span class="keyword">SET</span> PROTECTION MODE <span class="keyword">AS</span> MaxPerformance;</span><br><span class="line">Succeeded.</span><br><span class="line">DGMGRL<span class="operator">&gt;</span> <span class="keyword">show</span> configuration;</span><br><span class="line">Configuration <span class="operator">-</span> minconf</span><br><span class="line">Protection Mode: MaxPerformance</span><br><span class="line">Databases:</span><br><span class="line">minstd <span class="operator">-</span> <span class="keyword">Primary</span> database</span><br><span class="line">min <span class="operator">-</span> Physical standby database</span><br><span class="line">Fast<span class="operator">-</span><span class="keyword">Start</span> Failover: DISABLED</span><br><span class="line">Configuration Status:</span><br><span class="line">SUCCESS</span><br><span class="line">````</span><br><span class="line"></span><br><span class="line">使用broker修改会使LOG_ARCHIVE_DEST_2参数变得较为复杂，例如</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>service&#x3D;&quot;minstd&quot;, LGWR SYNC AFFIRM delay&#x3D;0 optional compression&#x3D;disable max_failure&#x3D;0 max_connections&#x3D;1 reopen&#x3D;300 db_unique_name&#x3D;&quot;minstd&quot; net_timeout&#x3D;30, valid_for&#x3D;(all_logfiles,primary_role)</p>
<pre><code>
而且修改后在sqlplus中show parameter LOG_ARCHIVE_DEST_2仅有主库显示更改之后的状态，而备库还保留原样，但是在show database verbose中是修改好的，仅当在发生切换时，备库变为主库时才会更正参数，可见最好使用broker来管理配置
</code></pre>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2016/03/22/oracle/DG/dg-broker-ORA-16664-ORA-16792/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/gzh.jpg">
      <meta itemprop="name" content="巴流">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
      <meta itemprop="description" content="左手人文 | 右手科技">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 兔子先生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/03/22/oracle/DG/dg-broker-ORA-16664-ORA-16792/" class="post-title-link" itemprop="url">DataGuard配置Broker解决ORA-16664、ORA-16792</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-03-22 16:21:00" itemprop="dateCreated datePublished" datetime="2016-03-22T16:21:00+08:00">2016-03-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-07 09:32:12" itemprop="dateModified" datetime="2025-02-07T09:32:12+08:00">2025-02-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oracle/" itemprop="url" rel="index"><span itemprop="name">oracle</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>给某一个客户安装ADG完毕，配置Broker方便日后的管理与切换，碰到些许问题，以作记录</p>
<p>创建完configuration之后，enable的过程很慢，而且状态出现error</p>
<p>主库查询：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">DGMGRL<span class="operator">&gt;</span> <span class="keyword">SHOW</span> CONFIGURATION VERBOSE;</span><br><span class="line">Configuration <span class="operator">-</span> anxinconf</span><br><span class="line">Protection Mode: MaxAvailability</span><br><span class="line">Databases:</span><br><span class="line">anxin <span class="operator">-</span> <span class="keyword">Primary</span> database</span><br><span class="line">anxinstd <span class="operator">-</span> Physical standby database</span><br><span class="line">Error: ORA<span class="number">-16664</span>: unable <span class="keyword">to</span> receive the <span class="keyword">result</span> <span class="keyword">from</span> a database</span><br><span class="line">Properties:</span><br><span class="line">FastStartFailoverThreshold <span class="operator">=</span> <span class="string">&#x27;30&#x27;</span></span><br><span class="line">OperationTimeout <span class="operator">=</span> <span class="string">&#x27;30&#x27;</span></span><br><span class="line">FastStartFailoverLagLimit <span class="operator">=</span> <span class="string">&#x27;30&#x27;</span></span><br><span class="line">CommunicationTimeout <span class="operator">=</span> <span class="string">&#x27;180&#x27;</span></span><br><span class="line">ObserverReconnect <span class="operator">=</span> <span class="string">&#x27;0&#x27;</span></span><br><span class="line">FastStartFailoverAutoReinstate <span class="operator">=</span> <span class="string">&#x27;TRUE&#x27;</span></span><br><span class="line">FastStartFailoverPmyShutdown <span class="operator">=</span> <span class="string">&#x27;TRUE&#x27;</span></span><br><span class="line">BystandersFollowRoleChange <span class="operator">=</span> <span class="string">&#x27;ALL&#x27;</span></span><br><span class="line">ObserverOverride <span class="operator">=</span> <span class="string">&#x27;FALSE&#x27;</span></span><br><span class="line">ExternalDestination1 <span class="operator">=</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">ExternalDestination2 <span class="operator">=</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">PrimaryLostWriteAction <span class="operator">=</span> <span class="string">&#x27;CONTINUE&#x27;</span></span><br><span class="line">Fast<span class="operator">-</span><span class="keyword">Start</span> Failover: DISABLED</span><br><span class="line">Configuration Status:</span><br><span class="line">ERROR</span><br></pre></td></tr></table></figure>

<p>备库查询：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">DGMGRL<span class="operator">&gt;</span> <span class="keyword">SHOW</span> CONFIGURATION VERBOSE;</span><br><span class="line">Configuration <span class="operator">-</span> anxinconf</span><br><span class="line">Protection Mode: MaxAvailability</span><br><span class="line">Databases:</span><br><span class="line">anxin <span class="operator">-</span> <span class="keyword">Primary</span> database</span><br><span class="line">anxinstd <span class="operator">-</span> Physical standby database</span><br><span class="line">Warning: ORA<span class="number">-16792</span>: configurable property <span class="keyword">value</span> <span class="keyword">is</span> inconsistent <span class="keyword">with</span> database setting</span><br><span class="line">Properties:</span><br><span class="line">FastStartFailoverThreshold <span class="operator">=</span> <span class="string">&#x27;30&#x27;</span></span><br><span class="line">OperationTimeout <span class="operator">=</span> <span class="string">&#x27;30&#x27;</span></span><br><span class="line">FastStartFailoverLagLimit <span class="operator">=</span> <span class="string">&#x27;30&#x27;</span></span><br><span class="line">CommunicationTimeout <span class="operator">=</span> <span class="string">&#x27;180&#x27;</span></span><br><span class="line">ObserverReconnect <span class="operator">=</span> <span class="string">&#x27;0&#x27;</span></span><br><span class="line">FastStartFailoverAutoReinstate <span class="operator">=</span> <span class="string">&#x27;TRUE&#x27;</span></span><br><span class="line">FastStartFailoverPmyShutdown <span class="operator">=</span> <span class="string">&#x27;TRUE&#x27;</span></span><br><span class="line">BystandersFollowRoleChange <span class="operator">=</span> <span class="string">&#x27;ALL&#x27;</span></span><br><span class="line">ObserverOverride <span class="operator">=</span> <span class="string">&#x27;FALSE&#x27;</span></span><br><span class="line">ExternalDestination1 <span class="operator">=</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">ExternalDestination2 <span class="operator">=</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">PrimaryLostWriteAction <span class="operator">=</span> <span class="string">&#x27;CONTINUE&#x27;</span></span><br><span class="line">Fast<span class="operator">-</span><span class="keyword">Start</span> Failover: DISABLED</span><br><span class="line">Configuration Status:</span><br><span class="line">WARNING</span><br></pre></td></tr></table></figure>

<p>查看备数据库的状态</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">DGMGRL<span class="operator">&gt;</span> <span class="keyword">show</span> database verbose anxinstd;</span><br><span class="line">Database <span class="operator">-</span> anxinstd</span><br><span class="line">Role: PHYSICAL STANDBY</span><br><span class="line">Intended State: APPLY<span class="operator">-</span><span class="keyword">ON</span></span><br><span class="line">Transport Lag: <span class="number">0</span> seconds (computed <span class="number">1</span> <span class="keyword">second</span> ago)</span><br><span class="line">Apply Lag: <span class="number">0</span> seconds (computed <span class="number">1</span> <span class="keyword">second</span> ago)</span><br><span class="line">Apply Rate: <span class="number">54.00</span> KByte<span class="operator">/</span>s</span><br><span class="line"><span class="type">Real</span> <span class="type">Time</span> Query: <span class="keyword">ON</span></span><br><span class="line">Instance(s):</span><br><span class="line">anxinstd</span><br><span class="line">Warning: ORA<span class="number">-16714</span>: the <span class="keyword">value</span> <span class="keyword">of</span> property ArchiveLagTarget <span class="keyword">is</span> inconsistent <span class="keyword">with</span> the database setting</span><br><span class="line">Warning: ORA<span class="number">-16714</span>: the <span class="keyword">value</span> <span class="keyword">of</span> property LogArchiveMinSucceedDest <span class="keyword">is</span> inconsistent <span class="keyword">with</span> the database setting</span><br><span class="line">Warning: ORA<span class="number">-16714</span>: the <span class="keyword">value</span> <span class="keyword">of</span> property LogArchiveTrace <span class="keyword">is</span> inconsistent <span class="keyword">with</span> the database setting</span><br><span class="line">Warning: ORA<span class="number">-16714</span>: the <span class="keyword">value</span> <span class="keyword">of</span> property LogArchiveFormat <span class="keyword">is</span> inconsistent <span class="keyword">with</span> the database setting</span><br><span class="line"></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>此时主备alert日志均有报错 <code>Fatal NI connect error 12514, connecting to:</code></p>
<p>主库：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=TCP)(HOST=192.168.1.101)(PORT=1521)))(CONNECT_DATA=(SERVICE_NAME=anxinstd_DGB)(CID=(PROGRAM=oracle)(HOST=db01)(USER=oracle))))</span><br></pre></td></tr></table></figure>

<p>备库：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=TCP)(HOST=192.168.1.100)(PORT=1521)))(CONNECT_DATA=(SERVICE_NAME=anxin_DGB)(CID=(PROGRAM=oracle)(HOST=db02)(USER=oracle))))</span><br></pre></td></tr></table></figure>

<p>备库状态报告4个属性值与数据库设置不一致，重新设置</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DGMGRL<span class="operator">&gt;</span> edit database anxinstd <span class="keyword">set</span> property LogArchiveFormat<span class="operator">=</span><span class="string">&#x27;%t_%s_%r.arc&#x27;</span>;</span><br><span class="line">Property &quot;logarchiveformat&quot; updated</span><br><span class="line">DGMGRL<span class="operator">&gt;</span> edit database anxinstd <span class="keyword">set</span> property ArchiveLagTarget<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line">Property &quot;archivelagtarget&quot; updated</span><br><span class="line">DGMGRL<span class="operator">&gt;</span> edit database anxinstd <span class="keyword">set</span> property LogArchiveTrace<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line">Property &quot;logarchivetrace&quot; updated</span><br><span class="line">DGMGRL<span class="operator">&gt;</span> edit database anxinstd <span class="keyword">set</span> property LogArchiveMinSucceedDest<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">Property &quot;logarchiveminsucceeddest&quot; updated</span><br><span class="line">DGMGRL<span class="operator">&gt;</span> <span class="keyword">show</span> database verbose anxinstd;</span><br></pre></td></tr></table></figure>

<p>再次查看broker状态</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">DGMGRL<span class="operator">&gt;</span> <span class="keyword">SHOW</span> CONFIGURATION VERBOSE;</span><br><span class="line">Configuration <span class="operator">-</span> anxinconf</span><br><span class="line">Protection Mode: MaxAvailability</span><br><span class="line">Databases:</span><br><span class="line">anxin <span class="operator">-</span> <span class="keyword">Primary</span> database</span><br><span class="line">anxinstd <span class="operator">-</span> Physical standby database</span><br><span class="line">Properties:</span><br><span class="line">FastStartFailoverThreshold <span class="operator">=</span> <span class="string">&#x27;30&#x27;</span></span><br><span class="line">OperationTimeout <span class="operator">=</span> <span class="string">&#x27;30&#x27;</span></span><br><span class="line">FastStartFailoverLagLimit <span class="operator">=</span> <span class="string">&#x27;30&#x27;</span></span><br><span class="line">CommunicationTimeout <span class="operator">=</span> <span class="string">&#x27;180&#x27;</span></span><br><span class="line">ObserverReconnect <span class="operator">=</span> <span class="string">&#x27;0&#x27;</span></span><br><span class="line">FastStartFailoverAutoReinstate <span class="operator">=</span> <span class="string">&#x27;TRUE&#x27;</span></span><br><span class="line">FastStartFailoverPmyShutdown <span class="operator">=</span> <span class="string">&#x27;TRUE&#x27;</span></span><br><span class="line">BystandersFollowRoleChange <span class="operator">=</span> <span class="string">&#x27;ALL&#x27;</span></span><br><span class="line">ObserverOverride <span class="operator">=</span> <span class="string">&#x27;FALSE&#x27;</span></span><br><span class="line">ExternalDestination1 <span class="operator">=</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">ExternalDestination2 <span class="operator">=</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">PrimaryLostWriteAction <span class="operator">=</span> <span class="string">&#x27;CONTINUE&#x27;</span></span><br><span class="line">Fast<span class="operator">-</span><span class="keyword">Start</span> Failover: DISABLED</span><br><span class="line">Configuration Status:</span><br><span class="line">SUCCESS</span><br></pre></td></tr></table></figure>

<p>主备状态都正常了</p>
<p>接下来测试切换的时候又出现了问题</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DGMGRL<span class="operator">&gt;</span> SWITCHOVER <span class="keyword">TO</span> anxinstd;</span><br><span class="line">Performing switchover NOW, please wait...</span><br><span class="line">Operation requires a connection <span class="keyword">to</span> instance &quot;anxinstd&quot; <span class="keyword">on</span> database &quot;anxinstd&quot;</span><br><span class="line">Connecting <span class="keyword">to</span> instance &quot;anxinstd&quot;...</span><br><span class="line">Unable <span class="keyword">to</span> <span class="keyword">connect</span> <span class="keyword">to</span> database</span><br><span class="line">ORA<span class="number">-12514</span>: TNS:listener does <span class="keyword">not</span> currently know <span class="keyword">of</span> service requested <span class="keyword">in</span> <span class="keyword">connect</span> descriptor</span><br><span class="line">Failed.</span><br><span class="line">Warning: You <span class="keyword">are</span> <span class="keyword">no</span> longer connected <span class="keyword">to</span> ORACLE.</span><br><span class="line"><span class="keyword">connect</span> <span class="keyword">to</span> instance &quot;anxinstd&quot; <span class="keyword">of</span> database &quot;anxinstd&quot;</span><br></pre></td></tr></table></figure>

<p><strong>官方文档中有如下描述：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">After performing a switchover using DGMGRL, Data Guard requires a shutdown and startup of both the primary and standby databases. This issue can occur if any necessary entry is missing in the listener.ora file.</span><br><span class="line">DGMGRL is unable to connect to the database after it has been stopped while performing the switchover</span><br><span class="line"></span><br><span class="line">To enable DGMGRL to restart instances during the course of broker operations, a service with a specific name must be statically registered with the listener of each instance. </span><br><span class="line">The value for the GLOBAL_DBNAME attribute must be set to a concatenation of db_unique_name_DGMGRL.db_domain in the LISTENER.ORA file.</span><br></pre></td></tr></table></figure>

<p>看一下StaticConnectIdentifier的值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DGMGRL<span class="operator">&gt;</span> <span class="keyword">show</span> database anxin StaticConnectIdentifier;</span><br><span class="line">StaticConnectIdentifier <span class="operator">=</span> <span class="string">&#x27;(DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=db01)(PORT=1521))(CONNECT_DATA=(SERVICE_NAME=anxin_DGMGRL)(INSTANCE_NAME=anxin)(SERVER=DEDICATED)))&#x27;</span></span><br><span class="line">DGMGRL<span class="operator">&gt;</span> <span class="keyword">show</span> database anxinstd StaticConnectIdentifier;</span><br><span class="line">StaticConnectIdentifier <span class="operator">=</span> <span class="string">&#x27;(DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=db02)(PORT=1521))(CONNECT_DATA=(SERVICE_NAME=anxinstd_DGMGRL)(INSTANCE_NAME=anxinstd)(SERVER=DEDICATED)))&#x27;</span></span><br></pre></td></tr></table></figure>

<p>均去连接一个db_unique_name_DGMGRL.db_domain格式的服务，那么需要在监听里静态注册一个db_unique_name_DGMGRL.db_domain的服务</p>
<p>主：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">xin =</span><br><span class="line">(DESCRIPTION_LIST =</span><br><span class="line">(DESCRIPTION =</span><br><span class="line">(ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.1.100)(PORT = 1521))</span><br><span class="line">)</span><br><span class="line">)</span><br><span class="line">SID_LIST_xin=</span><br><span class="line">(SID_LIST=</span><br><span class="line">(SID_DESC=</span><br><span class="line">(GLOBAL_DBNAME=anxin)</span><br><span class="line">(ORACLE_HOME=/u01/app/oracle/product/11.2.0/dbhome_1)</span><br><span class="line">(SID_NAME=anxin)</span><br><span class="line">)</span><br><span class="line">(SID_DESC=</span><br><span class="line">(GLOBAL_DBNAME=anxin_DGMGRL)</span><br><span class="line">(ORACLE_HOME=/u01/app/oracle/product/11.2.0/dbhome_1)</span><br><span class="line">(SID_NAME=anxin)</span><br><span class="line">)</span><br><span class="line">)</span><br><span class="line">)</span><br><span class="line">ADR_BASE_LISTENER = /u01/app/oracle</span><br></pre></td></tr></table></figure>

<p>备：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">xin =</span><br><span class="line">(DESCRIPTION_LIST =</span><br><span class="line">(DESCRIPTION =</span><br><span class="line">(ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.1.101)(PORT = 1521))</span><br><span class="line">)</span><br><span class="line">)</span><br><span class="line">SID_LIST_xin=</span><br><span class="line">(SID_LIST=</span><br><span class="line">(SID_DESC=</span><br><span class="line">(GLOBAL_DBNAME=anxinstd)</span><br><span class="line">(ORACLE_HOME=/u01/app/oracle/product/11.2.0/dbhome_1)</span><br><span class="line">(SID_NAME=anxinstd)</span><br><span class="line">)</span><br><span class="line">(SID_DESC=</span><br><span class="line">(GLOBAL_DBNAME=anxinstd_DGMGRL)</span><br><span class="line">(ORACLE_HOME=/u01/app/oracle/product/11.2.0/dbhome_1)</span><br><span class="line">(SID_NAME=anxinstd)</span><br><span class="line">)</span><br><span class="line">)</span><br><span class="line">)</span><br><span class="line">ADR_BASE_LISTENER = /u01/app/oracle</span><br></pre></td></tr></table></figure>

<p>再次测试，问题依旧，莫非和之前alert里的 Fatal NI connect error 12514报错有关？错误信息里的链接描述符均去请求一个db_unique_name_DGB.db_domain的服务，那么再依样添加到静态注册里试试</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">DGMGRL<span class="operator">&gt;</span> switchover <span class="keyword">to</span> anxinstd;</span><br><span class="line">Performing switchover NOW, please wait...</span><br><span class="line">Operation requires a connection <span class="keyword">to</span> instance &quot;anxinstd&quot; <span class="keyword">on</span> database &quot;anxinstd&quot;</span><br><span class="line">Connecting <span class="keyword">to</span> instance &quot;anxinstd&quot;...</span><br><span class="line">Connected.</span><br><span class="line"><span class="keyword">New</span> <span class="keyword">primary</span> database &quot;anxinstd&quot; <span class="keyword">is</span> opening...</span><br><span class="line">Operation requires startup <span class="keyword">of</span> instance &quot;anxin&quot; <span class="keyword">on</span> database &quot;anxin&quot;</span><br><span class="line">Starting instance &quot;anxin&quot;...</span><br><span class="line">ORACLE instance started.</span><br><span class="line">Database mounted.</span><br><span class="line">Database opened.</span><br><span class="line">Switchover succeeded, <span class="keyword">new</span> <span class="keyword">primary</span> <span class="keyword">is</span> &quot;anxinstd&quot;</span><br></pre></td></tr></table></figure>

<p>成功了，那么这个db_unique_name_DGB.db_domain的服务究竟是做什么用的呢？</p>
<p>{db_unique_name}_DGB.{db_domain}: This Service is used by the DMON-Processes to communicate between each other<br>DMON是一个用来管理broker的后台进程，这个进程负责与本地数据库以及远程数据库的DMON进程进行通讯（与远端数据库的DMON进程进行通讯的时候使用的是一个 动态注册 的service name “db_unique_name_DGB.db_domain”）</p>
<p>既然是动态注册，那缘何注册失败呢？<br>文档 ID 365314.1给出了答案：<strong>Database Will Not Register With Listener configured on IP instead of Hostname</strong></p>
<p>将主备的{db_unique_name}_DGB.{db_domain}静态entry删掉，host采用hostname，重启监听测试，switchover成功。</p>
<p>由此可见监听配置里还是采用hostname为好，通过本次事件也解惑了萦绕我心头很久的问题，很多时候建库完毕，使用工具创建动态注册的监听，监听状态里会有很多XDB之类的服务，而我改成静态监听之后（每次都用IP）却没有了之前的自动注册的服务，可见这就是根本原因：<code>Database Will Not Register With Listener configured on IP instead of Hostname</code></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2016/03/10/oracle/ORA-31617-unable-to-open-dump-file-for-write/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/gzh.jpg">
      <meta itemprop="name" content="巴流">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
      <meta itemprop="description" content="左手人文 | 右手科技">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 兔子先生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/03/10/oracle/ORA-31617-unable-to-open-dump-file-for-write/" class="post-title-link" itemprop="url">ORA-31617 unable to open dump file</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-03-10 16:21:00" itemprop="dateCreated datePublished" datetime="2016-03-10T16:21:00+08:00">2016-03-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-07 09:32:12" itemprop="dateModified" datetime="2025-02-07T09:32:12+08:00">2025-02-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oracle/" itemprop="url" rel="index"><span itemprop="name">oracle</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><strong>Question:</strong>  I am getting the ORA-31693 error during a data pump export in RAC:</p>
<p>ORA-31693: Table data object &quot;xxx&quot; failed to load&#x2F;unload and is being skipped due to error:<br>ORA-31617: unable to open dump file &quot;&#x2F;u01&#x2F;expdp&#x2F;dump_test.dmp&quot; for write<br>ORA-19505: failed to identify file &quot;&#x2F;u01&#x2F;expdp&#x2F;dump_test.dmp&quot;<br>ORA-27037: unable to obtain file status</p>
<p>What is the cause of the ORA-31693 error?</p>
<p><strong>Answer:</strong>  You can use the oerr utility to look-up the ORA-31693 error:</p>
<p><strong>ORA-31617:</strong> unable to open dump file &quot;xxx&quot; for write</p>
<p><strong>Cause:</strong> Export was unable to open the export file for writing. This message is usually followed by device messages from the operating system.</p>
<p><strong>Action:</strong>  Take appropriate action to restore the device.</p>
<p>The root cause of the ORA-31617 is likely in RAC is that this error occurs when parallel parameter is specified in using expdp in RAC databases  and same physical directories does not exists in all nodes.</p>
<p>This is a bug in 11g and it is fixed in 11by setting the &quot;cluster&quot; parameter cluster&#x3D;N :</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2016/02/16/oracle/DG/Oracle-DataGuard-switchover/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/gzh.jpg">
      <meta itemprop="name" content="巴流">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
      <meta itemprop="description" content="左手人文 | 右手科技">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 兔子先生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/02/16/oracle/DG/Oracle-DataGuard-switchover/" class="post-title-link" itemprop="url">Oracle DataGuard switchover切换一例</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-02-16 16:54:00" itemprop="dateCreated datePublished" datetime="2016-02-16T16:54:00+08:00">2016-02-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-07 09:32:12" itemprop="dateModified" datetime="2025-02-07T09:32:12+08:00">2025-02-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oracle/" itemprop="url" rel="index"><span itemprop="name">oracle</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><em>做DG的切换测试，发现了一些有趣的小问题，寥作记录</em><br><em>v$archived_log中的fal字段意思如下：</em><br><em>Indicates whether the archive log was generated as the result of a FAL request (YES) or not (NO)</em></p>
<ol>
<li>主库当时归档日志状态</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> DEST_ID,NAME ,SEQUENCE#,STANDBY_DEST,ARCHIVED,APPLIED,DELETED,STATUS,FAL,REGISTRAR,CREATOR <span class="keyword">from</span> v$archived_log  <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">   DEST_ID NAME                                                                              SEQUENCE# STA ARC APPLIED   DEL S FAL REGISTR CREATOR</span><br><span class="line"><span class="comment">---------- -------------------------------------------------------------------------------- ---------- --- --- --------- --- - --- ------- -------</span></span><br><span class="line">         <span class="number">2</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_74_903912515.arc                                                      <span class="number">74</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A YES RFS     ARCH</span><br><span class="line">         <span class="number">2</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_75_903912515.arc                                                      <span class="number">75</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A YES RFS     ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_76_903912515.arc                                                      <span class="number">76</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_77_903912515.arc                                                      <span class="number">77</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_78_903912515.arc                                                      <span class="number">78</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_79_903912515.arc                                                      <span class="number">79</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_80_903912515.arc                                                      <span class="number">80</span> <span class="keyword">NO</span>  YES <span class="keyword">NO</span>        <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">2</span> min                                                                                      <span class="number">80</span> YES YES YES       <span class="keyword">NO</span>  A YES ARCH    ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_81_903912515.arc                                                      <span class="number">81</span> <span class="keyword">NO</span>  YES <span class="keyword">NO</span>        <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">2</span> min                                                                                      <span class="number">81</span> YES YES YES       <span class="keyword">NO</span>  A YES ARCH    ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_82_903912515.arc                                                      <span class="number">82</span> <span class="keyword">NO</span>  YES <span class="keyword">NO</span>        <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">2</span> min                                                                                      <span class="number">82</span> YES YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  LGWR    LGWR</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_83_903912515.arc                                                      <span class="number">83</span> <span class="keyword">NO</span>  YES <span class="keyword">NO</span>        <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">2</span> min                                                                                      <span class="number">83</span> YES YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  LGWR    LGWR</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_84_903912515.arc                                                      <span class="number">84</span> <span class="keyword">NO</span>  YES <span class="keyword">NO</span>        <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">2</span> min                                                                                      <span class="number">84</span> YES YES <span class="keyword">NO</span>        <span class="keyword">NO</span>  A <span class="keyword">NO</span>  LGWR    LGWR</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>备库当时归档日志状态</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> DEST_ID,NAME ,SEQUENCE#,STANDBY_DEST,ARCHIVED,APPLIED,DELETED,STATUS,FAL,REGISTRAR,CREATOR <span class="keyword">from</span> v$archived_log  <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">   DEST_ID NAME                                                                                                  SEQUENCE# STA ARC APPLIED   DEL S FAL REGISTR CREATOR</span><br><span class="line"><span class="comment">---------- ---------------------------------------------------------------------------------------------------- ---------- --- --- --------- --- - --- ------- -------</span></span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_72_903912515.arc                                                                          <span class="number">72</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_73_903912515.arc                                                                          <span class="number">73</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_74_903912515.arc                                                                          <span class="number">74</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">2</span> minstd                                                                                                       <span class="number">74</span> YES YES YES       <span class="keyword">NO</span>  A YES ARCH    ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_75_903912515.arc                                                                          <span class="number">75</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  FGRD    FGRD</span><br><span class="line">         <span class="number">2</span> minstd                                                                                                       <span class="number">75</span> YES YES YES       <span class="keyword">NO</span>  A YES ARCH    ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_76_903912515.arc                                                                          <span class="number">76</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">2</span> minstd                                                                                                       <span class="number">76</span> YES YES YES       <span class="keyword">NO</span>  A YES ARCH    ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_77_903912515.arc                                                                          <span class="number">77</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">2</span> minstd                                                                                                       <span class="number">77</span> YES YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  LGWR    LGWR</span><br><span class="line">         <span class="number">2</span> minstd                                                                                                       <span class="number">78</span> YES YES <span class="keyword">NO</span>        <span class="keyword">NO</span>  A <span class="keyword">NO</span>  LGWR    LGWR</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_78_903912515.arc                                                                          <span class="number">78</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_79_903912515.arc                                                                          <span class="number">79</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     FGRD</span><br><span class="line">         <span class="number">2</span> minstd                                                                                                       <span class="number">79</span> YES YES <span class="keyword">NO</span>        <span class="keyword">NO</span>  A <span class="keyword">NO</span>  FGRD    FGRD</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_80_903912515.arc                                                                          <span class="number">80</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_81_903912515.arc                                                                          <span class="number">81</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_82_903912515.arc                                                                          <span class="number">82</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_83_903912515.arc                                                                          <span class="number">83</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_84_903912515.arc                                                                          <span class="number">84</span> <span class="keyword">NO</span>  YES <span class="keyword">IN</span><span class="operator">-</span>MEMORY <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     ARCH</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>此时进行切换</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">SELECT</span> SWITCHOVER_STATUS <span class="keyword">FROM</span> V$DATABASE;</span><br><span class="line"></span><br><span class="line">SWITCHOVER_STATUS</span><br><span class="line"><span class="comment">--------------------</span></span><br><span class="line"><span class="keyword">TO</span> STANDBY</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">ALTER</span> DATABASE <span class="keyword">COMMIT</span> <span class="keyword">TO</span> SWITCHOVER <span class="keyword">TO</span> PHYSICAL STANDBY;</span><br><span class="line"></span><br><span class="line">Database altered.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>主库的alert日志</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Tue Feb 16 14:55:15 2016</span><br><span class="line">ALTER DATABASE COMMIT TO SWITCHOVER TO PHYSICAL STANDBY</span><br><span class="line">ALTER DATABASE COMMIT TO SWITCHOVER TO PHYSICAL STANDBY [Process Id: 5441] (minstd)</span><br><span class="line">Waiting for all non-current ORLs to be archived...</span><br><span class="line">All non-current ORLs have been archived.</span><br><span class="line">Waiting for all FAL entries to be archived...</span><br><span class="line">All FAL entries have been archived.</span><br><span class="line">Waiting for potential Physical Standby switchover target to become synchronized...</span><br><span class="line">Active, synchronized Physical Standby switchover target has been identified</span><br><span class="line">Switchover End-Of-Redo Log thread 1 sequence 85 has been fixed</span><br><span class="line">Switchover: Primary highest seen SCN set to 0x0.0x101743</span><br><span class="line">ARCH: Noswitch archival of thread 1, sequence 85</span><br><span class="line">ARCH: End-Of-Redo Branch archival of thread 1 sequence 85</span><br><span class="line">ARCH: LGWR is actively archiving destination LOG_ARCHIVE_DEST_2</span><br><span class="line">ARCH: Standby redo logfile selected for thread 1 sequence 85 for destination LOG_ARCHIVE_DEST_2</span><br><span class="line">Archived Log entry 17 added for thread 1 sequence 85 ID 0x97bd9e7c dest 1:</span><br><span class="line">ARCH: Archiving is disabled due to current logfile archival</span><br><span class="line">Primary will check for some target standby to have received alls redo</span><br><span class="line">Final check for a synchronized target standby. Check will be made once.</span><br><span class="line">LOG_ARCHIVE_DEST_2 is a potential Physical Standby switchover target</span><br><span class="line">Active, synchronized target has been identified</span><br><span class="line">Target has also received all redo</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这时主库做了一次日志切换，加入EOR标记，并传输日志到所有备库，然后检查确认所有备库全部接受到所有的redo<br>这时查询备库</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> DEST_ID,NAME ,SEQUENCE#,STANDBY_DEST,ARCHIVED,APPLIED,DELETED,STATUS,FAL,REGISTRAR,CREATOR <span class="keyword">from</span> v$archived_log  <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">   DEST_ID NAME                                                                                                  SEQUENCE# STA ARC APPLIED   DEL S FAL REGISTR CREATOR</span><br><span class="line"><span class="comment">---------- ---------------------------------------------------------------------------------------------------- ---------- --- --- --------- --- - --- ------- -------</span></span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_72_903912515.arc                                                                          <span class="number">72</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_73_903912515.arc                                                                          <span class="number">73</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_74_903912515.arc                                                                          <span class="number">74</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">2</span> minstd                                                                                                       <span class="number">74</span> YES YES YES       <span class="keyword">NO</span>  A YES ARCH    ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_75_903912515.arc                                                                          <span class="number">75</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  FGRD    FGRD</span><br><span class="line">         <span class="number">2</span> minstd                                                                                                       <span class="number">75</span> YES YES YES       <span class="keyword">NO</span>  A YES ARCH    ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_76_903912515.arc                                                                          <span class="number">76</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">2</span> minstd                                                                                                       <span class="number">76</span> YES YES YES       <span class="keyword">NO</span>  A YES ARCH    ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_77_903912515.arc                                                                          <span class="number">77</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">2</span> minstd                                                                                                       <span class="number">77</span> YES YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  LGWR    LGWR</span><br><span class="line">         <span class="number">2</span> minstd                                                                                                       <span class="number">78</span> YES YES <span class="keyword">NO</span>        <span class="keyword">NO</span>  A <span class="keyword">NO</span>  LGWR    LGWR</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_78_903912515.arc                                                                          <span class="number">78</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_79_903912515.arc                                                                          <span class="number">79</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     FGRD</span><br><span class="line">         <span class="number">2</span> minstd                                                                                                       <span class="number">79</span> YES YES <span class="keyword">NO</span>        <span class="keyword">NO</span>  A <span class="keyword">NO</span>  FGRD    FGRD</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_80_903912515.arc                                                                          <span class="number">80</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_81_903912515.arc                                                                          <span class="number">81</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_82_903912515.arc                                                                          <span class="number">82</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_83_903912515.arc                                                                          <span class="number">83</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_84_903912515.arc                                                                          <span class="number">84</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_85_903912515.arc                                                                          <span class="number">85</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     ARCH</span><br></pre></td></tr></table></figure>

<blockquote>
<p>85号日志确实已经收到并且应用，备库alert如下</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Tue Feb 16 14:52:22 2016</span><br><span class="line">Archived Log entry 19 added for thread 1 sequence 84 ID 0x97bd9e7c dest 1:</span><br><span class="line">Media Recovery Waiting for thread 1 sequence 85 (in transit)</span><br><span class="line">Recovery of Online Redo Log: Thread 1 Group 4 Seq 85 Reading mem 0</span><br><span class="line">Mem# 0: /u01/app/oradata/min/stdb_redo01.log</span><br><span class="line">Tue Feb 16 14:55:17 2016</span><br><span class="line">RFS[5]: Assigned to RFS process 7837</span><br><span class="line">RFS[5]: Selected log 4 for thread 1 sequence 85 dbid -1749202365 branch 903912515</span><br><span class="line">Tue Feb 16 14:55:17 2016</span><br><span class="line">Archived Log entry 20 added for thread 1 sequence 85 ID 0x97bd9e7c dest 1:</span><br><span class="line">Tue Feb 16 14:55:17 2016</span><br><span class="line">RFS[2]: Possible network disconnect with primary database</span><br><span class="line">Tue Feb 16 14:55:17 2016</span><br><span class="line">RFS[6]: Assigned to RFS process 7782</span><br><span class="line">RFS[6]: Possible network disconnect with primary database</span><br><span class="line">Tue Feb 16 14:55:17 2016</span><br><span class="line">RFS[1]: Possible network disconnect with primary database</span><br><span class="line">Tue Feb 16 14:55:17 2016</span><br><span class="line">RFS[7]: Assigned to RFS process 7835</span><br><span class="line">RFS[7]: Possible network disconnect with primary database</span><br><span class="line">Tue Feb 16 14:55:17 2016</span><br><span class="line">Resetting standby activation ID 2545786492 (0x97bd9e7c)</span><br><span class="line">Media Recovery End-Of-Redo indicator encountered</span><br><span class="line">Media Recovery Continuing</span><br><span class="line">Media Recovery Waiting for thread 1 sequence 86</span><br></pre></td></tr></table></figure>

<blockquote>
<p>收到85号日志之后，与主库失去联系，在应用85号日志的时候遇到EOR标记<br>备库切换为主库</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">SELECT</span> SWITCHOVER_STATUS <span class="keyword">FROM</span> V$DATABASE;</span><br><span class="line"></span><br><span class="line">SWITCHOVER_STATUS</span><br><span class="line"><span class="comment">--------------------</span></span><br><span class="line"><span class="keyword">TO</span> <span class="keyword">PRIMARY</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">alter</span> database recover managed standby database cancel;</span><br><span class="line"></span><br><span class="line">Database altered.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">ALTER</span> DATABASE <span class="keyword">COMMIT</span> <span class="keyword">TO</span> SWITCHOVER <span class="keyword">TO</span> <span class="keyword">PRIMARY</span> <span class="keyword">WITH</span> SESSION SHUTDOWN;</span><br><span class="line"></span><br><span class="line">Database altered.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">alter</span> database <span class="keyword">open</span>;</span><br><span class="line"></span><br><span class="line">Database altered.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>新主库alert</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">ALTER DATABASE COMMIT TO SWITCHOVER TO PRIMARY WITH SESSION SHUTDOWN</span><br><span class="line">ALTER DATABASE SWITCHOVER TO PRIMARY (min)</span><br><span class="line">Maximum wait for role transition is 15 minutes.</span><br><span class="line">All dispatchers and shared servers shutdown</span><br><span class="line">CLOSE: killing server sessions.</span><br><span class="line">CLOSE: all sessions shutdown successfully.</span><br><span class="line">Tue Feb 16 15:00:29 2016</span><br><span class="line">SMON: disabling cache recovery</span><br><span class="line">Backup controlfile written to trace file /home/oracle/app/oracle/diag/rdbms/min/min/trace/min_ora_7726.trc</span><br><span class="line">SwitchOver after complete recovery through change 1054531</span><br><span class="line">Online log /u01/app/oradata/min/redo01.log: Thread 1 Group 1 was previously cleared</span><br><span class="line">Online log /u01/app/oradata/min/redo02.log: Thread 1 Group 2 was previously cleared</span><br><span class="line">Online log /u01/app/oradata/min/redo03.log: Thread 1 Group 3 was previously cleared</span><br><span class="line">Standby became primary SCN: 1054529</span><br><span class="line">AUDIT_TRAIL initialization parameter is changed back to its original value as specified in the parameter file.</span><br><span class="line">Switchover: Complete - Database mounted as primary</span><br><span class="line">Completed: ALTER DATABASE COMMIT TO SWITCHOVER TO PRIMARY WITH SESSION SHUTDOWN</span><br><span class="line">Tue Feb 16 15:00:42 2016</span><br><span class="line">alter database open</span><br><span class="line">Tue Feb 16 15:00:42 2016</span><br><span class="line">Assigning activation ID 2545831887 (0x97be4fcf)</span><br><span class="line">Thread 1 advanced to log sequence 87 (thread open)</span><br><span class="line">Tue Feb 16 15:00:42 2016</span><br><span class="line">ARC8: Becoming the &#x27;no SRL&#x27; ARCH</span><br><span class="line">Thread 1 opened at log sequence 87</span><br><span class="line">Current log# 2 seq# 87 mem# 0: /u01/app/oradata/min/redo02.log</span><br><span class="line">Successful open of redo thread 1</span><br><span class="line">MTTR advisory is disabled because FAST_START_MTTR_TARGET is not set</span><br><span class="line">Tue Feb 16 15:00:42 2016</span><br><span class="line">ARC9: Becoming the &#x27;no SRL&#x27; ARCH</span><br><span class="line">Tue Feb 16 15:00:42 2016</span><br><span class="line">ARCa: Becoming the &#x27;no SRL&#x27; ARCH</span><br><span class="line">Tue Feb 16 15:00:42 2016</span><br><span class="line">SMON: enabling cache recovery</span><br><span class="line">Archived Log entry 21 added for thread 1 sequence 86 ID 0x97be4fcf dest 1:</span><br><span class="line">Tue Feb 16 15:00:42 2016</span><br><span class="line">ARCt: Becoming the &#x27;no SRL&#x27; ARCH</span><br><span class="line">Tue Feb 16 15:00:42 2016</span><br><span class="line">NSA2 started with pid=18, OS id=7850</span><br><span class="line">[7726] Successfully onlined Undo Tablespace 2.</span><br><span class="line">Undo initialization finished serial:0 start:86759444 end:86759474 diff:30 (0 seconds)</span><br><span class="line">Dictionary check beginning</span><br><span class="line">Dictionary check complete</span><br><span class="line">Verifying file header compatibility for 11g tablespace encryption..</span><br><span class="line">Verifying 11g file header compatibility for tablespace encryption completed</span><br><span class="line">SMON: enabling tx recovery</span><br><span class="line">Database Characterset is ZHS16GBK</span><br><span class="line">Starting background process SMCO</span><br><span class="line">Tue Feb 16 15:00:42 2016</span><br><span class="line">idle dispatcher &#x27;D000&#x27; terminated, pid = (17, 1)</span><br><span class="line">ARCt: Standby redo logfile selected for thread 1 sequence 86 for destination LOG_ARCHIVE_DEST_2</span><br><span class="line">Tue Feb 16 15:00:42 2016</span><br><span class="line">SMCO started with pid=50, OS id=7852</span><br><span class="line">No Resource Manager plan active</span><br><span class="line">Starting background process QMNC</span><br><span class="line">Tue Feb 16 15:00:42 2016</span><br><span class="line">QMNC started with pid=52, OS id=7856</span><br><span class="line">LOGSTDBY: Validating controlfile with logical metadata</span><br><span class="line">LOGSTDBY: Validation complete</span><br><span class="line">Completed: alter database open</span><br><span class="line">Tue Feb 16 15:00:43 2016</span><br><span class="line">ARC0: Becoming the &#x27;no SRL&#x27; ARCH</span><br><span class="line">Tue Feb 16 15:00:43 2016</span><br><span class="line">ARC1: Becoming the &#x27;no SRL&#x27; ARCH</span><br><span class="line">ARC0: Archive log rejected (thread 1 sequence 86) at host &#x27;minstd&#x27;</span><br><span class="line">FAL[server, ARC0]: FAL archive failed, see trace file.</span><br><span class="line">ARCH: FAL archive failed. Archiver continuing</span><br><span class="line">ORACLE Instance min - Archival Error. Archiver continuing.</span><br><span class="line">Thread 1 advanced to log sequence 88 (LGWR switch)</span><br><span class="line">Current log# 3 seq# 88 mem# 0: /u01/app/oradata/min/redo03.log</span><br><span class="line">Tue Feb 16 15:00:45 2016</span><br><span class="line">ARC2: Becoming the &#x27;no SRL&#x27; ARCH</span><br><span class="line">Archived Log entry 23 added for thread 1 sequence 87 ID 0x97be4fcf dest 1:</span><br><span class="line">Tue Feb 16 15:00:45 2016</span><br><span class="line">ARC3: Becoming the &#x27;no SRL&#x27; ARCH</span><br><span class="line">ARC3: Standby redo logfile selected for thread 1 sequence 87 for destination LOG_ARCHIVE_DEST_2</span><br><span class="line">******************************************************************</span><br><span class="line">LGWR: Setting &#x27;active&#x27; archival for destination LOG_ARCHIVE_DEST_2</span><br><span class="line">******************************************************************</span><br><span class="line">LNS: Standby redo logfile selected for thread 1 sequence 88 for destination LOG_ARCHIVE_DEST_2</span><br><span class="line">Tue Feb 16 15:01:05 2016</span><br><span class="line">ARCr: Becoming the &#x27;no SRL&#x27; ARCH</span><br></pre></td></tr></table></figure>
<blockquote>
<p>新主库打开的时候向备库传输86号日志被拒绝，这里我猜测是一个gap检测的问题，至于为何报错，暂时没搞清楚，我觉得出现了FAL应该是备库检测到gap来请求日志的，但为何拒绝不甚清楚，而在新备库的日志却发现是接受成功的</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Tue Feb 16 15:00:42 2016</span><br><span class="line">Using STANDBY_ARCHIVE_DEST parameter default value as /u01/app/archive</span><br><span class="line">RFS[1]: Assigned to RFS process 5901</span><br><span class="line">RFS[1]: Selected log 4 for thread 1 sequence 86 dbid -1749202365 branch 903912515</span><br><span class="line">Tue Feb 16 15:00:42 2016</span><br><span class="line">Archived Log entry 19 added for thread 1 sequence 86 ID 0x97be4fcf dest 1:</span><br><span class="line">Tue Feb 16 15:00:45 2016</span><br><span class="line">RFS[2]: Assigned to RFS process 5905</span><br><span class="line">RFS[2]: Selected log 4 for thread 1 sequence 87 dbid -1749202365 branch 903912515</span><br><span class="line">Tue Feb 16 15:00:45 2016</span><br><span class="line">Archived Log entry 20 added for thread 1 sequence 87 ID 0x97be4fcf dest 1:</span><br><span class="line">Tue Feb 16 15:00:45 2016</span><br><span class="line">Primary database is in MAXIMUM PERFORMANCE mode</span><br><span class="line">RFS[3]: Assigned to RFS process 5907</span><br><span class="line">RFS[3]: Selected log 4 for thread 1 sequence 88 dbid -1749202365 branch 903912515</span><br><span class="line">Tue Feb 16 15:01:36 2016</span><br><span class="line">ALTER DATABASE RECOVER MANAGED STANDBY DATABASE USING CURRENT LOGFILE disconnect</span><br><span class="line">Attempt to start background Managed Standby Recovery process (minstd)</span><br><span class="line">Tue Feb 16 15:01:36 2016</span><br><span class="line">MRP0 started with pid=55, OS id=5923</span><br><span class="line">MRP0: Background Managed Standby Recovery process started (minstd)</span><br><span class="line">started logmerger process</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可见86，87已经接收到了<br>下一刻便开始正常传输了，主库日志信息如下：</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Tue Feb 16 15:00:45 2016</span><br><span class="line">ARC3: Becoming the &#x27;no SRL&#x27; ARCH</span><br><span class="line">ARC3: Standby redo logfile selected for thread 1 sequence 87 for destination LOG_ARCHIVE_DEST_2</span><br><span class="line">******************************************************************</span><br><span class="line">LGWR: Setting &#x27;active&#x27; archival for destination LOG_ARCHIVE_DEST_2</span><br><span class="line">******************************************************************</span><br><span class="line">LNS: Standby redo logfile selected for thread 1 sequence 88 for destination LOG_ARCHIVE_DEST_2</span><br><span class="line">Tue Feb 16 15:01:05 2016</span><br><span class="line">ARCr: Becoming the &#x27;no SRL&#x27; ARCH</span><br></pre></td></tr></table></figure>
<blockquote>
<p>有一个归档目的地2激活的提示，难道是一开始未激活？<br>此时再来看一下归档日志信息</p>
</blockquote>
<p><strong>新主库：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> DEST_ID,NAME ,SEQUENCE#,STANDBY_DEST,ARCHIVED,APPLIED,DELETED,STATUS,FAL,REGISTRAR,CREATOR <span class="keyword">from</span> v$archived_log  <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">   DEST_ID NAME                                                                                                  SEQUENCE# STA ARC APPLIED   DEL S FAL REGISTR CREATOR</span><br><span class="line"><span class="comment">---------- ---------------------------------------------------------------------------------------------------- ---------- --- --- --------- --- - --- ------- -------</span></span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_72_903912515.arc                                                                          <span class="number">72</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_73_903912515.arc                                                                          <span class="number">73</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">2</span> minstd                                                                                                       <span class="number">74</span> YES YES YES       <span class="keyword">NO</span>  A YES ARCH    ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_74_903912515.arc                                                                          <span class="number">74</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_75_903912515.arc                                                                          <span class="number">75</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  FGRD    FGRD</span><br><span class="line">         <span class="number">2</span> minstd                                                                                                       <span class="number">75</span> YES YES YES       <span class="keyword">NO</span>  A YES ARCH    ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_76_903912515.arc                                                                          <span class="number">76</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">2</span> minstd                                                                                                       <span class="number">76</span> YES YES YES       <span class="keyword">NO</span>  A YES ARCH    ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_77_903912515.arc                                                                          <span class="number">77</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">2</span> minstd                                                                                                       <span class="number">77</span> YES YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  LGWR    LGWR</span><br><span class="line">         <span class="number">2</span> minstd                                                                                                       <span class="number">78</span> YES YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  LGWR    LGWR</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_78_903912515.arc                                                                          <span class="number">78</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_79_903912515.arc                                                                          <span class="number">79</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     FGRD</span><br><span class="line">         <span class="number">2</span> minstd                                                                                                       <span class="number">79</span> YES YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  FGRD    FGRD</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_80_903912515.arc                                                                          <span class="number">80</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_81_903912515.arc                                                                          <span class="number">81</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_82_903912515.arc                                                                          <span class="number">82</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_83_903912515.arc                                                                          <span class="number">83</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_84_903912515.arc                                                                          <span class="number">84</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_85_903912515.arc                                                                          <span class="number">85</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_86_903912515.arc                                                                          <span class="number">86</span> <span class="keyword">NO</span>  YES <span class="keyword">NO</span>        <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">2</span> minstd                                                                                                       <span class="number">86</span> YES YES YES       <span class="keyword">NO</span>  A YES ARCH    ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_87_903912515.arc                                                                          <span class="number">87</span> <span class="keyword">NO</span>  YES <span class="keyword">NO</span>        <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">2</span> minstd                                                                                                       <span class="number">87</span> YES YES YES       <span class="keyword">NO</span>  A YES ARCH    ARCH</span><br><span class="line"></span><br><span class="line"><span class="number">24</span> <span class="keyword">rows</span> selected.</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>备库归档目的地86，97两个日志的FAL都是yes，而且在新主库查看切换期间产生的84，85两个日志的applied状态为yes，而在新备库（原主库）查询84，85在新主库（原备库）的applied状态却为NO，很有意思的一个现象</p>
</blockquote>
<p><strong>新备库:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> DEST_ID,NAME ,SEQUENCE#,STANDBY_DEST,ARCHIVED,APPLIED,DELETED,STATUS,FAL,REGISTRAR,CREATOR <span class="keyword">from</span> v$archived_log  <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">   DEST_ID NAME                                                          SEQUENCE# STA ARC APPLIED   DEL S FAL REGISTR CREATOR</span><br><span class="line"><span class="comment">---------- ------------------------------------------------------------ ---------- --- --- --------- --- - --- ------- -------</span></span><br><span class="line">         <span class="number">2</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_74_903912515.arc                                  <span class="number">74</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A YES RFS     ARCH</span><br><span class="line">         <span class="number">2</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_75_903912515.arc                                  <span class="number">75</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A YES RFS     ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_76_903912515.arc                                  <span class="number">76</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_77_903912515.arc                                  <span class="number">77</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_78_903912515.arc                                  <span class="number">78</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_79_903912515.arc                                  <span class="number">79</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_80_903912515.arc                                  <span class="number">80</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">2</span> min                                                                  <span class="number">80</span> YES YES YES       <span class="keyword">NO</span>  A YES ARCH    ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_81_903912515.arc                                  <span class="number">81</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">2</span> min                                                                  <span class="number">81</span> YES YES YES       <span class="keyword">NO</span>  A YES ARCH    ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_82_903912515.arc                                  <span class="number">82</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">2</span> min                                                                  <span class="number">82</span> YES YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  LGWR    LGWR</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_83_903912515.arc                                  <span class="number">83</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">2</span> min                                                                  <span class="number">83</span> YES YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  LGWR    LGWR</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_84_903912515.arc                                  <span class="number">84</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  ARCH    ARCH</span><br><span class="line">         <span class="number">2</span> min                                                                  <span class="number">84</span> YES YES <span class="keyword">NO</span>        <span class="keyword">NO</span>  A <span class="keyword">NO</span>  LGWR    LGWR</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_85_903912515.arc                                  <span class="number">85</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     FGRD</span><br><span class="line">         <span class="number">2</span> min                                                                  <span class="number">85</span> YES YES <span class="keyword">NO</span>        <span class="keyword">NO</span>  A <span class="keyword">NO</span>  FGRD    FGRD</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_86_903912515.arc                                  <span class="number">86</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     ARCH</span><br><span class="line">         <span class="number">1</span> <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>archive<span class="operator">/</span><span class="number">1</span>_87_903912515.arc                                  <span class="number">87</span> <span class="keyword">NO</span>  YES YES       <span class="keyword">NO</span>  A <span class="keyword">NO</span>  RFS     ARCH</span><br><span class="line"></span><br><span class="line"><span class="number">20</span> <span class="keyword">rows</span> selected.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>总结：</strong></p>
<ol>
<li>switchover前后每个主库角色都会切换1次日志（本次实验为准，并不绝对）</li>
<li>新主库产生的前2个日志是以FAL方式传输到备库</li>
<li>在原主库查询switcover之前产生的两个日志的applied状态时为NO，而在新的主库（原备库）查询日志的应用状态是为YES的</li>
</ol>
<blockquote>
<p>关于本文中提到的FAL报错的问题，希望广大DBA朋友帮助解惑，如文中还有其他错误之处，还望批评指正</p>
</blockquote>
<hr>
<blockquote>
<p>后记：在一套新的DG环境下测试切换，并未出现FAL报错的情况，怀疑是和当时备库的状态有关</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2016/01/05/oracle/perf/strace-login-slow/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/gzh.jpg">
      <meta itemprop="name" content="巴流">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
      <meta itemprop="description" content="左手人文 | 右手科技">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 兔子先生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016/01/05/oracle/perf/strace-login-slow/" class="post-title-link" itemprop="url">strace解决sqlplus登陆缓慢的问题一例</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2016-01-05 21:29:00" itemprop="dateCreated datePublished" datetime="2016-01-05T21:29:00+08:00">2016-01-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-07 09:32:12" itemprop="dateModified" datetime="2025-02-07T09:32:12+08:00">2025-02-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/strace/" itemprop="url" rel="index"><span itemprop="name">strace</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><strong>公司一台数据库测试服务器，某天开始sqlplus登陆缓慢，要卡四五秒才能登陆成功，而且是sqlplus &#x2F; as  sysdba</strong></p>
<p><strong>感觉问题排查无法下手，又不是什么大问题，库也不重要，一直没有去管</strong></p>
<p><strong>今天闲来无事，决定着手解决这个问题，排查此类问题的终极大杀器，祭出strace</strong></p>
<blockquote>
<p>[oracle@test8 ~]$ strace -T -t -o &#x2F;tmp&#x2F;nohost sqlplus &#x2F; as sysdba</p>
</blockquote>
<blockquote>
<p>查看&#x2F;tmp&#x2F;nohost内容，此处省略部分内容</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">10:05:39 open(&quot;/etc/hosts&quot;, O_RDONLY|O_CLOEXEC) = 9 &lt;0.000086&gt;</span><br><span class="line">10:05:39 fstat(9, &#123;st_mode=S_IFREG|0644, st_size=208, ...&#125;) = 0 &lt;0.000061&gt;</span><br><span class="line">10:05:39 mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fb66c9a2000 &lt;0.000063&gt;</span><br><span class="line">10:05:39 read(9, &quot;127.0.0.1 localhost localhost.&quot;..., 4096) = 208 &lt;0.000069&gt;</span><br><span class="line">10:05:39 read(9, &quot;&quot;, 4096) = 0 &lt;0.000059&gt;</span><br><span class="line">10:05:39 close(9) = 0 &lt;0.000125&gt;</span><br><span class="line">10:05:39 munmap(0x7fb66c9a2000, 4096) = 0 &lt;0.000078&gt;</span><br><span class="line">10:05:39 open(&quot;/home/app/oracle/product/11.2.0/dbhome_1/lib/libnss_dns.so.2&quot;, O_RDONLY) = -1 ENOENT (No such file or directory) &lt;0.000099&gt;</span><br><span class="line">10:05:39 open(&quot;/etc/ld.so.cache&quot;, O_RDONLY) = 9 &lt;0.000085&gt;</span><br><span class="line">10:05:39 fstat(9, &#123;st_mode=S_IFREG|0644, st_size=404774, ...&#125;) = 0 &lt;0.000059&gt;</span><br><span class="line">10:05:39 mmap(NULL, 404774, PROT_READ, MAP_PRIVATE, 9, 0) = 0x7fb66c71c000 &lt;0.000069&gt;</span><br><span class="line">10:05:39 close(9) = 0 &lt;0.000058&gt;</span><br><span class="line">10:05:39 open(&quot;/lib64/libnss_dns.so.2&quot;, O_RDONLY) = 9 &lt;0.000090&gt;</span><br><span class="line">10:05:39 read(9, &quot;\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\0\20\0\0\0\0\0\0&quot;..., 832) = 832 &lt;0.000062&gt;</span><br><span class="line">10:05:39 fstat(9, &#123;st_mode=S_IFREG|0755, st_size=27424, ...&#125;) = 0 &lt;0.000060&gt;</span><br><span class="line">10:05:39 mmap(NULL, 2117880, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 9, 0) = 0x7fb66c13b000 &lt;0.000067&gt;</span><br><span class="line">10:05:39 mprotect(0x7fb66c140000, 2093056, PROT_NONE) = 0 &lt;0.000074&gt;</span><br><span class="line">10:05:39 mmap(0x7fb66c33f000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 9, 0x4000) = 0x7fb66c33f000 &lt;0.000071&gt;</span><br><span class="line">10:05:39 close(9) = 0 &lt;0.000058&gt;</span><br><span class="line">10:05:39 open(&quot;/home/app/oracle/product/11.2.0/dbhome_1/lib/libresolv.so.2&quot;, O_RDONLY) = -1 ENOENT (No such file or directory) &lt;0.000100&gt;</span><br><span class="line">10:05:39 open(&quot;/lib64/libresolv.so.2&quot;, O_RDONLY) = 9 &lt;0.000089&gt;</span><br><span class="line">10:05:39 read(9, &quot;\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\00009\300E&gt;\0\0\0&quot;..., 832) = 832 &lt;0.000060&gt;</span><br><span class="line">10:05:39 fstat(9, &#123;st_mode=S_IFREG|0755, st_size=113952, ...&#125;) = 0 &lt;0.000060&gt;</span><br><span class="line">10:05:39 mmap(0x3e45c00000, 2202248, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 9, 0) = 0x3e45c00000 &lt;0.000066&gt;</span><br><span class="line">10:05:39 mprotect(0x3e45c16000, 2097152, PROT_NONE) = 0 &lt;0.000067&gt;</span><br><span class="line">10:05:39 mmap(0x3e45e16000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 9, 0x16000) = 0x3e45e16000 &lt;0.000077&gt;</span><br><span class="line">10:05:39 mmap(0x3e45e18000, 6792, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x3e45e18000 &lt;0.000072&gt;</span><br><span class="line">10:05:39 close(9) = 0 &lt;0.000058&gt;</span><br><span class="line">10:05:39 mprotect(0x3e45e16000, 4096, PROT_READ) = 0 &lt;0.000123&gt;</span><br><span class="line">10:05:39 mprotect(0x7fb66c33f000, 4096, PROT_READ) = 0 &lt;0.000069&gt;</span><br><span class="line">10:05:39 munmap(0x7fb66c71c000, 404774) = 0 &lt;0.000082&gt;</span><br><span class="line">10:05:39 socket(PF_INET, SOCK_DGRAM|SOCK_NONBLOCK, IPPROTO_IP) = 9 &lt;0.000094&gt;</span><br><span class="line">10:05:39 connect(9, &#123;sa_family=AF_INET, sin_port=htons(53), sin_addr=inet_addr(&quot;221.228.255.1&quot;)&#125;, 16) = 0 &lt;0.000076&gt;</span><br><span class="line">10:05:39 poll([&#123;fd=9, events=POLLOUT&#125;], 1, 0) = 1 ([&#123;fd=9, revents=POLLOUT&#125;]) &lt;0.000061&gt;</span><br><span class="line">10:05:39 sendto(9, &quot;\23\232\1\0\0\1\0\0\0\0\0\0\5test8\0\0\1\0\1&quot;, 23, MSG_NOSIGNAL, NULL, 0) = 23 &lt;0.000201&gt;</span><br><span class="line">10:05:39 poll([&#123;fd=9, events=POLLIN|POLLOUT&#125;], 1, 5000) = 1 ([&#123;fd=9, revents=POLLOUT&#125;]) &lt;0.000062&gt;</span><br><span class="line">10:05:39 sendto(9, &quot;\3d\1\0\0\1\0\0\0\0\0\0\5test8\0\0\34\0\1&quot;, 23, MSG_NOSIGNAL, NULL, 0) = 23 &lt;0.000098&gt;</span><br><span class="line">10:05:39 poll([&#123;fd=9, events=POLLIN&#125;], 1, 4998) = 1 ([&#123;fd=9, revents=POLLIN&#125;]) &lt;0.006345&gt;</span><br><span class="line">10:05:39 ioctl(9, FIONREAD, [39]) = 0 &lt;0.000063&gt;</span><br><span class="line">10:05:39 recvfrom(9, &quot;\23\232\201\200\0\1\0\1\0\0\0\0\5test8\0\0\1\0\1\300\f\0\1\0\1\0\0\0&quot;..., 2048, 0, &#123;sa_family=AF_INET, sin_port=htons(53), sin_addr=inet_addr(&quot;221.228.255.1&quot;)&#125;, [16]) = 39 &lt;0.000096&gt;</span><br><span class="line">10:05:39 poll([&#123;fd=9, events=POLLIN&#125;], 1, 4991) = 0 (Timeout) &lt;4.996143&gt;</span><br><span class="line">10:05:44 poll([&#123;fd=9, events=POLLOUT&#125;], 1, 0) = 1 ([&#123;fd=9, revents=POLLOUT&#125;]) &lt;0.000100&gt;</span><br><span class="line">10:05:44 sendto(9, &quot;\23\232\1\0\0\1\0\0\0\0\0\0\5test8\0\0\1\0\1&quot;, 23, MSG_NOSIGNAL, NULL, 0) = 23 &lt;0.000198&gt;</span><br><span class="line">10:05:44 poll([&#123;fd=9, events=POLLIN&#125;], 1, 5000) = 1 ([&#123;fd=9, revents=POLLIN&#125;]) &lt;0.006851&gt;</span><br><span class="line">10:05:44 ioctl(9, FIONREAD, [39]) = 0 &lt;0.000151&gt;</span><br><span class="line">10:05:44 recvfrom(9, &quot;\23\232\201\200\0\1\0\1\0\0\0\0\5test8\0\0\1\0\1\300\f\0\1\0\1\0\0\0&quot;..., 2048, 0, &#123;sa_family=AF_INET, sin_port=htons(53), sin_addr=inet_addr(&quot;221.228.255.1&quot;)&#125;, [16]) = 39 &lt;0.000107&gt;</span><br><span class="line">10:05:44 poll([&#123;fd=9, events=POLLOUT&#125;], 1, 4990) = 1 ([&#123;fd=9, revents=POLLOUT&#125;]) &lt;0.000088&gt;</span><br><span class="line">10:05:44 sendto(9, &quot;\3d\1\0\0\1\0\0\0\0\0\0\5test8\0\0\34\0\1&quot;, 23, MSG_NOSIGNAL, NULL, 0) = 23 &lt;0.000120&gt;</span><br><span class="line">10:05:44 poll([&#123;fd=9, events=POLLIN&#125;], 1, 4990) = 1 ([&#123;fd=9, revents=POLLIN&#125;]) &lt;0.008139&gt;</span><br><span class="line">10:05:44 ioctl(9, FIONREAD, [98]) = 0 &lt;0.000074&gt;</span><br><span class="line">10:05:44 recvfrom(9, &quot;\3d\201\203\0\1\0\0\0\1\0\0\5test8\0\0\34\0\1\0\0\6\0\1\0\0\35\17&quot;..., 2009, 0, &#123;sa_family=AF_INET, sin_port=htons(53), sin_addr=inet_addr(&quot;221.228.255.1&quot;)&#125;, [16]) = 98 &lt;0.000084&gt;</span><br><span class="line">10:05:44 close(9) = 0 &lt;0.000143&gt;</span><br><span class="line">10:05:44 open(&quot;/etc/hostid&quot;, O_RDONLY) = -1 ENOENT (No such file or directory) &lt;0.000095&gt;</span><br><span class="line">10:05:44 uname(&#123;sys=&quot;Linux&quot;, node=&quot;test8&quot;, ...&#125;) = 0 &lt;0.000061&gt;</span><br><span class="line">10:05:44 open(&quot;/etc/hosts&quot;, O_RDONLY|O_CLOEXEC) = 9 &lt;0.000114&gt;</span><br><span class="line">10:05:44 fstat(9, &#123;st_mode=S_IFREG|0644, st_size=208, ...&#125;) = 0 &lt;0.000062&gt;</span><br><span class="line">10:05:44 mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fb66c9a2000 &lt;0.000071&gt;</span><br><span class="line">10:05:44 read(9, &quot;127.0.0.1 localhost localhost.&quot;..., 4096) = 208 &lt;0.000089&gt;</span><br><span class="line">10:05:44 read(9, &quot;&quot;, 4096) = 0 &lt;0.000059&gt;</span><br><span class="line">10:05:44 close(9) = 0 &lt;0.000098&gt;</span><br><span class="line">10:05:44 munmap(0x7fb66c9a2000, 4096) = 0 &lt;0.000090&gt;</span><br><span class="line">10:05:44 socket(PF_INET, SOCK_DGRAM|SOCK_NONBLOCK, IPPROTO_IP) = 9 &lt;0.000092&gt;</span><br><span class="line">10:05:44 connect(9, &#123;sa_family=AF_INET, sin_port=htons(53), sin_addr=inet_addr(&quot;221.228.255.1&quot;)&#125;, 16) = 0 &lt;0.000072&gt;</span><br><span class="line">10:05:44 poll([&#123;fd=9, events=POLLOUT&#125;], 1, 0) = 1 ([&#123;fd=9, revents=POLLOUT&#125;]) &lt;0.000059&gt;</span><br><span class="line">10:05:44 sendto(9, &quot;\333\360\1\0\0\1\0\0\0\0\0\0\5test8\0\0\1\0\1&quot;, 23, MSG_NOSIGNAL, NULL, 0) = 23 &lt;0.000159&gt;</span><br><span class="line">10:05:44 poll([&#123;fd=9, events=POLLIN&#125;], 1, 5000) = 1 ([&#123;fd=9, revents=POLLIN&#125;]) &lt;0.008444&gt;</span><br><span class="line">10:05:44 ioctl(9, FIONREAD, [39]) = 0 &lt;0.000067&gt;</span><br><span class="line">10:05:44 recvfrom(9, &quot;\333\360\201\200\0\1\0\1\0\0\0\0\5test8\0\0\1\0\1\300\f\0\1\0\1\0\0\0&quot;..., 1024, 0, &#123;sa_family=AF_INET, sin_port=htons(53), sin_addr=inet_addr(&quot;221.228.255.1&quot;)&#125;, [16]) = 39 &lt;0.000077&gt;</span><br><span class="line">10:05:44 close(9) = 0 &lt;0.000086&gt;</span><br><span class="line">10:05:44 write(10, &quot;\2x\0\0\6\0\0\0\0\0\3s\3\0\0\0\0\0\0\0\0\0\0\0\0!\0\0\0\376\377\377&quot;..., 632) = 632 &lt;0.000124&gt;</span><br><span class="line">10:05:44 read(11, &quot;\6\331\0\0\6\0\0\0\0\0\10&amp;\0\23\0\0\0\23AUTH_VERSION_S&quot;..., 8208) = 1753 &lt;0.013111&gt;</span><br><span class="line">10:05:44 open(&quot;/home/app/oracle/product/11.2.0/dbhome_1//rdbms/mesg/oraus.msb&quot;, O_RDONLY) = 9 &lt;0.000142&gt;</span><br><span class="line">10:05:44 fcntl(9, F_SETFD, FD_CLOEXEC) = 0 &lt;0.000060&gt;</span><br><span class="line">10:05:44 lseek(9, 0, SEEK_SET) = 0 &lt;0.000062&gt;</span><br><span class="line">10:05:44 read(9, &quot;\25\23\&quot;\1\23\3\t\t\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;..., 256) = 256 &lt;0.000091&gt;</span><br><span class="line">10:05:44 lseek(9, 512, SEEK_SET) = 512 &lt;0.000060&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>其中*10:05:39 poll([{fd&#x3D;9, events&#x3D;POLLIN}], 1, 4991) &#x3D; 0 (Timeout) &lt;4.996143&gt;*是耗时最长的一步<br>而且卡在此处足足有5s，而且最终超时，根据上下文判断，此处是一个socket连接，而且还涉及到dns服务器的地址，由此推断应该和解析有关</p>
</blockquote>
<p>查看&#x2F;etc&#x2F;resolv.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@test8 etc]# cat /etc/resolv.conf</span><br><span class="line"># Generated by NetworkManager</span><br><span class="line">#nameserver 221.228.255.1</span><br><span class="line">nameserver 221.228.255.1</span><br><span class="line">nameserver 218.2.135.1</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可见配置了dns，其实我将dns注释掉之后sqlplus就恢复了正常，但dns不应该成为导致此问题的根本原因，此处明显是去dns上解析本机了,再来看&#x2F;etc&#x2F;hosts</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@test8 etc]# cat /etc/hosts</span><br><span class="line">127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1 localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.1.8 test8.com</span><br><span class="line">192.168.1.29 oem.oracle.com</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在重新查阅了hosts的正确配置之后发现我的hosts配置方法是错误的，以下为正确格式</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">格式：</span><br><span class="line">　　一般情况下hosts的内容关于主机名(hostname)的定义，每行为一个主机，每行由三部份组成，每个部份由空格隔开。其中#号开头的行做说明，不被系统解释。</span><br><span class="line">　　第一部份：网络IP地址；</span><br><span class="line">　　第二部份：主机名.域名，注意主机名和域名之间有个半角的点，比如 localhost.localdomain</span><br><span class="line">　　第二部份：主机名(主机名别名） ，其实就是主机名；</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我的主机名是test8，在我测试邮件的时候，为了骗过邮件服务器，我把hosts里解析随意加了个域名，却从未正式了解过hosts的配置方法，现在正确配置一下</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@test8 etc]# cat /etc/hosts</span><br><span class="line">127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1 localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.1.8 test8.com test8</span><br><span class="line">192.168.1.29 oem.oracle.com</span><br></pre></td></tr></table></figure>
<blockquote>
<p>再测试sqlplus，已经恢复正常</p>
</blockquote>
<blockquote>
<p>然而有些问题仍然比较困惑，正解析与反解析何时会进行？为什么会进行？为什么hosts和dns都不存在时候反而没问题，而dns存在hosts配置不正确的时候为什么会出问题？这些疑惑以我现在的能力还无法参破，就连strace的内容也只看个皮毛，期待来日解决吧！ </p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2015/12/31/oracle/DG/DataGuard-ORA-16825-ORA-16661/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/gzh.jpg">
      <meta itemprop="name" content="巴流">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
      <meta itemprop="description" content="左手人文 | 右手科技">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 兔子先生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/12/31/oracle/DG/DataGuard-ORA-16825-ORA-16661/" class="post-title-link" itemprop="url">DataGuard ORA-16825、ORA-16661解决一例</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-12-31 16:02:08" itemprop="dateCreated datePublished" datetime="2015-12-31T16:02:08+08:00">2015-12-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-07 09:32:12" itemprop="dateModified" datetime="2025-02-07T09:32:12+08:00">2025-02-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oracle/" itemprop="url" rel="index"><span itemprop="name">oracle</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>某天凌晨5点左右，被客户方运维人员电话吵醒，客户的交换机因故重启，导致做了RHCS的两台Linux服务器（非oracle服务器）因心跳问题也导致重启</p>
<p>第一时间登上去查看oracle运行情况,发现主库已是mount状态，备库已变为主库，可以肯定是因为心跳问题导致了自动切换（生产上的DG环境配置了Fast-Start Failover）</p>
<p>BROKER连上去查看状态</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">DGMGRL<span class="operator">&gt;</span> <span class="keyword">SHOW</span> CONFIGURATION VERBOSE;</span><br><span class="line">Configuration <span class="operator">-</span> jsconf</span><br><span class="line">Protection Mode: MaxAvailability</span><br><span class="line">Databases:</span><br><span class="line">jsread <span class="operator">-</span> <span class="keyword">Primary</span> database</span><br><span class="line">Error: ORA<span class="number">-16825</span>: multiple errors <span class="keyword">or</span> warnings, including fast<span class="operator">-</span><span class="keyword">start</span> failover<span class="operator">-</span>related errors <span class="keyword">or</span> warnings, detected <span class="keyword">for</span> the database</span><br><span class="line">  </span><br><span class="line">  jsrw   <span class="operator">-</span> (<span class="operator">*</span>) Physical standby database (disabled)</span><br><span class="line">      ORA<span class="number">-16661</span>: the standby database needs <span class="keyword">to</span> be reinstated</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  (<span class="operator">*</span>) Fast<span class="operator">-</span><span class="keyword">Start</span> Failover target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  Properties:</span><br><span class="line">    FastStartFailoverThreshold      <span class="operator">=</span> <span class="string">&#x27;30&#x27;</span></span><br><span class="line">    OperationTimeout                <span class="operator">=</span> <span class="string">&#x27;30&#x27;</span></span><br><span class="line">    FastStartFailoverLagLimit       <span class="operator">=</span> <span class="string">&#x27;30&#x27;</span></span><br><span class="line">    CommunicationTimeout            <span class="operator">=</span> <span class="string">&#x27;180&#x27;</span></span><br><span class="line">    ObserverReconnect               <span class="operator">=</span> <span class="string">&#x27;0&#x27;</span></span><br><span class="line">    FastStartFailoverAutoReinstate  <span class="operator">=</span> <span class="string">&#x27;TRUE&#x27;</span></span><br><span class="line">    FastStartFailoverPmyShutdown    <span class="operator">=</span> <span class="string">&#x27;TRUE&#x27;</span></span><br><span class="line">    BystandersFollowRoleChange      <span class="operator">=</span> <span class="string">&#x27;ALL&#x27;</span></span><br><span class="line">    ObserverOverride                <span class="operator">=</span> <span class="string">&#x27;FALSE&#x27;</span></span><br><span class="line">    ExternalDestination1            <span class="operator">=</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    ExternalDestination2            <span class="operator">=</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    PrimaryLostWriteAction          <span class="operator">=</span> <span class="string">&#x27;CONTINUE&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Fast<span class="operator">-</span><span class="keyword">Start</span> Failover: ENABLED</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  Threshold:          <span class="number">30</span> seconds</span><br><span class="line">  Target:             jsrw</span><br><span class="line">  Observer:           CAHW50</span><br><span class="line">  Lag Limit:          <span class="number">30</span> seconds (<span class="keyword">not</span> <span class="keyword">in</span> use)</span><br><span class="line">  Shutdown <span class="keyword">Primary</span>:   <span class="literal">TRUE</span></span><br><span class="line">  Auto<span class="operator">-</span>reinstate:     <span class="literal">TRUE</span></span><br><span class="line">  Observer Reconnect: (<span class="keyword">none</span>)</span><br><span class="line">  Observer Override:  <span class="literal">FALSE</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Configuration Status:</span><br><span class="line">ERROR</span><br></pre></td></tr></table></figure>

<p>查看主备库的状态</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">DGMGRL<span class="operator">&gt;</span> <span class="keyword">show</span> database jsrw</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Database <span class="operator">-</span> jsrw</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  Role:            PHYSICAL STANDBY</span><br><span class="line">  Intended State:  APPLY<span class="operator">-</span><span class="keyword">ON</span></span><br><span class="line">  Transport Lag:   (<span class="literal">unknown</span>)</span><br><span class="line">  Apply Lag:       (<span class="literal">unknown</span>)</span><br><span class="line">  Apply Rate:      (<span class="literal">unknown</span>)</span><br><span class="line">  <span class="type">Real</span> <span class="type">Time</span> Query: OFF</span><br><span class="line">  Instance(s):</span><br><span class="line">    jsrw</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Database Status:</span><br><span class="line">ORA<span class="number">-16661</span>: the standby database needs <span class="keyword">to</span> be reinstated</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DGMGRL<span class="operator">&gt;</span> <span class="keyword">show</span> database jsread</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Database <span class="operator">-</span> jsread</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  Role:            <span class="keyword">PRIMARY</span></span><br><span class="line">  Intended State:  TRANSPORT<span class="operator">-</span><span class="keyword">ON</span></span><br><span class="line">  Instance(s):</span><br><span class="line">    jsread</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  Database Error(s):</span><br><span class="line">    ORA<span class="number">-16820</span>: fast<span class="operator">-</span><span class="keyword">start</span> failover observer <span class="keyword">is</span> <span class="keyword">no</span> longer observing this database</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  Database Warning(s):</span><br><span class="line">    ORA<span class="number">-16817</span>: unsynchronized fast<span class="operator">-</span><span class="keyword">start</span> failover configuration</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Database Status:</span><br><span class="line">ERROR</span><br></pre></td></tr></table></figure>

<p>看样子原主库已被隔离，查看alert日志</p>
<p>原主库日志：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Tue Dec 15 04:14:45 2015</span><br><span class="line">ORA-16198: LGWR received timedout error from KSR</span><br><span class="line">LGWR: Attempting destination LOG_ARCHIVE_DEST_2 network reconnect (16198)</span><br><span class="line">LGWR: Destination LOG_ARCHIVE_DEST_2 network reconnect abandoned</span><br><span class="line">Error 16198 for archive log file 6 to &#x27;jsread&#x27;</span><br><span class="line">ORA-16198: LGWR received timedout error from KSR</span><br><span class="line">LGWR: Error 16198 disconnecting from destination LOG_ARCHIVE_DEST_2 standby host &#x27;jsread&#x27;</span><br><span class="line">Destination LOG_ARCHIVE_DEST_2 is UNSYNCHRONIZED</span><br><span class="line">Primary has heard from neither observer nor target standby within FastStartFailoverThreshold seconds.</span><br><span class="line">It is likely an automatic failover has already occurred. Primary is shutting down.</span><br><span class="line">Errors in file /orasystem_readwrite/oracle/oraWR/diag/rdbms/jsrw/jsrw/trace/jsrw_lgwr_73912.trc:</span><br><span class="line">ORA-16830: primary isolated from fast-start failover partners longer than FastStartFailoverThreshold seconds: shutting down</span><br></pre></td></tr></table></figure>

<p>日志中可以看到，主库失去了备库和observer的链接，已超时30秒，因此主库猜测此时极有可能已经发生了自动故障转移，然后将自己关掉</p>
<p>原备库日志：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">Tue Dec 15 04:14:47 2015</span><br><span class="line">RFS[44]: Assigned to RFS process 41247</span><br><span class="line">RFS[44]: Possible network disconnect with primary database</span><br><span class="line">Tue Dec 15 04:14:47 2015</span><br><span class="line">RFS[40]: Possible network disconnect with primary database</span><br><span class="line">Tue Dec 15 04:14:47 2015</span><br><span class="line">RFS[42]: Possible network disconnect with primary database</span><br><span class="line">Tue Dec 15 04:14:50 2015</span><br><span class="line">Attempting Fast-Start Failover because the threshold of 30 seconds has elapsed.</span><br><span class="line">Tue Dec 15 04:14:50 2015</span><br><span class="line">Data Guard Broker: Beginning failover</span><br><span class="line">Tue Dec 15 04:14:50 2015</span><br><span class="line">ALTER DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL</span><br><span class="line">Tue Dec 15 04:14:50 2015</span><br><span class="line">MRP0: Background Media Recovery cancelled with status 16037</span><br><span class="line">Errors in file /orasystem_readonly/oracle/oraread/diag/rdbms/jsread/jsread/trace/jsread_pr00_59244.trc:</span><br><span class="line">ORA-16037: user requested cancel of managed recovery operation</span><br><span class="line">Managed Standby Recovery not using Real Time Apply</span><br><span class="line">Tue Dec 15 04:14:50 2015</span><br><span class="line">ALTER SYSTEM SET service_names=&#x27;jsread&#x27; SCOPE=MEMORY SID=&#x27;jsread&#x27;;</span><br><span class="line">Recovery interrupted!</span><br><span class="line">Recovered data files to a consistent state at change 229593026</span><br><span class="line">Tue Dec 15 04:14:51 2015</span><br><span class="line">MRP0: Background Media Recovery process shutdown (jsread)</span><br><span class="line">Managed Standby Recovery Canceled (jsread)</span><br><span class="line">Completed: ALTER DATABASE RECOVER MANAGED STANDBY DATABASE CANCEL</span><br><span class="line">ALTER DATABASE RECOVER MANAGED STANDBY DATABASE FINISH FORCE</span><br><span class="line">Attempt to do a Terminal Recovery (jsread)</span><br><span class="line">Media Recovery Start: Managed Standby Recovery (jsread)</span><br><span class="line">started logmerger process</span><br><span class="line">Tue Dec 15 04:14:51 2015</span><br><span class="line">Managed Standby Recovery not using Real Time Apply</span><br><span class="line">Parallel Media Recovery started with 64 slaves</span><br><span class="line">Media Recovery Waiting for thread 1 sequence 3176 (in transit)</span><br><span class="line">Killing 1 processes with pids 41252 (all RFS, wait for I/O) in order to disallow current and future RFS connections. Requested by OS process 130750</span><br><span class="line">Begin: Standby Redo Logfile archival</span><br><span class="line">End: Standby Redo Logfile archival</span><br><span class="line">Terminal Recovery timestamp is &#x27;12/15/2015 04:14:57&#x27;</span><br><span class="line">Terminal Recovery: applying standby redo logs.</span><br><span class="line">Terminal Recovery: thread 1 seq# 3176 redo required</span><br><span class="line">Terminal Recovery:</span><br><span class="line">Recovery of Online Redo Log: Thread 1 Group 9 Seq 3176 Reading mem 0</span><br><span class="line">Mem# 0: /oradata_readonly/jsread/stb_redo02.log</span><br><span class="line">Identified End-Of-Redo (failover) for thread 1 sequence 3176 at SCN 0xffff.ffffffff</span><br><span class="line">Incomplete Recovery applied until change 229593027 time 12/15/2015 04:14:14</span><br><span class="line">Media Recovery Complete (jsread)</span><br><span class="line">Terminal Recovery: successful completion</span><br><span class="line">Forcing ARSCN to IRSCN for TR 0:229593027</span><br><span class="line">Tue Dec 15 04:14:57 2015</span><br><span class="line">ARCH: Archival stopped, error occurred. Will continue retrying</span><br><span class="line">Attempt to set limbo arscn 0:229593027 irscn 0:229593027</span><br><span class="line">ORACLE Instance jsread - Archival ErrorResetting standby activation ID 486853183 (0x1d04ca3f)</span><br><span class="line">ORA-16014: log 9 sequence# 3176 not archived, no available destinations</span><br><span class="line">ORA-00312: online log 9 thread 1: &#x27;/oradata_readonly/jsread/stb_redo02.log&#x27;</span><br><span class="line">Completed: ALTER DATABASE RECOVER MANAGED STANDBY DATABASE FINISH FORCE</span><br><span class="line">ALTER DATABASE COMMIT TO SWITCHOVER TO PRIMARY WAIT WITH SESSION SHUTDOWN</span><br><span class="line">ALTER DATABASE SWITCHOVER TO PRIMARY (jsread)</span><br><span class="line">Maximum wait for role transition is 15 minutes.</span><br><span class="line">All dispatchers and shared servers shutdown</span><br><span class="line">CLOSE: killing server sessions.</span><br><span class="line">Active process 117884 user &#x27;grid&#x27; program &#x27;oracle@jsc_db_r (TNS V1-V3)&#x27;</span><br><span class="line">Tue Dec 15 04:15:00 2015</span><br><span class="line">Active process 117884 user &#x27;grid&#x27; program &#x27;oracle@jsc_db_r (TNS V1-V3)&#x27;</span><br><span class="line">CLOSE: all sessions shutdown successfully.</span><br><span class="line">Tue Dec 15 04:15:01 2015</span><br><span class="line">SMON: disabling cache recovery</span><br><span class="line">Backup controlfile written to trace file /orasystem_readonly/oracle/oraread/diag/rdbms/jsread/jsread/trace/jsread_rsm0_79936.trc</span><br><span class="line">Standby terminal recovery start SCN: 229593026</span><br><span class="line">RESETLOGS after incomplete recovery UNTIL CHANGE 229593027</span><br><span class="line">Online log /oradata_readonly/jsread/redo01.log: Thread 1 Group 1 was previously cleared</span><br><span class="line">Online log /oradata_readonly/jsread/redo02.log: Thread 1 Group 2 was previously cleared</span><br><span class="line">Online log /oradata_readonly/jsread/redo03.log: Thread 1 Group 3 was previously cleared</span><br><span class="line">Online log /oradata_readonly/jsread/redo04.log: Thread 1 Group 4 was previously cleared</span><br><span class="line">Online log /oradata_readonly/jsread/redo05.log: Thread 1 Group 5 was previously cleared</span><br><span class="line">Online log /oradata_readonly/jsread/redo06.log: Thread 1 Group 6 was previously cleared</span><br><span class="line">Online log /oradata_readonly/jsread/redo07.log: Thread 1 Group 7 was previously cleared</span><br><span class="line">Online log /oradata_readonly/jsread/redo08.log: Thread 1 Group 16 was previously cleared</span><br><span class="line">Online log /oradata_readonly/jsread/redo09.log: Thread 1 Group 17 was previously cleared</span><br><span class="line">Online log /oradata_readonly/jsread/redo10.log: Thread 1 Group 18 was previously cleared</span><br><span class="line">Standby became primary SCN: 229593025</span><br><span class="line">Tue Dec 15 04:15:09 2015</span><br><span class="line">Setting recovery target incarnation to 5</span><br><span class="line">AUDIT_TRAIL initialization parameter is changed back to its original value as specified in the parameter file.</span><br><span class="line">Switchover: Complete - Database mounted as primary</span><br><span class="line">Completed: ALTER DATABASE COMMIT TO SWITCHOVER TO PRIMARY WAIT WITH SESSION SHUTDOWN</span><br><span class="line">ALTER DATABASE SET STANDBY DATABASE TO MAXIMIZE AVAILABILITY</span><br><span class="line">Completed: ALTER DATABASE SET STANDBY DATABASE TO MAXIMIZE AVAILABILITY</span><br><span class="line">ALTER DATABASE OPEN</span><br><span class="line">Data Guard Broker initializing...</span><br><span class="line">Tue Dec 15 04:15:09 2015</span><br><span class="line">Assigning activation ID 488981393 (0x1d254391)</span><br><span class="line">LGWR: Primary database is in MAXIMUM AVAILABILITY mode</span><br><span class="line">Destination LOG_ARCHIVE_DEST_2 is UNSYNCHRONIZED</span><br><span class="line">LGWR: Destination LOG_ARCHIVE_DEST_1 is not serviced by LGWR</span><br><span class="line">Thread 1 advanced to log sequence 2 (thread open)</span><br><span class="line">Tue Dec 15 04:15:09 2015</span><br><span class="line">ARC2: Becoming the &#x27;no SRL&#x27; ARCH</span><br><span class="line">Tue Dec 15 04:15:09 2015</span><br><span class="line">ARC3: Becoming the &#x27;no SRL&#x27; ARCH</span><br><span class="line">Thread 1 opened at log sequence 2</span><br><span class="line">Current log# 2 seq# 2 mem# 0: /oradata_readonly/jsread/redo02.log</span><br><span class="line">Successful open of redo thread 1</span><br><span class="line">MTTR advisory is disabled because FAST_START_MTTR_TARGET is not set</span><br><span class="line">ARC2: Becoming the &#x27;no SRL&#x27; ARCH</span><br><span class="line">SMON: enabling cache recovery</span><br><span class="line">Archived Log entry 3278 added for thread 1 sequence 1 ID 0x1d254391 dest 1:</span><br><span class="line">Archiver process freed from errors. No longer stopped</span><br><span class="line">Tue Dec 15 04:15:10 2015</span><br><span class="line">PING[ARC0]: Heartbeat failed to connect to standby &#x27;jsrw&#x27;. Error is 16058.</span><br><span class="line">[79936] Successfully onlined Undo Tablespace 2.</span><br><span class="line">Undo initialization finished serial:0 start:1846831906 end:1846832126 diff:220 (2 seconds)</span><br><span class="line">Dictionary check beginning</span><br><span class="line">PING[ARC0]: Heartbeat failed to connect to standby &#x27;jsrw&#x27;. Error is 16058.</span><br><span class="line">Dictionary check complete</span><br><span class="line">Verifying file header compatibility for 11g tablespace encryption..</span><br><span class="line">Verifying 11g file header compatibility for tablespace encryption completed</span><br><span class="line">SMON: enabling tx recovery</span><br><span class="line">Starting background process SMCO</span><br><span class="line">Database Characterset is ZHS16GBK</span><br><span class="line">Tue Dec 15 04:15:10 2015</span><br><span class="line">idle dispatcher &#x27;D000&#x27; terminated, pid = (24, 1)</span><br><span class="line">Tue Dec 15 04:15:10 2015</span><br><span class="line">SMCO started with pid=24, OS id=131236</span><br><span class="line">No Resource Manager plan active</span><br><span class="line">Tue Dec 15 04:15:11 2015</span><br><span class="line">Starting background process QMNC</span><br><span class="line">Tue Dec 15 04:15:11 2015</span><br><span class="line">QMNC started with pid=35, OS id=131244</span><br><span class="line">LOGSTDBY: Validating controlfile with logical metadata</span><br><span class="line">LOGSTDBY: Validation complete</span><br><span class="line">Completed: ALTER DATABASE OPEN</span><br></pre></td></tr></table></figure>

<p>备库确实在失去主库之后开始自动故障转移，并最终转移成功。</p>
<p>这里要说一下，按理交换机恢复之后DG检测到原主库会自动将其转换为备库，但这次显然没有，还记得有两个配置了RHCS的服务器因网络问题重启了，而客户的observer刚好部署在上面，登上去查看甚至没有找到observer的日志，为什么observer没有打日志出来的？</p>
<p>尝试开启observer，重启原主库，寄希望于observer自动将失败的主库转为备库，但是在start observer的时候就遇到了问题</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DGMGRL<span class="operator">&gt;</span> <span class="keyword">start</span> observer</span><br><span class="line">Error: ORA<span class="number">-16647</span>: could <span class="keyword">not</span> <span class="keyword">start</span> more than <span class="keyword">one</span> observer</span><br><span class="line">Failed.</span><br><span class="line">DGMGRL<span class="operator">&gt;</span> stop observer</span><br><span class="line">Error:</span><br><span class="line">ORA<span class="number">-01034</span>: ORACLE <span class="keyword">not</span> available</span><br><span class="line">Process ID: <span class="number">0</span></span><br><span class="line">Session ID: <span class="number">0</span> Serial number: <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>查看observer日志：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Observer started</span><br><span class="line">[W000 12/15 05:30:13.80] Observer started.</span><br><span class="line">Observer stopped</span><br><span class="line">Error:</span><br><span class="line">ORA-01034: ORACLE not available</span><br><span class="line">Process ID: 0</span><br><span class="line">Session ID: 0 Serial number: 0</span><br><span class="line">[W000 12/15 05:32:05.86] Failed to start the Observer.</span><br><span class="line">Error: ORA-16647: could not start more than one observer</span><br><span class="line">[W000 12/15 05:33:40.06] Failed to start the Observer.</span><br></pre></td></tr></table></figure>

<p>既无法停止，也无法启动，猜测应该是服务器重启导致的状态错乱，此时情况变 的复杂，因交换机重启导致网络不通，导致快速故障转移，推测转移工作未完全结束，observer的服务器又被重启，使得DG处在一个错误的状态下，<br>现在已无法通过observer自动恢复失败的主库，只能通过手动解决，而日志里确认新主库已转移成功，那么恢复失败的主库即可，那么如何恢复呢？有很多选择重建？利用flashback databse？或者利用broker的reinstate？<br>其实reinstate也是使用的flashback，那么干脆使用简单的reinstate吧</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DGMGRL<span class="operator">&gt;</span> reinstate database jsrw;</span><br><span class="line">Reinstating database &quot;jsrw&quot;, please wait...</span><br><span class="line">Operation requires shutdown <span class="keyword">of</span> instance &quot;jsrw&quot; <span class="keyword">on</span> database &quot;jsrw&quot;</span><br><span class="line">Shutting down instance &quot;jsrw&quot;...</span><br><span class="line">ORA<span class="number">-01109</span>: database <span class="keyword">not</span> <span class="keyword">open</span></span><br><span class="line">Database dismounted.</span><br><span class="line">ORACLE instance shut down.</span><br><span class="line">Operation requires startup <span class="keyword">of</span> instance &quot;jsrw&quot; <span class="keyword">on</span> database &quot;jsrw&quot;</span><br><span class="line">Starting instance &quot;jsrw&quot;...</span><br><span class="line">ORACLE instance started.</span><br><span class="line">Database mounted.</span><br><span class="line">Continuing <span class="keyword">to</span> reinstate database &quot;jsrw&quot; ...</span><br><span class="line">Reinstatement <span class="keyword">of</span> database &quot;jsrw&quot; succeeded</span><br></pre></td></tr></table></figure>

<p>查看状态</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">DGMGRL<span class="operator">&gt;</span> <span class="keyword">show</span> configuration verbose;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Configuration <span class="operator">-</span> jsconf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  Protection Mode: MaxAvailability</span><br><span class="line">  Databases:</span><br><span class="line">    jsread <span class="operator">-</span> <span class="keyword">Primary</span> database</span><br><span class="line">      Error: ORA<span class="number">-16820</span>: fast<span class="operator">-</span><span class="keyword">start</span> failover observer <span class="keyword">is</span> <span class="keyword">no</span> longer observing this database</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    jsrw   <span class="operator">-</span> (<span class="operator">*</span>) Physical standby database</span><br><span class="line">      Error: ORA<span class="number">-16820</span>: fast<span class="operator">-</span><span class="keyword">start</span> failover observer <span class="keyword">is</span> <span class="keyword">no</span> longer observing this database</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  (<span class="operator">*</span>) Fast<span class="operator">-</span><span class="keyword">Start</span> Failover target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  Properties:</span><br><span class="line">    FastStartFailoverThreshold      <span class="operator">=</span> <span class="string">&#x27;30&#x27;</span></span><br><span class="line">    OperationTimeout                <span class="operator">=</span> <span class="string">&#x27;30&#x27;</span></span><br><span class="line">    FastStartFailoverLagLimit       <span class="operator">=</span> <span class="string">&#x27;30&#x27;</span></span><br><span class="line">    CommunicationTimeout            <span class="operator">=</span> <span class="string">&#x27;180&#x27;</span></span><br><span class="line">    ObserverReconnect               <span class="operator">=</span> <span class="string">&#x27;0&#x27;</span></span><br><span class="line">    FastStartFailoverAutoReinstate  <span class="operator">=</span> <span class="string">&#x27;TRUE&#x27;</span></span><br><span class="line">    FastStartFailoverPmyShutdown    <span class="operator">=</span> <span class="string">&#x27;TRUE&#x27;</span></span><br><span class="line">    BystandersFollowRoleChange      <span class="operator">=</span> <span class="string">&#x27;ALL&#x27;</span></span><br><span class="line">    ObserverOverride                <span class="operator">=</span> <span class="string">&#x27;FALSE&#x27;</span></span><br><span class="line">    ExternalDestination1            <span class="operator">=</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    ExternalDestination2            <span class="operator">=</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    PrimaryLostWriteAction          <span class="operator">=</span> <span class="string">&#x27;CONTINUE&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Fast<span class="operator">-</span><span class="keyword">Start</span> Failover: ENABLED</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  Threshold:          <span class="number">30</span> seconds</span><br><span class="line">  Target:             jsrw</span><br><span class="line">  Observer:           CAHW50</span><br><span class="line">  Lag Limit:          <span class="number">30</span> seconds (<span class="keyword">not</span> <span class="keyword">in</span> use)</span><br><span class="line">  Shutdown <span class="keyword">Primary</span>:   <span class="literal">TRUE</span></span><br><span class="line">  Auto<span class="operator">-</span>reinstate:     <span class="literal">TRUE</span></span><br><span class="line">  Observer Reconnect: (<span class="keyword">none</span>)</span><br><span class="line">  Observer Override:  <span class="literal">FALSE</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Configuration Status:</span><br><span class="line">ERROR</span><br></pre></td></tr></table></figure>

<p>可见已经恢复成功，此时stop observer，start observer就没有问题了，但为了保险起见，停止了observer</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DGMGRL<span class="operator">&gt;</span> stop observer;</span><br><span class="line">Done.</span><br><span class="line">DGMGRL<span class="operator">&gt;</span> <span class="keyword">start</span> observer;</span><br><span class="line">Observer started</span><br></pre></td></tr></table></figure>

<p>这次显然是交换机导致的乌龙failover，根本不需要failover的，本来的高可用措施反而带来了些许麻烦，后来找机会又切换回原来的主库了，自动故障转移也一直没有再启动，届时手动faiover更为灵活，因为客户的应用并不够灵活.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2015/09/30/oracle/architecture/ASSM2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/gzh.jpg">
      <meta itemprop="name" content="巴流">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
      <meta itemprop="description" content="左手人文 | 右手科技">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 兔子先生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/09/30/oracle/architecture/ASSM2/" class="post-title-link" itemprop="url">ASSM三级位图结构与高水位的探究（下）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-09-30 14:31:00" itemprop="dateCreated datePublished" datetime="2015-09-30T14:31:00+08:00">2015-09-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-07 09:32:12" itemprop="dateModified" datetime="2025-02-07T09:32:12+08:00">2025-02-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oracle/" itemprop="url" rel="index"><span itemprop="name">oracle</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>上一篇文章介绍了ASSM三级位图管理下的数据插入和高水位推进的关系，我们得出的结论是随着数据不断的插入，段大小的不断增长，L1中挂载的数据块的数量也会增长，而高水位是以L1中数据块大小的总和与区大小之间最小的一方为单位进行推进，而且我们知道要想应对大并发插入，就要使高水位之下的空闲块的数量尽可能多，但是如此一来就有可能造成空间的浪费，而oracle的初心也是本着节省空间的目的来设计的。<br>之前我们用的是常规路径插入，能以L1和区的单位推动高水位，前提是要填满L1或区，而我们熟知的直接路径插入是在高水位之上插入，那是不是可以用直接路径插入快速增加高水位呢？我们来一探究竟。</p>
<blockquote>
<p>首先构造测试的表空间和表，跟上一篇一样</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">drop</span> tablespace lp including contents <span class="keyword">and</span> datafiles;</span><br><span class="line"></span><br><span class="line">Tablespace dropped.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span>space lp datafile <span class="string">&#x27;/home/oracle/app/oracle/oradata/DG43/lp.dbf&#x27;</span> size <span class="number">2048</span>M uniform size <span class="number">1</span>m;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> lp (id number,des1 <span class="type">char</span>(<span class="number">2000</span>),des2 <span class="type">char</span>(<span class="number">2000</span>),des3 <span class="type">char</span>(<span class="number">2000</span>),des4 <span class="type">char</span>(<span class="number">500</span>)) tablespace lp;</span><br><span class="line"></span><br><span class="line">Tablespace created.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">Table</span> created.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> lp pctfree <span class="number">24</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Table</span> altered.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> object_id,object_name <span class="keyword">from</span> dba_objects  <span class="keyword">where</span> object_name<span class="operator">=</span><span class="string">&#x27;LP&#x27;</span>;</span><br><span class="line"></span><br><span class="line"> OBJECT_ID OBJECT_NAME</span><br><span class="line"><span class="comment">---------- ------------------------------</span></span><br><span class="line">     <span class="number">78760</span> LP</span><br></pre></td></tr></table></figure>

<blockquote>
<p>首先看一下，78760这个对象在buffer里的数据块有哪些</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> file#,BLOCK#,DIRTY,OBJD <span class="keyword">from</span> v$bh <span class="keyword">where</span> objd<span class="operator">=</span><span class="string">&#x27;78760&#x27;</span>;</span><br><span class="line"></span><br><span class="line">     FILE#     BLOCK# D       OBJD</span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">131</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">129</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">130</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">128</span> N      <span class="number">78760</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>有没有眼熟呢，128、129、130、131四个块刚好是两个L1、L2、L3<br>我们定位段头块，看一下此时的高水位</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> segment_name ,HEADER_FILE,HEADER_BLOCK <span class="keyword">from</span> dba_segments <span class="keyword">where</span> segment_name<span class="operator">=</span><span class="string">&#x27;LP&#x27;</span>;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME                   HEADER_FILE HEADER_BLOCK</span><br><span class="line"><span class="comment">------------------------------ ----------- ------------</span></span><br><span class="line">LP                                       <span class="number">5</span>          <span class="number">131</span></span><br><span class="line"></span><br><span class="line">Extent Control Header</span><br><span class="line">  <span class="comment">-----------------------------------------------------------------</span></span><br><span class="line">  Extent Header:: spare1: <span class="number">0</span>      spare2: <span class="number">0</span>      #extents: <span class="number">1</span>      #blocks: <span class="number">128</span>   </span><br><span class="line">                  <span class="keyword">last</span> map  <span class="number">0x00000000</span>  #maps: <span class="number">0</span>      <span class="keyword">offset</span>: <span class="number">2716</span>  </span><br><span class="line">      Highwater::  <span class="number">0x01400084</span>  ext#: <span class="number">0</span>      blk#: <span class="number">4</span>      ext size: <span class="number">128</span>   </span><br><span class="line">  #blocks <span class="keyword">in</span> seg. hdr<span class="string">&#x27;s freelists: 0     </span></span><br><span class="line"><span class="string">  #blocks below: 0     </span></span><br><span class="line"><span class="string">  mapblk  0x00000000  offset: 0     </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">SQL&gt; select dbms_utility.data_block_address_file(to_number(&#x27;</span><span class="number">01400084</span><span class="string">&#x27;, &#x27;</span>xxxxxxxx<span class="string">&#x27;)) file#,</span></span><br><span class="line"><span class="string">  2                      dbms_utility.data_block_address_block(to_number(&#x27;</span><span class="number">01400084</span><span class="string">&#x27;, &#x27;</span>xxxxxxxx<span class="string">&#x27;)) block#</span></span><br><span class="line"><span class="string">  3  from dual;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     FILE#     BLOCK#</span></span><br><span class="line"><span class="string">---------- ----------</span></span><br><span class="line"><span class="string">         5        132</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以看出在没有任何数据的情况下，高水位是在第一个数据块上的，下面常规插入一行数据</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> lp <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>看一下高水位和buffer中的块</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> file#,BLOCK#,DIRTY,OBJD <span class="keyword">from</span> v$bh <span class="keyword">where</span> objd<span class="operator">=</span><span class="string">&#x27;78760&#x27;</span>;</span><br><span class="line"></span><br><span class="line">     FILE#     BLOCK# D       OBJD</span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">165</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">131</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">173</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">160</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">168</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">163</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">129</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">171</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">166</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">174</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">161</span> Y      <span class="number">78760</span></span><br><span class="line"></span><br><span class="line">     FILE#     BLOCK# D       OBJD</span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">169</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">164</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">130</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">172</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">167</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">175</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">162</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">128</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">170</span> Y      <span class="number">78760</span></span><br><span class="line"></span><br><span class="line"><span class="number">20</span> <span class="keyword">rows</span> selected.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) <span class="keyword">from</span> lp;</span><br><span class="line"></span><br><span class="line">DBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)</span><br><span class="line"><span class="comment">------------------------------------ ------------------------------------</span></span><br><span class="line">                                   <span class="number">5</span>                                  <span class="number">160</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Extent Control Header</span><br><span class="line">-----------------------------------------------------------------</span><br><span class="line">Extent Header:: spare1: 0 spare2: 0 #extents: 1 #blocks: 128</span><br><span class="line">last map 0x00000000 #maps: 0 offset: 2716</span><br><span class="line">Highwater:: 0x014000c0 ext#: 0 blk#: 64 ext size: 128</span><br><span class="line">#blocks in seg. hdr&#x27;s freelists: 0</span><br><span class="line">#blocks below: 60</span><br><span class="line">mapblk 0x00000000 offset: 0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>发现数据插入到160号块中，buffer中却多了16个块，高水位已移动到第二个L1中的第一个块上，看一下第一个L1</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">HWM Flag: HWM Set</span><br><span class="line">      Highwater::  0x014000c0  ext#: 0      blk#: 64     ext size: 128   </span><br><span class="line">  #blocks in seg. hdr&#x27;s freelists: 0     </span><br><span class="line">  #blocks below: 60    </span><br><span class="line">  mapblk  0x00000000  offset: 0     </span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">  DBA Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x01400080  Length: 64     Offset: 0      </span><br><span class="line"></span><br><span class="line">   0:Metadata   1:Metadata   2:Metadata   3:Metadata</span><br><span class="line">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class="line">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class="line">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class="line">   16:unformatted   17:unformatted   18:unformatted   19:unformatted</span><br><span class="line">   20:unformatted   21:unformatted   22:unformatted   23:unformatted</span><br><span class="line">   24:unformatted   25:unformatted   26:unformatted   27:unformatted</span><br><span class="line">   28:unformatted   29:unformatted   30:unformatted   31:unformatted</span><br><span class="line">   32:FULL   33:75-100% free   34:75-100% free   35:75-100% free</span><br><span class="line">   36:75-100% free   37:75-100% free   38:75-100% free   39:75-100% free</span><br><span class="line">   40:75-100% free   41:75-100% free   42:75-100% free   43:75-100% free</span><br><span class="line">   44:75-100% free   45:75-100% free   46:75-100% free   47:75-100% free</span><br><span class="line">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class="line">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class="line">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class="line">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> dbms_utility.data_block_address_file(to_number(<span class="string">&#x27;014000c0&#x27;</span>, <span class="string">&#x27;xxxxxxxx&#x27;</span>)) file#,</span><br><span class="line">  <span class="number">2</span>                      dbms_utility.data_block_address_block(to_number(<span class="string">&#x27;014000c0&#x27;</span>, <span class="string">&#x27;xxxxxxxx&#x27;</span>)) block#</span><br><span class="line">  <span class="number">3</span>  <span class="keyword">from</span> dual;</span><br><span class="line"></span><br><span class="line">     FILE#     BLOCK#</span><br><span class="line"><span class="comment">---------- ----------</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">192</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以发现，buffer中新增的16个块是一次性格式化的这16个块，而高水位指在192号块上，直接路径插入一行</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> file#,BLOCK#,DIRTY,OBJD <span class="keyword">from</span> v$bh <span class="keyword">where</span> objd<span class="operator">=</span><span class="string">&#x27;78760&#x27;</span>;</span><br><span class="line"></span><br><span class="line">     FILE#     BLOCK# D       OBJD</span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">165</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">131</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">173</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">160</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">168</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">163</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">129</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">171</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">166</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">174</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">161</span> N      <span class="number">78760</span></span><br><span class="line"></span><br><span class="line">     FILE#     BLOCK# D       OBJD</span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">169</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">164</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">130</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">172</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">167</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">175</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">162</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">128</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">170</span> N      <span class="number">78760</span></span><br><span class="line"></span><br><span class="line"><span class="number">20</span> <span class="keyword">rows</span> selected.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="comment">/*+ append_values(lp)*/</span> <span class="keyword">into</span> lp <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;b&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> created.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Commit</span> complete.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) <span class="keyword">from</span> lp;</span><br><span class="line"></span><br><span class="line">DBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)</span><br><span class="line"><span class="comment">------------------------------------ ------------------------------------</span></span><br><span class="line">                                   <span class="number">5</span>                                  <span class="number">160</span></span><br><span class="line">                                   <span class="number">5</span>                                  <span class="number">192</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> file#,BLOCK#,DIRTY,OBJD <span class="keyword">from</span> v$bh <span class="keyword">where</span> objd<span class="operator">=</span><span class="string">&#x27;78760&#x27;</span>;</span><br><span class="line"></span><br><span class="line">     FILE#     BLOCK# D       OBJD</span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">165</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">131</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">173</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">160</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">168</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">163</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">129</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">171</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">192</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">166</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">174</span> N      <span class="number">78760</span></span><br><span class="line"></span><br><span class="line">     FILE#     BLOCK# D       OBJD</span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">161</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">169</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">164</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">130</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">172</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">167</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">175</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">162</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">128</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">170</span> N      <span class="number">78760</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span> <span class="keyword">rows</span> selected.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">system</span> checkpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">System</span> altered.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以发现确实插入到了192号块，并且192号块已在buffer中，看一下此时的高水位</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Extent Control Header</span><br><span class="line">  -----------------------------------------------------------------</span><br><span class="line">  Extent Header:: spare1: 0      spare2: 0      #extents: 1      #blocks: 128   </span><br><span class="line">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class="line">      Highwater::  0x014000c1  ext#: 0      blk#: 65     ext size: 128   </span><br><span class="line">  #blocks in seg. hdr&#x27;s freelists: 0     </span><br><span class="line">  #blocks below: 65    </span><br><span class="line">  mapblk  0x00000000  offset: 0  </span><br><span class="line"></span><br><span class="line">HWM Flag: HWM Set</span><br><span class="line">      Highwater::  0x014000c1  ext#: 0      blk#: 65     ext size: 128   </span><br><span class="line">  #blocks in seg. hdr&#x27;s freelists: 0     </span><br><span class="line">  #blocks below: 65    </span><br><span class="line">  mapblk  0x00000000  offset: 0     </span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">  DBA Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x014000c0  Length: 64     Offset: 0      </span><br><span class="line"></span><br><span class="line">   0:FULL   1:unformatted   2:unformatted   3:unformatted</span><br><span class="line">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class="line">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class="line">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class="line">   16:unformatted   17:unformatted   18:unformatted   19:unformatted</span><br><span class="line">   20:unformatted   21:unformatted   22:unformatted   23:unformatted</span><br><span class="line">   24:unformatted   25:unformatted   26:unformatted   27:unformatted</span><br><span class="line">   28:unformatted   29:unformatted   30:unformatted   31:unformatted</span><br><span class="line">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class="line">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class="line">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class="line">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class="line">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class="line">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class="line">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class="line">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">End dump data blocks tsn: 5 file#: 5 minblk 129 maxblk 129</span><br></pre></td></tr></table></figure>

<blockquote>
<p>发现高水位仅仅移动了1个block，再试一遍</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="comment">/*+ append_values(lp)*/</span> <span class="keyword">into</span> lp <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;c&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> created.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Commit</span> complete.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) <span class="keyword">from</span> lp;</span><br><span class="line"></span><br><span class="line">DBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)</span><br><span class="line"><span class="comment">------------------------------------ ------------------------------------</span></span><br><span class="line">                                   <span class="number">5</span>                                  <span class="number">160</span></span><br><span class="line">                                   <span class="number">5</span>                                  <span class="number">192</span></span><br><span class="line">                                   <span class="number">5</span>                                  <span class="number">193</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> file#,BLOCK#,DIRTY,OBJD <span class="keyword">from</span> v$bh <span class="keyword">where</span> objd<span class="operator">=</span><span class="string">&#x27;78760&#x27;</span>;</span><br><span class="line"></span><br><span class="line">     FILE#     BLOCK# D       OBJD</span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">165</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">131</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">173</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">160</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">168</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">163</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">129</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">171</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">192</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">166</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">174</span> N      <span class="number">78760</span></span><br><span class="line"></span><br><span class="line">     FILE#     BLOCK# D       OBJD</span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">161</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">169</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">164</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">130</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">172</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">193</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">167</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">175</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">162</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">128</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">170</span> N      <span class="number">78760</span></span><br><span class="line"></span><br><span class="line"><span class="number">22</span> <span class="keyword">rows</span> selected.</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Extent Header:: spare1: 0      spare2: 0      #extents: 1      #blocks: 128   </span><br><span class="line">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class="line">      Highwater::  0x014000c2  ext#: 0      blk#: 66     ext size: 128   </span><br><span class="line">  #blocks in seg. hdr&#x27;s freelists: 0     </span><br><span class="line">  #blocks below: 66    </span><br><span class="line">  mapblk  0x00000000  offset: 0     </span><br></pre></td></tr></table></figure>

<blockquote>
<p>仍然是只推动了一个block，但是发现为何每次直接路径插入的block都会出现在buffer里呢？难道是11g这个append_values新的hint的原因，再来试一下传统的append</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="comment">/*+ append*/</span> <span class="keyword">into</span> lp <span class="keyword">select</span> <span class="operator">*</span>  <span class="keyword">from</span> lp <span class="keyword">where</span> <span class="built_in">trim</span>(des1)<span class="operator">=</span><span class="string">&#x27;a&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> created.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Commit</span> complete.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) <span class="keyword">from</span> lp;</span><br><span class="line"></span><br><span class="line">DBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)</span><br><span class="line"><span class="comment">------------------------------------ ------------------------------------</span></span><br><span class="line">                                   <span class="number">5</span>                                  <span class="number">160</span></span><br><span class="line">                                   <span class="number">5</span>                                  <span class="number">192</span></span><br><span class="line">                                   <span class="number">5</span>                                  <span class="number">193</span></span><br><span class="line">                                   <span class="number">5</span>                                  <span class="number">194</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> file#,BLOCK#,DIRTY,OBJD <span class="keyword">from</span> v$bh <span class="keyword">where</span> objd<span class="operator">=</span><span class="string">&#x27;78760&#x27;</span>;</span><br><span class="line"></span><br><span class="line">     FILE#     BLOCK# D       OBJD</span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">165</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">131</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">173</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">194</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">160</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">168</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">163</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">129</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">171</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">192</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">166</span> N      <span class="number">78760</span></span><br><span class="line"></span><br><span class="line">     FILE#     BLOCK# D       OBJD</span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">174</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">161</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">169</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">164</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">130</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">172</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">193</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">167</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">175</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">162</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">128</span> N      <span class="number">78760</span></span><br><span class="line"></span><br><span class="line">     FILE#     BLOCK# D       OBJD</span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">170</span> N      <span class="number">78760</span></span><br><span class="line"></span><br><span class="line"><span class="number">23</span> <span class="keyword">rows</span> selected.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">system</span> checkpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">System</span> altered.</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Extent Control Header</span><br><span class="line">-----------------------------------------------------------------</span><br><span class="line">Extent Header:: spare1: 0      spare2: 0      #extents: 1      #blocks: 128   </span><br><span class="line">                last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class="line">    Highwater::  0x014000c3  ext#: 0      blk#: 67     ext size: 128   </span><br><span class="line">#blocks in seg. hdr&#x27;s freelists: 0     </span><br><span class="line">#blocks below: 67    </span><br><span class="line">mapblk  0x00000000  offset: 0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>依然如故，不知道大家有没有发现，每次我执行完插入，都会执行一条select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp;<br>这其实是全表扫描，本来块没在buffer里，一个FTS把块全给整进来了（小表buffer读，大表在11g中通常情况是直接路径读），知道原因了，再试一遍</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="comment">/*+ append*/</span> <span class="keyword">into</span> lp <span class="keyword">select</span> <span class="operator">*</span>  <span class="keyword">from</span> lp <span class="keyword">where</span> <span class="built_in">trim</span>(des1)<span class="operator">=</span><span class="string">&#x27;b&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> created.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Commit</span> complete.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> file#,BLOCK#,DIRTY,OBJD <span class="keyword">from</span> v$bh <span class="keyword">where</span> objd<span class="operator">=</span><span class="string">&#x27;78760&#x27;</span>;</span><br><span class="line"></span><br><span class="line">     FILE#     BLOCK# D       OBJD</span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">165</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">131</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">173</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">194</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">160</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">168</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">163</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">129</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">171</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">192</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">166</span> N      <span class="number">78760</span></span><br><span class="line"></span><br><span class="line">     FILE#     BLOCK# D       OBJD</span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">174</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">161</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">169</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">164</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">130</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">172</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">193</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">167</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">175</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">162</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">128</span> N      <span class="number">78760</span></span><br><span class="line"></span><br><span class="line">     FILE#     BLOCK# D       OBJD</span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">170</span> N      <span class="number">78760</span></span><br><span class="line"></span><br><span class="line"><span class="number">23</span> <span class="keyword">rows</span> selected.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) <span class="keyword">from</span> lp;</span><br><span class="line"></span><br><span class="line">DBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)</span><br><span class="line"><span class="comment">------------------------------------ ------------------------------------</span></span><br><span class="line">                                   <span class="number">5</span>                                  <span class="number">160</span></span><br><span class="line">                                   <span class="number">5</span>                                  <span class="number">192</span></span><br><span class="line">                                   <span class="number">5</span>                                  <span class="number">193</span></span><br><span class="line">                                   <span class="number">5</span>                                  <span class="number">194</span></span><br><span class="line">                                   <span class="number">5</span>                                  <span class="number">195</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> file#,BLOCK#,DIRTY,OBJD <span class="keyword">from</span> v$bh <span class="keyword">where</span> objd<span class="operator">=</span><span class="string">&#x27;78760&#x27;</span>;</span><br><span class="line"></span><br><span class="line">     FILE#     BLOCK# D       OBJD</span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">165</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">131</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">173</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">194</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">160</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">168</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">163</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">129</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">171</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">192</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">166</span> N      <span class="number">78760</span></span><br><span class="line"></span><br><span class="line">     FILE#     BLOCK# D       OBJD</span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">174</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">195</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">161</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">169</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">164</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">130</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">172</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">193</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">167</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">175</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">162</span> N      <span class="number">78760</span></span><br><span class="line"></span><br><span class="line">     FILE#     BLOCK# D       OBJD</span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">128</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">170</span> N      <span class="number">78760</span></span><br><span class="line"></span><br><span class="line"><span class="number">24</span> <span class="keyword">rows</span> selected.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>终于看到了想要的结果，总结一下吧，直接路径下高水位的推进大概如下图的样子：</p>
</blockquote>
<p><img data-src="http://qiniu.liupzmin.com/direct.png"></p>
<blockquote>
<p>不知道大家有没有注意到，直接路径插入完后再读入buffer中居然是个脏块，这是不是跟延迟提交清除有关呢？我们以后再慢慢分析！</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2015/09/25/oracle/architecture/ASSM1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/gzh.jpg">
      <meta itemprop="name" content="巴流">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
      <meta itemprop="description" content="左手人文 | 右手科技">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 兔子先生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/09/25/oracle/architecture/ASSM1/" class="post-title-link" itemprop="url">ASSM三级位图结构与高水位的探究（上）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-09-25 14:51:00" itemprop="dateCreated datePublished" datetime="2015-09-25T14:51:00+08:00">2015-09-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-07 09:32:12" itemprop="dateModified" datetime="2025-02-07T09:32:12+08:00">2025-02-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oracle/" itemprop="url" rel="index"><span itemprop="name">oracle</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>#ASSM三级位图结构与高水位的探究</p>
<blockquote>
<p>三级位图</p>
</blockquote>
<p>Oracle9i在本地表空管理(LMT)的基础上，对段空间管理也引入了位图管理（Segment Space Management Auto）来取代原来的freelist管理方式（Segment Space Management Manual）。<br>但是默认system和undo表空间仍然是MSSM的管理方式，本文主要探究ASSM管理方式下，段的三级位图结构和高水位推进的关系 先来看<br>ASSM管理方式下的三级位图结构图：</p>
<p><img data-src="http://qiniu.liupzmin.com/%E4%B8%89%E7%BA%A7%E4%BD%8D%E5%9B%BE.jpg"><br><em>注：此图来源于网络</em><br>一个段被创建之后，段头其实是一个L3块，在我的试验中，一个1M固定区大小，block为8K的表空间，创建的第一个段第0个区，前两个块是L1（128,129号块），第三个是L2（130号块），第四个是L3（131号块），前128个块是数据文件头，本文不讨论。<br>当数据被插入的时候，oracle根据连接进来的session，做hash运算，随机选择一个L3（如果有多个的话），再随机选择一个L2，接下来在该L2下随机选择一个L1，再从L1中管理的block里面随机选择一个块将数据插入，不同的session经过hash之后，最后落到block时已经是很分散的了，不会产生很多和会话同时往一个block中插数据申请独占buffer pin，而造成大量buffer busy waits的情况，这就是ASSM号称支持大并发插入的原理所在，但是事实上真的如此么？我们来一探究竟！</p>
<blockquote>
<p>实验环境</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OS:REDHAT6.5 X64</span><br><span class="line">DB VERSION:11.2.0.4</span><br></pre></td></tr></table></figure>
<blockquote>
<p>首先，创建一个1M区大小的表空间，并在上面创建一张表，此表创建了4个空间很大的字段，目的是要一行占满一个block，便于观察结果</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> file#,NAME,BYTES<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1204</span> <span class="keyword">from</span> v$datafile;</span><br><span class="line"></span><br><span class="line">     FILE# NAME                                                                             BYTES<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1204</span></span><br><span class="line"><span class="comment">---------- -------------------------------------------------------------------------------- ---------------</span></span><br><span class="line">         <span class="number">1</span> <span class="operator">+</span>DATA<span class="operator">/</span>min<span class="operator">/</span>datafile<span class="operator">/</span><span class="keyword">system</span><span class="number">.256</span><span class="number">.854775095</span>                                               <span class="number">637.873754</span></span><br><span class="line">         <span class="number">2</span> <span class="operator">+</span>DATA<span class="operator">/</span>min<span class="operator">/</span>datafile<span class="operator">/</span>sysaux<span class="number">.257</span><span class="number">.854775097</span>                                               <span class="number">484.784053</span></span><br><span class="line">         <span class="number">3</span> <span class="operator">+</span>DATA<span class="operator">/</span>min<span class="operator">/</span>datafile<span class="operator">/</span>undotbs1<span class="number">.258</span><span class="number">.854775097</span>                                             <span class="number">187.109635</span></span><br><span class="line">         <span class="number">4</span> <span class="operator">+</span>DATA<span class="operator">/</span>min<span class="operator">/</span>datafile<span class="operator">/</span>users<span class="number">.259</span><span class="number">.854775097</span>                                                <span class="number">103.122924</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span>space lp datafile <span class="string">&#x27;+DATA/min/datafile/lp.dbf&#x27;</span> size <span class="number">2048</span>M uniform size <span class="number">1</span>m;</span><br><span class="line"></span><br><span class="line">Tablespace created.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> file#,NAME,BYTES<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1204</span> <span class="keyword">from</span> v$datafile;</span><br><span class="line"></span><br><span class="line">     FILE# NAME                                                                             BYTES<span class="operator">/</span><span class="number">1024</span><span class="operator">/</span><span class="number">1204</span></span><br><span class="line"><span class="comment">---------- -------------------------------------------------------------------------------- ---------------</span></span><br><span class="line">         <span class="number">1</span> <span class="operator">+</span>DATA<span class="operator">/</span>min<span class="operator">/</span>datafile<span class="operator">/</span><span class="keyword">system</span><span class="number">.256</span><span class="number">.854775095</span>                                               <span class="number">637.873754</span></span><br><span class="line">         <span class="number">2</span> <span class="operator">+</span>DATA<span class="operator">/</span>min<span class="operator">/</span>datafile<span class="operator">/</span>sysaux<span class="number">.257</span><span class="number">.854775097</span>                                               <span class="number">484.784053</span></span><br><span class="line">         <span class="number">3</span> <span class="operator">+</span>DATA<span class="operator">/</span>min<span class="operator">/</span>datafile<span class="operator">/</span>undotbs1<span class="number">.258</span><span class="number">.854775097</span>                                             <span class="number">187.109635</span></span><br><span class="line">         <span class="number">4</span> <span class="operator">+</span>DATA<span class="operator">/</span>min<span class="operator">/</span>datafile<span class="operator">/</span>users<span class="number">.259</span><span class="number">.854775097</span>                                                <span class="number">103.122924</span></span><br><span class="line">         <span class="number">5</span> <span class="operator">+</span>DATA<span class="operator">/</span>min<span class="operator">/</span>datafile<span class="operator">/</span>lp.dbf                                                              <span class="number">1741.8206</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> lp (id number,des1 <span class="type">char</span>(<span class="number">2000</span>),des2 <span class="type">char</span>(<span class="number">2000</span>),des3 <span class="type">char</span>(<span class="number">2000</span>),des4 <span class="type">char</span>(<span class="number">500</span>)) tablespace lp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Table</span> created.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>观察新建的表所占区</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> col SEGMENT_NAME <span class="keyword">for</span> a30</span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> col des1 <span class="keyword">for</span> a1</span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> col des2 <span class="keyword">for</span> a1</span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> col des3 <span class="keyword">for</span> a1</span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> col des4 <span class="keyword">for</span> a1</span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">set</span> line <span class="number">200</span></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID, BLOCKS <span class="keyword">from</span> dba_extents <span class="keyword">where</span> segment_name<span class="operator">=</span><span class="string">&#x27;LP&#x27;</span>;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME                    EXTENT_ID    FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line"><span class="comment">------------------------------ ---------- ---------- ---------- ----------</span></span><br><span class="line">LP                                      <span class="number">0</span>          <span class="number">5</span>        <span class="number">128</span>        <span class="number">128</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>此表是5号文件，拥有1个区，block从128号开始，接下来我们插入一条数据，并dump出段头进行观察</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> lp <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> created.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Commit</span> complete.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> segment_name ,HEADER_FILE,HEADER_BLOCK <span class="keyword">from</span> dba_segments <span class="keyword">where</span> segment_name<span class="operator">=</span><span class="string">&#x27;LP&#x27;</span>;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME                   HEADER_FILE HEADER_BLOCK</span><br><span class="line"><span class="comment">------------------------------ ----------- ------------</span></span><br><span class="line">LP                                       <span class="number">5</span>          <span class="number">131</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">system</span> checkpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">System</span> altered.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>LP的段头是5号文件，131号块，进行dump</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">system</span> dump datafile <span class="number">5</span> block <span class="number">131</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> col <span class="keyword">value</span> <span class="keyword">for</span> a65</span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span>  <span class="keyword">from</span> v$diag_info;</span><br><span class="line"></span><br><span class="line">   INST_ID NAME                                                                             <span class="keyword">VALUE</span></span><br><span class="line"><span class="comment">---------- -------------------------------------------------------------------------------- -----------------------------------------------------------------</span></span><br><span class="line">         <span class="number">1</span> Diag Enabled                                                                     <span class="literal">TRUE</span></span><br><span class="line">         <span class="number">1</span> ADR Base                                                                         <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>oracle</span><br><span class="line">         <span class="number">1</span> ADR Home                                                                         <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>oracle<span class="operator">/</span>diag<span class="operator">/</span>rdbms<span class="operator">/</span>min<span class="operator">/</span>min</span><br><span class="line">         <span class="number">1</span> Diag Trace                                                                       <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>oracle<span class="operator">/</span>diag<span class="operator">/</span>rdbms<span class="operator">/</span>min<span class="operator">/</span>min<span class="operator">/</span>trace</span><br><span class="line">         <span class="number">1</span> Diag Alert                                                                       <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>oracle<span class="operator">/</span>diag<span class="operator">/</span>rdbms<span class="operator">/</span>min<span class="operator">/</span>min<span class="operator">/</span>alert</span><br><span class="line">         <span class="number">1</span> Diag Incident                                                                    <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>oracle<span class="operator">/</span>diag<span class="operator">/</span>rdbms<span class="operator">/</span>min<span class="operator">/</span>min<span class="operator">/</span>incident</span><br><span class="line">         <span class="number">1</span> Diag Cdump                                                                       <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>oracle<span class="operator">/</span>diag<span class="operator">/</span>rdbms<span class="operator">/</span>min<span class="operator">/</span>min<span class="operator">/</span>cdump</span><br><span class="line">         <span class="number">1</span> Health Monitor                                                                   <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>oracle<span class="operator">/</span>diag<span class="operator">/</span>rdbms<span class="operator">/</span>min<span class="operator">/</span>min<span class="operator">/</span>hm</span><br><span class="line">         <span class="number">1</span> <span class="keyword">Default</span> Trace File                                                               <span class="operator">/</span>u01<span class="operator">/</span>app<span class="operator">/</span>oracle<span class="operator">/</span>diag<span class="operator">/</span>rdbms<span class="operator">/</span>min<span class="operator">/</span>min<span class="operator">/</span>trace<span class="operator">/</span>min_ora_2835.trc</span><br><span class="line">         <span class="number">1</span> Active Problem Count                                                             <span class="number">0</span></span><br><span class="line">         <span class="number">1</span> Active Incident Count                                                            <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="number">11</span> <span class="keyword">rows</span> selected.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>观察trc文件min_ora_2835.trc</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">Block dump from disk:</span><br><span class="line">buffer tsn: 8 rdba: 0x01400083 (5/131)</span><br><span class="line">scn: 0x0000.00140d51 seq: 0x01 flg: 0x04 tail: 0x0d512301</span><br><span class="line">frmt: 0x02 chkval: 0xfd8a type: 0x23=PAGETABLE SEGMENT HEADER</span><br><span class="line">Hex dump of block: st=0, typ_found=1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Extent Control Header</span><br><span class="line">  -----------------------------------------------------------------</span><br><span class="line">  Extent Header:: spare1: 0      spare2: 0      #extents: 1      #blocks: 128   </span><br><span class="line">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class="line">      Highwater::  0x014000c0  ext#: 0      blk#: 64     ext size: 128   </span><br><span class="line">  #blocks in seg. hdr&#x27;s freelists: 0     </span><br><span class="line">  #blocks below: 60    </span><br><span class="line">  mapblk  0x00000000  offset: 0     </span><br><span class="line">                   Unlocked</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">  Low HighWater Mark :</span><br><span class="line">      Highwater::  0x01400084  ext#: 0      blk#: 4      ext size: 128   </span><br><span class="line">  #blocks in seg. hdr&#x27;s freelists: 0     </span><br><span class="line">  #blocks below: 0     </span><br><span class="line">  mapblk  0x00000000  offset: 0     </span><br><span class="line">  Level 1 BMB for High HWM block: 0x01400080</span><br><span class="line">  Level 1 BMB for Low HWM block: 0x01400080</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">  Segment Type: 1 nl2: 1      blksz: 8192   fbsz: 0      </span><br><span class="line">  L2 Array start offset:  0x00001434</span><br><span class="line">  First Level 3 BMB:  0x00000000</span><br><span class="line">  L2 Hint for inserts:  0x01400082</span><br><span class="line">  Last Level 1 BMB:  0x01400081</span><br><span class="line">  Last Level II BMB:  0x01400082</span><br><span class="line">  Last Level III BMB:  0x00000000</span><br><span class="line">     Map Header:: next  0x00000000  #extents: 1    obj#: 87596  flag: 0x10000000</span><br><span class="line">  Inc # 0</span><br><span class="line">  Extent Map</span><br><span class="line">  -----------------------------------------------------------------</span><br><span class="line">   0x01400080  length: 128   </span><br><span class="line"></span><br><span class="line">  Auxillary Map</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   Extent 0     :  L1 dba:  0x01400080 Data dba:  0x01400084</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Second Level Bitmap block DBAs</span><br><span class="line">   --------------------------------------------------------</span><br><span class="line">   DBA 1:   0x01400082</span><br><span class="line"></span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 131 maxblk 131</span><br></pre></td></tr></table></figure>

<blockquote>
<p>很容易发现这是一个PAGETABLE SEGMENT HEADER块，Extent Map中只有一个区，另外在尾部有一个指向二级位图块的地址0x01400082，这是数据块地址的二进制用十六进制来表示，我们来将其转化成直观一点的信息</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> dbms_utility.data_block_address_file(to_number(<span class="string">&#x27;01400082&#x27;</span>, <span class="string">&#x27;xxxxxxxx&#x27;</span>)) file#,</span><br><span class="line">  <span class="number">2</span> dbms_utility.data_block_address_block(to_number(<span class="string">&#x27;01400082&#x27;</span>, <span class="string">&#x27;xxxxxxxx&#x27;</span>)) block#</span><br><span class="line">  <span class="number">3</span> <span class="keyword">from</span> dual;</span><br><span class="line"></span><br><span class="line">     FILE# BLOCK#</span><br><span class="line"><span class="comment">---------- ----------</span></span><br><span class="line">         <span class="number">5</span> <span class="number">130</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>依样将5号文件130号块的内容dump出来</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Block dump from disk:</span><br><span class="line">buffer tsn: 8 rdba: 0x01400082 (5/130)</span><br><span class="line">scn: 0x0000.00140a45 seq: 0x02 flg: 0x04 tail: 0x0a452102</span><br><span class="line">frmt: 0x02 chkval: 0xd119 type: 0x21=SECOND LEVEL BITMAP BLOCK</span><br><span class="line">Hex dump of block: st=0, typ_found=1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Dump of Second Level Bitmap Block</span><br><span class="line">   number: 2       nfree: 2       ffree: 0      pdba:     0x01400083</span><br><span class="line">   Inc #: 0 Objd: 87596</span><br><span class="line">  opcode:0</span><br><span class="line"> xid:</span><br><span class="line">  L1 Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x01400080  Free: 5 Inst: 1</span><br><span class="line">   0x01400081  Free: 5 Inst: 1</span><br><span class="line"></span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 130 maxblk 130</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以发现这是一个二级位图块，并从其中找到了2个L1块的地址，我们来看第一个L1</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Block dump from disk:</span><br><span class="line">buffer tsn: 8 rdba: 0x01400080 (5/128)</span><br><span class="line">scn: 0x0000.00140d51 seq: 0x03 flg: 0x04 tail: 0x0d512003</span><br><span class="line">frmt: 0x02 chkval: 0xe697 type: 0x20=FIRST LEVEL BITMAP BLOCK</span><br><span class="line">Hex dump of block: st=0, typ_found=1</span><br><span class="line"></span><br><span class="line">DBA Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x01400080  Length: 64     Offset: 0      </span><br><span class="line"></span><br><span class="line">   0:Metadata   1:Metadata   2:Metadata   3:Metadata</span><br><span class="line">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class="line">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class="line">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class="line">   16:75-100% free   17:75-100% free   18:75-100% free   19:75-100% free</span><br><span class="line">   20:75-100% free   21:75-100% free   22:75-100% free   23:75-100% free</span><br><span class="line">   24:75-100% free   25:75-100% free   26:75-100% free   27:75-100% free</span><br><span class="line">   28:75-100% free   29:75-100% free   30:75-100% free   31:0-25% free</span><br><span class="line">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class="line">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class="line">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class="line">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class="line">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class="line">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class="line">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class="line">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 128 maxblk 128</span><br></pre></td></tr></table></figure>

<blockquote>
<p>无疑这是一个L1块，里面挂了64个数据块，因为我之前插入了一行数据，oracle已经格式化了一部分，并向其中一个块插入了数据，但是没达到我们的效果，被插入的块还显示0-25%的空闲，我们要的是full的状态，说明我们构造的数据不够大，没关系，我们修改一下pctfree就可以了，另外我们可以发现这个区是1M，有2个L1，每个L1里有64个数据块，接下来修改pctfree</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> lp pctfree <span class="number">24</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Table</span> altered.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> TABLE_NAME,PCT_FREE <span class="keyword">from</span> dba_tables <span class="keyword">where</span> table_name<span class="operator">=</span><span class="string">&#x27;LP&#x27;</span>;</span><br><span class="line"></span><br><span class="line">TABLE_NAME                       PCT_FREE</span><br><span class="line"><span class="comment">------------------------------ ----------</span></span><br><span class="line">LP                                     <span class="number">24</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> lp <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> created.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Commit</span> complete.</span><br><span class="line"><span class="comment">--手动触发检查点将内存中的块刷新到磁盘，本文每次dump之前都会做这个操作，以保证磁盘和内存的内容一致</span></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">system</span> checkpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">System</span> altered.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们再看128号块</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">DBA Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x01400080  Length: 64     Offset: 0      </span><br><span class="line"></span><br><span class="line">   0:Metadata   1:Metadata   2:Metadata   3:Metadata</span><br><span class="line">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class="line">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class="line">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class="line">   16:75-100% free   17:75-100% free   18:75-100% free   19:75-100% free</span><br><span class="line">   20:75-100% free   21:75-100% free   22:75-100% free   23:75-100% free</span><br><span class="line">   24:75-100% free   25:75-100% free   26:75-100% free   27:75-100% free</span><br><span class="line">   28:75-100% free   29:75-100% free   30:75-100% free   31:0-25% free</span><br><span class="line">   32:75-100% free   33:75-100% free   34:75-100% free   &lt;font color=&#x27;red&#x27;&gt;35:FULL&lt;/font&gt;</span><br><span class="line">   36:75-100% free   37:75-100% free   38:75-100% free   39:75-100% free</span><br><span class="line">   40:75-100% free   41:75-100% free   42:75-100% free   43:75-100% free</span><br><span class="line">   44:75-100% free   45:75-100% free   46:75-100% free   47:75-100% free</span><br><span class="line">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class="line">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class="line">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class="line">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 128 maxblk 128</span><br></pre></td></tr></table></figure>

<blockquote>
<p>已经是我们想的结果了，到这里我们再来看一下另外一个L1吧，dump129号块</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">DBA Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x014000c0  Length: 64     Offset: 0      </span><br><span class="line"></span><br><span class="line">   0:unformatted   1:unformatted   2:unformatted   3:unformatted</span><br><span class="line">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class="line">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class="line">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class="line">   16:unformatted   17:unformatted   18:unformatted   19:unformatted</span><br><span class="line">   20:unformatted   21:unformatted   22:unformatted   23:unformatted</span><br><span class="line">   24:unformatted   25:unformatted   26:unformatted   27:unformatted</span><br><span class="line">   28:unformatted   29:unformatted   30:unformatted   31:unformatted</span><br><span class="line">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class="line">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class="line">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class="line">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class="line">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class="line">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class="line">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class="line">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 129 maxblk 129</span><br></pre></td></tr></table></figure>

<blockquote>
<p>全是未格式化的块，试一试并发插入，这里不模拟真正的并发了，只是开不同的session来进行插入</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> lp <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> created.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> lp <span class="keyword">values</span>(<span class="number">4</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> created.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> lp <span class="keyword">values</span>(<span class="number">5</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> created.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> lp <span class="keyword">values</span>(<span class="number">6</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> created.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> lp <span class="keyword">values</span>(<span class="number">7</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> created.</span><br><span class="line"></span><br><span class="line"><span class="comment">--单独session5条</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) <span class="keyword">from</span> lp;</span><br><span class="line"></span><br><span class="line">DBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)</span><br><span class="line"><span class="comment">------------------------------------ ------------------------------------</span></span><br><span class="line">                                   <span class="number">5</span>                                  <span class="number">158</span></span><br><span class="line">                                   <span class="number">5</span>                                  <span class="number">159</span></span><br><span class="line">                                   <span class="number">5</span>                                  <span class="number">163</span></span><br><span class="line">                                   <span class="number">5</span>                                  <span class="number">167</span></span><br><span class="line">                                   <span class="number">5</span>                                  <span class="number">171</span></span><br><span class="line">                                   <span class="number">5</span>                                  <span class="number">172</span></span><br><span class="line">                                   <span class="number">5</span>                                  <span class="number">174</span></span><br><span class="line">                                   <span class="number">5</span>                                  <span class="number">175</span></span><br><span class="line">                                   <span class="number">5</span>                                  <span class="number">179</span></span><br><span class="line">                                   <span class="number">5</span>                                  <span class="number">183</span></span><br><span class="line">                                   <span class="number">5</span>                                  <span class="number">187</span></span><br><span class="line">                                   <span class="number">5</span>                                  <span class="number">191</span></span><br><span class="line"></span><br><span class="line"><span class="number">12</span> <span class="keyword">rows</span> selected.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>一个单独的session里插入了5条，另外5个单独的session里各插一条，发现规律了么，插入的块只在132和192之间，我们分别看看两个L1</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; alter system checkpoint;</span><br><span class="line"></span><br><span class="line">System altered.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  DBA Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x01400080  Length: 64     Offset: 0      </span><br><span class="line"></span><br><span class="line">   0:Metadata   1:Metadata   2:Metadata   3:Metadata</span><br><span class="line">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class="line">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class="line">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class="line">   16:75-100% free   17:75-100% free   18:75-100% free   19:75-100% free</span><br><span class="line">   20:75-100% free   21:75-100% free   22:75-100% free   23:75-100% free</span><br><span class="line">   24:75-100% free   25:75-100% free   26:75-100% free   27:75-100% free</span><br><span class="line">   28:75-100% free   29:75-100% free   30:FULL   31:0-25% free</span><br><span class="line">   32:75-100% free   33:75-100% free   34:75-100% free   35:FULL</span><br><span class="line">   36:75-100% free   37:75-100% free   38:75-100% free   39:FULL</span><br><span class="line">   40:75-100% free   41:75-100% free   42:75-100% free   43:FULL</span><br><span class="line">   44:FULL   45:75-100% free   46:FULL   47:FULL</span><br><span class="line">   48:75-100% free   49:75-100% free   50:75-100% free   51:FULL</span><br><span class="line">   52:75-100% free   53:75-100% free   54:75-100% free   55:FULL</span><br><span class="line">   56:75-100% free   57:75-100% free   58:75-100% free   59:FULL</span><br><span class="line">   60:75-100% free   61:75-100% free   62:75-100% free   63:FULL</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 128 maxblk 128</span><br><span class="line"></span><br><span class="line">********************************************************************</span><br><span class="line">看一下第二个L1</span><br><span class="line"></span><br><span class="line">DBA Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x014000c0  Length: 64     Offset: 0      </span><br><span class="line"></span><br><span class="line">   0:unformatted   1:unformatted   2:unformatted   3:unformatted</span><br><span class="line">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class="line">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class="line">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class="line">   16:unformatted   17:unformatted   18:unformatted   19:unformatted</span><br><span class="line">   20:unformatted   21:unformatted   22:unformatted   23:unformatted</span><br><span class="line">   24:unformatted   25:unformatted   26:unformatted   27:unformatted</span><br><span class="line">   28:unformatted   29:unformatted   30:unformatted   31:unformatted</span><br><span class="line">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class="line">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class="line">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class="line">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class="line">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class="line">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class="line">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class="line">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 129 maxblk 129</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这说明只在第一个L1里面随机，那为什么L2下挂了2个L1，我插入了10条却没有一条随机到第二个L1块呢？答案是高水位，这是vage大师已经论证过的了，偶在这里仅为见证一下~~，好了，还记得L3里的高水位信息么？</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Extent Control Header</span><br><span class="line">  -----------------------------------------------------------------</span><br><span class="line">  Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928</span><br><span class="line">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class="line">      Highwater::  0x014000c0  ext#: 0      blk#: 64     ext size: 128   </span><br><span class="line">  #blocks in seg. hdr&#x27;s freelists: 0     </span><br><span class="line">  #blocks below: 60    </span><br><span class="line">  mapblk  0x00000000  offset: 0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Highwater::  0x014000c0是哪个块呢？</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> dbms_utility.data_block_address_file(to_number(<span class="string">&#x27;014000c0&#x27;</span>, <span class="string">&#x27;xxxxxxxx&#x27;</span>)) file#,</span><br><span class="line">  <span class="number">2</span> dbms_utility.data_block_address_block(to_number(<span class="string">&#x27;014000c0&#x27;</span>, <span class="string">&#x27;xxxxxxxx&#x27;</span>)) block#</span><br><span class="line">  <span class="number">3</span> <span class="keyword">from</span> dual;</span><br><span class="line"></span><br><span class="line">     FILE# BLOCK#</span><br><span class="line"><span class="comment">---------- ----------</span></span><br><span class="line">         <span class="number">5</span> <span class="number">192</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>这是第二个L1管理的第一个块，可见数据的插入只在高水位之下进行（直接路径插入除外），此时的状态如下：</p>
</blockquote>
<p><img data-src="http://qiniu.liupzmin.com/0%E4%B8%AAextent.png"></p>
<blockquote>
<p>那么L1里面只会有64个块么？高水位永远都会指向L1的最后一个块么？我们继续剖析！<br>首先给LP表多分配一些区</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">table</span> lp <span class="keyword">allocate</span> extent(size <span class="number">100</span>m);</span><br><span class="line"></span><br><span class="line"><span class="keyword">Table</span> altered.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID, BLOCKS <span class="keyword">from</span> dba_extents <span class="keyword">where</span> segment_name<span class="operator">=</span><span class="string">&#x27;LP&#x27;</span>;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME                    EXTENT_ID    FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line"><span class="comment">------------------------------ ---------- ---------- ---------- ----------</span></span><br><span class="line">LP                                      <span class="number">0</span>          <span class="number">5</span>        <span class="number">128</span>        <span class="number">128</span></span><br><span class="line">LP                                      <span class="number">1</span>          <span class="number">5</span>        <span class="number">256</span>        <span class="number">128</span></span><br><span class="line">LP                                      <span class="number">2</span>          <span class="number">5</span>        <span class="number">384</span>        <span class="number">128</span></span><br><span class="line">LP                                      <span class="number">3</span>          <span class="number">5</span>        <span class="number">512</span>        <span class="number">128</span></span><br><span class="line">LP                                      <span class="number">4</span>          <span class="number">5</span>        <span class="number">640</span>        <span class="number">128</span></span><br><span class="line">LP                                      <span class="number">5</span>          <span class="number">5</span>        <span class="number">768</span>        <span class="number">128</span></span><br><span class="line">LP                                      <span class="number">6</span>          <span class="number">5</span>        <span class="number">896</span>        <span class="number">128</span></span><br><span class="line">LP                                      <span class="number">7</span>          <span class="number">5</span>       <span class="number">1024</span>        <span class="number">128</span></span><br><span class="line">LP                                      <span class="number">8</span>          <span class="number">5</span>       <span class="number">1152</span>        <span class="number">128</span></span><br><span class="line">LP                                      <span class="number">9</span>          <span class="number">5</span>       <span class="number">1280</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">10</span>          <span class="number">5</span>       <span class="number">1408</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">11</span>          <span class="number">5</span>       <span class="number">1536</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">12</span>          <span class="number">5</span>       <span class="number">1664</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">13</span>          <span class="number">5</span>       <span class="number">1792</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">14</span>          <span class="number">5</span>       <span class="number">1920</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">15</span>          <span class="number">5</span>       <span class="number">2048</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">16</span>          <span class="number">5</span>       <span class="number">2176</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">17</span>          <span class="number">5</span>       <span class="number">2304</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">18</span>          <span class="number">5</span>       <span class="number">2432</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">19</span>          <span class="number">5</span>       <span class="number">2560</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">20</span>          <span class="number">5</span>       <span class="number">2688</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">21</span>          <span class="number">5</span>       <span class="number">2816</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">22</span>          <span class="number">5</span>       <span class="number">2944</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">23</span>          <span class="number">5</span>       <span class="number">3072</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">24</span>          <span class="number">5</span>       <span class="number">3200</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">25</span>          <span class="number">5</span>       <span class="number">3328</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">26</span>          <span class="number">5</span>       <span class="number">3456</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">27</span>          <span class="number">5</span>       <span class="number">3584</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">28</span>          <span class="number">5</span>       <span class="number">3712</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">29</span>          <span class="number">5</span>       <span class="number">3840</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">30</span>          <span class="number">5</span>       <span class="number">3968</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">31</span>          <span class="number">5</span>       <span class="number">4096</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">32</span>          <span class="number">5</span>       <span class="number">4224</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">33</span>          <span class="number">5</span>       <span class="number">4352</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">34</span>          <span class="number">5</span>       <span class="number">4480</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">35</span>          <span class="number">5</span>       <span class="number">4608</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">36</span>          <span class="number">5</span>       <span class="number">4736</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">37</span>          <span class="number">5</span>       <span class="number">4864</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">38</span>          <span class="number">5</span>       <span class="number">4992</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">39</span>          <span class="number">5</span>       <span class="number">5120</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">40</span>          <span class="number">5</span>       <span class="number">5248</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">41</span>          <span class="number">5</span>       <span class="number">5376</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">42</span>          <span class="number">5</span>       <span class="number">5504</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">43</span>          <span class="number">5</span>       <span class="number">5632</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">44</span>          <span class="number">5</span>       <span class="number">5760</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">45</span>          <span class="number">5</span>       <span class="number">5888</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">46</span>          <span class="number">5</span>       <span class="number">6016</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">47</span>          <span class="number">5</span>       <span class="number">6144</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">48</span>          <span class="number">5</span>       <span class="number">6272</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">49</span>          <span class="number">5</span>       <span class="number">6400</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">50</span>          <span class="number">5</span>       <span class="number">6528</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">51</span>          <span class="number">5</span>       <span class="number">6656</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">52</span>          <span class="number">5</span>       <span class="number">6784</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">53</span>          <span class="number">5</span>       <span class="number">6912</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">54</span>          <span class="number">5</span>       <span class="number">7040</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">55</span>          <span class="number">5</span>       <span class="number">7168</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">56</span>          <span class="number">5</span>       <span class="number">7296</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">57</span>          <span class="number">5</span>       <span class="number">7424</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">58</span>          <span class="number">5</span>       <span class="number">7552</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">59</span>          <span class="number">5</span>       <span class="number">7680</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">60</span>          <span class="number">5</span>       <span class="number">7808</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">61</span>          <span class="number">5</span>       <span class="number">7936</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">62</span>          <span class="number">5</span>       <span class="number">8064</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">63</span>          <span class="number">5</span>       <span class="number">8192</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">64</span>          <span class="number">5</span>       <span class="number">8320</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">65</span>          <span class="number">5</span>       <span class="number">8448</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">66</span>          <span class="number">5</span>       <span class="number">8576</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">67</span>          <span class="number">5</span>       <span class="number">8704</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">68</span>          <span class="number">5</span>       <span class="number">8832</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">69</span>          <span class="number">5</span>       <span class="number">8960</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">70</span>          <span class="number">5</span>       <span class="number">9088</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">71</span>          <span class="number">5</span>       <span class="number">9216</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">72</span>          <span class="number">5</span>       <span class="number">9344</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">73</span>          <span class="number">5</span>       <span class="number">9472</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">74</span>          <span class="number">5</span>       <span class="number">9600</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">75</span>          <span class="number">5</span>       <span class="number">9728</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">76</span>          <span class="number">5</span>       <span class="number">9856</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">77</span>          <span class="number">5</span>       <span class="number">9984</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">78</span>          <span class="number">5</span>      <span class="number">10112</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">79</span>          <span class="number">5</span>      <span class="number">10240</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">80</span>          <span class="number">5</span>      <span class="number">10368</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">81</span>          <span class="number">5</span>      <span class="number">10496</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">82</span>          <span class="number">5</span>      <span class="number">10624</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">83</span>          <span class="number">5</span>      <span class="number">10752</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">84</span>          <span class="number">5</span>      <span class="number">10880</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">85</span>          <span class="number">5</span>      <span class="number">11008</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">86</span>          <span class="number">5</span>      <span class="number">11136</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">87</span>          <span class="number">5</span>      <span class="number">11264</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">88</span>          <span class="number">5</span>      <span class="number">11392</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">89</span>          <span class="number">5</span>      <span class="number">11520</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">90</span>          <span class="number">5</span>      <span class="number">11648</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">91</span>          <span class="number">5</span>      <span class="number">11776</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">92</span>          <span class="number">5</span>      <span class="number">11904</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">93</span>          <span class="number">5</span>      <span class="number">12032</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">94</span>          <span class="number">5</span>      <span class="number">12160</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">95</span>          <span class="number">5</span>      <span class="number">12288</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">96</span>          <span class="number">5</span>      <span class="number">12416</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">97</span>          <span class="number">5</span>      <span class="number">12544</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">98</span>          <span class="number">5</span>      <span class="number">12672</span>        <span class="number">128</span></span><br><span class="line">LP                                     <span class="number">99</span>          <span class="number">5</span>      <span class="number">12800</span>        <span class="number">128</span></span><br><span class="line">LP                                    <span class="number">100</span>          <span class="number">5</span>      <span class="number">12928</span>        <span class="number">128</span></span><br><span class="line"></span><br><span class="line"><span class="number">101</span> <span class="keyword">rows</span> selected.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我分配了100个区，加上原来的一共101个，现在我们看看L3段头里面的内容</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></td><td class="code"><pre><span class="line">Extent Control Header</span><br><span class="line">  -----------------------------------------------------------------</span><br><span class="line">  Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928</span><br><span class="line">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class="line">      Highwater::  0x014000c0  ext#: 0      blk#: 64     ext size: 128   </span><br><span class="line">  #blocks in seg. hdr&#x27;s freelists: 0     </span><br><span class="line">  #blocks below: 60    </span><br><span class="line">  mapblk  0x00000000  offset: 0     </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Extent Map</span><br><span class="line">  -----------------------------------------------------------------</span><br><span class="line">   0x01400080  length: 128   </span><br><span class="line">   0x01400100  length: 128   </span><br><span class="line">   0x01400180  length: 128   </span><br><span class="line">   0x01400200  length: 128   </span><br><span class="line">   0x01400280  length: 128   </span><br><span class="line">   0x01400300  length: 128   </span><br><span class="line">   0x01400380  length: 128   </span><br><span class="line">   0x01400400  length: 128   </span><br><span class="line">   0x01400480  length: 128   </span><br><span class="line">   0x01400500  length: 128   </span><br><span class="line">   0x01400580  length: 128   </span><br><span class="line">   0x01400600  length: 128   </span><br><span class="line">   0x01400680  length: 128   </span><br><span class="line">   0x01400700  length: 128   </span><br><span class="line">   0x01400780  length: 128   </span><br><span class="line">   0x01400800  length: 128   </span><br><span class="line">   0x01400880  length: 128   </span><br><span class="line">   0x01400900  length: 128   </span><br><span class="line">   0x01400980  length: 128   </span><br><span class="line">   0x01400a00  length: 128   </span><br><span class="line">   0x01400a80  length: 128   </span><br><span class="line">   0x01400b00  length: 128   </span><br><span class="line">   0x01400b80  length: 128   </span><br><span class="line">   0x01400c00  length: 128   </span><br><span class="line">   0x01400c80  length: 128   </span><br><span class="line">   0x01400d00  length: 128   </span><br><span class="line">   0x01400d80  length: 128   </span><br><span class="line">   0x01400e00  length: 128   </span><br><span class="line">   0x01400e80  length: 128   </span><br><span class="line">   0x01400f00  length: 128   </span><br><span class="line">   0x01400f80  length: 128   </span><br><span class="line">   0x01401000  length: 128   </span><br><span class="line">   0x01401080  length: 128   </span><br><span class="line">   0x01401100  length: 128   </span><br><span class="line">   0x01401180  length: 128   </span><br><span class="line">   0x01401200  length: 128   </span><br><span class="line">   0x01401280  length: 128   </span><br><span class="line">   0x01401300  length: 128   </span><br><span class="line">   0x01401380  length: 128   </span><br><span class="line">   0x01401400  length: 128   </span><br><span class="line">   0x01401480  length: 128   </span><br><span class="line">   0x01401500  length: 128   </span><br><span class="line">   0x01401580  length: 128   </span><br><span class="line">   0x01401600  length: 128   </span><br><span class="line">   0x01401680  length: 128   </span><br><span class="line">   0x01401700  length: 128   </span><br><span class="line">   0x01401780  length: 128   </span><br><span class="line">   0x01401800  length: 128   </span><br><span class="line">   0x01401880  length: 128   </span><br><span class="line">   0x01401900  length: 128   </span><br><span class="line">   0x01401980  length: 128   </span><br><span class="line">   0x01401a00  length: 128   </span><br><span class="line">   0x01401a80  length: 128   </span><br><span class="line">   0x01401b00  length: 128   </span><br><span class="line">   0x01401b80  length: 128   </span><br><span class="line">   0x01401c00  length: 128   </span><br><span class="line">   0x01401c80  length: 128   </span><br><span class="line">   0x01401d00  length: 128   </span><br><span class="line">   0x01401d80  length: 128   </span><br><span class="line">   0x01401e00  length: 128   </span><br><span class="line">   0x01401e80  length: 128   </span><br><span class="line">   0x01401f00  length: 128   </span><br><span class="line">   0x01401f80  length: 128   </span><br><span class="line">   0x01402000  length: 128   </span><br><span class="line">   0x01402080  length: 128   </span><br><span class="line">   0x01402100  length: 128   </span><br><span class="line">   0x01402180  length: 128   </span><br><span class="line">   0x01402200  length: 128   </span><br><span class="line">   0x01402280  length: 128   </span><br><span class="line">   0x01402300  length: 128   </span><br><span class="line">   0x01402380  length: 128   </span><br><span class="line">   0x01402400  length: 128   </span><br><span class="line">   0x01402480  length: 128   </span><br><span class="line">   0x01402500  length: 128   </span><br><span class="line">   0x01402580  length: 128   </span><br><span class="line">   0x01402600  length: 128   </span><br><span class="line">   0x01402680  length: 128   </span><br><span class="line">   0x01402700  length: 128   </span><br><span class="line">   0x01402780  length: 128   </span><br><span class="line">   0x01402800  length: 128   </span><br><span class="line">   0x01402880  length: 128   </span><br><span class="line">   0x01402900  length: 128   </span><br><span class="line">   0x01402980  length: 128   </span><br><span class="line">   0x01402a00  length: 128   </span><br><span class="line">   0x01402a80  length: 128   </span><br><span class="line">   0x01402b00  length: 128   </span><br><span class="line">   0x01402b80  length: 128   </span><br><span class="line">   0x01402c00  length: 128   </span><br><span class="line">   0x01402c80  length: 128   </span><br><span class="line">   0x01402d00  length: 128   </span><br><span class="line">   0x01402d80  length: 128   </span><br><span class="line">   0x01402e00  length: 128   </span><br><span class="line">   0x01402e80  length: 128   </span><br><span class="line">   0x01402f00  length: 128   </span><br><span class="line">   0x01402f80  length: 128   </span><br><span class="line">   0x01403000  length: 128   </span><br><span class="line">   0x01403080  length: 128   </span><br><span class="line">   0x01403100  length: 128   </span><br><span class="line">   0x01403180  length: 128   </span><br><span class="line">   0x01403200  length: 128   </span><br><span class="line">   0x01403280  length: 128   </span><br><span class="line"></span><br><span class="line">  Auxillary Map</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   Extent 0     :  L1 dba:  0x01400080 Data dba:  0x01400084</span><br><span class="line">   Extent 1     :  L1 dba:  0x01400100 Data dba:  0x01400102</span><br><span class="line">   Extent 2     :  L1 dba:  0x01400180 Data dba:  0x01400182</span><br><span class="line">   Extent 3     :  L1 dba:  0x01400200 Data dba:  0x01400202</span><br><span class="line">   Extent 4     :  L1 dba:  0x01400280 Data dba:  0x01400282</span><br><span class="line">   Extent 5     :  L1 dba:  0x01400300 Data dba:  0x01400302</span><br><span class="line">   Extent 6     :  L1 dba:  0x01400380 Data dba:  0x01400382</span><br><span class="line">   Extent 7     :  L1 dba:  0x01400400 Data dba:  0x01400402</span><br><span class="line">   Extent 8     :  L1 dba:  0x01400480 Data dba:  0x01400482</span><br><span class="line">   Extent 9     :  L1 dba:  0x01400500 Data dba:  0x01400502</span><br><span class="line">   Extent 10    :  L1 dba:  0x01400580 Data dba:  0x01400582</span><br><span class="line">   Extent 11    :  L1 dba:  0x01400600 Data dba:  0x01400602</span><br><span class="line">   Extent 12    :  L1 dba:  0x01400680 Data dba:  0x01400682</span><br><span class="line">   Extent 13    :  L1 dba:  0x01400700 Data dba:  0x01400702</span><br><span class="line">   Extent 14    :  L1 dba:  0x01400780 Data dba:  0x01400782</span><br><span class="line">   Extent 15    :  L1 dba:  0x01400800 Data dba:  0x01400802</span><br><span class="line">   Extent 16    :  L1 dba:  0x01400880 Data dba:  0x01400882</span><br><span class="line">   Extent 17    :  L1 dba:  0x01400900 Data dba:  0x01400902</span><br><span class="line">   Extent 18    :  L1 dba:  0x01400980 Data dba:  0x01400982</span><br><span class="line">   Extent 19    :  L1 dba:  0x01400a00 Data dba:  0x01400a02</span><br><span class="line">   Extent 20    :  L1 dba:  0x01400a80 Data dba:  0x01400a82</span><br><span class="line">   Extent 21    :  L1 dba:  0x01400b00 Data dba:  0x01400b02</span><br><span class="line">   Extent 22    :  L1 dba:  0x01400b80 Data dba:  0x01400b82</span><br><span class="line">   Extent 23    :  L1 dba:  0x01400c00 Data dba:  0x01400c02</span><br><span class="line">   Extent 24    :  L1 dba:  0x01400c80 Data dba:  0x01400c82</span><br><span class="line">   Extent 25    :  L1 dba:  0x01400d00 Data dba:  0x01400d02</span><br><span class="line">   Extent 26    :  L1 dba:  0x01400d80 Data dba:  0x01400d82</span><br><span class="line">   Extent 27    :  L1 dba:  0x01400e00 Data dba:  0x01400e02</span><br><span class="line">   Extent 28    :  L1 dba:  0x01400e80 Data dba:  0x01400e82</span><br><span class="line">   Extent 29    :  L1 dba:  0x01400f00 Data dba:  0x01400f02</span><br><span class="line">   Extent 30    :  L1 dba:  0x01400f80 Data dba:  0x01400f82</span><br><span class="line">   Extent 31    :  L1 dba:  0x01401000 Data dba:  0x01401002</span><br><span class="line">   Extent 32    :  L1 dba:  0x01401080 Data dba:  0x01401082</span><br><span class="line">   Extent 33    :  L1 dba:  0x01401100 Data dba:  0x01401102</span><br><span class="line">   Extent 34    :  L1 dba:  0x01401180 Data dba:  0x01401182</span><br><span class="line">   Extent 35    :  L1 dba:  0x01401200 Data dba:  0x01401202</span><br><span class="line">   Extent 36    :  L1 dba:  0x01401280 Data dba:  0x01401282</span><br><span class="line">   Extent 37    :  L1 dba:  0x01401300 Data dba:  0x01401302</span><br><span class="line">   Extent 38    :  L1 dba:  0x01401380 Data dba:  0x01401382</span><br><span class="line">   Extent 39    :  L1 dba:  0x01401400 Data dba:  0x01401402</span><br><span class="line">   Extent 40    :  L1 dba:  0x01401480 Data dba:  0x01401482</span><br><span class="line">   Extent 41    :  L1 dba:  0x01401500 Data dba:  0x01401502</span><br><span class="line">   Extent 42    :  L1 dba:  0x01401580 Data dba:  0x01401582</span><br><span class="line">   Extent 43    :  L1 dba:  0x01401600 Data dba:  0x01401602</span><br><span class="line">   Extent 44    :  L1 dba:  0x01401680 Data dba:  0x01401682</span><br><span class="line">   Extent 45    :  L1 dba:  0x01401700 Data dba:  0x01401702</span><br><span class="line">   Extent 46    :  L1 dba:  0x01401780 Data dba:  0x01401782</span><br><span class="line">   Extent 47    :  L1 dba:  0x01401800 Data dba:  0x01401802</span><br><span class="line">   Extent 48    :  L1 dba:  0x01401880 Data dba:  0x01401882</span><br><span class="line">   Extent 49    :  L1 dba:  0x01401900 Data dba:  0x01401902</span><br><span class="line">   Extent 50    :  L1 dba:  0x01401980 Data dba:  0x01401982</span><br><span class="line">   Extent 51    :  L1 dba:  0x01401a00 Data dba:  0x01401a02</span><br><span class="line">   Extent 52    :  L1 dba:  0x01401a80 Data dba:  0x01401a82</span><br><span class="line">   Extent 53    :  L1 dba:  0x01401b00 Data dba:  0x01401b02</span><br><span class="line">   Extent 54    :  L1 dba:  0x01401b80 Data dba:  0x01401b82</span><br><span class="line">   Extent 55    :  L1 dba:  0x01401c00 Data dba:  0x01401c02</span><br><span class="line">   Extent 56    :  L1 dba:  0x01401c80 Data dba:  0x01401c82</span><br><span class="line">   Extent 57    :  L1 dba:  0x01401d00 Data dba:  0x01401d02</span><br><span class="line">   Extent 58    :  L1 dba:  0x01401d80 Data dba:  0x01401d82</span><br><span class="line">   Extent 59    :  L1 dba:  0x01401e00 Data dba:  0x01401e02</span><br><span class="line">   Extent 60    :  L1 dba:  0x01401e80 Data dba:  0x01401e82</span><br><span class="line">   Extent 61    :  L1 dba:  0x01401f00 Data dba:  0x01401f02</span><br><span class="line">   Extent 62    :  L1 dba:  0x01401f80 Data dba:  0x01401f82</span><br><span class="line">   Extent 63    :  L1 dba:  0x01402000 Data dba:  0x01402001</span><br><span class="line">   Extent 64    :  L1 dba:  0x01402000 Data dba:  0x01402080</span><br><span class="line">   Extent 65    :  L1 dba:  0x01402100 Data dba:  0x01402101</span><br><span class="line">   Extent 66    :  L1 dba:  0x01402100 Data dba:  0x01402180</span><br><span class="line">   Extent 67    :  L1 dba:  0x01402200 Data dba:  0x01402201</span><br><span class="line">   Extent 68    :  L1 dba:  0x01402200 Data dba:  0x01402280</span><br><span class="line">   Extent 69    :  L1 dba:  0x01402300 Data dba:  0x01402301</span><br><span class="line">   Extent 70    :  L1 dba:  0x01402300 Data dba:  0x01402380</span><br><span class="line">   Extent 71    :  L1 dba:  0x01402400 Data dba:  0x01402401</span><br><span class="line">   Extent 72    :  L1 dba:  0x01402400 Data dba:  0x01402480</span><br><span class="line">   Extent 73    :  L1 dba:  0x01402500 Data dba:  0x01402501</span><br><span class="line">   Extent 74    :  L1 dba:  0x01402500 Data dba:  0x01402580</span><br><span class="line">   Extent 75    :  L1 dba:  0x01402600 Data dba:  0x01402601</span><br><span class="line">   Extent 76    :  L1 dba:  0x01402600 Data dba:  0x01402680</span><br><span class="line">   Extent 77    :  L1 dba:  0x01402700 Data dba:  0x01402701</span><br><span class="line">   Extent 78    :  L1 dba:  0x01402700 Data dba:  0x01402780</span><br><span class="line">   Extent 79    :  L1 dba:  0x01402800 Data dba:  0x01402801</span><br><span class="line">   Extent 80    :  L1 dba:  0x01402800 Data dba:  0x01402880</span><br><span class="line">   Extent 81    :  L1 dba:  0x01402900 Data dba:  0x01402901</span><br><span class="line">   Extent 82    :  L1 dba:  0x01402900 Data dba:  0x01402980</span><br><span class="line">   Extent 83    :  L1 dba:  0x01402a00 Data dba:  0x01402a01</span><br><span class="line">   Extent 84    :  L1 dba:  0x01402a00 Data dba:  0x01402a80</span><br><span class="line">   Extent 85    :  L1 dba:  0x01402b00 Data dba:  0x01402b01</span><br><span class="line">   Extent 86    :  L1 dba:  0x01402b00 Data dba:  0x01402b80</span><br><span class="line">   Extent 87    :  L1 dba:  0x01402c00 Data dba:  0x01402c01</span><br><span class="line">   Extent 88    :  L1 dba:  0x01402c00 Data dba:  0x01402c80</span><br><span class="line">   Extent 89    :  L1 dba:  0x01402d00 Data dba:  0x01402d01</span><br><span class="line">   Extent 90    :  L1 dba:  0x01402d00 Data dba:  0x01402d80</span><br><span class="line">   Extent 91    :  L1 dba:  0x01402e00 Data dba:  0x01402e01</span><br><span class="line">   Extent 92    :  L1 dba:  0x01402e00 Data dba:  0x01402e80</span><br><span class="line">   Extent 93    :  L1 dba:  0x01402f00 Data dba:  0x01402f01</span><br><span class="line">   Extent 94    :  L1 dba:  0x01402f00 Data dba:  0x01402f80</span><br><span class="line">   Extent 95    :  L1 dba:  0x01403000 Data dba:  0x01403001</span><br><span class="line">   Extent 96    :  L1 dba:  0x01403000 Data dba:  0x01403080</span><br><span class="line">   Extent 97    :  L1 dba:  0x01403100 Data dba:  0x01403101</span><br><span class="line">   Extent 98    :  L1 dba:  0x01403100 Data dba:  0x01403180</span><br><span class="line">   Extent 99    :  L1 dba:  0x01403200 Data dba:  0x01403201</span><br><span class="line">   Extent 100   :  L1 dba:  0x01403200 Data dba:  0x01403280</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line"></span><br><span class="line">   Second Level Bitmap block DBAs</span><br><span class="line">   --------------------------------------------------------</span><br><span class="line">   DBA 1:   0x01400082</span><br><span class="line"></span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 131 maxblk 131   </span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里我们主要看Auxillary Map，里面记录了每个区所属的L1，不难发现从第64个区开始，64、65两个区的L1相同，这说明什么，说明L1下面挂了整整两个区的数据块，验证一下，将0x01402000块dump出来之后的内容：</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">01402000</span>  十进制 》<span class="number">20979712</span></span><br><span class="line">  <span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> dbms_utility.data_block_address_file(<span class="number">20979712</span>) Rfile#,dbms_utility.data_block_address_block(<span class="number">20979712</span>) &quot;Block#&quot; <span class="keyword">from</span> dual;</span><br><span class="line"></span><br><span class="line">    RFILE#     Block#</span><br><span class="line"><span class="comment">---------- ----------</span></span><br><span class="line">         <span class="number">5</span>       <span class="number">8192</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">          DBA Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x01402000  Length: 128    Offset: 0      </span><br><span class="line">   0x01402080  Length: 128    Offset: 128    </span><br><span class="line"></span><br><span class="line">   0:Metadata   1:unformatted   2:unformatted   3:unformatted</span><br><span class="line">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class="line">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class="line">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class="line">   16:unformatted   17:unformatted   18:unformatted   19:unformatted</span><br><span class="line">   20:unformatted   21:unformatted   22:unformatted   23:unformatted</span><br><span class="line">   24:unformatted   25:unformatted   26:unformatted   27:unformatted</span><br><span class="line">   28:unformatted   29:unformatted   30:unformatted   31:unformatted</span><br><span class="line">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class="line">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class="line">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class="line">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class="line">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class="line">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class="line">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class="line">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class="line">   64:unformatted   65:unformatted   66:unformatted   67:unformatted</span><br><span class="line">   68:unformatted   69:unformatted   70:unformatted   71:unformatted</span><br><span class="line">   72:unformatted   73:unformatted   74:unformatted   75:unformatted</span><br><span class="line">   76:unformatted   77:unformatted   78:unformatted   79:unformatted</span><br><span class="line">   80:unformatted   81:unformatted   82:unformatted   83:unformatted</span><br><span class="line">   84:unformatted   85:unformatted   86:unformatted   87:unformatted</span><br><span class="line">   88:unformatted   89:unformatted   90:unformatted   91:unformatted</span><br><span class="line">   92:unformatted   93:unformatted   94:unformatted   95:unformatted</span><br><span class="line">   96:unformatted   97:unformatted   98:unformatted   99:unformatted</span><br><span class="line">   100:unformatted   101:unformatted   102:unformatted   103:unformatted</span><br><span class="line">   104:unformatted   105:unformatted   106:unformatted   107:unformatted</span><br><span class="line">   108:unformatted   109:unformatted   110:unformatted   111:unformatted</span><br><span class="line">   112:unformatted   113:unformatted   114:unformatted   115:unformatted</span><br><span class="line">   116:unformatted   117:unformatted   118:unformatted   119:unformatted</span><br><span class="line">   120:unformatted   121:unformatted   122:unformatted   123:unformatted</span><br><span class="line">   124:unformatted   125:unformatted   126:unformatted   127:unformatted</span><br><span class="line">   128:unformatted   129:unformatted   130:unformatted   131:unformatted</span><br><span class="line">   132:unformatted   133:unformatted   134:unformatted   135:unformatted</span><br><span class="line">   136:unformatted   137:unformatted   138:unformatted   139:unformatted</span><br><span class="line">   140:unformatted   141:unformatted   142:unformatted   143:unformatted</span><br><span class="line">   144:unformatted   145:unformatted   146:unformatted   147:unformatted</span><br><span class="line">   148:unformatted   149:unformatted   150:unformatted   151:unformatted</span><br><span class="line">   152:unformatted   153:unformatted   154:unformatted   155:unformatted</span><br><span class="line">   156:unformatted   157:unformatted   158:unformatted   159:unformatted</span><br><span class="line">   160:unformatted   161:unformatted   162:unformatted   163:unformatted</span><br><span class="line">   164:unformatted   165:unformatted   166:unformatted   167:unformatted</span><br><span class="line">   168:unformatted   169:unformatted   170:unformatted   171:unformatted</span><br><span class="line">   172:unformatted   173:unformatted   174:unformatted   175:unformatted</span><br><span class="line">   176:unformatted   177:unformatted   178:unformatted   179:unformatted</span><br><span class="line">   180:unformatted   181:unformatted   182:unformatted   183:unformatted</span><br><span class="line">   184:unformatted   185:unformatted   186:unformatted   187:unformatted</span><br><span class="line">   188:unformatted   189:unformatted   190:unformatted   191:unformatted</span><br><span class="line">   192:unformatted   193:unformatted   194:unformatted   195:unformatted</span><br><span class="line">   196:unformatted   197:unformatted   198:unformatted   199:unformatted</span><br><span class="line">   200:unformatted   201:unformatted   202:unformatted   203:unformatted</span><br><span class="line">   204:unformatted   205:unformatted   206:unformatted   207:unformatted</span><br><span class="line">   208:unformatted   209:unformatted   210:unformatted   211:unformatted</span><br><span class="line">   212:unformatted   213:unformatted   214:unformatted   215:unformatted</span><br><span class="line">   216:unformatted   217:unformatted   218:unformatted   219:unformatted</span><br><span class="line">   220:unformatted   221:unformatted   222:unformatted   223:unformatted</span><br><span class="line">   224:unformatted   225:unformatted   226:unformatted   227:unformatted</span><br><span class="line">   228:unformatted   229:unformatted   230:unformatted   231:unformatted</span><br><span class="line">   232:unformatted   233:unformatted   234:unformatted   235:unformatted</span><br><span class="line">   236:unformatted   237:unformatted   238:unformatted   239:unformatted</span><br><span class="line">   240:unformatted   241:unformatted   242:unformatted   243:unformatted</span><br><span class="line">   244:unformatted   245:unformatted   246:unformatted   247:unformatted</span><br><span class="line">   248:unformatted   249:unformatted   250:unformatted   251:unformatted</span><br><span class="line">   252:unformatted   253:unformatted   254:unformatted   255:unformatted</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 8192 maxblk 8192</span><br></pre></td></tr></table></figure>

<blockquote>
<p>256个块，2M 2个区，可见L1中块的数量会随着段大小的改变而做调整的，可以增大到1024个甚至更多，我在这里不去再做验证，将重点放在高水位上，根据我们之前观察到的现象，高水位在第二个L1的地一个块，也可说第一个L1的末端，那么现在的L1里有256个块，高水位是不是也会推进到这个L1的末端呢？很容易进行验证，将数据插满到这个L1的前几个块再去观察段头高水位的变化就行了，那么插多少条呢？再来计算一下，当前的L1是8192号块，前面一共63个区，每个区里面两个L1，加上第一个区里面的一个L2和L3，我们需要插满8192-63*2-2&#x3D;8064</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span></span><br><span class="line">i number;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.8064</span> loop</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> lp <span class="keyword">values</span>(i,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="keyword">end</span> loop;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="operator">/</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>观察62号区的第二个L1，第一个L1的地址是0x01401f80，那么第二个就是01401f81，5号文件8065号块，dump出来的结果</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">DBA Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x01401fc0  Length: 64     Offset: 0      </span><br><span class="line"></span><br><span class="line">   0:FULL   1:FULL   2:FULL   3:FULL</span><br><span class="line">   4:FULL   5:FULL   6:FULL   7:FULL</span><br><span class="line">   8:FULL   9:FULL   10:FULL   11:FULL</span><br><span class="line">   12:FULL   13:FULL   14:FULL   15:FULL</span><br><span class="line">   16:FULL   17:FULL   18:FULL   19:FULL</span><br><span class="line">   20:FULL   21:FULL   22:FULL   23:FULL</span><br><span class="line">   24:FULL   25:FULL   26:FULL   27:FULL</span><br><span class="line">   28:FULL   29:FULL   30:FULL   31:FULL</span><br><span class="line">   32:FULL   33:FULL   34:FULL   35:FULL</span><br><span class="line">   36:FULL   37:FULL   38:FULL   39:FULL</span><br><span class="line">   40:FULL   41:FULL   42:FULL   43:FULL</span><br><span class="line">   44:FULL   45:FULL   46:FULL   47:FULL</span><br><span class="line">   48:FULL   49:FULL   50:FULL   51:FULL</span><br><span class="line">   52:FULL   53:FULL   54:FULL   55:FULL</span><br><span class="line">   56:FULL   57:FULL   58:FULL   59:FULL</span><br><span class="line">   60:FULL   61:FULL   62:FULL   63:FULL</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 8065 maxblk 8065</span><br></pre></td></tr></table></figure>

<blockquote>
<p>居然全满了？再看8192号L1呢</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">DBA Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x01402000  Length: 128    Offset: 0      </span><br><span class="line">   0x01402080  Length: 128    Offset: 128    </span><br><span class="line"></span><br><span class="line">   0:Metadata   1:FULL   2:FULL   3:FULL</span><br><span class="line">   4:FULL   5:FULL   6:FULL   7:FULL</span><br><span class="line">   8:FULL   9:FULL   10:FULL   11:FULL</span><br><span class="line">   12:FULL   13:FULL   14:FULL   15:FULL</span><br><span class="line">   16:FULL   17:FULL   18:FULL   19:FULL</span><br><span class="line">   20:FULL   21:FULL   22:FULL   23:FULL</span><br><span class="line">   24:FULL   25:FULL   26:FULL   27:FULL</span><br><span class="line">   28:FULL   29:FULL   30:FULL   31:FULL</span><br><span class="line">   32:FULL   33:FULL   34:FULL   35:FULL</span><br><span class="line">   36:FULL   37:FULL   38:FULL   39:FULL</span><br><span class="line">   40:FULL   41:FULL   42:FULL   43:FULL</span><br><span class="line">   44:FULL   45:FULL   46:FULL   47:FULL</span><br><span class="line">   48:FULL   49:FULL   50:FULL   51:FULL</span><br><span class="line">   52:FULL   53:FULL   54:FULL   55:FULL</span><br><span class="line">   56:FULL   57:FULL   58:FULL   59:FULL</span><br><span class="line">   60:FULL   61:FULL   62:FULL   63:FULL</span><br><span class="line">   64:FULL   65:FULL   66:FULL   67:FULL</span><br><span class="line">   68:FULL   69:FULL   70:FULL   71:FULL</span><br><span class="line">   72:FULL   73:FULL   74:FULL   75:FULL</span><br><span class="line">   76:FULL   77:FULL   78:FULL   79:FULL</span><br><span class="line">   80:FULL   81:FULL   82:FULL   83:FULL</span><br><span class="line">   84:FULL   85:FULL   86:FULL   87:FULL</span><br><span class="line">   88:FULL   89:FULL   90:FULL   91:FULL</span><br><span class="line">   92:FULL   93:FULL   94:FULL   95:FULL</span><br><span class="line">   96:FULL   97:FULL   98:FULL   99:FULL</span><br><span class="line">   100:FULL   101:FULL   102:FULL   103:FULL</span><br><span class="line">   104:FULL   105:FULL   106:FULL   107:FULL</span><br><span class="line">   108:FULL   109:FULL   110:FULL   111:FULL</span><br><span class="line">   112:FULL   113:FULL   114:FULL   115:FULL</span><br><span class="line">   116:FULL   117:FULL   118:FULL   119:FULL</span><br><span class="line">   120:FULL   121:FULL   122:FULL   123:FULL</span><br><span class="line">   124:FULL   125:FULL   126:FULL   127:FULL</span><br><span class="line">   128:unformatted   129:unformatted   130:unformatted   131:unformatted</span><br><span class="line">   132:unformatted   133:unformatted   134:unformatted   135:unformatted</span><br><span class="line">   136:unformatted   137:unformatted   138:unformatted   139:unformatted</span><br><span class="line">   140:unformatted   141:unformatted   142:unformatted   143:unformatted</span><br><span class="line">   144:75-100% free   145:75-100% free   146:75-100% free   147:75-100% free</span><br><span class="line">   148:75-100% free   149:75-100% free   150:75-100% free   151:75-100% free</span><br><span class="line">   152:75-100% free   153:75-100% free   154:75-100% free   155:FULL</span><br><span class="line">   156:75-100% free   157:75-100% free   158:75-100% free   159:75-100% free</span><br><span class="line">   160:75-100% free   161:75-100% free   162:75-100% free   163:FULL</span><br><span class="line">   164:75-100% free   165:75-100% free   166:75-100% free   167:75-100% free</span><br><span class="line">   168:75-100% free   169:75-100% free   170:75-100% free   171:75-100% free</span><br><span class="line">   172:75-100% free   173:75-100% free   174:75-100% free   175:75-100% free</span><br><span class="line">   176:unformatted   177:unformatted   178:unformatted   179:unformatted</span><br><span class="line">   180:unformatted   181:unformatted   182:unformatted   183:unformatted</span><br><span class="line">   184:unformatted   185:unformatted   186:unformatted   187:unformatted</span><br><span class="line">   188:unformatted   189:unformatted   190:unformatted   191:unformatted</span><br><span class="line">   192:unformatted   193:unformatted   194:unformatted   195:unformatted</span><br><span class="line">   196:unformatted   197:unformatted   198:unformatted   199:unformatted</span><br><span class="line">   200:unformatted   201:unformatted   202:unformatted   203:unformatted</span><br><span class="line">   204:unformatted   205:unformatted   206:unformatted   207:unformatted</span><br><span class="line">   208:unformatted   209:unformatted   210:unformatted   211:unformatted</span><br><span class="line">   212:unformatted   213:unformatted   214:unformatted   215:unformatted</span><br><span class="line">   216:unformatted   217:unformatted   218:unformatted   219:unformatted</span><br><span class="line">   220:unformatted   221:unformatted   222:unformatted   223:unformatted</span><br><span class="line">   224:unformatted   225:unformatted   226:unformatted   227:unformatted</span><br><span class="line">   228:unformatted   229:unformatted   230:unformatted   231:unformatted</span><br><span class="line">   232:unformatted   233:unformatted   234:unformatted   235:unformatted</span><br><span class="line">   236:unformatted   237:unformatted   238:unformatted   239:unformatted</span><br><span class="line">   240:unformatted   241:unformatted   242:unformatted   243:unformatted</span><br><span class="line">   244:unformatted   245:unformatted   246:unformatted   247:unformatted</span><br><span class="line">   248:unformatted   249:unformatted   250:unformatted   251:unformatted</span><br><span class="line">   252:unformatted   253:unformatted   254:unformatted   255:unformatted</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 8192 maxblk 8192</span><br></pre></td></tr></table></figure>

<blockquote>
<p>完蛋了，计算错误，L1下面的第二个区也已经被格式化了，看段头信息</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Extent Control Header</span><br><span class="line">  -----------------------------------------------------------------</span><br><span class="line">  Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928</span><br><span class="line">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class="line">      Highwater::  0x01402100  ext#: 64     blk#: 128    ext size: 128   </span><br><span class="line">  #blocks in seg. hdr&#x27;s freelists: 0     </span><br><span class="line">  #blocks below: 8191  </span><br><span class="line">  mapblk  0x00000000  offset: 64   </span><br></pre></td></tr></table></figure>

<blockquote>
<p>果然高水位指到了第66个区的L1块地址，这会影响我们的判断，到底哪里出问题了呢？观察8192号块内容是后128个块里被插入了2条，前128个块全满，也就是说我多插了130个块，后来猛然醒悟，我使用DBA来计算的，忘记减去128个块的文件头了，这么一算结果相查差还是不大的，太马虎了，要不是因为马虎哥也能上清华北大了；然后该怎么办呢？重新来过？不用！既然这个L1推过头了，索性把它堆满，然后我们去观察下一个L1，这下就好计算了；</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span></span><br><span class="line">i number;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.126</span> loop</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> lp <span class="keyword">values</span>(i,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="keyword">end</span> loop;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"><span class="operator">/</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>观察8192号块</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"> DBA Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x01402000  Length: 128    Offset: 0      </span><br><span class="line">   0x01402080  Length: 128    Offset: 128    </span><br><span class="line"></span><br><span class="line">   0:Metadata   1:FULL   2:FULL   3:FULL</span><br><span class="line">   4:FULL   5:FULL   6:FULL   7:FULL</span><br><span class="line">   8:FULL   9:FULL   10:FULL   11:FULL</span><br><span class="line">   12:FULL   13:FULL   14:FULL   15:FULL</span><br><span class="line">   16:FULL   17:FULL   18:FULL   19:FULL</span><br><span class="line">   20:FULL   21:FULL   22:FULL   23:FULL</span><br><span class="line">   24:FULL   25:FULL   26:FULL   27:FULL</span><br><span class="line">   28:FULL   29:FULL   30:FULL   31:FULL</span><br><span class="line">   32:FULL   33:FULL   34:FULL   35:FULL</span><br><span class="line">   36:FULL   37:FULL   38:FULL   39:FULL</span><br><span class="line">   40:FULL   41:FULL   42:FULL   43:FULL</span><br><span class="line">   44:FULL   45:FULL   46:FULL   47:FULL</span><br><span class="line">   48:FULL   49:FULL   50:FULL   51:FULL</span><br><span class="line">   52:FULL   53:FULL   54:FULL   55:FULL</span><br><span class="line">   56:FULL   57:FULL   58:FULL   59:FULL</span><br><span class="line">   60:FULL   61:FULL   62:FULL   63:FULL</span><br><span class="line">   64:FULL   65:FULL   66:FULL   67:FULL</span><br><span class="line">   68:FULL   69:FULL   70:FULL   71:FULL</span><br><span class="line">   72:FULL   73:FULL   74:FULL   75:FULL</span><br><span class="line">   76:FULL   77:FULL   78:FULL   79:FULL</span><br><span class="line">   80:FULL   81:FULL   82:FULL   83:FULL</span><br><span class="line">   84:FULL   85:FULL   86:FULL   87:FULL</span><br><span class="line">   88:FULL   89:FULL   90:FULL   91:FULL</span><br><span class="line">   92:FULL   93:FULL   94:FULL   95:FULL</span><br><span class="line">   96:FULL   97:FULL   98:FULL   99:FULL</span><br><span class="line">   100:FULL   101:FULL   102:FULL   103:FULL</span><br><span class="line">   104:FULL   105:FULL   106:FULL   107:FULL</span><br><span class="line">   108:FULL   109:FULL   110:FULL   111:FULL</span><br><span class="line">   112:FULL   113:FULL   114:FULL   115:FULL</span><br><span class="line">   116:FULL   117:FULL   118:FULL   119:FULL</span><br><span class="line">   120:FULL   121:FULL   122:FULL   123:FULL</span><br><span class="line">   124:FULL   125:FULL   126:FULL   127:FULL</span><br><span class="line">   128:FULL   129:FULL   130:FULL   131:FULL</span><br><span class="line">   132:FULL   133:FULL   134:FULL   135:FULL</span><br><span class="line">   136:FULL   137:FULL   138:FULL   139:FULL</span><br><span class="line">   140:FULL   141:FULL   142:FULL   143:FULL</span><br><span class="line">   144:FULL   145:FULL   146:FULL   147:FULL</span><br><span class="line">   148:FULL   149:FULL   150:FULL   151:FULL</span><br><span class="line">   152:FULL   153:FULL   154:FULL   155:FULL</span><br><span class="line">   156:FULL   157:FULL   158:FULL   159:FULL</span><br><span class="line">   160:FULL   161:FULL   162:FULL   163:FULL</span><br><span class="line">   164:FULL   165:FULL   166:FULL   167:FULL</span><br><span class="line">   168:FULL   169:FULL   170:FULL   171:FULL</span><br><span class="line">   172:FULL   173:FULL   174:FULL   175:FULL</span><br><span class="line">   176:FULL   177:FULL   178:FULL   179:FULL</span><br><span class="line">   180:FULL   181:FULL   182:FULL   183:FULL</span><br><span class="line">   184:FULL   185:FULL   186:FULL   187:FULL</span><br><span class="line">   188:FULL   189:FULL   190:FULL   191:FULL</span><br><span class="line">   192:FULL   193:FULL   194:FULL   195:FULL</span><br><span class="line">   196:FULL   197:FULL   198:FULL   199:FULL</span><br><span class="line">   200:FULL   201:FULL   202:FULL   203:FULL</span><br><span class="line">   204:FULL   205:FULL   206:FULL   207:FULL</span><br><span class="line">   208:FULL   209:FULL   210:FULL   211:FULL</span><br><span class="line">   212:FULL   213:FULL   214:FULL   215:FULL</span><br><span class="line">   216:FULL   217:FULL   218:FULL   219:FULL</span><br><span class="line">   220:FULL   221:FULL   222:FULL   223:FULL</span><br><span class="line">   224:FULL   225:FULL   226:FULL   227:FULL</span><br><span class="line">   228:FULL   229:FULL   230:FULL   231:FULL</span><br><span class="line">   232:FULL   233:FULL   234:FULL   235:FULL</span><br><span class="line">   236:FULL   237:FULL   238:FULL   239:FULL</span><br><span class="line">   240:FULL   241:FULL   242:FULL   243:FULL</span><br><span class="line">   244:FULL   245:FULL   246:FULL   247:FULL</span><br><span class="line">   248:FULL   249:FULL   250:FULL   251:FULL</span><br><span class="line">   252:FULL   253:FULL   254:FULL   255:FULL</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 8192 maxblk 8192</span><br></pre></td></tr></table></figure>

<blockquote>
<p>已经全满了，这个时候我们再去看一下段头的高水位</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Extent Control Header</span><br><span class="line"> -----------------------------------------------------------------</span><br><span class="line"> Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928</span><br><span class="line">                 last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class="line">     Highwater::  0x01402100  ext#: 64     blk#: 128    ext size: 128   </span><br><span class="line"> #blocks in seg. hdr&#x27;s freelists: 0     </span><br><span class="line"> #blocks below: 8191  </span><br><span class="line"> mapblk  0x00000000  offset: 64</span><br></pre></td></tr></table></figure>

<blockquote>
<p>没有动，看来oracle也是事不到眼前不知道着急啊，来看一看下一个L1</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> dbms_utility.data_block_address_file(to_number(<span class="string">&#x27;01402100&#x27;</span>, <span class="string">&#x27;xxxxxxxx&#x27;</span>)) file#,</span><br><span class="line">  <span class="number">2</span> dbms_utility.data_block_address_block(to_number(<span class="string">&#x27;01402100&#x27;</span>, <span class="string">&#x27;xxxxxxxx&#x27;</span>)) block#</span><br><span class="line">  <span class="number">3</span> <span class="keyword">from</span> dual;</span><br><span class="line"></span><br><span class="line">     FILE# BLOCK#</span><br><span class="line"><span class="comment">---------- ----------</span></span><br><span class="line">         <span class="number">5</span> <span class="number">8448</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>这个L1是5号文件8448号块，dump出来</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"> DBA Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x01402100  Length: 128    Offset: 0      </span><br><span class="line">   0x01402180  Length: 128    Offset: 128    </span><br><span class="line"></span><br><span class="line">   0:Metadata   1:unformatted   2:unformatted   3:unformatted</span><br><span class="line">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class="line">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class="line">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class="line">   16:unformatted   17:unformatted   18:unformatted   19:unformatted</span><br><span class="line">   20:unformatted   21:unformatted   22:unformatted   23:unformatted</span><br><span class="line">   24:unformatted   25:unformatted   26:unformatted   27:unformatted</span><br><span class="line">   28:unformatted   29:unformatted   30:unformatted   31:unformatted</span><br><span class="line">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class="line">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class="line">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class="line">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class="line">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class="line">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class="line">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class="line">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class="line">   64:unformatted   65:unformatted   66:unformatted   67:unformatted</span><br><span class="line">   68:unformatted   69:unformatted   70:unformatted   71:unformatted</span><br><span class="line">   72:unformatted   73:unformatted   74:unformatted   75:unformatted</span><br><span class="line">   76:unformatted   77:unformatted   78:unformatted   79:unformatted</span><br><span class="line">   80:unformatted   81:unformatted   82:unformatted   83:unformatted</span><br><span class="line">   84:unformatted   85:unformatted   86:unformatted   87:unformatted</span><br><span class="line">   88:unformatted   89:unformatted   90:unformatted   91:unformatted</span><br><span class="line">   92:unformatted   93:unformatted   94:unformatted   95:unformatted</span><br><span class="line">   96:unformatted   97:unformatted   98:unformatted   99:unformatted</span><br><span class="line">   100:unformatted   101:unformatted   102:unformatted   103:unformatted</span><br><span class="line">   104:unformatted   105:unformatted   106:unformatted   107:unformatted</span><br><span class="line">   108:unformatted   109:unformatted   110:unformatted   111:unformatted</span><br><span class="line">   112:unformatted   113:unformatted   114:unformatted   115:unformatted</span><br><span class="line">   116:unformatted   117:unformatted   118:unformatted   119:unformatted</span><br><span class="line">   120:unformatted   121:unformatted   122:unformatted   123:unformatted</span><br><span class="line">   124:unformatted   125:unformatted   126:unformatted   127:unformatted</span><br><span class="line">   128:unformatted   129:unformatted   130:unformatted   131:unformatted</span><br><span class="line">   132:unformatted   133:unformatted   134:unformatted   135:unformatted</span><br><span class="line">   136:unformatted   137:unformatted   138:unformatted   139:unformatted</span><br><span class="line">   140:unformatted   141:unformatted   142:unformatted   143:unformatted</span><br><span class="line">   144:unformatted   145:unformatted   146:unformatted   147:unformatted</span><br><span class="line">   148:unformatted   149:unformatted   150:unformatted   151:unformatted</span><br><span class="line">   152:unformatted   153:unformatted   154:unformatted   155:unformatted</span><br><span class="line">   156:unformatted   157:unformatted   158:unformatted   159:unformatted</span><br><span class="line">   160:unformatted   161:unformatted   162:unformatted   163:unformatted</span><br><span class="line">   164:unformatted   165:unformatted   166:unformatted   167:unformatted</span><br><span class="line">   168:unformatted   169:unformatted   170:unformatted   171:unformatted</span><br><span class="line">   172:unformatted   173:unformatted   174:unformatted   175:unformatted</span><br><span class="line">   176:unformatted   177:unformatted   178:unformatted   179:unformatted</span><br><span class="line">   180:unformatted   181:unformatted   182:unformatted   183:unformatted</span><br><span class="line">   184:unformatted   185:unformatted   186:unformatted   187:unformatted</span><br><span class="line">   188:unformatted   189:unformatted   190:unformatted   191:unformatted</span><br><span class="line">   192:unformatted   193:unformatted   194:unformatted   195:unformatted</span><br><span class="line">   196:unformatted   197:unformatted   198:unformatted   199:unformatted</span><br><span class="line">   200:unformatted   201:unformatted   202:unformatted   203:unformatted</span><br><span class="line">   204:unformatted   205:unformatted   206:unformatted   207:unformatted</span><br><span class="line">   208:unformatted   209:unformatted   210:unformatted   211:unformatted</span><br><span class="line">   212:unformatted   213:unformatted   214:unformatted   215:unformatted</span><br><span class="line">   216:unformatted   217:unformatted   218:unformatted   219:unformatted</span><br><span class="line">   220:unformatted   221:unformatted   222:unformatted   223:unformatted</span><br><span class="line">   224:unformatted   225:unformatted   226:unformatted   227:unformatted</span><br><span class="line">   228:unformatted   229:unformatted   230:unformatted   231:unformatted</span><br><span class="line">   232:unformatted   233:unformatted   234:unformatted   235:unformatted</span><br><span class="line">   236:unformatted   237:unformatted   238:unformatted   239:unformatted</span><br><span class="line">   240:unformatted   241:unformatted   242:unformatted   243:unformatted</span><br><span class="line">   244:unformatted   245:unformatted   246:unformatted   247:unformatted</span><br><span class="line">   248:unformatted   249:unformatted   250:unformatted   251:unformatted</span><br><span class="line">   252:unformatted   253:unformatted   254:unformatted   255:unformatted</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 8448 maxblk 8448</span><br></pre></td></tr></table></figure>

<blockquote>
<p>256个块，除了第一个是L1元数据之外，没有一个格式化的，这就达到了我们的目的，我现在要插入一条数据，迫使高水位推动，猜一下高水位会在哪？在L1管理的最后一个块后面么？<br>看插入一行数据之后的8448号块</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">DBA Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x01402100  Length: 128    Offset: 0      </span><br><span class="line">   0x01402180  Length: 128    Offset: 128    </span><br><span class="line"></span><br><span class="line">   0:Metadata   1:unformatted   2:unformatted   3:unformatted</span><br><span class="line">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class="line">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class="line">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class="line">   16:75-100% free   17:75-100% free   18:75-100% free   19:75-100% free</span><br><span class="line">   20:75-100% free   21:75-100% free   22:75-100% free   23:75-100% free</span><br><span class="line">   24:75-100% free   25:75-100% free   26:75-100% free   27:75-100% free</span><br><span class="line">   28:FULL   29:75-100% free   30:75-100% free   31:75-100% free</span><br><span class="line">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class="line">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class="line">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class="line">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class="line">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class="line">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class="line">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class="line">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class="line">   64:unformatted   65:unformatted   66:unformatted   67:unformatted</span><br><span class="line">   68:unformatted   69:unformatted   70:unformatted   71:unformatted</span><br><span class="line">   72:unformatted   73:unformatted   74:unformatted   75:unformatted</span><br><span class="line">   76:unformatted   77:unformatted   78:unformatted   79:unformatted</span><br><span class="line">   80:unformatted   81:unformatted   82:unformatted   83:unformatted</span><br><span class="line">   84:unformatted   85:unformatted   86:unformatted   87:unformatted</span><br><span class="line">   88:unformatted   89:unformatted   90:unformatted   91:unformatted</span><br><span class="line">   92:unformatted   93:unformatted   94:unformatted   95:unformatted</span><br><span class="line">   96:unformatted   97:unformatted   98:unformatted   99:unformatted</span><br><span class="line">   100:unformatted   101:unformatted   102:unformatted   103:unformatted</span><br><span class="line">   104:unformatted   105:unformatted   106:unformatted   107:unformatted</span><br><span class="line">   108:unformatted   109:unformatted   110:unformatted   111:unformatted</span><br><span class="line">   112:unformatted   113:unformatted   114:unformatted   115:unformatted</span><br><span class="line">   116:unformatted   117:unformatted   118:unformatted   119:unformatted</span><br><span class="line">   120:unformatted   121:unformatted   122:unformatted   123:unformatted</span><br><span class="line">   124:unformatted   125:unformatted   126:unformatted   127:unformatted</span><br><span class="line">   128:unformatted   129:unformatted   130:unformatted   131:unformatted</span><br><span class="line">   132:unformatted   133:unformatted   134:unformatted   135:unformatted</span><br><span class="line">   136:unformatted   137:unformatted   138:unformatted   139:unformatted</span><br><span class="line">   140:unformatted   141:unformatted   142:unformatted   143:unformatted</span><br><span class="line">   144:unformatted   145:unformatted   146:unformatted   147:unformatted</span><br><span class="line">   148:unformatted   149:unformatted   150:unformatted   151:unformatted</span><br><span class="line">   152:unformatted   153:unformatted   154:unformatted   155:unformatted</span><br><span class="line">   156:unformatted   157:unformatted   158:unformatted   159:unformatted</span><br><span class="line">   160:unformatted   161:unformatted   162:unformatted   163:unformatted</span><br><span class="line">   164:unformatted   165:unformatted   166:unformatted   167:unformatted</span><br><span class="line">   168:unformatted   169:unformatted   170:unformatted   171:unformatted</span><br><span class="line">   172:unformatted   173:unformatted   174:unformatted   175:unformatted</span><br><span class="line">   176:unformatted   177:unformatted   178:unformatted   179:unformatted</span><br><span class="line">   180:unformatted   181:unformatted   182:unformatted   183:unformatted</span><br><span class="line">   184:unformatted   185:unformatted   186:unformatted   187:unformatted</span><br><span class="line">   188:unformatted   189:unformatted   190:unformatted   191:unformatted</span><br><span class="line">   192:unformatted   193:unformatted   194:unformatted   195:unformatted</span><br><span class="line">   196:unformatted   197:unformatted   198:unformatted   199:unformatted</span><br><span class="line">   200:unformatted   201:unformatted   202:unformatted   203:unformatted</span><br><span class="line">   204:unformatted   205:unformatted   206:unformatted   207:unformatted</span><br><span class="line">   208:unformatted   209:unformatted   210:unformatted   211:unformatted</span><br><span class="line">   212:unformatted   213:unformatted   214:unformatted   215:unformatted</span><br><span class="line">   216:unformatted   217:unformatted   218:unformatted   219:unformatted</span><br><span class="line">   220:unformatted   221:unformatted   222:unformatted   223:unformatted</span><br><span class="line">   224:unformatted   225:unformatted   226:unformatted   227:unformatted</span><br><span class="line">   228:unformatted   229:unformatted   230:unformatted   231:unformatted</span><br><span class="line">   232:unformatted   233:unformatted   234:unformatted   235:unformatted</span><br><span class="line">   236:unformatted   237:unformatted   238:unformatted   239:unformatted</span><br><span class="line">   240:unformatted   241:unformatted   242:unformatted   243:unformatted</span><br><span class="line">   244:unformatted   245:unformatted   246:unformatted   247:unformatted</span><br><span class="line">   248:unformatted   249:unformatted   250:unformatted   251:unformatted</span><br><span class="line">   252:unformatted   253:unformatted   254:unformatted   255:unformatted</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 8448 maxblk 8448</span><br></pre></td></tr></table></figure>

<blockquote>
<p>有一个块已经满了，揭晓答案的时候来了，dump出段头</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Extent Control Header</span><br><span class="line">  -----------------------------------------------------------------</span><br><span class="line">  Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928</span><br><span class="line">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class="line">      Highwater::  0x01402180  ext#: 65     blk#: 128    ext size: 128   </span><br><span class="line">  #blocks in seg. hdr&#x27;s freelists: 0     </span><br><span class="line">  #blocks below: 8318  </span><br><span class="line">  mapblk  0x00000000  offset: 65</span><br></pre></td></tr></table></figure>

<blockquote>
<p>高水位是0x01402180，这个地址在哪呢？0x01402180比0x01402100多了十六进制80个块，就是十进制的128个块，仅仅是推动了一个区的大小，并不是一个L1的大小，这说明常规路径下插入高水位的推动是以L1和区中小的那个单位来推动的，就是L1小就推动L1里面所有块的大小，区小就推动一个区的大小，可见所谓的高并发并非像宣传的那样，还是受高水位的限制的，这个时候的区块大概像下面这个样子：</p>
</blockquote>
<p><img data-src="http://qiniu.liupzmin.com/%E6%89%A9%E5%B1%95%E7%9A%84L1.png"></p>
<blockquote>
<p>开几个session做下插入试试</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) <span class="keyword">from</span> lp <span class="keyword">where</span> <span class="built_in">trim</span>(des1)<span class="operator">=</span><span class="string">&#x27;b&#x27;</span>;</span><br><span class="line"></span><br><span class="line">                                   <span class="number">5</span>                                 <span class="number">8474</span></span><br><span class="line">                                   <span class="number">5</span>                                 <span class="number">8482</span></span><br><span class="line">                                   <span class="number">5</span>                                 <span class="number">8484</span></span><br><span class="line">                                   <span class="number">5</span>                                 <span class="number">8488</span></span><br><span class="line">                                   <span class="number">5</span>                                 <span class="number">8489</span></span><br><span class="line">                                   <span class="number">5</span>                                 <span class="number">8490</span></span><br><span class="line">                                   <span class="number">5</span>                                 <span class="number">8491</span></span><br><span class="line">                                   <span class="number">5</span>                                 <span class="number">8492</span></span><br><span class="line">                                   <span class="number">5</span>                                 <span class="number">8493</span></span><br><span class="line">                                   <span class="number">5</span>                                 <span class="number">8494</span></span><br><span class="line">                                   <span class="number">5</span>                                 <span class="number">8495</span></span><br><span class="line">                                   <span class="number">5</span>                                 <span class="number">8496</span></span><br><span class="line">                                   <span class="number">5</span>                                 <span class="number">8498</span></span><br><span class="line">                                   <span class="number">5</span>                                 <span class="number">8500</span></span><br><span class="line">                                   <span class="number">5</span>                                 <span class="number">8504</span></span><br><span class="line">                                   <span class="number">5</span>                                 <span class="number">8506</span></span><br><span class="line">                                   <span class="number">5</span>                                 <span class="number">8512</span></span><br><span class="line">                                   <span class="number">5</span>                                 <span class="number">8514</span></span><br><span class="line">                                   <span class="number">5</span>                                 <span class="number">8520</span></span><br><span class="line">                                   <span class="number">5</span>                                 <span class="number">8522</span></span><br><span class="line"></span><br><span class="line"><span class="number">20</span> <span class="keyword">rows</span> selected.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>全部是在高水位之下<br>这个实验有一点值得思考，就是PCTFREE如何设置，在插入删除频繁的段，PCTFREE的值应该要远离三个百分比线，就是25%&#x2F;50%&#x2F;75%，避免频繁插入删除的时候块状态频繁改变，由full变为非full，如此就会修改L1块的内容，有可能造成buffer busy waits。<br>而大家熟知的直接路径下的插入是直接在高水位之上插入并且绕过cache buffer的，这种情况下的高水位是如何推动的呢？我们再慢慢分析.</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2015/09/23/oracle/backup-restore/RMAN-diff-svr-dir-full-re/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/gzh.jpg">
      <meta itemprop="name" content="巴流">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
      <meta itemprop="description" content="左手人文 | 右手科技">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 兔子先生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2015/09/23/oracle/backup-restore/RMAN-diff-svr-dir-full-re/" class="post-title-link" itemprop="url">RMAN异机异目录完全恢复</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-09-23 11:04:00" itemprop="dateCreated datePublished" datetime="2015-09-23T11:04:00+08:00">2015-09-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-07 09:32:12" itemprop="dateModified" datetime="2025-02-07T09:32:12+08:00">2025-02-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oracle-backup/" itemprop="url" rel="index"><span itemprop="name">oracle backup</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>开始</p>
</blockquote>
<p>先说一下为什么要写这个异机完全恢复的blog，作为一个年轻的DBA，相信大多数都是备份长做而恢复不常做，我会经常担心我的生产库的服务器挂了怎么办，我的备份完好，但我们又没有容灾，我能否保证我的数据不丢失呢，所以就要rman利用备份重建，而如果此时我能找到完好无损的在线日志，我是不是可以完全恢复了呢，理论上大家都说可以，确从未在网上见到过完全恢复的事例（完全其实很简单，只是网上阐述了太多的不完全恢复，会让我觉得set until time等等是必备的其中一步），甚至oracle的官方网文档上也使用了“SET UNTIL SCN 123456;” 的案例，有鉴于此，我做了这个实验，并记录下来，跟大家分享，不见得这篇原创有多高深的技术和见解O(∩_∩)O</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">环境：</span><br><span class="line">    源库：</span><br><span class="line">        os：redhat 6.3 x64</span><br><span class="line">        db: 11gr2 11.2.0.4</span><br><span class="line">        存储方式：ASM</span><br><span class="line">    目标库：</span><br><span class="line">        os：redhat 6.5 x64</span><br><span class="line">        db: 11gr2 11.2.0.4</span><br><span class="line">        存储方式：文件系统</span><br></pre></td></tr></table></figure>

<h2 id="1-首先，源库进行rman备份"><a href="#1-首先，源库进行rman备份" class="headerlink" title="1. 首先，源库进行rman备份"></a>1. 首先，源库进行rman备份</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--手动0级全库备份</span></span><br><span class="line">run &#123;</span><br><span class="line">    CONFIGURE RETENTION POLICY <span class="keyword">TO</span> RECOVERY <span class="keyword">WINDOW</span> <span class="keyword">OF</span> <span class="number">7</span> DAYS;</span><br><span class="line">    CONFIGURE BACKUP OPTIMIZATION <span class="keyword">ON</span>;</span><br><span class="line">    CONFIGURE CONTROLFILE AUTOBACKUP <span class="keyword">ON</span>;</span><br><span class="line">    CONFIGURE DEVICE TYPE DISK PARALLELISM <span class="number">4</span> BACKUP TYPE <span class="keyword">TO</span> BACKUPSET;</span><br><span class="line">    CONFIGURE CONTROLFILE AUTOBACKUP FORMAT <span class="keyword">FOR</span> DEVICE TYPE DISK <span class="keyword">TO</span> <span class="string">&#x27;+DATA/backup/ctl_atuo_%F&#x27;</span>;</span><br><span class="line">    <span class="keyword">ALLOCATE</span> CHANNEL c1 TYPE DISK;</span><br><span class="line">    <span class="keyword">ALLOCATE</span> CHANNEL c2 TYPE DISK;</span><br><span class="line">    CROSSCHECK ARCHIVELOG <span class="keyword">ALL</span>;</span><br><span class="line">    BACKUP INCREMENTAL LEVEL <span class="number">0</span></span><br><span class="line">    DATABASE FORMAT <span class="string">&#x27;+DATA/backup/db_%U&#x27;</span> TAG <span class="string">&#x27;db_rman&#x27;</span>;</span><br><span class="line">    <span class="keyword">SQL</span> <span class="string">&#x27;ALTER SYSTEM ARCHIVE LOG CURRENT&#x27;</span>;</span><br><span class="line">    BACKUP ARCHIVELOG <span class="keyword">ALL</span> FORMAT <span class="string">&#x27;+DATA/backup/arc_%U&#x27;</span> TAG <span class="string">&#x27;ARC_rman&#x27;</span></span><br><span class="line">    <span class="keyword">DELETE</span> INPUT;</span><br><span class="line">    <span class="keyword">DELETE</span> NOPROMPT OBSOLETE;</span><br><span class="line">    <span class="keyword">RELEASE</span> CHANNEL c1;</span><br><span class="line">    <span class="keyword">RELEASE</span> CHANNEL c2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2015/09/23/oracle/backup-restore/RMAN-diff-svr-dir-full-re/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2014/07/22/oracle/architecture/linux-oracle-comp-list/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/gzh.jpg">
      <meta itemprop="name" content="巴流">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
      <meta itemprop="description" content="左手人文 | 右手科技">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 兔子先生">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2014/07/22/oracle/architecture/linux-oracle-comp-list/" class="post-title-link" itemprop="url">linux+oracle兼容列表</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2014-07-22 15:10:00" itemprop="dateCreated datePublished" datetime="2014-07-22T15:10:00+08:00">2014-07-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-07 09:32:12" itemprop="dateModified" datetime="2025-02-07T09:32:12+08:00">2025-02-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/oracle/" itemprop="url" rel="index"><span itemprop="name">oracle</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>linux+oracle兼容列表</p>
</blockquote>
<p><img data-src="http://qiniu.liupzmin.com/linux+oracle%E5%85%BC%E5%AE%B9%E5%88%97%E8%A1%A8.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2014 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">NexT</span>
</div>
  <div class="powered-by">由 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZw==">NexT.Gemini</span> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xpdXB6bWlu" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js" integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  


  <script src="/js/third-party/fancybox.js"></script>


  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"liupzmin","repo":"liupzmin.github.io","client_id":"77654195445087c01c56","client_secret":"eda09eecd05b86f0ef995d8067ec751abeb753d9","admin_user":"liupzmin","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","ClientID":"ae0756501dfc5de89d35","ClientSecret":"26befb359f7a466031bb96b4b7e0715c41c63fb8","owner":"liupzmin","adminUser":"['liupzmin']","labels":"['Gitalk']","perPage":15,"pagerDirection":"last","createIssueManually":true,"distractionFreeMode":false,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"93ccefe6fa5dc946637b27eeb51ad55c"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
