<!DOCTYPE html>













<html class="theme-next gemini" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












  <meta name="yandex-verification" content="3ac9ae36ddebb425">





  
  
  <link rel="stylesheet" href="/lib/fancybox/source/jquery.fancybox.css">







<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">

<link rel="stylesheet" href="/css/main.css?v=7.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.2.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.2.0',
    sidebar: {"onmobile":true},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    copycode: {"enable":false,"show_result":false,"style":"flat"},
    fancybox: true,
    fastclick: false,
    lazyload: true,
    tabs: true,
    motion: {"enable":false,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    }
  };
</script>

  <meta name="description" content="左手人文 | 右手科技">
<meta property="og:type" content="website">
<meta property="og:title" content="兔子先生">
<meta property="og:url" content="http://liupzmin.com/index.html">
<meta property="og:site_name" content="兔子先生">
<meta property="og:description" content="左手人文 | 右手科技">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="兔子先生">
<meta name="twitter:description" content="左手人文 | 右手科技">





  
  
  <link rel="canonical" href="http://liupzmin.com/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  
  <title>兔子先生 - 一只兔子的幸福生活</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  

  <div class="container 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">兔子先生</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">一只兔子的幸福生活</h1>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档<span class="badge">8</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签<span class="badge">4</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类<span class="badge">3</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



</div>
    </header>

    
  
  

  

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xpdXB6bWlu" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></span>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2019/07/21/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="巴流">
      <meta itemprop="description" content="左手人文 | 右手科技">
      <meta itemprop="image" content="/images/heizi.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/21/hello-world/" class="post-title-link" itemprop="url">Hello World</a>
              
            
          </h2>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-07-21 09:59:50" itemprop="dateCreated datePublished" datetime="2019-07-21T09:59:50+08:00">2019-07-21</time>
            </span>
          

          

          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Welcome to <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlvLw==" title="https://hexo.io/">Hexo<i class="fa fa-external-link"></i></span>! This is your very first post. Check <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlvL2RvY3Mv" title="https://hexo.io/docs/">documentation<i class="fa fa-external-link"></i></span> for more info. If you get any problems when using Hexo, you can find the answer in <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlvL2RvY3MvdHJvdWJsZXNob290aW5nLmh0bWw=" title="https://hexo.io/docs/troubleshooting.html">troubleshooting<i class="fa fa-external-link"></i></span> or you can ask me on <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2hleG9qcy9oZXhvL2lzc3Vlcw==" title="https://github.com/hexojs/hexo/issues">GitHub<i class="fa fa-external-link"></i></span>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>

<p>More info: <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvd3JpdGluZy5odG1s" title="https://hexo.io/docs/writing.html">Writing<i class="fa fa-external-link"></i></span></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvc2VydmVyLmh0bWw=" title="https://hexo.io/docs/server.html">Server<i class="fa fa-external-link"></i></span></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlvL2RvY3MvZ2VuZXJhdGluZy5odG1s" title="https://hexo.io/docs/generating.html">Generating<i class="fa fa-external-link"></i></span></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlvL2RvY3MvZGVwbG95bWVudC5odG1s" title="https://hexo.io/docs/deployment.html">Deployment<i class="fa fa-external-link"></i></span></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Test</span><span class="params">()</span></span>&#123;</span><br><span class="line">  a := <span class="number">1</span></span><br><span class="line">  fmt.printf(<span class="string">"Hello GoLang!"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2017/07/01/oracle/backup-restore/dbms_scheduler-for-rman-backup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="巴流">
      <meta itemprop="description" content="左手人文 | 右手科技">
      <meta itemprop="image" content="/images/heizi.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/07/01/oracle/backup-restore/dbms_scheduler-for-rman-backup/" class="post-title-link" itemprop="url">利用DBMS_SCHEDULER在Oracle 11gR2 RAC上执行rman备份</a>
              
            
          </h2>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-07-01 11:04:00" itemprop="dateCreated datePublished" datetime="2017-07-01T11:04:00+08:00">2017-07-01</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-21 12:43:08" itemprop="dateModified" datetime="2019-07-21T12:43:08+08:00">2019-07-21</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/oracle-backup/" itemprop="url" rel="index"><span itemprop="name">oracle backup</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="利用DBMS-SCHEDULER在Oracle-11gR2-RAC上执行rman备份"><a href="#利用DBMS-SCHEDULER在Oracle-11gR2-RAC上执行rman备份" class="headerlink" title="利用DBMS_SCHEDULER在Oracle 11gR2 RAC上执行rman备份"></a>利用DBMS_SCHEDULER在Oracle 11gR2 RAC上执行rman备份</h1><p>RMAN backup in Oracle 11gR2 RAC is exactly same like RMAN backup in Oracle 11gR2 single node.<br>The only difference is: Typically, in case of Oracle single node database, we will schedule RMAN scripts with the help of CRON job and it will run according to our convenience, but in case of Oracle RAC if we schedule RMAN script and if unfortunately that RAC node goes down ( where we configured RMAN scripts ), then RMAN backup won’t run obviously.</p>
<p>So, Same strategy will not be work in Oracle RAC node. For RMAN consistent backups use dbms_scheduler &amp; we need to place RMAN scripts in shared directory. ( Or in my case, I have created identical scripts on both cluster node’s )</p>
<p><strong>注意：</strong>  <em>需要将脚本放在共享位置或者每个节点的相同位置</em></p>
<blockquote>
<p>看一下rman的备份脚本，此脚本将备份放在ASM中，将日志放在节点本地</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">################################################################</span><br><span class="line">#    rman_backup_rac.sh FOR RAC                                #</span><br><span class="line">#    created by lp                                             #</span><br><span class="line">#    2017/03/22                                                #</span><br><span class="line">#    usage: rman_backup_rac.sh &lt;$BACKUP_LEVEL&gt;                 #</span><br><span class="line">#           BACKUP_LEVEL:                                      #</span><br><span class="line">#              F: full backup                                  #</span><br><span class="line">#              0: level 0                                      #</span><br><span class="line">#              1: level 1                                      #</span><br><span class="line">################################################################</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#!/bin/bash</span><br><span class="line"># User specific environment and startup programs</span><br><span class="line">export ORACLE_HOME=/u01/app/oracle/product/11.2.0/dbhome_1</span><br><span class="line">export RMAN_BAK_LOG_BASE=/home/oracle/DbBackup</span><br><span class="line">export RMAN_BAK_DATA_BASE=+data/NXRAC/backup</span><br><span class="line">export ORACLE_SID=`ps -ef|grep pmon|grep -v ASM|grep -v grep|awk -F&apos;_&apos; &apos;&#123;print $NF&#125;&apos;`</span><br><span class="line">export TIMESTAMP=`date +%Y%m%d%H%M`;</span><br><span class="line"></span><br><span class="line">#the destination of rman backuppiece</span><br><span class="line">export RMAN_DATA=$&#123;RMAN_BAK_DATA_BASE&#125;/rman</span><br><span class="line"></span><br><span class="line">#the destination of rman backup logs</span><br><span class="line">export RMAN_LOG=$&#123;RMAN_BAK_LOG_BASE&#125;/logs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if [[ ! -z $1 ]] &amp;&amp; echo $1 |grep -Ew &quot;[01F]&quot; &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">then</span><br><span class="line">                                export RMAN_LEVEL=$&#123;1&#125;</span><br><span class="line"></span><br><span class="line">                                # Check rman level</span><br><span class="line">                                if [ &quot;$RMAN_LEVEL&quot; == &quot;F&quot; ];</span><br><span class="line">                                        then  unset INCR_LVL</span><br><span class="line">                                        BACKUP_TYPE=full</span><br><span class="line">                                        else</span><br><span class="line">                                        INCR_LVL=&quot;INCREMENTAL LEVEL $&#123;RMAN_LEVEL&#125;&quot;</span><br><span class="line">                                        BACKUP_TYPE=lev$&#123;RMAN_LEVEL&#125;</span><br><span class="line">                                fi</span><br><span class="line">else</span><br><span class="line">                                echo &quot;$&#123;1&#125; wrong argument!&quot; &gt;$&#123;RMAN_LOG&#125;/wrong_argument_$&#123;TIMESTAMP&#125;.log</span><br><span class="line">                                exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#the prefix of rman backuppiece                                 </span><br><span class="line">export RMAN_FILE=$&#123;RMAN_DATA&#125;/$&#123;BACKUP_TYPE&#125;_$&#123;TIMESTAMP&#125;</span><br><span class="line"></span><br><span class="line">#the logfile of shell script including the rman logs contents</span><br><span class="line">export SSH_LOG=$&#123;RMAN_LOG&#125;/$&#123;BACKUP_TYPE&#125;_$&#123;TIMESTAMP&#125;.log</span><br><span class="line"></span><br><span class="line">#the size of backuppiece</span><br><span class="line">export MAXPIECESIZE=4G</span><br><span class="line"></span><br><span class="line">####################################################################</span><br><span class="line">#                                                                  #</span><br><span class="line">#   the name of rman logs excluding the file expanded-name,        #</span><br><span class="line">#   when the shell is complete,the content of this file will be    #</span><br><span class="line">#   appended to the $SSH_LOG and the rman logfile will be deleted. #</span><br><span class="line">#                                                                  #</span><br><span class="line">####################################################################</span><br><span class="line">export RMAN_LOG_FILE=$&#123;RMAN_LOG&#125;/$&#123;BACKUP_TYPE&#125;_$&#123;TIMESTAMP&#125;_1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#Check RMAN Backup Path</span><br><span class="line"></span><br><span class="line">if ! test -d $&#123;RMAN_LOG&#125;</span><br><span class="line">then</span><br><span class="line">mkdir -p $&#123;RMAN_LOG&#125;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">echo &quot;---------------------------------&quot; &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class="line">echo &quot;   &quot; &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class="line">echo &quot;Rman Begin  to Working .........&quot; &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class="line">echo &quot;Begin time at:&quot; `date` --`date +%Y%m%d%H%M` &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class="line"></span><br><span class="line">#Startup rman to backup</span><br><span class="line"></span><br><span class="line">$ORACLE_HOME/bin/rman log=$&#123;RMAN_LOG_FILE&#125;.log &lt;&lt;EOF</span><br><span class="line">connect target /</span><br><span class="line">run &#123;</span><br><span class="line">CONFIGURE RETENTION POLICY TO RECOVERY WINDOW OF 7 DAYS;</span><br><span class="line">CONFIGURE BACKUP OPTIMIZATION ON;</span><br><span class="line">CONFIGURE CONTROLFILE AUTOBACKUP ON;</span><br><span class="line">CONFIGURE DEVICE TYPE DISK PARALLELISM 4 BACKUP TYPE TO BACKUPSET;</span><br><span class="line">CONFIGURE CONTROLFILE AUTOBACKUP FORMAT FOR DEVICE TYPE DISK TO &apos;$&#123;RMAN_DATA&#125;/control_auto_%F&apos;;</span><br><span class="line">ALLOCATE CHANNEL &apos;ch1&apos; TYPE DISK maxpiecesize=$&#123;MAXPIECESIZE&#125; CONNECT &apos;SYS/passwd@node1&apos;;</span><br><span class="line">ALLOCATE CHANNEL &apos;ch2&apos; TYPE DISK maxpiecesize=$&#123;MAXPIECESIZE&#125; CONNECT &apos;SYS/passwd@node1&apos;;</span><br><span class="line">ALLOCATE CHANNEL &apos;ch3&apos; TYPE DISK maxpiecesize=$&#123;MAXPIECESIZE&#125; CONNECT &apos;SYS/passwd@mode2&apos;;</span><br><span class="line">ALLOCATE CHANNEL &apos;ch4&apos; TYPE DISK maxpiecesize=$&#123;MAXPIECESIZE&#125; CONNECT &apos;SYS/passwd@node2&apos;;</span><br><span class="line">CROSSCHECK ARCHIVELOG ALL;</span><br><span class="line">DELETE NOPROMPT OBSOLETE;</span><br><span class="line">DELETE NOPROMPT EXPIRED BACKUP;</span><br><span class="line">BACKUP AS COMPRESSED BACKUPSET</span><br><span class="line">$&#123;INCR_LVL&#125;</span><br><span class="line">DATABASE FORMAT &apos;$&#123;RMAN_FILE&#125;_db_%U&apos; TAG &apos;$&#123;BACKUP_TYPE&#125;_$&#123;TIMESTAMP&#125;&apos;;</span><br><span class="line">SQL &apos;ALTER SYSTEM ARCHIVE LOG CURRENT&apos;;</span><br><span class="line">BACKUP FILESPERSET 20 ARCHIVELOG ALL FORMAT &apos;$&#123;RMAN_FILE&#125;_arc_%U&apos; TAG &apos;$&#123;ORACLE_SID&#125;_arc_$&#123;TIMESTAMP&#125;&apos;</span><br><span class="line">DELETE  INPUT;  </span><br><span class="line">RELEASE CHANNEL ch1;</span><br><span class="line">RELEASE CHANNEL ch2;</span><br><span class="line">RELEASE CHANNEL ch3;</span><br><span class="line">RELEASE CHANNEL ch4;</span><br><span class="line">ALLOCATE CHANNEL ch00 TYPE DISK;</span><br><span class="line">BACKUP</span><br><span class="line">    FORMAT &apos;$&#123;RMAN_DATA&#125;/cntrl_%U&apos;</span><br><span class="line">    CURRENT CONTROLFILE;</span><br><span class="line">RELEASE CHANNEL ch00;</span><br><span class="line">&#125;</span><br><span class="line">exit;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">RC=$?</span><br><span class="line"></span><br><span class="line">cat $&#123;RMAN_LOG_FILE&#125;.log &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class="line">echo &quot;Rman Stop working @ time:&quot;`date` `date +%Y%m%d%H%M` &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class="line"></span><br><span class="line">if [ $RC -ne &quot;0&quot; ]; then</span><br><span class="line">    echo &quot;------ error ------&quot; &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class="line">else</span><br><span class="line">    echo &quot;------ Success during RMAN backup peroid------&quot; &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class="line">    rm -rf $&#123;RMAN_LOG_FILE&#125;.log</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">exit</span><br></pre></td></tr></table></figure>

<p><strong>DBMS_SCHEDULER:</strong></p>
<p>Here we are using DBMS_SCHEDULER instead of DBMS_JOB, because DBMS_SCHEDULER is RAC aware.</p>
<p><strong>Before jump into real DBMS_SCHEDULER configuration, we need to focus on an important thing, That:</strong></p>
<p>Both RAC nodes local time zone must be identical with DBMS_SCHEDULER default time.</p>
<p>On all RAC node, Ensure local time zone and set it accordingly.</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[oracle@node2 ]$ cat /etc/sysconfig/clock</span><br><span class="line">ZONE="Asia/Shanghai"</span><br></pre></td></tr></table></figure>

<p><strong>configure default time zone for DBMS_SCHEDULER</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; select value from dba_scheduler_global_attribute where attribute_name = 'DEFAULT_TIMEZONE';</span><br><span class="line"></span><br><span class="line">VALUE</span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line">PRC</span><br><span class="line"></span><br><span class="line">SQL&gt; exec dbms_scheduler.set_scheduler_attribute ('DEFAULT_TIMEZONE', 'Asia/Shanghai');</span><br><span class="line"></span><br><span class="line">PL/SQL procedure successfully completed.</span><br><span class="line"></span><br><span class="line">SQL&gt; select value from dba_scheduler_global_attribute where attribute_name = 'DEFAULT_TIMEZONE';</span><br><span class="line"></span><br><span class="line">VALUE</span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line">Asia/Shanghai</span><br></pre></td></tr></table></figure>

<p>Now we need to create credential so that are assigned to DBMS_SCHEDULER jobs so that they can authenticate with a local/remote host operating system or a remote Oracle database.</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; exec dbms_scheduler.create_credential(credential_name =&gt; 'oracle', username =&gt; 'oracle', password =&gt; 'oracle');</span><br><span class="line"></span><br><span class="line">PL/SQL procedure successfully completed.</span><br></pre></td></tr></table></figure>

<p>Now its time to create DBMS_SCHEDULER job for RMAN incremental level 0 backup, Here in this procedure I am going to create <em>RMAN_INC0_BACKUP</em> job with required attributes.</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">begin</span></span><br><span class="line">dbms_scheduler.create_job(</span><br><span class="line">job_name            =&gt; <span class="string">'RMAN_INC0_BACKUP'</span>,</span><br><span class="line">job_type            =&gt; <span class="string">'EXECUTABLE'</span>,</span><br><span class="line">job_action          =&gt; <span class="string">'/bin/sh'</span>,</span><br><span class="line">number_of_arguments =&gt; <span class="number">2</span>,</span><br><span class="line">start_date          =&gt; SYSTIMESTAMP,</span><br><span class="line">credential_name     =&gt; <span class="string">'oracle'</span>,</span><br><span class="line">auto_drop           =&gt; <span class="literal">FALSE</span>,</span><br><span class="line">enabled             =&gt; <span class="literal">FALSE</span>);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>Set argument_position &amp; argument_value ( i.e. Path of the RMAN script ) for the same job:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">begin</span></span><br><span class="line">dbms_scheduler.set_job_argument_value(</span><br><span class="line">job_name            =&gt; <span class="string">'RMAN_INC0_BACKUP'</span>,</span><br><span class="line">argument_position   =&gt;  <span class="number">1</span>,</span><br><span class="line">argument_value      =&gt; <span class="string">'/home/oracle/rman.sh'</span>);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line">/</span><br><span class="line"></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">dbms_scheduler.set_job_argument_value(</span><br><span class="line">job_name            =&gt; <span class="string">'RMAN_INC0_BACKUP'</span>,</span><br><span class="line">argument_position   =&gt;  <span class="number">2</span>,</span><br><span class="line">argument_value      =&gt; <span class="number">0</span>);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>Set start_date for the same job, In my case <em>RMAN_INC0_BACKUP</em> job will execute every week on sunday @03am, so job start date and its first run timing would  according to my convenience.</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">begin</span></span><br><span class="line">dbms_scheduler.set_attribute(</span><br><span class="line"><span class="keyword">name</span>      =&gt; <span class="string">'RMAN_INC0_BACKUP'</span>,</span><br><span class="line"><span class="keyword">attribute</span> =&gt; <span class="string">'start_date'</span>,</span><br><span class="line"><span class="keyword">value</span>     =&gt; trunc(<span class="keyword">sysdate</span>)+<span class="number">3</span>/<span class="number">24</span>);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>Test your backup job manually in SQL prompt by instantiating <em>RMAN_INC0_BACKUP</em> job.</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; exec dbms_scheduler.run_job('RMAN_INC0_BACKUP');</span><br><span class="line">PL/SQL procedure successfully completed.</span><br></pre></td></tr></table></figure>

<p>Verify running RMAN backup status by issuing following SQL query, It will show you RMAN backup details with start time &amp; end time.</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> SESSION_KEY, INPUT_TYPE, <span class="keyword">STATUS</span>,</span><br><span class="line">to_char(START_TIME,<span class="string">'mm/dd/yy hh24:mi'</span>) start_time,</span><br><span class="line">to_char(END_TIME,<span class="string">'mm/dd/yy hh24:mi'</span>) end_time,</span><br><span class="line">elapsed_seconds/<span class="number">3600</span> hrs</span><br><span class="line"><span class="keyword">from</span> V$RMAN_BACKUP_JOB_DETAILS</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> session_key;</span><br></pre></td></tr></table></figure>

<p>In case of any error while test run, you can make sure details of error by issuing the following query, OR You can also query to <em>dba_scheduler_job_run_details</em> dictionary view for more details.</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> JOB_NAME,<span class="keyword">STATUS</span>,STATE,<span class="keyword">ERROR</span><span class="comment">#,CREDENTIAL_NAME from dba_scheduler_job_run_details where CREDENTIAL_NAME like 'RMAN%';</span></span><br></pre></td></tr></table></figure>

<p>After successfully completion of test run, Enable &amp; schedule it by following procedure by setting value to <em>repeat_interval</em> parameter, In my case <em>RMAN_INC0_BACKUP</em> job will execute every week on Sunday @03pm.</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">begin</span></span><br><span class="line">dbms_scheduler.set_attribute(</span><br><span class="line"><span class="keyword">name</span>      =&gt; <span class="string">'RMAN_INC0_BACKUP'</span>,</span><br><span class="line"><span class="keyword">attribute</span> =&gt; <span class="string">'repeat_interval'</span>,</span><br><span class="line"><span class="keyword">value</span>     =&gt; <span class="string">'freq=daily;byday=sun;byhour=03'</span>);</span><br><span class="line">dbms_scheduler.enable( 'RMAN_INC0_BACKUP' );</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>Ensure dbms_scheduler job details by issuing the following query OR you can also query to <em>dba_scheduler_jobs</em> and <em>dba_scheduler_job_args</em>.</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">SQL&gt; select job_name,enabled,owner, state from dba_scheduler_jobs where job_name in ('RMAN_INC0_BACKUP');</span><br></pre></td></tr></table></figure>

<p>Keep your eye on behavior of dbms_scheduler job by issuing the following query:</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">SQL&gt; select job_name,RUN_COUNT,LAST_START_DATE,NEXT_RUN_DATE from dba_scheduler_jobs where job_name in ('RMAN_INC0_BACKUP');</span><br><span class="line">SQL&gt; select *  from dba_scheduler_job_args where job_name like 'RMAN%';</span><br></pre></td></tr></table></figure>

<p>In accordance with the above method to create a level 1 backup job <em>RMAN_INC1_BACKUP</em>，The only difference is the <em>repeat_interval</em>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">begin</span></span><br><span class="line">dbms_scheduler.set_attribute(</span><br><span class="line"><span class="keyword">name</span>      =&gt; <span class="string">'RMAN_INC1_BACKUP'</span>,</span><br><span class="line"><span class="keyword">attribute</span> =&gt; <span class="string">'repeat_interval'</span>,</span><br><span class="line"><span class="keyword">value</span>     =&gt; <span class="string">'freq=daily;byday=mon,tue,wed,thu,fri,sat;byhour=03'</span>);</span><br><span class="line">dbms_scheduler.enable( 'RMAN_INC1_BACKUP' );</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p><strong>Important Note:</strong><br>DBMS_SCHEDULER is smart enough to start backup on the node where the last backup was successfully executed.</p>
<p><strong>参考：</strong></p>
<p>https://dbatricksworld.com/how-to-backup-oracle-rac-11gr2-database-with-rman-backup-utility-with-the-help-of-dbms_scheduler-part-i-rman-full-database-backup/</p>
<p>http://dbatricksworld.com/how-to-backup-oracle-rac-11gr2-database-with-rman-backup-utility-with-the-help-of-dbms_scheduler-part-ii-rman-incremental-database-backup/</p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2016/07/25/oracle/lock-latch/enq-TM-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="巴流">
      <meta itemprop="description" content="左手人文 | 右手科技">
      <meta itemprop="image" content="/images/heizi.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/07/25/oracle/lock-latch/enq-TM-1/" class="post-title-link" itemprop="url">enq之TM-contention解决之道——外键无索引导致锁争用（上）</a>
              
            
          </h2>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-07-25 16:21:00" itemprop="dateCreated datePublished" datetime="2016-07-25T16:21:00+08:00">2016-07-25</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-21 12:58:37" itemprop="dateModified" datetime="2019-07-21T12:58:37+08:00">2019-07-21</time>
              </span>
            
          

          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>近日，开发负责人反映某生产环境业务处理缓慢，主要业务操作就是修改会员信息，登录查询后发现大量的session正在等待enq: TM - contention，且waiting的语句几乎都是update<br>session的即时信息没有保留，现在附上ash视图的一些统计信息，可以大概了解一下当时争用的场景</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; @ash_wait_chains.sql username||':'||program2||event2 session_type='FOREGROUND' sysdate-6/24 sysdate-5/24</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Display ASH Wait Chain Signatures script v0.2 BETA by Tanel Poder ( http://blog.tanelpoder.com )</span></span><br><span class="line"></span><br><span class="line">%This     SECONDS        AAS</span><br><span class="line"><span class="comment">------ ---------- ----------</span></span><br><span class="line">WAIT_CHAIN</span><br><span class="line"><span class="comment">------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span></span><br><span class="line">  72%       20073        5.6</span><br><span class="line">-&gt; JSCHPROD:(JDBC Thin Client) ON CPU</span><br><span class="line"></span><br><span class="line">   8%        2293         .6</span><br><span class="line">-&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) ON CPU</span><br><span class="line"></span><br><span class="line">   8%        2141         .6</span><br><span class="line">-&gt; JSCHPROD:(JDBC Thin Client) log file sync  -&gt; SYS:(LGWR) log file parallel write</span><br><span class="line"></span><br><span class="line">   7%        1879         .5</span><br><span class="line">-&gt; JSCHPROD:(JDBC Thin Client) log file sync  -&gt; SYS:(LGWR) LGWR-LNS wait on channel</span><br><span class="line"></span><br><span class="line">   2%         654         .2</span><br><span class="line">-&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) ON CPU</span><br><span class="line"></span><br><span class="line">   1%         288         .1</span><br><span class="line">-&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) ON CPU</span><br><span class="line"></span><br><span class="line">   1%         149          0</span><br><span class="line">-&gt; JSCHPROD:(JDBC Thin Client) log file sync  -&gt; SYS:(LGWR) ON CPU</span><br><span class="line"></span><br><span class="line">   0%         128          0</span><br><span class="line">-&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention</span><br><span class="line"></span><br><span class="line">   0%         112          0</span><br><span class="line">-&gt; JSCHPROD:(JDBC Thin Client) log file sync</span><br><span class="line"></span><br><span class="line">   0%          86          0</span><br><span class="line">-&gt; JSCHPROD:(JDBC Thin Client) db file scattered read</span><br><span class="line"></span><br><span class="line">   0%          43          0</span><br><span class="line">-&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) ON CPU</span><br><span class="line"></span><br><span class="line">   0%          37          0</span><br><span class="line">-&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention</span><br><span class="line"></span><br><span class="line">   0%          25          0</span><br><span class="line">-&gt; JSCHPROD:(JDBC Thin Client) log file sync  -&gt; SYS:(LGWR) LGWR wait on LNS</span><br><span class="line"></span><br><span class="line">   0%          13          0</span><br><span class="line">-&gt; JSCHPROD:(plsqldev.exe) ON CPU</span><br><span class="line"></span><br><span class="line">   0%          11          0</span><br><span class="line">-&gt; SYS:(plsqldev.exe) ON CPU</span><br><span class="line"></span><br><span class="line">   0%          10          0</span><br><span class="line">-&gt; JSCHPROD:(JDBC Thin Client) SQL*Net more data from client</span><br><span class="line"></span><br><span class="line">   0%           9          0</span><br><span class="line">-&gt; JSCHPROD:(JDBC Thin Client) db file sequential read</span><br><span class="line"></span><br><span class="line">   0%           9          0</span><br><span class="line">-&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) ON</span><br><span class="line">CPU</span><br><span class="line"></span><br><span class="line">   0%           6          0</span><br><span class="line">-&gt; JSCHPROD:(JDBC Thin Client) read by other session  -&gt; JSCHPROD:(JDBC Thin Client) ON CPU</span><br><span class="line"></span><br><span class="line">   0%           4          0</span><br><span class="line">-&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention</span><br><span class="line"></span><br><span class="line">   0%           3          0</span><br><span class="line">-&gt; JSCHPROD:(JDBC Thin Client) SQL*Net more data to client</span><br><span class="line"></span><br><span class="line">   0%           3          0</span><br><span class="line">-&gt; JSCHPROD:(JDBC Thin Client) buffer busy waits [data block]</span><br><span class="line"></span><br><span class="line">   0%           3          0</span><br><span class="line">-&gt; SYS:(oraagent.bin) Disk file operations I/O</span><br><span class="line"></span><br><span class="line">   0%           3          0</span><br><span class="line">-&gt; JSCHPROD:(JDBC Thin Client) log file sync  -&gt; SYS:(LGWR) LGWR wait for redo copy</span><br><span class="line"></span><br><span class="line">   0%           2          0</span><br><span class="line">-&gt; JSCHPROD:(JDBC Thin Client) enq: TX - row lock contention</span><br><span class="line"></span><br><span class="line">   0%           2          0</span><br><span class="line">-&gt; JSCHPROD:(JDBC Thin Client) log file sync  -&gt; SYS:(LGWR) LGWR wait for redo copy  -&gt; JSCHPROD:(JDBC Thin Client) ON CPU</span><br><span class="line"></span><br><span class="line">   0%           2          0</span><br><span class="line">-&gt; JSCHPROD:(JDBC Thin Client) enq: TX - index contention  -&gt; JSCHPROD:(JDBC Thin Client) ON CPU</span><br><span class="line"></span><br><span class="line">   0%           1          0</span><br><span class="line">-&gt; JSCHPROD:(plsqldev.exe) log file sync  -&gt; SYS:(LGWR) log file parallel write</span><br><span class="line"></span><br><span class="line">   0%           1          0</span><br><span class="line">-&gt; SYS:(plsqldev.exe) Disk file operations I/O</span><br><span class="line"></span><br><span class="line">   0%           1          0</span><br><span class="line">-&gt; JSCHPROD:(JDBC Thin Client) enq: TX - row lock contention  -&gt; JSCHPROD:(JDBC Thin Client) ON CPU</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">30 rows selected.</span><br></pre></td></tr></table></figure>

<p>可以看到，TM锁的争用很多，再看一份当时awr报告的top10</p>
<p><img alt data-src="https://liupzminblog.files.wordpress.com/2016/12/qq20161218-02x.png"></p>
<p>虽然占DBTIME不多，但本来是很快的操作，短时间内给人的感觉就是业务处理缓慢<br>查一下当时等待事件的p1,p2,p3的值</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> ash.SAMPLE_TIME,</span><br><span class="line">       ash.EVENT,</span><br><span class="line">       ash.SESSION_ID,</span><br><span class="line">       ash.BLOCKING_SESSION,</span><br><span class="line">       ash.P1TEXT,</span><br><span class="line">       ash.P1,</span><br><span class="line">       ash.P2TEXT,</span><br><span class="line">       ash.p2,</span><br><span class="line">       ash.p3text,</span><br><span class="line">       ash.p3,</span><br><span class="line">       ash.SESSION_STATE,</span><br><span class="line">       ash.SQL_OPNAME,</span><br><span class="line">       ash.SQL_ID</span><br><span class="line">       <span class="comment">--ash.*</span></span><br><span class="line">  <span class="keyword">from</span> v$active_session_history ash</span><br><span class="line"> <span class="keyword">where</span> ash.SAMPLE_TIME &gt;</span><br><span class="line">       <span class="keyword">to_date</span>(<span class="string">'20160425 10:00:00'</span>, <span class="string">'yyyymmdd HH24:MI:SS'</span>)</span><br><span class="line">   <span class="keyword">and</span> ash.SAMPLE_TIME &lt;</span><br><span class="line">       <span class="keyword">to_date</span>(<span class="string">'20160425 12:10:00'</span>, <span class="string">'yyyymmdd HH24:MI:SS'</span>)</span><br><span class="line">   <span class="keyword">and</span> ash.WAIT_CLASS &lt;&gt; <span class="string">'Idle'</span></span><br><span class="line">   <span class="keyword">and</span> ash.EVENT <span class="keyword">like</span> <span class="string">'enq: TM - contention'</span></span><br><span class="line"> <span class="keyword">order</span> <span class="keyword">by</span> sample_time <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>

<p>下面是部分结果</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">enq: TM - contention	1828	2401	name|mode	1414332421	object #	110417	table/partition	0	WAITING	UPDATE	ak25v8q8p6fzd</span><br><span class="line">enq: TM - contention	1873	2504	name|mode	1414332419	object #	110415	table/partition	0	WAITING	INSERT	7w0tma5up32wt</span><br><span class="line">enq: TM - contention	2504	1828	name|mode	1414332421	object #	110415	table/partition	0	WAITING	UPDATE	ak25v8q8p6fzd</span><br><span class="line">enq: TM - contention	772	4	name|mode	1414332421	object #	110417	table/partition	0	WAITING	UPDATE	ak25v8q8p6fzd</span><br><span class="line">enq: TM - contention	1781	1828	name|mode	1414332419	object #	110415	table/partition	0	WAITING	INSERT	7w0tma5up32wt</span><br><span class="line">enq: TM - contention	1828	772	name|mode	1414332421	object #	110415	table/partition	0	WAITING	UPDATE	ak25v8q8p6fzd</span><br><span class="line">enq: TM - contention	2401	1828	name|mode	1414332419	object #	110415	table/partition	0	WAITING	INSERT	7w0tma5up32wt</span><br><span class="line">enq: TM - contention	2504	772	name|mode	1414332421	object #	110415	table/partition	0	WAITING	UPDATE	ak25v8q8p6fzd</span><br><span class="line">enq: TM - contention	4	772	name|mode	1414332419	object #	110415	table/partition	0	WAITING	INSERT	7w0tma5up32wt</span><br><span class="line">enq: TM - contention	148	1781	name|mode	1414332420	object #	110428	table/partition	0	WAITING	UPDATE	9gd6xhd0xyhph</span><br><span class="line">enq: TM - contention	772	148	name|mode	1414332421	object #	110415	table/partition	0	WAITING	UPDATE	ak25v8q8p6fzd</span><br><span class="line">enq: TM - contention	1828	148	name|mode	1414332421	object #	110415	table/partition	0	WAITING	UPDATE	ak25v8q8p6fzd</span><br><span class="line">enq: TM - contention	1873	772	name|mode	1414332419	object #	110415	table/partition	0	WAITING	INSERT	7w0tma5up32wt</span><br></pre></td></tr></table></figure>

<p>可以看到p2的值为产生TM争用的对象id，经过查证，这些object均是session正在更新的表的子表，而且通过v$sql查看update语句均更改了主表的主键，问题到这里已经很明朗了，由于外键没加索引，导致了主表在更新主表主键或删除主表记录时对子表的锁定，而且这张主表被大量的子表引用，此时子表上也同时进行事务处理，所以造成了更新主表的session 不时hang住。</p>
<p>通过对所有子表的外键加索引，消除了争用，检测未加索引的外键语句：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> TABLE_NAME,</span><br><span class="line">       CONSTRAINT_NAME,</span><br><span class="line">       CNAME1 || NVL2(CNAME2, <span class="string">','</span> || CNAME2, <span class="literal">NULL</span>) ||</span><br><span class="line">       NVL2(CNAME3, <span class="string">','</span> || CNAME3, <span class="literal">NULL</span>) ||</span><br><span class="line">       NVL2(CNAME4, <span class="string">','</span> || CNAME4, <span class="literal">NULL</span>) ||</span><br><span class="line">       NVL2(CNAME5, <span class="string">','</span> || CNAME5, <span class="literal">NULL</span>) ||</span><br><span class="line">       NVL2(CNAME6, <span class="string">','</span> || CNAME6, <span class="literal">NULL</span>) ||</span><br><span class="line">       NVL2(CNAME7, <span class="string">','</span> || CNAME7, <span class="literal">NULL</span>) ||</span><br><span class="line">       NVL2(CNAME8, <span class="string">','</span> || CNAME8, <span class="literal">NULL</span>) <span class="keyword">COLUMNS</span></span><br><span class="line">  <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> B.TABLE_NAME,</span><br><span class="line">               B.CONSTRAINT_NAME,</span><br><span class="line">               <span class="keyword">MAX</span>(<span class="keyword">DECODE</span>(<span class="keyword">POSITION</span>, <span class="number">1</span>, COLUMN_NAME, <span class="literal">NULL</span>)) CNAME1,</span><br><span class="line">               <span class="keyword">MAX</span>(<span class="keyword">DECODE</span>(<span class="keyword">POSITION</span>, <span class="number">2</span>, COLUMN_NAME, <span class="literal">NULL</span>)) CNAME2,</span><br><span class="line">               <span class="keyword">MAX</span>(<span class="keyword">DECODE</span>(<span class="keyword">POSITION</span>, <span class="number">3</span>, COLUMN_NAME, <span class="literal">NULL</span>)) CNAME3,</span><br><span class="line">               <span class="keyword">MAX</span>(<span class="keyword">DECODE</span>(<span class="keyword">POSITION</span>, <span class="number">4</span>, COLUMN_NAME, <span class="literal">NULL</span>)) CNAME4,</span><br><span class="line">               <span class="keyword">MAX</span>(<span class="keyword">DECODE</span>(<span class="keyword">POSITION</span>, <span class="number">5</span>, COLUMN_NAME, <span class="literal">NULL</span>)) CNAME5,</span><br><span class="line">               <span class="keyword">MAX</span>(<span class="keyword">DECODE</span>(<span class="keyword">POSITION</span>, <span class="number">6</span>, COLUMN_NAME, <span class="literal">NULL</span>)) CNAME6,</span><br><span class="line">               <span class="keyword">MAX</span>(<span class="keyword">DECODE</span>(<span class="keyword">POSITION</span>, <span class="number">7</span>, COLUMN_NAME, <span class="literal">NULL</span>)) CNAME7,</span><br><span class="line">               <span class="keyword">MAX</span>(<span class="keyword">DECODE</span>(<span class="keyword">POSITION</span>, <span class="number">8</span>, COLUMN_NAME, <span class="literal">NULL</span>)) CNAME8,</span><br><span class="line">               <span class="keyword">COUNT</span>(*) COL_CNT</span><br><span class="line">          <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> <span class="keyword">SUBSTR</span>(TABLE_NAME, <span class="number">1</span>, <span class="number">30</span>) TABLE_NAME,</span><br><span class="line">                       <span class="keyword">SUBSTR</span>(CONSTRAINT_NAME, <span class="number">1</span>, <span class="number">30</span>) CONSTRAINT_NAME,</span><br><span class="line">                       <span class="keyword">SUBSTR</span>(COLUMN_NAME, <span class="number">1</span>, <span class="number">30</span>) COLUMN_NAME,</span><br><span class="line">                       <span class="keyword">POSITION</span></span><br><span class="line">                  <span class="keyword">FROM</span> USER_CONS_COLUMNS) A,</span><br><span class="line">               USER_CONSTRAINTS B</span><br><span class="line">         <span class="keyword">WHERE</span> A.CONSTRAINT_NAME = B.CONSTRAINT_NAME</span><br><span class="line">           <span class="keyword">AND</span> B.CONSTRAINT_TYPE = <span class="string">'R'</span></span><br><span class="line">         <span class="keyword">GROUP</span> <span class="keyword">BY</span> B.TABLE_NAME, B.CONSTRAINT_NAME) CONS</span><br><span class="line"> <span class="keyword">WHERE</span> COL_CNT &gt; <span class="keyword">ALL</span></span><br><span class="line"> (<span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*)</span><br><span class="line">          <span class="keyword">FROM</span> USER_IND_COLUMNS I</span><br><span class="line">         <span class="keyword">WHERE</span> I.TABLE_NAME = CONS.TABLE_NAME</span><br><span class="line">           <span class="keyword">AND</span> I.COLUMN_NAME <span class="keyword">IN</span> (CNAME1, CNAME2, CNAME3, CNAME4, CNAME5,</span><br><span class="line">                CNAME6, CNAME7, CNAME8)</span><br><span class="line">           <span class="keyword">AND</span> I.COLUMN_POSITION &lt;= CONS.COL_CNT</span><br><span class="line">         <span class="keyword">GROUP</span> <span class="keyword">BY</span> I.INDEX_NAME);</span><br></pre></td></tr></table></figure>

<p>这是摘自TOM大师的语句，外键不加索引也是导致死锁的常见原因之一，因此对于主表经常进行更新删除操作的情况，外键一定要加索引。<br>至于外键未加索引是如何导致锁定的，以及为何加了索引后争用就消失了? 敬请关注enq: TM - contention解决之道——外键无索引导致锁争用 （下）</p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2016/07/20/oracle/backup-restore/ORA-00600[13011]/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="巴流">
      <meta itemprop="description" content="左手人文 | 右手科技">
      <meta itemprop="image" content="/images/heizi.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/07/20/oracle/backup-restore/ORA-00600[13011]/" class="post-title-link" itemprop="url">一次ORA-00600[13011]处理过程</a>
              
            
          </h2>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-07-20 18:48:00" itemprop="dateCreated datePublished" datetime="2016-07-20T18:48:00+08:00">2016-07-20</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-21 12:52:02" itemprop="dateModified" datetime="2019-07-21T12:52:02+08:00">2019-07-21</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/oracle-restore/" itemprop="url" rel="index"><span itemprop="name">oracle restore</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>一次掉电后，DG主库启动alert中报如下错误</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Errors in file /home/oracle/app/oracle/diag/rdbms/min/min/trace/min_m002_4099.trc  (incident=16328):</span><br><span class="line">ORA-00600: internal error code, arguments: [13011], [6443], [8463760], [14], [8488694], [0], [], [], [], [], [], []</span><br><span class="line">Incident details in: /home/oracle/app/oracle/diag/rdbms/min/min/incident/incdir_16328/min_m002_4099_i16328.trc</span><br><span class="line">Use ADRCI or Support Workbench to package the incident.</span><br><span class="line">See Note 411.1 at My Oracle Support for error and packaging details.</span><br><span class="line">Errors in file /home/oracle/app/oracle/diag/rdbms/min/min/trace/min_m002_4099.trc  (incident=16329):</span><br><span class="line">ORA-00600: internal error code, arguments: [kewrose_1], [600], [ORA-00600: internal error code, arguments: [13011], [6443], [8463760], [14], [8488694], [0], [], [], [], [], [], []</span><br><span class="line">], [], [], [], [], [], [], [], [], []</span><br><span class="line">Incident details in: /home/oracle/app/oracle/diag/rdbms/min/min/incident/incdir_16329/min_m002_4099_i16329.trc</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查看trace文件，部分内容如下</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*** 2016-07-20 18:21:04.185</span><br><span class="line">*** SESSION ID:(169.43) 2016-07-20 18:21:04.185</span><br><span class="line">*** CLIENT ID:() 2016-07-20 18:21:04.185</span><br><span class="line">*** SERVICE NAME:(SYS$BACKGROUND) 2016-07-20 18:21:04.185</span><br><span class="line">*** MODULE NAME:(MMON_SLAVE) 2016-07-20 18:21:04.185</span><br><span class="line">*** ACTION NAME:(Auto-Purge Slave Action) 2016-07-20 18:21:04.185</span><br><span class="line"></span><br><span class="line">Dump continued from file: /home/oracle/app/oracle/diag/rdbms/min/min/trace/min_m000_2615.trc</span><br><span class="line">ORA-00600: internal error code, arguments: [13011], [6665], [8395075], [14], [8462787], [0], [], [], [], [], [], []</span><br><span class="line"></span><br><span class="line">========= Dump for incident 14804 (ORA 600 [13011]) ========</span><br><span class="line"></span><br><span class="line">*** 2016-07-20 18:21:04.186</span><br><span class="line">dbkedDefDump(): Starting incident default dumps (flags=0x2, level=3, mask=0x0)</span><br><span class="line">----- Current SQL Statement for this session (sql_id=c8taax4bfzsjc) -----</span><br><span class="line">delete from WRH$_RSRC_PLAN tab where (:beg_snap &lt;= tab.snap_id and         tab.snap_id &lt;= :end_snap and         dbid = :dbid)    and not exists (select 1 from WRM$_BASELINE b                    wh</span><br><span class="line">ere (tab.dbid = b.dbid) and                          (tab.snap_id &gt;= b.start_snap_id) and                          (tab.snap_id &lt;= b.end_snap_id))</span><br></pre></td></tr></table></figure>

<blockquote>
<p>MOS中关于ORA-600 [13013]描述</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Format: ORA-600 [13013] [a] [b] &#123;c&#125; [d] [e] [f]</span><br><span class="line">Arg [a] Passcount</span><br><span class="line">Arg [b] Data Object number</span><br><span class="line">Arg &#123;c&#125; Tablespace Decimal Relative DBA (RDBA) of block containing the row to be updated</span><br><span class="line">Arg [d] Row Slot number</span><br><span class="line">Arg [e] Decimal RDBA of block being updated (Typically same as &#123;c&#125;)</span><br><span class="line">Arg [f] Code</span><br></pre></td></tr></table></figure>

<blockquote>
<p>确定object</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; select owner,object_name,object_type  from dba_objects where object_id=6665;</span><br><span class="line"></span><br><span class="line">OWNER                          OBJECT_NAME                                                  OBJECT_TYPE</span><br><span class="line"><span class="comment">------------------------------ ------------------------------------------------------------ -------------------</span></span><br><span class="line">SYS                            WRH$_RSRC_PLAN                                               TABLE</span><br></pre></td></tr></table></figure>

<p>可见与trc文件中的sql中对象名吻合，都是<strong>WRH$_RSRC_PLAN</strong><br>查看trc文件中的<strong>PLAN TABLE</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">----- Plan Table -----</span><br><span class="line"></span><br><span class="line">============</span><br><span class="line">Plan Table</span><br><span class="line">============</span><br><span class="line">-----------------------------------------------------------+-----------------------------------+</span><br><span class="line">| Id  | Operation                       | Name             | Rows  | Bytes | Cost  | Time      |</span><br><span class="line">-----------------------------------------------------------+-----------------------------------+</span><br><span class="line">| 0   | DELETE STATEMENT                |                  |       |       |   626 |           |</span><br><span class="line">| 1   |  DELETE                         | WRH$_RSRC_PLAN   |       |       |       |           |</span><br><span class="line">| 2   |   FILTER                        |                  |       |       |       |           |</span><br><span class="line">| 3   |    INDEX RANGE SCAN             | WRH$_RSRC_PLAN_PK|    94 |  1598 |     8 |  00:00:01 |</span><br><span class="line">| 4   |     TABLE ACCESS BY INDEX ROWID | WRM$_BASELINE    |     1 |    33 |     2 |  00:00:01 |</span><br><span class="line">| 5   |      INDEX RANGE SCAN           | WRM$_BASELINE_PK |     1 |       |     1 |  00:00:01 |</span><br><span class="line">-----------------------------------------------------------+-----------------------------------+</span><br></pre></td></tr></table></figure>

<p>1.The most common cause of this error is an index corruption. The first step is to check the indexes for corruption, i.e. run</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; ANALYZE INDEX WRH$_RSRC_PLAN_PK VALIDATE STRUCTURE;</span><br><span class="line"></span><br><span class="line">Index analyzed.</span><br></pre></td></tr></table></figure>

<p>2.If the indexes do not report corruption, further test for corruption the base tables referenced in the execution plan or the statement producing the error:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; ANALYZE TABLE WRH$_RSRC_PLAN VALIDATE STRUCTURE CASCADE;</span><br><span class="line"><span class="keyword">ANALYZE</span> <span class="keyword">TABLE</span> WRH$_RSRC_PLAN <span class="keyword">VALIDATE</span> STRUCTURE <span class="keyword">CASCADE</span></span><br><span class="line">*</span><br><span class="line"><span class="keyword">ERROR</span> <span class="keyword">at</span> line <span class="number">1</span>:</span><br><span class="line">ORA<span class="number">-01499</span>: <span class="keyword">table</span>/<span class="keyword">index</span> <span class="keyword">cross</span> <span class="keyword">reference</span> <span class="keyword">failure</span> - see <span class="keyword">trace</span> <span class="keyword">file</span></span><br></pre></td></tr></table></figure>

<p>查看生成的trace文件内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">*** 2016-07-21 01:31:31.840</span><br><span class="line">*** SESSION ID:(52.5) 2016-07-21 01:31:31.840</span><br><span class="line">*** CLIENT ID:() 2016-07-21 01:31:31.840</span><br><span class="line">*** SERVICE NAME:(SYS$USERS) 2016-07-21 01:31:31.840</span><br><span class="line">*** MODULE NAME:(sqlplus@primary (TNS V1-V3)) 2016-07-21 01:31:31.840</span><br><span class="line">*** ACTION NAME:() 2016-07-21 01:31:31.840</span><br><span class="line"></span><br><span class="line">Table/Index row count mismatch</span><br><span class="line">table 2901 : index 3203, 296</span><br><span class="line">Index root = tsn: 1 rdba: 0x0080194a</span><br></pre></td></tr></table></figure>

<p>对于文件内容，简单介绍如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">trace文件中包含：</span><br><span class="line"></span><br><span class="line">&lt;description&gt;: tsn: &lt;tablespace number&gt; rdba: &lt;relative dba&gt;</span><br><span class="line"></span><br><span class="line">description有以下值：</span><br><span class="line"></span><br><span class="line">&quot;row not found in index&quot;</span><br><span class="line">&quot;Table/Index row count mismatch&quot;</span><br><span class="line">&quot;row mismatch in index dba&quot;</span><br><span class="line">&quot;Table row count/Bitmap index bit count mismatch&quot;</span><br><span class="line">&quot;kdavls: kdcchk returns %d when checking cluster dba 0x%08lx objn %d\n&quot;</span><br><span class="line"></span><br><span class="line">tsn:    Tablespace Number表示的是索引存储的表空间编号。</span><br><span class="line">rdba: 是索引段头相对于数据块的存储地址。</span><br></pre></td></tr></table></figure>

<p>运行以下sql查询索引的文件和块号</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> dbms_utility.data_block_address_file(</span><br><span class="line">         to_number(<span class="keyword">trim</span>(<span class="keyword">leading</span> <span class="string">'0'</span> <span class="keyword">from</span></span><br><span class="line"><span class="keyword">replace</span>(<span class="string">'&amp;&amp;rdba'</span>,<span class="string">'0x'</span>,<span class="string">''</span>)),<span class="string">'XXXXXXXX'</span>)</span><br><span class="line">       ) <span class="keyword">AS</span> rfile<span class="comment">#,</span></span><br><span class="line">       dbms_utility.data_block_address_block(</span><br><span class="line">         to_number(<span class="keyword">trim</span>(<span class="keyword">leading</span> <span class="string">'0'</span> <span class="keyword">from</span></span><br><span class="line"><span class="keyword">replace</span>(<span class="string">'&amp;&amp;rdba'</span>,<span class="string">'0x'</span>,<span class="string">''</span>)),<span class="string">'XXXXXXXX'</span>)</span><br><span class="line">       ) <span class="keyword">AS</span> <span class="keyword">block</span><span class="comment">#</span></span><br><span class="line"><span class="keyword">FROM</span> dual;</span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; SELECT dbms_utility.data_block_address_file(</span><br><span class="line">  2           to_number(trim(leading '0' from</span><br><span class="line">  3  <span class="keyword">replace</span>(<span class="string">'&amp;&amp;rdba'</span>,<span class="string">'0x'</span>,<span class="string">''</span>)),<span class="string">'XXXXXXXX'</span>)</span><br><span class="line">  <span class="number">4</span>         ) <span class="keyword">AS</span> rfile<span class="comment">#,</span></span><br><span class="line">  <span class="number">5</span>         dbms_utility.data_block_address_block(</span><br><span class="line">  <span class="number">6</span>           to_number(<span class="keyword">trim</span>(<span class="keyword">leading</span> <span class="string">'0'</span> <span class="keyword">from</span></span><br><span class="line">  <span class="number">7</span>  <span class="keyword">replace</span>(<span class="string">'&amp;&amp;rdba'</span>,<span class="string">'0x'</span>,<span class="string">''</span>)),<span class="string">'XXXXXXXX'</span>)</span><br><span class="line">  <span class="number">8</span>         ) <span class="keyword">AS</span> <span class="keyword">block</span><span class="comment">#</span></span><br><span class="line">  <span class="number">9</span>  <span class="keyword">FROM</span> dual;</span><br><span class="line">Enter value for rdba: 0x0080194a</span><br><span class="line">old   3: <span class="keyword">replace</span>(<span class="string">'&amp;&amp;rdba'</span>,<span class="string">'0x'</span>,<span class="string">''</span>)),<span class="string">'XXXXXXXX'</span>)</span><br><span class="line"><span class="keyword">new</span>   <span class="number">3</span>: <span class="keyword">replace</span>(<span class="string">'0x0080194a'</span>,<span class="string">'0x'</span>,<span class="string">''</span>)),<span class="string">'XXXXXXXX'</span>)</span><br><span class="line"><span class="keyword">old</span>   <span class="number">7</span>: <span class="keyword">replace</span>(<span class="string">'&amp;&amp;rdba'</span>,<span class="string">'0x'</span>,<span class="string">''</span>)),<span class="string">'XXXXXXXX'</span>)</span><br><span class="line"><span class="keyword">new</span>   <span class="number">7</span>: <span class="keyword">replace</span>(<span class="string">'0x0080194a'</span>,<span class="string">'0x'</span>,<span class="string">''</span>)),<span class="string">'XXXXXXXX'</span>)</span><br><span class="line"></span><br><span class="line">    RFILE<span class="comment">#     BLOCK#</span></span><br><span class="line"><span class="comment">---------- ----------</span></span><br><span class="line">         <span class="number">2</span>       <span class="number">6474</span></span><br></pre></td></tr></table></figure>

<p>接下来运行如下查询，定位具体的segment</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> owner, segment_name, segment_type</span><br><span class="line"><span class="keyword">from</span>  dba_segments</span><br><span class="line"><span class="keyword">where</span> header_file = &lt;rfile<span class="comment">#&gt;</span></span><br><span class="line">  <span class="keyword">and</span> header_block = &lt;<span class="keyword">block</span><span class="comment">#&gt;</span></span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; select owner, segment_name, segment_type</span><br><span class="line">  2  from  dba_segments</span><br><span class="line">  3  where header_file = 2</span><br><span class="line">  4    and header_block = 6474;</span><br><span class="line">OWNER                          SEGMENT_NAME                                                                      SEGMENT_TYPE</span><br><span class="line"><span class="comment">------------------------------ --------------------------------------------------------------------------------- ------------------</span></span><br><span class="line">SYS                            WRH$_RSRC_PLAN_PK                                                                 INDEX</span><br></pre></td></tr></table></figure>

<p>看来仍然是上面分析过的索引，这里是因为表和索引的数据不一致，那么重建索引</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> WRH$_RSRC_PLAN <span class="keyword">drop</span> <span class="keyword">constraint</span> WRH$_RSRC_PLAN_PK <span class="keyword">cascade</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> WRH$_RSRC_PLAN</span><br><span class="line">  <span class="keyword">add</span> <span class="keyword">constraint</span> WRH$_RSRC_PLAN_PK primary <span class="keyword">key</span> (DBID, SNAP_ID, INSTANCE_NUMBER, <span class="keyword">SEQUENCE</span><span class="comment">#);</span></span><br></pre></td></tr></table></figure>

<p>再次分析表，发现错误消失了</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; ANALYZE TABLE WRH$_RSRC_PLAN VALIDATE STRUCTURE CASCADE;</span><br><span class="line"></span><br><span class="line">Table analyzed.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>至此，问题解决</p>
</blockquote>
<p>掉电仍是数据库的大敌，而此次并非只在这一张表上有讹误，还有其他一些WRH$表，这些表均属于sysaux表空间，这些表都是awr系列表，写入频繁，掉电容易引起数据的不一致性，但是，正因为是awr数据，并不是特别重要，修复起来也相对容易。  </p>
<blockquote>
<p>记录一下AWR Performance Tables介绍</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">The Oracle10g dynamic performance tables constitute the foundation of sophisticated automations such as Automatic Memory Management  (AMM ) as well as intelligent advisory tools such as ADDM and the SQL Tuning   Advisor.</span><br><span class="line"></span><br><span class="line">Remember, the AWR is a core feature of the 10g database kernel and automatically collects and stores important run-time performance information for our historical analysis.</span><br><span class="line"></span><br><span class="line">The tables that store this information are prefixed with wrh$ and are very similar in function to the STATSPACK tables.  This could make STATSPACK appear somewhat obsolete, although it is still available in the $ORACLE_HOME/rdbms/admin directory.</span><br><span class="line"></span><br><span class="line">Unlike the more cumbersome STATSPACK utility, which requires knowledge of the table structure and creation of complex query scripts, the 10g Enterprise Manager (OEM) automatically displays and interprets this valuable time-series performance data.</span><br><span class="line"></span><br><span class="line">The wrh$ AWR tables store important historical statistical information about the database in the form of periodic snapshots. Each snapshot is a capture of the in–memory x$ fixed view and other control structures at a certain point in time. Each of the AWR table names is prefixed with wrm$ (Metadata tables), wrh$ (History tables), or wri$ (Advisory tables).</span><br><span class="line"></span><br><span class="line"> 1. The wrm$ tables store metadata information for the Workload Repository.</span><br><span class="line"></span><br><span class="line"> 2. The wrh$ tables store historical data or snapshots.</span><br><span class="line"></span><br><span class="line"> 3. The wri$ tables: These 49 tables store data related to advisory functions.</span><br></pre></td></tr></table></figure>


          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2015/09/30/oracle/architecture/ASSM2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="巴流">
      <meta itemprop="description" content="左手人文 | 右手科技">
      <meta itemprop="image" content="/images/heizi.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2015/09/30/oracle/architecture/ASSM2/" class="post-title-link" itemprop="url">ASSM三级位图结构与高水位的探究（下）</a>
              
            
          </h2>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2015-09-30 14:31:00" itemprop="dateCreated datePublished" datetime="2015-09-30T14:31:00+08:00">2015-09-30</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-21 13:03:54" itemprop="dateModified" datetime="2019-07-21T13:03:54+08:00">2019-07-21</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/oracle/" itemprop="url" rel="index"><span itemprop="name">oracle</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上一篇文章介绍了ASSM三级位图管理下的数据插入和高水位推进的关系，我们得出的结论是随着数据不断的插入，段大小的不断增长，L1中挂载的数据块的数量也会增长，而高水位是以L1中数据块大小的总和与区大小之间最小的一方为单位进行推进，而且我们知道要想应对大并发插入，就要使高水位之下的空闲块的数量尽可能多，但是如此一来就有可能造成空间的浪费，而oracle的初心也是本着节省空间的目的来设计的。<br>之前我们用的是常规路径插入，能以L1和区的单位推动高水位，前提是要填满L1或区，而我们熟知的直接路径插入是在高水位之上插入，那是不是可以用直接路径插入快速增加高水位呢？我们来一探究竟。</p>
<blockquote>
<p>首先构造测试的表空间和表，跟上一篇一样</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; drop tablespace lp including contents and datafiles;</span><br><span class="line"></span><br><span class="line">Tablespace dropped.</span><br><span class="line"></span><br><span class="line">SQL&gt; create tablespace lp datafile '/home/oracle/app/oracle/oradata/DG43/lp.dbf' size 2048M uniform size 1m;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> lp (<span class="keyword">id</span> <span class="built_in">number</span>,des1 <span class="built_in">char</span>(<span class="number">2000</span>),des2 <span class="built_in">char</span>(<span class="number">2000</span>),des3 <span class="built_in">char</span>(<span class="number">2000</span>),des4 <span class="built_in">char</span>(<span class="number">500</span>)) <span class="keyword">tablespace</span> lp;</span><br><span class="line"></span><br><span class="line">Tablespace created.</span><br><span class="line"></span><br><span class="line">SQL&gt;</span><br><span class="line">Table created.</span><br><span class="line"></span><br><span class="line">SQL&gt; alter table lp pctfree 24;</span><br><span class="line"></span><br><span class="line">Table altered.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SQL&gt; select object_id,object_name from dba_objects  where object_name='LP';</span><br><span class="line"></span><br><span class="line"> OBJECT_ID OBJECT_NAME</span><br><span class="line"><span class="comment">---------- ------------------------------</span></span><br><span class="line">     78760 LP</span><br></pre></td></tr></table></figure>

<blockquote>
<p>首先看一下，78760这个对象在buffer里的数据块有哪些</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';</span><br><span class="line"></span><br><span class="line">     FILE<span class="comment">#     BLOCK# D       OBJD</span></span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         5        131 N      78760</span><br><span class="line">         5        129 N      78760</span><br><span class="line">         5        130 N      78760</span><br><span class="line">         5        128 N      78760</span><br></pre></td></tr></table></figure>

<blockquote>
<p>有没有眼熟呢，128、129、130、131四个块刚好是两个L1、L2、L3<br>我们定位段头块，看一下此时的高水位</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; select segment_name ,HEADER_FILE,HEADER_BLOCK from dba_segments where segment_name='LP';</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME                   HEADER_FILE HEADER_BLOCK</span><br><span class="line"><span class="comment">------------------------------ ----------- ------------</span></span><br><span class="line">LP                                       5          131</span><br><span class="line"></span><br><span class="line">Extent Control Header</span><br><span class="line">  <span class="comment">-----------------------------------------------------------------</span></span><br><span class="line">  Extent Header:: spare1: 0      spare2: 0      <span class="comment">#extents: 1      #blocks: 128   </span></span><br><span class="line">                  last map  0x00000000  <span class="comment">#maps: 0      offset: 2716  </span></span><br><span class="line">      Highwater::  0x01400084  ext<span class="comment">#: 0      blk#: 4      ext size: 128   </span></span><br><span class="line">  <span class="comment">#blocks in seg. hdr's freelists: 0     </span></span><br><span class="line">  <span class="comment">#blocks below: 0     </span></span><br><span class="line">  mapblk  0x00000000  offset: 0     </span><br><span class="line"></span><br><span class="line">SQL&gt; select dbms_utility.data_block_address_file(to_number('01400084', 'xxxxxxxx')) file#,</span><br><span class="line">  2                      dbms_utility.data_block_address_block(to_number('01400084', 'xxxxxxxx')) block<span class="comment">#</span></span><br><span class="line">  3  from dual;</span><br><span class="line"></span><br><span class="line">     FILE<span class="comment">#     BLOCK#</span></span><br><span class="line"><span class="comment">---------- ----------</span></span><br><span class="line">         5        132</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以看出在没有任何数据的情况下，高水位是在第一个数据块上的，下面常规插入一行数据</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> lp <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'a'</span>,<span class="string">'a'</span>,<span class="string">'a'</span>,<span class="string">'a'</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>看一下高水位和buffer中的块</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';</span><br><span class="line"></span><br><span class="line">     FILE<span class="comment">#     BLOCK# D       OBJD</span></span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         5        165 Y      78760</span><br><span class="line">         5        131 Y      78760</span><br><span class="line">         5        173 Y      78760</span><br><span class="line">         5        160 Y      78760</span><br><span class="line">         5        168 Y      78760</span><br><span class="line">         5        163 Y      78760</span><br><span class="line">         5        129 N      78760</span><br><span class="line">         5        171 Y      78760</span><br><span class="line">         5        166 Y      78760</span><br><span class="line">         5        174 Y      78760</span><br><span class="line">         5        161 Y      78760</span><br><span class="line"></span><br><span class="line">     FILE<span class="comment">#     BLOCK# D       OBJD</span></span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         5        169 Y      78760</span><br><span class="line">         5        164 Y      78760</span><br><span class="line">         5        130 N      78760</span><br><span class="line">         5        172 Y      78760</span><br><span class="line">         5        167 Y      78760</span><br><span class="line">         5        175 Y      78760</span><br><span class="line">         5        162 Y      78760</span><br><span class="line">         5        128 Y      78760</span><br><span class="line">         5        170 Y      78760</span><br><span class="line"></span><br><span class="line">20 rows selected.</span><br><span class="line"></span><br><span class="line">SQL&gt; select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp;</span><br><span class="line"></span><br><span class="line">DBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)</span><br><span class="line"><span class="comment">------------------------------------ ------------------------------------</span></span><br><span class="line">                                   5                                  160</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Extent Control Header</span><br><span class="line">-----------------------------------------------------------------</span><br><span class="line">Extent Header:: spare1: 0 spare2: 0 #extents: 1 #blocks: 128</span><br><span class="line">last map 0x00000000 #maps: 0 offset: 2716</span><br><span class="line">Highwater:: 0x014000c0 ext#: 0 blk#: 64 ext size: 128</span><br><span class="line">#blocks in seg. hdr&apos;s freelists: 0</span><br><span class="line">#blocks below: 60</span><br><span class="line">mapblk 0x00000000 offset: 0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>发现数据插入到160号块中，buffer中却多了16个块，高水位已移动到第二个L1中的第一个块上，看一下第一个L1</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HWM Flag: HWM Set</span><br><span class="line">      Highwater::  0x014000c0  ext#: 0      blk#: 64     ext size: 128   </span><br><span class="line">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class="line">  #blocks below: 60    </span><br><span class="line">  mapblk  0x00000000  offset: 0     </span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">  DBA Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x01400080  Length: 64     Offset: 0      </span><br><span class="line"></span><br><span class="line">   0:Metadata   1:Metadata   2:Metadata   3:Metadata</span><br><span class="line">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class="line">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class="line">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class="line">   16:unformatted   17:unformatted   18:unformatted   19:unformatted</span><br><span class="line">   20:unformatted   21:unformatted   22:unformatted   23:unformatted</span><br><span class="line">   24:unformatted   25:unformatted   26:unformatted   27:unformatted</span><br><span class="line">   28:unformatted   29:unformatted   30:unformatted   31:unformatted</span><br><span class="line">   32:FULL   33:75-100% free   34:75-100% free   35:75-100% free</span><br><span class="line">   36:75-100% free   37:75-100% free   38:75-100% free   39:75-100% free</span><br><span class="line">   40:75-100% free   41:75-100% free   42:75-100% free   43:75-100% free</span><br><span class="line">   44:75-100% free   45:75-100% free   46:75-100% free   47:75-100% free</span><br><span class="line">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class="line">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class="line">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class="line">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">   SQL&gt; select dbms_utility.data_block_address_file(to_number('014000c0', 'xxxxxxxx')) file#,</span><br><span class="line">  2                      dbms_utility.data_block_address_block(to_number('014000c0', 'xxxxxxxx')) block<span class="comment">#</span></span><br><span class="line">  3  from dual;</span><br><span class="line"></span><br><span class="line">     FILE<span class="comment">#     BLOCK#</span></span><br><span class="line"><span class="comment">---------- ----------</span></span><br><span class="line">         5        192</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以发现，buffer中新增的16个块是一次性格式化的这16个块，而高水位指在192号块上，直接路径插入一行</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';</span><br><span class="line"></span><br><span class="line">     FILE<span class="comment">#     BLOCK# D       OBJD</span></span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         5        165 N      78760</span><br><span class="line">         5        131 N      78760</span><br><span class="line">         5        173 N      78760</span><br><span class="line">         5        160 N      78760</span><br><span class="line">         5        168 N      78760</span><br><span class="line">         5        163 N      78760</span><br><span class="line">         5        129 N      78760</span><br><span class="line">         5        171 N      78760</span><br><span class="line">         5        166 N      78760</span><br><span class="line">         5        174 N      78760</span><br><span class="line">         5        161 N      78760</span><br><span class="line"></span><br><span class="line">     FILE<span class="comment">#     BLOCK# D       OBJD</span></span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         5        169 N      78760</span><br><span class="line">         5        164 N      78760</span><br><span class="line">         5        130 N      78760</span><br><span class="line">         5        172 N      78760</span><br><span class="line">         5        167 N      78760</span><br><span class="line">         5        175 N      78760</span><br><span class="line">         5        162 N      78760</span><br><span class="line">         5        128 N      78760</span><br><span class="line">         5        170 N      78760</span><br><span class="line"></span><br><span class="line">20 rows selected.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SQL&gt; insert /*+ append_values(lp)*/ into lp values(2,'b','b','b','b');</span><br><span class="line"></span><br><span class="line">1 row created.</span><br><span class="line"></span><br><span class="line">SQL&gt; commit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Commit</span> complete.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span>&gt; <span class="keyword">select</span> dbms_rowid.ROWID_RELATIVE_FNO(<span class="keyword">rowid</span>),dbms_rowid.ROWID_BLOCK_NUMBER(<span class="keyword">rowid</span>) <span class="keyword">from</span> lp;</span><br><span class="line"></span><br><span class="line">DBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)</span><br><span class="line"><span class="comment">------------------------------------ ------------------------------------</span></span><br><span class="line">                                   5                                  160</span><br><span class="line">                                   5                                  192</span><br><span class="line"></span><br><span class="line">SQL&gt; select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';</span><br><span class="line"></span><br><span class="line">     FILE<span class="comment">#     BLOCK# D       OBJD</span></span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         5        165 N      78760</span><br><span class="line">         5        131 Y      78760</span><br><span class="line">         5        173 N      78760</span><br><span class="line">         5        160 N      78760</span><br><span class="line">         5        168 N      78760</span><br><span class="line">         5        163 N      78760</span><br><span class="line">         5        129 Y      78760</span><br><span class="line">         5        171 N      78760</span><br><span class="line">         5        192 Y      78760</span><br><span class="line">         5        166 N      78760</span><br><span class="line">         5        174 N      78760</span><br><span class="line"></span><br><span class="line">     FILE<span class="comment">#     BLOCK# D       OBJD</span></span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         5        161 N      78760</span><br><span class="line">         5        169 N      78760</span><br><span class="line">         5        164 N      78760</span><br><span class="line">         5        130 N      78760</span><br><span class="line">         5        172 N      78760</span><br><span class="line">         5        167 N      78760</span><br><span class="line">         5        175 N      78760</span><br><span class="line">         5        162 N      78760</span><br><span class="line">         5        128 Y      78760</span><br><span class="line">         5        170 N      78760</span><br><span class="line"></span><br><span class="line">21 rows selected.</span><br><span class="line"></span><br><span class="line">SQL&gt; alter system checkpoint;</span><br><span class="line"></span><br><span class="line">System altered.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以发现确实插入到了192号块，并且192号块已在buffer中，看一下此时的高水位</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Extent Control Header</span><br><span class="line">  -----------------------------------------------------------------</span><br><span class="line">  Extent Header:: spare1: 0      spare2: 0      #extents: 1      #blocks: 128   </span><br><span class="line">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class="line">      Highwater::  0x014000c1  ext#: 0      blk#: 65     ext size: 128   </span><br><span class="line">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class="line">  #blocks below: 65    </span><br><span class="line">  mapblk  0x00000000  offset: 0  </span><br><span class="line"></span><br><span class="line">HWM Flag: HWM Set</span><br><span class="line">      Highwater::  0x014000c1  ext#: 0      blk#: 65     ext size: 128   </span><br><span class="line">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class="line">  #blocks below: 65    </span><br><span class="line">  mapblk  0x00000000  offset: 0     </span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">  DBA Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x014000c0  Length: 64     Offset: 0      </span><br><span class="line"></span><br><span class="line">   0:FULL   1:unformatted   2:unformatted   3:unformatted</span><br><span class="line">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class="line">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class="line">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class="line">   16:unformatted   17:unformatted   18:unformatted   19:unformatted</span><br><span class="line">   20:unformatted   21:unformatted   22:unformatted   23:unformatted</span><br><span class="line">   24:unformatted   25:unformatted   26:unformatted   27:unformatted</span><br><span class="line">   28:unformatted   29:unformatted   30:unformatted   31:unformatted</span><br><span class="line">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class="line">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class="line">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class="line">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class="line">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class="line">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class="line">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class="line">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">End dump data blocks tsn: 5 file#: 5 minblk 129 maxblk 129</span><br></pre></td></tr></table></figure>

<blockquote>
<p>发现高水位仅仅移动了1个block，再试一遍</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; insert /*+ append_values(lp)*/ into lp values(3,'c','c','c','c');</span><br><span class="line"></span><br><span class="line">1 row created.</span><br><span class="line"></span><br><span class="line">SQL&gt; commit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Commit</span> complete.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span>&gt; <span class="keyword">select</span> dbms_rowid.ROWID_RELATIVE_FNO(<span class="keyword">rowid</span>),dbms_rowid.ROWID_BLOCK_NUMBER(<span class="keyword">rowid</span>) <span class="keyword">from</span> lp;</span><br><span class="line"></span><br><span class="line">DBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)</span><br><span class="line"><span class="comment">------------------------------------ ------------------------------------</span></span><br><span class="line">                                   5                                  160</span><br><span class="line">                                   5                                  192</span><br><span class="line">                                   5                                  193</span><br><span class="line"></span><br><span class="line">SQL&gt; select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';</span><br><span class="line"></span><br><span class="line">     FILE<span class="comment">#     BLOCK# D       OBJD</span></span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         5        165 N      78760</span><br><span class="line">         5        131 Y      78760</span><br><span class="line">         5        173 N      78760</span><br><span class="line">         5        160 N      78760</span><br><span class="line">         5        168 N      78760</span><br><span class="line">         5        163 N      78760</span><br><span class="line">         5        129 Y      78760</span><br><span class="line">         5        171 N      78760</span><br><span class="line">         5        192 N      78760</span><br><span class="line">         5        166 N      78760</span><br><span class="line">         5        174 N      78760</span><br><span class="line"></span><br><span class="line">     FILE<span class="comment">#     BLOCK# D       OBJD</span></span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         5        161 N      78760</span><br><span class="line">         5        169 N      78760</span><br><span class="line">         5        164 N      78760</span><br><span class="line">         5        130 N      78760</span><br><span class="line">         5        172 N      78760</span><br><span class="line">         5        193 Y      78760</span><br><span class="line">         5        167 N      78760</span><br><span class="line">         5        175 N      78760</span><br><span class="line">         5        162 N      78760</span><br><span class="line">         5        128 N      78760</span><br><span class="line">         5        170 N      78760</span><br><span class="line"></span><br><span class="line">22 rows selected.</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Extent Header:: spare1: 0      spare2: 0      #extents: 1      #blocks: 128   </span><br><span class="line">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class="line">      Highwater::  0x014000c2  ext#: 0      blk#: 66     ext size: 128   </span><br><span class="line">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class="line">  #blocks below: 66    </span><br><span class="line">  mapblk  0x00000000  offset: 0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>仍然是只推动了一个block，但是发现为何每次直接路径插入的block都会出现在buffer里呢？难道是11g这个append_values新的hint的原因，再来试一下传统的append</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">  SQL&gt; insert /*+ append*/ into lp select *  from lp where trim(des1)='a';</span><br><span class="line"></span><br><span class="line">1 row created.</span><br><span class="line"></span><br><span class="line">SQL&gt; commit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Commit</span> complete.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span>&gt; <span class="keyword">select</span> dbms_rowid.ROWID_RELATIVE_FNO(<span class="keyword">rowid</span>),dbms_rowid.ROWID_BLOCK_NUMBER(<span class="keyword">rowid</span>) <span class="keyword">from</span> lp;</span><br><span class="line"></span><br><span class="line">DBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)</span><br><span class="line"><span class="comment">------------------------------------ ------------------------------------</span></span><br><span class="line">                                   5                                  160</span><br><span class="line">                                   5                                  192</span><br><span class="line">                                   5                                  193</span><br><span class="line">                                   5                                  194</span><br><span class="line"></span><br><span class="line">SQL&gt; select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';</span><br><span class="line"></span><br><span class="line">     FILE<span class="comment">#     BLOCK# D       OBJD</span></span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         5        165 N      78760</span><br><span class="line">         5        131 Y      78760</span><br><span class="line">         5        173 N      78760</span><br><span class="line">         5        194 Y      78760</span><br><span class="line">         5        160 N      78760</span><br><span class="line">         5        168 N      78760</span><br><span class="line">         5        163 N      78760</span><br><span class="line">         5        129 Y      78760</span><br><span class="line">         5        171 N      78760</span><br><span class="line">         5        192 N      78760</span><br><span class="line">         5        166 N      78760</span><br><span class="line"></span><br><span class="line">     FILE<span class="comment">#     BLOCK# D       OBJD</span></span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         5        174 N      78760</span><br><span class="line">         5        161 N      78760</span><br><span class="line">         5        169 N      78760</span><br><span class="line">         5        164 N      78760</span><br><span class="line">         5        130 N      78760</span><br><span class="line">         5        172 N      78760</span><br><span class="line">         5        193 N      78760</span><br><span class="line">         5        167 N      78760</span><br><span class="line">         5        175 N      78760</span><br><span class="line">         5        162 N      78760</span><br><span class="line">         5        128 N      78760</span><br><span class="line"></span><br><span class="line">     FILE<span class="comment">#     BLOCK# D       OBJD</span></span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         5        170 N      78760</span><br><span class="line"></span><br><span class="line">23 rows selected.</span><br><span class="line"></span><br><span class="line">SQL&gt; alter system checkpoint;</span><br><span class="line"></span><br><span class="line">System altered.</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Extent Control Header</span><br><span class="line">-----------------------------------------------------------------</span><br><span class="line">Extent Header:: spare1: 0      spare2: 0      #extents: 1      #blocks: 128   </span><br><span class="line">                last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class="line">    Highwater::  0x014000c3  ext#: 0      blk#: 67     ext size: 128   </span><br><span class="line">#blocks in seg. hdr&apos;s freelists: 0     </span><br><span class="line">#blocks below: 67    </span><br><span class="line">mapblk  0x00000000  offset: 0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>依然如故，不知道大家有没有发现，每次我执行完插入，都会执行一条select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp;<br>这其实是全表扫描，本来块没在buffer里，一个FTS把块全给整进来了（小表buffer读，大表在11g中通常情况是直接路径读），知道原因了，再试一遍</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; insert /*+ append*/ into lp select *  from lp where trim(des1)='b';</span><br><span class="line"></span><br><span class="line">1 row created.</span><br><span class="line"></span><br><span class="line">SQL&gt; commit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Commit</span> complete.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span>&gt; <span class="keyword">select</span> <span class="keyword">file</span><span class="comment">#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';</span></span><br><span class="line"></span><br><span class="line">     <span class="keyword">FILE</span><span class="comment">#     BLOCK# D       OBJD</span></span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">165</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">131</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">173</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">194</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">160</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">168</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">163</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">129</span> Y      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">171</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">192</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">166</span> N      <span class="number">78760</span></span><br><span class="line"></span><br><span class="line">     <span class="keyword">FILE</span><span class="comment">#     BLOCK# D       OBJD</span></span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">174</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">161</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">169</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">164</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">130</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">172</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">193</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">167</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">175</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">162</span> N      <span class="number">78760</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">128</span> N      <span class="number">78760</span></span><br><span class="line"></span><br><span class="line">     <span class="keyword">FILE</span><span class="comment">#     BLOCK# D       OBJD</span></span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         <span class="number">5</span>        <span class="number">170</span> N      <span class="number">78760</span></span><br><span class="line"></span><br><span class="line"><span class="number">23</span> <span class="keyword">rows</span> selected.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span>&gt; <span class="keyword">select</span> dbms_rowid.ROWID_RELATIVE_FNO(<span class="keyword">rowid</span>),dbms_rowid.ROWID_BLOCK_NUMBER(<span class="keyword">rowid</span>) <span class="keyword">from</span> lp;</span><br><span class="line"></span><br><span class="line">DBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)</span><br><span class="line"><span class="comment">------------------------------------ ------------------------------------</span></span><br><span class="line">                                   5                                  160</span><br><span class="line">                                   5                                  192</span><br><span class="line">                                   5                                  193</span><br><span class="line">                                   5                                  194</span><br><span class="line">                                   5                                  195</span><br><span class="line"></span><br><span class="line">SQL&gt; select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';</span><br><span class="line"></span><br><span class="line">     FILE<span class="comment">#     BLOCK# D       OBJD</span></span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         5        165 N      78760</span><br><span class="line">         5        131 Y      78760</span><br><span class="line">         5        173 N      78760</span><br><span class="line">         5        194 N      78760</span><br><span class="line">         5        160 N      78760</span><br><span class="line">         5        168 N      78760</span><br><span class="line">         5        163 N      78760</span><br><span class="line">         5        129 Y      78760</span><br><span class="line">         5        171 N      78760</span><br><span class="line">         5        192 N      78760</span><br><span class="line">         5        166 N      78760</span><br><span class="line"></span><br><span class="line">     FILE<span class="comment">#     BLOCK# D       OBJD</span></span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         5        174 N      78760</span><br><span class="line">         5        195 Y      78760</span><br><span class="line">         5        161 N      78760</span><br><span class="line">         5        169 N      78760</span><br><span class="line">         5        164 N      78760</span><br><span class="line">         5        130 N      78760</span><br><span class="line">         5        172 N      78760</span><br><span class="line">         5        193 N      78760</span><br><span class="line">         5        167 N      78760</span><br><span class="line">         5        175 N      78760</span><br><span class="line">         5        162 N      78760</span><br><span class="line"></span><br><span class="line">     FILE<span class="comment">#     BLOCK# D       OBJD</span></span><br><span class="line"><span class="comment">---------- ---------- - ----------</span></span><br><span class="line">         5        128 N      78760</span><br><span class="line">         5        170 N      78760</span><br><span class="line"></span><br><span class="line">24 rows selected.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>终于看到了想要的结果，总结一下吧，直接路径下高水位的推进大概如下图的样子：</p>
</blockquote>
<p><img alt data-src="http://oaowhilvu.bkt.clouddn.com/direct.png"></p>
<blockquote>
<p>不知道大家有没有注意到，直接路径插入完后再读入buffer中居然是个脏块，这是不是跟延迟提交清除有关呢？我们以后再慢慢分析！</p>
</blockquote>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2015/09/25/oracle/architecture/ASSM1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="巴流">
      <meta itemprop="description" content="左手人文 | 右手科技">
      <meta itemprop="image" content="/images/heizi.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2015/09/25/oracle/architecture/ASSM1/" class="post-title-link" itemprop="url">ASSM三级位图结构与高水位的探究（上）</a>
              
            
          </h2>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2015-09-25 14:51:00" itemprop="dateCreated datePublished" datetime="2015-09-25T14:51:00+08:00">2015-09-25</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-21 13:04:46" itemprop="dateModified" datetime="2019-07-21T13:04:46+08:00">2019-07-21</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/oracle/" itemprop="url" rel="index"><span itemprop="name">oracle</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>#ASSM三级位图结构与高水位的探究</p>
<blockquote>
<p>三级位图</p>
</blockquote>
<p>Oracle9i在本地表空管理(LMT)的基础上，对段空间管理也引入了位图管理（Segment Space Management Auto）来取代原来的freelist管理方式（Segment Space Management Manual）。<br>但是默认system和undo表空间仍然是MSSM的管理方式，本文主要探究ASSM管理方式下，段的三级位图结构和高水位推进的关系 先来看<br>ASSM管理方式下的三级位图结构图：</p>
<p><img alt data-src="http://oaowhilvu.bkt.clouddn.com/%E4%B8%89%E7%BA%A7%E4%BD%8D%E5%9B%BE.jpg"><br><em>注：此图来源于网络</em><br>一个段被创建之后，段头其实是一个L3块，在我的试验中，一个1M固定区大小，block为8K的表空间，创建的第一个段第0个区，前两个块是L1（128,129号块），第三个是L2（130号块），第四个是L3（131号块），前128个块是数据文件头，本文不讨论。<br>当数据被插入的时候，oracle根据连接进来的session，做hash运算，随机选择一个L3（如果有多个的话），再随机选择一个L2，接下来在该L2下随机选择一个L1，再从L1中管理的block里面随机选择一个块将数据插入，不同的session经过hash之后，最后落到block时已经是很分散的了，不会产生很多和会话同时往一个block中插数据申请独占buffer pin，而造成大量buffer busy waits的情况，这就是ASSM号称支持大并发插入的原理所在，但是事实上真的如此么？我们来一探究竟！</p>
<blockquote>
<p>实验环境</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">OS:REDHAT6.5 X64</span><br><span class="line">DB VERSION:11.2.0.4</span><br></pre></td></tr></table></figure>

<blockquote>
<p>首先，创建一个1M区大小的表空间，并在上面创建一张表，此表创建了4个空间很大的字段，目的是要一行占满一个block，便于观察结果</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; select file#,NAME,BYTES/1024/1204 from v$datafile;</span><br><span class="line"></span><br><span class="line">     FILE<span class="comment"># NAME                                                                             BYTES/1024/1204</span></span><br><span class="line"><span class="comment">---------- -------------------------------------------------------------------------------- ---------------</span></span><br><span class="line">         1 +DATA/min/datafile/system.256.854775095                                               637.873754</span><br><span class="line">         2 +DATA/min/datafile/sysaux.257.854775097                                               484.784053</span><br><span class="line">         3 +DATA/min/datafile/undotbs1.258.854775097                                             187.109635</span><br><span class="line">         4 +DATA/min/datafile/users.259.854775097                                                103.122924</span><br><span class="line"></span><br><span class="line">SQL&gt; create tablespace lp datafile '+DATA/min/datafile/lp.dbf' size 2048M uniform size 1m;</span><br><span class="line"></span><br><span class="line">Tablespace created.</span><br><span class="line"></span><br><span class="line">SQL&gt; select file#,NAME,BYTES/1024/1204 from v$datafile;</span><br><span class="line"></span><br><span class="line">     FILE<span class="comment"># NAME                                                                             BYTES/1024/1204</span></span><br><span class="line"><span class="comment">---------- -------------------------------------------------------------------------------- ---------------</span></span><br><span class="line">         1 +DATA/min/datafile/system.256.854775095                                               637.873754</span><br><span class="line">         2 +DATA/min/datafile/sysaux.257.854775097                                               484.784053</span><br><span class="line">         3 +DATA/min/datafile/undotbs1.258.854775097                                             187.109635</span><br><span class="line">         4 +DATA/min/datafile/users.259.854775097                                                103.122924</span><br><span class="line">         5 +DATA/min/datafile/lp.dbf                                                              1741.8206</span><br><span class="line"></span><br><span class="line">SQL&gt; create table lp (id number,des1 char(2000),des2 char(2000),des3 char(2000),des4 char(500)) tablespace lp;</span><br><span class="line"></span><br><span class="line">Table created.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>观察新建的表所占区</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; col SEGMENT_NAME for a30</span><br><span class="line">SQL&gt; col des1 for a1</span><br><span class="line">SQL&gt; col des2 for a1</span><br><span class="line">SQL&gt; col des3 for a1</span><br><span class="line">SQL&gt; col des4 for a1</span><br><span class="line">SQL&gt; set line 200</span><br><span class="line">SQL&gt; select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID, BLOCKS from dba_extents where segment_name='LP';</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME                    EXTENT_ID    FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line"><span class="comment">------------------------------ ---------- ---------- ---------- ----------</span></span><br><span class="line">LP                                      0          5        128        128</span><br></pre></td></tr></table></figure>

<blockquote>
<p>此表是5号文件，拥有1个区，block从128号开始，接下来我们插入一条数据，并dump出段头进行观察</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; insert into lp values(1,'a','a','a','a');</span><br><span class="line"></span><br><span class="line">1 row created.</span><br><span class="line"></span><br><span class="line">SQL&gt; commit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Commit</span> complete.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span>&gt; <span class="keyword">select</span> segment_name ,HEADER_FILE,HEADER_BLOCK <span class="keyword">from</span> dba_segments <span class="keyword">where</span> segment_name=<span class="string">'LP'</span>;</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME                   HEADER_FILE HEADER_BLOCK</span><br><span class="line"><span class="comment">------------------------------ ----------- ------------</span></span><br><span class="line">LP                                       5          131</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SQL&gt; alter system checkpoint;</span><br><span class="line"></span><br><span class="line">System altered.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>LP的段头是5号文件，131号块，进行dump</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; alter system dump datafile 5 block 131;</span><br><span class="line"></span><br><span class="line">SQL&gt; col value for a65</span><br><span class="line">SQL&gt; select *  from v$diag_info;</span><br><span class="line"></span><br><span class="line">   INST_ID NAME                                                                             VALUE</span><br><span class="line"><span class="comment">---------- -------------------------------------------------------------------------------- -----------------------------------------------------------------</span></span><br><span class="line">         1 Diag Enabled                                                                     TRUE</span><br><span class="line">         1 ADR Base                                                                         /u01/app/oracle</span><br><span class="line">         1 ADR Home                                                                         /u01/app/oracle/diag/rdbms/min/min</span><br><span class="line">         1 Diag Trace                                                                       /u01/app/oracle/diag/rdbms/min/min/trace</span><br><span class="line">         1 Diag Alert                                                                       /u01/app/oracle/diag/rdbms/min/min/alert</span><br><span class="line">         1 Diag Incident                                                                    /u01/app/oracle/diag/rdbms/min/min/incident</span><br><span class="line">         1 Diag Cdump                                                                       /u01/app/oracle/diag/rdbms/min/min/cdump</span><br><span class="line">         1 Health Monitor                                                                   /u01/app/oracle/diag/rdbms/min/min/hm</span><br><span class="line">         1 Default Trace File                                                               /u01/app/oracle/diag/rdbms/min/min/trace/min_ora_2835.trc</span><br><span class="line">         1 Active Problem Count                                                             0</span><br><span class="line">         1 Active Incident Count                                                            0</span><br><span class="line"></span><br><span class="line">11 rows selected.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>观察trc文件min_ora_2835.trc</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Block dump from disk:</span><br><span class="line">buffer tsn: 8 rdba: 0x01400083 (5/131)</span><br><span class="line">scn: 0x0000.00140d51 seq: 0x01 flg: 0x04 tail: 0x0d512301</span><br><span class="line">frmt: 0x02 chkval: 0xfd8a type: 0x23=PAGETABLE SEGMENT HEADER</span><br><span class="line">Hex dump of block: st=0, typ_found=1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Extent Control Header</span><br><span class="line">  -----------------------------------------------------------------</span><br><span class="line">  Extent Header:: spare1: 0      spare2: 0      #extents: 1      #blocks: 128   </span><br><span class="line">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class="line">      Highwater::  0x014000c0  ext#: 0      blk#: 64     ext size: 128   </span><br><span class="line">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class="line">  #blocks below: 60    </span><br><span class="line">  mapblk  0x00000000  offset: 0     </span><br><span class="line">                   Unlocked</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">  Low HighWater Mark :</span><br><span class="line">      Highwater::  0x01400084  ext#: 0      blk#: 4      ext size: 128   </span><br><span class="line">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class="line">  #blocks below: 0     </span><br><span class="line">  mapblk  0x00000000  offset: 0     </span><br><span class="line">  Level 1 BMB for High HWM block: 0x01400080</span><br><span class="line">  Level 1 BMB for Low HWM block: 0x01400080</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">  Segment Type: 1 nl2: 1      blksz: 8192   fbsz: 0      </span><br><span class="line">  L2 Array start offset:  0x00001434</span><br><span class="line">  First Level 3 BMB:  0x00000000</span><br><span class="line">  L2 Hint for inserts:  0x01400082</span><br><span class="line">  Last Level 1 BMB:  0x01400081</span><br><span class="line">  Last Level II BMB:  0x01400082</span><br><span class="line">  Last Level III BMB:  0x00000000</span><br><span class="line">     Map Header:: next  0x00000000  #extents: 1    obj#: 87596  flag: 0x10000000</span><br><span class="line">  Inc # 0</span><br><span class="line">  Extent Map</span><br><span class="line">  -----------------------------------------------------------------</span><br><span class="line">   0x01400080  length: 128   </span><br><span class="line"></span><br><span class="line">  Auxillary Map</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   Extent 0     :  L1 dba:  0x01400080 Data dba:  0x01400084</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Second Level Bitmap block DBAs</span><br><span class="line">   --------------------------------------------------------</span><br><span class="line">   DBA 1:   0x01400082</span><br><span class="line"></span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 131 maxblk 131</span><br></pre></td></tr></table></figure>

<blockquote>
<p>很容易发现这是一个PAGETABLE SEGMENT HEADER块，Extent Map中只有一个区，另外在尾部有一个指向二级位图块的地址0x01400082，这是数据块地址的二进制用十六进制来表示，我们来将其转化成直观一点的信息</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; select dbms_utility.data_block_address_file(to_number('01400082', 'xxxxxxxx')) file#,</span><br><span class="line">  2 dbms_utility.data_block_address_block(to_number('01400082', 'xxxxxxxx')) block<span class="comment">#</span></span><br><span class="line">  3 from dual;</span><br><span class="line"></span><br><span class="line">     FILE<span class="comment"># BLOCK#</span></span><br><span class="line"><span class="comment">---------- ----------</span></span><br><span class="line">         5 130</span><br></pre></td></tr></table></figure>

<blockquote>
<p>依样将5号文件130号块的内容dump出来</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Block dump from disk:</span><br><span class="line">buffer tsn: 8 rdba: 0x01400082 (5/130)</span><br><span class="line">scn: 0x0000.00140a45 seq: 0x02 flg: 0x04 tail: 0x0a452102</span><br><span class="line">frmt: 0x02 chkval: 0xd119 type: 0x21=SECOND LEVEL BITMAP BLOCK</span><br><span class="line">Hex dump of block: st=0, typ_found=1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Dump of Second Level Bitmap Block</span><br><span class="line">   number: 2       nfree: 2       ffree: 0      pdba:     0x01400083</span><br><span class="line">   Inc #: 0 Objd: 87596</span><br><span class="line">  opcode:0</span><br><span class="line"> xid:</span><br><span class="line">  L1 Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x01400080  Free: 5 Inst: 1</span><br><span class="line">   0x01400081  Free: 5 Inst: 1</span><br><span class="line"></span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 130 maxblk 130</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以发现这是一个二级位图块，并从其中找到了2个L1块的地址，我们来看第一个L1</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Block dump from disk:</span><br><span class="line">buffer tsn: 8 rdba: 0x01400080 (5/128)</span><br><span class="line">scn: 0x0000.00140d51 seq: 0x03 flg: 0x04 tail: 0x0d512003</span><br><span class="line">frmt: 0x02 chkval: 0xe697 type: 0x20=FIRST LEVEL BITMAP BLOCK</span><br><span class="line">Hex dump of block: st=0, typ_found=1</span><br><span class="line"></span><br><span class="line">DBA Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x01400080  Length: 64     Offset: 0      </span><br><span class="line"></span><br><span class="line">   0:Metadata   1:Metadata   2:Metadata   3:Metadata</span><br><span class="line">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class="line">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class="line">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class="line">   16:75-100% free   17:75-100% free   18:75-100% free   19:75-100% free</span><br><span class="line">   20:75-100% free   21:75-100% free   22:75-100% free   23:75-100% free</span><br><span class="line">   24:75-100% free   25:75-100% free   26:75-100% free   27:75-100% free</span><br><span class="line">   28:75-100% free   29:75-100% free   30:75-100% free   31:0-25% free</span><br><span class="line">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class="line">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class="line">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class="line">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class="line">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class="line">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class="line">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class="line">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 128 maxblk 128</span><br></pre></td></tr></table></figure>

<blockquote>
<p>无疑这是一个L1块，里面挂了64个数据块，因为我之前插入了一行数据，oracle已经格式化了一部分，并向其中一个块插入了数据，但是没达到我们的效果，被插入的块还显示0-25%的空闲，我们要的是full的状态，说明我们构造的数据不够大，没关系，我们修改一下pctfree就可以了，另外我们可以发现这个区是1M，有2个L1，每个L1里有64个数据块，接下来修改pctfree</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; alter table lp pctfree 24;</span><br><span class="line"></span><br><span class="line">Table altered.</span><br><span class="line"></span><br><span class="line">SQL&gt; select TABLE_NAME,PCT_FREE from dba_tables where table_name='LP';</span><br><span class="line"></span><br><span class="line">TABLE_NAME                       PCT_FREE</span><br><span class="line"><span class="comment">------------------------------ ----------</span></span><br><span class="line">LP                                     24</span><br><span class="line"></span><br><span class="line">SQL&gt; insert into lp values(2,'a','a','a','a');</span><br><span class="line"></span><br><span class="line">1 row created.</span><br><span class="line"></span><br><span class="line">SQL&gt; commit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Commit</span> complete.</span><br><span class="line"><span class="comment">--手动触发检查点将内存中的块刷新到磁盘，本文每次dump之前都会做这个操作，以保证磁盘和内存的内容一致</span></span><br><span class="line"><span class="keyword">SQL</span>&gt; <span class="keyword">alter</span> <span class="keyword">system</span> checkpoint;</span><br><span class="line"></span><br><span class="line">System altered.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们再看128号块</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DBA Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x01400080  Length: 64     Offset: 0      </span><br><span class="line"></span><br><span class="line">   0:Metadata   1:Metadata   2:Metadata   3:Metadata</span><br><span class="line">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class="line">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class="line">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class="line">   16:75-100% free   17:75-100% free   18:75-100% free   19:75-100% free</span><br><span class="line">   20:75-100% free   21:75-100% free   22:75-100% free   23:75-100% free</span><br><span class="line">   24:75-100% free   25:75-100% free   26:75-100% free   27:75-100% free</span><br><span class="line">   28:75-100% free   29:75-100% free   30:75-100% free   31:0-25% free</span><br><span class="line">   32:75-100% free   33:75-100% free   34:75-100% free   &lt;font color=&apos;red&apos;&gt;35:FULL&lt;/font&gt;</span><br><span class="line">   36:75-100% free   37:75-100% free   38:75-100% free   39:75-100% free</span><br><span class="line">   40:75-100% free   41:75-100% free   42:75-100% free   43:75-100% free</span><br><span class="line">   44:75-100% free   45:75-100% free   46:75-100% free   47:75-100% free</span><br><span class="line">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class="line">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class="line">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class="line">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 128 maxblk 128</span><br></pre></td></tr></table></figure>

<blockquote>
<p>已经是我们想的结果了，到这里我们再来看一下另外一个L1吧，dump129号块</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DBA Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x014000c0  Length: 64     Offset: 0      </span><br><span class="line"></span><br><span class="line">   0:unformatted   1:unformatted   2:unformatted   3:unformatted</span><br><span class="line">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class="line">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class="line">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class="line">   16:unformatted   17:unformatted   18:unformatted   19:unformatted</span><br><span class="line">   20:unformatted   21:unformatted   22:unformatted   23:unformatted</span><br><span class="line">   24:unformatted   25:unformatted   26:unformatted   27:unformatted</span><br><span class="line">   28:unformatted   29:unformatted   30:unformatted   31:unformatted</span><br><span class="line">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class="line">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class="line">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class="line">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class="line">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class="line">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class="line">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class="line">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 129 maxblk 129</span><br></pre></td></tr></table></figure>

<blockquote>
<p>全是未格式化的块，试一试并发插入，这里不模拟真正的并发了，只是开不同的session来进行插入</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; insert into lp values(3,'a','a','a','a');</span><br><span class="line"></span><br><span class="line">1 row created.</span><br><span class="line"></span><br><span class="line">SQL&gt; insert into lp values(4,'a','a','a','a');</span><br><span class="line"></span><br><span class="line">1 row created.</span><br><span class="line"></span><br><span class="line">SQL&gt; insert into lp values(5,'a','a','a','a');</span><br><span class="line"></span><br><span class="line">1 row created.</span><br><span class="line"></span><br><span class="line">SQL&gt; insert into lp values(6,'a','a','a','a');</span><br><span class="line"></span><br><span class="line">1 row created.</span><br><span class="line"></span><br><span class="line">SQL&gt; insert into lp values(7,'a','a','a','a');</span><br><span class="line"></span><br><span class="line">1 row created.</span><br><span class="line"></span><br><span class="line"><span class="comment">--单独session5条</span></span><br><span class="line"></span><br><span class="line">SQL&gt; select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp;</span><br><span class="line"></span><br><span class="line">DBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)</span><br><span class="line"><span class="comment">------------------------------------ ------------------------------------</span></span><br><span class="line">                                   5                                  158</span><br><span class="line">                                   5                                  159</span><br><span class="line">                                   5                                  163</span><br><span class="line">                                   5                                  167</span><br><span class="line">                                   5                                  171</span><br><span class="line">                                   5                                  172</span><br><span class="line">                                   5                                  174</span><br><span class="line">                                   5                                  175</span><br><span class="line">                                   5                                  179</span><br><span class="line">                                   5                                  183</span><br><span class="line">                                   5                                  187</span><br><span class="line">                                   5                                  191</span><br><span class="line"></span><br><span class="line">12 rows selected.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>一个单独的session里插入了5条，另外5个单独的session里各插一条，发现规律了么，插入的块只在132和192之间，我们分别看看两个L1</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SQL&gt; alter system checkpoint;</span><br><span class="line"></span><br><span class="line">System altered.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  DBA Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x01400080  Length: 64     Offset: 0      </span><br><span class="line"></span><br><span class="line">   0:Metadata   1:Metadata   2:Metadata   3:Metadata</span><br><span class="line">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class="line">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class="line">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class="line">   16:75-100% free   17:75-100% free   18:75-100% free   19:75-100% free</span><br><span class="line">   20:75-100% free   21:75-100% free   22:75-100% free   23:75-100% free</span><br><span class="line">   24:75-100% free   25:75-100% free   26:75-100% free   27:75-100% free</span><br><span class="line">   28:75-100% free   29:75-100% free   30:FULL   31:0-25% free</span><br><span class="line">   32:75-100% free   33:75-100% free   34:75-100% free   35:FULL</span><br><span class="line">   36:75-100% free   37:75-100% free   38:75-100% free   39:FULL</span><br><span class="line">   40:75-100% free   41:75-100% free   42:75-100% free   43:FULL</span><br><span class="line">   44:FULL   45:75-100% free   46:FULL   47:FULL</span><br><span class="line">   48:75-100% free   49:75-100% free   50:75-100% free   51:FULL</span><br><span class="line">   52:75-100% free   53:75-100% free   54:75-100% free   55:FULL</span><br><span class="line">   56:75-100% free   57:75-100% free   58:75-100% free   59:FULL</span><br><span class="line">   60:75-100% free   61:75-100% free   62:75-100% free   63:FULL</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 128 maxblk 128</span><br><span class="line"></span><br><span class="line">********************************************************************</span><br><span class="line">看一下第二个L1</span><br><span class="line"></span><br><span class="line">DBA Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x014000c0  Length: 64     Offset: 0      </span><br><span class="line"></span><br><span class="line">   0:unformatted   1:unformatted   2:unformatted   3:unformatted</span><br><span class="line">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class="line">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class="line">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class="line">   16:unformatted   17:unformatted   18:unformatted   19:unformatted</span><br><span class="line">   20:unformatted   21:unformatted   22:unformatted   23:unformatted</span><br><span class="line">   24:unformatted   25:unformatted   26:unformatted   27:unformatted</span><br><span class="line">   28:unformatted   29:unformatted   30:unformatted   31:unformatted</span><br><span class="line">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class="line">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class="line">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class="line">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class="line">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class="line">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class="line">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class="line">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 129 maxblk 129</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这说明只在第一个L1里面随机，那为什么L2下挂了2个L1，我插入了10条却没有一条随机到第二个L1块呢？答案是高水位，这是vage大师已经论证过的了，偶在这里仅为见证一下~~，好了，还记得L3里的高水位信息么？</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Extent Control Header</span><br><span class="line">  -----------------------------------------------------------------</span><br><span class="line">  Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928</span><br><span class="line">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class="line">      Highwater::  0x014000c0  ext#: 0      blk#: 64     ext size: 128   </span><br><span class="line">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class="line">  #blocks below: 60    </span><br><span class="line">  mapblk  0x00000000  offset: 0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Highwater::  0x014000c0是哪个块呢？</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">  SQL&gt; select dbms_utility.data_block_address_file(to_number('014000c0', 'xxxxxxxx')) file#,</span><br><span class="line">  2 dbms_utility.data_block_address_block(to_number('014000c0', 'xxxxxxxx')) block<span class="comment">#</span></span><br><span class="line">  3 from dual;</span><br><span class="line"></span><br><span class="line">     FILE<span class="comment"># BLOCK#</span></span><br><span class="line"><span class="comment">---------- ----------</span></span><br><span class="line">         5 192</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这是第二个L1管理的第一个块，可见数据的插入只在高水位之下进行（直接路径插入除外），此时的状态如下：</p>
</blockquote>
<p><img alt data-src="http://oaowhilvu.bkt.clouddn.com/0%E4%B8%AAextent.png"></p>
<blockquote>
<p>那么L1里面只会有64个块么？高水位永远都会指向L1的最后一个块么？我们继续剖析！<br>首先给LP表多分配一些区</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; alter table lp allocate extent(size 100m);</span><br><span class="line"></span><br><span class="line">Table altered.</span><br><span class="line"></span><br><span class="line">SQL&gt; select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID, BLOCKS from dba_extents where segment_name='LP';</span><br><span class="line"></span><br><span class="line">SEGMENT_NAME                    EXTENT_ID    FILE_ID   BLOCK_ID     BLOCKS</span><br><span class="line"><span class="comment">------------------------------ ---------- ---------- ---------- ----------</span></span><br><span class="line">LP                                      0          5        128        128</span><br><span class="line">LP                                      1          5        256        128</span><br><span class="line">LP                                      2          5        384        128</span><br><span class="line">LP                                      3          5        512        128</span><br><span class="line">LP                                      4          5        640        128</span><br><span class="line">LP                                      5          5        768        128</span><br><span class="line">LP                                      6          5        896        128</span><br><span class="line">LP                                      7          5       1024        128</span><br><span class="line">LP                                      8          5       1152        128</span><br><span class="line">LP                                      9          5       1280        128</span><br><span class="line">LP                                     10          5       1408        128</span><br><span class="line">LP                                     11          5       1536        128</span><br><span class="line">LP                                     12          5       1664        128</span><br><span class="line">LP                                     13          5       1792        128</span><br><span class="line">LP                                     14          5       1920        128</span><br><span class="line">LP                                     15          5       2048        128</span><br><span class="line">LP                                     16          5       2176        128</span><br><span class="line">LP                                     17          5       2304        128</span><br><span class="line">LP                                     18          5       2432        128</span><br><span class="line">LP                                     19          5       2560        128</span><br><span class="line">LP                                     20          5       2688        128</span><br><span class="line">LP                                     21          5       2816        128</span><br><span class="line">LP                                     22          5       2944        128</span><br><span class="line">LP                                     23          5       3072        128</span><br><span class="line">LP                                     24          5       3200        128</span><br><span class="line">LP                                     25          5       3328        128</span><br><span class="line">LP                                     26          5       3456        128</span><br><span class="line">LP                                     27          5       3584        128</span><br><span class="line">LP                                     28          5       3712        128</span><br><span class="line">LP                                     29          5       3840        128</span><br><span class="line">LP                                     30          5       3968        128</span><br><span class="line">LP                                     31          5       4096        128</span><br><span class="line">LP                                     32          5       4224        128</span><br><span class="line">LP                                     33          5       4352        128</span><br><span class="line">LP                                     34          5       4480        128</span><br><span class="line">LP                                     35          5       4608        128</span><br><span class="line">LP                                     36          5       4736        128</span><br><span class="line">LP                                     37          5       4864        128</span><br><span class="line">LP                                     38          5       4992        128</span><br><span class="line">LP                                     39          5       5120        128</span><br><span class="line">LP                                     40          5       5248        128</span><br><span class="line">LP                                     41          5       5376        128</span><br><span class="line">LP                                     42          5       5504        128</span><br><span class="line">LP                                     43          5       5632        128</span><br><span class="line">LP                                     44          5       5760        128</span><br><span class="line">LP                                     45          5       5888        128</span><br><span class="line">LP                                     46          5       6016        128</span><br><span class="line">LP                                     47          5       6144        128</span><br><span class="line">LP                                     48          5       6272        128</span><br><span class="line">LP                                     49          5       6400        128</span><br><span class="line">LP                                     50          5       6528        128</span><br><span class="line">LP                                     51          5       6656        128</span><br><span class="line">LP                                     52          5       6784        128</span><br><span class="line">LP                                     53          5       6912        128</span><br><span class="line">LP                                     54          5       7040        128</span><br><span class="line">LP                                     55          5       7168        128</span><br><span class="line">LP                                     56          5       7296        128</span><br><span class="line">LP                                     57          5       7424        128</span><br><span class="line">LP                                     58          5       7552        128</span><br><span class="line">LP                                     59          5       7680        128</span><br><span class="line">LP                                     60          5       7808        128</span><br><span class="line">LP                                     61          5       7936        128</span><br><span class="line">LP                                     62          5       8064        128</span><br><span class="line">LP                                     63          5       8192        128</span><br><span class="line">LP                                     64          5       8320        128</span><br><span class="line">LP                                     65          5       8448        128</span><br><span class="line">LP                                     66          5       8576        128</span><br><span class="line">LP                                     67          5       8704        128</span><br><span class="line">LP                                     68          5       8832        128</span><br><span class="line">LP                                     69          5       8960        128</span><br><span class="line">LP                                     70          5       9088        128</span><br><span class="line">LP                                     71          5       9216        128</span><br><span class="line">LP                                     72          5       9344        128</span><br><span class="line">LP                                     73          5       9472        128</span><br><span class="line">LP                                     74          5       9600        128</span><br><span class="line">LP                                     75          5       9728        128</span><br><span class="line">LP                                     76          5       9856        128</span><br><span class="line">LP                                     77          5       9984        128</span><br><span class="line">LP                                     78          5      10112        128</span><br><span class="line">LP                                     79          5      10240        128</span><br><span class="line">LP                                     80          5      10368        128</span><br><span class="line">LP                                     81          5      10496        128</span><br><span class="line">LP                                     82          5      10624        128</span><br><span class="line">LP                                     83          5      10752        128</span><br><span class="line">LP                                     84          5      10880        128</span><br><span class="line">LP                                     85          5      11008        128</span><br><span class="line">LP                                     86          5      11136        128</span><br><span class="line">LP                                     87          5      11264        128</span><br><span class="line">LP                                     88          5      11392        128</span><br><span class="line">LP                                     89          5      11520        128</span><br><span class="line">LP                                     90          5      11648        128</span><br><span class="line">LP                                     91          5      11776        128</span><br><span class="line">LP                                     92          5      11904        128</span><br><span class="line">LP                                     93          5      12032        128</span><br><span class="line">LP                                     94          5      12160        128</span><br><span class="line">LP                                     95          5      12288        128</span><br><span class="line">LP                                     96          5      12416        128</span><br><span class="line">LP                                     97          5      12544        128</span><br><span class="line">LP                                     98          5      12672        128</span><br><span class="line">LP                                     99          5      12800        128</span><br><span class="line">LP                                    100          5      12928        128</span><br><span class="line"></span><br><span class="line">101 rows selected.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我分配了100个区，加上原来的一共101个，现在我们看看L3段头里面的内容</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Extent Control Header</span><br><span class="line">  -----------------------------------------------------------------</span><br><span class="line">  Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928</span><br><span class="line">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class="line">      Highwater::  0x014000c0  ext#: 0      blk#: 64     ext size: 128   </span><br><span class="line">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class="line">  #blocks below: 60    </span><br><span class="line">  mapblk  0x00000000  offset: 0     </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Extent Map</span><br><span class="line">  -----------------------------------------------------------------</span><br><span class="line">   0x01400080  length: 128   </span><br><span class="line">   0x01400100  length: 128   </span><br><span class="line">   0x01400180  length: 128   </span><br><span class="line">   0x01400200  length: 128   </span><br><span class="line">   0x01400280  length: 128   </span><br><span class="line">   0x01400300  length: 128   </span><br><span class="line">   0x01400380  length: 128   </span><br><span class="line">   0x01400400  length: 128   </span><br><span class="line">   0x01400480  length: 128   </span><br><span class="line">   0x01400500  length: 128   </span><br><span class="line">   0x01400580  length: 128   </span><br><span class="line">   0x01400600  length: 128   </span><br><span class="line">   0x01400680  length: 128   </span><br><span class="line">   0x01400700  length: 128   </span><br><span class="line">   0x01400780  length: 128   </span><br><span class="line">   0x01400800  length: 128   </span><br><span class="line">   0x01400880  length: 128   </span><br><span class="line">   0x01400900  length: 128   </span><br><span class="line">   0x01400980  length: 128   </span><br><span class="line">   0x01400a00  length: 128   </span><br><span class="line">   0x01400a80  length: 128   </span><br><span class="line">   0x01400b00  length: 128   </span><br><span class="line">   0x01400b80  length: 128   </span><br><span class="line">   0x01400c00  length: 128   </span><br><span class="line">   0x01400c80  length: 128   </span><br><span class="line">   0x01400d00  length: 128   </span><br><span class="line">   0x01400d80  length: 128   </span><br><span class="line">   0x01400e00  length: 128   </span><br><span class="line">   0x01400e80  length: 128   </span><br><span class="line">   0x01400f00  length: 128   </span><br><span class="line">   0x01400f80  length: 128   </span><br><span class="line">   0x01401000  length: 128   </span><br><span class="line">   0x01401080  length: 128   </span><br><span class="line">   0x01401100  length: 128   </span><br><span class="line">   0x01401180  length: 128   </span><br><span class="line">   0x01401200  length: 128   </span><br><span class="line">   0x01401280  length: 128   </span><br><span class="line">   0x01401300  length: 128   </span><br><span class="line">   0x01401380  length: 128   </span><br><span class="line">   0x01401400  length: 128   </span><br><span class="line">   0x01401480  length: 128   </span><br><span class="line">   0x01401500  length: 128   </span><br><span class="line">   0x01401580  length: 128   </span><br><span class="line">   0x01401600  length: 128   </span><br><span class="line">   0x01401680  length: 128   </span><br><span class="line">   0x01401700  length: 128   </span><br><span class="line">   0x01401780  length: 128   </span><br><span class="line">   0x01401800  length: 128   </span><br><span class="line">   0x01401880  length: 128   </span><br><span class="line">   0x01401900  length: 128   </span><br><span class="line">   0x01401980  length: 128   </span><br><span class="line">   0x01401a00  length: 128   </span><br><span class="line">   0x01401a80  length: 128   </span><br><span class="line">   0x01401b00  length: 128   </span><br><span class="line">   0x01401b80  length: 128   </span><br><span class="line">   0x01401c00  length: 128   </span><br><span class="line">   0x01401c80  length: 128   </span><br><span class="line">   0x01401d00  length: 128   </span><br><span class="line">   0x01401d80  length: 128   </span><br><span class="line">   0x01401e00  length: 128   </span><br><span class="line">   0x01401e80  length: 128   </span><br><span class="line">   0x01401f00  length: 128   </span><br><span class="line">   0x01401f80  length: 128   </span><br><span class="line">   0x01402000  length: 128   </span><br><span class="line">   0x01402080  length: 128   </span><br><span class="line">   0x01402100  length: 128   </span><br><span class="line">   0x01402180  length: 128   </span><br><span class="line">   0x01402200  length: 128   </span><br><span class="line">   0x01402280  length: 128   </span><br><span class="line">   0x01402300  length: 128   </span><br><span class="line">   0x01402380  length: 128   </span><br><span class="line">   0x01402400  length: 128   </span><br><span class="line">   0x01402480  length: 128   </span><br><span class="line">   0x01402500  length: 128   </span><br><span class="line">   0x01402580  length: 128   </span><br><span class="line">   0x01402600  length: 128   </span><br><span class="line">   0x01402680  length: 128   </span><br><span class="line">   0x01402700  length: 128   </span><br><span class="line">   0x01402780  length: 128   </span><br><span class="line">   0x01402800  length: 128   </span><br><span class="line">   0x01402880  length: 128   </span><br><span class="line">   0x01402900  length: 128   </span><br><span class="line">   0x01402980  length: 128   </span><br><span class="line">   0x01402a00  length: 128   </span><br><span class="line">   0x01402a80  length: 128   </span><br><span class="line">   0x01402b00  length: 128   </span><br><span class="line">   0x01402b80  length: 128   </span><br><span class="line">   0x01402c00  length: 128   </span><br><span class="line">   0x01402c80  length: 128   </span><br><span class="line">   0x01402d00  length: 128   </span><br><span class="line">   0x01402d80  length: 128   </span><br><span class="line">   0x01402e00  length: 128   </span><br><span class="line">   0x01402e80  length: 128   </span><br><span class="line">   0x01402f00  length: 128   </span><br><span class="line">   0x01402f80  length: 128   </span><br><span class="line">   0x01403000  length: 128   </span><br><span class="line">   0x01403080  length: 128   </span><br><span class="line">   0x01403100  length: 128   </span><br><span class="line">   0x01403180  length: 128   </span><br><span class="line">   0x01403200  length: 128   </span><br><span class="line">   0x01403280  length: 128   </span><br><span class="line"></span><br><span class="line">  Auxillary Map</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   Extent 0     :  L1 dba:  0x01400080 Data dba:  0x01400084</span><br><span class="line">   Extent 1     :  L1 dba:  0x01400100 Data dba:  0x01400102</span><br><span class="line">   Extent 2     :  L1 dba:  0x01400180 Data dba:  0x01400182</span><br><span class="line">   Extent 3     :  L1 dba:  0x01400200 Data dba:  0x01400202</span><br><span class="line">   Extent 4     :  L1 dba:  0x01400280 Data dba:  0x01400282</span><br><span class="line">   Extent 5     :  L1 dba:  0x01400300 Data dba:  0x01400302</span><br><span class="line">   Extent 6     :  L1 dba:  0x01400380 Data dba:  0x01400382</span><br><span class="line">   Extent 7     :  L1 dba:  0x01400400 Data dba:  0x01400402</span><br><span class="line">   Extent 8     :  L1 dba:  0x01400480 Data dba:  0x01400482</span><br><span class="line">   Extent 9     :  L1 dba:  0x01400500 Data dba:  0x01400502</span><br><span class="line">   Extent 10    :  L1 dba:  0x01400580 Data dba:  0x01400582</span><br><span class="line">   Extent 11    :  L1 dba:  0x01400600 Data dba:  0x01400602</span><br><span class="line">   Extent 12    :  L1 dba:  0x01400680 Data dba:  0x01400682</span><br><span class="line">   Extent 13    :  L1 dba:  0x01400700 Data dba:  0x01400702</span><br><span class="line">   Extent 14    :  L1 dba:  0x01400780 Data dba:  0x01400782</span><br><span class="line">   Extent 15    :  L1 dba:  0x01400800 Data dba:  0x01400802</span><br><span class="line">   Extent 16    :  L1 dba:  0x01400880 Data dba:  0x01400882</span><br><span class="line">   Extent 17    :  L1 dba:  0x01400900 Data dba:  0x01400902</span><br><span class="line">   Extent 18    :  L1 dba:  0x01400980 Data dba:  0x01400982</span><br><span class="line">   Extent 19    :  L1 dba:  0x01400a00 Data dba:  0x01400a02</span><br><span class="line">   Extent 20    :  L1 dba:  0x01400a80 Data dba:  0x01400a82</span><br><span class="line">   Extent 21    :  L1 dba:  0x01400b00 Data dba:  0x01400b02</span><br><span class="line">   Extent 22    :  L1 dba:  0x01400b80 Data dba:  0x01400b82</span><br><span class="line">   Extent 23    :  L1 dba:  0x01400c00 Data dba:  0x01400c02</span><br><span class="line">   Extent 24    :  L1 dba:  0x01400c80 Data dba:  0x01400c82</span><br><span class="line">   Extent 25    :  L1 dba:  0x01400d00 Data dba:  0x01400d02</span><br><span class="line">   Extent 26    :  L1 dba:  0x01400d80 Data dba:  0x01400d82</span><br><span class="line">   Extent 27    :  L1 dba:  0x01400e00 Data dba:  0x01400e02</span><br><span class="line">   Extent 28    :  L1 dba:  0x01400e80 Data dba:  0x01400e82</span><br><span class="line">   Extent 29    :  L1 dba:  0x01400f00 Data dba:  0x01400f02</span><br><span class="line">   Extent 30    :  L1 dba:  0x01400f80 Data dba:  0x01400f82</span><br><span class="line">   Extent 31    :  L1 dba:  0x01401000 Data dba:  0x01401002</span><br><span class="line">   Extent 32    :  L1 dba:  0x01401080 Data dba:  0x01401082</span><br><span class="line">   Extent 33    :  L1 dba:  0x01401100 Data dba:  0x01401102</span><br><span class="line">   Extent 34    :  L1 dba:  0x01401180 Data dba:  0x01401182</span><br><span class="line">   Extent 35    :  L1 dba:  0x01401200 Data dba:  0x01401202</span><br><span class="line">   Extent 36    :  L1 dba:  0x01401280 Data dba:  0x01401282</span><br><span class="line">   Extent 37    :  L1 dba:  0x01401300 Data dba:  0x01401302</span><br><span class="line">   Extent 38    :  L1 dba:  0x01401380 Data dba:  0x01401382</span><br><span class="line">   Extent 39    :  L1 dba:  0x01401400 Data dba:  0x01401402</span><br><span class="line">   Extent 40    :  L1 dba:  0x01401480 Data dba:  0x01401482</span><br><span class="line">   Extent 41    :  L1 dba:  0x01401500 Data dba:  0x01401502</span><br><span class="line">   Extent 42    :  L1 dba:  0x01401580 Data dba:  0x01401582</span><br><span class="line">   Extent 43    :  L1 dba:  0x01401600 Data dba:  0x01401602</span><br><span class="line">   Extent 44    :  L1 dba:  0x01401680 Data dba:  0x01401682</span><br><span class="line">   Extent 45    :  L1 dba:  0x01401700 Data dba:  0x01401702</span><br><span class="line">   Extent 46    :  L1 dba:  0x01401780 Data dba:  0x01401782</span><br><span class="line">   Extent 47    :  L1 dba:  0x01401800 Data dba:  0x01401802</span><br><span class="line">   Extent 48    :  L1 dba:  0x01401880 Data dba:  0x01401882</span><br><span class="line">   Extent 49    :  L1 dba:  0x01401900 Data dba:  0x01401902</span><br><span class="line">   Extent 50    :  L1 dba:  0x01401980 Data dba:  0x01401982</span><br><span class="line">   Extent 51    :  L1 dba:  0x01401a00 Data dba:  0x01401a02</span><br><span class="line">   Extent 52    :  L1 dba:  0x01401a80 Data dba:  0x01401a82</span><br><span class="line">   Extent 53    :  L1 dba:  0x01401b00 Data dba:  0x01401b02</span><br><span class="line">   Extent 54    :  L1 dba:  0x01401b80 Data dba:  0x01401b82</span><br><span class="line">   Extent 55    :  L1 dba:  0x01401c00 Data dba:  0x01401c02</span><br><span class="line">   Extent 56    :  L1 dba:  0x01401c80 Data dba:  0x01401c82</span><br><span class="line">   Extent 57    :  L1 dba:  0x01401d00 Data dba:  0x01401d02</span><br><span class="line">   Extent 58    :  L1 dba:  0x01401d80 Data dba:  0x01401d82</span><br><span class="line">   Extent 59    :  L1 dba:  0x01401e00 Data dba:  0x01401e02</span><br><span class="line">   Extent 60    :  L1 dba:  0x01401e80 Data dba:  0x01401e82</span><br><span class="line">   Extent 61    :  L1 dba:  0x01401f00 Data dba:  0x01401f02</span><br><span class="line">   Extent 62    :  L1 dba:  0x01401f80 Data dba:  0x01401f82</span><br><span class="line">   Extent 63    :  L1 dba:  0x01402000 Data dba:  0x01402001</span><br><span class="line">   Extent 64    :  L1 dba:  0x01402000 Data dba:  0x01402080</span><br><span class="line">   Extent 65    :  L1 dba:  0x01402100 Data dba:  0x01402101</span><br><span class="line">   Extent 66    :  L1 dba:  0x01402100 Data dba:  0x01402180</span><br><span class="line">   Extent 67    :  L1 dba:  0x01402200 Data dba:  0x01402201</span><br><span class="line">   Extent 68    :  L1 dba:  0x01402200 Data dba:  0x01402280</span><br><span class="line">   Extent 69    :  L1 dba:  0x01402300 Data dba:  0x01402301</span><br><span class="line">   Extent 70    :  L1 dba:  0x01402300 Data dba:  0x01402380</span><br><span class="line">   Extent 71    :  L1 dba:  0x01402400 Data dba:  0x01402401</span><br><span class="line">   Extent 72    :  L1 dba:  0x01402400 Data dba:  0x01402480</span><br><span class="line">   Extent 73    :  L1 dba:  0x01402500 Data dba:  0x01402501</span><br><span class="line">   Extent 74    :  L1 dba:  0x01402500 Data dba:  0x01402580</span><br><span class="line">   Extent 75    :  L1 dba:  0x01402600 Data dba:  0x01402601</span><br><span class="line">   Extent 76    :  L1 dba:  0x01402600 Data dba:  0x01402680</span><br><span class="line">   Extent 77    :  L1 dba:  0x01402700 Data dba:  0x01402701</span><br><span class="line">   Extent 78    :  L1 dba:  0x01402700 Data dba:  0x01402780</span><br><span class="line">   Extent 79    :  L1 dba:  0x01402800 Data dba:  0x01402801</span><br><span class="line">   Extent 80    :  L1 dba:  0x01402800 Data dba:  0x01402880</span><br><span class="line">   Extent 81    :  L1 dba:  0x01402900 Data dba:  0x01402901</span><br><span class="line">   Extent 82    :  L1 dba:  0x01402900 Data dba:  0x01402980</span><br><span class="line">   Extent 83    :  L1 dba:  0x01402a00 Data dba:  0x01402a01</span><br><span class="line">   Extent 84    :  L1 dba:  0x01402a00 Data dba:  0x01402a80</span><br><span class="line">   Extent 85    :  L1 dba:  0x01402b00 Data dba:  0x01402b01</span><br><span class="line">   Extent 86    :  L1 dba:  0x01402b00 Data dba:  0x01402b80</span><br><span class="line">   Extent 87    :  L1 dba:  0x01402c00 Data dba:  0x01402c01</span><br><span class="line">   Extent 88    :  L1 dba:  0x01402c00 Data dba:  0x01402c80</span><br><span class="line">   Extent 89    :  L1 dba:  0x01402d00 Data dba:  0x01402d01</span><br><span class="line">   Extent 90    :  L1 dba:  0x01402d00 Data dba:  0x01402d80</span><br><span class="line">   Extent 91    :  L1 dba:  0x01402e00 Data dba:  0x01402e01</span><br><span class="line">   Extent 92    :  L1 dba:  0x01402e00 Data dba:  0x01402e80</span><br><span class="line">   Extent 93    :  L1 dba:  0x01402f00 Data dba:  0x01402f01</span><br><span class="line">   Extent 94    :  L1 dba:  0x01402f00 Data dba:  0x01402f80</span><br><span class="line">   Extent 95    :  L1 dba:  0x01403000 Data dba:  0x01403001</span><br><span class="line">   Extent 96    :  L1 dba:  0x01403000 Data dba:  0x01403080</span><br><span class="line">   Extent 97    :  L1 dba:  0x01403100 Data dba:  0x01403101</span><br><span class="line">   Extent 98    :  L1 dba:  0x01403100 Data dba:  0x01403180</span><br><span class="line">   Extent 99    :  L1 dba:  0x01403200 Data dba:  0x01403201</span><br><span class="line">   Extent 100   :  L1 dba:  0x01403200 Data dba:  0x01403280</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line"></span><br><span class="line">   Second Level Bitmap block DBAs</span><br><span class="line">   --------------------------------------------------------</span><br><span class="line">   DBA 1:   0x01400082</span><br><span class="line"></span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 131 maxblk 131</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里我们主要看Auxillary Map，里面记录了每个区所属的L1，不难发现从第64个区开始，64、65两个区的L1相同，这说明什么，说明L1下面挂了整整两个区的数据块，验证一下，将0x01402000块dump出来之后的内容：</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">  01402000  十进制 》20979712</span><br><span class="line">  SQL&gt; select dbms_utility.data_block_address_file(20979712) Rfile#,dbms_utility.data_block_address_block(20979712) "Block#" from dual;</span><br><span class="line"></span><br><span class="line">    RFILE<span class="comment">#     Block#</span></span><br><span class="line"><span class="comment">---------- ----------</span></span><br><span class="line">         5       8192</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">          DBA Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x01402000  Length: 128    Offset: 0      </span><br><span class="line">   0x01402080  Length: 128    Offset: 128    </span><br><span class="line"></span><br><span class="line">   0:Metadata   1:unformatted   2:unformatted   3:unformatted</span><br><span class="line">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class="line">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class="line">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class="line">   16:unformatted   17:unformatted   18:unformatted   19:unformatted</span><br><span class="line">   20:unformatted   21:unformatted   22:unformatted   23:unformatted</span><br><span class="line">   24:unformatted   25:unformatted   26:unformatted   27:unformatted</span><br><span class="line">   28:unformatted   29:unformatted   30:unformatted   31:unformatted</span><br><span class="line">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class="line">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class="line">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class="line">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class="line">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class="line">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class="line">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class="line">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class="line">   64:unformatted   65:unformatted   66:unformatted   67:unformatted</span><br><span class="line">   68:unformatted   69:unformatted   70:unformatted   71:unformatted</span><br><span class="line">   72:unformatted   73:unformatted   74:unformatted   75:unformatted</span><br><span class="line">   76:unformatted   77:unformatted   78:unformatted   79:unformatted</span><br><span class="line">   80:unformatted   81:unformatted   82:unformatted   83:unformatted</span><br><span class="line">   84:unformatted   85:unformatted   86:unformatted   87:unformatted</span><br><span class="line">   88:unformatted   89:unformatted   90:unformatted   91:unformatted</span><br><span class="line">   92:unformatted   93:unformatted   94:unformatted   95:unformatted</span><br><span class="line">   96:unformatted   97:unformatted   98:unformatted   99:unformatted</span><br><span class="line">   100:unformatted   101:unformatted   102:unformatted   103:unformatted</span><br><span class="line">   104:unformatted   105:unformatted   106:unformatted   107:unformatted</span><br><span class="line">   108:unformatted   109:unformatted   110:unformatted   111:unformatted</span><br><span class="line">   112:unformatted   113:unformatted   114:unformatted   115:unformatted</span><br><span class="line">   116:unformatted   117:unformatted   118:unformatted   119:unformatted</span><br><span class="line">   120:unformatted   121:unformatted   122:unformatted   123:unformatted</span><br><span class="line">   124:unformatted   125:unformatted   126:unformatted   127:unformatted</span><br><span class="line">   128:unformatted   129:unformatted   130:unformatted   131:unformatted</span><br><span class="line">   132:unformatted   133:unformatted   134:unformatted   135:unformatted</span><br><span class="line">   136:unformatted   137:unformatted   138:unformatted   139:unformatted</span><br><span class="line">   140:unformatted   141:unformatted   142:unformatted   143:unformatted</span><br><span class="line">   144:unformatted   145:unformatted   146:unformatted   147:unformatted</span><br><span class="line">   148:unformatted   149:unformatted   150:unformatted   151:unformatted</span><br><span class="line">   152:unformatted   153:unformatted   154:unformatted   155:unformatted</span><br><span class="line">   156:unformatted   157:unformatted   158:unformatted   159:unformatted</span><br><span class="line">   160:unformatted   161:unformatted   162:unformatted   163:unformatted</span><br><span class="line">   164:unformatted   165:unformatted   166:unformatted   167:unformatted</span><br><span class="line">   168:unformatted   169:unformatted   170:unformatted   171:unformatted</span><br><span class="line">   172:unformatted   173:unformatted   174:unformatted   175:unformatted</span><br><span class="line">   176:unformatted   177:unformatted   178:unformatted   179:unformatted</span><br><span class="line">   180:unformatted   181:unformatted   182:unformatted   183:unformatted</span><br><span class="line">   184:unformatted   185:unformatted   186:unformatted   187:unformatted</span><br><span class="line">   188:unformatted   189:unformatted   190:unformatted   191:unformatted</span><br><span class="line">   192:unformatted   193:unformatted   194:unformatted   195:unformatted</span><br><span class="line">   196:unformatted   197:unformatted   198:unformatted   199:unformatted</span><br><span class="line">   200:unformatted   201:unformatted   202:unformatted   203:unformatted</span><br><span class="line">   204:unformatted   205:unformatted   206:unformatted   207:unformatted</span><br><span class="line">   208:unformatted   209:unformatted   210:unformatted   211:unformatted</span><br><span class="line">   212:unformatted   213:unformatted   214:unformatted   215:unformatted</span><br><span class="line">   216:unformatted   217:unformatted   218:unformatted   219:unformatted</span><br><span class="line">   220:unformatted   221:unformatted   222:unformatted   223:unformatted</span><br><span class="line">   224:unformatted   225:unformatted   226:unformatted   227:unformatted</span><br><span class="line">   228:unformatted   229:unformatted   230:unformatted   231:unformatted</span><br><span class="line">   232:unformatted   233:unformatted   234:unformatted   235:unformatted</span><br><span class="line">   236:unformatted   237:unformatted   238:unformatted   239:unformatted</span><br><span class="line">   240:unformatted   241:unformatted   242:unformatted   243:unformatted</span><br><span class="line">   244:unformatted   245:unformatted   246:unformatted   247:unformatted</span><br><span class="line">   248:unformatted   249:unformatted   250:unformatted   251:unformatted</span><br><span class="line">   252:unformatted   253:unformatted   254:unformatted   255:unformatted</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 8192 maxblk 8192</span><br></pre></td></tr></table></figure>

<blockquote>
<p>256个块，2M 2个区，可见L1中块的数量会随着段大小的改变而做调整的，可以增大到1024个甚至更多，我在这里不去再做验证，将重点放在高水位上，根据我们之前观察到的现象，高水位在第二个L1的地一个块，也可说第一个L1的末端，那么现在的L1里有256个块，高水位是不是也会推进到这个L1的末端呢？很容易进行验证，将数据插满到这个L1的前几个块再去观察段头高水位的变化就行了，那么插多少条呢？再来计算一下，当前的L1是8192号块，前面一共63个区，每个区里面两个L1，加上第一个区里面的一个L2和L3，我们需要插满8192-63*2-2=8064</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">declare</span></span><br><span class="line">i <span class="built_in">number</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.8064</span> <span class="keyword">loop</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> lp <span class="keyword">values</span>(i,<span class="string">'a'</span>,<span class="string">'a'</span>,<span class="string">'a'</span>,<span class="string">'a'</span>);</span><br><span class="line"><span class="keyword">end</span> <span class="keyword">loop</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<blockquote>
<p>观察62号区的第二个L1，第一个L1的地址是0x01401f80，那么第二个就是01401f81，5号文件8065号块，dump出来的结果</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DBA Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x01401fc0  Length: 64     Offset: 0      </span><br><span class="line"></span><br><span class="line">   0:FULL   1:FULL   2:FULL   3:FULL</span><br><span class="line">   4:FULL   5:FULL   6:FULL   7:FULL</span><br><span class="line">   8:FULL   9:FULL   10:FULL   11:FULL</span><br><span class="line">   12:FULL   13:FULL   14:FULL   15:FULL</span><br><span class="line">   16:FULL   17:FULL   18:FULL   19:FULL</span><br><span class="line">   20:FULL   21:FULL   22:FULL   23:FULL</span><br><span class="line">   24:FULL   25:FULL   26:FULL   27:FULL</span><br><span class="line">   28:FULL   29:FULL   30:FULL   31:FULL</span><br><span class="line">   32:FULL   33:FULL   34:FULL   35:FULL</span><br><span class="line">   36:FULL   37:FULL   38:FULL   39:FULL</span><br><span class="line">   40:FULL   41:FULL   42:FULL   43:FULL</span><br><span class="line">   44:FULL   45:FULL   46:FULL   47:FULL</span><br><span class="line">   48:FULL   49:FULL   50:FULL   51:FULL</span><br><span class="line">   52:FULL   53:FULL   54:FULL   55:FULL</span><br><span class="line">   56:FULL   57:FULL   58:FULL   59:FULL</span><br><span class="line">   60:FULL   61:FULL   62:FULL   63:FULL</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 8065 maxblk 8065</span><br></pre></td></tr></table></figure>

<blockquote>
<p>居然全满了？再看8192号L1呢</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DBA Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x01402000  Length: 128    Offset: 0      </span><br><span class="line">   0x01402080  Length: 128    Offset: 128    </span><br><span class="line"></span><br><span class="line">   0:Metadata   1:FULL   2:FULL   3:FULL</span><br><span class="line">   4:FULL   5:FULL   6:FULL   7:FULL</span><br><span class="line">   8:FULL   9:FULL   10:FULL   11:FULL</span><br><span class="line">   12:FULL   13:FULL   14:FULL   15:FULL</span><br><span class="line">   16:FULL   17:FULL   18:FULL   19:FULL</span><br><span class="line">   20:FULL   21:FULL   22:FULL   23:FULL</span><br><span class="line">   24:FULL   25:FULL   26:FULL   27:FULL</span><br><span class="line">   28:FULL   29:FULL   30:FULL   31:FULL</span><br><span class="line">   32:FULL   33:FULL   34:FULL   35:FULL</span><br><span class="line">   36:FULL   37:FULL   38:FULL   39:FULL</span><br><span class="line">   40:FULL   41:FULL   42:FULL   43:FULL</span><br><span class="line">   44:FULL   45:FULL   46:FULL   47:FULL</span><br><span class="line">   48:FULL   49:FULL   50:FULL   51:FULL</span><br><span class="line">   52:FULL   53:FULL   54:FULL   55:FULL</span><br><span class="line">   56:FULL   57:FULL   58:FULL   59:FULL</span><br><span class="line">   60:FULL   61:FULL   62:FULL   63:FULL</span><br><span class="line">   64:FULL   65:FULL   66:FULL   67:FULL</span><br><span class="line">   68:FULL   69:FULL   70:FULL   71:FULL</span><br><span class="line">   72:FULL   73:FULL   74:FULL   75:FULL</span><br><span class="line">   76:FULL   77:FULL   78:FULL   79:FULL</span><br><span class="line">   80:FULL   81:FULL   82:FULL   83:FULL</span><br><span class="line">   84:FULL   85:FULL   86:FULL   87:FULL</span><br><span class="line">   88:FULL   89:FULL   90:FULL   91:FULL</span><br><span class="line">   92:FULL   93:FULL   94:FULL   95:FULL</span><br><span class="line">   96:FULL   97:FULL   98:FULL   99:FULL</span><br><span class="line">   100:FULL   101:FULL   102:FULL   103:FULL</span><br><span class="line">   104:FULL   105:FULL   106:FULL   107:FULL</span><br><span class="line">   108:FULL   109:FULL   110:FULL   111:FULL</span><br><span class="line">   112:FULL   113:FULL   114:FULL   115:FULL</span><br><span class="line">   116:FULL   117:FULL   118:FULL   119:FULL</span><br><span class="line">   120:FULL   121:FULL   122:FULL   123:FULL</span><br><span class="line">   124:FULL   125:FULL   126:FULL   127:FULL</span><br><span class="line">   128:unformatted   129:unformatted   130:unformatted   131:unformatted</span><br><span class="line">   132:unformatted   133:unformatted   134:unformatted   135:unformatted</span><br><span class="line">   136:unformatted   137:unformatted   138:unformatted   139:unformatted</span><br><span class="line">   140:unformatted   141:unformatted   142:unformatted   143:unformatted</span><br><span class="line">   144:75-100% free   145:75-100% free   146:75-100% free   147:75-100% free</span><br><span class="line">   148:75-100% free   149:75-100% free   150:75-100% free   151:75-100% free</span><br><span class="line">   152:75-100% free   153:75-100% free   154:75-100% free   155:FULL</span><br><span class="line">   156:75-100% free   157:75-100% free   158:75-100% free   159:75-100% free</span><br><span class="line">   160:75-100% free   161:75-100% free   162:75-100% free   163:FULL</span><br><span class="line">   164:75-100% free   165:75-100% free   166:75-100% free   167:75-100% free</span><br><span class="line">   168:75-100% free   169:75-100% free   170:75-100% free   171:75-100% free</span><br><span class="line">   172:75-100% free   173:75-100% free   174:75-100% free   175:75-100% free</span><br><span class="line">   176:unformatted   177:unformatted   178:unformatted   179:unformatted</span><br><span class="line">   180:unformatted   181:unformatted   182:unformatted   183:unformatted</span><br><span class="line">   184:unformatted   185:unformatted   186:unformatted   187:unformatted</span><br><span class="line">   188:unformatted   189:unformatted   190:unformatted   191:unformatted</span><br><span class="line">   192:unformatted   193:unformatted   194:unformatted   195:unformatted</span><br><span class="line">   196:unformatted   197:unformatted   198:unformatted   199:unformatted</span><br><span class="line">   200:unformatted   201:unformatted   202:unformatted   203:unformatted</span><br><span class="line">   204:unformatted   205:unformatted   206:unformatted   207:unformatted</span><br><span class="line">   208:unformatted   209:unformatted   210:unformatted   211:unformatted</span><br><span class="line">   212:unformatted   213:unformatted   214:unformatted   215:unformatted</span><br><span class="line">   216:unformatted   217:unformatted   218:unformatted   219:unformatted</span><br><span class="line">   220:unformatted   221:unformatted   222:unformatted   223:unformatted</span><br><span class="line">   224:unformatted   225:unformatted   226:unformatted   227:unformatted</span><br><span class="line">   228:unformatted   229:unformatted   230:unformatted   231:unformatted</span><br><span class="line">   232:unformatted   233:unformatted   234:unformatted   235:unformatted</span><br><span class="line">   236:unformatted   237:unformatted   238:unformatted   239:unformatted</span><br><span class="line">   240:unformatted   241:unformatted   242:unformatted   243:unformatted</span><br><span class="line">   244:unformatted   245:unformatted   246:unformatted   247:unformatted</span><br><span class="line">   248:unformatted   249:unformatted   250:unformatted   251:unformatted</span><br><span class="line">   252:unformatted   253:unformatted   254:unformatted   255:unformatted</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 8192 maxblk 8192</span><br></pre></td></tr></table></figure>

<blockquote>
<p>完蛋了，计算错误，L1下面的第二个区也已经被格式化了，看段头信息</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Extent Control Header</span><br><span class="line">  -----------------------------------------------------------------</span><br><span class="line">  Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928</span><br><span class="line">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class="line">      Highwater::  0x01402100  ext#: 64     blk#: 128    ext size: 128   </span><br><span class="line">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class="line">  #blocks below: 8191  </span><br><span class="line">  mapblk  0x00000000  offset: 64</span><br></pre></td></tr></table></figure>

<blockquote>
<p>果然高水位指到了第66个区的L1块地址，这会影响我们的判断，到底哪里出问题了呢？观察8192号块内容是后128个块里被插入了2条，前128个块全满，也就是说我多插了130个块，后来猛然醒悟，我使用DBA来计算的，忘记减去128个块的文件头了，这么一算结果相查差还是不大的，太马虎了，要不是因为马虎哥也能上清华北大了；然后该怎么办呢？重新来过？不用！既然这个L1推过头了，索性把它堆满，然后我们去观察下一个L1，这下就好计算了；</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">declare</span></span><br><span class="line">i <span class="built_in">number</span>;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1.</span><span class="number">.126</span> <span class="keyword">loop</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> lp <span class="keyword">values</span>(i,<span class="string">'a'</span>,<span class="string">'a'</span>,<span class="string">'a'</span>,<span class="string">'a'</span>);</span><br><span class="line"><span class="keyword">end</span> <span class="keyword">loop</span>;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<blockquote>
<p>观察8192号块</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> DBA Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x01402000  Length: 128    Offset: 0      </span><br><span class="line">   0x01402080  Length: 128    Offset: 128    </span><br><span class="line"></span><br><span class="line">   0:Metadata   1:FULL   2:FULL   3:FULL</span><br><span class="line">   4:FULL   5:FULL   6:FULL   7:FULL</span><br><span class="line">   8:FULL   9:FULL   10:FULL   11:FULL</span><br><span class="line">   12:FULL   13:FULL   14:FULL   15:FULL</span><br><span class="line">   16:FULL   17:FULL   18:FULL   19:FULL</span><br><span class="line">   20:FULL   21:FULL   22:FULL   23:FULL</span><br><span class="line">   24:FULL   25:FULL   26:FULL   27:FULL</span><br><span class="line">   28:FULL   29:FULL   30:FULL   31:FULL</span><br><span class="line">   32:FULL   33:FULL   34:FULL   35:FULL</span><br><span class="line">   36:FULL   37:FULL   38:FULL   39:FULL</span><br><span class="line">   40:FULL   41:FULL   42:FULL   43:FULL</span><br><span class="line">   44:FULL   45:FULL   46:FULL   47:FULL</span><br><span class="line">   48:FULL   49:FULL   50:FULL   51:FULL</span><br><span class="line">   52:FULL   53:FULL   54:FULL   55:FULL</span><br><span class="line">   56:FULL   57:FULL   58:FULL   59:FULL</span><br><span class="line">   60:FULL   61:FULL   62:FULL   63:FULL</span><br><span class="line">   64:FULL   65:FULL   66:FULL   67:FULL</span><br><span class="line">   68:FULL   69:FULL   70:FULL   71:FULL</span><br><span class="line">   72:FULL   73:FULL   74:FULL   75:FULL</span><br><span class="line">   76:FULL   77:FULL   78:FULL   79:FULL</span><br><span class="line">   80:FULL   81:FULL   82:FULL   83:FULL</span><br><span class="line">   84:FULL   85:FULL   86:FULL   87:FULL</span><br><span class="line">   88:FULL   89:FULL   90:FULL   91:FULL</span><br><span class="line">   92:FULL   93:FULL   94:FULL   95:FULL</span><br><span class="line">   96:FULL   97:FULL   98:FULL   99:FULL</span><br><span class="line">   100:FULL   101:FULL   102:FULL   103:FULL</span><br><span class="line">   104:FULL   105:FULL   106:FULL   107:FULL</span><br><span class="line">   108:FULL   109:FULL   110:FULL   111:FULL</span><br><span class="line">   112:FULL   113:FULL   114:FULL   115:FULL</span><br><span class="line">   116:FULL   117:FULL   118:FULL   119:FULL</span><br><span class="line">   120:FULL   121:FULL   122:FULL   123:FULL</span><br><span class="line">   124:FULL   125:FULL   126:FULL   127:FULL</span><br><span class="line">   128:FULL   129:FULL   130:FULL   131:FULL</span><br><span class="line">   132:FULL   133:FULL   134:FULL   135:FULL</span><br><span class="line">   136:FULL   137:FULL   138:FULL   139:FULL</span><br><span class="line">   140:FULL   141:FULL   142:FULL   143:FULL</span><br><span class="line">   144:FULL   145:FULL   146:FULL   147:FULL</span><br><span class="line">   148:FULL   149:FULL   150:FULL   151:FULL</span><br><span class="line">   152:FULL   153:FULL   154:FULL   155:FULL</span><br><span class="line">   156:FULL   157:FULL   158:FULL   159:FULL</span><br><span class="line">   160:FULL   161:FULL   162:FULL   163:FULL</span><br><span class="line">   164:FULL   165:FULL   166:FULL   167:FULL</span><br><span class="line">   168:FULL   169:FULL   170:FULL   171:FULL</span><br><span class="line">   172:FULL   173:FULL   174:FULL   175:FULL</span><br><span class="line">   176:FULL   177:FULL   178:FULL   179:FULL</span><br><span class="line">   180:FULL   181:FULL   182:FULL   183:FULL</span><br><span class="line">   184:FULL   185:FULL   186:FULL   187:FULL</span><br><span class="line">   188:FULL   189:FULL   190:FULL   191:FULL</span><br><span class="line">   192:FULL   193:FULL   194:FULL   195:FULL</span><br><span class="line">   196:FULL   197:FULL   198:FULL   199:FULL</span><br><span class="line">   200:FULL   201:FULL   202:FULL   203:FULL</span><br><span class="line">   204:FULL   205:FULL   206:FULL   207:FULL</span><br><span class="line">   208:FULL   209:FULL   210:FULL   211:FULL</span><br><span class="line">   212:FULL   213:FULL   214:FULL   215:FULL</span><br><span class="line">   216:FULL   217:FULL   218:FULL   219:FULL</span><br><span class="line">   220:FULL   221:FULL   222:FULL   223:FULL</span><br><span class="line">   224:FULL   225:FULL   226:FULL   227:FULL</span><br><span class="line">   228:FULL   229:FULL   230:FULL   231:FULL</span><br><span class="line">   232:FULL   233:FULL   234:FULL   235:FULL</span><br><span class="line">   236:FULL   237:FULL   238:FULL   239:FULL</span><br><span class="line">   240:FULL   241:FULL   242:FULL   243:FULL</span><br><span class="line">   244:FULL   245:FULL   246:FULL   247:FULL</span><br><span class="line">   248:FULL   249:FULL   250:FULL   251:FULL</span><br><span class="line">   252:FULL   253:FULL   254:FULL   255:FULL</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 8192 maxblk 8192</span><br></pre></td></tr></table></figure>

<blockquote>
<p>已经全满了，这个时候我们再去看一下段头的高水位</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Extent Control Header</span><br><span class="line"> -----------------------------------------------------------------</span><br><span class="line"> Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928</span><br><span class="line">                 last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class="line">     Highwater::  0x01402100  ext#: 64     blk#: 128    ext size: 128   </span><br><span class="line"> #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class="line"> #blocks below: 8191  </span><br><span class="line"> mapblk  0x00000000  offset: 64</span><br></pre></td></tr></table></figure>

<blockquote>
<p>没有动，看来oracle也是事不到眼前不知道着急啊，来看一看下一个L1</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; select dbms_utility.data_block_address_file(to_number('01402100', 'xxxxxxxx')) file#,</span><br><span class="line">  2 dbms_utility.data_block_address_block(to_number('01402100', 'xxxxxxxx')) block<span class="comment">#</span></span><br><span class="line">  3 from dual;</span><br><span class="line"></span><br><span class="line">     FILE<span class="comment"># BLOCK#</span></span><br><span class="line"><span class="comment">---------- ----------</span></span><br><span class="line">         5 8448</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这个L1是5号文件8448号块，dump出来</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> DBA Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x01402100  Length: 128    Offset: 0      </span><br><span class="line">   0x01402180  Length: 128    Offset: 128    </span><br><span class="line"></span><br><span class="line">   0:Metadata   1:unformatted   2:unformatted   3:unformatted</span><br><span class="line">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class="line">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class="line">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class="line">   16:unformatted   17:unformatted   18:unformatted   19:unformatted</span><br><span class="line">   20:unformatted   21:unformatted   22:unformatted   23:unformatted</span><br><span class="line">   24:unformatted   25:unformatted   26:unformatted   27:unformatted</span><br><span class="line">   28:unformatted   29:unformatted   30:unformatted   31:unformatted</span><br><span class="line">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class="line">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class="line">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class="line">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class="line">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class="line">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class="line">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class="line">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class="line">   64:unformatted   65:unformatted   66:unformatted   67:unformatted</span><br><span class="line">   68:unformatted   69:unformatted   70:unformatted   71:unformatted</span><br><span class="line">   72:unformatted   73:unformatted   74:unformatted   75:unformatted</span><br><span class="line">   76:unformatted   77:unformatted   78:unformatted   79:unformatted</span><br><span class="line">   80:unformatted   81:unformatted   82:unformatted   83:unformatted</span><br><span class="line">   84:unformatted   85:unformatted   86:unformatted   87:unformatted</span><br><span class="line">   88:unformatted   89:unformatted   90:unformatted   91:unformatted</span><br><span class="line">   92:unformatted   93:unformatted   94:unformatted   95:unformatted</span><br><span class="line">   96:unformatted   97:unformatted   98:unformatted   99:unformatted</span><br><span class="line">   100:unformatted   101:unformatted   102:unformatted   103:unformatted</span><br><span class="line">   104:unformatted   105:unformatted   106:unformatted   107:unformatted</span><br><span class="line">   108:unformatted   109:unformatted   110:unformatted   111:unformatted</span><br><span class="line">   112:unformatted   113:unformatted   114:unformatted   115:unformatted</span><br><span class="line">   116:unformatted   117:unformatted   118:unformatted   119:unformatted</span><br><span class="line">   120:unformatted   121:unformatted   122:unformatted   123:unformatted</span><br><span class="line">   124:unformatted   125:unformatted   126:unformatted   127:unformatted</span><br><span class="line">   128:unformatted   129:unformatted   130:unformatted   131:unformatted</span><br><span class="line">   132:unformatted   133:unformatted   134:unformatted   135:unformatted</span><br><span class="line">   136:unformatted   137:unformatted   138:unformatted   139:unformatted</span><br><span class="line">   140:unformatted   141:unformatted   142:unformatted   143:unformatted</span><br><span class="line">   144:unformatted   145:unformatted   146:unformatted   147:unformatted</span><br><span class="line">   148:unformatted   149:unformatted   150:unformatted   151:unformatted</span><br><span class="line">   152:unformatted   153:unformatted   154:unformatted   155:unformatted</span><br><span class="line">   156:unformatted   157:unformatted   158:unformatted   159:unformatted</span><br><span class="line">   160:unformatted   161:unformatted   162:unformatted   163:unformatted</span><br><span class="line">   164:unformatted   165:unformatted   166:unformatted   167:unformatted</span><br><span class="line">   168:unformatted   169:unformatted   170:unformatted   171:unformatted</span><br><span class="line">   172:unformatted   173:unformatted   174:unformatted   175:unformatted</span><br><span class="line">   176:unformatted   177:unformatted   178:unformatted   179:unformatted</span><br><span class="line">   180:unformatted   181:unformatted   182:unformatted   183:unformatted</span><br><span class="line">   184:unformatted   185:unformatted   186:unformatted   187:unformatted</span><br><span class="line">   188:unformatted   189:unformatted   190:unformatted   191:unformatted</span><br><span class="line">   192:unformatted   193:unformatted   194:unformatted   195:unformatted</span><br><span class="line">   196:unformatted   197:unformatted   198:unformatted   199:unformatted</span><br><span class="line">   200:unformatted   201:unformatted   202:unformatted   203:unformatted</span><br><span class="line">   204:unformatted   205:unformatted   206:unformatted   207:unformatted</span><br><span class="line">   208:unformatted   209:unformatted   210:unformatted   211:unformatted</span><br><span class="line">   212:unformatted   213:unformatted   214:unformatted   215:unformatted</span><br><span class="line">   216:unformatted   217:unformatted   218:unformatted   219:unformatted</span><br><span class="line">   220:unformatted   221:unformatted   222:unformatted   223:unformatted</span><br><span class="line">   224:unformatted   225:unformatted   226:unformatted   227:unformatted</span><br><span class="line">   228:unformatted   229:unformatted   230:unformatted   231:unformatted</span><br><span class="line">   232:unformatted   233:unformatted   234:unformatted   235:unformatted</span><br><span class="line">   236:unformatted   237:unformatted   238:unformatted   239:unformatted</span><br><span class="line">   240:unformatted   241:unformatted   242:unformatted   243:unformatted</span><br><span class="line">   244:unformatted   245:unformatted   246:unformatted   247:unformatted</span><br><span class="line">   248:unformatted   249:unformatted   250:unformatted   251:unformatted</span><br><span class="line">   252:unformatted   253:unformatted   254:unformatted   255:unformatted</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 8448 maxblk 8448</span><br></pre></td></tr></table></figure>

<blockquote>
<p>256个块，除了第一个是L1元数据之外，没有一个格式化的，这就达到了我们的目的，我现在要插入一条数据，迫使高水位推动，猜一下高水位会在哪？在L1管理的最后一个块后面么？<br>看插入一行数据之后的8448号块</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DBA Ranges :</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">   0x01402100  Length: 128    Offset: 0      </span><br><span class="line">   0x01402180  Length: 128    Offset: 128    </span><br><span class="line"></span><br><span class="line">   0:Metadata   1:unformatted   2:unformatted   3:unformatted</span><br><span class="line">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class="line">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class="line">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class="line">   16:75-100% free   17:75-100% free   18:75-100% free   19:75-100% free</span><br><span class="line">   20:75-100% free   21:75-100% free   22:75-100% free   23:75-100% free</span><br><span class="line">   24:75-100% free   25:75-100% free   26:75-100% free   27:75-100% free</span><br><span class="line">   28:FULL   29:75-100% free   30:75-100% free   31:75-100% free</span><br><span class="line">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class="line">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class="line">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class="line">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class="line">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class="line">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class="line">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class="line">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class="line">   64:unformatted   65:unformatted   66:unformatted   67:unformatted</span><br><span class="line">   68:unformatted   69:unformatted   70:unformatted   71:unformatted</span><br><span class="line">   72:unformatted   73:unformatted   74:unformatted   75:unformatted</span><br><span class="line">   76:unformatted   77:unformatted   78:unformatted   79:unformatted</span><br><span class="line">   80:unformatted   81:unformatted   82:unformatted   83:unformatted</span><br><span class="line">   84:unformatted   85:unformatted   86:unformatted   87:unformatted</span><br><span class="line">   88:unformatted   89:unformatted   90:unformatted   91:unformatted</span><br><span class="line">   92:unformatted   93:unformatted   94:unformatted   95:unformatted</span><br><span class="line">   96:unformatted   97:unformatted   98:unformatted   99:unformatted</span><br><span class="line">   100:unformatted   101:unformatted   102:unformatted   103:unformatted</span><br><span class="line">   104:unformatted   105:unformatted   106:unformatted   107:unformatted</span><br><span class="line">   108:unformatted   109:unformatted   110:unformatted   111:unformatted</span><br><span class="line">   112:unformatted   113:unformatted   114:unformatted   115:unformatted</span><br><span class="line">   116:unformatted   117:unformatted   118:unformatted   119:unformatted</span><br><span class="line">   120:unformatted   121:unformatted   122:unformatted   123:unformatted</span><br><span class="line">   124:unformatted   125:unformatted   126:unformatted   127:unformatted</span><br><span class="line">   128:unformatted   129:unformatted   130:unformatted   131:unformatted</span><br><span class="line">   132:unformatted   133:unformatted   134:unformatted   135:unformatted</span><br><span class="line">   136:unformatted   137:unformatted   138:unformatted   139:unformatted</span><br><span class="line">   140:unformatted   141:unformatted   142:unformatted   143:unformatted</span><br><span class="line">   144:unformatted   145:unformatted   146:unformatted   147:unformatted</span><br><span class="line">   148:unformatted   149:unformatted   150:unformatted   151:unformatted</span><br><span class="line">   152:unformatted   153:unformatted   154:unformatted   155:unformatted</span><br><span class="line">   156:unformatted   157:unformatted   158:unformatted   159:unformatted</span><br><span class="line">   160:unformatted   161:unformatted   162:unformatted   163:unformatted</span><br><span class="line">   164:unformatted   165:unformatted   166:unformatted   167:unformatted</span><br><span class="line">   168:unformatted   169:unformatted   170:unformatted   171:unformatted</span><br><span class="line">   172:unformatted   173:unformatted   174:unformatted   175:unformatted</span><br><span class="line">   176:unformatted   177:unformatted   178:unformatted   179:unformatted</span><br><span class="line">   180:unformatted   181:unformatted   182:unformatted   183:unformatted</span><br><span class="line">   184:unformatted   185:unformatted   186:unformatted   187:unformatted</span><br><span class="line">   188:unformatted   189:unformatted   190:unformatted   191:unformatted</span><br><span class="line">   192:unformatted   193:unformatted   194:unformatted   195:unformatted</span><br><span class="line">   196:unformatted   197:unformatted   198:unformatted   199:unformatted</span><br><span class="line">   200:unformatted   201:unformatted   202:unformatted   203:unformatted</span><br><span class="line">   204:unformatted   205:unformatted   206:unformatted   207:unformatted</span><br><span class="line">   208:unformatted   209:unformatted   210:unformatted   211:unformatted</span><br><span class="line">   212:unformatted   213:unformatted   214:unformatted   215:unformatted</span><br><span class="line">   216:unformatted   217:unformatted   218:unformatted   219:unformatted</span><br><span class="line">   220:unformatted   221:unformatted   222:unformatted   223:unformatted</span><br><span class="line">   224:unformatted   225:unformatted   226:unformatted   227:unformatted</span><br><span class="line">   228:unformatted   229:unformatted   230:unformatted   231:unformatted</span><br><span class="line">   232:unformatted   233:unformatted   234:unformatted   235:unformatted</span><br><span class="line">   236:unformatted   237:unformatted   238:unformatted   239:unformatted</span><br><span class="line">   240:unformatted   241:unformatted   242:unformatted   243:unformatted</span><br><span class="line">   244:unformatted   245:unformatted   246:unformatted   247:unformatted</span><br><span class="line">   248:unformatted   249:unformatted   250:unformatted   251:unformatted</span><br><span class="line">   252:unformatted   253:unformatted   254:unformatted   255:unformatted</span><br><span class="line">  --------------------------------------------------------</span><br><span class="line">End dump data blocks tsn: 8 file#: 5 minblk 8448 maxblk 8448</span><br></pre></td></tr></table></figure>

<blockquote>
<p>有一个块已经满了，揭晓答案的时候来了，dump出段头</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Extent Control Header</span><br><span class="line">  -----------------------------------------------------------------</span><br><span class="line">  Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928</span><br><span class="line">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class="line">      Highwater::  0x01402180  ext#: 65     blk#: 128    ext size: 128   </span><br><span class="line">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class="line">  #blocks below: 8318  </span><br><span class="line">  mapblk  0x00000000  offset: 65</span><br></pre></td></tr></table></figure>

<blockquote>
<p>高水位是0x01402180，这个地址在哪呢？0x01402180比0x01402100多了十六进制80个块，就是十进制的128个块，仅仅是推动了一个区的大小，并不是一个L1的大小，这说明常规路径下插入高水位的推动是以L1和区中小的那个单位来推动的，就是L1小就推动L1里面所有块的大小，区小就推动一个区的大小，可见所谓的高并发并非像宣传的那样，还是受高水位的限制的，这个时候的区块大概像下面这个样子：</p>
</blockquote>
<p><img alt data-src="http://oaowhilvu.bkt.clouddn.com/%E6%89%A9%E5%B1%95%E7%9A%84L1.png"></p>
<blockquote>
<p>开几个session做下插入试试</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp where trim(des1)='b';</span><br><span class="line"></span><br><span class="line">                                   5                                 8474</span><br><span class="line">                                   5                                 8482</span><br><span class="line">                                   5                                 8484</span><br><span class="line">                                   5                                 8488</span><br><span class="line">                                   5                                 8489</span><br><span class="line">                                   5                                 8490</span><br><span class="line">                                   5                                 8491</span><br><span class="line">                                   5                                 8492</span><br><span class="line">                                   5                                 8493</span><br><span class="line">                                   5                                 8494</span><br><span class="line">                                   5                                 8495</span><br><span class="line">                                   5                                 8496</span><br><span class="line">                                   5                                 8498</span><br><span class="line">                                   5                                 8500</span><br><span class="line">                                   5                                 8504</span><br><span class="line">                                   5                                 8506</span><br><span class="line">                                   5                                 8512</span><br><span class="line">                                   5                                 8514</span><br><span class="line">                                   5                                 8520</span><br><span class="line">                                   5                                 8522</span><br><span class="line"></span><br><span class="line">20 rows selected.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>全部是在高水位之下<br>这个实验有一点值得思考，就是PCTFREE如何设置，在插入删除频繁的段，PCTFREE的值应该要远离三个百分比线，就是25%/50%/75%，避免频繁插入删除的时候块状态频繁改变，由full变为非full，如此就会修改L1块的内容，有可能造成buffer busy waits。<br>而大家熟知的直接路径下的插入是直接在高水位之上插入并且绕过cache buffer的，这种情况下的高水位是如何推动的呢？我们再慢慢分析.</p>
</blockquote>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2015/09/23/oracle/backup-restore/RMAN-different-server-directory-full-restore/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="巴流">
      <meta itemprop="description" content="左手人文 | 右手科技">
      <meta itemprop="image" content="/images/heizi.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2015/09/23/oracle/backup-restore/RMAN-different-server-directory-full-restore/" class="post-title-link" itemprop="url">RMAN异机异目录完全恢复</a>
              
            
          </h2>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2015-09-23 11:04:00" itemprop="dateCreated datePublished" datetime="2015-09-23T11:04:00+08:00">2015-09-23</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-21 12:56:06" itemprop="dateModified" datetime="2019-07-21T12:56:06+08:00">2019-07-21</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/oracle-backup/" itemprop="url" rel="index"><span itemprop="name">oracle backup</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <blockquote>
<p>开始</p>
</blockquote>
<p>先说一下为什么要写这个异机完全恢复的blog，作为一个年轻的DBA，相信大多数都是备份长做而恢复不常做，我会经常担心我的生产库的服务器挂了怎么办，我的备份完好，但我们又没有容灾，我能否保证我的数据不丢失呢，所以就要rman利用备份重建，而如果此时我能找到完好无损的在线日志，我是不是可以完全恢复了呢，理论上大家都说可以，确从未在网上见到过完全恢复的事例（完全其实很简单，只是网上阐述了太多的不完全恢复，会让我觉得set until time等等是必备的其中一步），甚至oracle的官方网文档上也使用了“SET UNTIL SCN 123456;” 的案例，有鉴于此，我做了这个实验，并记录下来，跟大家分享，不见得这篇原创有多高深的技术和见解O(∩_∩)O</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">环境：</span><br><span class="line">    源库：</span><br><span class="line">        os：redhat 6.3 x64</span><br><span class="line">        db: 11gr2 11.2.0.4</span><br><span class="line">        存储方式：ASM</span><br><span class="line">    目标库：</span><br><span class="line">        os：redhat 6.5 x64</span><br><span class="line">        db: 11gr2 11.2.0.4</span><br><span class="line">        存储方式：文件系统</span><br></pre></td></tr></table></figure>

<h2 id="1-首先，源库进行rman备份"><a href="#1-首先，源库进行rman备份" class="headerlink" title="1. 首先，源库进行rman备份"></a>1. 首先，源库进行rman备份</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--手动0级全库备份</span></span><br><span class="line">run &#123;</span><br><span class="line">    CONFIGURE RETENTION POLICY TO RECOVERY WINDOW OF 7 DAYS;</span><br><span class="line">    CONFIGURE <span class="keyword">BACKUP</span> OPTIMIZATION <span class="keyword">ON</span>;</span><br><span class="line">    CONFIGURE CONTROLFILE AUTOBACKUP ON;</span><br><span class="line">    CONFIGURE DEVICE TYPE DISK PARALLELISM 4 <span class="keyword">BACKUP</span> <span class="keyword">TYPE</span> <span class="keyword">TO</span> BACKUPSET;</span><br><span class="line">    CONFIGURE CONTROLFILE AUTOBACKUP FORMAT FOR DEVICE TYPE DISK TO '+DATA/<span class="keyword">backup</span>/ctl_atuo_%F<span class="string">';</span></span><br><span class="line"><span class="string">    ALLOCATE CHANNEL c1 TYPE DISK;</span></span><br><span class="line"><span class="string">    ALLOCATE CHANNEL c2 TYPE DISK;</span></span><br><span class="line"><span class="string">    CROSSCHECK ARCHIVELOG ALL;</span></span><br><span class="line"><span class="string">    BACKUP INCREMENTAL LEVEL 0</span></span><br><span class="line"><span class="string">    DATABASE FORMAT '</span>+<span class="keyword">DATA</span>/<span class="keyword">backup</span>/db_%U<span class="string">' TAG '</span>db_rman<span class="string">';</span></span><br><span class="line"><span class="string">    SQL '</span><span class="keyword">ALTER</span> <span class="keyword">SYSTEM</span> <span class="keyword">ARCHIVE</span> <span class="keyword">LOG</span> <span class="keyword">CURRENT</span><span class="string">';</span></span><br><span class="line"><span class="string">    BACKUP ARCHIVELOG ALL FORMAT '</span>+<span class="keyword">DATA</span>/<span class="keyword">backup</span>/arc_%U<span class="string">' TAG '</span>ARC_rman<span class="string">'</span></span><br><span class="line"><span class="string">    DELETE INPUT;</span></span><br><span class="line"><span class="string">    DELETE NOPROMPT OBSOLETE;</span></span><br><span class="line"><span class="string">    RELEASE CHANNEL c1;</span></span><br><span class="line"><span class="string">    RELEASE CHANNEL c2;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/2015/09/23/oracle/backup-restore/RMAN-different-server-directory-full-restore/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2014/07/22/oracle/architecture/linux+oracle-compatibility-list/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="巴流">
      <meta itemprop="description" content="左手人文 | 右手科技">
      <meta itemprop="image" content="/images/heizi.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2014/07/22/oracle/architecture/linux+oracle-compatibility-list/" class="post-title-link" itemprop="url">linux+oracle兼容列表</a>
              
            
          </h2>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2014-07-22 15:10:00" itemprop="dateCreated datePublished" datetime="2014-07-22T15:10:00+08:00">2014-07-22</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-21 13:01:58" itemprop="dateModified" datetime="2019-07-21T13:01:58+08:00">2019-07-21</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/oracle/" itemprop="url" rel="index"><span itemprop="name">oracle</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>linux+oracle兼容列表</p>
</blockquote>
<p><img alt data-src="http://oaowhilvu.bkt.clouddn.com/linux+oracle%E5%85%BC%E5%AE%B9%E5%88%97%E8%A1%A8.png"></p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">

          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  
    <img class="site-author-image" itemprop="image" src="/images/heizi.jpeg" alt="巴流">
  
  <p class="site-author-name" itemprop="name">巴流</p>
  <div class="site-description motion-element" itemprop="description">左手人文 | 右手科技</div>
</div>


  <nav class="site-state motion-element">
    
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    

    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        
        
          
        
          
        
          
        
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span>
        </a>
      </div>
    

    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">标签</span>
        </a>
      </div>
    
  </nav>







  <div class="links-of-author motion-element">
    
      <span class="links-of-author-item">
      
      
      
        
      
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xpdXB6bWlu" title="GitHub &rarr; https://github.com/liupzmin"><i class="fa fa-fw fa-github"></i></span>
      </span>
    
      <span class="links-of-author-item">
      
      
      
        
      
        <span class="exturl" data-url="bWFpbHRvOnN1cHBvcnRAdGhlbWUtbmV4dC5vcmc=" title="E-Mail &rarr; mailto:support@theme-next.org"><i class="fa fa-fw fa-envelope"></i></span>
      </span>
    
  </div>







          
          
        </div>
      </div>

      

      
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2014 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">NexT</span>

  

  
</div>


  <div class="powered-by">由 <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <span class="exturl theme-link" data-url="aHR0cHM6Ly90aGVtZS1uZXh0Lm9yZw==">NexT.Gemini</span> v7.2.0</div>



  <div class="footer-custom">
Theme source code <span class="exturl theme-link" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvaGV4by10aGVtZS1uZXh0">here</span><br>
Website source code <span class="exturl theme-link" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvdGhlbWUtbmV4dC5vcmc=">here</span>
</div>



        








        
      </div>
    </footer>

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>








  





  











  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/lazyload/lozad.min.js?v=1.10.0"></script>

  
  <script src="/lib/fancybox/source/jquery.fancybox.pack.js"></script>




  <script src="/js/utils.js?v=7.2.0"></script>



  
  


  <script src="/js/affix.js?v=7.2.0"></script>

  <script src="/js/schemes/pisces.js?v=7.2.0"></script>




  

  <script src="/js/next-boot.js?v=7.2.0"></script>

  

  
  <script src="/js/exturl.js?v=7.2.0"></script>


  

  

  






  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  

  


  

  

  

  

  

  

  

  

  

  


  

</body>
</html>
