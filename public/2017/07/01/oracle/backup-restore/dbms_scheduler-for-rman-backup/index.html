<!DOCTYPE html>













<html class="theme-next gemini" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












  <meta name="yandex-verification" content="3ac9ae36ddebb425">





  
  
  <link rel="stylesheet" href="/lib/fancybox/source/jquery.fancybox.css">







<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">

<link rel="stylesheet" href="/css/main.css?v=7.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.2.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.2.0',
    sidebar: {"onmobile":true},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    copycode: {"enable":false,"show_result":false,"style":"flat"},
    fancybox: true,
    fastclick: false,
    lazyload: true,
    tabs: true,
    motion: {"enable":false,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    }
  };
</script>

  <meta name="description" content="利用DBMS_SCHEDULER在Oracle 11gR2 RAC上执行rman备份RMAN backup in Oracle 11gR2 RAC is exactly same like RMAN backup in Oracle 11gR2 single node.The only difference is: Typically, in case of Oracle single node">
<meta name="keywords" content="oracle backup">
<meta property="og:type" content="article">
<meta property="og:title" content="利用DBMS_SCHEDULER在Oracle 11gR2 RAC上执行rman备份">
<meta property="og:url" content="http://liupzmin.com/2017/07/01/oracle/backup-restore/dbms_scheduler-for-rman-backup/index.html">
<meta property="og:site_name" content="兔子先生">
<meta property="og:description" content="利用DBMS_SCHEDULER在Oracle 11gR2 RAC上执行rman备份RMAN backup in Oracle 11gR2 RAC is exactly same like RMAN backup in Oracle 11gR2 single node.The only difference is: Typically, in case of Oracle single node">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-07-21T04:43:08.312Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="利用DBMS_SCHEDULER在Oracle 11gR2 RAC上执行rman备份">
<meta name="twitter:description" content="利用DBMS_SCHEDULER在Oracle 11gR2 RAC上执行rman备份RMAN backup in Oracle 11gR2 RAC is exactly same like RMAN backup in Oracle 11gR2 single node.The only difference is: Typically, in case of Oracle single node">





  
  
  <link rel="canonical" href="http://liupzmin.com/2017/07/01/oracle/backup-restore/dbms_scheduler-for-rman-backup/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  
  <title>利用DBMS_SCHEDULER在Oracle 11gR2 RAC上执行rman备份 | 兔子先生</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  

  <div class="container page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">兔子先生</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">一只兔子的幸福生活</h1>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档<span class="badge">8</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签<span class="badge">4</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类<span class="badge">3</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



</div>
    </header>

    
  
  

  

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xpdXB6bWlu" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></span>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://liupzmin.com/2017/07/01/oracle/backup-restore/dbms_scheduler-for-rman-backup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="巴流">
      <meta itemprop="description" content="左手人文 | 右手科技">
      <meta itemprop="image" content="/images/heizi.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兔子先生">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">利用DBMS_SCHEDULER在Oracle 11gR2 RAC上执行rman备份<span class="exturl post-edit-link" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvdGhlbWUtbmV4dC5vcmcvZWRpdC9zb3VyY2Uvc291cmNlL19wb3N0cy9vcmFjbGUvYmFja3VwLXJlc3RvcmUvZGJtc19zY2hlZHVsZXItZm9yLXJtYW4tYmFja3VwLm1k" title="编辑"><i class="fa fa-pencil"></i></span>

              
            
          </h2>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-07-01 11:04:00" itemprop="dateCreated datePublished" datetime="2017-07-01T11:04:00+08:00">2017-07-01</time>
            </span>
          

          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-07-21 12:43:08" itemprop="dateModified" datetime="2019-07-21T12:43:08+08:00">2019-07-21</time>
              </span>
            
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/oracle-backup/" itemprop="url" rel="index"><span itemprop="name">oracle backup</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="利用DBMS-SCHEDULER在Oracle-11gR2-RAC上执行rman备份"><a href="#利用DBMS-SCHEDULER在Oracle-11gR2-RAC上执行rman备份" class="headerlink" title="利用DBMS_SCHEDULER在Oracle 11gR2 RAC上执行rman备份"></a>利用DBMS_SCHEDULER在Oracle 11gR2 RAC上执行rman备份</h1><p>RMAN backup in Oracle 11gR2 RAC is exactly same like RMAN backup in Oracle 11gR2 single node.<br>The only difference is: Typically, in case of Oracle single node database, we will schedule RMAN scripts with the help of CRON job and it will run according to our convenience, but in case of Oracle RAC if we schedule RMAN script and if unfortunately that RAC node goes down ( where we configured RMAN scripts ), then RMAN backup won’t run obviously.</p>
<p>So, Same strategy will not be work in Oracle RAC node. For RMAN consistent backups use dbms_scheduler &amp; we need to place RMAN scripts in shared directory. ( Or in my case, I have created identical scripts on both cluster node’s )</p>
<p><strong>注意：</strong>  <em>需要将脚本放在共享位置或者每个节点的相同位置</em></p>
<blockquote>
<p>看一下rman的备份脚本，此脚本将备份放在ASM中，将日志放在节点本地</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">################################################################</span><br><span class="line">#    rman_backup_rac.sh FOR RAC                                #</span><br><span class="line">#    created by lp                                             #</span><br><span class="line">#    2017/03/22                                                #</span><br><span class="line">#    usage: rman_backup_rac.sh &lt;$BACKUP_LEVEL&gt;                 #</span><br><span class="line">#           BACKUP_LEVEL:                                      #</span><br><span class="line">#              F: full backup                                  #</span><br><span class="line">#              0: level 0                                      #</span><br><span class="line">#              1: level 1                                      #</span><br><span class="line">################################################################</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#!/bin/bash</span><br><span class="line"># User specific environment and startup programs</span><br><span class="line">export ORACLE_HOME=/u01/app/oracle/product/11.2.0/dbhome_1</span><br><span class="line">export RMAN_BAK_LOG_BASE=/home/oracle/DbBackup</span><br><span class="line">export RMAN_BAK_DATA_BASE=+data/NXRAC/backup</span><br><span class="line">export ORACLE_SID=`ps -ef|grep pmon|grep -v ASM|grep -v grep|awk -F&apos;_&apos; &apos;&#123;print $NF&#125;&apos;`</span><br><span class="line">export TIMESTAMP=`date +%Y%m%d%H%M`;</span><br><span class="line"></span><br><span class="line">#the destination of rman backuppiece</span><br><span class="line">export RMAN_DATA=$&#123;RMAN_BAK_DATA_BASE&#125;/rman</span><br><span class="line"></span><br><span class="line">#the destination of rman backup logs</span><br><span class="line">export RMAN_LOG=$&#123;RMAN_BAK_LOG_BASE&#125;/logs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if [[ ! -z $1 ]] &amp;&amp; echo $1 |grep -Ew &quot;[01F]&quot; &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">then</span><br><span class="line">                                export RMAN_LEVEL=$&#123;1&#125;</span><br><span class="line"></span><br><span class="line">                                # Check rman level</span><br><span class="line">                                if [ &quot;$RMAN_LEVEL&quot; == &quot;F&quot; ];</span><br><span class="line">                                        then  unset INCR_LVL</span><br><span class="line">                                        BACKUP_TYPE=full</span><br><span class="line">                                        else</span><br><span class="line">                                        INCR_LVL=&quot;INCREMENTAL LEVEL $&#123;RMAN_LEVEL&#125;&quot;</span><br><span class="line">                                        BACKUP_TYPE=lev$&#123;RMAN_LEVEL&#125;</span><br><span class="line">                                fi</span><br><span class="line">else</span><br><span class="line">                                echo &quot;$&#123;1&#125; wrong argument!&quot; &gt;$&#123;RMAN_LOG&#125;/wrong_argument_$&#123;TIMESTAMP&#125;.log</span><br><span class="line">                                exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#the prefix of rman backuppiece                                 </span><br><span class="line">export RMAN_FILE=$&#123;RMAN_DATA&#125;/$&#123;BACKUP_TYPE&#125;_$&#123;TIMESTAMP&#125;</span><br><span class="line"></span><br><span class="line">#the logfile of shell script including the rman logs contents</span><br><span class="line">export SSH_LOG=$&#123;RMAN_LOG&#125;/$&#123;BACKUP_TYPE&#125;_$&#123;TIMESTAMP&#125;.log</span><br><span class="line"></span><br><span class="line">#the size of backuppiece</span><br><span class="line">export MAXPIECESIZE=4G</span><br><span class="line"></span><br><span class="line">####################################################################</span><br><span class="line">#                                                                  #</span><br><span class="line">#   the name of rman logs excluding the file expanded-name,        #</span><br><span class="line">#   when the shell is complete,the content of this file will be    #</span><br><span class="line">#   appended to the $SSH_LOG and the rman logfile will be deleted. #</span><br><span class="line">#                                                                  #</span><br><span class="line">####################################################################</span><br><span class="line">export RMAN_LOG_FILE=$&#123;RMAN_LOG&#125;/$&#123;BACKUP_TYPE&#125;_$&#123;TIMESTAMP&#125;_1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#Check RMAN Backup Path</span><br><span class="line"></span><br><span class="line">if ! test -d $&#123;RMAN_LOG&#125;</span><br><span class="line">then</span><br><span class="line">mkdir -p $&#123;RMAN_LOG&#125;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">echo &quot;---------------------------------&quot; &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class="line">echo &quot;   &quot; &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class="line">echo &quot;Rman Begin  to Working .........&quot; &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class="line">echo &quot;Begin time at:&quot; `date` --`date +%Y%m%d%H%M` &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class="line"></span><br><span class="line">#Startup rman to backup</span><br><span class="line"></span><br><span class="line">$ORACLE_HOME/bin/rman log=$&#123;RMAN_LOG_FILE&#125;.log &lt;&lt;EOF</span><br><span class="line">connect target /</span><br><span class="line">run &#123;</span><br><span class="line">CONFIGURE RETENTION POLICY TO RECOVERY WINDOW OF 7 DAYS;</span><br><span class="line">CONFIGURE BACKUP OPTIMIZATION ON;</span><br><span class="line">CONFIGURE CONTROLFILE AUTOBACKUP ON;</span><br><span class="line">CONFIGURE DEVICE TYPE DISK PARALLELISM 4 BACKUP TYPE TO BACKUPSET;</span><br><span class="line">CONFIGURE CONTROLFILE AUTOBACKUP FORMAT FOR DEVICE TYPE DISK TO &apos;$&#123;RMAN_DATA&#125;/control_auto_%F&apos;;</span><br><span class="line">ALLOCATE CHANNEL &apos;ch1&apos; TYPE DISK maxpiecesize=$&#123;MAXPIECESIZE&#125; CONNECT &apos;SYS/passwd@node1&apos;;</span><br><span class="line">ALLOCATE CHANNEL &apos;ch2&apos; TYPE DISK maxpiecesize=$&#123;MAXPIECESIZE&#125; CONNECT &apos;SYS/passwd@node1&apos;;</span><br><span class="line">ALLOCATE CHANNEL &apos;ch3&apos; TYPE DISK maxpiecesize=$&#123;MAXPIECESIZE&#125; CONNECT &apos;SYS/passwd@mode2&apos;;</span><br><span class="line">ALLOCATE CHANNEL &apos;ch4&apos; TYPE DISK maxpiecesize=$&#123;MAXPIECESIZE&#125; CONNECT &apos;SYS/passwd@node2&apos;;</span><br><span class="line">CROSSCHECK ARCHIVELOG ALL;</span><br><span class="line">DELETE NOPROMPT OBSOLETE;</span><br><span class="line">DELETE NOPROMPT EXPIRED BACKUP;</span><br><span class="line">BACKUP AS COMPRESSED BACKUPSET</span><br><span class="line">$&#123;INCR_LVL&#125;</span><br><span class="line">DATABASE FORMAT &apos;$&#123;RMAN_FILE&#125;_db_%U&apos; TAG &apos;$&#123;BACKUP_TYPE&#125;_$&#123;TIMESTAMP&#125;&apos;;</span><br><span class="line">SQL &apos;ALTER SYSTEM ARCHIVE LOG CURRENT&apos;;</span><br><span class="line">BACKUP FILESPERSET 20 ARCHIVELOG ALL FORMAT &apos;$&#123;RMAN_FILE&#125;_arc_%U&apos; TAG &apos;$&#123;ORACLE_SID&#125;_arc_$&#123;TIMESTAMP&#125;&apos;</span><br><span class="line">DELETE  INPUT;  </span><br><span class="line">RELEASE CHANNEL ch1;</span><br><span class="line">RELEASE CHANNEL ch2;</span><br><span class="line">RELEASE CHANNEL ch3;</span><br><span class="line">RELEASE CHANNEL ch4;</span><br><span class="line">ALLOCATE CHANNEL ch00 TYPE DISK;</span><br><span class="line">BACKUP</span><br><span class="line">    FORMAT &apos;$&#123;RMAN_DATA&#125;/cntrl_%U&apos;</span><br><span class="line">    CURRENT CONTROLFILE;</span><br><span class="line">RELEASE CHANNEL ch00;</span><br><span class="line">&#125;</span><br><span class="line">exit;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">RC=$?</span><br><span class="line"></span><br><span class="line">cat $&#123;RMAN_LOG_FILE&#125;.log &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class="line">echo &quot;Rman Stop working @ time:&quot;`date` `date +%Y%m%d%H%M` &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class="line"></span><br><span class="line">if [ $RC -ne &quot;0&quot; ]; then</span><br><span class="line">    echo &quot;------ error ------&quot; &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class="line">else</span><br><span class="line">    echo &quot;------ Success during RMAN backup peroid------&quot; &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class="line">    rm -rf $&#123;RMAN_LOG_FILE&#125;.log</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">exit</span><br></pre></td></tr></table></figure>

<p><strong>DBMS_SCHEDULER:</strong></p>
<p>Here we are using DBMS_SCHEDULER instead of DBMS_JOB, because DBMS_SCHEDULER is RAC aware.</p>
<p><strong>Before jump into real DBMS_SCHEDULER configuration, we need to focus on an important thing, That:</strong></p>
<p>Both RAC nodes local time zone must be identical with DBMS_SCHEDULER default time.</p>
<p>On all RAC node, Ensure local time zone and set it accordingly.</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[oracle@node2 ]$ cat /etc/sysconfig/clock</span><br><span class="line">ZONE="Asia/Shanghai"</span><br></pre></td></tr></table></figure>

<p><strong>configure default time zone for DBMS_SCHEDULER</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; select value from dba_scheduler_global_attribute where attribute_name = 'DEFAULT_TIMEZONE';</span><br><span class="line"></span><br><span class="line">VALUE</span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line">PRC</span><br><span class="line"></span><br><span class="line">SQL&gt; exec dbms_scheduler.set_scheduler_attribute ('DEFAULT_TIMEZONE', 'Asia/Shanghai');</span><br><span class="line"></span><br><span class="line">PL/SQL procedure successfully completed.</span><br><span class="line"></span><br><span class="line">SQL&gt; select value from dba_scheduler_global_attribute where attribute_name = 'DEFAULT_TIMEZONE';</span><br><span class="line"></span><br><span class="line">VALUE</span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------</span></span><br><span class="line">Asia/Shanghai</span><br></pre></td></tr></table></figure>

<p>Now we need to create credential so that are assigned to DBMS_SCHEDULER jobs so that they can authenticate with a local/remote host operating system or a remote Oracle database.</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; exec dbms_scheduler.create_credential(credential_name =&gt; 'oracle', username =&gt; 'oracle', password =&gt; 'oracle');</span><br><span class="line"></span><br><span class="line">PL/SQL procedure successfully completed.</span><br></pre></td></tr></table></figure>

<p>Now its time to create DBMS_SCHEDULER job for RMAN incremental level 0 backup, Here in this procedure I am going to create <em>RMAN_INC0_BACKUP</em> job with required attributes.</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">begin</span></span><br><span class="line">dbms_scheduler.create_job(</span><br><span class="line">job_name            =&gt; <span class="string">'RMAN_INC0_BACKUP'</span>,</span><br><span class="line">job_type            =&gt; <span class="string">'EXECUTABLE'</span>,</span><br><span class="line">job_action          =&gt; <span class="string">'/bin/sh'</span>,</span><br><span class="line">number_of_arguments =&gt; <span class="number">2</span>,</span><br><span class="line">start_date          =&gt; SYSTIMESTAMP,</span><br><span class="line">credential_name     =&gt; <span class="string">'oracle'</span>,</span><br><span class="line">auto_drop           =&gt; <span class="literal">FALSE</span>,</span><br><span class="line">enabled             =&gt; <span class="literal">FALSE</span>);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>Set argument_position &amp; argument_value ( i.e. Path of the RMAN script ) for the same job:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">begin</span></span><br><span class="line">dbms_scheduler.set_job_argument_value(</span><br><span class="line">job_name            =&gt; <span class="string">'RMAN_INC0_BACKUP'</span>,</span><br><span class="line">argument_position   =&gt;  <span class="number">1</span>,</span><br><span class="line">argument_value      =&gt; <span class="string">'/home/oracle/rman.sh'</span>);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line">/</span><br><span class="line"></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">dbms_scheduler.set_job_argument_value(</span><br><span class="line">job_name            =&gt; <span class="string">'RMAN_INC0_BACKUP'</span>,</span><br><span class="line">argument_position   =&gt;  <span class="number">2</span>,</span><br><span class="line">argument_value      =&gt; <span class="number">0</span>);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>Set start_date for the same job, In my case <em>RMAN_INC0_BACKUP</em> job will execute every week on sunday @03am, so job start date and its first run timing would  according to my convenience.</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">begin</span></span><br><span class="line">dbms_scheduler.set_attribute(</span><br><span class="line"><span class="keyword">name</span>      =&gt; <span class="string">'RMAN_INC0_BACKUP'</span>,</span><br><span class="line"><span class="keyword">attribute</span> =&gt; <span class="string">'start_date'</span>,</span><br><span class="line"><span class="keyword">value</span>     =&gt; trunc(<span class="keyword">sysdate</span>)+<span class="number">3</span>/<span class="number">24</span>);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>Test your backup job manually in SQL prompt by instantiating <em>RMAN_INC0_BACKUP</em> job.</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">SQL&gt; exec dbms_scheduler.run_job('RMAN_INC0_BACKUP');</span><br><span class="line">PL/SQL procedure successfully completed.</span><br></pre></td></tr></table></figure>

<p>Verify running RMAN backup status by issuing following SQL query, It will show you RMAN backup details with start time &amp; end time.</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> SESSION_KEY, INPUT_TYPE, <span class="keyword">STATUS</span>,</span><br><span class="line">to_char(START_TIME,<span class="string">'mm/dd/yy hh24:mi'</span>) start_time,</span><br><span class="line">to_char(END_TIME,<span class="string">'mm/dd/yy hh24:mi'</span>) end_time,</span><br><span class="line">elapsed_seconds/<span class="number">3600</span> hrs</span><br><span class="line"><span class="keyword">from</span> V$RMAN_BACKUP_JOB_DETAILS</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> session_key;</span><br></pre></td></tr></table></figure>

<p>In case of any error while test run, you can make sure details of error by issuing the following query, OR You can also query to <em>dba_scheduler_job_run_details</em> dictionary view for more details.</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> JOB_NAME,<span class="keyword">STATUS</span>,STATE,<span class="keyword">ERROR</span><span class="comment">#,CREDENTIAL_NAME from dba_scheduler_job_run_details where CREDENTIAL_NAME like 'RMAN%';</span></span><br></pre></td></tr></table></figure>

<p>After successfully completion of test run, Enable &amp; schedule it by following procedure by setting value to <em>repeat_interval</em> parameter, In my case <em>RMAN_INC0_BACKUP</em> job will execute every week on Sunday @03pm.</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">begin</span></span><br><span class="line">dbms_scheduler.set_attribute(</span><br><span class="line"><span class="keyword">name</span>      =&gt; <span class="string">'RMAN_INC0_BACKUP'</span>,</span><br><span class="line"><span class="keyword">attribute</span> =&gt; <span class="string">'repeat_interval'</span>,</span><br><span class="line"><span class="keyword">value</span>     =&gt; <span class="string">'freq=daily;byday=sun;byhour=03'</span>);</span><br><span class="line">dbms_scheduler.enable( 'RMAN_INC0_BACKUP' );</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p>Ensure dbms_scheduler job details by issuing the following query OR you can also query to <em>dba_scheduler_jobs</em> and <em>dba_scheduler_job_args</em>.</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">SQL&gt; select job_name,enabled,owner, state from dba_scheduler_jobs where job_name in ('RMAN_INC0_BACKUP');</span><br></pre></td></tr></table></figure>

<p>Keep your eye on behavior of dbms_scheduler job by issuing the following query:</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">SQL&gt; select job_name,RUN_COUNT,LAST_START_DATE,NEXT_RUN_DATE from dba_scheduler_jobs where job_name in ('RMAN_INC0_BACKUP');</span><br><span class="line">SQL&gt; select *  from dba_scheduler_job_args where job_name like 'RMAN%';</span><br></pre></td></tr></table></figure>

<p>In accordance with the above method to create a level 1 backup job <em>RMAN_INC1_BACKUP</em>，The only difference is the <em>repeat_interval</em>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">begin</span></span><br><span class="line">dbms_scheduler.set_attribute(</span><br><span class="line"><span class="keyword">name</span>      =&gt; <span class="string">'RMAN_INC1_BACKUP'</span>,</span><br><span class="line"><span class="keyword">attribute</span> =&gt; <span class="string">'repeat_interval'</span>,</span><br><span class="line"><span class="keyword">value</span>     =&gt; <span class="string">'freq=daily;byday=mon,tue,wed,thu,fri,sat;byhour=03'</span>);</span><br><span class="line">dbms_scheduler.enable( 'RMAN_INC1_BACKUP' );</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>

<p><strong>Important Note:</strong><br>DBMS_SCHEDULER is smart enough to start backup on the node where the last backup was successfully executed.</p>
<p><strong>参考：</strong></p>
<p>https://dbatricksworld.com/how-to-backup-oracle-rac-11gr2-database-with-rman-backup-utility-with-the-help-of-dbms_scheduler-part-i-rman-full-database-backup/</p>
<p>http://dbatricksworld.com/how-to-backup-oracle-rac-11gr2-database-with-rman-backup-utility-with-the-help-of-dbms_scheduler-part-ii-rman-incremental-database-backup/</p>

      
    </div>

    

    
      
    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        
          
        
        <div class="post-tags">
          
            <a href="/tags/oracle-backup/" rel="tag"># oracle backup</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/07/25/oracle/lock-latch/enq-TM-1/" rel="next" title="enq之TM-contention解决之道——外键无索引导致锁争用（上）">
                <i class="fa fa-chevron-left"></i> enq之TM-contention解决之道——外键无索引导致锁争用（上）
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/07/21/hello-world/" rel="prev" title="Hello World">
                Hello World <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="gitalk-container">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">

          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  
    <img class="site-author-image" itemprop="image" src="/images/heizi.jpeg" alt="巴流">
  
  <p class="site-author-name" itemprop="name">巴流</p>
  <div class="site-description motion-element" itemprop="description">左手人文 | 右手科技</div>
</div>


  <nav class="site-state motion-element">
    
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    

    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        
        
          
        
          
        
          
        
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span>
        </a>
      </div>
    

    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">标签</span>
        </a>
      </div>
    
  </nav>







  <div class="links-of-author motion-element">
    
      <span class="links-of-author-item">
      
      
      
        
      
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xpdXB6bWlu" title="GitHub &rarr; https://github.com/liupzmin"><i class="fa fa-fw fa-github"></i></span>
      </span>
    
      <span class="links-of-author-item">
      
      
      
        
      
        <span class="exturl" data-url="bWFpbHRvOnN1cHBvcnRAdGhlbWUtbmV4dC5vcmc=" title="E-Mail &rarr; mailto:support@theme-next.org"><i class="fa fa-fw fa-envelope"></i></span>
      </span>
    
  </div>







          
          
        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#利用DBMS-SCHEDULER在Oracle-11gR2-RAC上执行rman备份"><span class="nav-number">1.</span> <span class="nav-text">利用DBMS_SCHEDULER在Oracle 11gR2 RAC上执行rman备份</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2014 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">NexT</span>

  

  
</div>


  <div class="powered-by">由 <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <span class="exturl theme-link" data-url="aHR0cHM6Ly90aGVtZS1uZXh0Lm9yZw==">NexT.Gemini</span> v7.2.0</div>



  <div class="footer-custom">
Theme source code <span class="exturl theme-link" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvaGV4by10aGVtZS1uZXh0">here</span><br>
Website source code <span class="exturl theme-link" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvdGhlbWUtbmV4dC5vcmc=">here</span>
</div>



        








        
      </div>
    </footer>

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>








  





  











  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/lazyload/lozad.min.js?v=1.10.0"></script>

  
  <script src="/lib/fancybox/source/jquery.fancybox.pack.js"></script>




  <script src="/js/utils.js?v=7.2.0"></script>



  
  


  <script src="/js/affix.js?v=7.2.0"></script>

  <script src="/js/schemes/pisces.js?v=7.2.0"></script>




  
  <script src="/js/scrollspy.js?v=7.2.0"></script>
<script src="/js/post-details.js?v=7.2.0"></script>



  <script src="/js/next-boot.js?v=7.2.0"></script>

  

  
  <script src="/js/exturl.js?v=7.2.0"></script>


  

  

  


  
    

  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">

  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

   <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: 'ae0756501dfc5de89d35',
          clientSecret: '26befb359f7a466031bb96b4b7e0715c41c63fb8',
          repo: 'liupzmin.github.io',
          owner: 'liupzmin',
          admin: ['liupzmin'],
          id: location.pathname,
          labels: ['Gitalk'],
          perPage: 15,
          pagerDirection: 'last',
          createIssueManually: true,
          distractionFreeMode: false
        })
        gitalk.render('gitalk-container')           
       </script>


  




  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">

  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

   <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: 'ae0756501dfc5de89d35',
          clientSecret: '26befb359f7a466031bb96b4b7e0715c41c63fb8',
          repo: 'liupzmin.github.io',
          owner: 'liupzmin',
          admin: ['liupzmin'],
          id: location.pathname,
          labels: ['Gitalk'],
          perPage: 15,
          pagerDirection: 'last',
          createIssueManually: true,
          distractionFreeMode: false
        })
        gitalk.render('gitalk-container')           
       </script>



  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

  

  


  

</body>
</html>
