{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"source/CNAME","path":"CNAME","modified":0,"renderable":0},{"_id":"themes/next/source/css/main.styl","path":"css/main.styl","modified":0,"renderable":1},{"_id":"themes/next/source/images/apple-touch-icon-next.png","path":"images/apple-touch-icon-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/avatar.gif","path":"images/avatar.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/algolia_logo.svg","path":"images/algolia_logo.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","path":"images/cc-by-nc-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","path":"images/cc-by-nc-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc.svg","path":"images/cc-by-nc.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-nd.svg","path":"images/cc-by-nd.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by-sa.svg","path":"images/cc-by-sa.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-by.svg","path":"images/cc-by.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/cc-zero.svg","path":"images/cc-zero.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/favicon-16x16-next.png","path":"images/favicon-16x16-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/favicon-32x32-next.png","path":"images/favicon-32x32-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/heizi.jpeg","path":"images/heizi.jpeg","modified":0,"renderable":1},{"_id":"themes/next/source/images/logo.svg","path":"images/logo.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/quote-l.svg","path":"images/quote-l.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/quote-r.svg","path":"images/quote-r.svg","modified":0,"renderable":1},{"_id":"themes/next/source/js/affix.js","path":"js/affix.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/algolia-search.js","path":"js/algolia-search.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/exturl.js","path":"js/exturl.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/js.cookie.js","path":"js/js.cookie.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/motion.js","path":"js/motion.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/next-boot.js","path":"js/next-boot.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/post-details.js","path":"js/post-details.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/scroll-cookie.js","path":"js/scroll-cookie.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/scrollspy.js","path":"js/scrollspy.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/utils.js","path":"js/utils.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/schemes/pisces.js","path":"js/schemes/pisces.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/schemes/muse.js","path":"js/schemes/muse.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/HELP-US-OUT.txt","path":"lib/font-awesome/HELP-US-OUT.txt","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/bower.json","path":"lib/font-awesome/bower.json","modified":0,"renderable":1},{"_id":"themes/next/source/lib/lazyload/lozad.min.js","path":"lib/lazyload/lozad.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.min.js","path":"lib/velocity/velocity.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.ui.js","path":"lib/velocity/velocity.ui.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","path":"lib/velocity/velocity.ui.min.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/jquery/index.js","path":"lib/jquery/index.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading.gif","path":"lib/fancybox/source/fancybox_loading.gif","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_overlay.png","path":"lib/fancybox/source/fancybox_overlay.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/blank.gif","path":"lib/fancybox/source/blank.gif","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading@2x.gif","path":"lib/fancybox/source/fancybox_loading@2x.gif","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite@2x.png","path":"lib/fancybox/source/fancybox_sprite@2x.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite.png","path":"lib/fancybox/source/fancybox_sprite.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.css","path":"lib/fancybox/source/jquery.fancybox.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.js","path":"lib/fancybox/source/jquery.fancybox.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.pack.js","path":"lib/fancybox/source/jquery.fancybox.pack.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css","path":"lib/font-awesome/css/font-awesome.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css.map","path":"lib/font-awesome/css/font-awesome.css.map","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.min.css","path":"lib/font-awesome/css/font-awesome.min.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff","path":"lib/font-awesome/fonts/fontawesome-webfont.woff","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff2","path":"lib/font-awesome/fonts/fontawesome-webfont.woff2","modified":0,"renderable":1},{"_id":"themes/next/source/lib/velocity/velocity.js","path":"lib/velocity/velocity.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.css","path":"lib/fancybox/source/helpers/jquery.fancybox-buttons.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/fancybox_buttons.png","path":"lib/fancybox/source/helpers/fancybox_buttons.png","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.js","path":"lib/fancybox/source/helpers/jquery.fancybox-buttons.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-media.js","path":"lib/fancybox/source/helpers/jquery.fancybox-media.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","path":"lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","modified":0,"renderable":1},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","path":"lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","modified":0,"renderable":1},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.eot","path":"lib/font-awesome/fonts/fontawesome-webfont.eot","modified":0,"renderable":1}],"Cache":[{"_id":"source/CNAME","hash":"82691e305d448abd0455bdce15bd2f3582736859","modified":1563615402619},{"_id":"source/.DS_Store","hash":"310c1139b25b1ac8ef0e8b789215373e7a8cbf4d","modified":1563612848244},{"_id":"themes/next/.DS_Store","hash":"1237cfbdd042276db6c5414edbffdfe2e15e2816","modified":1563673475566},{"_id":"themes/next/.all-contributorsrc","hash":"a861e51d8b604bd98c4aac9f4338fa4fb2084a32","modified":1563577524210},{"_id":"themes/next/._config.yml.swp","hash":"b947c8a48d2e8783aeae0f366a7b2d2bf7173159","modified":1563672696004},{"_id":"themes/next/.bowerrc","hash":"3228a58ed0ece9f85e1e3136352094080b8dece1","modified":1563577524210},{"_id":"themes/next/.editorconfig","hash":"792fd2bd8174ece1a75d5fd24ab16594886f3a7f","modified":1563577524210},{"_id":"themes/next/.eslintrc.json","hash":"cc5f297f0322672fe3f684f823bc4659e4a54c41","modified":1563577524210},{"_id":"themes/next/.gitattributes","hash":"44bd4729c74ccb88110804f41746fec07bf487d4","modified":1563577524211},{"_id":"themes/next/.gitignore","hash":"b80cec1d5e6a73d1cec382aad8046d1352a1e963","modified":1563577524215},{"_id":"themes/next/.stylintrc","hash":"b28e24704a5d8de08346c45286574c8e76cc109f","modified":1563577524216},{"_id":"themes/next/LICENSE.md","hash":"18144d8ed58c75af66cb419d54f3f63374cd5c5b","modified":1563577524216},{"_id":"themes/next/.travis.yml","hash":"3d1dc928c4a97933e64379cfde749dedf62f252c","modified":1563577524216},{"_id":"themes/next/README.md","hash":"2fcc7621e898732ef7976b89ca2511f84c577c35","modified":1563577524216},{"_id":"themes/next/bower.json","hash":"e6a80b9ed2d618d1cca5781952c67167a7cfac07","modified":1563577524217},{"_id":"themes/next/_config.yml","hash":"eccd99894847c7b81e27464f3d9e5def6ed0568b","modified":1563672692000},{"_id":"themes/next/crowdin.yml","hash":"e026078448c77dcdd9ef50256bb6635a8f83dca6","modified":1563577524217},{"_id":"themes/next/gulpfile.coffee","hash":"899001c864f975082ca1bc6b3fe3c614007baf8a","modified":1563577524223},{"_id":"themes/next/package.json","hash":"abefbba4150026ec8b3d8e79c7e874964bd3dc76","modified":1563577524245},{"_id":"source/_posts/enq-TM-1.md","hash":"f6841672f1437d8fb7c36a534915082a0394e82a","modified":1563674748691},{"_id":"source/_posts/hello-world.md","hash":"f52d22b64b67616ef8130100326dc7565ac36ca8","modified":1563674390721},{"_id":"source/_data/footer.swig","hash":"e566fa4ba7b00702d97632b135bb5c24a7175ba5","modified":1563579145009},{"_id":"source/_data/styles.styl","hash":"08a50cd552314c9c53953200f41c63bcfd23cb05","modified":1563579094170},{"_id":"source/about/index.md","hash":"23b467e74243f5e0b6137d2e285797938cd58306","modified":1563673907246},{"_id":"source/tags/index.md","hash":"0564c1527ec050b827e114bf97488ffaaba6f438","modified":1563674230002},{"_id":"source/categories/index.md","hash":"63b489420aceb709e8127e310c0ec0eaddf9b595","modified":1563674199043},{"_id":"themes/next/.git/HEAD","hash":"acbaef275e46a7f14c1ef456fff2c8bbe8c84724","modified":1563577524202},{"_id":"themes/next/.git/description","hash":"9635f1b7e12c045212819dd934d809ef07efa2f4","modified":1563577414826},{"_id":"themes/next/.git/config","hash":"e2ca9fa6f115d4406d24bf0df53fc26ce13e0c9b","modified":1563577524204},{"_id":"themes/next/.git/packed-refs","hash":"d4fe2df8b4e28b3f3a4b0150d4443c4207a88b66","modified":1563577524201},{"_id":"themes/next/.github/CODE_OF_CONDUCT.md","hash":"c149f003d03501565e7688915cd8f2e99fbf8f42","modified":1563577524211},{"_id":"themes/next/.github/CONTRIBUTING.md","hash":"d366609651386c65ee842d47d10d7cf971790383","modified":1563577524212},{"_id":"themes/next/.github/ISSUE_TEMPLATE.md","hash":"00c25366764e6b9ccb40b877c60dc13b2916bbf7","modified":1563577524212},{"_id":"themes/next/.github/PULL_REQUEST_TEMPLATE.md","hash":"3239625bb2573e61f7bcce27a74882a9ff7021e9","modified":1563577524213},{"_id":"themes/next/.github/auto_assign.yml","hash":"cb68a1dca1c4623448c2ca899614a9f21df1b036","modified":1563577524213},{"_id":"themes/next/.github/config.yml","hash":"8a5cbf5aa9529390fe0a782758aca9c3a02f9dcf","modified":1563577524214},{"_id":"themes/next/.github/eslint-disable-bot.yml","hash":"16541fb7b80f5ab90135db96285badb63c4d7d3e","modified":1563577524214},{"_id":"themes/next/.github/lock.yml","hash":"585d2c471047be320aa62f2b74dad797bf09c530","modified":1563577524214},{"_id":"themes/next/.github/mergeable.yml","hash":"0ee56e23bbc71e1e76427d2bd255a9879bd36e22","modified":1563577524214},{"_id":"themes/next/.github/support.yml","hash":"d75db6ffa7b4ca3b865a925f9de9aef3fc51925c","modified":1563577524215},{"_id":"themes/next/.github/release-drafter.yml","hash":"c9fdbbdf712327a8ae1ed5972973a75802e245bc","modified":1563577524215},{"_id":"themes/next/.github/stale.yml","hash":"41bf97ee86b8940a0b2e754499ec77fd2b44b717","modified":1563577524215},{"_id":"themes/next/.github/topissuebot.yml","hash":"10665bf2b5aba351725715c71e94ad183a0e8f18","modified":1563577524215},{"_id":"themes/next/.github/weekly-digest.yml","hash":"404e4ccb7fcd6587bc9b0247a7a7ff256d21f2cb","modified":1563577524215},{"_id":"themes/next/docs/AUTHORS.md","hash":"265b3ae69a83efb2e0ce5308ef2dc0f5f1ea0b56","modified":1563577524218},{"_id":"themes/next/docs/ALGOLIA-SEARCH.md","hash":"4094dab82cbdfdd0de117e94b508bbd5ceb3d363","modified":1563577524218},{"_id":"themes/next/docs/DATA-FILES.md","hash":"8e1962dd3e1b700169b3ae5bba43992f100651ce","modified":1563577524218},{"_id":"themes/next/docs/LICENSE.txt","hash":"368bf2c29d70f27d8726dd914f1b3211cae4bbab","modified":1563577524219},{"_id":"themes/next/docs/AGPL3.md","hash":"0d2b8c5fa8a614723be0767cc3bca39c49578036","modified":1563577524218},{"_id":"themes/next/docs/LEANCLOUD-COUNTER-SECURITY.md","hash":"b8fa118856f6992f7416697c4b96531b7c9816a0","modified":1563577524219},{"_id":"themes/next/docs/INSTALLATION.md","hash":"2bbdd6c1751b2b42ce9b9335da420c6026a483e9","modified":1563577524218},{"_id":"themes/next/docs/UPDATE-FROM-5.1.X.md","hash":"a07ca23c38f6e4dddd4b74016b30e88cd3796f75","modified":1563577524219},{"_id":"themes/next/docs/MATH.md","hash":"026d2cff73c22a30ea39c50783557ff4913aceac","modified":1563577524219},{"_id":"themes/next/languages/de.yml","hash":"88dcfa3e53cef1b7f858f98ca9f980179169ae4c","modified":1563577524224},{"_id":"themes/next/languages/default.yml","hash":"c540c3a0d7db2d4239293c8783881962640b6c34","modified":1563577524224},{"_id":"themes/next/languages/es.yml","hash":"a5203c7bbae70bc40f2ee526f9e8105ca9be851e","modified":1563577524224},{"_id":"themes/next/languages/en.yml","hash":"c540c3a0d7db2d4239293c8783881962640b6c34","modified":1563577524224},{"_id":"themes/next/languages/fa.yml","hash":"cc1f3a13e020e2cc666ddc57aaebc4c1ebd669d0","modified":1563577524224},{"_id":"themes/next/languages/fr.yml","hash":"c1e2e892c678920854e1f3df409118398523849e","modified":1563577524225},{"_id":"themes/next/languages/hu.yml","hash":"3b4c10c86a228da70dc4b1a1784a6f942e186032","modified":1563577524225},{"_id":"themes/next/languages/ja.yml","hash":"8f85a6500716191159f16c7f484ba61ddd16eeb6","modified":1563577524226},{"_id":"themes/next/languages/id.yml","hash":"3a9f4485e6801e0e6fae749133a52e3797760795","modified":1563577524225},{"_id":"themes/next/languages/it.yml","hash":"28ff9197a3d21e838e33bb026d8adb544320cb1a","modified":1563577524226},{"_id":"themes/next/languages/nl.yml","hash":"6f4a339ecc67a140f3f9c7bec369cbda6b45afd7","modified":1563577524226},{"_id":"themes/next/languages/ko.yml","hash":"1df31bf037bcb6868a4bd60c49ff55eec5b8167f","modified":1563577524226},{"_id":"themes/next/languages/pt.yml","hash":"6d87701443e33a13574049e613f064f1eb250c95","modified":1563577524227},{"_id":"themes/next/languages/pt-BR.yml","hash":"301a0535df5de7b585c7c9752053c41c6ef26f9b","modified":1563577524227},{"_id":"themes/next/languages/ru.yml","hash":"93872ac01074159566ee3e1738eea6e9216bab8e","modified":1563577524227},{"_id":"themes/next/languages/tr.yml","hash":"5489606e6c40c0b226a3414c8e5037aac965211d","modified":1563577524227},{"_id":"themes/next/languages/uk.yml","hash":"765ba405778f07d7ec3713606568852b04e1a862","modified":1563577524228},{"_id":"themes/next/languages/zh-CN.yml","hash":"f311ad2cc2edba144764c36c0035b6ed0d356a53","modified":1563577524228},{"_id":"themes/next/languages/vi.yml","hash":"6a812db8606498980cd64f001e9ef2f50e124809","modified":1563577524228},{"_id":"themes/next/languages/zh-TW.yml","hash":"3f3674cac8f47a9a509a7557ea1557bbfbd027e8","modified":1563577524229},{"_id":"themes/next/languages/zh-HK.yml","hash":"7a5e47f561d4b6e132f7f3b09676afbf8520264e","modified":1563577524229},{"_id":"themes/next/layout/_layout.swig","hash":"bf314249f8a4247434c2a958c1065f148e923cb7","modified":1563577524229},{"_id":"themes/next/layout/archive.swig","hash":"7e8f3a41a68e912f2b2aaba905d314306ccaf794","modified":1563577524244},{"_id":"themes/next/layout/category.swig","hash":"dda0e6b2139decaf5e865d22ec9d45fdb615a703","modified":1563577524244},{"_id":"themes/next/layout/index.swig","hash":"9b4733d037c360e8504645b1d6c6dd17817c9d7b","modified":1563577524245},{"_id":"themes/next/layout/page.swig","hash":"29c64c7031aaf276d3d11cdf2e95025996fd6eed","modified":1563577524245},{"_id":"themes/next/layout/schedule.swig","hash":"3268dd3d90d8b0e142cfa1a2ebb23355baeda148","modified":1563577524245},{"_id":"themes/next/layout/post.swig","hash":"f74929fd792541916eb25c2addfb35431be071ba","modified":1563577524245},{"_id":"themes/next/layout/tag.swig","hash":"a6be69a90924c9d2f4d90fb4867234859bd2c2e9","modified":1563577524245},{"_id":"themes/next/scripts/injects-point.js","hash":"e6ef2f179c4d52d3175e655f9725d6195b5be51b","modified":1563577524247},{"_id":"themes/next/scripts/injects.js","hash":"f11bf387782cc0fcc8e64a374abbcad5b9e080c8","modified":1563577524247},{"_id":"themes/next/scripts/merge-configs.js","hash":"8d2d3844ad5c29206a05986ab1e6deb88667537e","modified":1563577524248},{"_id":"themes/next/scripts/merge.js","hash":"9130dabe6a674c54b535f322b17d75fe6081472f","modified":1563577524248},{"_id":"themes/next/source/.DS_Store","hash":"97104560415578d83218df9b2bd610c5b9a09a6a","modified":1563673507193},{"_id":"themes/next/test/.jshintrc","hash":"19f93d13d1689fe033c82eb2d5f3ce30b6543cc0","modified":1563577524299},{"_id":"themes/next/test/helpers.js","hash":"a1f5de25154c3724ffc24a91ddc576cdbd60864f","modified":1563577524299},{"_id":"themes/next/test/intern.js","hash":"11fa8a4f5c3b4119a179ae0a2584c8187f907a73","modified":1563577524299},{"_id":"themes/next/.git/index","hash":"3ed6f535ae919a2c2d4585a44666ab50a255e34b","modified":1563679379920},{"_id":"themes/next/source/fonts/.gitkeep","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1563577524287},{"_id":"themes/next/.git/hooks/applypatch-msg.sample","hash":"4de88eb95a5e93fd27e78b5fb3b5231a8d8917dd","modified":1563577414827},{"_id":"themes/next/.git/hooks/post-update.sample","hash":"b614c2f63da7dca9f1db2e7ade61ef30448fc96c","modified":1563577414828},{"_id":"themes/next/.git/hooks/fsmonitor-watchman.sample","hash":"f7c0aa40cb0d620ff0bca3efe3521ec79e5d7156","modified":1563577414827},{"_id":"themes/next/.git/hooks/commit-msg.sample","hash":"ee1ed5aad98a435f2020b6de35c173b75d9affac","modified":1563577414826},{"_id":"themes/next/.git/hooks/pre-applypatch.sample","hash":"f208287c1a92525de9f5462e905a9d31de1e2d75","modified":1563577414828},{"_id":"themes/next/.git/hooks/pre-commit.sample","hash":"33729ad4ce51acda35094e581e4088f3167a0af8","modified":1563577414827},{"_id":"themes/next/.git/hooks/pre-push.sample","hash":"5c8518bfd1d1d3d2c1a7194994c0a16d8a313a41","modified":1563577414828},{"_id":"themes/next/.git/hooks/pre-rebase.sample","hash":"288efdc0027db4cfd8b7c47c4aeddba09b6ded12","modified":1563577414827},{"_id":"themes/next/.git/hooks/pre-receive.sample","hash":"705a17d259e7896f0082fe2e9f2c0c3b127be5ac","modified":1563577414827},{"_id":"themes/next/.git/hooks/prepare-commit-msg.sample","hash":"2584806ba147152ae005cb675aa4f01d5d068456","modified":1563577414828},{"_id":"themes/next/.git/hooks/update.sample","hash":"e729cd61b27c128951d139de8e7c63d1a3758dde","modified":1563577414828},{"_id":"themes/next/.git/logs/HEAD","hash":"63c32362ddf7fd8a39eb4ba0654bbfc26f59c71b","modified":1563577524203},{"_id":"themes/next/.git/info/exclude","hash":"c879df015d97615050afa7b9641e3352a1e701ac","modified":1563577414826},{"_id":"themes/next/.github/ISSUE_TEMPLATE/bug-report.md","hash":"c37a60580c901c79ccb22564b228a46e06207445","modified":1563577524212},{"_id":"themes/next/.github/ISSUE_TEMPLATE/custom-issue-template.md","hash":"57e1e06e845193e80c7df4a4454af28352526f7a","modified":1563577524212},{"_id":"themes/next/.github/ISSUE_TEMPLATE/feature-request.md","hash":"07c423cce4157b8e2dbf60907ccbf3f18c4cf98a","modified":1563577524213},{"_id":"themes/next/.github/ISSUE_TEMPLATE/non-english.md","hash":"0b0727ff4d5180ae67f930fb4f8e9488e33eda9f","modified":1563577524213},{"_id":"themes/next/docs/ru/INSTALLATION.md","hash":"6c5d69e94961c793da156217ecf1179e868d7ba1","modified":1563577524220},{"_id":"themes/next/docs/ru/DATA-FILES.md","hash":"d6d20f60f77a76c77f8e65d0c9adbd79d0274557","modified":1563577524220},{"_id":"themes/next/docs/ru/UPDATE-FROM-5.1.X.md","hash":"b1dd18d9b890b21718883ea1832e7e02a773104a","modified":1563577524221},{"_id":"themes/next/docs/zh-CN/CODE_OF_CONDUCT.md","hash":"0dfb458370a0ffbbe37c00f53c15e3aa3e79b125","modified":1563577524221},{"_id":"themes/next/docs/zh-CN/ALGOLIA-SEARCH.md","hash":"caa624092175d44e3d3a8c6ca23922718da2354c","modified":1563577524221},{"_id":"themes/next/docs/ru/README.md","hash":"932d3965d8b1a1ff653c07a0cafcdbf5892d6945","modified":1563577524220},{"_id":"themes/next/docs/zh-CN/CONTRIBUTING.md","hash":"93e45568d6225396efe5168606e856b3c4fd8ad4","modified":1563577524221},{"_id":"themes/next/docs/zh-CN/MATH.md","hash":"83feca62190abcca0332915ffe0eefe582573085","modified":1563577524223},{"_id":"themes/next/docs/zh-CN/README.md","hash":"79a73361b24e7fb7022992702961faacd6a2f9fe","modified":1563577524223},{"_id":"themes/next/docs/zh-CN/INSTALLATION.md","hash":"b19a6e0ae96eb7c756fb5b1ba03934c7f9cbb3c3","modified":1563577524222},{"_id":"themes/next/docs/zh-CN/DATA-FILES.md","hash":"f3eec572a7d83542e2710a7404082014aaa1a5e7","modified":1563577524222},{"_id":"themes/next/docs/zh-CN/LEANCLOUD-COUNTER-SECURITY.md","hash":"2b1d61e216a65210718697d75bbdd84cda671ea4","modified":1563577524222},{"_id":"themes/next/docs/zh-CN/UPDATE-FROM-5.1.X.md","hash":"ae9f012ce9216f384777fb56dc35e6e5ca13b901","modified":1563577524223},{"_id":"themes/next/layout/_macro/post-collapse.swig","hash":"89b0a0e64637bf5b0cfea0a23642df3d95eedfa4","modified":1563577524230},{"_id":"themes/next/layout/_macro/post.swig","hash":"b7f4b9fb69388a308f2ba430bca035aede001d3d","modified":1563577524230},{"_id":"themes/next/layout/_partials/footer.swig","hash":"97953309b3ab354b8b7cf011850df42bc14b595d","modified":1563577524231},{"_id":"themes/next/layout/_macro/sidebar.swig","hash":"381a52b658bb8d7721e6a3852568ce88a2580f1d","modified":1563577524231},{"_id":"themes/next/layout/_partials/comments.swig","hash":"784356dd77fe96ea1bc4cb0008e2b40de71bf2f0","modified":1563577524231},{"_id":"themes/next/layout/_partials/github-banner.swig","hash":"6357537ac0bb114aed4d61bafb39e6690a413697","modified":1563577524231},{"_id":"themes/next/layout/_partials/pagination.swig","hash":"dbe321bcf3cf45917cc11a3e3f50d8572bac2c70","modified":1563577524233},{"_id":"themes/next/layout/_partials/post-edit.swig","hash":"06dac109504812b63766a80ede9ddacbd42d227d","modified":1563577524234},{"_id":"themes/next/layout/_third-party/baidu-push.swig","hash":"4ccf2abbfd070874265b0436a3eff21f7c998dfb","modified":1563577524240},{"_id":"themes/next/layout/_third-party/bookmark.swig","hash":"10b61a8bac671e375916a4d234c120117098a78f","modified":1563577524241},{"_id":"themes/next/layout/_third-party/chatra.swig","hash":"c59b04402ea02e52ea3dedc34217be0f0d1ad0ac","modified":1563577524241},{"_id":"themes/next/layout/_third-party/mermaid.swig","hash":"d6e6ddda836bd9e2e8d9767a910c7d3280080e81","modified":1563577524242},{"_id":"themes/next/layout/_third-party/needsharebutton.swig","hash":"2c4a66be4677d3e4dec3f169ac8a769098dad1fe","modified":1563577524243},{"_id":"themes/next/layout/_third-party/pangu.swig","hash":"c28f9dc96ab735daeb7f599f86470aa5a83c03cf","modified":1563577524243},{"_id":"themes/next/layout/_third-party/pdf.swig","hash":"810a9b2a6059f46c4a2ddb178f1eaa4c5e23750b","modified":1563577524243},{"_id":"themes/next/layout/_third-party/quicklink.swig","hash":"7757bd285732e857996b99af9d917953589fac5e","modified":1563577524243},{"_id":"themes/next/layout/_third-party/rating.swig","hash":"cbe40cb67dad15ade967b0f396c1a95b6871f76a","modified":1563577524243},{"_id":"themes/next/layout/_third-party/schedule.swig","hash":"2398e5cd0cb466953b6e7a42c2b2caddebf3c348","modified":1563577524243},{"_id":"themes/next/layout/_third-party/tidio.swig","hash":"912368c41de675f458b267a49a99ae3e7e420ebb","modified":1563577524244},{"_id":"themes/next/layout/_scripts/commons.swig","hash":"5db3bf74183de45bb4d6e4632a91f1a561467f17","modified":1563577524237},{"_id":"themes/next/layout/_scripts/exturl.swig","hash":"61ae10d41f67ece004a025077fdb28724af05090","modified":1563577524237},{"_id":"themes/next/layout/_scripts/next-boot.swig","hash":"283e78eb795f52236026434dab6a0667f14d3c08","modified":1563577524237},{"_id":"themes/next/layout/_scripts/noscript.swig","hash":"edaff4766e0c05fd5c889d9dd32884d376bef9d9","modified":1563577524237},{"_id":"themes/next/layout/_scripts/scroll-cookie.swig","hash":"ccd13d73429ef91ef5e8b7d9fa43c8188facdf41","modified":1563577524238},{"_id":"themes/next/layout/_scripts/vendors.swig","hash":"4cb999150bdd41d6a5f5b27f44a05e7fbcb7379c","modified":1563577524238},{"_id":"themes/next/layout/_scripts/three.swig","hash":"cf1819fc0a075d2389ca491740c98eba54ba72a6","modified":1563577524238},{"_id":"themes/next/scripts/helpers/engine.js","hash":"60eb1554456d9d0e5afc4a2d16f1580a0aa02da8","modified":1563577524247},{"_id":"themes/next/scripts/helpers/next-url.js","hash":"799a042bbf497a4c7a2981aa2014ff28fa1bb382","modified":1563577524247},{"_id":"themes/next/scripts/filters/default-injects.js","hash":"ed8b2871c10d7d1128bda48582997a4b926290de","modified":1563577524246},{"_id":"themes/next/scripts/filters/exturl.js","hash":"79ad823ca803cb00e0bfc648aa6c9d59711e0519","modified":1563577524246},{"_id":"themes/next/scripts/filters/lazyload.js","hash":"3d424ad75b1431f57f8d1d0218b2a06ecc0a6e70","modified":1563577524246},{"_id":"themes/next/scripts/tags/button.js","hash":"f3b4f7ae7e58072bbf410d950a99a0b53cbc866d","modified":1563577524248},{"_id":"themes/next/scripts/tags/center-quote.js","hash":"f13430d9d1c9773b390787c2f046bb1f12a79878","modified":1563577524249},{"_id":"themes/next/scripts/tags/full-image.js","hash":"149de45ff83403e97f6affa280072392dca42e4f","modified":1563577524249},{"_id":"themes/next/scripts/tags/group-pictures.js","hash":"8fc05f22b88553bc1d96e0c925799cd97920fc6a","modified":1563577524249},{"_id":"themes/next/scripts/tags/include-raw.js","hash":"5db59d56f4f4082382bf1c16722e6c383892b0c5","modified":1563577524249},{"_id":"themes/next/source/css/main.styl","hash":"7b5a1b48e95fb0d6a75be2ef7318a9a1fe71d09c","modified":1563577524287},{"_id":"themes/next/scripts/tags/label.js","hash":"fc5b267d903facb7a35001792db28b801cccb1f8","modified":1563577524250},{"_id":"themes/next/scripts/tags/mermaid.js","hash":"983c6c4adea86160ecc0ba2204bc312aa338121d","modified":1563577524250},{"_id":"themes/next/scripts/tags/note.js","hash":"0a02bb4c15aec41f6d5f1271cdb5c65889e265d9","modified":1563577524250},{"_id":"themes/next/scripts/tags/pdf.js","hash":"f780cc72bff91d2720626e7af69eed25e9c12a29","modified":1563577524250},{"_id":"themes/next/scripts/tags/tabs.js","hash":"00ca6340d4fe0ccdae7525373e4729117775bbfa","modified":1563577524250},{"_id":"themes/next/scripts/tags/video.js","hash":"e5ff4c44faee604dd3ea9db6b222828c4750c227","modified":1563577524250},{"_id":"themes/next/source/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1563577524287},{"_id":"themes/next/source/images/avatar.gif","hash":"18c53e15eb0c84b139995f9334ed8522b40aeaf6","modified":1563577524287},{"_id":"themes/next/source/images/algolia_logo.svg","hash":"ec119560b382b2624e00144ae01c137186e91621","modified":1563577524287},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","hash":"c6524ece3f8039a5f612feaf865d21ec8a794564","modified":1563577524288},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","hash":"3031be41e8753c70508aa88e84ed8f4f653f157e","modified":1563577524288},{"_id":"themes/next/source/images/cc-by-nc.svg","hash":"8d39b39d88f8501c0d27f8df9aae47136ebc59b7","modified":1563577524288},{"_id":"themes/next/source/images/cc-by-nd.svg","hash":"c563508ce9ced1e66948024ba1153400ac0e0621","modified":1563577524288},{"_id":"themes/next/source/images/cc-by-sa.svg","hash":"aa4742d733c8af8d38d4c183b8adbdcab045872e","modified":1563577524288},{"_id":"themes/next/source/images/cc-by.svg","hash":"28a0a4fe355a974a5e42f68031652b76798d4f7e","modified":1563577524288},{"_id":"themes/next/source/images/cc-zero.svg","hash":"87669bf8ac268a91d027a0a4802c92a1473e9030","modified":1563577524289},{"_id":"themes/next/source/images/favicon-16x16-next.png","hash":"5dad3320bff7f6c6859cf463c981d4151c079130","modified":1563673288820},{"_id":"themes/next/source/images/favicon-32x32-next.png","hash":"9557c4fbe0d885542ff02ad5e9a6b0f0c1c82822","modified":1563673302277},{"_id":"themes/next/source/images/heizi.jpeg","hash":"a964a09cc060d192ec28d63b12ceac0317b58ad1","modified":1563582447685},{"_id":"themes/next/source/images/logo.svg","hash":"d29cacbae1bdc4bbccb542107ee0524fe55ad6de","modified":1563577524289},{"_id":"themes/next/source/images/quote-l.svg","hash":"94e870b4c8c48da61d09522196d4dd40e277a98f","modified":1563577524289},{"_id":"themes/next/source/images/quote-r.svg","hash":"e60ae504f9d99b712c793c3740c6b100d057d4ec","modified":1563577524289},{"_id":"themes/next/source/js/affix.js","hash":"a2aab233d99297435a5274bf512c3c753fe08e80","modified":1563577524290},{"_id":"themes/next/source/js/algolia-search.js","hash":"1f7f10c579e7703d0f6acb8b73f3d78a07d0c623","modified":1563577524290},{"_id":"themes/next/source/js/exturl.js","hash":"54825acc8de4793feac415be227b965428f4e97d","modified":1563577524290},{"_id":"themes/next/source/js/js.cookie.js","hash":"e0afce539f1fb81d59e3c6f0a68d736e2fb45d93","modified":1563577524290},{"_id":"themes/next/source/js/motion.js","hash":"ca2965da47ba9fc5b0dde0a825c29e0817b965b9","modified":1563577524290},{"_id":"themes/next/source/js/next-boot.js","hash":"d673f486417eaf1925ffecc3c4720850cad2ada3","modified":1563577524290},{"_id":"themes/next/source/js/post-details.js","hash":"a614a3830f7dfcd4df303c1255d558a135b3854e","modified":1563577524291},{"_id":"themes/next/source/js/scroll-cookie.js","hash":"d07b3776708d4ae79ed2037c4c7391d5c9b06b19","modified":1563577524291},{"_id":"themes/next/source/js/scrollspy.js","hash":"fa3c92968bcdbcb8d95a1729f7659d9753cbd077","modified":1563577524291},{"_id":"themes/next/source/js/utils.js","hash":"c11f610e19fcbdb3d692bc5a17e43ef3338d81cc","modified":1563577524292},{"_id":"themes/next/source/lib/.DS_Store","hash":"f15228ab631d240ef4cc8d7ed7a36294e6b20a30","modified":1563673339263},{"_id":"themes/next/source/css/_mixins/Mist.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1563577524282},{"_id":"themes/next/source/css/_mixins/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1563577524282},{"_id":"themes/next/source/css/_variables/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1563577524286},{"_id":"themes/next/.git/refs/heads/master","hash":"30bce67afd5e7a948a501f6802298e059ad20cd2","modified":1563577524203},{"_id":"themes/next/layout/_macro/menu/menu-badge.swig","hash":"65c5e585982dae7ae1542cada71858b4ea1f73d6","modified":1563577524230},{"_id":"themes/next/layout/_macro/menu/menu-item.swig","hash":"9257da95bd032bb3bd1da670e302fd2c7d5610b6","modified":1563577524230},{"_id":"themes/next/layout/_partials/head/external-fonts.swig","hash":"fc6bafc8c633afadc538c5afa5620ea2a1cdcb84","modified":1563577524232},{"_id":"themes/next/layout/_partials/head/head-unique.swig","hash":"02bb5748e8540b024e7f4008a9e640890b45280f","modified":1563577524232},{"_id":"themes/next/layout/_partials/head/head.swig","hash":"3599602ec6bb1e2d26b355c2d2a709c2858c85db","modified":1563577524232},{"_id":"themes/next/layout/_partials/page/page-header.swig","hash":"2940df694fff28e8bf71b6546b4162f1e38227db","modified":1563577524233},{"_id":"themes/next/layout/_partials/header/brand.swig","hash":"dec2d88ba95a69ce2796015eb712f24ef34ad82a","modified":1563577524232},{"_id":"themes/next/layout/_partials/header/menu.swig","hash":"71af31fea5913fd30c233e555ef13cf2c9768f72","modified":1563577524233},{"_id":"themes/next/layout/_partials/page/breadcrumb.swig","hash":"0fa4fadb39467b01cede49f21b22e86b1a2da805","modified":1563577524233},{"_id":"themes/next/layout/_partials/header/index.swig","hash":"7e3d5b40a8e13ce3bb5f28cb23f62c10c2bf14dd","modified":1563577524232},{"_id":"themes/next/layout/_partials/header/sub-menu.swig","hash":"5adc60100e129c1d0307bdcaa0c7b8e8375a6ea4","modified":1563577524233},{"_id":"themes/next/layout/_partials/post/post-copyright.swig","hash":"3615db591dd910fb9fa96542734c7ec0ef05019c","modified":1563577524234},{"_id":"themes/next/layout/_partials/post/wechat-subscriber.swig","hash":"ef11b5be5bfb2f0affe82cf521c002b37fef9819","modified":1563577524235},{"_id":"themes/next/layout/_partials/post/post-related.swig","hash":"eea95b785c9c36d28e1839619793f66e89773bee","modified":1563577524234},{"_id":"themes/next/layout/_partials/post/reward.swig","hash":"d44f025eb93c99ddf90202d8293ccf80689a00c7","modified":1563577524234},{"_id":"themes/next/layout/_partials/share/add-this.swig","hash":"15b542f5b06b7532234af367340b9ed9fcebb0ac","modified":1563577524236},{"_id":"themes/next/layout/_partials/search/index.swig","hash":"7d1693416a5dc098f4723a53da2e2d1fc2d6e075","modified":1563577524235},{"_id":"themes/next/layout/_partials/share/likely.swig","hash":"06cafe19f0e307ef7ad54038ae76b8db6bb5b4f9","modified":1563577524236},{"_id":"themes/next/layout/_partials/search/algolia-search.swig","hash":"d9fe715fee716f78c7976c4e8838da71439ee0e0","modified":1563577524235},{"_id":"themes/next/layout/_third-party/analytics/analytics-with-widget.swig","hash":"a5723950c343d220270bfd27bd30050eda6c3fb3","modified":1563577524238},{"_id":"themes/next/layout/_partials/search/swiftype.swig","hash":"a5587bd1f60d35e58618576cec45e662aa44ea1f","modified":1563577524236},{"_id":"themes/next/layout/_partials/search/localsearch.swig","hash":"957701729b85fb0c5bfcf2fb99c19d54582f91ed","modified":1563577524235},{"_id":"themes/next/layout/_partials/sidebar/site-overview.swig","hash":"4992f1572e560a418b70c10764a95ec827a1a7b3","modified":1563577524236},{"_id":"themes/next/layout/_third-party/analytics/application-insights.swig","hash":"798d67e4a736613ab899eabe6529091bbcda7850","modified":1563577524239},{"_id":"themes/next/layout/_third-party/analytics/cnzz-analytics.swig","hash":"08cd47ef8572121b7811342d3c9a84a338a18191","modified":1563577524239},{"_id":"themes/next/layout/_third-party/analytics/busuanzi-counter.swig","hash":"8eadb929c9e50e58502ccad2dc2657746f8c592a","modified":1563577524239},{"_id":"themes/next/layout/_third-party/analytics/baidu-analytics.swig","hash":"591b2ccd9713ccb922b9fcf5e278b6de9c5ec30b","modified":1563577524239},{"_id":"themes/next/layout/_third-party/analytics/firestore.swig","hash":"fae69a0e1a1d42f7bb44e594a29857d94594698b","modified":1563577524239},{"_id":"themes/next/layout/_third-party/analytics/facebook-sdk.swig","hash":"3d01fa6edc0ad73f81813613f2e8a610777f1852","modified":1563577524239},{"_id":"themes/next/layout/_third-party/analytics/growingio.swig","hash":"4a966b7ffe2d80ff1b3dd0fd14b355766dc5c70f","modified":1563577524240},{"_id":"themes/next/layout/_third-party/analytics/google-analytics.swig","hash":"9fa1ca7059243197d8fbbd35108c36629a254570","modified":1563577524239},{"_id":"themes/next/layout/_third-party/analytics/lean-analytics.swig","hash":"a09d2af2a8470555eeb265b0eb14dc678079e870","modified":1563577524240},{"_id":"themes/next/layout/_third-party/analytics/index.swig","hash":"438c6f5e6665d72f4ea7ee206011d669246f6102","modified":1563577524240},{"_id":"themes/next/layout/_third-party/analytics/tencent-analytics.swig","hash":"f240a50cd9b627620d9a374a29cf95f0c5e99d7c","modified":1563577524240},{"_id":"themes/next/layout/_third-party/analytics/tencent-mta.swig","hash":"92e04a2b9e0c3df594bc22235d1894e5ad458dfc","modified":1563577524240},{"_id":"themes/next/layout/_third-party/analytics/vkontakte-api.swig","hash":"0dd5b315d1da55dbfc10f51a1f8952f72eba2720","modified":1563577524240},{"_id":"themes/next/layout/_third-party/comments/changyan.swig","hash":"3533167c4295637b91d90f3bae7c651cd128bb6e","modified":1563577524241},{"_id":"themes/next/layout/_third-party/comments/disqusjs.swig","hash":"074a995cd630f56fc4a3135173515c86f2cb34b6","modified":1563577524241},{"_id":"themes/next/layout/_third-party/comments/disqus.swig","hash":"1a00b1b78c429721d6477c2d8f6f68f005285cc8","modified":1563577524241},{"_id":"themes/next/layout/_third-party/comments/gitalk.swig","hash":"91952690ff40997fac16c46ef4986ce4053771c5","modified":1563583236485},{"_id":"themes/next/layout/_third-party/comments/index.swig","hash":"8b7e545644650fc36a335b8c52c7556bccec903f","modified":1563584309314},{"_id":"themes/next/layout/_third-party/comments/valine.swig","hash":"15a4d60d3ecc59db2f23629477f8e7b8324981ed","modified":1563577524242},{"_id":"themes/next/layout/_third-party/comments/livere.swig","hash":"40bab84a4a7a368fa31f0f8ce49af6ec3e5983c9","modified":1563577524242},{"_id":"themes/next/layout/_third-party/math/index.swig","hash":"a7e304b05a44279d3e4f611908d7faef9dc14d7c","modified":1563577524242},{"_id":"themes/next/layout/_third-party/math/katex.swig","hash":"c2cb2f384bc30d31cdccf9794a729c03e687b45c","modified":1563577524242},{"_id":"themes/next/layout/_third-party/math/mathjax.swig","hash":"601774d8672577aefbcefac82c94b01f0338da31","modified":1563577524242},{"_id":"themes/next/layout/_third-party/search/algolia-search.swig","hash":"0a13dfd2de52a96901039098c6fc7b515edfc50b","modified":1563577524244},{"_id":"themes/next/layout/_third-party/search/index.swig","hash":"ea94aa85034c6d1b6bb865aecea55c73f8a14501","modified":1563577524244},{"_id":"themes/next/layout/_third-party/search/localsearch.swig","hash":"b3eaab6a269aa3fcbafe24fd06f0c9206dc12716","modified":1563577524244},{"_id":"themes/next/layout/_scripts/pages/post-details.swig","hash":"5b05f165547391bf231e52f56f3d925efc09bc44","modified":1563577524237},{"_id":"themes/next/layout/_scripts/schemes/gemini.swig","hash":"ffc8e8836714ea79abeb77b75859634615652877","modified":1563577524237},{"_id":"themes/next/layout/_scripts/schemes/mist.swig","hash":"108b157fbd1ac3baaf19ae87234fa8728ab79556","modified":1563577524237},{"_id":"themes/next/layout/_scripts/schemes/muse.swig","hash":"0097e45e7b671f8006b8b2d3c4f95cacc76a983c","modified":1563577524238},{"_id":"themes/next/layout/_scripts/schemes/pisces.swig","hash":"e42604fbb17648484e5f12afe230d826de089388","modified":1563577524238},{"_id":"themes/next/source/css/_mixins/Gemini.styl","hash":"2aa5b7166a85a8aa34b17792ae4f58a5a96df6cc","modified":1563577524282},{"_id":"themes/next/source/css/_mixins/Pisces.styl","hash":"2e8fb29aa92325df39054b5450757858c6cebc41","modified":1563577524282},{"_id":"themes/next/source/css/_mixins/base.styl","hash":"4056cf687cf435697afe569caf3954b04ae277c9","modified":1563577524282},{"_id":"themes/next/source/css/_variables/Gemini.styl","hash":"a8aa41625b94cf17a7f473ed10dcbe683b1db705","modified":1563577524286},{"_id":"themes/next/source/css/_variables/Mist.styl","hash":"be087dcc060e8179f7e7f60ab4feb65817bd3d9f","modified":1563577524286},{"_id":"themes/next/source/css/_variables/Pisces.styl","hash":"fc15e277d1504532a09b7b1bd31f900ad95ec4b8","modified":1563577524286},{"_id":"themes/next/source/css/_variables/base.styl","hash":"640f25a63770af5566ccc9cec79c40a4f1c0b29e","modified":1563577524287},{"_id":"themes/next/source/js/schemes/pisces.js","hash":"9eb63cba0327d3d11b6cbfcbe40b88e97a8378a3","modified":1563577524291},{"_id":"themes/next/source/js/schemes/muse.js","hash":"d6e4d1c937387d0d7891a41305ecdfe5597d6136","modified":1563577524291},{"_id":"themes/next/source/lib/fancybox/.gitignore","hash":"7ca689ee76b1ec3f8b20acdfae66dc26d6daa935","modified":1552331228000},{"_id":"themes/next/source/lib/font-awesome/.bower.json","hash":"a2aaaf12378db56bd10596ba3daae30950eac051","modified":1563577524292},{"_id":"themes/next/source/lib/font-awesome/.gitignore","hash":"69d152fa46b517141ec3b1114dd6134724494d83","modified":1563577524292},{"_id":"themes/next/source/lib/font-awesome/HELP-US-OUT.txt","hash":"4f7bf961f1bed448f6ba99aeb9219fabf930ba96","modified":1563577524293},{"_id":"themes/next/source/lib/font-awesome/.npmignore","hash":"dcf470ab3a358103bb896a539cc03caeda10fa8b","modified":1563577524292},{"_id":"themes/next/source/lib/font-awesome/bower.json","hash":"279a8a718ab6c930a67c41237f0aac166c1b9440","modified":1563577524293},{"_id":"themes/next/source/lib/lazyload/lozad.min.js","hash":"c6a52bd23da771a44ed2cd2884aad30c91fa6345","modified":499162500000},{"_id":"themes/next/source/lib/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1563577524298},{"_id":"themes/next/source/lib/velocity/velocity.ui.js","hash":"6a1d101eab3de87527bb54fcc8c7b36b79d8f0df","modified":1563577524299},{"_id":"themes/next/source/lib/velocity/velocity.ui.min.js","hash":"ed5e534cd680a25d8d14429af824f38a2c7d9908","modified":1563577524299},{"_id":"themes/next/source/lib/jquery/index.js","hash":"88523924351bac0b5d560fe0c5781e2556e7693d","modified":1563577524297},{"_id":"themes/next/.git/refs/remotes/origin/HEAD","hash":"d9427cda09aba1cdde5c69c2b13c905bddb0bc51","modified":1563577524202},{"_id":"themes/next/.git/logs/refs/heads/master","hash":"63c32362ddf7fd8a39eb4ba0654bbfc26f59c71b","modified":1563577524203},{"_id":"themes/next/source/css/_common/components/back-to-top-sidebar.styl","hash":"fe5ff961b86004a306778c7d33a85b32e5e00e48","modified":1563577524251},{"_id":"themes/next/source/css/_common/components/back-to-top.styl","hash":"c8b3225396cb444d8baeb94bac78e5216b992a81","modified":1563577524251},{"_id":"themes/next/source/css/_common/components/buttons.styl","hash":"b98c65006e2546fbf3870c16fbbcbc009dbaab15","modified":1563577524251},{"_id":"themes/next/source/css/_common/components/comments.styl","hash":"471f1627891aca5c0e1973e09fbcb01e1510d193","modified":1563577524252},{"_id":"themes/next/source/css/_common/components/gitalk.styl","hash":"e6d4bdee6183fba28264d34b976dad9a92d8dfba","modified":1563584172177},{"_id":"themes/next/source/css/_common/components/components.styl","hash":"9d71f34fa13a41b8c8cd2fbdf3fdea608385277c","modified":1563577524252},{"_id":"themes/next/source/css/_common/components/pagination.styl","hash":"ce826aedf42b9eca424a044452f5d193866726a6","modified":1563577524265},{"_id":"themes/next/source/css/_common/components/scrollbar.styl","hash":"d7b8bcf2a6031296c84bb4f4ecfb037af01d2d82","modified":1563577524276},{"_id":"themes/next/source/css/_common/components/rainbow.styl","hash":"4741d642f9ed2eec9be23112f7a51645e77e41f3","modified":1563577524275},{"_id":"themes/next/source/css/_common/outline/outline.styl","hash":"7e51ea64611ab5d678c112b4688d4db4fd2737e2","modified":1563577524280},{"_id":"themes/next/source/css/_common/scaffolding/base.styl","hash":"6d900b4159eeb869196a619602578bf4d83a117b","modified":1563577524281},{"_id":"themes/next/source/css/_common/scaffolding/helpers.styl","hash":"8e0740a9ad349ce5555122325da872923135a698","modified":1563577524281},{"_id":"themes/next/source/css/_common/scaffolding/mobile.styl","hash":"773f6d791f938ff037783004369092991d7bcd31","modified":1563577524281},{"_id":"themes/next/source/css/_common/scaffolding/tables.styl","hash":"33456264a74d1bba38264d14713544d67d003733","modified":1563577524281},{"_id":"themes/next/source/css/_common/scaffolding/scaffolding.styl","hash":"a280a583b7615e939aaddbf778f5c108ef8a2a6c","modified":1563577524281},{"_id":"themes/next/source/css/_common/scaffolding/normalize.styl","hash":"7ffde343bdf10add1f052f3c4308a15180eb4404","modified":1563577524281},{"_id":"themes/next/source/css/_schemes/Gemini/index.styl","hash":"1489ff40ce5f9fee81a7b4aa5ef56a864a481a63","modified":1563577524282},{"_id":"themes/next/source/css/_schemes/Mist/_header.styl","hash":"24230e46fc9fb7b8551f97bb36e9bc1f7423098e","modified":1563577524283},{"_id":"themes/next/source/css/_schemes/Mist/_logo.styl","hash":"38e5df90c8689a71c978fd83ba74af3d4e4e5386","modified":1563577524283},{"_id":"themes/next/source/css/_schemes/Mist/_menu.styl","hash":"75d2d92af070eb10273558b2436972d3f12b361c","modified":1563577524283},{"_id":"themes/next/source/css/_schemes/Mist/_posts-expanded.styl","hash":"213f2178dc260a28cba4fef723827a6e707f91a3","modified":1563577524283},{"_id":"themes/next/source/css/_schemes/Mist/_search.styl","hash":"7359880e8d85312861fe0871f58b662e627dae0c","modified":1563577524283},{"_id":"themes/next/source/css/_schemes/Mist/_base.styl","hash":"0bef9f0dc134215bc4d0984ba3a16a1a0b6f87ec","modified":1563577524282},{"_id":"themes/next/source/css/_schemes/Mist/index.styl","hash":"3948894201e6229a66bcf490e451f2481c8a99cb","modified":1563577524283},{"_id":"themes/next/source/css/_schemes/Pisces/_menu.styl","hash":"2f782305b1e1d19197a90f1e5e9167fd77749a8e","modified":1563577524285},{"_id":"themes/next/source/css/_schemes/Pisces/_brand.styl","hash":"57044a6d19eb418c1c3d28787e82c69efa9e0ca6","modified":1563577524285},{"_id":"themes/next/source/css/_schemes/Pisces/_layout.styl","hash":"75737591682a2bafa71db4c03fb79e970ac0e7aa","modified":1563577524285},{"_id":"themes/next/source/css/_schemes/Pisces/_sidebar.styl","hash":"44d834c231e2bb57851954d73e70f6995b5929e7","modified":1563577524285},{"_id":"themes/next/source/css/_schemes/Pisces/_sub-menu.styl","hash":"6f427a43550f7b03c503106767fbcce1f18a4f78","modified":1563577524286},{"_id":"themes/next/source/css/_schemes/Muse/_layout.styl","hash":"6565b4a309325596768d0d32e022c80ef23066cb","modified":1563577524284},{"_id":"themes/next/source/css/_schemes/Pisces/index.styl","hash":"232aedbd44243b3b80c4503c947060d3269c1afc","modified":1563577524286},{"_id":"themes/next/source/css/_schemes/Muse/_menu.styl","hash":"1edf4e69d0ec0dc9cefed6c35d3e803e0da4093d","modified":1563577524284},{"_id":"themes/next/source/css/_schemes/Muse/_search.styl","hash":"7359880e8d85312861fe0871f58b662e627dae0c","modified":1563577524284},{"_id":"themes/next/source/css/_schemes/Muse/index.styl","hash":"dfd7a9cf39a2135de4cf2f8651cac3fb333d028f","modified":1563577524284},{"_id":"themes/next/source/css/_schemes/Muse/_logo.styl","hash":"fc160583f742c94316a0fee05c18468033173534","modified":1563577524284},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1488296781000},{"_id":"themes/next/source/lib/fancybox/source/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1488296781000},{"_id":"themes/next/source/lib/fancybox/source/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1488296781000},{"_id":"themes/next/source/lib/fancybox/source/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1488296781000},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1488296781000},{"_id":"themes/next/source/lib/fancybox/source/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1488296781000},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.css","hash":"67e4f3cee1a670bd6905f11aac5cfc10de159e6b","modified":1488296781000},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.js","hash":"e029ec8e8c510a7efec79df463d807246e5eaa98","modified":1488296781000},{"_id":"themes/next/source/lib/fancybox/source/jquery.fancybox.pack.js","hash":"3ac24755c93c080990348fb9301dbbbb5fdbcab6","modified":1488296781000},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css","hash":"0140952c64e3f2b74ef64e050f2fe86eab6624c8","modified":1563577524293},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.css.map","hash":"0189d278706509412bac4745f96c83984e1d59f4","modified":1563577524293},{"_id":"themes/next/source/lib/font-awesome/css/font-awesome.min.css","hash":"512c7d79033e3028a9be61b540cf1a6870c896f8","modified":1563577524294},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff","hash":"28b782240b3e76db824e12c02754a9731a167527","modified":1563577524296},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.woff2","hash":"d6f48cba7d076fb6f2fd6ba993a75b9dc1ecbf0c","modified":1563577524296},{"_id":"themes/next/.git/logs/refs/remotes/origin/HEAD","hash":"63c32362ddf7fd8a39eb4ba0654bbfc26f59c71b","modified":1563577524202},{"_id":"themes/next/.git/objects/pack/pack-adb0508b45ff3c327a982e5538f6f97d50aa789e.idx","hash":"0b18343b9ea938f3d05d7ae13fb116dac7f373e8","modified":1563577524190},{"_id":"themes/next/source/lib/velocity/velocity.js","hash":"9f08181baea0cc0e906703b7e5df9111b9ef3373","modified":1563577524298},{"_id":"themes/next/source/css/_common/components/header/github-banner.styl","hash":"ca97f0b6990eef947039faede80c56d9c4381ee1","modified":1563577524252},{"_id":"themes/next/source/css/_common/components/footer/footer.styl","hash":"4cfeec9434a72d5efc6ca225d3445d084d4590f7","modified":1563577524252},{"_id":"themes/next/source/css/_common/components/header/header.styl","hash":"6c4990d375b640ee4551e62c48c1cbe4c3d62212","modified":1563577524253},{"_id":"themes/next/source/css/_common/components/header/headerband.styl","hash":"d27448f199fc2f9980b601bc22b87f08b5d64dd1","modified":1563577524254},{"_id":"themes/next/source/css/_common/components/header/menu.styl","hash":"a410ed529afd46ddf4a96ecf0de6599488716887","modified":1563577524256},{"_id":"themes/next/source/css/_common/components/header/site-meta.styl","hash":"c0d9e18a9210fdcaf33e488518b3b288eb58c0a1","modified":1563577524257},{"_id":"themes/next/source/css/_common/components/header/site-nav.styl","hash":"cc6ee18f47f2e1e06df6fa0eadb37079e580fd11","modified":1563577524257},{"_id":"themes/next/source/css/_common/components/highlight/copy-code.styl","hash":"24d366f13f4af294ee929819713146e0a885706e","modified":1563577524258},{"_id":"themes/next/source/css/_common/components/highlight/diff.styl","hash":"4114f1aa7546bbdf8253e261061c9d9bb0ca6c39","modified":1563577524258},{"_id":"themes/next/source/css/_common/components/highlight/highlight.styl","hash":"a690d4aba571b08c029a168e12cef2bbfd27a1ae","modified":1563577524259},{"_id":"themes/next/source/css/_common/components/highlight/theme.styl","hash":"ba17bf993d3e6a4aed02e740e3a4b913d9e7409d","modified":1563577524259},{"_id":"themes/next/source/css/_common/components/pages/breadcrumb.styl","hash":"f2469ecf57eeb32f5ad0a26c7358e521383ac935","modified":1563577524261},{"_id":"themes/next/source/css/_common/components/pages/archive.styl","hash":"6904fd7ea6455e008d9884558b68254608af9a3c","modified":1563577524260},{"_id":"themes/next/source/css/_common/components/pages/categories.styl","hash":"e3124da5350d6c01f32ccd04134a686baa4fb30a","modified":1563577524261},{"_id":"themes/next/source/css/_common/components/pages/pages.styl","hash":"f1d52954b9a5d1ca8e224382349f525e598dd923","modified":1563577524262},{"_id":"themes/next/source/css/_common/components/pages/post-detail.styl","hash":"9bf4362a4d0ae151ada84b219d39fbe5bb8c790e","modified":1563577524262},{"_id":"themes/next/source/css/_common/components/pages/schedule.styl","hash":"9df791fa842b16ae72ad2998ffc2f87fdf0b6a88","modified":1563577524263},{"_id":"themes/next/source/css/_common/components/pages/tag-cloud.styl","hash":"61ca40856e5cacd48e0fa9728fde4605c7dd4c94","modified":1563577524263},{"_id":"themes/next/source/css/_common/components/post/post-collapse.styl","hash":"8bffc9f7f4b20860a56160f0d1ba77062106f990","modified":1563577524267},{"_id":"themes/next/source/css/_common/components/post/post-button.styl","hash":"e72a89e0f421444453e149ba32c77a64bd8e44e8","modified":1563577524267},{"_id":"themes/next/source/css/_common/components/post/post-copyright.styl","hash":"2356226157e8068b0e9bbe2f7d0f74e1ab49199b","modified":1563577524268},{"_id":"themes/next/source/css/_common/components/post/post-eof.styl","hash":"c961d37190d9bec58a36306c7e716c4e72c4582f","modified":1563577524268},{"_id":"themes/next/source/css/_common/components/post/post-gallery.styl","hash":"0bf899fab331add63f0c8ead31ca3a3db2ad74d9","modified":1563577524268},{"_id":"themes/next/source/css/_common/components/post/post-expand.styl","hash":"df3c19fd447da6d4a807683345007a41338f9a04","modified":1563577524268},{"_id":"themes/next/source/css/_common/components/post/post-meta.styl","hash":"67165cd8836e03c289162b96ef06f8b024afe9af","modified":1563577524269},{"_id":"themes/next/source/css/_common/components/post/post-nav.styl","hash":"496f931e3a7e313ba8088fb91bb20789cace72c9","modified":1563577524269},{"_id":"themes/next/source/css/_common/components/post/post-reading_progress.styl","hash":"3f33bb862c2aa993f54987fbb345da067b79b112","modified":1563577524270},{"_id":"themes/next/source/css/_common/components/post/post-reward.styl","hash":"5440013a081201ca791582db98159dce93ea9e75","modified":1563577524270},{"_id":"themes/next/source/css/_common/components/post/post-rtl.styl","hash":"017074ef58166e2d69c53bb7590a0e7a8947a1ed","modified":1563577524271},{"_id":"themes/next/source/css/_common/components/post/post-tags.styl","hash":"a352ae5b1f8857393bf770d2e638bf15f0c9585d","modified":1563577524271},{"_id":"themes/next/source/css/_common/components/post/post-type.styl","hash":"d5c8ffed7f2c701052b7a53abaf5ef437374ea72","modified":1563577524272},{"_id":"themes/next/source/css/_common/components/post/post-widgets.styl","hash":"a6c24393dffbdd94dd5c01cdbec5e180b0bfbbbd","modified":1563577524273},{"_id":"themes/next/source/css/_common/components/post/post-title.styl","hash":"8e058c99dd7d41f0bd34c7c28b6ac9fbb17dcb5e","modified":1563577524272},{"_id":"themes/next/source/css/_common/components/post/post.styl","hash":"9c60fd1c4d221b968a5b1129f41e6d62adac1730","modified":1563577524274},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-author-links.styl","hash":"3d55c8641a69449de7caf1ea2cf731973481daf5","modified":1563577524276},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-author.styl","hash":"965a4896925f4c2bfdb492e1923288c91b854f2d","modified":1563577524276},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-blogroll.styl","hash":"cc83816614f21c7e1d8d3f867d547ff7c658cec4","modified":1563577524277},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-button.styl","hash":"517d541a80d59ad99a3f648be74891e0c7bc72a8","modified":1563577524277},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-dimmer.styl","hash":"987f1cdd57dd9f6f81c133c280c20d7168c37d7f","modified":1563577524277},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-nav.styl","hash":"9a3bfc878ca797946815bed23cd6f92b24a16358","modified":1563577524277},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-toc.styl","hash":"8a24b56524a388fbabd408ffc8ba9b56eb9e01ce","modified":1563577524277},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-toggle.styl","hash":"4a655ce8217e038b4b9df2265555feae9ccd6242","modified":1563577524277},{"_id":"themes/next/source/css/_common/components/sidebar/site-state.styl","hash":"967fb3a3c6c851b34ec5df2d945dc266ed63d146","modified":1563577524278},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar.styl","hash":"38314eec8f4a2d1667e1061d7a3deb1c16f17da9","modified":1563577524278},{"_id":"themes/next/source/css/_common/components/tags/blockquote-center.styl","hash":"58ec00eebe68d0eebd2eea435c710063877447df","modified":1563577524278},{"_id":"themes/next/source/css/_common/components/tags/full-image.styl","hash":"6ec8ea7b11a146777b6b8da0f71f0cc1dbd129df","modified":1563577524278},{"_id":"themes/next/source/css/_common/components/tags/group-pictures.styl","hash":"c85df3ecc0b37095cac14114c308e5829c66b5a3","modified":1563577524278},{"_id":"themes/next/source/css/_common/components/tags/label.styl","hash":"d7501ae01fc45fa15b00d1bc5233b9fffa20a3c9","modified":1563577524278},{"_id":"themes/next/source/css/_common/components/tags/note.styl","hash":"ca7cd57bc346a3fda8097b2b49e6d943600912d2","modified":1563577524279},{"_id":"themes/next/source/css/_common/components/tags/tabs.styl","hash":"4b62818333d2463fe416fb3156ced12e7d60aafa","modified":1563577524279},{"_id":"themes/next/source/css/_common/components/tags/pdf.styl","hash":"da8d34729fb6eb0fcb8ee81e67d2be3c02bc1bc4","modified":1563577524279},{"_id":"themes/next/source/css/_common/components/tags/tags.styl","hash":"cbc0be5a3285b469858ec9ead48e2ea90bd47ae1","modified":1563577524279},{"_id":"themes/next/source/css/_common/components/third-party/algolia-search.styl","hash":"fc58498d4f5081fcf6218e9e18c5bf2328275bef","modified":1563577524279},{"_id":"themes/next/source/css/_common/components/third-party/gitalk.styl","hash":"1156b11ac74d2d21b1b5047767b2a9edafc9182d","modified":1563577524279},{"_id":"themes/next/source/css/_common/components/third-party/localsearch.styl","hash":"9fac89c8146eb2675721a26f528d7d0f8be7debe","modified":1563577524280},{"_id":"themes/next/source/css/_common/components/third-party/math.styl","hash":"ef66c0a08e4243a25e41408d70ca66682b8dcea1","modified":1563577524280},{"_id":"themes/next/source/css/_common/components/third-party/needsharebutton.styl","hash":"61466e3e5459960b5802a267751a0c8018918b0b","modified":1563577524280},{"_id":"themes/next/source/css/_common/components/third-party/related-posts.styl","hash":"3ae3f3c276d444862033fd3434c632ad0d2f84e6","modified":1563577524280},{"_id":"themes/next/source/css/_common/components/third-party/third-party.styl","hash":"616f4820306dc0b6346cda3d2094a0af5ade4fba","modified":1563577524280},{"_id":"themes/next/source/css/_schemes/Mist/outline/outline.styl","hash":"5dc4859c66305f871e56cba78f64bfe3bf1b5f01","modified":1563577524284},{"_id":"themes/next/source/css/_schemes/Muse/sidebar/_sidebar.styl","hash":"487dbb5b389620e7be2ce666531a7baa249d50a0","modified":1563577524285},{"_id":"themes/next/source/css/_schemes/Muse/sidebar/sidebar-blogroll.styl","hash":"817587e46df49e819858c8ecbafa08b53d5ff040","modified":1563577524285},{"_id":"themes/next/source/lib/fancybox/.github/ISSUE_TEMPLATE/bug_report.md","hash":"83d211c67c12e8c1f6e9f796cfd0cecbf5160e15","modified":1552331228000},{"_id":"themes/next/source/lib/fancybox/.github/ISSUE_TEMPLATE/feature_request.md","hash":"f6867a2f0417fe89a0f2008730ee19dd38422021","modified":1552331228000},{"_id":"themes/next/source/lib/fancybox/.github/ISSUE_TEMPLATE/question.md","hash":"b2c7bf433a6b94f3daa3b54b8c92c6cf93c15557","modified":1552331228000},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.css","hash":"4310a88abe2e05cc3d0bfc30f57be6b1395547ef","modified":1488296781000},{"_id":"themes/next/source/lib/fancybox/source/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1488296781000},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-buttons.js","hash":"dc3645529a4bf72983a39fa34c1eb9146e082019","modified":1488296781000},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-media.js","hash":"b861d5c645b8b6f98757b973e72da1c7e7198c9c","modified":1488296781000},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.css","hash":"4ac329c16a5277592fc12a37cca3d72ca4ec292f","modified":1488296781000},{"_id":"themes/next/source/lib/fancybox/source/helpers/jquery.fancybox-thumbs.js","hash":"3d695e257e61f4cbe57adda99eb01b13785f9929","modified":1488296781000},{"_id":"themes/next/source/lib/font-awesome/fonts/fontawesome-webfont.eot","hash":"d980c2ce873dc43af460d4d572d441304499f400","modified":1563577524295},{"_id":"themes/next/.git/objects/pack/pack-adb0508b45ff3c327a982e5538f6f97d50aa789e.pack","hash":"75b0de48168d10f18c502789461a3a04de86bd46","modified":1563577524184},{"_id":"public/search.xml","hash":"eaedab4c21fc4d321231b25349e0afc9a05f56c2","modified":1563685533328},{"_id":"public/about/index.html","hash":"016a0ba2a9206bb3123fd6d6afb9eef7a0489096","modified":1563685533655},{"_id":"public/tags/index.html","hash":"e7124106ca566066940dc9078b320534a3e0291b","modified":1563685533655},{"_id":"public/categories/index.html","hash":"afa4c84452b61b766f143b4e5722ebddca264f7c","modified":1563685533658},{"_id":"public/2019/07/21/hello-world/index.html","hash":"357f9067f580f0ce00093e6e250bff5bed635b46","modified":1563685533659},{"_id":"public/2016/07/25/enq-TM-1/index.html","hash":"31b70caa72d3e238dc82134e47d4514a4476d5b9","modified":1563684746645},{"_id":"public/archives/index.html","hash":"4f408a6ef712dab61a2e3b9af373ae29a3452896","modified":1563685533659},{"_id":"public/archives/2016/index.html","hash":"051ba6f7ff01978b44d5f697e065cc1e246dbbec","modified":1563685533660},{"_id":"public/archives/2016/07/index.html","hash":"25b0f89a117677709974f7e439afec603ace097a","modified":1563685533660},{"_id":"public/archives/2019/index.html","hash":"3182caeed5d622f10d1868338d231608729556ce","modified":1563685533661},{"_id":"public/archives/2019/07/index.html","hash":"d316cf297d83198aa506fa6a86b488867ab24db8","modified":1563685533661},{"_id":"public/index.html","hash":"a339d46b290c8e1478a10c517f2ff13f6c69b1dd","modified":1563685533659},{"_id":"public/tags/oracle/index.html","hash":"f986f8e3737515d784b37e727b34a3a9e504758f","modified":1563685533661},{"_id":"public/tags/test/index.html","hash":"2376979bc5507c9577af176e02e58c33a068d0bf","modified":1563685533661},{"_id":"source/_posts/.DS_Store","hash":"f6b1b9677931a886f7738c2c380aa407431e4e41","modified":1563683844954},{"_id":"source/_posts/oracle/.DS_Store","hash":"b9e340052d018e9a2f6ecc43846d8d6159f93ab2","modified":1563685242649},{"_id":"source/_posts/oracle/backup-restore/RMAN-different-server-directory-full-restore.md","hash":"dd01c79511a577e6240293973597bfed54725171","modified":1563684966369},{"_id":"source/_posts/oracle/backup-restore/dbms_scheduler-for-rman-backup.md","hash":"e3e18dd9ecd59be11dc8f6903500cdad82bc9b5c","modified":1563684188312},{"_id":"public/2017/07/01/oracle/backup-restore/dbms_scheduler-for-rman-backup/index.html","hash":"ab99d05707d32c39b6a048f61c8faeeca27c594d","modified":1563685533659},{"_id":"public/2015/09/23/oracle/backup-restore/RMAN-different-server-directory-full-restore/index.html","hash":"49c36c1d8c0fc291d15b71f55098e2d990671360","modified":1563685533659},{"_id":"public/categories/oracle-backup/index.html","hash":"e0f7363e6f40f73e780e3dc6096e9fefabf946a7","modified":1563685533659},{"_id":"public/archives/2015/index.html","hash":"331d1246a6b2b2c29ba2256a831eef9b145dfb6c","modified":1563685533659},{"_id":"public/archives/2015/09/index.html","hash":"9cbfe52289541cbefc2ef53cf8d621d6abe00a13","modified":1563685533660},{"_id":"public/archives/2017/index.html","hash":"b8e7371077d2a7d376974d1a2bf46f6f9ade56aa","modified":1563685533661},{"_id":"public/archives/2017/07/index.html","hash":"1b8a288240fc75b8b90a8537d14eba7f2b7e96b8","modified":1563685533661},{"_id":"public/tags/oracle-backup/index.html","hash":"19d06ce0418d7d3b0c0bc1348717651120f59886","modified":1563685533661},{"_id":"source/_posts/oracle/backup-restore/.DS_Store","hash":"015a5a911044271d24229d262e6cb5dd671ef53f","modified":1563685242648},{"_id":"source/_posts/oracle/backup-restore/ORA-00600[13011].md","hash":"437f6ab1677ce8cf3695bb9d14d17fae27d97cd1","modified":1563684722799},{"_id":"public/2016/07/20/oracle/backup-restore/ORA-00600[13011]/index.html","hash":"904ffa15896d27b64e59d122b1daa311a3b80271","modified":1563685533659},{"_id":"public/categories/oracle-restore/index.html","hash":"d19345cd6c395c3a55697ef13bcdb4d6e3501f1c","modified":1563685533659},{"_id":"public/tags/oracle-restore/index.html","hash":"7ea618801e6d637635d630b807641b257902cf51","modified":1563685533661},{"_id":"source/_posts/oracle/architecture/ASSM2.md","hash":"36d7def5cc2f4ccf3c32463a29b697b876837989","modified":1563685434650},{"_id":"source/_posts/oracle/architecture/linux+oracle-compatibility-list.md","hash":"cdb17a71765360d3b1f8e90219878e011b0339c4","modified":1563685318585},{"_id":"source/_posts/oracle/architecture/.DS_Store","hash":"9891fc6f8dea9e07c5f103b4b9f3f0af2407a461","modified":1563685354771},{"_id":"source/_posts/oracle/lock-latch/enq-TM-1.md","hash":"f6841672f1437d8fb7c36a534915082a0394e82a","modified":1563685117300},{"_id":"source/_posts/oracle/architecture/ASSM1.md","hash":"f2a9ff08201028ca863a79e17d2853046b864663","modified":1563685486580},{"_id":"public/2016/07/25/oracle/lock-latch/enq-TM-1/index.html","hash":"0d07e6ae574b9ff63ecc1899261a5040d95d39c3","modified":1563685533669},{"_id":"public/2015/09/30/oracle/architecture/ASSM2/index.html","hash":"2278e661027570a43d8dc61df1c865b647c8611d","modified":1563685533670},{"_id":"public/2015/09/25/oracle/architecture/ASSM1/index.html","hash":"260c3201f908f9a619ae0cf8c7f4920cb607ccdb","modified":1563685533671},{"_id":"public/2014/07/22/oracle/architecture/linux+oracle-compatibility-list/index.html","hash":"4d7db2a821e175f1c31915fcfdae555839c3364d","modified":1563685533671},{"_id":"public/categories/oracle/index.html","hash":"38d25723890695fca024305a2141902b26393b3a","modified":1563685533672},{"_id":"public/archives/2014/index.html","hash":"f73ccea21650b7aa4c8be2fa00e00c8f3deba8ca","modified":1563685533672},{"_id":"public/archives/2014/07/index.html","hash":"13c3ba1c741b4aecc98c455615b600d372eae0f3","modified":1563685533672}],"Category":[{"name":"oracle backup","_id":"cjych78ij0002f40et03sp1am"},{"name":"oracle restore","_id":"cjychiv1c0001ix0epc19b6ta"},{"name":"oracle","_id":"cjychzpxf0002fn0ejgvyyu1f"}],"Data":[{"_id":"styles","data":""},{"_id":"footer","data":"<div class=\"footer-custom\">\nTheme source code <span class=\"exturl theme-link\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvaGV4by10aGVtZS1uZXh0\">here</span><br>\nWebsite source code <span class=\"exturl theme-link\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvdGhlbWUtbmV4dC5vcmc=\">here</span>\n</div>\n"}],"Page":[{"title":"about","date":"2019-07-21T01:26:26.000Z","comments":0,"_content":"\n> 简介\n\n\nOracle OCP，兔子先生，目前从事oracle DBA工作，在Oracle数据库领域具有深厚的理论基础、丰富的实践经验；曾参与过中国航天设备监控系统、易程股份铁科院运维管理平台、中国不锈钢统一清算交易平台 、江苏登记结算平台系统等项目，并从中担任数据库物理设计、逻辑设计、安装实施，备份迁移，性能调优，故障解决等数据库工作，以及应用系统的测试发布，系统日常运维脚本的编写等工作。\n\n> 个人说明\n\n\n热爱据库技术，在数据库管理领域有十分丰富的工作经验，在Oracle内核，性能调优，SQL调优方面有丰富的经验及见解；洞悉oracle体系结构、熟悉关系型数据库建模、在oracle性能优化、数据备份恢复、容灾系统建设、高可用架构搭建方面有丰富的经验和技术积累；熟悉数据库开发语言PL/SQL，脚本语言shell、php等。\n\n> 联系方式\n\n\n1. 电话：15716182113\n2. QQ： 676333678\n3. Email: 676333678@qq.com;liupzmin@gmail.com\n","source":"about/index.md","raw":"---\ntitle: about\ndate: 2019-07-21 09:26:26\ncomments: false\n---\n\n> 简介\n\n\nOracle OCP，兔子先生，目前从事oracle DBA工作，在Oracle数据库领域具有深厚的理论基础、丰富的实践经验；曾参与过中国航天设备监控系统、易程股份铁科院运维管理平台、中国不锈钢统一清算交易平台 、江苏登记结算平台系统等项目，并从中担任数据库物理设计、逻辑设计、安装实施，备份迁移，性能调优，故障解决等数据库工作，以及应用系统的测试发布，系统日常运维脚本的编写等工作。\n\n> 个人说明\n\n\n热爱据库技术，在数据库管理领域有十分丰富的工作经验，在Oracle内核，性能调优，SQL调优方面有丰富的经验及见解；洞悉oracle体系结构、熟悉关系型数据库建模、在oracle性能优化、数据备份恢复、容灾系统建设、高可用架构搭建方面有丰富的经验和技术积累；熟悉数据库开发语言PL/SQL，脚本语言shell、php等。\n\n> 联系方式\n\n\n1. 电话：15716182113\n2. QQ： 676333678\n3. Email: 676333678@qq.com;liupzmin@gmail.com\n","updated":"2019-07-21T01:51:47.246Z","path":"about/index.html","layout":"page","_id":"cjyceelqd0001e20ehcb1sxej","content":"<blockquote>\n<p>简介</p>\n</blockquote>\n<p>Oracle OCP，兔子先生，目前从事oracle DBA工作，在Oracle数据库领域具有深厚的理论基础、丰富的实践经验；曾参与过中国航天设备监控系统、易程股份铁科院运维管理平台、中国不锈钢统一清算交易平台 、江苏登记结算平台系统等项目，并从中担任数据库物理设计、逻辑设计、安装实施，备份迁移，性能调优，故障解决等数据库工作，以及应用系统的测试发布，系统日常运维脚本的编写等工作。</p>\n<blockquote>\n<p>个人说明</p>\n</blockquote>\n<p>热爱据库技术，在数据库管理领域有十分丰富的工作经验，在Oracle内核，性能调优，SQL调优方面有丰富的经验及见解；洞悉oracle体系结构、熟悉关系型数据库建模、在oracle性能优化、数据备份恢复、容灾系统建设、高可用架构搭建方面有丰富的经验和技术积累；熟悉数据库开发语言PL/SQL，脚本语言shell、php等。</p>\n<blockquote>\n<p>联系方式</p>\n</blockquote>\n<ol>\n<li>电话：15716182113</li>\n<li>QQ： 676333678</li>\n<li>Email: <span class=\"exturl\" data-url=\"bWFpbHRvOjY3NjMzMzY3OEBxcS5jb20=\" title=\"mailto:676333678@qq.com\">676333678@qq.com<i class=\"fa fa-external-link\"></i></span>;liupzmin@gmail.com</li>\n</ol>\n","site":{"data":{"styles":"","footer":"<div class=\"footer-custom\">\nTheme source code <span class=\"exturl theme-link\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvaGV4by10aGVtZS1uZXh0\">here</span><br>\nWebsite source code <span class=\"exturl theme-link\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvdGhlbWUtbmV4dC5vcmc=\">here</span>\n</div>\n"}},"excerpt":"","more":"<blockquote>\n<p>简介</p>\n</blockquote>\n<p>Oracle OCP，兔子先生，目前从事oracle DBA工作，在Oracle数据库领域具有深厚的理论基础、丰富的实践经验；曾参与过中国航天设备监控系统、易程股份铁科院运维管理平台、中国不锈钢统一清算交易平台 、江苏登记结算平台系统等项目，并从中担任数据库物理设计、逻辑设计、安装实施，备份迁移，性能调优，故障解决等数据库工作，以及应用系统的测试发布，系统日常运维脚本的编写等工作。</p>\n<blockquote>\n<p>个人说明</p>\n</blockquote>\n<p>热爱据库技术，在数据库管理领域有十分丰富的工作经验，在Oracle内核，性能调优，SQL调优方面有丰富的经验及见解；洞悉oracle体系结构、熟悉关系型数据库建模、在oracle性能优化、数据备份恢复、容灾系统建设、高可用架构搭建方面有丰富的经验和技术积累；熟悉数据库开发语言PL/SQL，脚本语言shell、php等。</p>\n<blockquote>\n<p>联系方式</p>\n</blockquote>\n<ol>\n<li>电话：15716182113</li>\n<li>QQ： 676333678</li>\n<li>Email: <span class=\"exturl\" data-url=\"bWFpbHRvOjY3NjMzMzY3OEBxcS5jb20=\" title=\"mailto:676333678@qq.com\">676333678@qq.com<i class=\"fa fa-external-link\"></i></span>;liupzmin@gmail.com</li>\n</ol>\n"},{"title":"所有标签","date":"2014-12-22T04:39:04.000Z","type":"tags","comments":0,"_content":"","source":"tags/index.md","raw":"---\ntitle: 所有标签\ndate: 2014-12-22 12:39:04\ntype: \"tags\"\ncomments: false\n---\n","updated":"2019-07-21T01:57:10.002Z","path":"tags/index.html","layout":"page","_id":"cjyceelsu0003e20ef2wmqeby","content":"","site":{"data":{"styles":"","footer":"<div class=\"footer-custom\">\nTheme source code <span class=\"exturl theme-link\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvaGV4by10aGVtZS1uZXh0\">here</span><br>\nWebsite source code <span class=\"exturl theme-link\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvdGhlbWUtbmV4dC5vcmc=\">here</span>\n</div>\n"}},"excerpt":"","more":""},{"title":"所有分类","date":"2019-07-21T01:27:53.000Z","type":"categories","comments":0,"_content":"","source":"categories/index.md","raw":"---\ntitle: 所有分类\ndate: 2019-07-21 09:27:53\ntype: \"categories\"\ncomments: false\n\n---\n","updated":"2019-07-21T01:56:39.043Z","path":"categories/index.html","layout":"page","_id":"cjyceelsx0005e20e0qily6r1","content":"","site":{"data":{"styles":"","footer":"<div class=\"footer-custom\">\nTheme source code <span class=\"exturl theme-link\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvaGV4by10aGVtZS1uZXh0\">here</span><br>\nWebsite source code <span class=\"exturl theme-link\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvdGhlbWUtbmV4dC5vcmc=\">here</span>\n</div>\n"}},"excerpt":"","more":""}],"Post":[{"title":"Hello World","_content":"Welcome to [Hexo](https://hexo.io/)! This is your very first post. Check [documentation](https://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](https://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues).\n\n## Quick Start\n\n### Create a new post\n\n``` bash\n$ hexo new \"My New Post\"\n```\n\nMore info: [Writing](https://hexo.io/docs/writing.html)\n\n### Run server\n\n``` bash\n$ hexo server\n```\n\nMore info: [Server](https://hexo.io/docs/server.html)\n\n### Generate static files\n\n``` bash\n$ hexo generate\n```\n\nMore info: [Generating](https://hexo.io/docs/generating.html)\n\n### Deploy to remote sites\n\n``` bash\n$ hexo deploy\n```\n\nMore info: [Deployment](https://hexo.io/docs/deployment.html)\n\n```go\nfunc Test(){\n  a := 1\n  fmt.printf(\"Hello GoLang!\")\n}\n```\n","source":"_posts/hello-world.md","raw":"---\ntitle: Hello World\ntags: test\n---\nWelcome to [Hexo](https://hexo.io/)! This is your very first post. Check [documentation](https://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](https://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues).\n\n## Quick Start\n\n### Create a new post\n\n``` bash\n$ hexo new \"My New Post\"\n```\n\nMore info: [Writing](https://hexo.io/docs/writing.html)\n\n### Run server\n\n``` bash\n$ hexo server\n```\n\nMore info: [Server](https://hexo.io/docs/server.html)\n\n### Generate static files\n\n``` bash\n$ hexo generate\n```\n\nMore info: [Generating](https://hexo.io/docs/generating.html)\n\n### Deploy to remote sites\n\n``` bash\n$ hexo deploy\n```\n\nMore info: [Deployment](https://hexo.io/docs/deployment.html)\n\n```go\nfunc Test(){\n  a := 1\n  fmt.printf(\"Hello GoLang!\")\n}\n```\n","slug":"hello-world","published":1,"date":"2019-07-21T01:59:50.721Z","updated":"2019-07-21T01:59:50.721Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjyceelss0002e20e6dp50an7","content":"<p>Welcome to <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvLw==\" title=\"https://hexo.io/\">Hexo<i class=\"fa fa-external-link\"></i></span>! This is your very first post. Check <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mv\" title=\"https://hexo.io/docs/\">documentation<i class=\"fa fa-external-link\"></i></span> for more info. If you get any problems when using Hexo, you can find the answer in <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3MvdHJvdWJsZXNob290aW5nLmh0bWw=\" title=\"https://hexo.io/docs/troubleshooting.html\">troubleshooting<i class=\"fa fa-external-link\"></i></span> or you can ask me on <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2hleG9qcy9oZXhvL2lzc3Vlcw==\" title=\"https://github.com/hexojs/hexo/issues\">GitHub<i class=\"fa fa-external-link\"></i></span>.</p>\n<h2 id=\"Quick-Start\"><a href=\"#Quick-Start\" class=\"headerlink\" title=\"Quick Start\"></a>Quick Start</h2><h3 id=\"Create-a-new-post\"><a href=\"#Create-a-new-post\" class=\"headerlink\" title=\"Create a new post\"></a>Create a new post</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">\"My New Post\"</span></span><br></pre></td></tr></table></figure>\n\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvd3JpdGluZy5odG1s\" title=\"https://hexo.io/docs/writing.html\">Writing<i class=\"fa fa-external-link\"></i></span></p>\n<h3 id=\"Run-server\"><a href=\"#Run-server\" class=\"headerlink\" title=\"Run server\"></a>Run server</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure>\n\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvc2VydmVyLmh0bWw=\" title=\"https://hexo.io/docs/server.html\">Server<i class=\"fa fa-external-link\"></i></span></p>\n<h3 id=\"Generate-static-files\"><a href=\"#Generate-static-files\" class=\"headerlink\" title=\"Generate static files\"></a>Generate static files</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></figure>\n\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3MvZ2VuZXJhdGluZy5odG1s\" title=\"https://hexo.io/docs/generating.html\">Generating<i class=\"fa fa-external-link\"></i></span></p>\n<h3 id=\"Deploy-to-remote-sites\"><a href=\"#Deploy-to-remote-sites\" class=\"headerlink\" title=\"Deploy to remote sites\"></a>Deploy to remote sites</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></figure>\n\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3MvZGVwbG95bWVudC5odG1s\" title=\"https://hexo.io/docs/deployment.html\">Deployment<i class=\"fa fa-external-link\"></i></span></p>\n<figure class=\"highlight go\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">Test</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  a := <span class=\"number\">1</span></span><br><span class=\"line\">  fmt.printf(<span class=\"string\">\"Hello GoLang!\"</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","site":{"data":{"styles":"","footer":"<div class=\"footer-custom\">\nTheme source code <span class=\"exturl theme-link\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvaGV4by10aGVtZS1uZXh0\">here</span><br>\nWebsite source code <span class=\"exturl theme-link\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvdGhlbWUtbmV4dC5vcmc=\">here</span>\n</div>\n"}},"excerpt":"","more":"<p>Welcome to <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvLw==\" title=\"https://hexo.io/\">Hexo<i class=\"fa fa-external-link\"></i></span>! This is your very first post. Check <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mv\" title=\"https://hexo.io/docs/\">documentation<i class=\"fa fa-external-link\"></i></span> for more info. If you get any problems when using Hexo, you can find the answer in <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3MvdHJvdWJsZXNob290aW5nLmh0bWw=\" title=\"https://hexo.io/docs/troubleshooting.html\">troubleshooting<i class=\"fa fa-external-link\"></i></span> or you can ask me on <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2hleG9qcy9oZXhvL2lzc3Vlcw==\" title=\"https://github.com/hexojs/hexo/issues\">GitHub<i class=\"fa fa-external-link\"></i></span>.</p>\n<h2 id=\"Quick-Start\"><a href=\"#Quick-Start\" class=\"headerlink\" title=\"Quick Start\"></a>Quick Start</h2><h3 id=\"Create-a-new-post\"><a href=\"#Create-a-new-post\" class=\"headerlink\" title=\"Create a new post\"></a>Create a new post</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">\"My New Post\"</span></span><br></pre></td></tr></table></figure>\n\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvd3JpdGluZy5odG1s\" title=\"https://hexo.io/docs/writing.html\">Writing<i class=\"fa fa-external-link\"></i></span></p>\n<h3 id=\"Run-server\"><a href=\"#Run-server\" class=\"headerlink\" title=\"Run server\"></a>Run server</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure>\n\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvc2VydmVyLmh0bWw=\" title=\"https://hexo.io/docs/server.html\">Server<i class=\"fa fa-external-link\"></i></span></p>\n<h3 id=\"Generate-static-files\"><a href=\"#Generate-static-files\" class=\"headerlink\" title=\"Generate static files\"></a>Generate static files</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></figure>\n\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3MvZ2VuZXJhdGluZy5odG1s\" title=\"https://hexo.io/docs/generating.html\">Generating<i class=\"fa fa-external-link\"></i></span></p>\n<h3 id=\"Deploy-to-remote-sites\"><a href=\"#Deploy-to-remote-sites\" class=\"headerlink\" title=\"Deploy to remote sites\"></a>Deploy to remote sites</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></figure>\n\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3MvZGVwbG95bWVudC5odG1s\" title=\"https://hexo.io/docs/deployment.html\">Deployment<i class=\"fa fa-external-link\"></i></span></p>\n<figure class=\"highlight go\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">Test</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  a := <span class=\"number\">1</span></span><br><span class=\"line\">  fmt.printf(<span class=\"string\">\"Hello GoLang!\"</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n"},{"date":"2015-09-23T03:04:00.000Z","title":"RMAN异机异目录完全恢复","_content":"\n>开始\n\n先说一下为什么要写这个异机完全恢复的blog，作为一个年轻的DBA，相信大多数都是备份长做而恢复不常做，我会经常担心我的生产库的服务器挂了怎么办，我的备份完好，但我们又没有容灾，我能否保证我的数据不丢失呢，所以就要rman利用备份重建，而如果此时我能找到完好无损的在线日志，我是不是可以完全恢复了呢，理论上大家都说可以，确从未在网上见到过完全恢复的事例（完全其实很简单，只是网上阐述了太多的不完全恢复，会让我觉得set until time等等是必备的其中一步），甚至oracle的官方网文档上也使用了“SET UNTIL SCN 123456;” 的案例，有鉴于此，我做了这个实验，并记录下来，跟大家分享，不见得这篇原创有多高深的技术和见解O(∩_∩)O\n\n```\n环境：\n    源库：\n        os：redhat 6.3 x64\n        db: 11gr2 11.2.0.4\n        存储方式：ASM\n    目标库：\n        os：redhat 6.5 x64\n        db: 11gr2 11.2.0.4\n        存储方式：文件系统\n```\n\n## 1. 首先，源库进行rman备份\n```sql\n--手动0级全库备份\nrun {\n    CONFIGURE RETENTION POLICY TO RECOVERY WINDOW OF 7 DAYS;\n    CONFIGURE BACKUP OPTIMIZATION ON;\n    CONFIGURE CONTROLFILE AUTOBACKUP ON;\n    CONFIGURE DEVICE TYPE DISK PARALLELISM 4 BACKUP TYPE TO BACKUPSET;\n    CONFIGURE CONTROLFILE AUTOBACKUP FORMAT FOR DEVICE TYPE DISK TO '+DATA/backup/ctl_atuo_%F';\n    ALLOCATE CHANNEL c1 TYPE DISK;\n    ALLOCATE CHANNEL c2 TYPE DISK;\n    CROSSCHECK ARCHIVELOG ALL;\n    BACKUP INCREMENTAL LEVEL 0\n    DATABASE FORMAT '+DATA/backup/db_%U' TAG 'db_rman';\n    SQL 'ALTER SYSTEM ARCHIVE LOG CURRENT';\n    BACKUP ARCHIVELOG ALL FORMAT '+DATA/backup/arc_%U' TAG 'ARC_rman'\n    DELETE INPUT;\n    DELETE NOPROMPT OBSOLETE;\n    RELEASE CHANNEL c1;\n    RELEASE CHANNEL c2;\n}\n```\n<!--more-->\n### 观察备份的文件，此处是ASM分别用asmcmd和rman查看\n```sql\nASMCMD> ls\narc_0cqhdnqq_1_1\narc_0dqhdnqq_1_1\nctl_atuo_c-2496627597-20150917-00\nctl_atuo_c-2496627597-20150917-01\ndb_09qhdno6_1_1\ndb_0aqhdno6_1_1\nASMCMD> pwd\n+Data/backup\nASMCMD>\n\nRMAN> list backup summary;\n\n\nList of Backups\n===============\nKey     TY LV S Device Type Completion Time #Pieces #Copies Compressed Tag\n------- -- -- - ----------- --------------- ------- ------- ---------- ---\n9       B  0  A DISK        17-SEP-15       1       1       NO         DB_RMAN\n10      B  0  A DISK        17-SEP-15       1       1       NO         DB_RMAN\n11      B  F  A DISK        17-SEP-15       1       1       NO         TAG20150917T221650\n12      B  A  A DISK        17-SEP-15       1       1       NO         ARC_RMAN\n13      B  A  A DISK        17-SEP-15       1       1       NO         ARC_RMAN\n14      B  F  A DISK        17-SEP-15       1       1       NO         TAG20150917T221703\n```\n### 为了试验restore之后recover应用归档日志的情况，我在0级备份之后再生成一些归档日志，脚本如下：\n```sql\ndeclare\n  i integer;\nbegin\n  for i in 1..3000000 loop\n    insert into t values(i,'aaaaaaaaaaaaaaaaaaaaa');\n    end loop;\nend;\n```\n### 向测试表T中插入200万行数据，看归档的日志：\n```\nASMCMD> ls\n1_22_854775184.dbf\n1_23_854775184.dbf\n1_24_854775184.dbf\n1_25_854775184.dbf\n1_26_854775184.dbf\n1_27_854775184.dbf\n1_28_854775184.dbf\n1_29_854775184.dbf\n1_30_854775184.dbf\n1_31_854775184.dbf\n1_32_854775184.dbf\n1_33_854775184.dbf\n1_34_854775184.dbf\n1_35_854775184.dbf\n1_36_854775184.dbf\n1_37_854775184.dbf\n1_38_854775184.dbf\n1_39_854775184.dbf\n```\n### 查看T表的行数\n```sql\nSQL> select count(1) from t;\n\n  COUNT(1)\n----------\n   3000000\n```\n## 2. 转移备份\n现在要把rman备份，备份之后的归档，源库关闭之后的在线redo文件拷贝到备库，这里稍微麻烦一点，涉及到从asm中拷贝文件，我这里使用2中方法，rman的backup as cpoy以及asmcmd的cp命令，如下所示：\n>rman copy备份集\n\n```sql\n--这里是copy 0级备份\nbackup as copy backupset 9 format '/u01/backupset/db2.rman';\nbackup as copy backupset 10 format '/u01/backupset/db2.rman';\nbackup as copy backupset 11 format '/u01/backupset/ctl1.rman';\nbackup as copy backupset 12 format '/u01/backupset/arc1.rman';\nbackup as copy backupset 13 format '/u01/backupset/arc2.rman';\nbackup as copy backupset 14 format '/u01/backupset/ctl2.rman';\n```\n>asmcmd转移归档\n\n```\n--生成的归档日志\nASMCMD> ls\n1_22_854775184.dbf\n1_23_854775184.dbf\n1_24_854775184.dbf\n1_25_854775184.dbf\n1_26_854775184.dbf\n1_27_854775184.dbf\n1_28_854775184.dbf\n1_29_854775184.dbf\n1_30_854775184.dbf\n1_31_854775184.dbf\n1_32_854775184.dbf\n1_33_854775184.dbf\n1_34_854775184.dbf\n1_35_854775184.dbf\n1_36_854775184.dbf\n1_37_854775184.dbf\n1_38_854775184.dbf\n1_39_854775184.dbf\n--copy走，无法使用通配符是一件很痛苦的事情\nASMCMD> cp 1_23_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_23_854775184.dbf -> /u02/backupset/1_23_854775184.dbf\nASMCMD> cp 1_24_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_24_854775184.dbf -> /u02/backupset/1_24_854775184.dbf\nASMCMD> cp 1_25_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_25_854775184.dbf -> /u02/backupset/1_25_854775184.dbf\nASMCMD> cp 1_26_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_26_854775184.dbf -> /u02/backupset/1_26_854775184.dbf\nASMCMD> cp 1_27_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_27_854775184.dbf -> /u02/backupset/1_27_854775184.dbf\nASMCMD> cp 1_28_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_28_854775184.dbf -> /u02/backupset/1_28_854775184.dbf\nASMCMD> cp 1_29_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_29_854775184.dbf -> /u02/backupset/1_29_854775184.dbf\nASMCMD> cp 1_3* /u02/backupset\ncopying +Data/archive_log/1_30_854775184.dbf -> /u02/backupset/1_30_854775184.dbf\nASMCMD> cp 1_31_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_31_854775184.dbf -> /u02/backupset/1_31_854775184.dbf\nASMCMD> cp 1_32_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_32_854775184.dbf -> /u02/backupset/1_32_854775184.dbf\nASMCMD> cp 1_33_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_33_854775184.dbf -> /u02/backupset/1_33_854775184.dbf\nASMCMD> cp 1_34_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_34_854775184.dbf -> /u02/backupset/1_34_854775184.dbf\nASMCMD> cp 1_35_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_35_854775184.dbf -> /u02/backupset/1_35_854775184.dbf\nASMCMD> cp 1_36_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_36_854775184.dbf -> /u02/backupset/1_36_854775184.dbf\nASMCMD> cp 1_37_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_37_854775184.dbf -> /u02/backupset/1_37_854775184.dbf\nASMCMD> cp 1_38_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_38_854775184.dbf -> /u02/backupset/1_38_854775184.dbf\nASMCMD> cp 1_39_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_39_854775184.dbf -> /u02/backupset/1_39_854775184.dbf\n```\n### 查看当前的redo状态,记住当前redo的seq号\n```sql\nSQL> select group#,SEQUENCE# ,MEMBERS,ARCHIVED,STATUS from v$log;\n\n    GROUP#  SEQUENCE#    MEMBERS ARC STATUS\n---------- ---------- ---------- --- ----------------\n         1         40          2 NO  CURRENT\n         2         38          2 YES INACTIVE\n         3         39          2 YES INACTIVE\n ```\n### 查看redo文件\n ```sql\n SQL> select GROUP#,STATUS,MEMBER  from v$logfile;\n\n    GROUP# STATUS  MEMBER\n---------- ------- --------------------------------------------------------------------------------\n         3         +DATA/min/onlinelog/group_3.266.854775193\n         3         +DATA/min/onlinelog/group_3.267.854775195\n         2         +DATA/min/onlinelog/group_2.264.854775189\n         2         +DATA/min/onlinelog/group_2.265.854775191\n         1         +DATA/min/onlinelog/group_1.262.854775185\n         1         +DATA/min/onlinelog/group_1.263.854775187\n ```\n >使用asmcmd拷贝并改名，这个时候我已经关闭了源库\n\n```\nASMCMD> cd onlinelog\nASMCMD>\nASMCMD> ls\ngroup_1.262.854775185\ngroup_1.263.854775187\ngroup_2.264.854775189\ngroup_2.265.854775191\ngroup_3.266.854775193\ngroup_3.267.854775195\n\nASMCMD> cp group_1.262.854775185 /u02/backupset/redo1a.log\ncopying +Data/min/onlinelog/group_1.262.854775185 -> /u02/backupset/redo1a.log\nASMCMD> cp group_1.263.854775187 /u02/backupset/redo1b.log\ncopying +Data/min/onlinelog/group_1.263.854775187 -> /u02/backupset/redo1b.log\nASMCMD> cp group_2.264.854775189 /u02/backupset/redo2a.log\ncopying +Data/min/onlinelog/group_2.264.854775189 -> /u02/backupset/redo2a.log\nASMCMD> cp group_2.265.854775191 /u02/backupset/redo2b.log\ncopying +Data/min/onlinelog/group_2.265.854775191 -> /u02/backupset/redo2b.log\nASMCMD> cp group_3.266.854775193 /u02/backupset/redo3a.log\ncopying +Data/min/onlinelog/group_3.266.854775193 -> /u02/backupset/redo3a.log\nASMCMD> cp group_3.267.854775195 /u02/backupset/redo3b.log\ncopying +Data/min/onlinelog/group_3.267.854775195 -> /u02/backupset/redo3b.log\n```\n## 3.  目标机器恢复\n这一步之前已经在目标主机安装好oracle软件，安装过程不再赘述，直接记录恢复过程\n这里直接从备份中恢复pfile（比较懒，不想手动准备），无参数文件，rman会启动一个傻瓜实例，供我们恢复参数文件。\n###从备份中恢复参数文件\n```sql\nRMAN> startup nomount\n\nstartup failed: ORA-01078: failure in processing system parameters\nLRM-00109: could not open parameter file '/home/oracle/app/oracle/product/11.2.0/dbhome_1/dbs/initmin.ora'\n\nstarting Oracle instance without parameter file for retrieval of spfile\nOracle instance started\n\nTotal System Global Area    1068937216 bytes\n\nFixed Size                     2260088 bytes\nVariable Size                281019272 bytes\nDatabase Buffers             780140544 bytes\nRedo Buffers                   5517312 bytes\n\n\nRMAN> restore spfile to pfile '/home/oracle/app/oracle/product/11.2.0/dbhome_1/dbs/initmin.ora' from '/u01/rmanbackup/ctl2.rman';\n\nStarting restore at 18-SEP-15\nusing target database control file instead of recovery catalog\nallocated channel: ORA_DISK_1\nchannel ORA_DISK_1: SID=171 device type=DISK\n\nchannel ORA_DISK_1: restoring spfile from AUTOBACKUP /u01/rmanbackup/ctl2.rman\nchannel ORA_DISK_1: SPFILE restore from AUTOBACKUP complete\nFinished restore at 18-SEP-15\n\nRMAN> shutdown abort\n\nOracle instance shut down\n```\n### 创建目录，修改参数文件\n```bash\n[oracle@rman_newhost u01]$ mkdir -p /u01/app/oracle/admin/min/adump\n[oracle@rman_newhost u01]$ mkdir -p /u01/app/oracle/fast_recovery_area\n[oracle@rman_newhost u01]$ mkdir -p /u01/app/oracle/archived_log\n[oracle@rman_newhost u01]$ mkdir -p /u01/app/oracle/oradata/min\n*.audit_file_dest='/u01/app/oracle/admin/min/adump'\n*.audit_trail='db'\n*.compatible='11.2.0.4.0'\n*.control_files='/u01/app/oracle/fast_recovery_area/control01.ctl','/u01/app/oracle/oradata/min/control02.ctl'\n*.db_block_size=8192\n*.db_domain=''\n*.db_name='min'\n*.db_recovery_file_dest='/u01/app/oracle/fast_recovery_area'\n*.db_recovery_file_dest_size=4385144832\n*.diagnostic_dest='/u01/app/oracle'\n*.dispatchers='(PROTOCOL=TCP) (SERVICE=minXDB)'\n*.log_archive_dest_1='location=/u01/app/oracle/archived_log'\n*.log_checkpoints_to_alert=TRUE\n*.memory_target=1394606080\n*.open_cursors=300\n*.processes=1500\n*.remote_login_passwordfile='EXCLUSIVE'\n*.sessions=1655\n*.undo_tablespace='UNDOTBS1'\n```\n### 启动到nomount状态，恢复控制文件\n```sql\nRMAN> startup nomount\n\nconnected to target database (not started)\nOracle instance started\n\nTotal System Global Area    1402982400 bytes\n\nFixed Size                     2253184 bytes\nVariable Size               1275072128 bytes\nDatabase Buffers             117440512 bytes\nRedo Buffers                   8216576 bytes\n\nRMAN> restore controlfile from '/u01/rmanbackup/ctl2.rman';\n\nStarting restore at 18-SEP-15\nallocated channel: ORA_DISK_1\nchannel ORA_DISK_1: SID=1146 device type=DISK\n\nchannel ORA_DISK_1: restoring control file\nchannel ORA_DISK_1: restore complete, elapsed time: 00:00:01\noutput file name=/u01/app/oracle/fast_recovery_area/control01.ctl\noutput file name=/u01/app/oracle/oradata/min/control02.ctl\nFinished restore at 18-SEP-15\n\nRMAN> alter database mount;\n\ndatabase mounted\nreleased channel: ORA_DISK_1\n```\n### 将redo文件和归档日志移动到对应目录下\n```bash\n[oracle@rman_newhost rmanbackup]$ mv redo* /u01/app/oracle/oradata/min\n[oracle@rman_newhost rmanbackup]$ ll /u01/app/oracle/oradata/min\n总用量 316744\n-rw-r-----. 1 oracle oinstall 9748480 9月 18 00:34 control02.ctl\n-rw-r--r--. 1 oracle oinstall 52429312 9月 17 23:00 redo1a.log\n-rw-r--r--. 1 oracle oinstall 52429312 9月 17 23:01 redo1b.log\n-rw-r--r--. 1 oracle oinstall 52429312 9月 17 23:01 redo2a.log\n-rw-r--r--. 1 oracle oinstall 52429312 9月 17 23:01 redo2b.log\n-rw-r--r--. 1 oracle oinstall 52429312 9月 17 23:02 redo3a.log\n-rw-r--r--. 1 oracle oinstall 52429312 9月 17 23:02 redo3b.log\n[oracle@rman_newhost rmanbackup]$ mv 1_* /u01/app/oracle/archived_log\n[oracle@rman_newhost rmanbackup]$ ll /u01/app/oracle/archived_log\n总用量 809056\n-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:48 1_22_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 39179776 9月 17 22:49 1_23_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:49 1_24_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:50 1_25_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:50 1_26_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 48581120 9月 17 22:50 1_27_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:51 1_28_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 42950144 9月 17 22:51 1_29_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:51 1_30_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 50134016 9月 17 22:53 1_31_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:53 1_32_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 46714368 9月 17 22:53 1_33_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 44308480 9月 17 22:54 1_34_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:54 1_35_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:54 1_36_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:54 1_37_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:55 1_38_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:55 1_39_854775184.dbf\n```\n### 注册备份集\n下面一步的操作是删掉控制文件中对备份的记录信息，因为这是源库备份恢复过来的，我们要删掉老的备份信息，将备份重新注册，不删也没关系，crosscheck以后你会发现，原来的备份状态都是expired的\n>利用crosscheck删除控制文件中的备份记录\n\n```sql\nRMAN> list backup summary;\n\n\nList of Backups\n===============\nKey     TY LV S Device Type Completion Time #Pieces #Copies Compressed Tag\n------- -- -- - ----------- --------------- ------- ------- ---------- ---\n9       B  0  A DISK        17-SEP-15       1       1       NO         DB_RMAN\n10      B  0  A DISK        17-SEP-15       1       1       NO         DB_RMAN\n11      B  F  A DISK        17-SEP-15       1       1       NO         TAG20150917T221650\n12      B  A  A DISK        17-SEP-15       1       1       NO         ARC_RMAN\n13      B  A  A DISK        17-SEP-15       1       1       NO         ARC_RMAN\n\nRMAN> crosscheck backup;\n\nStarting implicit crosscheck backup at 18-SEP-15\nallocated channel: ORA_DISK_1\nchannel ORA_DISK_1: SID=1146 device type=DISK\nallocated channel: ORA_DISK_2\nchannel ORA_DISK_2: SID=10 device type=DISK\nallocated channel: ORA_DISK_3\nchannel ORA_DISK_3: SID=1147 device type=DISK\nallocated channel: ORA_DISK_4\nchannel ORA_DISK_4: SID=11 device type=DISK\nCrosschecked 5 objects\nFinished implicit crosscheck backup at 18-SEP-15\n\nStarting implicit crosscheck copy at 18-SEP-15\nusing channel ORA_DISK_1\nusing channel ORA_DISK_2\nusing channel ORA_DISK_3\nusing channel ORA_DISK_4\nFinished implicit crosscheck copy at 18-SEP-15\n\nsearching for all files in the recovery area\ncataloging files...\nno files cataloged\n\nusing channel ORA_DISK_1\nusing channel ORA_DISK_2\nusing channel ORA_DISK_3\nusing channel ORA_DISK_4\ncrosschecked backup piece: found to be 'EXPIRED'\nbackup piece handle=+DATA/backup/db_0aqhdno6_1_1 RECID=9 STAMP=890691334\ncrosschecked backup piece: found to be 'EXPIRED'\nbackup piece handle=+DATA/backup/db_09qhdno6_1_1 RECID=10 STAMP=890691334\ncrosschecked backup piece: found to be 'EXPIRED'\nbackup piece handle=+DATA/backup/ctl_atuo_c-2496627597-20150917-00 RECID=11 STAMP=890691411\ncrosschecked backup piece: found to be 'EXPIRED'\nbackup piece handle=+DATA/backup/arc_0dqhdnqq_1_1 RECID=12 STAMP=890691418\ncrosschecked backup piece: found to be 'EXPIRED'\nbackup piece handle=+DATA/backup/arc_0cqhdnqq_1_1 RECID=13 STAMP=890691418\nCrosschecked 5 objects\n\n\nRMAN> list backup;\n\n\nList of Backup Sets\n===================\n\n\nBS Key  Type LV Size       Device Type Elapsed Time Completion Time\n------- ---- -- ---------- ----------- ------------ ---------------\n9       Incr 0  433.65M    DISK        00:01:10     17-SEP-15\n        BP Key: 9   Status: EXPIRED  Compressed: NO  Tag: DB_RMAN\n        Piece Name: +DATA/backup/db_0aqhdno6_1_1\n  List of Datafiles in backup set 9\n  File LV Type Ckp SCN    Ckp Time  Name\n  ---- -- ---- ---------- --------- ----\n  2    0  Incr 1138043    17-SEP-15 +DATA/min/datafile/sysaux.257.854775097\n  3    0  Incr 1138043    17-SEP-15 +DATA/min/datafile/undotbs1.258.854775097\n\nBS Key  Type LV Size       Device Type Elapsed Time Completion Time\n------- ---- -- ---------- ----------- ------------ ---------------\n10      Incr 0  638.84M    DISK        00:01:10     17-SEP-15\n        BP Key: 10   Status: EXPIRED  Compressed: NO  Tag: DB_RMAN\n        Piece Name: +DATA/backup/db_09qhdno6_1_1\n  List of Datafiles in backup set 10\n  File LV Type Ckp SCN    Ckp Time  Name\n  ---- -- ---- ---------- --------- ----\n  1    0  Incr 1138042    17-SEP-15 +DATA/min/datafile/system.256.854775095\n  4    0  Incr 1138042    17-SEP-15 +DATA/min/datafile/users.259.854775097\n\nBS Key  Type LV Size       Device Type Elapsed Time Completion Time\n------- ---- -- ---------- ----------- ------------ ---------------\n11      Full    9.36M      DISK        00:00:01     17-SEP-15\n        BP Key: 11   Status: EXPIRED  Compressed: NO  Tag: TAG20150917T221650\n        Piece Name: +DATA/backup/ctl_atuo_c-2496627597-20150917-00\n  SPFILE Included: Modification time: 17-SEP-15\n  SPFILE db_unique_name: MIN\n  Control File Included: Ckp SCN: 1138347      Ckp time: 17-SEP-15\n\nBS Key  Size       Device Type Elapsed Time Completion Time\n------- ---------- ----------- ------------ ---------------\n12      2.00K      DISK        00:00:00     17-SEP-15\n        BP Key: 12   Status: EXPIRED  Compressed: NO  Tag: ARC_RMAN\n        Piece Name: +DATA/backup/arc_0dqhdnqq_1_1\n\n  List of Archived Logs in backup set 12\n  Thrd Seq     Low SCN    Low Time  Next SCN   Next Time\n  ---- ------- ---------- --------- ---------- ---------\n  1    21      1138364    17-SEP-15 1138372    17-SEP-15\n\nBS Key  Size       Device Type Elapsed Time Completion Time\n------- ---------- ----------- ------------ ---------------\n13      30.99M     DISK        00:00:02     17-SEP-15\n        BP Key: 13   Status: EXPIRED  Compressed: NO  Tag: ARC_RMAN\n        Piece Name: +DATA/backup/arc_0cqhdnqq_1_1\n\n  List of Archived Logs in backup set 13\n  Thrd Seq     Low SCN    Low Time  Next SCN   Next Time\n  ---- ------- ---------- --------- ---------- ---------\n  1    20      1127220    17-SEP-15 1138364    17-SEP-15\n\nRMAN> list archivelog all;\n\nspecification does not match any archived log in the repository\n\n\nRMAN> report obsolete;\n\nRMAN retention policy will be applied to the command\nRMAN retention policy is set to recovery window of 7 days\nno obsolete backups found\n\nRMAN> list expired backup;\n\n\nList of Backup Sets\n===================\n\n\nBS Key  Type LV Size       Device Type Elapsed Time Completion Time\n------- ---- -- ---------- ----------- ------------ ---------------\n9       Incr 0  433.65M    DISK        00:01:10     17-SEP-15\n        BP Key: 9   Status: EXPIRED  Compressed: NO  Tag: DB_RMAN\n        Piece Name: +DATA/backup/db_0aqhdno6_1_1\n  List of Datafiles in backup set 9\n  File LV Type Ckp SCN    Ckp Time  Name\n  ---- -- ---- ---------- --------- ----\n  2    0  Incr 1138043    17-SEP-15 +DATA/min/datafile/sysaux.257.854775097\n  3    0  Incr 1138043    17-SEP-15 +DATA/min/datafile/undotbs1.258.854775097\n\nBS Key  Type LV Size       Device Type Elapsed Time Completion Time\n------- ---- -- ---------- ----------- ------------ ---------------\n10      Incr 0  638.84M    DISK        00:01:10     17-SEP-15\n        BP Key: 10   Status: EXPIRED  Compressed: NO  Tag: DB_RMAN\n        Piece Name: +DATA/backup/db_09qhdno6_1_1\n  List of Datafiles in backup set 10\n  File LV Type Ckp SCN    Ckp Time  Name\n  ---- -- ---- ---------- --------- ----\n  1    0  Incr 1138042    17-SEP-15 +DATA/min/datafile/system.256.854775095\n  4    0  Incr 1138042    17-SEP-15 +DATA/min/datafile/users.259.854775097\n\nBS Key  Type LV Size       Device Type Elapsed Time Completion Time\n------- ---- -- ---------- ----------- ------------ ---------------\n11      Full    9.36M      DISK        00:00:01     17-SEP-15\n        BP Key: 11   Status: EXPIRED  Compressed: NO  Tag: TAG20150917T221650\n        Piece Name: +DATA/backup/ctl_atuo_c-2496627597-20150917-00\n  SPFILE Included: Modification time: 17-SEP-15\n  SPFILE db_unique_name: MIN\n  Control File Included: Ckp SCN: 1138347      Ckp time: 17-SEP-15\n\nBS Key  Size       Device Type Elapsed Time Completion Time\n------- ---------- ----------- ------------ ---------------\n12      2.00K      DISK        00:00:00     17-SEP-15\n        BP Key: 12   Status: EXPIRED  Compressed: NO  Tag: ARC_RMAN\n        Piece Name: +DATA/backup/arc_0dqhdnqq_1_1\n\n  List of Archived Logs in backup set 12\n  Thrd Seq     Low SCN    Low Time  Next SCN   Next Time\n  ---- ------- ---------- --------- ---------- ---------\n  1    21      1138364    17-SEP-15 1138372    17-SEP-15\n\nBS Key  Size       Device Type Elapsed Time Completion Time\n------- ---------- ----------- ------------ ---------------\n13      30.99M     DISK        00:00:02     17-SEP-15\n        BP Key: 13   Status: EXPIRED  Compressed: NO  Tag: ARC_RMAN\n        Piece Name: +DATA/backup/arc_0cqhdnqq_1_1\n\n  List of Archived Logs in backup set 13\n  Thrd Seq     Low SCN    Low Time  Next SCN   Next Time\n  ---- ------- ---------- --------- ---------- ---------\n  1    20      1127220    17-SEP-15 1138364    17-SEP-15\n\nRMAN> delete noprompt expired backup;\n\nusing channel ORA_DISK_1\nusing channel ORA_DISK_2\nusing channel ORA_DISK_3\nusing channel ORA_DISK_4\n\nList of Backup Pieces\nBP Key  BS Key  Pc# Cp# Status      Device Type Piece Name\n------- ------- --- --- ----------- ----------- ----------\n9       9       1   1   EXPIRED     DISK        +DATA/backup/db_0aqhdno6_1_1\n10      10      1   1   EXPIRED     DISK        +DATA/backup/db_09qhdno6_1_1\n11      11      1   1   EXPIRED     DISK        +DATA/backup/ctl_atuo_c-2496627597-20150917-00\n12      12      1   1   EXPIRED     DISK        +DATA/backup/arc_0dqhdnqq_1_1\n13      13      1   1   EXPIRED     DISK        +DATA/backup/arc_0cqhdnqq_1_1\ndeleted backup piece\nbackup piece handle=+DATA/backup/db_0aqhdno6_1_1 RECID=9 STAMP=890691334\ndeleted backup piece\nbackup piece handle=+DATA/backup/db_09qhdno6_1_1 RECID=10 STAMP=890691334\ndeleted backup piece\nbackup piece handle=+DATA/backup/ctl_atuo_c-2496627597-20150917-00 RECID=11 STAMP=890691411\ndeleted backup piece\nbackup piece handle=+DATA/backup/arc_0dqhdnqq_1_1 RECID=12 STAMP=890691418\ndeleted backup piece\nbackup piece handle=+DATA/backup/arc_0cqhdnqq_1_1 RECID=13 STAMP=890691418\nDeleted 5 EXPIRED objects\n\n\nRMAN> list backup;\n\nspecification does not match any backup in the repository\n```\n>重新注册备份，并观察控制文件中的备份信息，和数据库结构的信息\n\n```sql\nRMAN> catalog start with '/u01/rmanbackup';\n\nsearching for all files that match the pattern /u01/rmanbackup\n\nList of Files Unknown to the Database\n=====================================\nFile Name: /u01/rmanbackup/arc1.rman\nFile Name: /u01/rmanbackup/db1.rman\nFile Name: /u01/rmanbackup/ctl2.rman\nFile Name: /u01/rmanbackup/ctl1.rman\nFile Name: /u01/rmanbackup/db2.rman\nFile Name: /u01/rmanbackup/arc2.rman\n\nDo you really want to catalog the above files (enter YES or NO)? yes\ncataloging files...\ncataloging done\n\nList of Cataloged Files\n=======================\nFile Name: /u01/rmanbackup/arc1.rman\nFile Name: /u01/rmanbackup/db1.rman\nFile Name: /u01/rmanbackup/ctl2.rman\nFile Name: /u01/rmanbackup/ctl1.rman\nFile Name: /u01/rmanbackup/db2.rman\nFile Name: /u01/rmanbackup/arc2.rman\n\nRMAN> list backup summary;\n\n\nList of Backups\n===============\nKey     TY LV S Device Type Completion Time #Pieces #Copies Compressed Tag\n------- -- -- - ----------- --------------- ------- ------- ---------- ---\n14      B  A  A DISK        17-SEP-15       1       1       NO         ARC_RMAN\n15      B  0  A DISK        17-SEP-15       1       1       NO         DB_RMAN\n16      B  0  A DISK        17-SEP-15       1       1       NO         DB_RMAN\n17      B  A  A DISK        17-SEP-15       1       1       NO         ARC_RMAN\n\n--数据文件、临时文件的记录还是源库的信息，一会儿恢复的时候要setnewname\nRMAN> report schema;\n\nRMAN-06139: WARNING: control file is not current for REPORT SCHEMA\nReport of database schema for database with db_unique_name MIN\n\nList of Permanent Datafiles\n===========================\nFile Size(MB) Tablespace           RB segs Datafile Name\n---- -------- -------------------- ------- ------------------------\n1    0        SYSTEM               ***     +DATA/min/datafile/system.256.854775095\n2    0        SYSAUX               ***     +DATA/min/datafile/sysaux.257.854775097\n3    0        UNDOTBS1             ***     +DATA/min/datafile/undotbs1.258.854775097\n4    0        USERS                ***     +DATA/min/datafile/users.259.854775097\n\nList of Temporary Files\n=======================\nFile Size(MB) Tablespace           Maxsize(MB) Tempfile Name\n---- -------- -------------------- ----------- --------------------\n1    20       TEMP                 32767       +DATA/min/tempfile/temp.268.854775211\n\n--你会发现这是老的控制文件，是我们0级备份里的，其中关于redo的状态记录，当前redo还停留在序列号22\nSQL> select GROUP#,SEQUENCE# ,STATUS,ARCHIVED  from v$log;\n\n    GROUP#  SEQUENCE# STATUS           ARC\n---------- ---------- ---------------- ---\n         1         22 CURRENT          NO\n         3         21 ACTIVE           YES\n         2         20 ACTIVE           YES\n\nSQL> desc v$logfile;\n Name                                      Null?    Type\n ----------------------------------------- -------- ----------------------------\n GROUP#                                             NUMBER\n STATUS                                             VARCHAR2(7)\n TYPE                                               VARCHAR2(7)\n MEMBER                                             VARCHAR2(513)\n IS_RECOVERY_DEST_FILE                              VARCHAR2(3)\n\n--redo的记录还是源库的信息，一会儿恢复的时候要setnewname\nSQL> col member for a80\nSQL> set line 200\nSQL> select GROUP#,STATUS,MEMBER from v$logfile;\n\n    GROUP# STATUS  MEMBER\n---------- ------- --------------------------------------------------------------------------------\n         3         +DATA/min/onlinelog/group_3.266.854775193\n         3         +DATA/min/onlinelog/group_3.267.854775195\n         2         +DATA/min/onlinelog/group_2.264.854775189\n         2         +DATA/min/onlinelog/group_2.265.854775191\n         1         +DATA/min/onlinelog/group_1.262.854775185\n         1         +DATA/min/onlinelog/group_1.263.854775187\n\n6 rows selected.\n```\n### 还原数据库\n```sql\nRMAN> RUN\n2>  {\n3>    ALLOCATE CHANNEL c1 DEVICE TYPE DISK;\n4>    ALLOCATE CHANNEL c2 DEVICE TYPE DISK;\n5>    set archivelog destination to \"/u01/app/oracle/archived_log\";\n6>       set newname for datafile 1 to \"/u01/app/oracle/oradata/min/system01.dbf\";\n7>       set newname for datafile 2 to \"/u01/app/oracle/oradata/min/sysaux01.dbf\";\n8>       set newname for datafile 3 to \"/u01/app/oracle/oradata/min/undotbs01.dbf\";\n9>       set newname for datafile 4 to \"/u01/app/oracle/oradata/min/users01.dbf\";\n10>      set newname for tempfile 1 to \"/u01/app/oracle/oradata/min/temp01.dbf\";\n11>      SQL \"ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_1.262.854775185''  to  ''/u01/app/oracle/oradata/min/redo1a.log'' \";\n12>      SQL \"ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_1.263.854775187''  to  ''/u01/app/oracle/oradata/min/redo1b.log'' \";\n13>      SQL \"ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_2.264.854775189''  to  ''/u01/app/oracle/oradata/min/redo2a.log'' \";\n14>      SQL \"ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_2.265.854775191''  to  ''/u01/app/oracle/oradata/min/redo2b.log'' \";\n15>      SQL \"ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_3.266.854775193''  to  ''/u01/app/oracle/oradata/min/redo3a.log'' \";\n16>      SQL \"ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_3.267.854775195''  to  ''/u01/app/oracle/oradata/min/redo3b.log'' \";\n17>    RESTORE DATABASE;\n18>    SWITCH DATAFILE ALL;\n19>    switch tempfile all;\n20>  }\n\nreleased channel: ORA_DISK_1\nreleased channel: ORA_DISK_2\nreleased channel: ORA_DISK_3\nreleased channel: ORA_DISK_4\nallocated channel: c1\nchannel c1: SID=1146 device type=DISK\n\nallocated channel: c2\nchannel c2: SID=11 device type=DISK\n\nexecuting command: SET ARCHIVELOG DESTINATION\n\nexecuting command: SET NEWNAME\n\nexecuting command: SET NEWNAME\n\nexecuting command: SET NEWNAME\n\nexecuting command: SET NEWNAME\n\nexecuting command: SET NEWNAME\n\nsql statement: ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_1.262.854775185''  to  ''/u01/app/oracle/oradata/min/redo1a.log''\n\nsql statement: ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_1.263.854775187''  to  ''/u01/app/oracle/oradata/min/redo1b.log''\n\nsql statement: ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_2.264.854775189''  to  ''/u01/app/oracle/oradata/min/redo2a.log''\n\nsql statement: ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_2.265.854775191''  to  ''/u01/app/oracle/oradata/min/redo2b.log''\n\nsql statement: ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_3.266.854775193''  to  ''/u01/app/oracle/oradata/min/redo3a.log''\n\nsql statement: ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_3.267.854775195''  to  ''/u01/app/oracle/oradata/min/redo3b.log''\n\nStarting restore at 18-SEP-15\n\nskipping datafile 2; already restored to file /u01/app/oracle/oradata/min/sysaux01.dbf\nchannel c1: starting datafile backup set restore\nchannel c1: specifying datafile(s) to restore from backup set\nchannel c1: restoring datafile 00001 to /u01/app/oracle/oradata/min/system01.dbf\nchannel c1: restoring datafile 00004 to /u01/app/oracle/oradata/min/users01.dbf\nchannel c1: reading from backup piece /u01/rmanbackup/db2.rman\nchannel c2: starting datafile backup set restore\nchannel c2: specifying datafile(s) to restore from backup set\nchannel c2: restoring datafile 00003 to /u01/app/oracle/oradata/min/undotbs01.dbf\nchannel c2: reading from backup piece /u01/rmanbackup/db1.rman\nchannel c2: piece handle=/u01/rmanbackup/db1.rman tag=DB_RMAN\nchannel c2: restored backup piece 1\nchannel c2: restore complete, elapsed time: 00:00:08\nchannel c1: piece handle=/u01/rmanbackup/db2.rman tag=DB_RMAN\nchannel c1: restored backup piece 1\nchannel c1: restore complete, elapsed time: 00:00:36\nFinished restore at 18-SEP-15\n\ndatafile 1 switched to datafile copy\ninput datafile copy RECID=5 STAMP=890701322 file name=/u01/app/oracle/oradata/min/system01.dbf\ndatafile 2 switched to datafile copy\ninput datafile copy RECID=6 STAMP=890701322 file name=/u01/app/oracle/oradata/min/sysaux01.dbf\ndatafile 3 switched to datafile copy\ninput datafile copy RECID=7 STAMP=890701322 file name=/u01/app/oracle/oradata/min/undotbs01.dbf\ndatafile 4 switched to datafile copy\ninput datafile copy RECID=8 STAMP=890701322 file name=/u01/app/oracle/oradata/min/users01.dbf\n\nrenamed tempfile 1 to /u01/app/oracle/oradata/min/temp01.dbf in control file\nreleased channel: c1\nreleased channel: c2\n\nRMAN>\n```\n>restore完毕，我们再来看一下控制文件中的信息\n\n```sql\nRMAN> report schema;\n\nRMAN-06139: WARNING: control file is not current for REPORT SCHEMA\nReport of database schema for database with db_unique_name MIN\n\nList of Permanent Datafiles\n===========================\nFile Size(MB) Tablespace           RB segs Datafile Name\n---- -------- -------------------- ------- ------------------------\n1    750      SYSTEM               ***     /u01/app/oracle/oradata/min/system01.dbf\n2    560      SYSAUX               ***     /u01/app/oracle/oradata/min/sysaux01.dbf\n3    100      UNDOTBS1             ***     /u01/app/oracle/oradata/min/undotbs01.dbf\n4    5        USERS                ***     /u01/app/oracle/oradata/min/users01.dbf\n\nList of Temporary Files\n=======================\nFile Size(MB) Tablespace           Maxsize(MB) Tempfile Name\n---- -------- -------------------- ----------- --------------------\n1    20       TEMP                 32767       /u01/app/oracle/oradata/min/temp01.dbf\n```\n### 完全恢复数据库\n```sql\nRMAN> recover database;\n\nStarting recover at 18-SEP-15\nallocated channel: ORA_DISK_1\nchannel ORA_DISK_1: SID=1146 device type=DISK\nallocated channel: ORA_DISK_2\nchannel ORA_DISK_2: SID=11 device type=DISK\nallocated channel: ORA_DISK_3\nchannel ORA_DISK_3: SID=1137 device type=DISK\nallocated channel: ORA_DISK_4\nchannel ORA_DISK_4: SID=10 device type=DISK\n\nstarting media recovery\n\narchived log for thread 1 with sequence 38 is already on disk as file /u01/app/oracle/oradata/min/redo2a.log\narchived log for thread 1 with sequence 39 is already on disk as file /u01/app/oracle/oradata/min/redo3a.log\narchived log for thread 1 with sequence 40 is already on disk as file /u01/app/oracle/oradata/min/redo1a.log\nchannel ORA_DISK_1: starting archived log restore to default destination\nchannel ORA_DISK_1: restoring archived log\narchived log thread=1 sequence=20\nchannel ORA_DISK_1: reading from backup piece /u01/rmanbackup/arc2.rman\nchannel ORA_DISK_2: starting archived log restore to default destination\nchannel ORA_DISK_2: restoring archived log\narchived log thread=1 sequence=21\nchannel ORA_DISK_2: reading from backup piece /u01/rmanbackup/arc1.rman\nchannel ORA_DISK_2: piece handle=/u01/rmanbackup/arc1.rman tag=ARC_RMAN\nchannel ORA_DISK_2: restored backup piece 1\nchannel ORA_DISK_2: restore complete, elapsed time: 00:00:01\nchannel ORA_DISK_1: piece handle=/u01/rmanbackup/arc2.rman tag=ARC_RMAN\nchannel ORA_DISK_1: restored backup piece 1\nchannel ORA_DISK_1: restore complete, elapsed time: 00:00:03\narchived log file name=/u01/app/oracle/archived_log/1_20_854775184.dbf thread=1 sequence=20\narchived log file name=/u01/app/oracle/archived_log/1_21_854775184.dbf thread=1 sequence=21\narchived log file name=/u01/app/oracle/archived_log/1_22_854775184.dbf thread=1 sequence=22\narchived log file name=/u01/app/oracle/archived_log/1_23_854775184.dbf thread=1 sequence=23\narchived log file name=/u01/app/oracle/archived_log/1_24_854775184.dbf thread=1 sequence=24\narchived log file name=/u01/app/oracle/archived_log/1_25_854775184.dbf thread=1 sequence=25\narchived log file name=/u01/app/oracle/archived_log/1_26_854775184.dbf thread=1 sequence=26\narchived log file name=/u01/app/oracle/archived_log/1_27_854775184.dbf thread=1 sequence=27\narchived log file name=/u01/app/oracle/archived_log/1_28_854775184.dbf thread=1 sequence=28\narchived log file name=/u01/app/oracle/archived_log/1_29_854775184.dbf thread=1 sequence=29\narchived log file name=/u01/app/oracle/archived_log/1_30_854775184.dbf thread=1 sequence=30\narchived log file name=/u01/app/oracle/archived_log/1_31_854775184.dbf thread=1 sequence=31\narchived log file name=/u01/app/oracle/archived_log/1_32_854775184.dbf thread=1 sequence=32\narchived log file name=/u01/app/oracle/archived_log/1_33_854775184.dbf thread=1 sequence=33\narchived log file name=/u01/app/oracle/archived_log/1_34_854775184.dbf thread=1 sequence=34\narchived log file name=/u01/app/oracle/archived_log/1_35_854775184.dbf thread=1 sequence=35\narchived log file name=/u01/app/oracle/archived_log/1_36_854775184.dbf thread=1 sequence=36\narchived log file name=/u01/app/oracle/archived_log/1_37_854775184.dbf thread=1 sequence=37\narchived log file name=/u01/app/oracle/oradata/min/redo2a.log thread=1 sequence=38\narchived log file name=/u01/app/oracle/oradata/min/redo3a.log thread=1 sequence=39\narchived log file name=/u01/app/oracle/oradata/min/redo1a.log thread=1 sequence=40\nmedia recovery complete, elapsed time: 00:00:43\nFinished recover at 18-SEP-15\n\nRMAN>\n```\n从恢复的日志可以看出，oracle会绕过38、39号的归档直接利用在线日志做恢复，oracle的聪明之处可见一斑！\n试着正常方式打开数据库，会发现报错：\n\n```sql\nRMAN> alter database open;\n\nRMAN-00571: ===========================================================\nRMAN-00569: =============== ERROR MESSAGE STACK FOLLOWS ===============\nRMAN-00571: ===========================================================\nRMAN-03002: failure of alter db command at 09/18/2015 01:04:41\nORA-01589: must use RESETLOGS or NORESETLOGS option for database open\n\n--看一下此时控制文件中的日志序列号，会发现没有前推，必须用resetlogs打开数据库\nSQL>  select group#,status,sequence# from v$log;\n\n    GROUP# STATUS            SEQUENCE#\n---------- ---------------- ----------\n         1 CURRENT                  22\n         3 ACTIVE                   21\n         2 ACTIVE                   20\nRMAN> alter database open resetlogs;\n\ndatabase opened\n```\n\n>使用resetlog的原因是recover命令只能修复控制文件中数据物理结构信息，而无法修改控制文件中的当前重做日志的序列号的信息，recover命令结束后，控制文件中的当前日志序列号还是陈旧的，若按常规方式打开数据库，将报错，为了抹去控制文件这个固执的念头，oracle采用重设日志的功能，日志序列号从1开始。此处虽然使用了resetlogs，但是因为“recover database”命令执行成功，所有提交的事务不会丢失，resetlogs仅仅是为了照顾还原的控制文件，与不完全恢复的resetlogs是不同的，至此恢复结束。\n\n```sql\nSQL> conn test/test\nERROR:\nORA-28002: the password will expire within 6 days\n\n\nConnected.\nSQL> select count(1) from t;\n\n  COUNT(1)\n----------\n   3000000\n```\n","source":"_posts/oracle/backup-restore/RMAN-different-server-directory-full-restore.md","raw":"---\ndate: 2015-09-23 11:04\ntags: oracle backup\ntitle: RMAN异机异目录完全恢复\ncategories: oracle backup\n---\n\n>开始\n\n先说一下为什么要写这个异机完全恢复的blog，作为一个年轻的DBA，相信大多数都是备份长做而恢复不常做，我会经常担心我的生产库的服务器挂了怎么办，我的备份完好，但我们又没有容灾，我能否保证我的数据不丢失呢，所以就要rman利用备份重建，而如果此时我能找到完好无损的在线日志，我是不是可以完全恢复了呢，理论上大家都说可以，确从未在网上见到过完全恢复的事例（完全其实很简单，只是网上阐述了太多的不完全恢复，会让我觉得set until time等等是必备的其中一步），甚至oracle的官方网文档上也使用了“SET UNTIL SCN 123456;” 的案例，有鉴于此，我做了这个实验，并记录下来，跟大家分享，不见得这篇原创有多高深的技术和见解O(∩_∩)O\n\n```\n环境：\n    源库：\n        os：redhat 6.3 x64\n        db: 11gr2 11.2.0.4\n        存储方式：ASM\n    目标库：\n        os：redhat 6.5 x64\n        db: 11gr2 11.2.0.4\n        存储方式：文件系统\n```\n\n## 1. 首先，源库进行rman备份\n```sql\n--手动0级全库备份\nrun {\n    CONFIGURE RETENTION POLICY TO RECOVERY WINDOW OF 7 DAYS;\n    CONFIGURE BACKUP OPTIMIZATION ON;\n    CONFIGURE CONTROLFILE AUTOBACKUP ON;\n    CONFIGURE DEVICE TYPE DISK PARALLELISM 4 BACKUP TYPE TO BACKUPSET;\n    CONFIGURE CONTROLFILE AUTOBACKUP FORMAT FOR DEVICE TYPE DISK TO '+DATA/backup/ctl_atuo_%F';\n    ALLOCATE CHANNEL c1 TYPE DISK;\n    ALLOCATE CHANNEL c2 TYPE DISK;\n    CROSSCHECK ARCHIVELOG ALL;\n    BACKUP INCREMENTAL LEVEL 0\n    DATABASE FORMAT '+DATA/backup/db_%U' TAG 'db_rman';\n    SQL 'ALTER SYSTEM ARCHIVE LOG CURRENT';\n    BACKUP ARCHIVELOG ALL FORMAT '+DATA/backup/arc_%U' TAG 'ARC_rman'\n    DELETE INPUT;\n    DELETE NOPROMPT OBSOLETE;\n    RELEASE CHANNEL c1;\n    RELEASE CHANNEL c2;\n}\n```\n<!--more-->\n### 观察备份的文件，此处是ASM分别用asmcmd和rman查看\n```sql\nASMCMD> ls\narc_0cqhdnqq_1_1\narc_0dqhdnqq_1_1\nctl_atuo_c-2496627597-20150917-00\nctl_atuo_c-2496627597-20150917-01\ndb_09qhdno6_1_1\ndb_0aqhdno6_1_1\nASMCMD> pwd\n+Data/backup\nASMCMD>\n\nRMAN> list backup summary;\n\n\nList of Backups\n===============\nKey     TY LV S Device Type Completion Time #Pieces #Copies Compressed Tag\n------- -- -- - ----------- --------------- ------- ------- ---------- ---\n9       B  0  A DISK        17-SEP-15       1       1       NO         DB_RMAN\n10      B  0  A DISK        17-SEP-15       1       1       NO         DB_RMAN\n11      B  F  A DISK        17-SEP-15       1       1       NO         TAG20150917T221650\n12      B  A  A DISK        17-SEP-15       1       1       NO         ARC_RMAN\n13      B  A  A DISK        17-SEP-15       1       1       NO         ARC_RMAN\n14      B  F  A DISK        17-SEP-15       1       1       NO         TAG20150917T221703\n```\n### 为了试验restore之后recover应用归档日志的情况，我在0级备份之后再生成一些归档日志，脚本如下：\n```sql\ndeclare\n  i integer;\nbegin\n  for i in 1..3000000 loop\n    insert into t values(i,'aaaaaaaaaaaaaaaaaaaaa');\n    end loop;\nend;\n```\n### 向测试表T中插入200万行数据，看归档的日志：\n```\nASMCMD> ls\n1_22_854775184.dbf\n1_23_854775184.dbf\n1_24_854775184.dbf\n1_25_854775184.dbf\n1_26_854775184.dbf\n1_27_854775184.dbf\n1_28_854775184.dbf\n1_29_854775184.dbf\n1_30_854775184.dbf\n1_31_854775184.dbf\n1_32_854775184.dbf\n1_33_854775184.dbf\n1_34_854775184.dbf\n1_35_854775184.dbf\n1_36_854775184.dbf\n1_37_854775184.dbf\n1_38_854775184.dbf\n1_39_854775184.dbf\n```\n### 查看T表的行数\n```sql\nSQL> select count(1) from t;\n\n  COUNT(1)\n----------\n   3000000\n```\n## 2. 转移备份\n现在要把rman备份，备份之后的归档，源库关闭之后的在线redo文件拷贝到备库，这里稍微麻烦一点，涉及到从asm中拷贝文件，我这里使用2中方法，rman的backup as cpoy以及asmcmd的cp命令，如下所示：\n>rman copy备份集\n\n```sql\n--这里是copy 0级备份\nbackup as copy backupset 9 format '/u01/backupset/db2.rman';\nbackup as copy backupset 10 format '/u01/backupset/db2.rman';\nbackup as copy backupset 11 format '/u01/backupset/ctl1.rman';\nbackup as copy backupset 12 format '/u01/backupset/arc1.rman';\nbackup as copy backupset 13 format '/u01/backupset/arc2.rman';\nbackup as copy backupset 14 format '/u01/backupset/ctl2.rman';\n```\n>asmcmd转移归档\n\n```\n--生成的归档日志\nASMCMD> ls\n1_22_854775184.dbf\n1_23_854775184.dbf\n1_24_854775184.dbf\n1_25_854775184.dbf\n1_26_854775184.dbf\n1_27_854775184.dbf\n1_28_854775184.dbf\n1_29_854775184.dbf\n1_30_854775184.dbf\n1_31_854775184.dbf\n1_32_854775184.dbf\n1_33_854775184.dbf\n1_34_854775184.dbf\n1_35_854775184.dbf\n1_36_854775184.dbf\n1_37_854775184.dbf\n1_38_854775184.dbf\n1_39_854775184.dbf\n--copy走，无法使用通配符是一件很痛苦的事情\nASMCMD> cp 1_23_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_23_854775184.dbf -> /u02/backupset/1_23_854775184.dbf\nASMCMD> cp 1_24_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_24_854775184.dbf -> /u02/backupset/1_24_854775184.dbf\nASMCMD> cp 1_25_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_25_854775184.dbf -> /u02/backupset/1_25_854775184.dbf\nASMCMD> cp 1_26_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_26_854775184.dbf -> /u02/backupset/1_26_854775184.dbf\nASMCMD> cp 1_27_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_27_854775184.dbf -> /u02/backupset/1_27_854775184.dbf\nASMCMD> cp 1_28_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_28_854775184.dbf -> /u02/backupset/1_28_854775184.dbf\nASMCMD> cp 1_29_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_29_854775184.dbf -> /u02/backupset/1_29_854775184.dbf\nASMCMD> cp 1_3* /u02/backupset\ncopying +Data/archive_log/1_30_854775184.dbf -> /u02/backupset/1_30_854775184.dbf\nASMCMD> cp 1_31_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_31_854775184.dbf -> /u02/backupset/1_31_854775184.dbf\nASMCMD> cp 1_32_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_32_854775184.dbf -> /u02/backupset/1_32_854775184.dbf\nASMCMD> cp 1_33_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_33_854775184.dbf -> /u02/backupset/1_33_854775184.dbf\nASMCMD> cp 1_34_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_34_854775184.dbf -> /u02/backupset/1_34_854775184.dbf\nASMCMD> cp 1_35_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_35_854775184.dbf -> /u02/backupset/1_35_854775184.dbf\nASMCMD> cp 1_36_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_36_854775184.dbf -> /u02/backupset/1_36_854775184.dbf\nASMCMD> cp 1_37_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_37_854775184.dbf -> /u02/backupset/1_37_854775184.dbf\nASMCMD> cp 1_38_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_38_854775184.dbf -> /u02/backupset/1_38_854775184.dbf\nASMCMD> cp 1_39_854775184.dbf /u02/backupset\ncopying +Data/archive_log/1_39_854775184.dbf -> /u02/backupset/1_39_854775184.dbf\n```\n### 查看当前的redo状态,记住当前redo的seq号\n```sql\nSQL> select group#,SEQUENCE# ,MEMBERS,ARCHIVED,STATUS from v$log;\n\n    GROUP#  SEQUENCE#    MEMBERS ARC STATUS\n---------- ---------- ---------- --- ----------------\n         1         40          2 NO  CURRENT\n         2         38          2 YES INACTIVE\n         3         39          2 YES INACTIVE\n ```\n### 查看redo文件\n ```sql\n SQL> select GROUP#,STATUS,MEMBER  from v$logfile;\n\n    GROUP# STATUS  MEMBER\n---------- ------- --------------------------------------------------------------------------------\n         3         +DATA/min/onlinelog/group_3.266.854775193\n         3         +DATA/min/onlinelog/group_3.267.854775195\n         2         +DATA/min/onlinelog/group_2.264.854775189\n         2         +DATA/min/onlinelog/group_2.265.854775191\n         1         +DATA/min/onlinelog/group_1.262.854775185\n         1         +DATA/min/onlinelog/group_1.263.854775187\n ```\n >使用asmcmd拷贝并改名，这个时候我已经关闭了源库\n\n```\nASMCMD> cd onlinelog\nASMCMD>\nASMCMD> ls\ngroup_1.262.854775185\ngroup_1.263.854775187\ngroup_2.264.854775189\ngroup_2.265.854775191\ngroup_3.266.854775193\ngroup_3.267.854775195\n\nASMCMD> cp group_1.262.854775185 /u02/backupset/redo1a.log\ncopying +Data/min/onlinelog/group_1.262.854775185 -> /u02/backupset/redo1a.log\nASMCMD> cp group_1.263.854775187 /u02/backupset/redo1b.log\ncopying +Data/min/onlinelog/group_1.263.854775187 -> /u02/backupset/redo1b.log\nASMCMD> cp group_2.264.854775189 /u02/backupset/redo2a.log\ncopying +Data/min/onlinelog/group_2.264.854775189 -> /u02/backupset/redo2a.log\nASMCMD> cp group_2.265.854775191 /u02/backupset/redo2b.log\ncopying +Data/min/onlinelog/group_2.265.854775191 -> /u02/backupset/redo2b.log\nASMCMD> cp group_3.266.854775193 /u02/backupset/redo3a.log\ncopying +Data/min/onlinelog/group_3.266.854775193 -> /u02/backupset/redo3a.log\nASMCMD> cp group_3.267.854775195 /u02/backupset/redo3b.log\ncopying +Data/min/onlinelog/group_3.267.854775195 -> /u02/backupset/redo3b.log\n```\n## 3.  目标机器恢复\n这一步之前已经在目标主机安装好oracle软件，安装过程不再赘述，直接记录恢复过程\n这里直接从备份中恢复pfile（比较懒，不想手动准备），无参数文件，rman会启动一个傻瓜实例，供我们恢复参数文件。\n###从备份中恢复参数文件\n```sql\nRMAN> startup nomount\n\nstartup failed: ORA-01078: failure in processing system parameters\nLRM-00109: could not open parameter file '/home/oracle/app/oracle/product/11.2.0/dbhome_1/dbs/initmin.ora'\n\nstarting Oracle instance without parameter file for retrieval of spfile\nOracle instance started\n\nTotal System Global Area    1068937216 bytes\n\nFixed Size                     2260088 bytes\nVariable Size                281019272 bytes\nDatabase Buffers             780140544 bytes\nRedo Buffers                   5517312 bytes\n\n\nRMAN> restore spfile to pfile '/home/oracle/app/oracle/product/11.2.0/dbhome_1/dbs/initmin.ora' from '/u01/rmanbackup/ctl2.rman';\n\nStarting restore at 18-SEP-15\nusing target database control file instead of recovery catalog\nallocated channel: ORA_DISK_1\nchannel ORA_DISK_1: SID=171 device type=DISK\n\nchannel ORA_DISK_1: restoring spfile from AUTOBACKUP /u01/rmanbackup/ctl2.rman\nchannel ORA_DISK_1: SPFILE restore from AUTOBACKUP complete\nFinished restore at 18-SEP-15\n\nRMAN> shutdown abort\n\nOracle instance shut down\n```\n### 创建目录，修改参数文件\n```bash\n[oracle@rman_newhost u01]$ mkdir -p /u01/app/oracle/admin/min/adump\n[oracle@rman_newhost u01]$ mkdir -p /u01/app/oracle/fast_recovery_area\n[oracle@rman_newhost u01]$ mkdir -p /u01/app/oracle/archived_log\n[oracle@rman_newhost u01]$ mkdir -p /u01/app/oracle/oradata/min\n*.audit_file_dest='/u01/app/oracle/admin/min/adump'\n*.audit_trail='db'\n*.compatible='11.2.0.4.0'\n*.control_files='/u01/app/oracle/fast_recovery_area/control01.ctl','/u01/app/oracle/oradata/min/control02.ctl'\n*.db_block_size=8192\n*.db_domain=''\n*.db_name='min'\n*.db_recovery_file_dest='/u01/app/oracle/fast_recovery_area'\n*.db_recovery_file_dest_size=4385144832\n*.diagnostic_dest='/u01/app/oracle'\n*.dispatchers='(PROTOCOL=TCP) (SERVICE=minXDB)'\n*.log_archive_dest_1='location=/u01/app/oracle/archived_log'\n*.log_checkpoints_to_alert=TRUE\n*.memory_target=1394606080\n*.open_cursors=300\n*.processes=1500\n*.remote_login_passwordfile='EXCLUSIVE'\n*.sessions=1655\n*.undo_tablespace='UNDOTBS1'\n```\n### 启动到nomount状态，恢复控制文件\n```sql\nRMAN> startup nomount\n\nconnected to target database (not started)\nOracle instance started\n\nTotal System Global Area    1402982400 bytes\n\nFixed Size                     2253184 bytes\nVariable Size               1275072128 bytes\nDatabase Buffers             117440512 bytes\nRedo Buffers                   8216576 bytes\n\nRMAN> restore controlfile from '/u01/rmanbackup/ctl2.rman';\n\nStarting restore at 18-SEP-15\nallocated channel: ORA_DISK_1\nchannel ORA_DISK_1: SID=1146 device type=DISK\n\nchannel ORA_DISK_1: restoring control file\nchannel ORA_DISK_1: restore complete, elapsed time: 00:00:01\noutput file name=/u01/app/oracle/fast_recovery_area/control01.ctl\noutput file name=/u01/app/oracle/oradata/min/control02.ctl\nFinished restore at 18-SEP-15\n\nRMAN> alter database mount;\n\ndatabase mounted\nreleased channel: ORA_DISK_1\n```\n### 将redo文件和归档日志移动到对应目录下\n```bash\n[oracle@rman_newhost rmanbackup]$ mv redo* /u01/app/oracle/oradata/min\n[oracle@rman_newhost rmanbackup]$ ll /u01/app/oracle/oradata/min\n总用量 316744\n-rw-r-----. 1 oracle oinstall 9748480 9月 18 00:34 control02.ctl\n-rw-r--r--. 1 oracle oinstall 52429312 9月 17 23:00 redo1a.log\n-rw-r--r--. 1 oracle oinstall 52429312 9月 17 23:01 redo1b.log\n-rw-r--r--. 1 oracle oinstall 52429312 9月 17 23:01 redo2a.log\n-rw-r--r--. 1 oracle oinstall 52429312 9月 17 23:01 redo2b.log\n-rw-r--r--. 1 oracle oinstall 52429312 9月 17 23:02 redo3a.log\n-rw-r--r--. 1 oracle oinstall 52429312 9月 17 23:02 redo3b.log\n[oracle@rman_newhost rmanbackup]$ mv 1_* /u01/app/oracle/archived_log\n[oracle@rman_newhost rmanbackup]$ ll /u01/app/oracle/archived_log\n总用量 809056\n-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:48 1_22_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 39179776 9月 17 22:49 1_23_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:49 1_24_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:50 1_25_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:50 1_26_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 48581120 9月 17 22:50 1_27_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:51 1_28_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 42950144 9月 17 22:51 1_29_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:51 1_30_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 50134016 9月 17 22:53 1_31_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:53 1_32_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 46714368 9月 17 22:53 1_33_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 44308480 9月 17 22:54 1_34_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:54 1_35_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:54 1_36_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:54 1_37_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:55 1_38_854775184.dbf\n-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:55 1_39_854775184.dbf\n```\n### 注册备份集\n下面一步的操作是删掉控制文件中对备份的记录信息，因为这是源库备份恢复过来的，我们要删掉老的备份信息，将备份重新注册，不删也没关系，crosscheck以后你会发现，原来的备份状态都是expired的\n>利用crosscheck删除控制文件中的备份记录\n\n```sql\nRMAN> list backup summary;\n\n\nList of Backups\n===============\nKey     TY LV S Device Type Completion Time #Pieces #Copies Compressed Tag\n------- -- -- - ----------- --------------- ------- ------- ---------- ---\n9       B  0  A DISK        17-SEP-15       1       1       NO         DB_RMAN\n10      B  0  A DISK        17-SEP-15       1       1       NO         DB_RMAN\n11      B  F  A DISK        17-SEP-15       1       1       NO         TAG20150917T221650\n12      B  A  A DISK        17-SEP-15       1       1       NO         ARC_RMAN\n13      B  A  A DISK        17-SEP-15       1       1       NO         ARC_RMAN\n\nRMAN> crosscheck backup;\n\nStarting implicit crosscheck backup at 18-SEP-15\nallocated channel: ORA_DISK_1\nchannel ORA_DISK_1: SID=1146 device type=DISK\nallocated channel: ORA_DISK_2\nchannel ORA_DISK_2: SID=10 device type=DISK\nallocated channel: ORA_DISK_3\nchannel ORA_DISK_3: SID=1147 device type=DISK\nallocated channel: ORA_DISK_4\nchannel ORA_DISK_4: SID=11 device type=DISK\nCrosschecked 5 objects\nFinished implicit crosscheck backup at 18-SEP-15\n\nStarting implicit crosscheck copy at 18-SEP-15\nusing channel ORA_DISK_1\nusing channel ORA_DISK_2\nusing channel ORA_DISK_3\nusing channel ORA_DISK_4\nFinished implicit crosscheck copy at 18-SEP-15\n\nsearching for all files in the recovery area\ncataloging files...\nno files cataloged\n\nusing channel ORA_DISK_1\nusing channel ORA_DISK_2\nusing channel ORA_DISK_3\nusing channel ORA_DISK_4\ncrosschecked backup piece: found to be 'EXPIRED'\nbackup piece handle=+DATA/backup/db_0aqhdno6_1_1 RECID=9 STAMP=890691334\ncrosschecked backup piece: found to be 'EXPIRED'\nbackup piece handle=+DATA/backup/db_09qhdno6_1_1 RECID=10 STAMP=890691334\ncrosschecked backup piece: found to be 'EXPIRED'\nbackup piece handle=+DATA/backup/ctl_atuo_c-2496627597-20150917-00 RECID=11 STAMP=890691411\ncrosschecked backup piece: found to be 'EXPIRED'\nbackup piece handle=+DATA/backup/arc_0dqhdnqq_1_1 RECID=12 STAMP=890691418\ncrosschecked backup piece: found to be 'EXPIRED'\nbackup piece handle=+DATA/backup/arc_0cqhdnqq_1_1 RECID=13 STAMP=890691418\nCrosschecked 5 objects\n\n\nRMAN> list backup;\n\n\nList of Backup Sets\n===================\n\n\nBS Key  Type LV Size       Device Type Elapsed Time Completion Time\n------- ---- -- ---------- ----------- ------------ ---------------\n9       Incr 0  433.65M    DISK        00:01:10     17-SEP-15\n        BP Key: 9   Status: EXPIRED  Compressed: NO  Tag: DB_RMAN\n        Piece Name: +DATA/backup/db_0aqhdno6_1_1\n  List of Datafiles in backup set 9\n  File LV Type Ckp SCN    Ckp Time  Name\n  ---- -- ---- ---------- --------- ----\n  2    0  Incr 1138043    17-SEP-15 +DATA/min/datafile/sysaux.257.854775097\n  3    0  Incr 1138043    17-SEP-15 +DATA/min/datafile/undotbs1.258.854775097\n\nBS Key  Type LV Size       Device Type Elapsed Time Completion Time\n------- ---- -- ---------- ----------- ------------ ---------------\n10      Incr 0  638.84M    DISK        00:01:10     17-SEP-15\n        BP Key: 10   Status: EXPIRED  Compressed: NO  Tag: DB_RMAN\n        Piece Name: +DATA/backup/db_09qhdno6_1_1\n  List of Datafiles in backup set 10\n  File LV Type Ckp SCN    Ckp Time  Name\n  ---- -- ---- ---------- --------- ----\n  1    0  Incr 1138042    17-SEP-15 +DATA/min/datafile/system.256.854775095\n  4    0  Incr 1138042    17-SEP-15 +DATA/min/datafile/users.259.854775097\n\nBS Key  Type LV Size       Device Type Elapsed Time Completion Time\n------- ---- -- ---------- ----------- ------------ ---------------\n11      Full    9.36M      DISK        00:00:01     17-SEP-15\n        BP Key: 11   Status: EXPIRED  Compressed: NO  Tag: TAG20150917T221650\n        Piece Name: +DATA/backup/ctl_atuo_c-2496627597-20150917-00\n  SPFILE Included: Modification time: 17-SEP-15\n  SPFILE db_unique_name: MIN\n  Control File Included: Ckp SCN: 1138347      Ckp time: 17-SEP-15\n\nBS Key  Size       Device Type Elapsed Time Completion Time\n------- ---------- ----------- ------------ ---------------\n12      2.00K      DISK        00:00:00     17-SEP-15\n        BP Key: 12   Status: EXPIRED  Compressed: NO  Tag: ARC_RMAN\n        Piece Name: +DATA/backup/arc_0dqhdnqq_1_1\n\n  List of Archived Logs in backup set 12\n  Thrd Seq     Low SCN    Low Time  Next SCN   Next Time\n  ---- ------- ---------- --------- ---------- ---------\n  1    21      1138364    17-SEP-15 1138372    17-SEP-15\n\nBS Key  Size       Device Type Elapsed Time Completion Time\n------- ---------- ----------- ------------ ---------------\n13      30.99M     DISK        00:00:02     17-SEP-15\n        BP Key: 13   Status: EXPIRED  Compressed: NO  Tag: ARC_RMAN\n        Piece Name: +DATA/backup/arc_0cqhdnqq_1_1\n\n  List of Archived Logs in backup set 13\n  Thrd Seq     Low SCN    Low Time  Next SCN   Next Time\n  ---- ------- ---------- --------- ---------- ---------\n  1    20      1127220    17-SEP-15 1138364    17-SEP-15\n\nRMAN> list archivelog all;\n\nspecification does not match any archived log in the repository\n\n\nRMAN> report obsolete;\n\nRMAN retention policy will be applied to the command\nRMAN retention policy is set to recovery window of 7 days\nno obsolete backups found\n\nRMAN> list expired backup;\n\n\nList of Backup Sets\n===================\n\n\nBS Key  Type LV Size       Device Type Elapsed Time Completion Time\n------- ---- -- ---------- ----------- ------------ ---------------\n9       Incr 0  433.65M    DISK        00:01:10     17-SEP-15\n        BP Key: 9   Status: EXPIRED  Compressed: NO  Tag: DB_RMAN\n        Piece Name: +DATA/backup/db_0aqhdno6_1_1\n  List of Datafiles in backup set 9\n  File LV Type Ckp SCN    Ckp Time  Name\n  ---- -- ---- ---------- --------- ----\n  2    0  Incr 1138043    17-SEP-15 +DATA/min/datafile/sysaux.257.854775097\n  3    0  Incr 1138043    17-SEP-15 +DATA/min/datafile/undotbs1.258.854775097\n\nBS Key  Type LV Size       Device Type Elapsed Time Completion Time\n------- ---- -- ---------- ----------- ------------ ---------------\n10      Incr 0  638.84M    DISK        00:01:10     17-SEP-15\n        BP Key: 10   Status: EXPIRED  Compressed: NO  Tag: DB_RMAN\n        Piece Name: +DATA/backup/db_09qhdno6_1_1\n  List of Datafiles in backup set 10\n  File LV Type Ckp SCN    Ckp Time  Name\n  ---- -- ---- ---------- --------- ----\n  1    0  Incr 1138042    17-SEP-15 +DATA/min/datafile/system.256.854775095\n  4    0  Incr 1138042    17-SEP-15 +DATA/min/datafile/users.259.854775097\n\nBS Key  Type LV Size       Device Type Elapsed Time Completion Time\n------- ---- -- ---------- ----------- ------------ ---------------\n11      Full    9.36M      DISK        00:00:01     17-SEP-15\n        BP Key: 11   Status: EXPIRED  Compressed: NO  Tag: TAG20150917T221650\n        Piece Name: +DATA/backup/ctl_atuo_c-2496627597-20150917-00\n  SPFILE Included: Modification time: 17-SEP-15\n  SPFILE db_unique_name: MIN\n  Control File Included: Ckp SCN: 1138347      Ckp time: 17-SEP-15\n\nBS Key  Size       Device Type Elapsed Time Completion Time\n------- ---------- ----------- ------------ ---------------\n12      2.00K      DISK        00:00:00     17-SEP-15\n        BP Key: 12   Status: EXPIRED  Compressed: NO  Tag: ARC_RMAN\n        Piece Name: +DATA/backup/arc_0dqhdnqq_1_1\n\n  List of Archived Logs in backup set 12\n  Thrd Seq     Low SCN    Low Time  Next SCN   Next Time\n  ---- ------- ---------- --------- ---------- ---------\n  1    21      1138364    17-SEP-15 1138372    17-SEP-15\n\nBS Key  Size       Device Type Elapsed Time Completion Time\n------- ---------- ----------- ------------ ---------------\n13      30.99M     DISK        00:00:02     17-SEP-15\n        BP Key: 13   Status: EXPIRED  Compressed: NO  Tag: ARC_RMAN\n        Piece Name: +DATA/backup/arc_0cqhdnqq_1_1\n\n  List of Archived Logs in backup set 13\n  Thrd Seq     Low SCN    Low Time  Next SCN   Next Time\n  ---- ------- ---------- --------- ---------- ---------\n  1    20      1127220    17-SEP-15 1138364    17-SEP-15\n\nRMAN> delete noprompt expired backup;\n\nusing channel ORA_DISK_1\nusing channel ORA_DISK_2\nusing channel ORA_DISK_3\nusing channel ORA_DISK_4\n\nList of Backup Pieces\nBP Key  BS Key  Pc# Cp# Status      Device Type Piece Name\n------- ------- --- --- ----------- ----------- ----------\n9       9       1   1   EXPIRED     DISK        +DATA/backup/db_0aqhdno6_1_1\n10      10      1   1   EXPIRED     DISK        +DATA/backup/db_09qhdno6_1_1\n11      11      1   1   EXPIRED     DISK        +DATA/backup/ctl_atuo_c-2496627597-20150917-00\n12      12      1   1   EXPIRED     DISK        +DATA/backup/arc_0dqhdnqq_1_1\n13      13      1   1   EXPIRED     DISK        +DATA/backup/arc_0cqhdnqq_1_1\ndeleted backup piece\nbackup piece handle=+DATA/backup/db_0aqhdno6_1_1 RECID=9 STAMP=890691334\ndeleted backup piece\nbackup piece handle=+DATA/backup/db_09qhdno6_1_1 RECID=10 STAMP=890691334\ndeleted backup piece\nbackup piece handle=+DATA/backup/ctl_atuo_c-2496627597-20150917-00 RECID=11 STAMP=890691411\ndeleted backup piece\nbackup piece handle=+DATA/backup/arc_0dqhdnqq_1_1 RECID=12 STAMP=890691418\ndeleted backup piece\nbackup piece handle=+DATA/backup/arc_0cqhdnqq_1_1 RECID=13 STAMP=890691418\nDeleted 5 EXPIRED objects\n\n\nRMAN> list backup;\n\nspecification does not match any backup in the repository\n```\n>重新注册备份，并观察控制文件中的备份信息，和数据库结构的信息\n\n```sql\nRMAN> catalog start with '/u01/rmanbackup';\n\nsearching for all files that match the pattern /u01/rmanbackup\n\nList of Files Unknown to the Database\n=====================================\nFile Name: /u01/rmanbackup/arc1.rman\nFile Name: /u01/rmanbackup/db1.rman\nFile Name: /u01/rmanbackup/ctl2.rman\nFile Name: /u01/rmanbackup/ctl1.rman\nFile Name: /u01/rmanbackup/db2.rman\nFile Name: /u01/rmanbackup/arc2.rman\n\nDo you really want to catalog the above files (enter YES or NO)? yes\ncataloging files...\ncataloging done\n\nList of Cataloged Files\n=======================\nFile Name: /u01/rmanbackup/arc1.rman\nFile Name: /u01/rmanbackup/db1.rman\nFile Name: /u01/rmanbackup/ctl2.rman\nFile Name: /u01/rmanbackup/ctl1.rman\nFile Name: /u01/rmanbackup/db2.rman\nFile Name: /u01/rmanbackup/arc2.rman\n\nRMAN> list backup summary;\n\n\nList of Backups\n===============\nKey     TY LV S Device Type Completion Time #Pieces #Copies Compressed Tag\n------- -- -- - ----------- --------------- ------- ------- ---------- ---\n14      B  A  A DISK        17-SEP-15       1       1       NO         ARC_RMAN\n15      B  0  A DISK        17-SEP-15       1       1       NO         DB_RMAN\n16      B  0  A DISK        17-SEP-15       1       1       NO         DB_RMAN\n17      B  A  A DISK        17-SEP-15       1       1       NO         ARC_RMAN\n\n--数据文件、临时文件的记录还是源库的信息，一会儿恢复的时候要setnewname\nRMAN> report schema;\n\nRMAN-06139: WARNING: control file is not current for REPORT SCHEMA\nReport of database schema for database with db_unique_name MIN\n\nList of Permanent Datafiles\n===========================\nFile Size(MB) Tablespace           RB segs Datafile Name\n---- -------- -------------------- ------- ------------------------\n1    0        SYSTEM               ***     +DATA/min/datafile/system.256.854775095\n2    0        SYSAUX               ***     +DATA/min/datafile/sysaux.257.854775097\n3    0        UNDOTBS1             ***     +DATA/min/datafile/undotbs1.258.854775097\n4    0        USERS                ***     +DATA/min/datafile/users.259.854775097\n\nList of Temporary Files\n=======================\nFile Size(MB) Tablespace           Maxsize(MB) Tempfile Name\n---- -------- -------------------- ----------- --------------------\n1    20       TEMP                 32767       +DATA/min/tempfile/temp.268.854775211\n\n--你会发现这是老的控制文件，是我们0级备份里的，其中关于redo的状态记录，当前redo还停留在序列号22\nSQL> select GROUP#,SEQUENCE# ,STATUS,ARCHIVED  from v$log;\n\n    GROUP#  SEQUENCE# STATUS           ARC\n---------- ---------- ---------------- ---\n         1         22 CURRENT          NO\n         3         21 ACTIVE           YES\n         2         20 ACTIVE           YES\n\nSQL> desc v$logfile;\n Name                                      Null?    Type\n ----------------------------------------- -------- ----------------------------\n GROUP#                                             NUMBER\n STATUS                                             VARCHAR2(7)\n TYPE                                               VARCHAR2(7)\n MEMBER                                             VARCHAR2(513)\n IS_RECOVERY_DEST_FILE                              VARCHAR2(3)\n\n--redo的记录还是源库的信息，一会儿恢复的时候要setnewname\nSQL> col member for a80\nSQL> set line 200\nSQL> select GROUP#,STATUS,MEMBER from v$logfile;\n\n    GROUP# STATUS  MEMBER\n---------- ------- --------------------------------------------------------------------------------\n         3         +DATA/min/onlinelog/group_3.266.854775193\n         3         +DATA/min/onlinelog/group_3.267.854775195\n         2         +DATA/min/onlinelog/group_2.264.854775189\n         2         +DATA/min/onlinelog/group_2.265.854775191\n         1         +DATA/min/onlinelog/group_1.262.854775185\n         1         +DATA/min/onlinelog/group_1.263.854775187\n\n6 rows selected.\n```\n### 还原数据库\n```sql\nRMAN> RUN\n2>  {\n3>    ALLOCATE CHANNEL c1 DEVICE TYPE DISK;\n4>    ALLOCATE CHANNEL c2 DEVICE TYPE DISK;\n5>    set archivelog destination to \"/u01/app/oracle/archived_log\";\n6>       set newname for datafile 1 to \"/u01/app/oracle/oradata/min/system01.dbf\";\n7>       set newname for datafile 2 to \"/u01/app/oracle/oradata/min/sysaux01.dbf\";\n8>       set newname for datafile 3 to \"/u01/app/oracle/oradata/min/undotbs01.dbf\";\n9>       set newname for datafile 4 to \"/u01/app/oracle/oradata/min/users01.dbf\";\n10>      set newname for tempfile 1 to \"/u01/app/oracle/oradata/min/temp01.dbf\";\n11>      SQL \"ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_1.262.854775185''  to  ''/u01/app/oracle/oradata/min/redo1a.log'' \";\n12>      SQL \"ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_1.263.854775187''  to  ''/u01/app/oracle/oradata/min/redo1b.log'' \";\n13>      SQL \"ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_2.264.854775189''  to  ''/u01/app/oracle/oradata/min/redo2a.log'' \";\n14>      SQL \"ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_2.265.854775191''  to  ''/u01/app/oracle/oradata/min/redo2b.log'' \";\n15>      SQL \"ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_3.266.854775193''  to  ''/u01/app/oracle/oradata/min/redo3a.log'' \";\n16>      SQL \"ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_3.267.854775195''  to  ''/u01/app/oracle/oradata/min/redo3b.log'' \";\n17>    RESTORE DATABASE;\n18>    SWITCH DATAFILE ALL;\n19>    switch tempfile all;\n20>  }\n\nreleased channel: ORA_DISK_1\nreleased channel: ORA_DISK_2\nreleased channel: ORA_DISK_3\nreleased channel: ORA_DISK_4\nallocated channel: c1\nchannel c1: SID=1146 device type=DISK\n\nallocated channel: c2\nchannel c2: SID=11 device type=DISK\n\nexecuting command: SET ARCHIVELOG DESTINATION\n\nexecuting command: SET NEWNAME\n\nexecuting command: SET NEWNAME\n\nexecuting command: SET NEWNAME\n\nexecuting command: SET NEWNAME\n\nexecuting command: SET NEWNAME\n\nsql statement: ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_1.262.854775185''  to  ''/u01/app/oracle/oradata/min/redo1a.log''\n\nsql statement: ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_1.263.854775187''  to  ''/u01/app/oracle/oradata/min/redo1b.log''\n\nsql statement: ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_2.264.854775189''  to  ''/u01/app/oracle/oradata/min/redo2a.log''\n\nsql statement: ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_2.265.854775191''  to  ''/u01/app/oracle/oradata/min/redo2b.log''\n\nsql statement: ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_3.266.854775193''  to  ''/u01/app/oracle/oradata/min/redo3a.log''\n\nsql statement: ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_3.267.854775195''  to  ''/u01/app/oracle/oradata/min/redo3b.log''\n\nStarting restore at 18-SEP-15\n\nskipping datafile 2; already restored to file /u01/app/oracle/oradata/min/sysaux01.dbf\nchannel c1: starting datafile backup set restore\nchannel c1: specifying datafile(s) to restore from backup set\nchannel c1: restoring datafile 00001 to /u01/app/oracle/oradata/min/system01.dbf\nchannel c1: restoring datafile 00004 to /u01/app/oracle/oradata/min/users01.dbf\nchannel c1: reading from backup piece /u01/rmanbackup/db2.rman\nchannel c2: starting datafile backup set restore\nchannel c2: specifying datafile(s) to restore from backup set\nchannel c2: restoring datafile 00003 to /u01/app/oracle/oradata/min/undotbs01.dbf\nchannel c2: reading from backup piece /u01/rmanbackup/db1.rman\nchannel c2: piece handle=/u01/rmanbackup/db1.rman tag=DB_RMAN\nchannel c2: restored backup piece 1\nchannel c2: restore complete, elapsed time: 00:00:08\nchannel c1: piece handle=/u01/rmanbackup/db2.rman tag=DB_RMAN\nchannel c1: restored backup piece 1\nchannel c1: restore complete, elapsed time: 00:00:36\nFinished restore at 18-SEP-15\n\ndatafile 1 switched to datafile copy\ninput datafile copy RECID=5 STAMP=890701322 file name=/u01/app/oracle/oradata/min/system01.dbf\ndatafile 2 switched to datafile copy\ninput datafile copy RECID=6 STAMP=890701322 file name=/u01/app/oracle/oradata/min/sysaux01.dbf\ndatafile 3 switched to datafile copy\ninput datafile copy RECID=7 STAMP=890701322 file name=/u01/app/oracle/oradata/min/undotbs01.dbf\ndatafile 4 switched to datafile copy\ninput datafile copy RECID=8 STAMP=890701322 file name=/u01/app/oracle/oradata/min/users01.dbf\n\nrenamed tempfile 1 to /u01/app/oracle/oradata/min/temp01.dbf in control file\nreleased channel: c1\nreleased channel: c2\n\nRMAN>\n```\n>restore完毕，我们再来看一下控制文件中的信息\n\n```sql\nRMAN> report schema;\n\nRMAN-06139: WARNING: control file is not current for REPORT SCHEMA\nReport of database schema for database with db_unique_name MIN\n\nList of Permanent Datafiles\n===========================\nFile Size(MB) Tablespace           RB segs Datafile Name\n---- -------- -------------------- ------- ------------------------\n1    750      SYSTEM               ***     /u01/app/oracle/oradata/min/system01.dbf\n2    560      SYSAUX               ***     /u01/app/oracle/oradata/min/sysaux01.dbf\n3    100      UNDOTBS1             ***     /u01/app/oracle/oradata/min/undotbs01.dbf\n4    5        USERS                ***     /u01/app/oracle/oradata/min/users01.dbf\n\nList of Temporary Files\n=======================\nFile Size(MB) Tablespace           Maxsize(MB) Tempfile Name\n---- -------- -------------------- ----------- --------------------\n1    20       TEMP                 32767       /u01/app/oracle/oradata/min/temp01.dbf\n```\n### 完全恢复数据库\n```sql\nRMAN> recover database;\n\nStarting recover at 18-SEP-15\nallocated channel: ORA_DISK_1\nchannel ORA_DISK_1: SID=1146 device type=DISK\nallocated channel: ORA_DISK_2\nchannel ORA_DISK_2: SID=11 device type=DISK\nallocated channel: ORA_DISK_3\nchannel ORA_DISK_3: SID=1137 device type=DISK\nallocated channel: ORA_DISK_4\nchannel ORA_DISK_4: SID=10 device type=DISK\n\nstarting media recovery\n\narchived log for thread 1 with sequence 38 is already on disk as file /u01/app/oracle/oradata/min/redo2a.log\narchived log for thread 1 with sequence 39 is already on disk as file /u01/app/oracle/oradata/min/redo3a.log\narchived log for thread 1 with sequence 40 is already on disk as file /u01/app/oracle/oradata/min/redo1a.log\nchannel ORA_DISK_1: starting archived log restore to default destination\nchannel ORA_DISK_1: restoring archived log\narchived log thread=1 sequence=20\nchannel ORA_DISK_1: reading from backup piece /u01/rmanbackup/arc2.rman\nchannel ORA_DISK_2: starting archived log restore to default destination\nchannel ORA_DISK_2: restoring archived log\narchived log thread=1 sequence=21\nchannel ORA_DISK_2: reading from backup piece /u01/rmanbackup/arc1.rman\nchannel ORA_DISK_2: piece handle=/u01/rmanbackup/arc1.rman tag=ARC_RMAN\nchannel ORA_DISK_2: restored backup piece 1\nchannel ORA_DISK_2: restore complete, elapsed time: 00:00:01\nchannel ORA_DISK_1: piece handle=/u01/rmanbackup/arc2.rman tag=ARC_RMAN\nchannel ORA_DISK_1: restored backup piece 1\nchannel ORA_DISK_1: restore complete, elapsed time: 00:00:03\narchived log file name=/u01/app/oracle/archived_log/1_20_854775184.dbf thread=1 sequence=20\narchived log file name=/u01/app/oracle/archived_log/1_21_854775184.dbf thread=1 sequence=21\narchived log file name=/u01/app/oracle/archived_log/1_22_854775184.dbf thread=1 sequence=22\narchived log file name=/u01/app/oracle/archived_log/1_23_854775184.dbf thread=1 sequence=23\narchived log file name=/u01/app/oracle/archived_log/1_24_854775184.dbf thread=1 sequence=24\narchived log file name=/u01/app/oracle/archived_log/1_25_854775184.dbf thread=1 sequence=25\narchived log file name=/u01/app/oracle/archived_log/1_26_854775184.dbf thread=1 sequence=26\narchived log file name=/u01/app/oracle/archived_log/1_27_854775184.dbf thread=1 sequence=27\narchived log file name=/u01/app/oracle/archived_log/1_28_854775184.dbf thread=1 sequence=28\narchived log file name=/u01/app/oracle/archived_log/1_29_854775184.dbf thread=1 sequence=29\narchived log file name=/u01/app/oracle/archived_log/1_30_854775184.dbf thread=1 sequence=30\narchived log file name=/u01/app/oracle/archived_log/1_31_854775184.dbf thread=1 sequence=31\narchived log file name=/u01/app/oracle/archived_log/1_32_854775184.dbf thread=1 sequence=32\narchived log file name=/u01/app/oracle/archived_log/1_33_854775184.dbf thread=1 sequence=33\narchived log file name=/u01/app/oracle/archived_log/1_34_854775184.dbf thread=1 sequence=34\narchived log file name=/u01/app/oracle/archived_log/1_35_854775184.dbf thread=1 sequence=35\narchived log file name=/u01/app/oracle/archived_log/1_36_854775184.dbf thread=1 sequence=36\narchived log file name=/u01/app/oracle/archived_log/1_37_854775184.dbf thread=1 sequence=37\narchived log file name=/u01/app/oracle/oradata/min/redo2a.log thread=1 sequence=38\narchived log file name=/u01/app/oracle/oradata/min/redo3a.log thread=1 sequence=39\narchived log file name=/u01/app/oracle/oradata/min/redo1a.log thread=1 sequence=40\nmedia recovery complete, elapsed time: 00:00:43\nFinished recover at 18-SEP-15\n\nRMAN>\n```\n从恢复的日志可以看出，oracle会绕过38、39号的归档直接利用在线日志做恢复，oracle的聪明之处可见一斑！\n试着正常方式打开数据库，会发现报错：\n\n```sql\nRMAN> alter database open;\n\nRMAN-00571: ===========================================================\nRMAN-00569: =============== ERROR MESSAGE STACK FOLLOWS ===============\nRMAN-00571: ===========================================================\nRMAN-03002: failure of alter db command at 09/18/2015 01:04:41\nORA-01589: must use RESETLOGS or NORESETLOGS option for database open\n\n--看一下此时控制文件中的日志序列号，会发现没有前推，必须用resetlogs打开数据库\nSQL>  select group#,status,sequence# from v$log;\n\n    GROUP# STATUS            SEQUENCE#\n---------- ---------------- ----------\n         1 CURRENT                  22\n         3 ACTIVE                   21\n         2 ACTIVE                   20\nRMAN> alter database open resetlogs;\n\ndatabase opened\n```\n\n>使用resetlog的原因是recover命令只能修复控制文件中数据物理结构信息，而无法修改控制文件中的当前重做日志的序列号的信息，recover命令结束后，控制文件中的当前日志序列号还是陈旧的，若按常规方式打开数据库，将报错，为了抹去控制文件这个固执的念头，oracle采用重设日志的功能，日志序列号从1开始。此处虽然使用了resetlogs，但是因为“recover database”命令执行成功，所有提交的事务不会丢失，resetlogs仅仅是为了照顾还原的控制文件，与不完全恢复的resetlogs是不同的，至此恢复结束。\n\n```sql\nSQL> conn test/test\nERROR:\nORA-28002: the password will expire within 6 days\n\n\nConnected.\nSQL> select count(1) from t;\n\n  COUNT(1)\n----------\n   3000000\n```\n","slug":"oracle/backup-restore/RMAN-different-server-directory-full-restore","published":1,"updated":"2019-07-21T04:56:06.369Z","_id":"cjych78i90000f40eumrgqa5e","comments":1,"layout":"post","photos":[],"link":"","content":"<blockquote>\n<p>开始</p>\n</blockquote>\n<p>先说一下为什么要写这个异机完全恢复的blog，作为一个年轻的DBA，相信大多数都是备份长做而恢复不常做，我会经常担心我的生产库的服务器挂了怎么办，我的备份完好，但我们又没有容灾，我能否保证我的数据不丢失呢，所以就要rman利用备份重建，而如果此时我能找到完好无损的在线日志，我是不是可以完全恢复了呢，理论上大家都说可以，确从未在网上见到过完全恢复的事例（完全其实很简单，只是网上阐述了太多的不完全恢复，会让我觉得set until time等等是必备的其中一步），甚至oracle的官方网文档上也使用了“SET UNTIL SCN 123456;” 的案例，有鉴于此，我做了这个实验，并记录下来，跟大家分享，不见得这篇原创有多高深的技术和见解O(∩_∩)O</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">环境：</span><br><span class=\"line\">    源库：</span><br><span class=\"line\">        os：redhat 6.3 x64</span><br><span class=\"line\">        db: 11gr2 11.2.0.4</span><br><span class=\"line\">        存储方式：ASM</span><br><span class=\"line\">    目标库：</span><br><span class=\"line\">        os：redhat 6.5 x64</span><br><span class=\"line\">        db: 11gr2 11.2.0.4</span><br><span class=\"line\">        存储方式：文件系统</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"1-首先，源库进行rman备份\"><a href=\"#1-首先，源库进行rman备份\" class=\"headerlink\" title=\"1. 首先，源库进行rman备份\"></a>1. 首先，源库进行rman备份</h2><figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">--手动0级全库备份</span></span><br><span class=\"line\">run &#123;</span><br><span class=\"line\">    CONFIGURE RETENTION POLICY TO RECOVERY WINDOW OF 7 DAYS;</span><br><span class=\"line\">    CONFIGURE <span class=\"keyword\">BACKUP</span> OPTIMIZATION <span class=\"keyword\">ON</span>;</span><br><span class=\"line\">    CONFIGURE CONTROLFILE AUTOBACKUP ON;</span><br><span class=\"line\">    CONFIGURE DEVICE TYPE DISK PARALLELISM 4 <span class=\"keyword\">BACKUP</span> <span class=\"keyword\">TYPE</span> <span class=\"keyword\">TO</span> BACKUPSET;</span><br><span class=\"line\">    CONFIGURE CONTROLFILE AUTOBACKUP FORMAT FOR DEVICE TYPE DISK TO '+DATA/<span class=\"keyword\">backup</span>/ctl_atuo_%F<span class=\"string\">';</span></span><br><span class=\"line\"><span class=\"string\">    ALLOCATE CHANNEL c1 TYPE DISK;</span></span><br><span class=\"line\"><span class=\"string\">    ALLOCATE CHANNEL c2 TYPE DISK;</span></span><br><span class=\"line\"><span class=\"string\">    CROSSCHECK ARCHIVELOG ALL;</span></span><br><span class=\"line\"><span class=\"string\">    BACKUP INCREMENTAL LEVEL 0</span></span><br><span class=\"line\"><span class=\"string\">    DATABASE FORMAT '</span>+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/db_%U<span class=\"string\">' TAG '</span>db_rman<span class=\"string\">';</span></span><br><span class=\"line\"><span class=\"string\">    SQL '</span><span class=\"keyword\">ALTER</span> <span class=\"keyword\">SYSTEM</span> <span class=\"keyword\">ARCHIVE</span> <span class=\"keyword\">LOG</span> <span class=\"keyword\">CURRENT</span><span class=\"string\">';</span></span><br><span class=\"line\"><span class=\"string\">    BACKUP ARCHIVELOG ALL FORMAT '</span>+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/arc_%U<span class=\"string\">' TAG '</span>ARC_rman<span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\">    DELETE INPUT;</span></span><br><span class=\"line\"><span class=\"string\">    DELETE NOPROMPT OBSOLETE;</span></span><br><span class=\"line\"><span class=\"string\">    RELEASE CHANNEL c1;</span></span><br><span class=\"line\"><span class=\"string\">    RELEASE CHANNEL c2;</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n<h3 id=\"观察备份的文件，此处是ASM分别用asmcmd和rman查看\"><a href=\"#观察备份的文件，此处是ASM分别用asmcmd和rman查看\" class=\"headerlink\" title=\"观察备份的文件，此处是ASM分别用asmcmd和rman查看\"></a>观察备份的文件，此处是ASM分别用asmcmd和rman查看</h3><figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">ASMCMD&gt; ls</span><br><span class=\"line\">arc_0cqhdnqq_1_1</span><br><span class=\"line\">arc_0dqhdnqq_1_1</span><br><span class=\"line\">ctl_atuo_c-2496627597-20150917-00</span><br><span class=\"line\">ctl_atuo_c-2496627597-20150917-01</span><br><span class=\"line\">db_09qhdno6_1_1</span><br><span class=\"line\">db_0aqhdno6_1_1</span><br><span class=\"line\">ASMCMD&gt; pwd</span><br><span class=\"line\">+Data/<span class=\"keyword\">backup</span></span><br><span class=\"line\">ASMCMD&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt; <span class=\"keyword\">list</span> <span class=\"keyword\">backup</span> summary;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">List of Backups</span><br><span class=\"line\">===============</span><br><span class=\"line\">Key     TY LV S Device Type Completion Time <span class=\"comment\">#Pieces #Copies Compressed Tag</span></span><br><span class=\"line\"><span class=\"comment\">------- -- -- - ----------- --------------- ------- ------- ---------- ---</span></span><br><span class=\"line\">9       B  0  A DISK        17-SEP-15       1       1       NO         DB_RMAN</span><br><span class=\"line\">10      B  0  A DISK        17-SEP-15       1       1       NO         DB_RMAN</span><br><span class=\"line\">11      B  F  A DISK        17-SEP-15       1       1       NO         TAG20150917T221650</span><br><span class=\"line\">12      B  A  A DISK        17-SEP-15       1       1       NO         ARC_RMAN</span><br><span class=\"line\">13      B  A  A DISK        17-SEP-15       1       1       NO         ARC_RMAN</span><br><span class=\"line\">14      B  F  A DISK        17-SEP-15       1       1       NO         TAG20150917T221703</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"为了试验restore之后recover应用归档日志的情况，我在0级备份之后再生成一些归档日志，脚本如下：\"><a href=\"#为了试验restore之后recover应用归档日志的情况，我在0级备份之后再生成一些归档日志，脚本如下：\" class=\"headerlink\" title=\"为了试验restore之后recover应用归档日志的情况，我在0级备份之后再生成一些归档日志，脚本如下：\"></a>为了试验restore之后recover应用归档日志的情况，我在0级备份之后再生成一些归档日志，脚本如下：</h3><figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">declare</span></span><br><span class=\"line\">  i <span class=\"built_in\">integer</span>;</span><br><span class=\"line\"><span class=\"keyword\">begin</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"number\">1.</span><span class=\"number\">.3000000</span> <span class=\"keyword\">loop</span></span><br><span class=\"line\">    <span class=\"keyword\">insert</span> <span class=\"keyword\">into</span> t <span class=\"keyword\">values</span>(i,<span class=\"string\">'aaaaaaaaaaaaaaaaaaaaa'</span>);</span><br><span class=\"line\">    <span class=\"keyword\">end</span> <span class=\"keyword\">loop</span>;</span><br><span class=\"line\"><span class=\"keyword\">end</span>;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"向测试表T中插入200万行数据，看归档的日志：\"><a href=\"#向测试表T中插入200万行数据，看归档的日志：\" class=\"headerlink\" title=\"向测试表T中插入200万行数据，看归档的日志：\"></a>向测试表T中插入200万行数据，看归档的日志：</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">ASMCMD&gt; ls</span><br><span class=\"line\">1_22_854775184.dbf</span><br><span class=\"line\">1_23_854775184.dbf</span><br><span class=\"line\">1_24_854775184.dbf</span><br><span class=\"line\">1_25_854775184.dbf</span><br><span class=\"line\">1_26_854775184.dbf</span><br><span class=\"line\">1_27_854775184.dbf</span><br><span class=\"line\">1_28_854775184.dbf</span><br><span class=\"line\">1_29_854775184.dbf</span><br><span class=\"line\">1_30_854775184.dbf</span><br><span class=\"line\">1_31_854775184.dbf</span><br><span class=\"line\">1_32_854775184.dbf</span><br><span class=\"line\">1_33_854775184.dbf</span><br><span class=\"line\">1_34_854775184.dbf</span><br><span class=\"line\">1_35_854775184.dbf</span><br><span class=\"line\">1_36_854775184.dbf</span><br><span class=\"line\">1_37_854775184.dbf</span><br><span class=\"line\">1_38_854775184.dbf</span><br><span class=\"line\">1_39_854775184.dbf</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"查看T表的行数\"><a href=\"#查看T表的行数\" class=\"headerlink\" title=\"查看T表的行数\"></a>查看T表的行数</h3><figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select count(1) from t;</span><br><span class=\"line\"></span><br><span class=\"line\">  COUNT(1)</span><br><span class=\"line\"><span class=\"comment\">----------</span></span><br><span class=\"line\">   3000000</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-转移备份\"><a href=\"#2-转移备份\" class=\"headerlink\" title=\"2. 转移备份\"></a>2. 转移备份</h2><p>现在要把rman备份，备份之后的归档，源库关闭之后的在线redo文件拷贝到备库，这里稍微麻烦一点，涉及到从asm中拷贝文件，我这里使用2中方法，rman的backup as cpoy以及asmcmd的cp命令，如下所示：</p>\n<blockquote>\n<p>rman copy备份集</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">--这里是copy 0级备份</span></span><br><span class=\"line\"><span class=\"keyword\">backup</span> <span class=\"keyword\">as</span> copy backupset <span class=\"number\">9</span> <span class=\"keyword\">format</span> <span class=\"string\">'/u01/backupset/db2.rman'</span>;</span><br><span class=\"line\"><span class=\"keyword\">backup</span> <span class=\"keyword\">as</span> copy backupset <span class=\"number\">10</span> <span class=\"keyword\">format</span> <span class=\"string\">'/u01/backupset/db2.rman'</span>;</span><br><span class=\"line\"><span class=\"keyword\">backup</span> <span class=\"keyword\">as</span> copy backupset <span class=\"number\">11</span> <span class=\"keyword\">format</span> <span class=\"string\">'/u01/backupset/ctl1.rman'</span>;</span><br><span class=\"line\"><span class=\"keyword\">backup</span> <span class=\"keyword\">as</span> copy backupset <span class=\"number\">12</span> <span class=\"keyword\">format</span> <span class=\"string\">'/u01/backupset/arc1.rman'</span>;</span><br><span class=\"line\"><span class=\"keyword\">backup</span> <span class=\"keyword\">as</span> copy backupset <span class=\"number\">13</span> <span class=\"keyword\">format</span> <span class=\"string\">'/u01/backupset/arc2.rman'</span>;</span><br><span class=\"line\"><span class=\"keyword\">backup</span> <span class=\"keyword\">as</span> copy backupset <span class=\"number\">14</span> <span class=\"keyword\">format</span> <span class=\"string\">'/u01/backupset/ctl2.rman'</span>;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>asmcmd转移归档</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">--生成的归档日志</span><br><span class=\"line\">ASMCMD&gt; ls</span><br><span class=\"line\">1_22_854775184.dbf</span><br><span class=\"line\">1_23_854775184.dbf</span><br><span class=\"line\">1_24_854775184.dbf</span><br><span class=\"line\">1_25_854775184.dbf</span><br><span class=\"line\">1_26_854775184.dbf</span><br><span class=\"line\">1_27_854775184.dbf</span><br><span class=\"line\">1_28_854775184.dbf</span><br><span class=\"line\">1_29_854775184.dbf</span><br><span class=\"line\">1_30_854775184.dbf</span><br><span class=\"line\">1_31_854775184.dbf</span><br><span class=\"line\">1_32_854775184.dbf</span><br><span class=\"line\">1_33_854775184.dbf</span><br><span class=\"line\">1_34_854775184.dbf</span><br><span class=\"line\">1_35_854775184.dbf</span><br><span class=\"line\">1_36_854775184.dbf</span><br><span class=\"line\">1_37_854775184.dbf</span><br><span class=\"line\">1_38_854775184.dbf</span><br><span class=\"line\">1_39_854775184.dbf</span><br><span class=\"line\">--copy走，无法使用通配符是一件很痛苦的事情</span><br><span class=\"line\">ASMCMD&gt; cp 1_23_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_23_854775184.dbf -&gt; /u02/backupset/1_23_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_24_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_24_854775184.dbf -&gt; /u02/backupset/1_24_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_25_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_25_854775184.dbf -&gt; /u02/backupset/1_25_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_26_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_26_854775184.dbf -&gt; /u02/backupset/1_26_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_27_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_27_854775184.dbf -&gt; /u02/backupset/1_27_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_28_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_28_854775184.dbf -&gt; /u02/backupset/1_28_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_29_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_29_854775184.dbf -&gt; /u02/backupset/1_29_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_3* /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_30_854775184.dbf -&gt; /u02/backupset/1_30_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_31_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_31_854775184.dbf -&gt; /u02/backupset/1_31_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_32_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_32_854775184.dbf -&gt; /u02/backupset/1_32_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_33_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_33_854775184.dbf -&gt; /u02/backupset/1_33_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_34_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_34_854775184.dbf -&gt; /u02/backupset/1_34_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_35_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_35_854775184.dbf -&gt; /u02/backupset/1_35_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_36_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_36_854775184.dbf -&gt; /u02/backupset/1_36_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_37_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_37_854775184.dbf -&gt; /u02/backupset/1_37_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_38_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_38_854775184.dbf -&gt; /u02/backupset/1_38_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_39_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_39_854775184.dbf -&gt; /u02/backupset/1_39_854775184.dbf</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"查看当前的redo状态-记住当前redo的seq号\"><a href=\"#查看当前的redo状态-记住当前redo的seq号\" class=\"headerlink\" title=\"查看当前的redo状态,记住当前redo的seq号\"></a>查看当前的redo状态,记住当前redo的seq号</h3><figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select group#,SEQUENCE# ,MEMBERS,ARCHIVED,STATUS from v$log;</span><br><span class=\"line\"></span><br><span class=\"line\">    GROUP<span class=\"comment\">#  SEQUENCE#    MEMBERS ARC STATUS</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- ---------- --- ----------------</span></span><br><span class=\"line\">         1         40          2 NO  CURRENT</span><br><span class=\"line\">         2         38          2 YES INACTIVE</span><br><span class=\"line\">         3         39          2 YES INACTIVE</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"查看redo文件\"><a href=\"#查看redo文件\" class=\"headerlink\" title=\"查看redo文件\"></a>查看redo文件</h3> <figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"> SQL&gt; select GROUP#,STATUS,MEMBER  from v$logfile;</span><br><span class=\"line\"></span><br><span class=\"line\">    GROUP<span class=\"comment\"># STATUS  MEMBER</span></span><br><span class=\"line\"><span class=\"comment\">---------- ------- --------------------------------------------------------------------------------</span></span><br><span class=\"line\">         3         +DATA/min/onlinelog/group_3.266.854775193</span><br><span class=\"line\">         3         +DATA/min/onlinelog/group_3.267.854775195</span><br><span class=\"line\">         2         +DATA/min/onlinelog/group_2.264.854775189</span><br><span class=\"line\">         2         +DATA/min/onlinelog/group_2.265.854775191</span><br><span class=\"line\">         1         +DATA/min/onlinelog/group_1.262.854775185</span><br><span class=\"line\">         1         +DATA/min/onlinelog/group_1.263.854775187</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>使用asmcmd拷贝并改名，这个时候我已经关闭了源库</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">ASMCMD&gt; cd onlinelog</span><br><span class=\"line\">ASMCMD&gt;</span><br><span class=\"line\">ASMCMD&gt; ls</span><br><span class=\"line\">group_1.262.854775185</span><br><span class=\"line\">group_1.263.854775187</span><br><span class=\"line\">group_2.264.854775189</span><br><span class=\"line\">group_2.265.854775191</span><br><span class=\"line\">group_3.266.854775193</span><br><span class=\"line\">group_3.267.854775195</span><br><span class=\"line\"></span><br><span class=\"line\">ASMCMD&gt; cp group_1.262.854775185 /u02/backupset/redo1a.log</span><br><span class=\"line\">copying +Data/min/onlinelog/group_1.262.854775185 -&gt; /u02/backupset/redo1a.log</span><br><span class=\"line\">ASMCMD&gt; cp group_1.263.854775187 /u02/backupset/redo1b.log</span><br><span class=\"line\">copying +Data/min/onlinelog/group_1.263.854775187 -&gt; /u02/backupset/redo1b.log</span><br><span class=\"line\">ASMCMD&gt; cp group_2.264.854775189 /u02/backupset/redo2a.log</span><br><span class=\"line\">copying +Data/min/onlinelog/group_2.264.854775189 -&gt; /u02/backupset/redo2a.log</span><br><span class=\"line\">ASMCMD&gt; cp group_2.265.854775191 /u02/backupset/redo2b.log</span><br><span class=\"line\">copying +Data/min/onlinelog/group_2.265.854775191 -&gt; /u02/backupset/redo2b.log</span><br><span class=\"line\">ASMCMD&gt; cp group_3.266.854775193 /u02/backupset/redo3a.log</span><br><span class=\"line\">copying +Data/min/onlinelog/group_3.266.854775193 -&gt; /u02/backupset/redo3a.log</span><br><span class=\"line\">ASMCMD&gt; cp group_3.267.854775195 /u02/backupset/redo3b.log</span><br><span class=\"line\">copying +Data/min/onlinelog/group_3.267.854775195 -&gt; /u02/backupset/redo3b.log</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-目标机器恢复\"><a href=\"#3-目标机器恢复\" class=\"headerlink\" title=\"3.  目标机器恢复\"></a>3.  目标机器恢复</h2><p>这一步之前已经在目标主机安装好oracle软件，安装过程不再赘述，直接记录恢复过程<br>这里直接从备份中恢复pfile（比较懒，不想手动准备），无参数文件，rman会启动一个傻瓜实例，供我们恢复参数文件。</p>\n<p>###从备份中恢复参数文件</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">RMAN&gt; startup nomount</span><br><span class=\"line\"></span><br><span class=\"line\">startup failed: ORA-01078: failure in processing system parameters</span><br><span class=\"line\">LRM-00109: could not open parameter file '/home/oracle/app/oracle/product/11.2.0/dbhome_1/dbs/initmin.ora'</span><br><span class=\"line\"></span><br><span class=\"line\">starting Oracle instance without parameter file for retrieval of spfile</span><br><span class=\"line\">Oracle instance started</span><br><span class=\"line\"></span><br><span class=\"line\">Total System Global Area    1068937216 bytes</span><br><span class=\"line\"></span><br><span class=\"line\">Fixed Size                     2260088 bytes</span><br><span class=\"line\">Variable Size                281019272 bytes</span><br><span class=\"line\">Database Buffers             780140544 bytes</span><br><span class=\"line\">Redo Buffers                   5517312 bytes</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt; restore spfile to pfile '/home/oracle/app/oracle/product/11.2.0/dbhome_1/dbs/initmin.ora' from '/u01/rmanbackup/ctl2.rman';</span><br><span class=\"line\"></span><br><span class=\"line\">Starting <span class=\"keyword\">restore</span> <span class=\"keyword\">at</span> <span class=\"number\">18</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"><span class=\"keyword\">using</span> target <span class=\"keyword\">database</span> control <span class=\"keyword\">file</span> instead <span class=\"keyword\">of</span> <span class=\"keyword\">recovery</span> <span class=\"keyword\">catalog</span></span><br><span class=\"line\">allocated channel: ORA_DISK_1</span><br><span class=\"line\">channel ORA_DISK_1: <span class=\"keyword\">SID</span>=<span class=\"number\">171</span> device <span class=\"keyword\">type</span>=DISK</span><br><span class=\"line\"></span><br><span class=\"line\">channel ORA_DISK_1: restoring <span class=\"keyword\">spfile</span> <span class=\"keyword\">from</span> AUTOBACKUP /u01/rmanbackup/ctl2.rman</span><br><span class=\"line\">channel ORA_DISK_1: <span class=\"keyword\">SPFILE</span> <span class=\"keyword\">restore</span> <span class=\"keyword\">from</span> AUTOBACKUP <span class=\"keyword\">complete</span></span><br><span class=\"line\">Finished <span class=\"keyword\">restore</span> <span class=\"keyword\">at</span> <span class=\"number\">18</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt; <span class=\"keyword\">shutdown</span> <span class=\"keyword\">abort</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">Oracle</span> <span class=\"keyword\">instance</span> shut down</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"创建目录，修改参数文件\"><a href=\"#创建目录，修改参数文件\" class=\"headerlink\" title=\"创建目录，修改参数文件\"></a>创建目录，修改参数文件</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">[oracle@rman_newhost u01]$ mkdir -p /u01/app/oracle/admin/min/adump</span><br><span class=\"line\">[oracle@rman_newhost u01]$ mkdir -p /u01/app/oracle/fast_recovery_area</span><br><span class=\"line\">[oracle@rman_newhost u01]$ mkdir -p /u01/app/oracle/archived_log</span><br><span class=\"line\">[oracle@rman_newhost u01]$ mkdir -p /u01/app/oracle/oradata/min</span><br><span class=\"line\">*.audit_file_dest=<span class=\"string\">'/u01/app/oracle/admin/min/adump'</span></span><br><span class=\"line\">*.audit_trail=<span class=\"string\">'db'</span></span><br><span class=\"line\">*.compatible=<span class=\"string\">'11.2.0.4.0'</span></span><br><span class=\"line\">*.control_files=<span class=\"string\">'/u01/app/oracle/fast_recovery_area/control01.ctl'</span>,<span class=\"string\">'/u01/app/oracle/oradata/min/control02.ctl'</span></span><br><span class=\"line\">*.db_block_size=8192</span><br><span class=\"line\">*.db_domain=<span class=\"string\">''</span></span><br><span class=\"line\">*.db_name=<span class=\"string\">'min'</span></span><br><span class=\"line\">*.db_recovery_file_dest=<span class=\"string\">'/u01/app/oracle/fast_recovery_area'</span></span><br><span class=\"line\">*.db_recovery_file_dest_size=4385144832</span><br><span class=\"line\">*.diagnostic_dest=<span class=\"string\">'/u01/app/oracle'</span></span><br><span class=\"line\">*.dispatchers=<span class=\"string\">'(PROTOCOL=TCP) (SERVICE=minXDB)'</span></span><br><span class=\"line\">*.log_archive_dest_1=<span class=\"string\">'location=/u01/app/oracle/archived_log'</span></span><br><span class=\"line\">*.log_checkpoints_to_alert=TRUE</span><br><span class=\"line\">*.memory_target=1394606080</span><br><span class=\"line\">*.open_cursors=300</span><br><span class=\"line\">*.processes=1500</span><br><span class=\"line\">*.remote_login_passwordfile=<span class=\"string\">'EXCLUSIVE'</span></span><br><span class=\"line\">*.sessions=1655</span><br><span class=\"line\">*.undo_tablespace=<span class=\"string\">'UNDOTBS1'</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"启动到nomount状态，恢复控制文件\"><a href=\"#启动到nomount状态，恢复控制文件\" class=\"headerlink\" title=\"启动到nomount状态，恢复控制文件\"></a>启动到nomount状态，恢复控制文件</h3><figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">RMAN&gt; startup nomount</span><br><span class=\"line\"></span><br><span class=\"line\">connected to target database (not started)</span><br><span class=\"line\">Oracle instance started</span><br><span class=\"line\"></span><br><span class=\"line\">Total System Global Area    1402982400 bytes</span><br><span class=\"line\"></span><br><span class=\"line\">Fixed Size                     2253184 bytes</span><br><span class=\"line\">Variable Size               1275072128 bytes</span><br><span class=\"line\">Database Buffers             117440512 bytes</span><br><span class=\"line\">Redo Buffers                   8216576 bytes</span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt; restore controlfile from '/u01/rmanbackup/ctl2.rman';</span><br><span class=\"line\"></span><br><span class=\"line\">Starting <span class=\"keyword\">restore</span> <span class=\"keyword\">at</span> <span class=\"number\">18</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">allocated channel: ORA_DISK_1</span><br><span class=\"line\">channel ORA_DISK_1: <span class=\"keyword\">SID</span>=<span class=\"number\">1146</span> device <span class=\"keyword\">type</span>=DISK</span><br><span class=\"line\"></span><br><span class=\"line\">channel ORA_DISK_1: restoring control <span class=\"keyword\">file</span></span><br><span class=\"line\">channel ORA_DISK_1: <span class=\"keyword\">restore</span> <span class=\"keyword\">complete</span>, elapsed <span class=\"built_in\">time</span>: <span class=\"number\">00</span>:<span class=\"number\">00</span>:<span class=\"number\">01</span></span><br><span class=\"line\"><span class=\"keyword\">output</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/fast_recovery_area/control01.ctl</span><br><span class=\"line\"><span class=\"keyword\">output</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/control02.ctl</span><br><span class=\"line\">Finished <span class=\"keyword\">restore</span> <span class=\"keyword\">at</span> <span class=\"number\">18</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt; <span class=\"keyword\">alter</span> <span class=\"keyword\">database</span> <span class=\"keyword\">mount</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">database mounted</span><br><span class=\"line\">released channel: ORA_DISK_1</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"将redo文件和归档日志移动到对应目录下\"><a href=\"#将redo文件和归档日志移动到对应目录下\" class=\"headerlink\" title=\"将redo文件和归档日志移动到对应目录下\"></a>将redo文件和归档日志移动到对应目录下</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">[oracle@rman_newhost rmanbackup]$ mv redo* /u01/app/oracle/oradata/min</span><br><span class=\"line\">[oracle@rman_newhost rmanbackup]$ ll /u01/app/oracle/oradata/min</span><br><span class=\"line\">总用量 316744</span><br><span class=\"line\">-rw-r-----. 1 oracle oinstall 9748480 9月 18 00:34 control02.ctl</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 52429312 9月 17 23:00 redo1a.log</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 52429312 9月 17 23:01 redo1b.log</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 52429312 9月 17 23:01 redo2a.log</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 52429312 9月 17 23:01 redo2b.log</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 52429312 9月 17 23:02 redo3a.log</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 52429312 9月 17 23:02 redo3b.log</span><br><span class=\"line\">[oracle@rman_newhost rmanbackup]$ mv 1_* /u01/app/oracle/archived_log</span><br><span class=\"line\">[oracle@rman_newhost rmanbackup]$ ll /u01/app/oracle/archived_log</span><br><span class=\"line\">总用量 809056</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:48 1_22_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 39179776 9月 17 22:49 1_23_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:49 1_24_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:50 1_25_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:50 1_26_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 48581120 9月 17 22:50 1_27_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:51 1_28_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 42950144 9月 17 22:51 1_29_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:51 1_30_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 50134016 9月 17 22:53 1_31_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:53 1_32_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 46714368 9月 17 22:53 1_33_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 44308480 9月 17 22:54 1_34_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:54 1_35_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:54 1_36_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:54 1_37_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:55 1_38_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:55 1_39_854775184.dbf</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"注册备份集\"><a href=\"#注册备份集\" class=\"headerlink\" title=\"注册备份集\"></a>注册备份集</h3><p>下面一步的操作是删掉控制文件中对备份的记录信息，因为这是源库备份恢复过来的，我们要删掉老的备份信息，将备份重新注册，不删也没关系，crosscheck以后你会发现，原来的备份状态都是expired的</p>\n<blockquote>\n<p>利用crosscheck删除控制文件中的备份记录</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">RMAN&gt; list backup summary;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">List of Backups</span><br><span class=\"line\">===============</span><br><span class=\"line\">Key     TY LV S Device Type Completion Time <span class=\"comment\">#Pieces #Copies Compressed Tag</span></span><br><span class=\"line\"><span class=\"comment\">------- -- -- - ----------- --------------- ------- ------- ---------- ---</span></span><br><span class=\"line\">9       B  0  A DISK        17-SEP-15       1       1       NO         DB_RMAN</span><br><span class=\"line\">10      B  0  A DISK        17-SEP-15       1       1       NO         DB_RMAN</span><br><span class=\"line\">11      B  F  A DISK        17-SEP-15       1       1       NO         TAG20150917T221650</span><br><span class=\"line\">12      B  A  A DISK        17-SEP-15       1       1       NO         ARC_RMAN</span><br><span class=\"line\">13      B  A  A DISK        17-SEP-15       1       1       NO         ARC_RMAN</span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt; crosscheck backup;</span><br><span class=\"line\"></span><br><span class=\"line\">Starting implicit crosscheck <span class=\"keyword\">backup</span> <span class=\"keyword\">at</span> <span class=\"number\">18</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">allocated channel: ORA_DISK_1</span><br><span class=\"line\">channel ORA_DISK_1: <span class=\"keyword\">SID</span>=<span class=\"number\">1146</span> device <span class=\"keyword\">type</span>=DISK</span><br><span class=\"line\">allocated channel: ORA_DISK_2</span><br><span class=\"line\">channel ORA_DISK_2: <span class=\"keyword\">SID</span>=<span class=\"number\">10</span> device <span class=\"keyword\">type</span>=DISK</span><br><span class=\"line\">allocated channel: ORA_DISK_3</span><br><span class=\"line\">channel ORA_DISK_3: <span class=\"keyword\">SID</span>=<span class=\"number\">1147</span> device <span class=\"keyword\">type</span>=DISK</span><br><span class=\"line\">allocated channel: ORA_DISK_4</span><br><span class=\"line\">channel ORA_DISK_4: <span class=\"keyword\">SID</span>=<span class=\"number\">11</span> device <span class=\"keyword\">type</span>=DISK</span><br><span class=\"line\">Crosschecked <span class=\"number\">5</span> objects</span><br><span class=\"line\">Finished implicit crosscheck <span class=\"keyword\">backup</span> <span class=\"keyword\">at</span> <span class=\"number\">18</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">Starting</span> implicit crosscheck copy <span class=\"keyword\">at</span> <span class=\"number\">18</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"><span class=\"keyword\">using</span> channel ORA_DISK_1</span><br><span class=\"line\"><span class=\"keyword\">using</span> channel ORA_DISK_2</span><br><span class=\"line\"><span class=\"keyword\">using</span> channel ORA_DISK_3</span><br><span class=\"line\"><span class=\"keyword\">using</span> channel ORA_DISK_4</span><br><span class=\"line\">Finished implicit crosscheck copy <span class=\"keyword\">at</span> <span class=\"number\">18</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"></span><br><span class=\"line\">searching <span class=\"keyword\">for</span> <span class=\"keyword\">all</span> files <span class=\"keyword\">in</span> the <span class=\"keyword\">recovery</span> area</span><br><span class=\"line\">cataloging files...</span><br><span class=\"line\"><span class=\"keyword\">no</span> files cataloged</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">using</span> channel ORA_DISK_1</span><br><span class=\"line\"><span class=\"keyword\">using</span> channel ORA_DISK_2</span><br><span class=\"line\"><span class=\"keyword\">using</span> channel ORA_DISK_3</span><br><span class=\"line\"><span class=\"keyword\">using</span> channel ORA_DISK_4</span><br><span class=\"line\">crosschecked <span class=\"keyword\">backup</span> piece: <span class=\"keyword\">found</span> <span class=\"keyword\">to</span> be <span class=\"string\">'EXPIRED'</span></span><br><span class=\"line\"><span class=\"keyword\">backup</span> piece handle=+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/db_0aqhdno6_1_1 RECID=<span class=\"number\">9</span> STAMP=<span class=\"number\">890691334</span></span><br><span class=\"line\">crosschecked <span class=\"keyword\">backup</span> piece: <span class=\"keyword\">found</span> <span class=\"keyword\">to</span> be <span class=\"string\">'EXPIRED'</span></span><br><span class=\"line\"><span class=\"keyword\">backup</span> piece handle=+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/db_09qhdno6_1_1 RECID=<span class=\"number\">10</span> STAMP=<span class=\"number\">890691334</span></span><br><span class=\"line\">crosschecked <span class=\"keyword\">backup</span> piece: <span class=\"keyword\">found</span> <span class=\"keyword\">to</span> be <span class=\"string\">'EXPIRED'</span></span><br><span class=\"line\"><span class=\"keyword\">backup</span> piece handle=+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/ctl_atuo_c<span class=\"number\">-2496627597</span><span class=\"number\">-20150917</span><span class=\"number\">-00</span> RECID=<span class=\"number\">11</span> STAMP=<span class=\"number\">890691411</span></span><br><span class=\"line\">crosschecked <span class=\"keyword\">backup</span> piece: <span class=\"keyword\">found</span> <span class=\"keyword\">to</span> be <span class=\"string\">'EXPIRED'</span></span><br><span class=\"line\"><span class=\"keyword\">backup</span> piece handle=+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/arc_0dqhdnqq_1_1 RECID=<span class=\"number\">12</span> STAMP=<span class=\"number\">890691418</span></span><br><span class=\"line\">crosschecked <span class=\"keyword\">backup</span> piece: <span class=\"keyword\">found</span> <span class=\"keyword\">to</span> be <span class=\"string\">'EXPIRED'</span></span><br><span class=\"line\"><span class=\"keyword\">backup</span> piece handle=+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/arc_0cqhdnqq_1_1 RECID=<span class=\"number\">13</span> STAMP=<span class=\"number\">890691418</span></span><br><span class=\"line\">Crosschecked <span class=\"number\">5</span> objects</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt; <span class=\"keyword\">list</span> <span class=\"keyword\">backup</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">List of <span class=\"keyword\">Backup</span> <span class=\"keyword\">Sets</span></span><br><span class=\"line\">===================</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">BS <span class=\"keyword\">Key</span>  <span class=\"keyword\">Type</span> LV <span class=\"keyword\">Size</span>       Device <span class=\"keyword\">Type</span> Elapsed <span class=\"built_in\">Time</span> Completion <span class=\"built_in\">Time</span></span><br><span class=\"line\"><span class=\"comment\">------- ---- -- ---------- ----------- ------------ ---------------</span></span><br><span class=\"line\"><span class=\"number\">9</span>       Incr <span class=\"number\">0</span>  <span class=\"number\">433.65</span>M    DISK        <span class=\"number\">00</span>:<span class=\"number\">01</span>:<span class=\"number\">10</span>     <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">        BP <span class=\"keyword\">Key</span>: <span class=\"number\">9</span>   <span class=\"keyword\">Status</span>: EXPIRED  Compressed: <span class=\"keyword\">NO</span>  Tag: DB_RMAN</span><br><span class=\"line\">        Piece <span class=\"keyword\">Name</span>: +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/db_0aqhdno6_1_1</span><br><span class=\"line\">  <span class=\"keyword\">List</span> <span class=\"keyword\">of</span> <span class=\"keyword\">Datafiles</span> <span class=\"keyword\">in</span> <span class=\"keyword\">backup</span> <span class=\"keyword\">set</span> <span class=\"number\">9</span></span><br><span class=\"line\">  <span class=\"keyword\">File</span> LV <span class=\"keyword\">Type</span> Ckp <span class=\"keyword\">SCN</span>    Ckp <span class=\"built_in\">Time</span>  <span class=\"keyword\">Name</span></span><br><span class=\"line\">  <span class=\"comment\">---- -- ---- ---------- --------- ----</span></span><br><span class=\"line\">  <span class=\"number\">2</span>    <span class=\"number\">0</span>  Incr <span class=\"number\">1138043</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span> +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/<span class=\"keyword\">datafile</span>/<span class=\"keyword\">sysaux</span><span class=\"number\">.257</span><span class=\"number\">.854775097</span></span><br><span class=\"line\">  <span class=\"number\">3</span>    <span class=\"number\">0</span>  Incr <span class=\"number\">1138043</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span> +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/<span class=\"keyword\">datafile</span>/undotbs1<span class=\"number\">.258</span><span class=\"number\">.854775097</span></span><br><span class=\"line\"></span><br><span class=\"line\">BS <span class=\"keyword\">Key</span>  <span class=\"keyword\">Type</span> LV <span class=\"keyword\">Size</span>       Device <span class=\"keyword\">Type</span> Elapsed <span class=\"built_in\">Time</span> Completion <span class=\"built_in\">Time</span></span><br><span class=\"line\"><span class=\"comment\">------- ---- -- ---------- ----------- ------------ ---------------</span></span><br><span class=\"line\"><span class=\"number\">10</span>      Incr <span class=\"number\">0</span>  <span class=\"number\">638.84</span>M    DISK        <span class=\"number\">00</span>:<span class=\"number\">01</span>:<span class=\"number\">10</span>     <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">        BP <span class=\"keyword\">Key</span>: <span class=\"number\">10</span>   <span class=\"keyword\">Status</span>: EXPIRED  Compressed: <span class=\"keyword\">NO</span>  Tag: DB_RMAN</span><br><span class=\"line\">        Piece <span class=\"keyword\">Name</span>: +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/db_09qhdno6_1_1</span><br><span class=\"line\">  <span class=\"keyword\">List</span> <span class=\"keyword\">of</span> <span class=\"keyword\">Datafiles</span> <span class=\"keyword\">in</span> <span class=\"keyword\">backup</span> <span class=\"keyword\">set</span> <span class=\"number\">10</span></span><br><span class=\"line\">  <span class=\"keyword\">File</span> LV <span class=\"keyword\">Type</span> Ckp <span class=\"keyword\">SCN</span>    Ckp <span class=\"built_in\">Time</span>  <span class=\"keyword\">Name</span></span><br><span class=\"line\">  <span class=\"comment\">---- -- ---- ---------- --------- ----</span></span><br><span class=\"line\">  <span class=\"number\">1</span>    <span class=\"number\">0</span>  Incr <span class=\"number\">1138042</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span> +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/<span class=\"keyword\">datafile</span>/<span class=\"keyword\">system</span><span class=\"number\">.256</span><span class=\"number\">.854775095</span></span><br><span class=\"line\">  <span class=\"number\">4</span>    <span class=\"number\">0</span>  Incr <span class=\"number\">1138042</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span> +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/<span class=\"keyword\">datafile</span>/<span class=\"keyword\">users</span><span class=\"number\">.259</span><span class=\"number\">.854775097</span></span><br><span class=\"line\"></span><br><span class=\"line\">BS <span class=\"keyword\">Key</span>  <span class=\"keyword\">Type</span> LV <span class=\"keyword\">Size</span>       Device <span class=\"keyword\">Type</span> Elapsed <span class=\"built_in\">Time</span> Completion <span class=\"built_in\">Time</span></span><br><span class=\"line\"><span class=\"comment\">------- ---- -- ---------- ----------- ------------ ---------------</span></span><br><span class=\"line\"><span class=\"number\">11</span>      <span class=\"keyword\">Full</span>    <span class=\"number\">9.36</span>M      DISK        <span class=\"number\">00</span>:<span class=\"number\">00</span>:<span class=\"number\">01</span>     <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">        BP <span class=\"keyword\">Key</span>: <span class=\"number\">11</span>   <span class=\"keyword\">Status</span>: EXPIRED  Compressed: <span class=\"keyword\">NO</span>  Tag: TAG20150917T221650</span><br><span class=\"line\">        Piece <span class=\"keyword\">Name</span>: +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/ctl_atuo_c<span class=\"number\">-2496627597</span><span class=\"number\">-20150917</span><span class=\"number\">-00</span></span><br><span class=\"line\">  <span class=\"keyword\">SPFILE</span> Included: <span class=\"keyword\">Modification</span> <span class=\"built_in\">time</span>: <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">  <span class=\"keyword\">SPFILE</span> db_unique_name: <span class=\"keyword\">MIN</span></span><br><span class=\"line\">  Control <span class=\"keyword\">File</span> Included: Ckp <span class=\"keyword\">SCN</span>: <span class=\"number\">1138347</span>      Ckp <span class=\"built_in\">time</span>: <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"></span><br><span class=\"line\">BS <span class=\"keyword\">Key</span>  <span class=\"keyword\">Size</span>       Device <span class=\"keyword\">Type</span> Elapsed <span class=\"built_in\">Time</span> Completion <span class=\"built_in\">Time</span></span><br><span class=\"line\"><span class=\"comment\">------- ---------- ----------- ------------ ---------------</span></span><br><span class=\"line\"><span class=\"number\">12</span>      <span class=\"number\">2.00</span>K      DISK        <span class=\"number\">00</span>:<span class=\"number\">00</span>:<span class=\"number\">00</span>     <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">        BP <span class=\"keyword\">Key</span>: <span class=\"number\">12</span>   <span class=\"keyword\">Status</span>: EXPIRED  Compressed: <span class=\"keyword\">NO</span>  Tag: ARC_RMAN</span><br><span class=\"line\">        Piece <span class=\"keyword\">Name</span>: +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/arc_0dqhdnqq_1_1</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">List</span> <span class=\"keyword\">of</span> <span class=\"keyword\">Archived</span> <span class=\"keyword\">Logs</span> <span class=\"keyword\">in</span> <span class=\"keyword\">backup</span> <span class=\"keyword\">set</span> <span class=\"number\">12</span></span><br><span class=\"line\">  Thrd Seq     <span class=\"keyword\">Low</span> <span class=\"keyword\">SCN</span>    <span class=\"keyword\">Low</span> <span class=\"built_in\">Time</span>  <span class=\"keyword\">Next</span> <span class=\"keyword\">SCN</span>   <span class=\"keyword\">Next</span> <span class=\"built_in\">Time</span></span><br><span class=\"line\">  <span class=\"comment\">---- ------- ---------- --------- ---------- ---------</span></span><br><span class=\"line\">  <span class=\"number\">1</span>    <span class=\"number\">21</span>      <span class=\"number\">1138364</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span> <span class=\"number\">1138372</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"></span><br><span class=\"line\">BS <span class=\"keyword\">Key</span>  <span class=\"keyword\">Size</span>       Device <span class=\"keyword\">Type</span> Elapsed <span class=\"built_in\">Time</span> Completion <span class=\"built_in\">Time</span></span><br><span class=\"line\"><span class=\"comment\">------- ---------- ----------- ------------ ---------------</span></span><br><span class=\"line\"><span class=\"number\">13</span>      <span class=\"number\">30.99</span>M     DISK        <span class=\"number\">00</span>:<span class=\"number\">00</span>:<span class=\"number\">02</span>     <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">        BP <span class=\"keyword\">Key</span>: <span class=\"number\">13</span>   <span class=\"keyword\">Status</span>: EXPIRED  Compressed: <span class=\"keyword\">NO</span>  Tag: ARC_RMAN</span><br><span class=\"line\">        Piece <span class=\"keyword\">Name</span>: +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/arc_0cqhdnqq_1_1</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">List</span> <span class=\"keyword\">of</span> <span class=\"keyword\">Archived</span> <span class=\"keyword\">Logs</span> <span class=\"keyword\">in</span> <span class=\"keyword\">backup</span> <span class=\"keyword\">set</span> <span class=\"number\">13</span></span><br><span class=\"line\">  Thrd Seq     <span class=\"keyword\">Low</span> <span class=\"keyword\">SCN</span>    <span class=\"keyword\">Low</span> <span class=\"built_in\">Time</span>  <span class=\"keyword\">Next</span> <span class=\"keyword\">SCN</span>   <span class=\"keyword\">Next</span> <span class=\"built_in\">Time</span></span><br><span class=\"line\">  <span class=\"comment\">---- ------- ---------- --------- ---------- ---------</span></span><br><span class=\"line\">  <span class=\"number\">1</span>    <span class=\"number\">20</span>      <span class=\"number\">1127220</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span> <span class=\"number\">1138364</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt; <span class=\"keyword\">list</span> <span class=\"keyword\">archivelog</span> <span class=\"keyword\">all</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">specification does not match any archived log in the repository</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt; report obsolete;</span><br><span class=\"line\"></span><br><span class=\"line\">RMAN retention policy will be applied to the command</span><br><span class=\"line\">RMAN retention policy is <span class=\"keyword\">set</span> <span class=\"keyword\">to</span> <span class=\"keyword\">recovery</span> <span class=\"keyword\">window</span> <span class=\"keyword\">of</span> <span class=\"number\">7</span> <span class=\"keyword\">days</span></span><br><span class=\"line\"><span class=\"keyword\">no</span> obsolete backups <span class=\"keyword\">found</span></span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt; <span class=\"keyword\">list</span> expired <span class=\"keyword\">backup</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">List of <span class=\"keyword\">Backup</span> <span class=\"keyword\">Sets</span></span><br><span class=\"line\">===================</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">BS <span class=\"keyword\">Key</span>  <span class=\"keyword\">Type</span> LV <span class=\"keyword\">Size</span>       Device <span class=\"keyword\">Type</span> Elapsed <span class=\"built_in\">Time</span> Completion <span class=\"built_in\">Time</span></span><br><span class=\"line\"><span class=\"comment\">------- ---- -- ---------- ----------- ------------ ---------------</span></span><br><span class=\"line\"><span class=\"number\">9</span>       Incr <span class=\"number\">0</span>  <span class=\"number\">433.65</span>M    DISK        <span class=\"number\">00</span>:<span class=\"number\">01</span>:<span class=\"number\">10</span>     <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">        BP <span class=\"keyword\">Key</span>: <span class=\"number\">9</span>   <span class=\"keyword\">Status</span>: EXPIRED  Compressed: <span class=\"keyword\">NO</span>  Tag: DB_RMAN</span><br><span class=\"line\">        Piece <span class=\"keyword\">Name</span>: +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/db_0aqhdno6_1_1</span><br><span class=\"line\">  <span class=\"keyword\">List</span> <span class=\"keyword\">of</span> <span class=\"keyword\">Datafiles</span> <span class=\"keyword\">in</span> <span class=\"keyword\">backup</span> <span class=\"keyword\">set</span> <span class=\"number\">9</span></span><br><span class=\"line\">  <span class=\"keyword\">File</span> LV <span class=\"keyword\">Type</span> Ckp <span class=\"keyword\">SCN</span>    Ckp <span class=\"built_in\">Time</span>  <span class=\"keyword\">Name</span></span><br><span class=\"line\">  <span class=\"comment\">---- -- ---- ---------- --------- ----</span></span><br><span class=\"line\">  <span class=\"number\">2</span>    <span class=\"number\">0</span>  Incr <span class=\"number\">1138043</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span> +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/<span class=\"keyword\">datafile</span>/<span class=\"keyword\">sysaux</span><span class=\"number\">.257</span><span class=\"number\">.854775097</span></span><br><span class=\"line\">  <span class=\"number\">3</span>    <span class=\"number\">0</span>  Incr <span class=\"number\">1138043</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span> +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/<span class=\"keyword\">datafile</span>/undotbs1<span class=\"number\">.258</span><span class=\"number\">.854775097</span></span><br><span class=\"line\"></span><br><span class=\"line\">BS <span class=\"keyword\">Key</span>  <span class=\"keyword\">Type</span> LV <span class=\"keyword\">Size</span>       Device <span class=\"keyword\">Type</span> Elapsed <span class=\"built_in\">Time</span> Completion <span class=\"built_in\">Time</span></span><br><span class=\"line\"><span class=\"comment\">------- ---- -- ---------- ----------- ------------ ---------------</span></span><br><span class=\"line\"><span class=\"number\">10</span>      Incr <span class=\"number\">0</span>  <span class=\"number\">638.84</span>M    DISK        <span class=\"number\">00</span>:<span class=\"number\">01</span>:<span class=\"number\">10</span>     <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">        BP <span class=\"keyword\">Key</span>: <span class=\"number\">10</span>   <span class=\"keyword\">Status</span>: EXPIRED  Compressed: <span class=\"keyword\">NO</span>  Tag: DB_RMAN</span><br><span class=\"line\">        Piece <span class=\"keyword\">Name</span>: +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/db_09qhdno6_1_1</span><br><span class=\"line\">  <span class=\"keyword\">List</span> <span class=\"keyword\">of</span> <span class=\"keyword\">Datafiles</span> <span class=\"keyword\">in</span> <span class=\"keyword\">backup</span> <span class=\"keyword\">set</span> <span class=\"number\">10</span></span><br><span class=\"line\">  <span class=\"keyword\">File</span> LV <span class=\"keyword\">Type</span> Ckp <span class=\"keyword\">SCN</span>    Ckp <span class=\"built_in\">Time</span>  <span class=\"keyword\">Name</span></span><br><span class=\"line\">  <span class=\"comment\">---- -- ---- ---------- --------- ----</span></span><br><span class=\"line\">  <span class=\"number\">1</span>    <span class=\"number\">0</span>  Incr <span class=\"number\">1138042</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span> +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/<span class=\"keyword\">datafile</span>/<span class=\"keyword\">system</span><span class=\"number\">.256</span><span class=\"number\">.854775095</span></span><br><span class=\"line\">  <span class=\"number\">4</span>    <span class=\"number\">0</span>  Incr <span class=\"number\">1138042</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span> +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/<span class=\"keyword\">datafile</span>/<span class=\"keyword\">users</span><span class=\"number\">.259</span><span class=\"number\">.854775097</span></span><br><span class=\"line\"></span><br><span class=\"line\">BS <span class=\"keyword\">Key</span>  <span class=\"keyword\">Type</span> LV <span class=\"keyword\">Size</span>       Device <span class=\"keyword\">Type</span> Elapsed <span class=\"built_in\">Time</span> Completion <span class=\"built_in\">Time</span></span><br><span class=\"line\"><span class=\"comment\">------- ---- -- ---------- ----------- ------------ ---------------</span></span><br><span class=\"line\"><span class=\"number\">11</span>      <span class=\"keyword\">Full</span>    <span class=\"number\">9.36</span>M      DISK        <span class=\"number\">00</span>:<span class=\"number\">00</span>:<span class=\"number\">01</span>     <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">        BP <span class=\"keyword\">Key</span>: <span class=\"number\">11</span>   <span class=\"keyword\">Status</span>: EXPIRED  Compressed: <span class=\"keyword\">NO</span>  Tag: TAG20150917T221650</span><br><span class=\"line\">        Piece <span class=\"keyword\">Name</span>: +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/ctl_atuo_c<span class=\"number\">-2496627597</span><span class=\"number\">-20150917</span><span class=\"number\">-00</span></span><br><span class=\"line\">  <span class=\"keyword\">SPFILE</span> Included: <span class=\"keyword\">Modification</span> <span class=\"built_in\">time</span>: <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">  <span class=\"keyword\">SPFILE</span> db_unique_name: <span class=\"keyword\">MIN</span></span><br><span class=\"line\">  Control <span class=\"keyword\">File</span> Included: Ckp <span class=\"keyword\">SCN</span>: <span class=\"number\">1138347</span>      Ckp <span class=\"built_in\">time</span>: <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"></span><br><span class=\"line\">BS <span class=\"keyword\">Key</span>  <span class=\"keyword\">Size</span>       Device <span class=\"keyword\">Type</span> Elapsed <span class=\"built_in\">Time</span> Completion <span class=\"built_in\">Time</span></span><br><span class=\"line\"><span class=\"comment\">------- ---------- ----------- ------------ ---------------</span></span><br><span class=\"line\"><span class=\"number\">12</span>      <span class=\"number\">2.00</span>K      DISK        <span class=\"number\">00</span>:<span class=\"number\">00</span>:<span class=\"number\">00</span>     <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">        BP <span class=\"keyword\">Key</span>: <span class=\"number\">12</span>   <span class=\"keyword\">Status</span>: EXPIRED  Compressed: <span class=\"keyword\">NO</span>  Tag: ARC_RMAN</span><br><span class=\"line\">        Piece <span class=\"keyword\">Name</span>: +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/arc_0dqhdnqq_1_1</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">List</span> <span class=\"keyword\">of</span> <span class=\"keyword\">Archived</span> <span class=\"keyword\">Logs</span> <span class=\"keyword\">in</span> <span class=\"keyword\">backup</span> <span class=\"keyword\">set</span> <span class=\"number\">12</span></span><br><span class=\"line\">  Thrd Seq     <span class=\"keyword\">Low</span> <span class=\"keyword\">SCN</span>    <span class=\"keyword\">Low</span> <span class=\"built_in\">Time</span>  <span class=\"keyword\">Next</span> <span class=\"keyword\">SCN</span>   <span class=\"keyword\">Next</span> <span class=\"built_in\">Time</span></span><br><span class=\"line\">  <span class=\"comment\">---- ------- ---------- --------- ---------- ---------</span></span><br><span class=\"line\">  <span class=\"number\">1</span>    <span class=\"number\">21</span>      <span class=\"number\">1138364</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span> <span class=\"number\">1138372</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"></span><br><span class=\"line\">BS <span class=\"keyword\">Key</span>  <span class=\"keyword\">Size</span>       Device <span class=\"keyword\">Type</span> Elapsed <span class=\"built_in\">Time</span> Completion <span class=\"built_in\">Time</span></span><br><span class=\"line\"><span class=\"comment\">------- ---------- ----------- ------------ ---------------</span></span><br><span class=\"line\"><span class=\"number\">13</span>      <span class=\"number\">30.99</span>M     DISK        <span class=\"number\">00</span>:<span class=\"number\">00</span>:<span class=\"number\">02</span>     <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">        BP <span class=\"keyword\">Key</span>: <span class=\"number\">13</span>   <span class=\"keyword\">Status</span>: EXPIRED  Compressed: <span class=\"keyword\">NO</span>  Tag: ARC_RMAN</span><br><span class=\"line\">        Piece <span class=\"keyword\">Name</span>: +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/arc_0cqhdnqq_1_1</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">List</span> <span class=\"keyword\">of</span> <span class=\"keyword\">Archived</span> <span class=\"keyword\">Logs</span> <span class=\"keyword\">in</span> <span class=\"keyword\">backup</span> <span class=\"keyword\">set</span> <span class=\"number\">13</span></span><br><span class=\"line\">  Thrd Seq     <span class=\"keyword\">Low</span> <span class=\"keyword\">SCN</span>    <span class=\"keyword\">Low</span> <span class=\"built_in\">Time</span>  <span class=\"keyword\">Next</span> <span class=\"keyword\">SCN</span>   <span class=\"keyword\">Next</span> <span class=\"built_in\">Time</span></span><br><span class=\"line\">  <span class=\"comment\">---- ------- ---------- --------- ---------- ---------</span></span><br><span class=\"line\">  <span class=\"number\">1</span>    <span class=\"number\">20</span>      <span class=\"number\">1127220</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span> <span class=\"number\">1138364</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt; <span class=\"keyword\">delete</span> <span class=\"keyword\">noprompt</span> expired <span class=\"keyword\">backup</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">using channel ORA_DISK_1</span><br><span class=\"line\">using channel ORA_DISK_2</span><br><span class=\"line\">using channel ORA_DISK_3</span><br><span class=\"line\">using channel ORA_DISK_4</span><br><span class=\"line\"></span><br><span class=\"line\">List of <span class=\"keyword\">Backup</span> Pieces</span><br><span class=\"line\">BP <span class=\"keyword\">Key</span>  BS <span class=\"keyword\">Key</span>  Pc<span class=\"comment\"># Cp# Status      Device Type Piece Name</span></span><br><span class=\"line\"><span class=\"comment\">------- ------- --- --- ----------- ----------- ----------</span></span><br><span class=\"line\"><span class=\"number\">9</span>       <span class=\"number\">9</span>       <span class=\"number\">1</span>   <span class=\"number\">1</span>   EXPIRED     DISK        +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/db_0aqhdno6_1_1</span><br><span class=\"line\"><span class=\"number\">10</span>      <span class=\"number\">10</span>      <span class=\"number\">1</span>   <span class=\"number\">1</span>   EXPIRED     DISK        +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/db_09qhdno6_1_1</span><br><span class=\"line\"><span class=\"number\">11</span>      <span class=\"number\">11</span>      <span class=\"number\">1</span>   <span class=\"number\">1</span>   EXPIRED     DISK        +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/ctl_atuo_c<span class=\"number\">-2496627597</span><span class=\"number\">-20150917</span><span class=\"number\">-00</span></span><br><span class=\"line\"><span class=\"number\">12</span>      <span class=\"number\">12</span>      <span class=\"number\">1</span>   <span class=\"number\">1</span>   EXPIRED     DISK        +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/arc_0dqhdnqq_1_1</span><br><span class=\"line\"><span class=\"number\">13</span>      <span class=\"number\">13</span>      <span class=\"number\">1</span>   <span class=\"number\">1</span>   EXPIRED     DISK        +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/arc_0cqhdnqq_1_1</span><br><span class=\"line\">deleted <span class=\"keyword\">backup</span> piece</span><br><span class=\"line\"><span class=\"keyword\">backup</span> piece handle=+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/db_0aqhdno6_1_1 RECID=<span class=\"number\">9</span> STAMP=<span class=\"number\">890691334</span></span><br><span class=\"line\">deleted <span class=\"keyword\">backup</span> piece</span><br><span class=\"line\"><span class=\"keyword\">backup</span> piece handle=+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/db_09qhdno6_1_1 RECID=<span class=\"number\">10</span> STAMP=<span class=\"number\">890691334</span></span><br><span class=\"line\">deleted <span class=\"keyword\">backup</span> piece</span><br><span class=\"line\"><span class=\"keyword\">backup</span> piece handle=+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/ctl_atuo_c<span class=\"number\">-2496627597</span><span class=\"number\">-20150917</span><span class=\"number\">-00</span> RECID=<span class=\"number\">11</span> STAMP=<span class=\"number\">890691411</span></span><br><span class=\"line\">deleted <span class=\"keyword\">backup</span> piece</span><br><span class=\"line\"><span class=\"keyword\">backup</span> piece handle=+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/arc_0dqhdnqq_1_1 RECID=<span class=\"number\">12</span> STAMP=<span class=\"number\">890691418</span></span><br><span class=\"line\">deleted <span class=\"keyword\">backup</span> piece</span><br><span class=\"line\"><span class=\"keyword\">backup</span> piece handle=+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/arc_0cqhdnqq_1_1 RECID=<span class=\"number\">13</span> STAMP=<span class=\"number\">890691418</span></span><br><span class=\"line\">Deleted <span class=\"number\">5</span> EXPIRED objects</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt; <span class=\"keyword\">list</span> <span class=\"keyword\">backup</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">specification does not match any <span class=\"keyword\">backup</span> <span class=\"keyword\">in</span> the repository</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>重新注册备份，并观察控制文件中的备份信息，和数据库结构的信息</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">RMAN&gt; catalog start with '/u01/rmanbackup';</span><br><span class=\"line\"></span><br><span class=\"line\">searching for all files that match the pattern /u01/rmanbackup</span><br><span class=\"line\"></span><br><span class=\"line\">List of Files Unknown to the Database</span><br><span class=\"line\">=====================================</span><br><span class=\"line\">File Name: /u01/rmanbackup/arc1.rman</span><br><span class=\"line\">File Name: /u01/rmanbackup/db1.rman</span><br><span class=\"line\">File Name: /u01/rmanbackup/ctl2.rman</span><br><span class=\"line\">File Name: /u01/rmanbackup/ctl1.rman</span><br><span class=\"line\">File Name: /u01/rmanbackup/db2.rman</span><br><span class=\"line\">File Name: /u01/rmanbackup/arc2.rman</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">Do</span> you really want <span class=\"keyword\">to</span> <span class=\"keyword\">catalog</span> the above files (enter YES <span class=\"keyword\">or</span> <span class=\"keyword\">NO</span>)? yes</span><br><span class=\"line\">cataloging files...</span><br><span class=\"line\">cataloging done</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">List</span> <span class=\"keyword\">of</span> Cataloged Files</span><br><span class=\"line\">=======================</span><br><span class=\"line\"><span class=\"keyword\">File</span> <span class=\"keyword\">Name</span>: /u01/rmanbackup/arc1.rman</span><br><span class=\"line\"><span class=\"keyword\">File</span> <span class=\"keyword\">Name</span>: /u01/rmanbackup/db1.rman</span><br><span class=\"line\"><span class=\"keyword\">File</span> <span class=\"keyword\">Name</span>: /u01/rmanbackup/ctl2.rman</span><br><span class=\"line\"><span class=\"keyword\">File</span> <span class=\"keyword\">Name</span>: /u01/rmanbackup/ctl1.rman</span><br><span class=\"line\"><span class=\"keyword\">File</span> <span class=\"keyword\">Name</span>: /u01/rmanbackup/db2.rman</span><br><span class=\"line\"><span class=\"keyword\">File</span> <span class=\"keyword\">Name</span>: /u01/rmanbackup/arc2.rman</span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt; <span class=\"keyword\">list</span> <span class=\"keyword\">backup</span> summary;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">List of Backups</span><br><span class=\"line\">===============</span><br><span class=\"line\">Key     TY LV S Device Type Completion Time <span class=\"comment\">#Pieces #Copies Compressed Tag</span></span><br><span class=\"line\"><span class=\"comment\">------- -- -- - ----------- --------------- ------- ------- ---------- ---</span></span><br><span class=\"line\">14      B  A  A DISK        17-SEP-15       1       1       NO         ARC_RMAN</span><br><span class=\"line\">15      B  0  A DISK        17-SEP-15       1       1       NO         DB_RMAN</span><br><span class=\"line\">16      B  0  A DISK        17-SEP-15       1       1       NO         DB_RMAN</span><br><span class=\"line\">17      B  A  A DISK        17-SEP-15       1       1       NO         ARC_RMAN</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">--数据文件、临时文件的记录还是源库的信息，一会儿恢复的时候要setnewname</span></span><br><span class=\"line\">RMAN&gt; report schema;</span><br><span class=\"line\"></span><br><span class=\"line\">RMAN-06139: WARNING: control file is not current for REPORT SCHEMA</span><br><span class=\"line\">Report of database schema for database <span class=\"keyword\">with</span> db_unique_name <span class=\"keyword\">MIN</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">List</span> <span class=\"keyword\">of</span> <span class=\"keyword\">Permanent</span> <span class=\"keyword\">Datafiles</span></span><br><span class=\"line\">===========================</span><br><span class=\"line\"><span class=\"keyword\">File</span> <span class=\"keyword\">Size</span>(MB) <span class=\"keyword\">Tablespace</span>           RB segs <span class=\"keyword\">Datafile</span> <span class=\"keyword\">Name</span></span><br><span class=\"line\"><span class=\"comment\">---- -------- -------------------- ------- ------------------------</span></span><br><span class=\"line\"><span class=\"number\">1</span>    <span class=\"number\">0</span>        <span class=\"keyword\">SYSTEM</span>               ***     +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/<span class=\"keyword\">datafile</span>/<span class=\"keyword\">system</span><span class=\"number\">.256</span><span class=\"number\">.854775095</span></span><br><span class=\"line\"><span class=\"number\">2</span>    <span class=\"number\">0</span>        <span class=\"keyword\">SYSAUX</span>               ***     +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/<span class=\"keyword\">datafile</span>/<span class=\"keyword\">sysaux</span><span class=\"number\">.257</span><span class=\"number\">.854775097</span></span><br><span class=\"line\"><span class=\"number\">3</span>    <span class=\"number\">0</span>        UNDOTBS1             ***     +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/<span class=\"keyword\">datafile</span>/undotbs1<span class=\"number\">.258</span><span class=\"number\">.854775097</span></span><br><span class=\"line\"><span class=\"number\">4</span>    <span class=\"number\">0</span>        <span class=\"keyword\">USERS</span>                ***     +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/<span class=\"keyword\">datafile</span>/<span class=\"keyword\">users</span><span class=\"number\">.259</span><span class=\"number\">.854775097</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">List</span> <span class=\"keyword\">of</span> <span class=\"keyword\">Temporary</span> Files</span><br><span class=\"line\">=======================</span><br><span class=\"line\"><span class=\"keyword\">File</span> <span class=\"keyword\">Size</span>(MB) <span class=\"keyword\">Tablespace</span>           <span class=\"keyword\">Maxsize</span>(MB) Tempfile <span class=\"keyword\">Name</span></span><br><span class=\"line\"><span class=\"comment\">---- -------- -------------------- ----------- --------------------</span></span><br><span class=\"line\"><span class=\"number\">1</span>    <span class=\"number\">20</span>       TEMP                 <span class=\"number\">32767</span>       +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/tempfile/temp<span class=\"number\">.268</span><span class=\"number\">.854775211</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">--你会发现这是老的控制文件，是我们0级备份里的，其中关于redo的状态记录，当前redo还停留在序列号22</span></span><br><span class=\"line\"><span class=\"keyword\">SQL</span>&gt; <span class=\"keyword\">select</span> <span class=\"keyword\">GROUP</span><span class=\"comment\">#,SEQUENCE# ,STATUS,ARCHIVED  from v$log;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">GROUP</span><span class=\"comment\">#  SEQUENCE# STATUS           ARC</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- ---------------- ---</span></span><br><span class=\"line\">         <span class=\"number\">1</span>         <span class=\"number\">22</span> <span class=\"keyword\">CURRENT</span>          <span class=\"keyword\">NO</span></span><br><span class=\"line\">         <span class=\"number\">3</span>         <span class=\"number\">21</span> ACTIVE           YES</span><br><span class=\"line\">         <span class=\"number\">2</span>         <span class=\"number\">20</span> ACTIVE           YES</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">SQL</span>&gt; <span class=\"keyword\">desc</span> v$<span class=\"keyword\">logfile</span>;</span><br><span class=\"line\"> Name                                      Null?    Type</span><br><span class=\"line\"> <span class=\"comment\">----------------------------------------- -------- ----------------------------</span></span><br><span class=\"line\"> GROUP<span class=\"comment\">#                                             NUMBER</span></span><br><span class=\"line\"> STATUS                                             VARCHAR2(7)</span><br><span class=\"line\"> TYPE                                               VARCHAR2(7)</span><br><span class=\"line\"> MEMBER                                             VARCHAR2(513)</span><br><span class=\"line\"> IS_RECOVERY_DEST_FILE                              VARCHAR2(3)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">--redo的记录还是源库的信息，一会儿恢复的时候要setnewname</span></span><br><span class=\"line\">SQL&gt; col member for a80</span><br><span class=\"line\">SQL&gt; set line 200</span><br><span class=\"line\">SQL&gt; select GROUP#,STATUS,MEMBER from v$logfile;</span><br><span class=\"line\"></span><br><span class=\"line\">    GROUP<span class=\"comment\"># STATUS  MEMBER</span></span><br><span class=\"line\"><span class=\"comment\">---------- ------- --------------------------------------------------------------------------------</span></span><br><span class=\"line\">         3         +DATA/min/onlinelog/group_3.266.854775193</span><br><span class=\"line\">         3         +DATA/min/onlinelog/group_3.267.854775195</span><br><span class=\"line\">         2         +DATA/min/onlinelog/group_2.264.854775189</span><br><span class=\"line\">         2         +DATA/min/onlinelog/group_2.265.854775191</span><br><span class=\"line\">         1         +DATA/min/onlinelog/group_1.262.854775185</span><br><span class=\"line\">         1         +DATA/min/onlinelog/group_1.263.854775187</span><br><span class=\"line\"></span><br><span class=\"line\">6 rows selected.</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"还原数据库\"><a href=\"#还原数据库\" class=\"headerlink\" title=\"还原数据库\"></a>还原数据库</h3><figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">RMAN&gt; RUN</span><br><span class=\"line\">2&gt;  &#123;</span><br><span class=\"line\">3&gt;    ALLOCATE CHANNEL c1 DEVICE TYPE DISK;</span><br><span class=\"line\">4&gt;    ALLOCATE CHANNEL c2 DEVICE TYPE DISK;</span><br><span class=\"line\">5&gt;    set archivelog destination to \"/u01/app/oracle/archived_log\";</span><br><span class=\"line\">6&gt;       set newname for datafile 1 to \"/u01/app/oracle/oradata/min/system01.dbf\";</span><br><span class=\"line\">7&gt;       set newname for datafile 2 to \"/u01/app/oracle/oradata/min/sysaux01.dbf\";</span><br><span class=\"line\">8&gt;       set newname for datafile 3 to \"/u01/app/oracle/oradata/min/undotbs01.dbf\";</span><br><span class=\"line\">9&gt;       set newname for datafile 4 to \"/u01/app/oracle/oradata/min/users01.dbf\";</span><br><span class=\"line\">10&gt;      set newname for tempfile 1 to \"/u01/app/oracle/oradata/min/temp01.dbf\";</span><br><span class=\"line\">11&gt;      SQL \"ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_1.262.854775185''  to  ''/u01/app/oracle/oradata/min/redo1a.log'' \";</span><br><span class=\"line\">12&gt;      SQL \"ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_1.263.854775187''  to  ''/u01/app/oracle/oradata/min/redo1b.log'' \";</span><br><span class=\"line\">13&gt;      SQL \"ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_2.264.854775189''  to  ''/u01/app/oracle/oradata/min/redo2a.log'' \";</span><br><span class=\"line\">14&gt;      SQL \"ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_2.265.854775191''  to  ''/u01/app/oracle/oradata/min/redo2b.log'' \";</span><br><span class=\"line\">15&gt;      SQL \"ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_3.266.854775193''  to  ''/u01/app/oracle/oradata/min/redo3a.log'' \";</span><br><span class=\"line\">16&gt;      SQL \"ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_3.267.854775195''  to  ''/u01/app/oracle/oradata/min/redo3b.log'' \";</span><br><span class=\"line\">17&gt;    RESTORE DATABASE;</span><br><span class=\"line\">18&gt;    SWITCH DATAFILE ALL;</span><br><span class=\"line\">19&gt;    switch tempfile all;</span><br><span class=\"line\">20&gt;  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">released channel: ORA_DISK_1</span><br><span class=\"line\">released channel: ORA_DISK_2</span><br><span class=\"line\">released channel: ORA_DISK_3</span><br><span class=\"line\">released channel: ORA_DISK_4</span><br><span class=\"line\">allocated channel: c1</span><br><span class=\"line\">channel c1: SID=1146 device type=DISK</span><br><span class=\"line\"></span><br><span class=\"line\">allocated channel: c2</span><br><span class=\"line\">channel c2: SID=11 device type=DISK</span><br><span class=\"line\"></span><br><span class=\"line\">executing command: <span class=\"keyword\">SET</span> <span class=\"keyword\">ARCHIVELOG</span> DESTINATION</span><br><span class=\"line\"></span><br><span class=\"line\">executing command: <span class=\"keyword\">SET</span> NEWNAME</span><br><span class=\"line\"></span><br><span class=\"line\">executing command: <span class=\"keyword\">SET</span> NEWNAME</span><br><span class=\"line\"></span><br><span class=\"line\">executing command: <span class=\"keyword\">SET</span> NEWNAME</span><br><span class=\"line\"></span><br><span class=\"line\">executing command: <span class=\"keyword\">SET</span> NEWNAME</span><br><span class=\"line\"></span><br><span class=\"line\">executing command: <span class=\"keyword\">SET</span> NEWNAME</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">sql</span> <span class=\"keyword\">statement</span>: <span class=\"keyword\">ALTER</span> <span class=\"keyword\">DATABASE</span> <span class=\"keyword\">RENAME</span> <span class=\"keyword\">FILE</span> <span class=\"string\">''</span>+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/onlinelog/group_1<span class=\"number\">.262</span><span class=\"number\">.854775185</span><span class=\"string\">''</span>  <span class=\"keyword\">to</span>  <span class=\"string\">''</span>/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/redo1a.log<span class=\"string\">''</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">sql</span> <span class=\"keyword\">statement</span>: <span class=\"keyword\">ALTER</span> <span class=\"keyword\">DATABASE</span> <span class=\"keyword\">RENAME</span> <span class=\"keyword\">FILE</span> <span class=\"string\">''</span>+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/onlinelog/group_1<span class=\"number\">.263</span><span class=\"number\">.854775187</span><span class=\"string\">''</span>  <span class=\"keyword\">to</span>  <span class=\"string\">''</span>/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/redo1b.log<span class=\"string\">''</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">sql</span> <span class=\"keyword\">statement</span>: <span class=\"keyword\">ALTER</span> <span class=\"keyword\">DATABASE</span> <span class=\"keyword\">RENAME</span> <span class=\"keyword\">FILE</span> <span class=\"string\">''</span>+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/onlinelog/group_2<span class=\"number\">.264</span><span class=\"number\">.854775189</span><span class=\"string\">''</span>  <span class=\"keyword\">to</span>  <span class=\"string\">''</span>/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/redo2a.log<span class=\"string\">''</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">sql</span> <span class=\"keyword\">statement</span>: <span class=\"keyword\">ALTER</span> <span class=\"keyword\">DATABASE</span> <span class=\"keyword\">RENAME</span> <span class=\"keyword\">FILE</span> <span class=\"string\">''</span>+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/onlinelog/group_2<span class=\"number\">.265</span><span class=\"number\">.854775191</span><span class=\"string\">''</span>  <span class=\"keyword\">to</span>  <span class=\"string\">''</span>/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/redo2b.log<span class=\"string\">''</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">sql</span> <span class=\"keyword\">statement</span>: <span class=\"keyword\">ALTER</span> <span class=\"keyword\">DATABASE</span> <span class=\"keyword\">RENAME</span> <span class=\"keyword\">FILE</span> <span class=\"string\">''</span>+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/onlinelog/group_3<span class=\"number\">.266</span><span class=\"number\">.854775193</span><span class=\"string\">''</span>  <span class=\"keyword\">to</span>  <span class=\"string\">''</span>/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/redo3a.log<span class=\"string\">''</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">sql</span> <span class=\"keyword\">statement</span>: <span class=\"keyword\">ALTER</span> <span class=\"keyword\">DATABASE</span> <span class=\"keyword\">RENAME</span> <span class=\"keyword\">FILE</span> <span class=\"string\">''</span>+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/onlinelog/group_3<span class=\"number\">.267</span><span class=\"number\">.854775195</span><span class=\"string\">''</span>  <span class=\"keyword\">to</span>  <span class=\"string\">''</span>/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/redo3b.log<span class=\"string\">''</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">Starting</span> <span class=\"keyword\">restore</span> <span class=\"keyword\">at</span> <span class=\"number\">18</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"></span><br><span class=\"line\">skipping <span class=\"keyword\">datafile</span> <span class=\"number\">2</span>; already restored to file /u01/app/oracle/oradata/min/sysaux01.dbf</span><br><span class=\"line\">channel c1: starting datafile <span class=\"keyword\">backup</span> <span class=\"keyword\">set</span> <span class=\"keyword\">restore</span></span><br><span class=\"line\">channel c1: specifying <span class=\"keyword\">datafile</span>(s) <span class=\"keyword\">to</span> <span class=\"keyword\">restore</span> <span class=\"keyword\">from</span> <span class=\"keyword\">backup</span> <span class=\"keyword\">set</span></span><br><span class=\"line\">channel c1: restoring <span class=\"keyword\">datafile</span> <span class=\"number\">00001</span> <span class=\"keyword\">to</span> /u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/system01.dbf</span><br><span class=\"line\">channel c1: restoring <span class=\"keyword\">datafile</span> <span class=\"number\">00004</span> <span class=\"keyword\">to</span> /u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/users01.dbf</span><br><span class=\"line\">channel c1: reading <span class=\"keyword\">from</span> <span class=\"keyword\">backup</span> piece /u01/rmanbackup/db2.rman</span><br><span class=\"line\">channel c2: <span class=\"keyword\">starting</span> <span class=\"keyword\">datafile</span> <span class=\"keyword\">backup</span> <span class=\"keyword\">set</span> <span class=\"keyword\">restore</span></span><br><span class=\"line\">channel c2: specifying <span class=\"keyword\">datafile</span>(s) <span class=\"keyword\">to</span> <span class=\"keyword\">restore</span> <span class=\"keyword\">from</span> <span class=\"keyword\">backup</span> <span class=\"keyword\">set</span></span><br><span class=\"line\">channel c2: restoring <span class=\"keyword\">datafile</span> <span class=\"number\">00003</span> <span class=\"keyword\">to</span> /u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/undotbs01.dbf</span><br><span class=\"line\">channel c2: reading <span class=\"keyword\">from</span> <span class=\"keyword\">backup</span> piece /u01/rmanbackup/db1.rman</span><br><span class=\"line\">channel c2: piece handle=/u01/rmanbackup/db1.rman tag=DB_RMAN</span><br><span class=\"line\">channel c2: restored <span class=\"keyword\">backup</span> piece <span class=\"number\">1</span></span><br><span class=\"line\">channel c2: <span class=\"keyword\">restore</span> <span class=\"keyword\">complete</span>, elapsed <span class=\"built_in\">time</span>: <span class=\"number\">00</span>:<span class=\"number\">00</span>:<span class=\"number\">08</span></span><br><span class=\"line\">channel c1: piece handle=/u01/rmanbackup/db2.rman tag=DB_RMAN</span><br><span class=\"line\">channel c1: restored <span class=\"keyword\">backup</span> piece <span class=\"number\">1</span></span><br><span class=\"line\">channel c1: <span class=\"keyword\">restore</span> <span class=\"keyword\">complete</span>, elapsed <span class=\"built_in\">time</span>: <span class=\"number\">00</span>:<span class=\"number\">00</span>:<span class=\"number\">36</span></span><br><span class=\"line\">Finished <span class=\"keyword\">restore</span> <span class=\"keyword\">at</span> <span class=\"number\">18</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">datafile</span> <span class=\"number\">1</span> switched <span class=\"keyword\">to</span> <span class=\"keyword\">datafile</span> copy</span><br><span class=\"line\"><span class=\"keyword\">input</span> <span class=\"keyword\">datafile</span> copy RECID=<span class=\"number\">5</span> STAMP=<span class=\"number\">890701322</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/system01.dbf</span><br><span class=\"line\"><span class=\"keyword\">datafile</span> <span class=\"number\">2</span> switched <span class=\"keyword\">to</span> <span class=\"keyword\">datafile</span> copy</span><br><span class=\"line\"><span class=\"keyword\">input</span> <span class=\"keyword\">datafile</span> copy RECID=<span class=\"number\">6</span> STAMP=<span class=\"number\">890701322</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/sysaux01.dbf</span><br><span class=\"line\"><span class=\"keyword\">datafile</span> <span class=\"number\">3</span> switched <span class=\"keyword\">to</span> <span class=\"keyword\">datafile</span> copy</span><br><span class=\"line\"><span class=\"keyword\">input</span> <span class=\"keyword\">datafile</span> copy RECID=<span class=\"number\">7</span> STAMP=<span class=\"number\">890701322</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/undotbs01.dbf</span><br><span class=\"line\"><span class=\"keyword\">datafile</span> <span class=\"number\">4</span> switched <span class=\"keyword\">to</span> <span class=\"keyword\">datafile</span> copy</span><br><span class=\"line\"><span class=\"keyword\">input</span> <span class=\"keyword\">datafile</span> copy RECID=<span class=\"number\">8</span> STAMP=<span class=\"number\">890701322</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/users01.dbf</span><br><span class=\"line\"></span><br><span class=\"line\">renamed tempfile <span class=\"number\">1</span> <span class=\"keyword\">to</span> /u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/temp01.dbf <span class=\"keyword\">in</span> control <span class=\"keyword\">file</span></span><br><span class=\"line\">released channel: c1</span><br><span class=\"line\">released channel: c2</span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>restore完毕，我们再来看一下控制文件中的信息</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">RMAN&gt; report schema;</span><br><span class=\"line\"></span><br><span class=\"line\">RMAN-06139: WARNING: control file is not current for REPORT SCHEMA</span><br><span class=\"line\">Report of database schema for database <span class=\"keyword\">with</span> db_unique_name <span class=\"keyword\">MIN</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">List</span> <span class=\"keyword\">of</span> <span class=\"keyword\">Permanent</span> <span class=\"keyword\">Datafiles</span></span><br><span class=\"line\">===========================</span><br><span class=\"line\"><span class=\"keyword\">File</span> <span class=\"keyword\">Size</span>(MB) <span class=\"keyword\">Tablespace</span>           RB segs <span class=\"keyword\">Datafile</span> <span class=\"keyword\">Name</span></span><br><span class=\"line\"><span class=\"comment\">---- -------- -------------------- ------- ------------------------</span></span><br><span class=\"line\"><span class=\"number\">1</span>    <span class=\"number\">750</span>      <span class=\"keyword\">SYSTEM</span>               ***     /u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/system01.dbf</span><br><span class=\"line\"><span class=\"number\">2</span>    <span class=\"number\">560</span>      <span class=\"keyword\">SYSAUX</span>               ***     /u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/sysaux01.dbf</span><br><span class=\"line\"><span class=\"number\">3</span>    <span class=\"number\">100</span>      UNDOTBS1             ***     /u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/undotbs01.dbf</span><br><span class=\"line\"><span class=\"number\">4</span>    <span class=\"number\">5</span>        <span class=\"keyword\">USERS</span>                ***     /u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/users01.dbf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">List</span> <span class=\"keyword\">of</span> <span class=\"keyword\">Temporary</span> Files</span><br><span class=\"line\">=======================</span><br><span class=\"line\"><span class=\"keyword\">File</span> <span class=\"keyword\">Size</span>(MB) <span class=\"keyword\">Tablespace</span>           <span class=\"keyword\">Maxsize</span>(MB) Tempfile <span class=\"keyword\">Name</span></span><br><span class=\"line\"><span class=\"comment\">---- -------- -------------------- ----------- --------------------</span></span><br><span class=\"line\"><span class=\"number\">1</span>    <span class=\"number\">20</span>       TEMP                 <span class=\"number\">32767</span>       /u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/temp01.dbf</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"完全恢复数据库\"><a href=\"#完全恢复数据库\" class=\"headerlink\" title=\"完全恢复数据库\"></a>完全恢复数据库</h3><figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">RMAN&gt; recover database;</span><br><span class=\"line\"></span><br><span class=\"line\">Starting recover at 18-SEP-15</span><br><span class=\"line\">allocated channel: ORA_DISK_1</span><br><span class=\"line\">channel ORA_DISK_1: SID=1146 device type=DISK</span><br><span class=\"line\">allocated channel: ORA_DISK_2</span><br><span class=\"line\">channel ORA_DISK_2: SID=11 device type=DISK</span><br><span class=\"line\">allocated channel: ORA_DISK_3</span><br><span class=\"line\">channel ORA_DISK_3: SID=1137 device type=DISK</span><br><span class=\"line\">allocated channel: ORA_DISK_4</span><br><span class=\"line\">channel ORA_DISK_4: SID=10 device type=DISK</span><br><span class=\"line\"></span><br><span class=\"line\">starting media recovery</span><br><span class=\"line\"></span><br><span class=\"line\">archived log for thread 1 <span class=\"keyword\">with</span> <span class=\"keyword\">sequence</span> <span class=\"number\">38</span> <span class=\"keyword\">is</span> already <span class=\"keyword\">on</span> disk <span class=\"keyword\">as</span> <span class=\"keyword\">file</span> /u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/redo2a.log</span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">for</span> <span class=\"keyword\">thread</span> <span class=\"number\">1</span> <span class=\"keyword\">with</span> <span class=\"keyword\">sequence</span> <span class=\"number\">39</span> <span class=\"keyword\">is</span> already <span class=\"keyword\">on</span> disk <span class=\"keyword\">as</span> <span class=\"keyword\">file</span> /u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/redo3a.log</span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">for</span> <span class=\"keyword\">thread</span> <span class=\"number\">1</span> <span class=\"keyword\">with</span> <span class=\"keyword\">sequence</span> <span class=\"number\">40</span> <span class=\"keyword\">is</span> already <span class=\"keyword\">on</span> disk <span class=\"keyword\">as</span> <span class=\"keyword\">file</span> /u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/redo1a.log</span><br><span class=\"line\">channel ORA_DISK_1: <span class=\"keyword\">starting</span> <span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">restore</span> <span class=\"keyword\">to</span> <span class=\"keyword\">default</span> destination</span><br><span class=\"line\">channel ORA_DISK_1: restoring <span class=\"keyword\">archived</span> <span class=\"keyword\">log</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">20</span></span><br><span class=\"line\">channel ORA_DISK_1: reading <span class=\"keyword\">from</span> <span class=\"keyword\">backup</span> piece /u01/rmanbackup/arc2.rman</span><br><span class=\"line\">channel ORA_DISK_2: <span class=\"keyword\">starting</span> <span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">restore</span> <span class=\"keyword\">to</span> <span class=\"keyword\">default</span> destination</span><br><span class=\"line\">channel ORA_DISK_2: restoring <span class=\"keyword\">archived</span> <span class=\"keyword\">log</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">21</span></span><br><span class=\"line\">channel ORA_DISK_2: reading <span class=\"keyword\">from</span> <span class=\"keyword\">backup</span> piece /u01/rmanbackup/arc1.rman</span><br><span class=\"line\">channel ORA_DISK_2: piece handle=/u01/rmanbackup/arc1.rman tag=ARC_RMAN</span><br><span class=\"line\">channel ORA_DISK_2: restored <span class=\"keyword\">backup</span> piece <span class=\"number\">1</span></span><br><span class=\"line\">channel ORA_DISK_2: <span class=\"keyword\">restore</span> <span class=\"keyword\">complete</span>, elapsed <span class=\"built_in\">time</span>: <span class=\"number\">00</span>:<span class=\"number\">00</span>:<span class=\"number\">01</span></span><br><span class=\"line\">channel ORA_DISK_1: piece handle=/u01/rmanbackup/arc2.rman tag=ARC_RMAN</span><br><span class=\"line\">channel ORA_DISK_1: restored <span class=\"keyword\">backup</span> piece <span class=\"number\">1</span></span><br><span class=\"line\">channel ORA_DISK_1: <span class=\"keyword\">restore</span> <span class=\"keyword\">complete</span>, elapsed <span class=\"built_in\">time</span>: <span class=\"number\">00</span>:<span class=\"number\">00</span>:<span class=\"number\">03</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_20_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">20</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_21_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">21</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_22_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">22</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_23_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">23</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_24_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">24</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_25_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">25</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_26_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">26</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_27_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">27</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_28_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">28</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_29_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">29</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_30_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">30</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_31_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">31</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_32_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">32</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_33_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">33</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_34_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">34</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_35_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">35</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_36_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">36</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_37_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">37</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/redo2a.log <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">38</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/redo3a.log <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">39</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/redo1a.log <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">40</span></span><br><span class=\"line\">media <span class=\"keyword\">recovery</span> <span class=\"keyword\">complete</span>, elapsed <span class=\"built_in\">time</span>: <span class=\"number\">00</span>:<span class=\"number\">00</span>:<span class=\"number\">43</span></span><br><span class=\"line\">Finished <span class=\"keyword\">recover</span> <span class=\"keyword\">at</span> <span class=\"number\">18</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt;</span><br></pre></td></tr></table></figure>\n\n<p>从恢复的日志可以看出，oracle会绕过38、39号的归档直接利用在线日志做恢复，oracle的聪明之处可见一斑！<br>试着正常方式打开数据库，会发现报错：</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">RMAN&gt; alter database open;</span><br><span class=\"line\"></span><br><span class=\"line\">RMAN-00571: ===========================================================</span><br><span class=\"line\">RMAN-00569: =============== ERROR MESSAGE STACK FOLLOWS ===============</span><br><span class=\"line\">RMAN-00571: ===========================================================</span><br><span class=\"line\">RMAN-03002: failure of <span class=\"keyword\">alter</span> db command <span class=\"keyword\">at</span> <span class=\"number\">09</span>/<span class=\"number\">18</span>/<span class=\"number\">2015</span> <span class=\"number\">01</span>:<span class=\"number\">04</span>:<span class=\"number\">41</span></span><br><span class=\"line\">ORA<span class=\"number\">-01589</span>: must <span class=\"keyword\">use</span> <span class=\"keyword\">RESETLOGS</span> <span class=\"keyword\">or</span> <span class=\"keyword\">NORESETLOGS</span> <span class=\"keyword\">option</span> <span class=\"keyword\">for</span> <span class=\"keyword\">database</span> <span class=\"keyword\">open</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">--看一下此时控制文件中的日志序列号，会发现没有前推，必须用resetlogs打开数据库</span></span><br><span class=\"line\"><span class=\"keyword\">SQL</span>&gt;  <span class=\"keyword\">select</span> <span class=\"keyword\">group</span><span class=\"comment\">#,status,sequence# from v$log;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">GROUP</span><span class=\"comment\"># STATUS            SEQUENCE#</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------------- ----------</span></span><br><span class=\"line\">         <span class=\"number\">1</span> <span class=\"keyword\">CURRENT</span>                  <span class=\"number\">22</span></span><br><span class=\"line\">         <span class=\"number\">3</span> ACTIVE                   <span class=\"number\">21</span></span><br><span class=\"line\">         <span class=\"number\">2</span> ACTIVE                   <span class=\"number\">20</span></span><br><span class=\"line\">RMAN&gt; <span class=\"keyword\">alter</span> <span class=\"keyword\">database</span> <span class=\"keyword\">open</span> <span class=\"keyword\">resetlogs</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">database opened</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>使用resetlog的原因是recover命令只能修复控制文件中数据物理结构信息，而无法修改控制文件中的当前重做日志的序列号的信息，recover命令结束后，控制文件中的当前日志序列号还是陈旧的，若按常规方式打开数据库，将报错，为了抹去控制文件这个固执的念头，oracle采用重设日志的功能，日志序列号从1开始。此处虽然使用了resetlogs，但是因为“recover database”命令执行成功，所有提交的事务不会丢失，resetlogs仅仅是为了照顾还原的控制文件，与不完全恢复的resetlogs是不同的，至此恢复结束。</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; conn test/test</span><br><span class=\"line\">ERROR:</span><br><span class=\"line\">ORA-28002: the password will expire within 6 days</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Connected.</span><br><span class=\"line\">SQL&gt; select count(1) from t;</span><br><span class=\"line\"></span><br><span class=\"line\">  COUNT(1)</span><br><span class=\"line\"><span class=\"comment\">----------</span></span><br><span class=\"line\">   3000000</span><br></pre></td></tr></table></figure>\n\n","site":{"data":{"styles":"","footer":"<div class=\"footer-custom\">\nTheme source code <span class=\"exturl theme-link\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvaGV4by10aGVtZS1uZXh0\">here</span><br>\nWebsite source code <span class=\"exturl theme-link\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvdGhlbWUtbmV4dC5vcmc=\">here</span>\n</div>\n"}},"excerpt":"<blockquote>\n<p>开始</p>\n</blockquote>\n<p>先说一下为什么要写这个异机完全恢复的blog，作为一个年轻的DBA，相信大多数都是备份长做而恢复不常做，我会经常担心我的生产库的服务器挂了怎么办，我的备份完好，但我们又没有容灾，我能否保证我的数据不丢失呢，所以就要rman利用备份重建，而如果此时我能找到完好无损的在线日志，我是不是可以完全恢复了呢，理论上大家都说可以，确从未在网上见到过完全恢复的事例（完全其实很简单，只是网上阐述了太多的不完全恢复，会让我觉得set until time等等是必备的其中一步），甚至oracle的官方网文档上也使用了“SET UNTIL SCN 123456;” 的案例，有鉴于此，我做了这个实验，并记录下来，跟大家分享，不见得这篇原创有多高深的技术和见解O(∩_∩)O</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">环境：</span><br><span class=\"line\">    源库：</span><br><span class=\"line\">        os：redhat 6.3 x64</span><br><span class=\"line\">        db: 11gr2 11.2.0.4</span><br><span class=\"line\">        存储方式：ASM</span><br><span class=\"line\">    目标库：</span><br><span class=\"line\">        os：redhat 6.5 x64</span><br><span class=\"line\">        db: 11gr2 11.2.0.4</span><br><span class=\"line\">        存储方式：文件系统</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"1-首先，源库进行rman备份\"><a href=\"#1-首先，源库进行rman备份\" class=\"headerlink\" title=\"1. 首先，源库进行rman备份\"></a>1. 首先，源库进行rman备份</h2><figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">--手动0级全库备份</span></span><br><span class=\"line\">run &#123;</span><br><span class=\"line\">    CONFIGURE RETENTION POLICY TO RECOVERY WINDOW OF 7 DAYS;</span><br><span class=\"line\">    CONFIGURE <span class=\"keyword\">BACKUP</span> OPTIMIZATION <span class=\"keyword\">ON</span>;</span><br><span class=\"line\">    CONFIGURE CONTROLFILE AUTOBACKUP ON;</span><br><span class=\"line\">    CONFIGURE DEVICE TYPE DISK PARALLELISM 4 <span class=\"keyword\">BACKUP</span> <span class=\"keyword\">TYPE</span> <span class=\"keyword\">TO</span> BACKUPSET;</span><br><span class=\"line\">    CONFIGURE CONTROLFILE AUTOBACKUP FORMAT FOR DEVICE TYPE DISK TO '+DATA/<span class=\"keyword\">backup</span>/ctl_atuo_%F<span class=\"string\">';</span></span><br><span class=\"line\"><span class=\"string\">    ALLOCATE CHANNEL c1 TYPE DISK;</span></span><br><span class=\"line\"><span class=\"string\">    ALLOCATE CHANNEL c2 TYPE DISK;</span></span><br><span class=\"line\"><span class=\"string\">    CROSSCHECK ARCHIVELOG ALL;</span></span><br><span class=\"line\"><span class=\"string\">    BACKUP INCREMENTAL LEVEL 0</span></span><br><span class=\"line\"><span class=\"string\">    DATABASE FORMAT '</span>+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/db_%U<span class=\"string\">' TAG '</span>db_rman<span class=\"string\">';</span></span><br><span class=\"line\"><span class=\"string\">    SQL '</span><span class=\"keyword\">ALTER</span> <span class=\"keyword\">SYSTEM</span> <span class=\"keyword\">ARCHIVE</span> <span class=\"keyword\">LOG</span> <span class=\"keyword\">CURRENT</span><span class=\"string\">';</span></span><br><span class=\"line\"><span class=\"string\">    BACKUP ARCHIVELOG ALL FORMAT '</span>+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/arc_%U<span class=\"string\">' TAG '</span>ARC_rman<span class=\"string\">'</span></span><br><span class=\"line\"><span class=\"string\">    DELETE INPUT;</span></span><br><span class=\"line\"><span class=\"string\">    DELETE NOPROMPT OBSOLETE;</span></span><br><span class=\"line\"><span class=\"string\">    RELEASE CHANNEL c1;</span></span><br><span class=\"line\"><span class=\"string\">    RELEASE CHANNEL c2;</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br></pre></td></tr></table></figure>","more":"<h3 id=\"观察备份的文件，此处是ASM分别用asmcmd和rman查看\"><a href=\"#观察备份的文件，此处是ASM分别用asmcmd和rman查看\" class=\"headerlink\" title=\"观察备份的文件，此处是ASM分别用asmcmd和rman查看\"></a>观察备份的文件，此处是ASM分别用asmcmd和rman查看</h3><figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">ASMCMD&gt; ls</span><br><span class=\"line\">arc_0cqhdnqq_1_1</span><br><span class=\"line\">arc_0dqhdnqq_1_1</span><br><span class=\"line\">ctl_atuo_c-2496627597-20150917-00</span><br><span class=\"line\">ctl_atuo_c-2496627597-20150917-01</span><br><span class=\"line\">db_09qhdno6_1_1</span><br><span class=\"line\">db_0aqhdno6_1_1</span><br><span class=\"line\">ASMCMD&gt; pwd</span><br><span class=\"line\">+Data/<span class=\"keyword\">backup</span></span><br><span class=\"line\">ASMCMD&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt; <span class=\"keyword\">list</span> <span class=\"keyword\">backup</span> summary;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">List of Backups</span><br><span class=\"line\">===============</span><br><span class=\"line\">Key     TY LV S Device Type Completion Time <span class=\"comment\">#Pieces #Copies Compressed Tag</span></span><br><span class=\"line\"><span class=\"comment\">------- -- -- - ----------- --------------- ------- ------- ---------- ---</span></span><br><span class=\"line\">9       B  0  A DISK        17-SEP-15       1       1       NO         DB_RMAN</span><br><span class=\"line\">10      B  0  A DISK        17-SEP-15       1       1       NO         DB_RMAN</span><br><span class=\"line\">11      B  F  A DISK        17-SEP-15       1       1       NO         TAG20150917T221650</span><br><span class=\"line\">12      B  A  A DISK        17-SEP-15       1       1       NO         ARC_RMAN</span><br><span class=\"line\">13      B  A  A DISK        17-SEP-15       1       1       NO         ARC_RMAN</span><br><span class=\"line\">14      B  F  A DISK        17-SEP-15       1       1       NO         TAG20150917T221703</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"为了试验restore之后recover应用归档日志的情况，我在0级备份之后再生成一些归档日志，脚本如下：\"><a href=\"#为了试验restore之后recover应用归档日志的情况，我在0级备份之后再生成一些归档日志，脚本如下：\" class=\"headerlink\" title=\"为了试验restore之后recover应用归档日志的情况，我在0级备份之后再生成一些归档日志，脚本如下：\"></a>为了试验restore之后recover应用归档日志的情况，我在0级备份之后再生成一些归档日志，脚本如下：</h3><figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">declare</span></span><br><span class=\"line\">  i <span class=\"built_in\">integer</span>;</span><br><span class=\"line\"><span class=\"keyword\">begin</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"number\">1.</span><span class=\"number\">.3000000</span> <span class=\"keyword\">loop</span></span><br><span class=\"line\">    <span class=\"keyword\">insert</span> <span class=\"keyword\">into</span> t <span class=\"keyword\">values</span>(i,<span class=\"string\">'aaaaaaaaaaaaaaaaaaaaa'</span>);</span><br><span class=\"line\">    <span class=\"keyword\">end</span> <span class=\"keyword\">loop</span>;</span><br><span class=\"line\"><span class=\"keyword\">end</span>;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"向测试表T中插入200万行数据，看归档的日志：\"><a href=\"#向测试表T中插入200万行数据，看归档的日志：\" class=\"headerlink\" title=\"向测试表T中插入200万行数据，看归档的日志：\"></a>向测试表T中插入200万行数据，看归档的日志：</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">ASMCMD&gt; ls</span><br><span class=\"line\">1_22_854775184.dbf</span><br><span class=\"line\">1_23_854775184.dbf</span><br><span class=\"line\">1_24_854775184.dbf</span><br><span class=\"line\">1_25_854775184.dbf</span><br><span class=\"line\">1_26_854775184.dbf</span><br><span class=\"line\">1_27_854775184.dbf</span><br><span class=\"line\">1_28_854775184.dbf</span><br><span class=\"line\">1_29_854775184.dbf</span><br><span class=\"line\">1_30_854775184.dbf</span><br><span class=\"line\">1_31_854775184.dbf</span><br><span class=\"line\">1_32_854775184.dbf</span><br><span class=\"line\">1_33_854775184.dbf</span><br><span class=\"line\">1_34_854775184.dbf</span><br><span class=\"line\">1_35_854775184.dbf</span><br><span class=\"line\">1_36_854775184.dbf</span><br><span class=\"line\">1_37_854775184.dbf</span><br><span class=\"line\">1_38_854775184.dbf</span><br><span class=\"line\">1_39_854775184.dbf</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"查看T表的行数\"><a href=\"#查看T表的行数\" class=\"headerlink\" title=\"查看T表的行数\"></a>查看T表的行数</h3><figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select count(1) from t;</span><br><span class=\"line\"></span><br><span class=\"line\">  COUNT(1)</span><br><span class=\"line\"><span class=\"comment\">----------</span></span><br><span class=\"line\">   3000000</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-转移备份\"><a href=\"#2-转移备份\" class=\"headerlink\" title=\"2. 转移备份\"></a>2. 转移备份</h2><p>现在要把rman备份，备份之后的归档，源库关闭之后的在线redo文件拷贝到备库，这里稍微麻烦一点，涉及到从asm中拷贝文件，我这里使用2中方法，rman的backup as cpoy以及asmcmd的cp命令，如下所示：</p>\n<blockquote>\n<p>rman copy备份集</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">--这里是copy 0级备份</span></span><br><span class=\"line\"><span class=\"keyword\">backup</span> <span class=\"keyword\">as</span> copy backupset <span class=\"number\">9</span> <span class=\"keyword\">format</span> <span class=\"string\">'/u01/backupset/db2.rman'</span>;</span><br><span class=\"line\"><span class=\"keyword\">backup</span> <span class=\"keyword\">as</span> copy backupset <span class=\"number\">10</span> <span class=\"keyword\">format</span> <span class=\"string\">'/u01/backupset/db2.rman'</span>;</span><br><span class=\"line\"><span class=\"keyword\">backup</span> <span class=\"keyword\">as</span> copy backupset <span class=\"number\">11</span> <span class=\"keyword\">format</span> <span class=\"string\">'/u01/backupset/ctl1.rman'</span>;</span><br><span class=\"line\"><span class=\"keyword\">backup</span> <span class=\"keyword\">as</span> copy backupset <span class=\"number\">12</span> <span class=\"keyword\">format</span> <span class=\"string\">'/u01/backupset/arc1.rman'</span>;</span><br><span class=\"line\"><span class=\"keyword\">backup</span> <span class=\"keyword\">as</span> copy backupset <span class=\"number\">13</span> <span class=\"keyword\">format</span> <span class=\"string\">'/u01/backupset/arc2.rman'</span>;</span><br><span class=\"line\"><span class=\"keyword\">backup</span> <span class=\"keyword\">as</span> copy backupset <span class=\"number\">14</span> <span class=\"keyword\">format</span> <span class=\"string\">'/u01/backupset/ctl2.rman'</span>;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>asmcmd转移归档</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">--生成的归档日志</span><br><span class=\"line\">ASMCMD&gt; ls</span><br><span class=\"line\">1_22_854775184.dbf</span><br><span class=\"line\">1_23_854775184.dbf</span><br><span class=\"line\">1_24_854775184.dbf</span><br><span class=\"line\">1_25_854775184.dbf</span><br><span class=\"line\">1_26_854775184.dbf</span><br><span class=\"line\">1_27_854775184.dbf</span><br><span class=\"line\">1_28_854775184.dbf</span><br><span class=\"line\">1_29_854775184.dbf</span><br><span class=\"line\">1_30_854775184.dbf</span><br><span class=\"line\">1_31_854775184.dbf</span><br><span class=\"line\">1_32_854775184.dbf</span><br><span class=\"line\">1_33_854775184.dbf</span><br><span class=\"line\">1_34_854775184.dbf</span><br><span class=\"line\">1_35_854775184.dbf</span><br><span class=\"line\">1_36_854775184.dbf</span><br><span class=\"line\">1_37_854775184.dbf</span><br><span class=\"line\">1_38_854775184.dbf</span><br><span class=\"line\">1_39_854775184.dbf</span><br><span class=\"line\">--copy走，无法使用通配符是一件很痛苦的事情</span><br><span class=\"line\">ASMCMD&gt; cp 1_23_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_23_854775184.dbf -&gt; /u02/backupset/1_23_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_24_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_24_854775184.dbf -&gt; /u02/backupset/1_24_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_25_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_25_854775184.dbf -&gt; /u02/backupset/1_25_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_26_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_26_854775184.dbf -&gt; /u02/backupset/1_26_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_27_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_27_854775184.dbf -&gt; /u02/backupset/1_27_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_28_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_28_854775184.dbf -&gt; /u02/backupset/1_28_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_29_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_29_854775184.dbf -&gt; /u02/backupset/1_29_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_3* /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_30_854775184.dbf -&gt; /u02/backupset/1_30_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_31_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_31_854775184.dbf -&gt; /u02/backupset/1_31_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_32_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_32_854775184.dbf -&gt; /u02/backupset/1_32_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_33_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_33_854775184.dbf -&gt; /u02/backupset/1_33_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_34_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_34_854775184.dbf -&gt; /u02/backupset/1_34_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_35_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_35_854775184.dbf -&gt; /u02/backupset/1_35_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_36_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_36_854775184.dbf -&gt; /u02/backupset/1_36_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_37_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_37_854775184.dbf -&gt; /u02/backupset/1_37_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_38_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_38_854775184.dbf -&gt; /u02/backupset/1_38_854775184.dbf</span><br><span class=\"line\">ASMCMD&gt; cp 1_39_854775184.dbf /u02/backupset</span><br><span class=\"line\">copying +Data/archive_log/1_39_854775184.dbf -&gt; /u02/backupset/1_39_854775184.dbf</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"查看当前的redo状态-记住当前redo的seq号\"><a href=\"#查看当前的redo状态-记住当前redo的seq号\" class=\"headerlink\" title=\"查看当前的redo状态,记住当前redo的seq号\"></a>查看当前的redo状态,记住当前redo的seq号</h3><figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select group#,SEQUENCE# ,MEMBERS,ARCHIVED,STATUS from v$log;</span><br><span class=\"line\"></span><br><span class=\"line\">    GROUP<span class=\"comment\">#  SEQUENCE#    MEMBERS ARC STATUS</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- ---------- --- ----------------</span></span><br><span class=\"line\">         1         40          2 NO  CURRENT</span><br><span class=\"line\">         2         38          2 YES INACTIVE</span><br><span class=\"line\">         3         39          2 YES INACTIVE</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"查看redo文件\"><a href=\"#查看redo文件\" class=\"headerlink\" title=\"查看redo文件\"></a>查看redo文件</h3> <figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"> SQL&gt; select GROUP#,STATUS,MEMBER  from v$logfile;</span><br><span class=\"line\"></span><br><span class=\"line\">    GROUP<span class=\"comment\"># STATUS  MEMBER</span></span><br><span class=\"line\"><span class=\"comment\">---------- ------- --------------------------------------------------------------------------------</span></span><br><span class=\"line\">         3         +DATA/min/onlinelog/group_3.266.854775193</span><br><span class=\"line\">         3         +DATA/min/onlinelog/group_3.267.854775195</span><br><span class=\"line\">         2         +DATA/min/onlinelog/group_2.264.854775189</span><br><span class=\"line\">         2         +DATA/min/onlinelog/group_2.265.854775191</span><br><span class=\"line\">         1         +DATA/min/onlinelog/group_1.262.854775185</span><br><span class=\"line\">         1         +DATA/min/onlinelog/group_1.263.854775187</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>使用asmcmd拷贝并改名，这个时候我已经关闭了源库</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">ASMCMD&gt; cd onlinelog</span><br><span class=\"line\">ASMCMD&gt;</span><br><span class=\"line\">ASMCMD&gt; ls</span><br><span class=\"line\">group_1.262.854775185</span><br><span class=\"line\">group_1.263.854775187</span><br><span class=\"line\">group_2.264.854775189</span><br><span class=\"line\">group_2.265.854775191</span><br><span class=\"line\">group_3.266.854775193</span><br><span class=\"line\">group_3.267.854775195</span><br><span class=\"line\"></span><br><span class=\"line\">ASMCMD&gt; cp group_1.262.854775185 /u02/backupset/redo1a.log</span><br><span class=\"line\">copying +Data/min/onlinelog/group_1.262.854775185 -&gt; /u02/backupset/redo1a.log</span><br><span class=\"line\">ASMCMD&gt; cp group_1.263.854775187 /u02/backupset/redo1b.log</span><br><span class=\"line\">copying +Data/min/onlinelog/group_1.263.854775187 -&gt; /u02/backupset/redo1b.log</span><br><span class=\"line\">ASMCMD&gt; cp group_2.264.854775189 /u02/backupset/redo2a.log</span><br><span class=\"line\">copying +Data/min/onlinelog/group_2.264.854775189 -&gt; /u02/backupset/redo2a.log</span><br><span class=\"line\">ASMCMD&gt; cp group_2.265.854775191 /u02/backupset/redo2b.log</span><br><span class=\"line\">copying +Data/min/onlinelog/group_2.265.854775191 -&gt; /u02/backupset/redo2b.log</span><br><span class=\"line\">ASMCMD&gt; cp group_3.266.854775193 /u02/backupset/redo3a.log</span><br><span class=\"line\">copying +Data/min/onlinelog/group_3.266.854775193 -&gt; /u02/backupset/redo3a.log</span><br><span class=\"line\">ASMCMD&gt; cp group_3.267.854775195 /u02/backupset/redo3b.log</span><br><span class=\"line\">copying +Data/min/onlinelog/group_3.267.854775195 -&gt; /u02/backupset/redo3b.log</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-目标机器恢复\"><a href=\"#3-目标机器恢复\" class=\"headerlink\" title=\"3.  目标机器恢复\"></a>3.  目标机器恢复</h2><p>这一步之前已经在目标主机安装好oracle软件，安装过程不再赘述，直接记录恢复过程<br>这里直接从备份中恢复pfile（比较懒，不想手动准备），无参数文件，rman会启动一个傻瓜实例，供我们恢复参数文件。</p>\n<p>###从备份中恢复参数文件</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">RMAN&gt; startup nomount</span><br><span class=\"line\"></span><br><span class=\"line\">startup failed: ORA-01078: failure in processing system parameters</span><br><span class=\"line\">LRM-00109: could not open parameter file '/home/oracle/app/oracle/product/11.2.0/dbhome_1/dbs/initmin.ora'</span><br><span class=\"line\"></span><br><span class=\"line\">starting Oracle instance without parameter file for retrieval of spfile</span><br><span class=\"line\">Oracle instance started</span><br><span class=\"line\"></span><br><span class=\"line\">Total System Global Area    1068937216 bytes</span><br><span class=\"line\"></span><br><span class=\"line\">Fixed Size                     2260088 bytes</span><br><span class=\"line\">Variable Size                281019272 bytes</span><br><span class=\"line\">Database Buffers             780140544 bytes</span><br><span class=\"line\">Redo Buffers                   5517312 bytes</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt; restore spfile to pfile '/home/oracle/app/oracle/product/11.2.0/dbhome_1/dbs/initmin.ora' from '/u01/rmanbackup/ctl2.rman';</span><br><span class=\"line\"></span><br><span class=\"line\">Starting <span class=\"keyword\">restore</span> <span class=\"keyword\">at</span> <span class=\"number\">18</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"><span class=\"keyword\">using</span> target <span class=\"keyword\">database</span> control <span class=\"keyword\">file</span> instead <span class=\"keyword\">of</span> <span class=\"keyword\">recovery</span> <span class=\"keyword\">catalog</span></span><br><span class=\"line\">allocated channel: ORA_DISK_1</span><br><span class=\"line\">channel ORA_DISK_1: <span class=\"keyword\">SID</span>=<span class=\"number\">171</span> device <span class=\"keyword\">type</span>=DISK</span><br><span class=\"line\"></span><br><span class=\"line\">channel ORA_DISK_1: restoring <span class=\"keyword\">spfile</span> <span class=\"keyword\">from</span> AUTOBACKUP /u01/rmanbackup/ctl2.rman</span><br><span class=\"line\">channel ORA_DISK_1: <span class=\"keyword\">SPFILE</span> <span class=\"keyword\">restore</span> <span class=\"keyword\">from</span> AUTOBACKUP <span class=\"keyword\">complete</span></span><br><span class=\"line\">Finished <span class=\"keyword\">restore</span> <span class=\"keyword\">at</span> <span class=\"number\">18</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt; <span class=\"keyword\">shutdown</span> <span class=\"keyword\">abort</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">Oracle</span> <span class=\"keyword\">instance</span> shut down</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"创建目录，修改参数文件\"><a href=\"#创建目录，修改参数文件\" class=\"headerlink\" title=\"创建目录，修改参数文件\"></a>创建目录，修改参数文件</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">[oracle@rman_newhost u01]$ mkdir -p /u01/app/oracle/admin/min/adump</span><br><span class=\"line\">[oracle@rman_newhost u01]$ mkdir -p /u01/app/oracle/fast_recovery_area</span><br><span class=\"line\">[oracle@rman_newhost u01]$ mkdir -p /u01/app/oracle/archived_log</span><br><span class=\"line\">[oracle@rman_newhost u01]$ mkdir -p /u01/app/oracle/oradata/min</span><br><span class=\"line\">*.audit_file_dest=<span class=\"string\">'/u01/app/oracle/admin/min/adump'</span></span><br><span class=\"line\">*.audit_trail=<span class=\"string\">'db'</span></span><br><span class=\"line\">*.compatible=<span class=\"string\">'11.2.0.4.0'</span></span><br><span class=\"line\">*.control_files=<span class=\"string\">'/u01/app/oracle/fast_recovery_area/control01.ctl'</span>,<span class=\"string\">'/u01/app/oracle/oradata/min/control02.ctl'</span></span><br><span class=\"line\">*.db_block_size=8192</span><br><span class=\"line\">*.db_domain=<span class=\"string\">''</span></span><br><span class=\"line\">*.db_name=<span class=\"string\">'min'</span></span><br><span class=\"line\">*.db_recovery_file_dest=<span class=\"string\">'/u01/app/oracle/fast_recovery_area'</span></span><br><span class=\"line\">*.db_recovery_file_dest_size=4385144832</span><br><span class=\"line\">*.diagnostic_dest=<span class=\"string\">'/u01/app/oracle'</span></span><br><span class=\"line\">*.dispatchers=<span class=\"string\">'(PROTOCOL=TCP) (SERVICE=minXDB)'</span></span><br><span class=\"line\">*.log_archive_dest_1=<span class=\"string\">'location=/u01/app/oracle/archived_log'</span></span><br><span class=\"line\">*.log_checkpoints_to_alert=TRUE</span><br><span class=\"line\">*.memory_target=1394606080</span><br><span class=\"line\">*.open_cursors=300</span><br><span class=\"line\">*.processes=1500</span><br><span class=\"line\">*.remote_login_passwordfile=<span class=\"string\">'EXCLUSIVE'</span></span><br><span class=\"line\">*.sessions=1655</span><br><span class=\"line\">*.undo_tablespace=<span class=\"string\">'UNDOTBS1'</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"启动到nomount状态，恢复控制文件\"><a href=\"#启动到nomount状态，恢复控制文件\" class=\"headerlink\" title=\"启动到nomount状态，恢复控制文件\"></a>启动到nomount状态，恢复控制文件</h3><figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">RMAN&gt; startup nomount</span><br><span class=\"line\"></span><br><span class=\"line\">connected to target database (not started)</span><br><span class=\"line\">Oracle instance started</span><br><span class=\"line\"></span><br><span class=\"line\">Total System Global Area    1402982400 bytes</span><br><span class=\"line\"></span><br><span class=\"line\">Fixed Size                     2253184 bytes</span><br><span class=\"line\">Variable Size               1275072128 bytes</span><br><span class=\"line\">Database Buffers             117440512 bytes</span><br><span class=\"line\">Redo Buffers                   8216576 bytes</span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt; restore controlfile from '/u01/rmanbackup/ctl2.rman';</span><br><span class=\"line\"></span><br><span class=\"line\">Starting <span class=\"keyword\">restore</span> <span class=\"keyword\">at</span> <span class=\"number\">18</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">allocated channel: ORA_DISK_1</span><br><span class=\"line\">channel ORA_DISK_1: <span class=\"keyword\">SID</span>=<span class=\"number\">1146</span> device <span class=\"keyword\">type</span>=DISK</span><br><span class=\"line\"></span><br><span class=\"line\">channel ORA_DISK_1: restoring control <span class=\"keyword\">file</span></span><br><span class=\"line\">channel ORA_DISK_1: <span class=\"keyword\">restore</span> <span class=\"keyword\">complete</span>, elapsed <span class=\"built_in\">time</span>: <span class=\"number\">00</span>:<span class=\"number\">00</span>:<span class=\"number\">01</span></span><br><span class=\"line\"><span class=\"keyword\">output</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/fast_recovery_area/control01.ctl</span><br><span class=\"line\"><span class=\"keyword\">output</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/control02.ctl</span><br><span class=\"line\">Finished <span class=\"keyword\">restore</span> <span class=\"keyword\">at</span> <span class=\"number\">18</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt; <span class=\"keyword\">alter</span> <span class=\"keyword\">database</span> <span class=\"keyword\">mount</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">database mounted</span><br><span class=\"line\">released channel: ORA_DISK_1</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"将redo文件和归档日志移动到对应目录下\"><a href=\"#将redo文件和归档日志移动到对应目录下\" class=\"headerlink\" title=\"将redo文件和归档日志移动到对应目录下\"></a>将redo文件和归档日志移动到对应目录下</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">[oracle@rman_newhost rmanbackup]$ mv redo* /u01/app/oracle/oradata/min</span><br><span class=\"line\">[oracle@rman_newhost rmanbackup]$ ll /u01/app/oracle/oradata/min</span><br><span class=\"line\">总用量 316744</span><br><span class=\"line\">-rw-r-----. 1 oracle oinstall 9748480 9月 18 00:34 control02.ctl</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 52429312 9月 17 23:00 redo1a.log</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 52429312 9月 17 23:01 redo1b.log</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 52429312 9月 17 23:01 redo2a.log</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 52429312 9月 17 23:01 redo2b.log</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 52429312 9月 17 23:02 redo3a.log</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 52429312 9月 17 23:02 redo3b.log</span><br><span class=\"line\">[oracle@rman_newhost rmanbackup]$ mv 1_* /u01/app/oracle/archived_log</span><br><span class=\"line\">[oracle@rman_newhost rmanbackup]$ ll /u01/app/oracle/archived_log</span><br><span class=\"line\">总用量 809056</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:48 1_22_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 39179776 9月 17 22:49 1_23_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:49 1_24_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:50 1_25_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:50 1_26_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 48581120 9月 17 22:50 1_27_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:51 1_28_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 42950144 9月 17 22:51 1_29_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:51 1_30_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 50134016 9月 17 22:53 1_31_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:53 1_32_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 46714368 9月 17 22:53 1_33_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 44308480 9月 17 22:54 1_34_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:54 1_35_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:54 1_36_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:54 1_37_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:55 1_38_854775184.dbf</span><br><span class=\"line\">-rw-r--r--. 1 oracle oinstall 46381568 9月 17 22:55 1_39_854775184.dbf</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"注册备份集\"><a href=\"#注册备份集\" class=\"headerlink\" title=\"注册备份集\"></a>注册备份集</h3><p>下面一步的操作是删掉控制文件中对备份的记录信息，因为这是源库备份恢复过来的，我们要删掉老的备份信息，将备份重新注册，不删也没关系，crosscheck以后你会发现，原来的备份状态都是expired的</p>\n<blockquote>\n<p>利用crosscheck删除控制文件中的备份记录</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">RMAN&gt; list backup summary;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">List of Backups</span><br><span class=\"line\">===============</span><br><span class=\"line\">Key     TY LV S Device Type Completion Time <span class=\"comment\">#Pieces #Copies Compressed Tag</span></span><br><span class=\"line\"><span class=\"comment\">------- -- -- - ----------- --------------- ------- ------- ---------- ---</span></span><br><span class=\"line\">9       B  0  A DISK        17-SEP-15       1       1       NO         DB_RMAN</span><br><span class=\"line\">10      B  0  A DISK        17-SEP-15       1       1       NO         DB_RMAN</span><br><span class=\"line\">11      B  F  A DISK        17-SEP-15       1       1       NO         TAG20150917T221650</span><br><span class=\"line\">12      B  A  A DISK        17-SEP-15       1       1       NO         ARC_RMAN</span><br><span class=\"line\">13      B  A  A DISK        17-SEP-15       1       1       NO         ARC_RMAN</span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt; crosscheck backup;</span><br><span class=\"line\"></span><br><span class=\"line\">Starting implicit crosscheck <span class=\"keyword\">backup</span> <span class=\"keyword\">at</span> <span class=\"number\">18</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">allocated channel: ORA_DISK_1</span><br><span class=\"line\">channel ORA_DISK_1: <span class=\"keyword\">SID</span>=<span class=\"number\">1146</span> device <span class=\"keyword\">type</span>=DISK</span><br><span class=\"line\">allocated channel: ORA_DISK_2</span><br><span class=\"line\">channel ORA_DISK_2: <span class=\"keyword\">SID</span>=<span class=\"number\">10</span> device <span class=\"keyword\">type</span>=DISK</span><br><span class=\"line\">allocated channel: ORA_DISK_3</span><br><span class=\"line\">channel ORA_DISK_3: <span class=\"keyword\">SID</span>=<span class=\"number\">1147</span> device <span class=\"keyword\">type</span>=DISK</span><br><span class=\"line\">allocated channel: ORA_DISK_4</span><br><span class=\"line\">channel ORA_DISK_4: <span class=\"keyword\">SID</span>=<span class=\"number\">11</span> device <span class=\"keyword\">type</span>=DISK</span><br><span class=\"line\">Crosschecked <span class=\"number\">5</span> objects</span><br><span class=\"line\">Finished implicit crosscheck <span class=\"keyword\">backup</span> <span class=\"keyword\">at</span> <span class=\"number\">18</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">Starting</span> implicit crosscheck copy <span class=\"keyword\">at</span> <span class=\"number\">18</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"><span class=\"keyword\">using</span> channel ORA_DISK_1</span><br><span class=\"line\"><span class=\"keyword\">using</span> channel ORA_DISK_2</span><br><span class=\"line\"><span class=\"keyword\">using</span> channel ORA_DISK_3</span><br><span class=\"line\"><span class=\"keyword\">using</span> channel ORA_DISK_4</span><br><span class=\"line\">Finished implicit crosscheck copy <span class=\"keyword\">at</span> <span class=\"number\">18</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"></span><br><span class=\"line\">searching <span class=\"keyword\">for</span> <span class=\"keyword\">all</span> files <span class=\"keyword\">in</span> the <span class=\"keyword\">recovery</span> area</span><br><span class=\"line\">cataloging files...</span><br><span class=\"line\"><span class=\"keyword\">no</span> files cataloged</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">using</span> channel ORA_DISK_1</span><br><span class=\"line\"><span class=\"keyword\">using</span> channel ORA_DISK_2</span><br><span class=\"line\"><span class=\"keyword\">using</span> channel ORA_DISK_3</span><br><span class=\"line\"><span class=\"keyword\">using</span> channel ORA_DISK_4</span><br><span class=\"line\">crosschecked <span class=\"keyword\">backup</span> piece: <span class=\"keyword\">found</span> <span class=\"keyword\">to</span> be <span class=\"string\">'EXPIRED'</span></span><br><span class=\"line\"><span class=\"keyword\">backup</span> piece handle=+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/db_0aqhdno6_1_1 RECID=<span class=\"number\">9</span> STAMP=<span class=\"number\">890691334</span></span><br><span class=\"line\">crosschecked <span class=\"keyword\">backup</span> piece: <span class=\"keyword\">found</span> <span class=\"keyword\">to</span> be <span class=\"string\">'EXPIRED'</span></span><br><span class=\"line\"><span class=\"keyword\">backup</span> piece handle=+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/db_09qhdno6_1_1 RECID=<span class=\"number\">10</span> STAMP=<span class=\"number\">890691334</span></span><br><span class=\"line\">crosschecked <span class=\"keyword\">backup</span> piece: <span class=\"keyword\">found</span> <span class=\"keyword\">to</span> be <span class=\"string\">'EXPIRED'</span></span><br><span class=\"line\"><span class=\"keyword\">backup</span> piece handle=+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/ctl_atuo_c<span class=\"number\">-2496627597</span><span class=\"number\">-20150917</span><span class=\"number\">-00</span> RECID=<span class=\"number\">11</span> STAMP=<span class=\"number\">890691411</span></span><br><span class=\"line\">crosschecked <span class=\"keyword\">backup</span> piece: <span class=\"keyword\">found</span> <span class=\"keyword\">to</span> be <span class=\"string\">'EXPIRED'</span></span><br><span class=\"line\"><span class=\"keyword\">backup</span> piece handle=+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/arc_0dqhdnqq_1_1 RECID=<span class=\"number\">12</span> STAMP=<span class=\"number\">890691418</span></span><br><span class=\"line\">crosschecked <span class=\"keyword\">backup</span> piece: <span class=\"keyword\">found</span> <span class=\"keyword\">to</span> be <span class=\"string\">'EXPIRED'</span></span><br><span class=\"line\"><span class=\"keyword\">backup</span> piece handle=+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/arc_0cqhdnqq_1_1 RECID=<span class=\"number\">13</span> STAMP=<span class=\"number\">890691418</span></span><br><span class=\"line\">Crosschecked <span class=\"number\">5</span> objects</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt; <span class=\"keyword\">list</span> <span class=\"keyword\">backup</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">List of <span class=\"keyword\">Backup</span> <span class=\"keyword\">Sets</span></span><br><span class=\"line\">===================</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">BS <span class=\"keyword\">Key</span>  <span class=\"keyword\">Type</span> LV <span class=\"keyword\">Size</span>       Device <span class=\"keyword\">Type</span> Elapsed <span class=\"built_in\">Time</span> Completion <span class=\"built_in\">Time</span></span><br><span class=\"line\"><span class=\"comment\">------- ---- -- ---------- ----------- ------------ ---------------</span></span><br><span class=\"line\"><span class=\"number\">9</span>       Incr <span class=\"number\">0</span>  <span class=\"number\">433.65</span>M    DISK        <span class=\"number\">00</span>:<span class=\"number\">01</span>:<span class=\"number\">10</span>     <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">        BP <span class=\"keyword\">Key</span>: <span class=\"number\">9</span>   <span class=\"keyword\">Status</span>: EXPIRED  Compressed: <span class=\"keyword\">NO</span>  Tag: DB_RMAN</span><br><span class=\"line\">        Piece <span class=\"keyword\">Name</span>: +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/db_0aqhdno6_1_1</span><br><span class=\"line\">  <span class=\"keyword\">List</span> <span class=\"keyword\">of</span> <span class=\"keyword\">Datafiles</span> <span class=\"keyword\">in</span> <span class=\"keyword\">backup</span> <span class=\"keyword\">set</span> <span class=\"number\">9</span></span><br><span class=\"line\">  <span class=\"keyword\">File</span> LV <span class=\"keyword\">Type</span> Ckp <span class=\"keyword\">SCN</span>    Ckp <span class=\"built_in\">Time</span>  <span class=\"keyword\">Name</span></span><br><span class=\"line\">  <span class=\"comment\">---- -- ---- ---------- --------- ----</span></span><br><span class=\"line\">  <span class=\"number\">2</span>    <span class=\"number\">0</span>  Incr <span class=\"number\">1138043</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span> +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/<span class=\"keyword\">datafile</span>/<span class=\"keyword\">sysaux</span><span class=\"number\">.257</span><span class=\"number\">.854775097</span></span><br><span class=\"line\">  <span class=\"number\">3</span>    <span class=\"number\">0</span>  Incr <span class=\"number\">1138043</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span> +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/<span class=\"keyword\">datafile</span>/undotbs1<span class=\"number\">.258</span><span class=\"number\">.854775097</span></span><br><span class=\"line\"></span><br><span class=\"line\">BS <span class=\"keyword\">Key</span>  <span class=\"keyword\">Type</span> LV <span class=\"keyword\">Size</span>       Device <span class=\"keyword\">Type</span> Elapsed <span class=\"built_in\">Time</span> Completion <span class=\"built_in\">Time</span></span><br><span class=\"line\"><span class=\"comment\">------- ---- -- ---------- ----------- ------------ ---------------</span></span><br><span class=\"line\"><span class=\"number\">10</span>      Incr <span class=\"number\">0</span>  <span class=\"number\">638.84</span>M    DISK        <span class=\"number\">00</span>:<span class=\"number\">01</span>:<span class=\"number\">10</span>     <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">        BP <span class=\"keyword\">Key</span>: <span class=\"number\">10</span>   <span class=\"keyword\">Status</span>: EXPIRED  Compressed: <span class=\"keyword\">NO</span>  Tag: DB_RMAN</span><br><span class=\"line\">        Piece <span class=\"keyword\">Name</span>: +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/db_09qhdno6_1_1</span><br><span class=\"line\">  <span class=\"keyword\">List</span> <span class=\"keyword\">of</span> <span class=\"keyword\">Datafiles</span> <span class=\"keyword\">in</span> <span class=\"keyword\">backup</span> <span class=\"keyword\">set</span> <span class=\"number\">10</span></span><br><span class=\"line\">  <span class=\"keyword\">File</span> LV <span class=\"keyword\">Type</span> Ckp <span class=\"keyword\">SCN</span>    Ckp <span class=\"built_in\">Time</span>  <span class=\"keyword\">Name</span></span><br><span class=\"line\">  <span class=\"comment\">---- -- ---- ---------- --------- ----</span></span><br><span class=\"line\">  <span class=\"number\">1</span>    <span class=\"number\">0</span>  Incr <span class=\"number\">1138042</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span> +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/<span class=\"keyword\">datafile</span>/<span class=\"keyword\">system</span><span class=\"number\">.256</span><span class=\"number\">.854775095</span></span><br><span class=\"line\">  <span class=\"number\">4</span>    <span class=\"number\">0</span>  Incr <span class=\"number\">1138042</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span> +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/<span class=\"keyword\">datafile</span>/<span class=\"keyword\">users</span><span class=\"number\">.259</span><span class=\"number\">.854775097</span></span><br><span class=\"line\"></span><br><span class=\"line\">BS <span class=\"keyword\">Key</span>  <span class=\"keyword\">Type</span> LV <span class=\"keyword\">Size</span>       Device <span class=\"keyword\">Type</span> Elapsed <span class=\"built_in\">Time</span> Completion <span class=\"built_in\">Time</span></span><br><span class=\"line\"><span class=\"comment\">------- ---- -- ---------- ----------- ------------ ---------------</span></span><br><span class=\"line\"><span class=\"number\">11</span>      <span class=\"keyword\">Full</span>    <span class=\"number\">9.36</span>M      DISK        <span class=\"number\">00</span>:<span class=\"number\">00</span>:<span class=\"number\">01</span>     <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">        BP <span class=\"keyword\">Key</span>: <span class=\"number\">11</span>   <span class=\"keyword\">Status</span>: EXPIRED  Compressed: <span class=\"keyword\">NO</span>  Tag: TAG20150917T221650</span><br><span class=\"line\">        Piece <span class=\"keyword\">Name</span>: +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/ctl_atuo_c<span class=\"number\">-2496627597</span><span class=\"number\">-20150917</span><span class=\"number\">-00</span></span><br><span class=\"line\">  <span class=\"keyword\">SPFILE</span> Included: <span class=\"keyword\">Modification</span> <span class=\"built_in\">time</span>: <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">  <span class=\"keyword\">SPFILE</span> db_unique_name: <span class=\"keyword\">MIN</span></span><br><span class=\"line\">  Control <span class=\"keyword\">File</span> Included: Ckp <span class=\"keyword\">SCN</span>: <span class=\"number\">1138347</span>      Ckp <span class=\"built_in\">time</span>: <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"></span><br><span class=\"line\">BS <span class=\"keyword\">Key</span>  <span class=\"keyword\">Size</span>       Device <span class=\"keyword\">Type</span> Elapsed <span class=\"built_in\">Time</span> Completion <span class=\"built_in\">Time</span></span><br><span class=\"line\"><span class=\"comment\">------- ---------- ----------- ------------ ---------------</span></span><br><span class=\"line\"><span class=\"number\">12</span>      <span class=\"number\">2.00</span>K      DISK        <span class=\"number\">00</span>:<span class=\"number\">00</span>:<span class=\"number\">00</span>     <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">        BP <span class=\"keyword\">Key</span>: <span class=\"number\">12</span>   <span class=\"keyword\">Status</span>: EXPIRED  Compressed: <span class=\"keyword\">NO</span>  Tag: ARC_RMAN</span><br><span class=\"line\">        Piece <span class=\"keyword\">Name</span>: +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/arc_0dqhdnqq_1_1</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">List</span> <span class=\"keyword\">of</span> <span class=\"keyword\">Archived</span> <span class=\"keyword\">Logs</span> <span class=\"keyword\">in</span> <span class=\"keyword\">backup</span> <span class=\"keyword\">set</span> <span class=\"number\">12</span></span><br><span class=\"line\">  Thrd Seq     <span class=\"keyword\">Low</span> <span class=\"keyword\">SCN</span>    <span class=\"keyword\">Low</span> <span class=\"built_in\">Time</span>  <span class=\"keyword\">Next</span> <span class=\"keyword\">SCN</span>   <span class=\"keyword\">Next</span> <span class=\"built_in\">Time</span></span><br><span class=\"line\">  <span class=\"comment\">---- ------- ---------- --------- ---------- ---------</span></span><br><span class=\"line\">  <span class=\"number\">1</span>    <span class=\"number\">21</span>      <span class=\"number\">1138364</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span> <span class=\"number\">1138372</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"></span><br><span class=\"line\">BS <span class=\"keyword\">Key</span>  <span class=\"keyword\">Size</span>       Device <span class=\"keyword\">Type</span> Elapsed <span class=\"built_in\">Time</span> Completion <span class=\"built_in\">Time</span></span><br><span class=\"line\"><span class=\"comment\">------- ---------- ----------- ------------ ---------------</span></span><br><span class=\"line\"><span class=\"number\">13</span>      <span class=\"number\">30.99</span>M     DISK        <span class=\"number\">00</span>:<span class=\"number\">00</span>:<span class=\"number\">02</span>     <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">        BP <span class=\"keyword\">Key</span>: <span class=\"number\">13</span>   <span class=\"keyword\">Status</span>: EXPIRED  Compressed: <span class=\"keyword\">NO</span>  Tag: ARC_RMAN</span><br><span class=\"line\">        Piece <span class=\"keyword\">Name</span>: +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/arc_0cqhdnqq_1_1</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">List</span> <span class=\"keyword\">of</span> <span class=\"keyword\">Archived</span> <span class=\"keyword\">Logs</span> <span class=\"keyword\">in</span> <span class=\"keyword\">backup</span> <span class=\"keyword\">set</span> <span class=\"number\">13</span></span><br><span class=\"line\">  Thrd Seq     <span class=\"keyword\">Low</span> <span class=\"keyword\">SCN</span>    <span class=\"keyword\">Low</span> <span class=\"built_in\">Time</span>  <span class=\"keyword\">Next</span> <span class=\"keyword\">SCN</span>   <span class=\"keyword\">Next</span> <span class=\"built_in\">Time</span></span><br><span class=\"line\">  <span class=\"comment\">---- ------- ---------- --------- ---------- ---------</span></span><br><span class=\"line\">  <span class=\"number\">1</span>    <span class=\"number\">20</span>      <span class=\"number\">1127220</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span> <span class=\"number\">1138364</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt; <span class=\"keyword\">list</span> <span class=\"keyword\">archivelog</span> <span class=\"keyword\">all</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">specification does not match any archived log in the repository</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt; report obsolete;</span><br><span class=\"line\"></span><br><span class=\"line\">RMAN retention policy will be applied to the command</span><br><span class=\"line\">RMAN retention policy is <span class=\"keyword\">set</span> <span class=\"keyword\">to</span> <span class=\"keyword\">recovery</span> <span class=\"keyword\">window</span> <span class=\"keyword\">of</span> <span class=\"number\">7</span> <span class=\"keyword\">days</span></span><br><span class=\"line\"><span class=\"keyword\">no</span> obsolete backups <span class=\"keyword\">found</span></span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt; <span class=\"keyword\">list</span> expired <span class=\"keyword\">backup</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">List of <span class=\"keyword\">Backup</span> <span class=\"keyword\">Sets</span></span><br><span class=\"line\">===================</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">BS <span class=\"keyword\">Key</span>  <span class=\"keyword\">Type</span> LV <span class=\"keyword\">Size</span>       Device <span class=\"keyword\">Type</span> Elapsed <span class=\"built_in\">Time</span> Completion <span class=\"built_in\">Time</span></span><br><span class=\"line\"><span class=\"comment\">------- ---- -- ---------- ----------- ------------ ---------------</span></span><br><span class=\"line\"><span class=\"number\">9</span>       Incr <span class=\"number\">0</span>  <span class=\"number\">433.65</span>M    DISK        <span class=\"number\">00</span>:<span class=\"number\">01</span>:<span class=\"number\">10</span>     <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">        BP <span class=\"keyword\">Key</span>: <span class=\"number\">9</span>   <span class=\"keyword\">Status</span>: EXPIRED  Compressed: <span class=\"keyword\">NO</span>  Tag: DB_RMAN</span><br><span class=\"line\">        Piece <span class=\"keyword\">Name</span>: +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/db_0aqhdno6_1_1</span><br><span class=\"line\">  <span class=\"keyword\">List</span> <span class=\"keyword\">of</span> <span class=\"keyword\">Datafiles</span> <span class=\"keyword\">in</span> <span class=\"keyword\">backup</span> <span class=\"keyword\">set</span> <span class=\"number\">9</span></span><br><span class=\"line\">  <span class=\"keyword\">File</span> LV <span class=\"keyword\">Type</span> Ckp <span class=\"keyword\">SCN</span>    Ckp <span class=\"built_in\">Time</span>  <span class=\"keyword\">Name</span></span><br><span class=\"line\">  <span class=\"comment\">---- -- ---- ---------- --------- ----</span></span><br><span class=\"line\">  <span class=\"number\">2</span>    <span class=\"number\">0</span>  Incr <span class=\"number\">1138043</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span> +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/<span class=\"keyword\">datafile</span>/<span class=\"keyword\">sysaux</span><span class=\"number\">.257</span><span class=\"number\">.854775097</span></span><br><span class=\"line\">  <span class=\"number\">3</span>    <span class=\"number\">0</span>  Incr <span class=\"number\">1138043</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span> +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/<span class=\"keyword\">datafile</span>/undotbs1<span class=\"number\">.258</span><span class=\"number\">.854775097</span></span><br><span class=\"line\"></span><br><span class=\"line\">BS <span class=\"keyword\">Key</span>  <span class=\"keyword\">Type</span> LV <span class=\"keyword\">Size</span>       Device <span class=\"keyword\">Type</span> Elapsed <span class=\"built_in\">Time</span> Completion <span class=\"built_in\">Time</span></span><br><span class=\"line\"><span class=\"comment\">------- ---- -- ---------- ----------- ------------ ---------------</span></span><br><span class=\"line\"><span class=\"number\">10</span>      Incr <span class=\"number\">0</span>  <span class=\"number\">638.84</span>M    DISK        <span class=\"number\">00</span>:<span class=\"number\">01</span>:<span class=\"number\">10</span>     <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">        BP <span class=\"keyword\">Key</span>: <span class=\"number\">10</span>   <span class=\"keyword\">Status</span>: EXPIRED  Compressed: <span class=\"keyword\">NO</span>  Tag: DB_RMAN</span><br><span class=\"line\">        Piece <span class=\"keyword\">Name</span>: +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/db_09qhdno6_1_1</span><br><span class=\"line\">  <span class=\"keyword\">List</span> <span class=\"keyword\">of</span> <span class=\"keyword\">Datafiles</span> <span class=\"keyword\">in</span> <span class=\"keyword\">backup</span> <span class=\"keyword\">set</span> <span class=\"number\">10</span></span><br><span class=\"line\">  <span class=\"keyword\">File</span> LV <span class=\"keyword\">Type</span> Ckp <span class=\"keyword\">SCN</span>    Ckp <span class=\"built_in\">Time</span>  <span class=\"keyword\">Name</span></span><br><span class=\"line\">  <span class=\"comment\">---- -- ---- ---------- --------- ----</span></span><br><span class=\"line\">  <span class=\"number\">1</span>    <span class=\"number\">0</span>  Incr <span class=\"number\">1138042</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span> +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/<span class=\"keyword\">datafile</span>/<span class=\"keyword\">system</span><span class=\"number\">.256</span><span class=\"number\">.854775095</span></span><br><span class=\"line\">  <span class=\"number\">4</span>    <span class=\"number\">0</span>  Incr <span class=\"number\">1138042</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span> +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/<span class=\"keyword\">datafile</span>/<span class=\"keyword\">users</span><span class=\"number\">.259</span><span class=\"number\">.854775097</span></span><br><span class=\"line\"></span><br><span class=\"line\">BS <span class=\"keyword\">Key</span>  <span class=\"keyword\">Type</span> LV <span class=\"keyword\">Size</span>       Device <span class=\"keyword\">Type</span> Elapsed <span class=\"built_in\">Time</span> Completion <span class=\"built_in\">Time</span></span><br><span class=\"line\"><span class=\"comment\">------- ---- -- ---------- ----------- ------------ ---------------</span></span><br><span class=\"line\"><span class=\"number\">11</span>      <span class=\"keyword\">Full</span>    <span class=\"number\">9.36</span>M      DISK        <span class=\"number\">00</span>:<span class=\"number\">00</span>:<span class=\"number\">01</span>     <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">        BP <span class=\"keyword\">Key</span>: <span class=\"number\">11</span>   <span class=\"keyword\">Status</span>: EXPIRED  Compressed: <span class=\"keyword\">NO</span>  Tag: TAG20150917T221650</span><br><span class=\"line\">        Piece <span class=\"keyword\">Name</span>: +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/ctl_atuo_c<span class=\"number\">-2496627597</span><span class=\"number\">-20150917</span><span class=\"number\">-00</span></span><br><span class=\"line\">  <span class=\"keyword\">SPFILE</span> Included: <span class=\"keyword\">Modification</span> <span class=\"built_in\">time</span>: <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">  <span class=\"keyword\">SPFILE</span> db_unique_name: <span class=\"keyword\">MIN</span></span><br><span class=\"line\">  Control <span class=\"keyword\">File</span> Included: Ckp <span class=\"keyword\">SCN</span>: <span class=\"number\">1138347</span>      Ckp <span class=\"built_in\">time</span>: <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"></span><br><span class=\"line\">BS <span class=\"keyword\">Key</span>  <span class=\"keyword\">Size</span>       Device <span class=\"keyword\">Type</span> Elapsed <span class=\"built_in\">Time</span> Completion <span class=\"built_in\">Time</span></span><br><span class=\"line\"><span class=\"comment\">------- ---------- ----------- ------------ ---------------</span></span><br><span class=\"line\"><span class=\"number\">12</span>      <span class=\"number\">2.00</span>K      DISK        <span class=\"number\">00</span>:<span class=\"number\">00</span>:<span class=\"number\">00</span>     <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">        BP <span class=\"keyword\">Key</span>: <span class=\"number\">12</span>   <span class=\"keyword\">Status</span>: EXPIRED  Compressed: <span class=\"keyword\">NO</span>  Tag: ARC_RMAN</span><br><span class=\"line\">        Piece <span class=\"keyword\">Name</span>: +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/arc_0dqhdnqq_1_1</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">List</span> <span class=\"keyword\">of</span> <span class=\"keyword\">Archived</span> <span class=\"keyword\">Logs</span> <span class=\"keyword\">in</span> <span class=\"keyword\">backup</span> <span class=\"keyword\">set</span> <span class=\"number\">12</span></span><br><span class=\"line\">  Thrd Seq     <span class=\"keyword\">Low</span> <span class=\"keyword\">SCN</span>    <span class=\"keyword\">Low</span> <span class=\"built_in\">Time</span>  <span class=\"keyword\">Next</span> <span class=\"keyword\">SCN</span>   <span class=\"keyword\">Next</span> <span class=\"built_in\">Time</span></span><br><span class=\"line\">  <span class=\"comment\">---- ------- ---------- --------- ---------- ---------</span></span><br><span class=\"line\">  <span class=\"number\">1</span>    <span class=\"number\">21</span>      <span class=\"number\">1138364</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span> <span class=\"number\">1138372</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"></span><br><span class=\"line\">BS <span class=\"keyword\">Key</span>  <span class=\"keyword\">Size</span>       Device <span class=\"keyword\">Type</span> Elapsed <span class=\"built_in\">Time</span> Completion <span class=\"built_in\">Time</span></span><br><span class=\"line\"><span class=\"comment\">------- ---------- ----------- ------------ ---------------</span></span><br><span class=\"line\"><span class=\"number\">13</span>      <span class=\"number\">30.99</span>M     DISK        <span class=\"number\">00</span>:<span class=\"number\">00</span>:<span class=\"number\">02</span>     <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\">        BP <span class=\"keyword\">Key</span>: <span class=\"number\">13</span>   <span class=\"keyword\">Status</span>: EXPIRED  Compressed: <span class=\"keyword\">NO</span>  Tag: ARC_RMAN</span><br><span class=\"line\">        Piece <span class=\"keyword\">Name</span>: +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/arc_0cqhdnqq_1_1</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">List</span> <span class=\"keyword\">of</span> <span class=\"keyword\">Archived</span> <span class=\"keyword\">Logs</span> <span class=\"keyword\">in</span> <span class=\"keyword\">backup</span> <span class=\"keyword\">set</span> <span class=\"number\">13</span></span><br><span class=\"line\">  Thrd Seq     <span class=\"keyword\">Low</span> <span class=\"keyword\">SCN</span>    <span class=\"keyword\">Low</span> <span class=\"built_in\">Time</span>  <span class=\"keyword\">Next</span> <span class=\"keyword\">SCN</span>   <span class=\"keyword\">Next</span> <span class=\"built_in\">Time</span></span><br><span class=\"line\">  <span class=\"comment\">---- ------- ---------- --------- ---------- ---------</span></span><br><span class=\"line\">  <span class=\"number\">1</span>    <span class=\"number\">20</span>      <span class=\"number\">1127220</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span> <span class=\"number\">1138364</span>    <span class=\"number\">17</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt; <span class=\"keyword\">delete</span> <span class=\"keyword\">noprompt</span> expired <span class=\"keyword\">backup</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">using channel ORA_DISK_1</span><br><span class=\"line\">using channel ORA_DISK_2</span><br><span class=\"line\">using channel ORA_DISK_3</span><br><span class=\"line\">using channel ORA_DISK_4</span><br><span class=\"line\"></span><br><span class=\"line\">List of <span class=\"keyword\">Backup</span> Pieces</span><br><span class=\"line\">BP <span class=\"keyword\">Key</span>  BS <span class=\"keyword\">Key</span>  Pc<span class=\"comment\"># Cp# Status      Device Type Piece Name</span></span><br><span class=\"line\"><span class=\"comment\">------- ------- --- --- ----------- ----------- ----------</span></span><br><span class=\"line\"><span class=\"number\">9</span>       <span class=\"number\">9</span>       <span class=\"number\">1</span>   <span class=\"number\">1</span>   EXPIRED     DISK        +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/db_0aqhdno6_1_1</span><br><span class=\"line\"><span class=\"number\">10</span>      <span class=\"number\">10</span>      <span class=\"number\">1</span>   <span class=\"number\">1</span>   EXPIRED     DISK        +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/db_09qhdno6_1_1</span><br><span class=\"line\"><span class=\"number\">11</span>      <span class=\"number\">11</span>      <span class=\"number\">1</span>   <span class=\"number\">1</span>   EXPIRED     DISK        +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/ctl_atuo_c<span class=\"number\">-2496627597</span><span class=\"number\">-20150917</span><span class=\"number\">-00</span></span><br><span class=\"line\"><span class=\"number\">12</span>      <span class=\"number\">12</span>      <span class=\"number\">1</span>   <span class=\"number\">1</span>   EXPIRED     DISK        +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/arc_0dqhdnqq_1_1</span><br><span class=\"line\"><span class=\"number\">13</span>      <span class=\"number\">13</span>      <span class=\"number\">1</span>   <span class=\"number\">1</span>   EXPIRED     DISK        +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/arc_0cqhdnqq_1_1</span><br><span class=\"line\">deleted <span class=\"keyword\">backup</span> piece</span><br><span class=\"line\"><span class=\"keyword\">backup</span> piece handle=+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/db_0aqhdno6_1_1 RECID=<span class=\"number\">9</span> STAMP=<span class=\"number\">890691334</span></span><br><span class=\"line\">deleted <span class=\"keyword\">backup</span> piece</span><br><span class=\"line\"><span class=\"keyword\">backup</span> piece handle=+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/db_09qhdno6_1_1 RECID=<span class=\"number\">10</span> STAMP=<span class=\"number\">890691334</span></span><br><span class=\"line\">deleted <span class=\"keyword\">backup</span> piece</span><br><span class=\"line\"><span class=\"keyword\">backup</span> piece handle=+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/ctl_atuo_c<span class=\"number\">-2496627597</span><span class=\"number\">-20150917</span><span class=\"number\">-00</span> RECID=<span class=\"number\">11</span> STAMP=<span class=\"number\">890691411</span></span><br><span class=\"line\">deleted <span class=\"keyword\">backup</span> piece</span><br><span class=\"line\"><span class=\"keyword\">backup</span> piece handle=+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/arc_0dqhdnqq_1_1 RECID=<span class=\"number\">12</span> STAMP=<span class=\"number\">890691418</span></span><br><span class=\"line\">deleted <span class=\"keyword\">backup</span> piece</span><br><span class=\"line\"><span class=\"keyword\">backup</span> piece handle=+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">backup</span>/arc_0cqhdnqq_1_1 RECID=<span class=\"number\">13</span> STAMP=<span class=\"number\">890691418</span></span><br><span class=\"line\">Deleted <span class=\"number\">5</span> EXPIRED objects</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt; <span class=\"keyword\">list</span> <span class=\"keyword\">backup</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">specification does not match any <span class=\"keyword\">backup</span> <span class=\"keyword\">in</span> the repository</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>重新注册备份，并观察控制文件中的备份信息，和数据库结构的信息</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">RMAN&gt; catalog start with '/u01/rmanbackup';</span><br><span class=\"line\"></span><br><span class=\"line\">searching for all files that match the pattern /u01/rmanbackup</span><br><span class=\"line\"></span><br><span class=\"line\">List of Files Unknown to the Database</span><br><span class=\"line\">=====================================</span><br><span class=\"line\">File Name: /u01/rmanbackup/arc1.rman</span><br><span class=\"line\">File Name: /u01/rmanbackup/db1.rman</span><br><span class=\"line\">File Name: /u01/rmanbackup/ctl2.rman</span><br><span class=\"line\">File Name: /u01/rmanbackup/ctl1.rman</span><br><span class=\"line\">File Name: /u01/rmanbackup/db2.rman</span><br><span class=\"line\">File Name: /u01/rmanbackup/arc2.rman</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">Do</span> you really want <span class=\"keyword\">to</span> <span class=\"keyword\">catalog</span> the above files (enter YES <span class=\"keyword\">or</span> <span class=\"keyword\">NO</span>)? yes</span><br><span class=\"line\">cataloging files...</span><br><span class=\"line\">cataloging done</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">List</span> <span class=\"keyword\">of</span> Cataloged Files</span><br><span class=\"line\">=======================</span><br><span class=\"line\"><span class=\"keyword\">File</span> <span class=\"keyword\">Name</span>: /u01/rmanbackup/arc1.rman</span><br><span class=\"line\"><span class=\"keyword\">File</span> <span class=\"keyword\">Name</span>: /u01/rmanbackup/db1.rman</span><br><span class=\"line\"><span class=\"keyword\">File</span> <span class=\"keyword\">Name</span>: /u01/rmanbackup/ctl2.rman</span><br><span class=\"line\"><span class=\"keyword\">File</span> <span class=\"keyword\">Name</span>: /u01/rmanbackup/ctl1.rman</span><br><span class=\"line\"><span class=\"keyword\">File</span> <span class=\"keyword\">Name</span>: /u01/rmanbackup/db2.rman</span><br><span class=\"line\"><span class=\"keyword\">File</span> <span class=\"keyword\">Name</span>: /u01/rmanbackup/arc2.rman</span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt; <span class=\"keyword\">list</span> <span class=\"keyword\">backup</span> summary;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">List of Backups</span><br><span class=\"line\">===============</span><br><span class=\"line\">Key     TY LV S Device Type Completion Time <span class=\"comment\">#Pieces #Copies Compressed Tag</span></span><br><span class=\"line\"><span class=\"comment\">------- -- -- - ----------- --------------- ------- ------- ---------- ---</span></span><br><span class=\"line\">14      B  A  A DISK        17-SEP-15       1       1       NO         ARC_RMAN</span><br><span class=\"line\">15      B  0  A DISK        17-SEP-15       1       1       NO         DB_RMAN</span><br><span class=\"line\">16      B  0  A DISK        17-SEP-15       1       1       NO         DB_RMAN</span><br><span class=\"line\">17      B  A  A DISK        17-SEP-15       1       1       NO         ARC_RMAN</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">--数据文件、临时文件的记录还是源库的信息，一会儿恢复的时候要setnewname</span></span><br><span class=\"line\">RMAN&gt; report schema;</span><br><span class=\"line\"></span><br><span class=\"line\">RMAN-06139: WARNING: control file is not current for REPORT SCHEMA</span><br><span class=\"line\">Report of database schema for database <span class=\"keyword\">with</span> db_unique_name <span class=\"keyword\">MIN</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">List</span> <span class=\"keyword\">of</span> <span class=\"keyword\">Permanent</span> <span class=\"keyword\">Datafiles</span></span><br><span class=\"line\">===========================</span><br><span class=\"line\"><span class=\"keyword\">File</span> <span class=\"keyword\">Size</span>(MB) <span class=\"keyword\">Tablespace</span>           RB segs <span class=\"keyword\">Datafile</span> <span class=\"keyword\">Name</span></span><br><span class=\"line\"><span class=\"comment\">---- -------- -------------------- ------- ------------------------</span></span><br><span class=\"line\"><span class=\"number\">1</span>    <span class=\"number\">0</span>        <span class=\"keyword\">SYSTEM</span>               ***     +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/<span class=\"keyword\">datafile</span>/<span class=\"keyword\">system</span><span class=\"number\">.256</span><span class=\"number\">.854775095</span></span><br><span class=\"line\"><span class=\"number\">2</span>    <span class=\"number\">0</span>        <span class=\"keyword\">SYSAUX</span>               ***     +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/<span class=\"keyword\">datafile</span>/<span class=\"keyword\">sysaux</span><span class=\"number\">.257</span><span class=\"number\">.854775097</span></span><br><span class=\"line\"><span class=\"number\">3</span>    <span class=\"number\">0</span>        UNDOTBS1             ***     +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/<span class=\"keyword\">datafile</span>/undotbs1<span class=\"number\">.258</span><span class=\"number\">.854775097</span></span><br><span class=\"line\"><span class=\"number\">4</span>    <span class=\"number\">0</span>        <span class=\"keyword\">USERS</span>                ***     +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/<span class=\"keyword\">datafile</span>/<span class=\"keyword\">users</span><span class=\"number\">.259</span><span class=\"number\">.854775097</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">List</span> <span class=\"keyword\">of</span> <span class=\"keyword\">Temporary</span> Files</span><br><span class=\"line\">=======================</span><br><span class=\"line\"><span class=\"keyword\">File</span> <span class=\"keyword\">Size</span>(MB) <span class=\"keyword\">Tablespace</span>           <span class=\"keyword\">Maxsize</span>(MB) Tempfile <span class=\"keyword\">Name</span></span><br><span class=\"line\"><span class=\"comment\">---- -------- -------------------- ----------- --------------------</span></span><br><span class=\"line\"><span class=\"number\">1</span>    <span class=\"number\">20</span>       TEMP                 <span class=\"number\">32767</span>       +<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/tempfile/temp<span class=\"number\">.268</span><span class=\"number\">.854775211</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">--你会发现这是老的控制文件，是我们0级备份里的，其中关于redo的状态记录，当前redo还停留在序列号22</span></span><br><span class=\"line\"><span class=\"keyword\">SQL</span>&gt; <span class=\"keyword\">select</span> <span class=\"keyword\">GROUP</span><span class=\"comment\">#,SEQUENCE# ,STATUS,ARCHIVED  from v$log;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">GROUP</span><span class=\"comment\">#  SEQUENCE# STATUS           ARC</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- ---------------- ---</span></span><br><span class=\"line\">         <span class=\"number\">1</span>         <span class=\"number\">22</span> <span class=\"keyword\">CURRENT</span>          <span class=\"keyword\">NO</span></span><br><span class=\"line\">         <span class=\"number\">3</span>         <span class=\"number\">21</span> ACTIVE           YES</span><br><span class=\"line\">         <span class=\"number\">2</span>         <span class=\"number\">20</span> ACTIVE           YES</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">SQL</span>&gt; <span class=\"keyword\">desc</span> v$<span class=\"keyword\">logfile</span>;</span><br><span class=\"line\"> Name                                      Null?    Type</span><br><span class=\"line\"> <span class=\"comment\">----------------------------------------- -------- ----------------------------</span></span><br><span class=\"line\"> GROUP<span class=\"comment\">#                                             NUMBER</span></span><br><span class=\"line\"> STATUS                                             VARCHAR2(7)</span><br><span class=\"line\"> TYPE                                               VARCHAR2(7)</span><br><span class=\"line\"> MEMBER                                             VARCHAR2(513)</span><br><span class=\"line\"> IS_RECOVERY_DEST_FILE                              VARCHAR2(3)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">--redo的记录还是源库的信息，一会儿恢复的时候要setnewname</span></span><br><span class=\"line\">SQL&gt; col member for a80</span><br><span class=\"line\">SQL&gt; set line 200</span><br><span class=\"line\">SQL&gt; select GROUP#,STATUS,MEMBER from v$logfile;</span><br><span class=\"line\"></span><br><span class=\"line\">    GROUP<span class=\"comment\"># STATUS  MEMBER</span></span><br><span class=\"line\"><span class=\"comment\">---------- ------- --------------------------------------------------------------------------------</span></span><br><span class=\"line\">         3         +DATA/min/onlinelog/group_3.266.854775193</span><br><span class=\"line\">         3         +DATA/min/onlinelog/group_3.267.854775195</span><br><span class=\"line\">         2         +DATA/min/onlinelog/group_2.264.854775189</span><br><span class=\"line\">         2         +DATA/min/onlinelog/group_2.265.854775191</span><br><span class=\"line\">         1         +DATA/min/onlinelog/group_1.262.854775185</span><br><span class=\"line\">         1         +DATA/min/onlinelog/group_1.263.854775187</span><br><span class=\"line\"></span><br><span class=\"line\">6 rows selected.</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"还原数据库\"><a href=\"#还原数据库\" class=\"headerlink\" title=\"还原数据库\"></a>还原数据库</h3><figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">RMAN&gt; RUN</span><br><span class=\"line\">2&gt;  &#123;</span><br><span class=\"line\">3&gt;    ALLOCATE CHANNEL c1 DEVICE TYPE DISK;</span><br><span class=\"line\">4&gt;    ALLOCATE CHANNEL c2 DEVICE TYPE DISK;</span><br><span class=\"line\">5&gt;    set archivelog destination to \"/u01/app/oracle/archived_log\";</span><br><span class=\"line\">6&gt;       set newname for datafile 1 to \"/u01/app/oracle/oradata/min/system01.dbf\";</span><br><span class=\"line\">7&gt;       set newname for datafile 2 to \"/u01/app/oracle/oradata/min/sysaux01.dbf\";</span><br><span class=\"line\">8&gt;       set newname for datafile 3 to \"/u01/app/oracle/oradata/min/undotbs01.dbf\";</span><br><span class=\"line\">9&gt;       set newname for datafile 4 to \"/u01/app/oracle/oradata/min/users01.dbf\";</span><br><span class=\"line\">10&gt;      set newname for tempfile 1 to \"/u01/app/oracle/oradata/min/temp01.dbf\";</span><br><span class=\"line\">11&gt;      SQL \"ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_1.262.854775185''  to  ''/u01/app/oracle/oradata/min/redo1a.log'' \";</span><br><span class=\"line\">12&gt;      SQL \"ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_1.263.854775187''  to  ''/u01/app/oracle/oradata/min/redo1b.log'' \";</span><br><span class=\"line\">13&gt;      SQL \"ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_2.264.854775189''  to  ''/u01/app/oracle/oradata/min/redo2a.log'' \";</span><br><span class=\"line\">14&gt;      SQL \"ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_2.265.854775191''  to  ''/u01/app/oracle/oradata/min/redo2b.log'' \";</span><br><span class=\"line\">15&gt;      SQL \"ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_3.266.854775193''  to  ''/u01/app/oracle/oradata/min/redo3a.log'' \";</span><br><span class=\"line\">16&gt;      SQL \"ALTER DATABASE RENAME FILE ''+DATA/min/onlinelog/group_3.267.854775195''  to  ''/u01/app/oracle/oradata/min/redo3b.log'' \";</span><br><span class=\"line\">17&gt;    RESTORE DATABASE;</span><br><span class=\"line\">18&gt;    SWITCH DATAFILE ALL;</span><br><span class=\"line\">19&gt;    switch tempfile all;</span><br><span class=\"line\">20&gt;  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">released channel: ORA_DISK_1</span><br><span class=\"line\">released channel: ORA_DISK_2</span><br><span class=\"line\">released channel: ORA_DISK_3</span><br><span class=\"line\">released channel: ORA_DISK_4</span><br><span class=\"line\">allocated channel: c1</span><br><span class=\"line\">channel c1: SID=1146 device type=DISK</span><br><span class=\"line\"></span><br><span class=\"line\">allocated channel: c2</span><br><span class=\"line\">channel c2: SID=11 device type=DISK</span><br><span class=\"line\"></span><br><span class=\"line\">executing command: <span class=\"keyword\">SET</span> <span class=\"keyword\">ARCHIVELOG</span> DESTINATION</span><br><span class=\"line\"></span><br><span class=\"line\">executing command: <span class=\"keyword\">SET</span> NEWNAME</span><br><span class=\"line\"></span><br><span class=\"line\">executing command: <span class=\"keyword\">SET</span> NEWNAME</span><br><span class=\"line\"></span><br><span class=\"line\">executing command: <span class=\"keyword\">SET</span> NEWNAME</span><br><span class=\"line\"></span><br><span class=\"line\">executing command: <span class=\"keyword\">SET</span> NEWNAME</span><br><span class=\"line\"></span><br><span class=\"line\">executing command: <span class=\"keyword\">SET</span> NEWNAME</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">sql</span> <span class=\"keyword\">statement</span>: <span class=\"keyword\">ALTER</span> <span class=\"keyword\">DATABASE</span> <span class=\"keyword\">RENAME</span> <span class=\"keyword\">FILE</span> <span class=\"string\">''</span>+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/onlinelog/group_1<span class=\"number\">.262</span><span class=\"number\">.854775185</span><span class=\"string\">''</span>  <span class=\"keyword\">to</span>  <span class=\"string\">''</span>/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/redo1a.log<span class=\"string\">''</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">sql</span> <span class=\"keyword\">statement</span>: <span class=\"keyword\">ALTER</span> <span class=\"keyword\">DATABASE</span> <span class=\"keyword\">RENAME</span> <span class=\"keyword\">FILE</span> <span class=\"string\">''</span>+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/onlinelog/group_1<span class=\"number\">.263</span><span class=\"number\">.854775187</span><span class=\"string\">''</span>  <span class=\"keyword\">to</span>  <span class=\"string\">''</span>/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/redo1b.log<span class=\"string\">''</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">sql</span> <span class=\"keyword\">statement</span>: <span class=\"keyword\">ALTER</span> <span class=\"keyword\">DATABASE</span> <span class=\"keyword\">RENAME</span> <span class=\"keyword\">FILE</span> <span class=\"string\">''</span>+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/onlinelog/group_2<span class=\"number\">.264</span><span class=\"number\">.854775189</span><span class=\"string\">''</span>  <span class=\"keyword\">to</span>  <span class=\"string\">''</span>/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/redo2a.log<span class=\"string\">''</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">sql</span> <span class=\"keyword\">statement</span>: <span class=\"keyword\">ALTER</span> <span class=\"keyword\">DATABASE</span> <span class=\"keyword\">RENAME</span> <span class=\"keyword\">FILE</span> <span class=\"string\">''</span>+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/onlinelog/group_2<span class=\"number\">.265</span><span class=\"number\">.854775191</span><span class=\"string\">''</span>  <span class=\"keyword\">to</span>  <span class=\"string\">''</span>/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/redo2b.log<span class=\"string\">''</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">sql</span> <span class=\"keyword\">statement</span>: <span class=\"keyword\">ALTER</span> <span class=\"keyword\">DATABASE</span> <span class=\"keyword\">RENAME</span> <span class=\"keyword\">FILE</span> <span class=\"string\">''</span>+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/onlinelog/group_3<span class=\"number\">.266</span><span class=\"number\">.854775193</span><span class=\"string\">''</span>  <span class=\"keyword\">to</span>  <span class=\"string\">''</span>/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/redo3a.log<span class=\"string\">''</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">sql</span> <span class=\"keyword\">statement</span>: <span class=\"keyword\">ALTER</span> <span class=\"keyword\">DATABASE</span> <span class=\"keyword\">RENAME</span> <span class=\"keyword\">FILE</span> <span class=\"string\">''</span>+<span class=\"keyword\">DATA</span>/<span class=\"keyword\">min</span>/onlinelog/group_3<span class=\"number\">.267</span><span class=\"number\">.854775195</span><span class=\"string\">''</span>  <span class=\"keyword\">to</span>  <span class=\"string\">''</span>/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/redo3b.log<span class=\"string\">''</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">Starting</span> <span class=\"keyword\">restore</span> <span class=\"keyword\">at</span> <span class=\"number\">18</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"></span><br><span class=\"line\">skipping <span class=\"keyword\">datafile</span> <span class=\"number\">2</span>; already restored to file /u01/app/oracle/oradata/min/sysaux01.dbf</span><br><span class=\"line\">channel c1: starting datafile <span class=\"keyword\">backup</span> <span class=\"keyword\">set</span> <span class=\"keyword\">restore</span></span><br><span class=\"line\">channel c1: specifying <span class=\"keyword\">datafile</span>(s) <span class=\"keyword\">to</span> <span class=\"keyword\">restore</span> <span class=\"keyword\">from</span> <span class=\"keyword\">backup</span> <span class=\"keyword\">set</span></span><br><span class=\"line\">channel c1: restoring <span class=\"keyword\">datafile</span> <span class=\"number\">00001</span> <span class=\"keyword\">to</span> /u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/system01.dbf</span><br><span class=\"line\">channel c1: restoring <span class=\"keyword\">datafile</span> <span class=\"number\">00004</span> <span class=\"keyword\">to</span> /u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/users01.dbf</span><br><span class=\"line\">channel c1: reading <span class=\"keyword\">from</span> <span class=\"keyword\">backup</span> piece /u01/rmanbackup/db2.rman</span><br><span class=\"line\">channel c2: <span class=\"keyword\">starting</span> <span class=\"keyword\">datafile</span> <span class=\"keyword\">backup</span> <span class=\"keyword\">set</span> <span class=\"keyword\">restore</span></span><br><span class=\"line\">channel c2: specifying <span class=\"keyword\">datafile</span>(s) <span class=\"keyword\">to</span> <span class=\"keyword\">restore</span> <span class=\"keyword\">from</span> <span class=\"keyword\">backup</span> <span class=\"keyword\">set</span></span><br><span class=\"line\">channel c2: restoring <span class=\"keyword\">datafile</span> <span class=\"number\">00003</span> <span class=\"keyword\">to</span> /u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/undotbs01.dbf</span><br><span class=\"line\">channel c2: reading <span class=\"keyword\">from</span> <span class=\"keyword\">backup</span> piece /u01/rmanbackup/db1.rman</span><br><span class=\"line\">channel c2: piece handle=/u01/rmanbackup/db1.rman tag=DB_RMAN</span><br><span class=\"line\">channel c2: restored <span class=\"keyword\">backup</span> piece <span class=\"number\">1</span></span><br><span class=\"line\">channel c2: <span class=\"keyword\">restore</span> <span class=\"keyword\">complete</span>, elapsed <span class=\"built_in\">time</span>: <span class=\"number\">00</span>:<span class=\"number\">00</span>:<span class=\"number\">08</span></span><br><span class=\"line\">channel c1: piece handle=/u01/rmanbackup/db2.rman tag=DB_RMAN</span><br><span class=\"line\">channel c1: restored <span class=\"keyword\">backup</span> piece <span class=\"number\">1</span></span><br><span class=\"line\">channel c1: <span class=\"keyword\">restore</span> <span class=\"keyword\">complete</span>, elapsed <span class=\"built_in\">time</span>: <span class=\"number\">00</span>:<span class=\"number\">00</span>:<span class=\"number\">36</span></span><br><span class=\"line\">Finished <span class=\"keyword\">restore</span> <span class=\"keyword\">at</span> <span class=\"number\">18</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">datafile</span> <span class=\"number\">1</span> switched <span class=\"keyword\">to</span> <span class=\"keyword\">datafile</span> copy</span><br><span class=\"line\"><span class=\"keyword\">input</span> <span class=\"keyword\">datafile</span> copy RECID=<span class=\"number\">5</span> STAMP=<span class=\"number\">890701322</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/system01.dbf</span><br><span class=\"line\"><span class=\"keyword\">datafile</span> <span class=\"number\">2</span> switched <span class=\"keyword\">to</span> <span class=\"keyword\">datafile</span> copy</span><br><span class=\"line\"><span class=\"keyword\">input</span> <span class=\"keyword\">datafile</span> copy RECID=<span class=\"number\">6</span> STAMP=<span class=\"number\">890701322</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/sysaux01.dbf</span><br><span class=\"line\"><span class=\"keyword\">datafile</span> <span class=\"number\">3</span> switched <span class=\"keyword\">to</span> <span class=\"keyword\">datafile</span> copy</span><br><span class=\"line\"><span class=\"keyword\">input</span> <span class=\"keyword\">datafile</span> copy RECID=<span class=\"number\">7</span> STAMP=<span class=\"number\">890701322</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/undotbs01.dbf</span><br><span class=\"line\"><span class=\"keyword\">datafile</span> <span class=\"number\">4</span> switched <span class=\"keyword\">to</span> <span class=\"keyword\">datafile</span> copy</span><br><span class=\"line\"><span class=\"keyword\">input</span> <span class=\"keyword\">datafile</span> copy RECID=<span class=\"number\">8</span> STAMP=<span class=\"number\">890701322</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/users01.dbf</span><br><span class=\"line\"></span><br><span class=\"line\">renamed tempfile <span class=\"number\">1</span> <span class=\"keyword\">to</span> /u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/temp01.dbf <span class=\"keyword\">in</span> control <span class=\"keyword\">file</span></span><br><span class=\"line\">released channel: c1</span><br><span class=\"line\">released channel: c2</span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>restore完毕，我们再来看一下控制文件中的信息</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">RMAN&gt; report schema;</span><br><span class=\"line\"></span><br><span class=\"line\">RMAN-06139: WARNING: control file is not current for REPORT SCHEMA</span><br><span class=\"line\">Report of database schema for database <span class=\"keyword\">with</span> db_unique_name <span class=\"keyword\">MIN</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">List</span> <span class=\"keyword\">of</span> <span class=\"keyword\">Permanent</span> <span class=\"keyword\">Datafiles</span></span><br><span class=\"line\">===========================</span><br><span class=\"line\"><span class=\"keyword\">File</span> <span class=\"keyword\">Size</span>(MB) <span class=\"keyword\">Tablespace</span>           RB segs <span class=\"keyword\">Datafile</span> <span class=\"keyword\">Name</span></span><br><span class=\"line\"><span class=\"comment\">---- -------- -------------------- ------- ------------------------</span></span><br><span class=\"line\"><span class=\"number\">1</span>    <span class=\"number\">750</span>      <span class=\"keyword\">SYSTEM</span>               ***     /u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/system01.dbf</span><br><span class=\"line\"><span class=\"number\">2</span>    <span class=\"number\">560</span>      <span class=\"keyword\">SYSAUX</span>               ***     /u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/sysaux01.dbf</span><br><span class=\"line\"><span class=\"number\">3</span>    <span class=\"number\">100</span>      UNDOTBS1             ***     /u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/undotbs01.dbf</span><br><span class=\"line\"><span class=\"number\">4</span>    <span class=\"number\">5</span>        <span class=\"keyword\">USERS</span>                ***     /u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/users01.dbf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">List</span> <span class=\"keyword\">of</span> <span class=\"keyword\">Temporary</span> Files</span><br><span class=\"line\">=======================</span><br><span class=\"line\"><span class=\"keyword\">File</span> <span class=\"keyword\">Size</span>(MB) <span class=\"keyword\">Tablespace</span>           <span class=\"keyword\">Maxsize</span>(MB) Tempfile <span class=\"keyword\">Name</span></span><br><span class=\"line\"><span class=\"comment\">---- -------- -------------------- ----------- --------------------</span></span><br><span class=\"line\"><span class=\"number\">1</span>    <span class=\"number\">20</span>       TEMP                 <span class=\"number\">32767</span>       /u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/temp01.dbf</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"完全恢复数据库\"><a href=\"#完全恢复数据库\" class=\"headerlink\" title=\"完全恢复数据库\"></a>完全恢复数据库</h3><figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">RMAN&gt; recover database;</span><br><span class=\"line\"></span><br><span class=\"line\">Starting recover at 18-SEP-15</span><br><span class=\"line\">allocated channel: ORA_DISK_1</span><br><span class=\"line\">channel ORA_DISK_1: SID=1146 device type=DISK</span><br><span class=\"line\">allocated channel: ORA_DISK_2</span><br><span class=\"line\">channel ORA_DISK_2: SID=11 device type=DISK</span><br><span class=\"line\">allocated channel: ORA_DISK_3</span><br><span class=\"line\">channel ORA_DISK_3: SID=1137 device type=DISK</span><br><span class=\"line\">allocated channel: ORA_DISK_4</span><br><span class=\"line\">channel ORA_DISK_4: SID=10 device type=DISK</span><br><span class=\"line\"></span><br><span class=\"line\">starting media recovery</span><br><span class=\"line\"></span><br><span class=\"line\">archived log for thread 1 <span class=\"keyword\">with</span> <span class=\"keyword\">sequence</span> <span class=\"number\">38</span> <span class=\"keyword\">is</span> already <span class=\"keyword\">on</span> disk <span class=\"keyword\">as</span> <span class=\"keyword\">file</span> /u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/redo2a.log</span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">for</span> <span class=\"keyword\">thread</span> <span class=\"number\">1</span> <span class=\"keyword\">with</span> <span class=\"keyword\">sequence</span> <span class=\"number\">39</span> <span class=\"keyword\">is</span> already <span class=\"keyword\">on</span> disk <span class=\"keyword\">as</span> <span class=\"keyword\">file</span> /u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/redo3a.log</span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">for</span> <span class=\"keyword\">thread</span> <span class=\"number\">1</span> <span class=\"keyword\">with</span> <span class=\"keyword\">sequence</span> <span class=\"number\">40</span> <span class=\"keyword\">is</span> already <span class=\"keyword\">on</span> disk <span class=\"keyword\">as</span> <span class=\"keyword\">file</span> /u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/redo1a.log</span><br><span class=\"line\">channel ORA_DISK_1: <span class=\"keyword\">starting</span> <span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">restore</span> <span class=\"keyword\">to</span> <span class=\"keyword\">default</span> destination</span><br><span class=\"line\">channel ORA_DISK_1: restoring <span class=\"keyword\">archived</span> <span class=\"keyword\">log</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">20</span></span><br><span class=\"line\">channel ORA_DISK_1: reading <span class=\"keyword\">from</span> <span class=\"keyword\">backup</span> piece /u01/rmanbackup/arc2.rman</span><br><span class=\"line\">channel ORA_DISK_2: <span class=\"keyword\">starting</span> <span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">restore</span> <span class=\"keyword\">to</span> <span class=\"keyword\">default</span> destination</span><br><span class=\"line\">channel ORA_DISK_2: restoring <span class=\"keyword\">archived</span> <span class=\"keyword\">log</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">21</span></span><br><span class=\"line\">channel ORA_DISK_2: reading <span class=\"keyword\">from</span> <span class=\"keyword\">backup</span> piece /u01/rmanbackup/arc1.rman</span><br><span class=\"line\">channel ORA_DISK_2: piece handle=/u01/rmanbackup/arc1.rman tag=ARC_RMAN</span><br><span class=\"line\">channel ORA_DISK_2: restored <span class=\"keyword\">backup</span> piece <span class=\"number\">1</span></span><br><span class=\"line\">channel ORA_DISK_2: <span class=\"keyword\">restore</span> <span class=\"keyword\">complete</span>, elapsed <span class=\"built_in\">time</span>: <span class=\"number\">00</span>:<span class=\"number\">00</span>:<span class=\"number\">01</span></span><br><span class=\"line\">channel ORA_DISK_1: piece handle=/u01/rmanbackup/arc2.rman tag=ARC_RMAN</span><br><span class=\"line\">channel ORA_DISK_1: restored <span class=\"keyword\">backup</span> piece <span class=\"number\">1</span></span><br><span class=\"line\">channel ORA_DISK_1: <span class=\"keyword\">restore</span> <span class=\"keyword\">complete</span>, elapsed <span class=\"built_in\">time</span>: <span class=\"number\">00</span>:<span class=\"number\">00</span>:<span class=\"number\">03</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_20_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">20</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_21_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">21</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_22_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">22</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_23_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">23</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_24_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">24</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_25_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">25</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_26_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">26</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_27_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">27</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_28_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">28</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_29_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">29</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_30_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">30</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_31_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">31</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_32_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">32</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_33_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">33</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_34_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">34</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_35_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">35</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_36_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">36</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/archived_log/<span class=\"number\">1</span>_37_854775184.dbf <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">37</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/redo2a.log <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">38</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/redo3a.log <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">39</span></span><br><span class=\"line\"><span class=\"keyword\">archived</span> <span class=\"keyword\">log</span> <span class=\"keyword\">file</span> <span class=\"keyword\">name</span>=/u01/app/<span class=\"keyword\">oracle</span>/<span class=\"keyword\">oradata</span>/<span class=\"keyword\">min</span>/redo1a.log <span class=\"keyword\">thread</span>=<span class=\"number\">1</span> <span class=\"keyword\">sequence</span>=<span class=\"number\">40</span></span><br><span class=\"line\">media <span class=\"keyword\">recovery</span> <span class=\"keyword\">complete</span>, elapsed <span class=\"built_in\">time</span>: <span class=\"number\">00</span>:<span class=\"number\">00</span>:<span class=\"number\">43</span></span><br><span class=\"line\">Finished <span class=\"keyword\">recover</span> <span class=\"keyword\">at</span> <span class=\"number\">18</span>-SEP<span class=\"number\">-15</span></span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt;</span><br></pre></td></tr></table></figure>\n\n<p>从恢复的日志可以看出，oracle会绕过38、39号的归档直接利用在线日志做恢复，oracle的聪明之处可见一斑！<br>试着正常方式打开数据库，会发现报错：</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">RMAN&gt; alter database open;</span><br><span class=\"line\"></span><br><span class=\"line\">RMAN-00571: ===========================================================</span><br><span class=\"line\">RMAN-00569: =============== ERROR MESSAGE STACK FOLLOWS ===============</span><br><span class=\"line\">RMAN-00571: ===========================================================</span><br><span class=\"line\">RMAN-03002: failure of <span class=\"keyword\">alter</span> db command <span class=\"keyword\">at</span> <span class=\"number\">09</span>/<span class=\"number\">18</span>/<span class=\"number\">2015</span> <span class=\"number\">01</span>:<span class=\"number\">04</span>:<span class=\"number\">41</span></span><br><span class=\"line\">ORA<span class=\"number\">-01589</span>: must <span class=\"keyword\">use</span> <span class=\"keyword\">RESETLOGS</span> <span class=\"keyword\">or</span> <span class=\"keyword\">NORESETLOGS</span> <span class=\"keyword\">option</span> <span class=\"keyword\">for</span> <span class=\"keyword\">database</span> <span class=\"keyword\">open</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">--看一下此时控制文件中的日志序列号，会发现没有前推，必须用resetlogs打开数据库</span></span><br><span class=\"line\"><span class=\"keyword\">SQL</span>&gt;  <span class=\"keyword\">select</span> <span class=\"keyword\">group</span><span class=\"comment\">#,status,sequence# from v$log;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">GROUP</span><span class=\"comment\"># STATUS            SEQUENCE#</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------------- ----------</span></span><br><span class=\"line\">         <span class=\"number\">1</span> <span class=\"keyword\">CURRENT</span>                  <span class=\"number\">22</span></span><br><span class=\"line\">         <span class=\"number\">3</span> ACTIVE                   <span class=\"number\">21</span></span><br><span class=\"line\">         <span class=\"number\">2</span> ACTIVE                   <span class=\"number\">20</span></span><br><span class=\"line\">RMAN&gt; <span class=\"keyword\">alter</span> <span class=\"keyword\">database</span> <span class=\"keyword\">open</span> <span class=\"keyword\">resetlogs</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">database opened</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>使用resetlog的原因是recover命令只能修复控制文件中数据物理结构信息，而无法修改控制文件中的当前重做日志的序列号的信息，recover命令结束后，控制文件中的当前日志序列号还是陈旧的，若按常规方式打开数据库，将报错，为了抹去控制文件这个固执的念头，oracle采用重设日志的功能，日志序列号从1开始。此处虽然使用了resetlogs，但是因为“recover database”命令执行成功，所有提交的事务不会丢失，resetlogs仅仅是为了照顾还原的控制文件，与不完全恢复的resetlogs是不同的，至此恢复结束。</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; conn test/test</span><br><span class=\"line\">ERROR:</span><br><span class=\"line\">ORA-28002: the password will expire within 6 days</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Connected.</span><br><span class=\"line\">SQL&gt; select count(1) from t;</span><br><span class=\"line\"></span><br><span class=\"line\">  COUNT(1)</span><br><span class=\"line\"><span class=\"comment\">----------</span></span><br><span class=\"line\">   3000000</span><br></pre></td></tr></table></figure>"},{"date":"2017-07-01T03:04:00.000Z","title":"利用DBMS_SCHEDULER在Oracle 11gR2 RAC上执行rman备份","_content":"\n# 利用DBMS_SCHEDULER在Oracle 11gR2 RAC上执行rman备份\n\nRMAN backup in Oracle 11gR2 RAC is exactly same like RMAN backup in Oracle 11gR2 single node.\nThe only difference is: Typically, in case of Oracle single node database, we will schedule RMAN scripts with the help of CRON job and it will run according to our convenience, but in case of Oracle RAC if we schedule RMAN script and if unfortunately that RAC node goes down ( where we configured RMAN scripts ), then RMAN backup won’t run obviously.\n\nSo, Same strategy will not be work in Oracle RAC node. For RMAN consistent backups use dbms_scheduler & we need to place RMAN scripts in shared directory. ( Or in my case, I have created identical scripts on both cluster node’s )\n\n**注意：**  *需要将脚本放在共享位置或者每个节点的相同位置*\n\n>看一下rman的备份脚本，此脚本将备份放在ASM中，将日志放在节点本地\n\n```\n################################################################\n#    rman_backup_rac.sh FOR RAC                                #\n#    created by lp                                             #\n#    2017/03/22                                                #\n#    usage: rman_backup_rac.sh <$BACKUP_LEVEL>                 #\n#           BACKUP_LEVEL:                                      #\n#              F: full backup                                  #\n#              0: level 0                                      #\n#              1: level 1                                      #\n################################################################\n\n\n#!/bin/bash\n# User specific environment and startup programs\nexport ORACLE_HOME=/u01/app/oracle/product/11.2.0/dbhome_1\nexport RMAN_BAK_LOG_BASE=/home/oracle/DbBackup\nexport RMAN_BAK_DATA_BASE=+data/NXRAC/backup\nexport ORACLE_SID=`ps -ef|grep pmon|grep -v ASM|grep -v grep|awk -F'_' '{print $NF}'`\nexport TIMESTAMP=`date +%Y%m%d%H%M`;\n\n#the destination of rman backuppiece\nexport RMAN_DATA=${RMAN_BAK_DATA_BASE}/rman\n\n#the destination of rman backup logs\nexport RMAN_LOG=${RMAN_BAK_LOG_BASE}/logs\n\n\nif [[ ! -z $1 ]] && echo $1 |grep -Ew \"[01F]\" >/dev/null 2>&1\nthen\n                                export RMAN_LEVEL=${1}\n\n                                # Check rman level\n                                if [ \"$RMAN_LEVEL\" == \"F\" ];\n                                        then  unset INCR_LVL\n                                        BACKUP_TYPE=full\n                                        else\n                                        INCR_LVL=\"INCREMENTAL LEVEL ${RMAN_LEVEL}\"\n                                        BACKUP_TYPE=lev${RMAN_LEVEL}\n                                fi\nelse\n                                echo \"${1} wrong argument!\" >${RMAN_LOG}/wrong_argument_${TIMESTAMP}.log\n                                exit 1\nfi\n\n\n\n\n\n#the prefix of rman backuppiece                                 \nexport RMAN_FILE=${RMAN_DATA}/${BACKUP_TYPE}_${TIMESTAMP}\n\n#the logfile of shell script including the rman logs contents\nexport SSH_LOG=${RMAN_LOG}/${BACKUP_TYPE}_${TIMESTAMP}.log\n\n#the size of backuppiece\nexport MAXPIECESIZE=4G\n\n####################################################################\n#                                                                  #\n#   the name of rman logs excluding the file expanded-name,        #\n#   when the shell is complete,the content of this file will be    #\n#   appended to the $SSH_LOG and the rman logfile will be deleted. #\n#                                                                  #\n####################################################################\nexport RMAN_LOG_FILE=${RMAN_LOG}/${BACKUP_TYPE}_${TIMESTAMP}_1\n\n\n#Check RMAN Backup Path\n\nif ! test -d ${RMAN_LOG}\nthen\nmkdir -p ${RMAN_LOG}\nfi\n\necho \"---------------------------------\" >>${SSH_LOG}\necho \"   \" >>${SSH_LOG}\necho \"Rman Begin  to Working .........\" >>${SSH_LOG}\necho \"Begin time at:\" `date` --`date +%Y%m%d%H%M` >>${SSH_LOG}\n\n#Startup rman to backup\n\n$ORACLE_HOME/bin/rman log=${RMAN_LOG_FILE}.log <<EOF\nconnect target /\nrun {\nCONFIGURE RETENTION POLICY TO RECOVERY WINDOW OF 7 DAYS;\nCONFIGURE BACKUP OPTIMIZATION ON;\nCONFIGURE CONTROLFILE AUTOBACKUP ON;\nCONFIGURE DEVICE TYPE DISK PARALLELISM 4 BACKUP TYPE TO BACKUPSET;\nCONFIGURE CONTROLFILE AUTOBACKUP FORMAT FOR DEVICE TYPE DISK TO '${RMAN_DATA}/control_auto_%F';\nALLOCATE CHANNEL 'ch1' TYPE DISK maxpiecesize=${MAXPIECESIZE} CONNECT 'SYS/passwd@node1';\nALLOCATE CHANNEL 'ch2' TYPE DISK maxpiecesize=${MAXPIECESIZE} CONNECT 'SYS/passwd@node1';\nALLOCATE CHANNEL 'ch3' TYPE DISK maxpiecesize=${MAXPIECESIZE} CONNECT 'SYS/passwd@mode2';\nALLOCATE CHANNEL 'ch4' TYPE DISK maxpiecesize=${MAXPIECESIZE} CONNECT 'SYS/passwd@node2';\nCROSSCHECK ARCHIVELOG ALL;\nDELETE NOPROMPT OBSOLETE;\nDELETE NOPROMPT EXPIRED BACKUP;\nBACKUP AS COMPRESSED BACKUPSET\n${INCR_LVL}\nDATABASE FORMAT '${RMAN_FILE}_db_%U' TAG '${BACKUP_TYPE}_${TIMESTAMP}';\nSQL 'ALTER SYSTEM ARCHIVE LOG CURRENT';\nBACKUP FILESPERSET 20 ARCHIVELOG ALL FORMAT '${RMAN_FILE}_arc_%U' TAG '${ORACLE_SID}_arc_${TIMESTAMP}'\nDELETE  INPUT;  \nRELEASE CHANNEL ch1;\nRELEASE CHANNEL ch2;\nRELEASE CHANNEL ch3;\nRELEASE CHANNEL ch4;\nALLOCATE CHANNEL ch00 TYPE DISK;\nBACKUP\n    FORMAT '${RMAN_DATA}/cntrl_%U'\n    CURRENT CONTROLFILE;\nRELEASE CHANNEL ch00;\n}\nexit;\nEOF\n\nRC=$?\n\ncat ${RMAN_LOG_FILE}.log >>${SSH_LOG}\necho \"Rman Stop working @ time:\"`date` `date +%Y%m%d%H%M` >>${SSH_LOG}\n\nif [ $RC -ne \"0\" ]; then\n    echo \"------ error ------\" >>${SSH_LOG}\nelse\n    echo \"------ Success during RMAN backup peroid------\" >>${SSH_LOG}\n    rm -rf ${RMAN_LOG_FILE}.log\nfi\n\nexit\n```\n\n**DBMS_SCHEDULER:**\n\nHere we are using DBMS_SCHEDULER instead of DBMS_JOB, because DBMS_SCHEDULER is RAC aware.\n\n**Before jump into real DBMS_SCHEDULER configuration, we need to focus on an important thing, That:**\n\nBoth RAC nodes local time zone must be identical with DBMS_SCHEDULER default time.\n\nOn all RAC node, Ensure local time zone and set it accordingly.\n\n```shell\n[oracle@node2 ]$ cat /etc/sysconfig/clock\nZONE=\"Asia/Shanghai\"\n```\n**configure default time zone for DBMS_SCHEDULER**\n\n```SQL\nSQL> select value from dba_scheduler_global_attribute where attribute_name = 'DEFAULT_TIMEZONE';\n\nVALUE\n--------------------------------------------------------------------------------\nPRC\n\nSQL> exec dbms_scheduler.set_scheduler_attribute ('DEFAULT_TIMEZONE', 'Asia/Shanghai');\n\nPL/SQL procedure successfully completed.\n\nSQL> select value from dba_scheduler_global_attribute where attribute_name = 'DEFAULT_TIMEZONE';\n\nVALUE\n--------------------------------------------------------------------------------\nAsia/Shanghai\n\n```\n\nNow we need to create credential so that are assigned to DBMS_SCHEDULER jobs so that they can authenticate with a local/remote host operating system or a remote Oracle database.\n\n```SQL\nSQL> exec dbms_scheduler.create_credential(credential_name => 'oracle', username => 'oracle', password => 'oracle');\n\nPL/SQL procedure successfully completed.\n```\n\nNow its time to create DBMS_SCHEDULER job for RMAN incremental level 0 backup, Here in this procedure I am going to create *RMAN_INC0_BACKUP* job with required attributes.\n\n```SQL\nbegin\ndbms_scheduler.create_job(\njob_name            => 'RMAN_INC0_BACKUP',\njob_type            => 'EXECUTABLE',\njob_action          => '/bin/sh',\nnumber_of_arguments => 2,\nstart_date          => SYSTIMESTAMP,\ncredential_name     => 'oracle',\nauto_drop           => FALSE,\nenabled             => FALSE);\nend;\n/\n```\nSet argument_position & argument_value ( i.e. Path of the RMAN script ) for the same job:\n\n```SQL\nbegin\ndbms_scheduler.set_job_argument_value(\njob_name            => 'RMAN_INC0_BACKUP',\nargument_position   =>  1,\nargument_value      => '/home/oracle/rman.sh');\nend;\n/\n\nbegin\ndbms_scheduler.set_job_argument_value(\njob_name            => 'RMAN_INC0_BACKUP',\nargument_position   =>  2,\nargument_value      => 0);\nend;\n/\n\n```\n\n\nSet start_date for the same job, In my case *RMAN_INC0_BACKUP* job will execute every week on sunday @03am, so job start date and its first run timing would  according to my convenience.\n```SQL\nbegin\ndbms_scheduler.set_attribute(\nname      => 'RMAN_INC0_BACKUP',\nattribute => 'start_date',\nvalue     => trunc(sysdate)+3/24);\nend;\n/\n```\n\nTest your backup job manually in SQL prompt by instantiating *RMAN_INC0_BACKUP* job.\n\n```SQL\nSQL> exec dbms_scheduler.run_job('RMAN_INC0_BACKUP');\nPL/SQL procedure successfully completed.\n```\n\nVerify running RMAN backup status by issuing following SQL query, It will show you RMAN backup details with start time & end time.\n\n```SQL\nselect SESSION_KEY, INPUT_TYPE, STATUS,\nto_char(START_TIME,'mm/dd/yy hh24:mi') start_time,\nto_char(END_TIME,'mm/dd/yy hh24:mi') end_time,\nelapsed_seconds/3600 hrs\nfrom V$RMAN_BACKUP_JOB_DETAILS\norder by session_key;\n```\n\nIn case of any error while test run, you can make sure details of error by issuing the following query, OR You can also query to *dba_scheduler_job_run_details* dictionary view for more details.\n\n```SQL\nselect JOB_NAME,STATUS,STATE,ERROR#,CREDENTIAL_NAME from dba_scheduler_job_run_details where CREDENTIAL_NAME like 'RMAN%';\n```\n\nAfter successfully completion of test run, Enable & schedule it by following procedure by setting value to *repeat_interval* parameter, In my case *RMAN_INC0_BACKUP* job will execute every week on Sunday @03pm.\n\n```SQL\nbegin\ndbms_scheduler.set_attribute(\nname      => 'RMAN_INC0_BACKUP',\nattribute => 'repeat_interval',\nvalue     => 'freq=daily;byday=sun;byhour=03');\ndbms_scheduler.enable( 'RMAN_INC0_BACKUP' );\nend;\n/\n```\n\nEnsure dbms_scheduler job details by issuing the following query OR you can also query to *dba_scheduler_jobs* and *dba_scheduler_job_args*.\n\n```SQL\nSQL> select job_name,enabled,owner, state from dba_scheduler_jobs where job_name in ('RMAN_INC0_BACKUP');\n```\n\nKeep your eye on behavior of dbms_scheduler job by issuing the following query:\n\n```SQL\nSQL> select job_name,RUN_COUNT,LAST_START_DATE,NEXT_RUN_DATE from dba_scheduler_jobs where job_name in ('RMAN_INC0_BACKUP');\nSQL> select *  from dba_scheduler_job_args where job_name like 'RMAN%';\n```\nIn accordance with the above method to create a level 1 backup job *RMAN_INC1_BACKUP*，The only difference is the *repeat_interval*：\n\n```SQL\nbegin\ndbms_scheduler.set_attribute(\nname      => 'RMAN_INC1_BACKUP',\nattribute => 'repeat_interval',\nvalue     => 'freq=daily;byday=mon,tue,wed,thu,fri,sat;byhour=03');\ndbms_scheduler.enable( 'RMAN_INC1_BACKUP' );\nend;\n/\n```\n\n**Important Note:**\nDBMS_SCHEDULER is smart enough to start backup on the node where the last backup was successfully executed.\n\n**参考：**\n\n<https://dbatricksworld.com/how-to-backup-oracle-rac-11gr2-database-with-rman-backup-utility-with-the-help-of-dbms_scheduler-part-i-rman-full-database-backup/>\n\n<http://dbatricksworld.com/how-to-backup-oracle-rac-11gr2-database-with-rman-backup-utility-with-the-help-of-dbms_scheduler-part-ii-rman-incremental-database-backup/>\n","source":"_posts/oracle/backup-restore/dbms_scheduler-for-rman-backup.md","raw":"---\ndate: 2017-07-01 11:04\ntags: oracle backup\ntitle: 利用DBMS_SCHEDULER在Oracle 11gR2 RAC上执行rman备份\ncategories: oracle backup\n---\n\n# 利用DBMS_SCHEDULER在Oracle 11gR2 RAC上执行rman备份\n\nRMAN backup in Oracle 11gR2 RAC is exactly same like RMAN backup in Oracle 11gR2 single node.\nThe only difference is: Typically, in case of Oracle single node database, we will schedule RMAN scripts with the help of CRON job and it will run according to our convenience, but in case of Oracle RAC if we schedule RMAN script and if unfortunately that RAC node goes down ( where we configured RMAN scripts ), then RMAN backup won’t run obviously.\n\nSo, Same strategy will not be work in Oracle RAC node. For RMAN consistent backups use dbms_scheduler & we need to place RMAN scripts in shared directory. ( Or in my case, I have created identical scripts on both cluster node’s )\n\n**注意：**  *需要将脚本放在共享位置或者每个节点的相同位置*\n\n>看一下rman的备份脚本，此脚本将备份放在ASM中，将日志放在节点本地\n\n```\n################################################################\n#    rman_backup_rac.sh FOR RAC                                #\n#    created by lp                                             #\n#    2017/03/22                                                #\n#    usage: rman_backup_rac.sh <$BACKUP_LEVEL>                 #\n#           BACKUP_LEVEL:                                      #\n#              F: full backup                                  #\n#              0: level 0                                      #\n#              1: level 1                                      #\n################################################################\n\n\n#!/bin/bash\n# User specific environment and startup programs\nexport ORACLE_HOME=/u01/app/oracle/product/11.2.0/dbhome_1\nexport RMAN_BAK_LOG_BASE=/home/oracle/DbBackup\nexport RMAN_BAK_DATA_BASE=+data/NXRAC/backup\nexport ORACLE_SID=`ps -ef|grep pmon|grep -v ASM|grep -v grep|awk -F'_' '{print $NF}'`\nexport TIMESTAMP=`date +%Y%m%d%H%M`;\n\n#the destination of rman backuppiece\nexport RMAN_DATA=${RMAN_BAK_DATA_BASE}/rman\n\n#the destination of rman backup logs\nexport RMAN_LOG=${RMAN_BAK_LOG_BASE}/logs\n\n\nif [[ ! -z $1 ]] && echo $1 |grep -Ew \"[01F]\" >/dev/null 2>&1\nthen\n                                export RMAN_LEVEL=${1}\n\n                                # Check rman level\n                                if [ \"$RMAN_LEVEL\" == \"F\" ];\n                                        then  unset INCR_LVL\n                                        BACKUP_TYPE=full\n                                        else\n                                        INCR_LVL=\"INCREMENTAL LEVEL ${RMAN_LEVEL}\"\n                                        BACKUP_TYPE=lev${RMAN_LEVEL}\n                                fi\nelse\n                                echo \"${1} wrong argument!\" >${RMAN_LOG}/wrong_argument_${TIMESTAMP}.log\n                                exit 1\nfi\n\n\n\n\n\n#the prefix of rman backuppiece                                 \nexport RMAN_FILE=${RMAN_DATA}/${BACKUP_TYPE}_${TIMESTAMP}\n\n#the logfile of shell script including the rman logs contents\nexport SSH_LOG=${RMAN_LOG}/${BACKUP_TYPE}_${TIMESTAMP}.log\n\n#the size of backuppiece\nexport MAXPIECESIZE=4G\n\n####################################################################\n#                                                                  #\n#   the name of rman logs excluding the file expanded-name,        #\n#   when the shell is complete,the content of this file will be    #\n#   appended to the $SSH_LOG and the rman logfile will be deleted. #\n#                                                                  #\n####################################################################\nexport RMAN_LOG_FILE=${RMAN_LOG}/${BACKUP_TYPE}_${TIMESTAMP}_1\n\n\n#Check RMAN Backup Path\n\nif ! test -d ${RMAN_LOG}\nthen\nmkdir -p ${RMAN_LOG}\nfi\n\necho \"---------------------------------\" >>${SSH_LOG}\necho \"   \" >>${SSH_LOG}\necho \"Rman Begin  to Working .........\" >>${SSH_LOG}\necho \"Begin time at:\" `date` --`date +%Y%m%d%H%M` >>${SSH_LOG}\n\n#Startup rman to backup\n\n$ORACLE_HOME/bin/rman log=${RMAN_LOG_FILE}.log <<EOF\nconnect target /\nrun {\nCONFIGURE RETENTION POLICY TO RECOVERY WINDOW OF 7 DAYS;\nCONFIGURE BACKUP OPTIMIZATION ON;\nCONFIGURE CONTROLFILE AUTOBACKUP ON;\nCONFIGURE DEVICE TYPE DISK PARALLELISM 4 BACKUP TYPE TO BACKUPSET;\nCONFIGURE CONTROLFILE AUTOBACKUP FORMAT FOR DEVICE TYPE DISK TO '${RMAN_DATA}/control_auto_%F';\nALLOCATE CHANNEL 'ch1' TYPE DISK maxpiecesize=${MAXPIECESIZE} CONNECT 'SYS/passwd@node1';\nALLOCATE CHANNEL 'ch2' TYPE DISK maxpiecesize=${MAXPIECESIZE} CONNECT 'SYS/passwd@node1';\nALLOCATE CHANNEL 'ch3' TYPE DISK maxpiecesize=${MAXPIECESIZE} CONNECT 'SYS/passwd@mode2';\nALLOCATE CHANNEL 'ch4' TYPE DISK maxpiecesize=${MAXPIECESIZE} CONNECT 'SYS/passwd@node2';\nCROSSCHECK ARCHIVELOG ALL;\nDELETE NOPROMPT OBSOLETE;\nDELETE NOPROMPT EXPIRED BACKUP;\nBACKUP AS COMPRESSED BACKUPSET\n${INCR_LVL}\nDATABASE FORMAT '${RMAN_FILE}_db_%U' TAG '${BACKUP_TYPE}_${TIMESTAMP}';\nSQL 'ALTER SYSTEM ARCHIVE LOG CURRENT';\nBACKUP FILESPERSET 20 ARCHIVELOG ALL FORMAT '${RMAN_FILE}_arc_%U' TAG '${ORACLE_SID}_arc_${TIMESTAMP}'\nDELETE  INPUT;  \nRELEASE CHANNEL ch1;\nRELEASE CHANNEL ch2;\nRELEASE CHANNEL ch3;\nRELEASE CHANNEL ch4;\nALLOCATE CHANNEL ch00 TYPE DISK;\nBACKUP\n    FORMAT '${RMAN_DATA}/cntrl_%U'\n    CURRENT CONTROLFILE;\nRELEASE CHANNEL ch00;\n}\nexit;\nEOF\n\nRC=$?\n\ncat ${RMAN_LOG_FILE}.log >>${SSH_LOG}\necho \"Rman Stop working @ time:\"`date` `date +%Y%m%d%H%M` >>${SSH_LOG}\n\nif [ $RC -ne \"0\" ]; then\n    echo \"------ error ------\" >>${SSH_LOG}\nelse\n    echo \"------ Success during RMAN backup peroid------\" >>${SSH_LOG}\n    rm -rf ${RMAN_LOG_FILE}.log\nfi\n\nexit\n```\n\n**DBMS_SCHEDULER:**\n\nHere we are using DBMS_SCHEDULER instead of DBMS_JOB, because DBMS_SCHEDULER is RAC aware.\n\n**Before jump into real DBMS_SCHEDULER configuration, we need to focus on an important thing, That:**\n\nBoth RAC nodes local time zone must be identical with DBMS_SCHEDULER default time.\n\nOn all RAC node, Ensure local time zone and set it accordingly.\n\n```shell\n[oracle@node2 ]$ cat /etc/sysconfig/clock\nZONE=\"Asia/Shanghai\"\n```\n**configure default time zone for DBMS_SCHEDULER**\n\n```SQL\nSQL> select value from dba_scheduler_global_attribute where attribute_name = 'DEFAULT_TIMEZONE';\n\nVALUE\n--------------------------------------------------------------------------------\nPRC\n\nSQL> exec dbms_scheduler.set_scheduler_attribute ('DEFAULT_TIMEZONE', 'Asia/Shanghai');\n\nPL/SQL procedure successfully completed.\n\nSQL> select value from dba_scheduler_global_attribute where attribute_name = 'DEFAULT_TIMEZONE';\n\nVALUE\n--------------------------------------------------------------------------------\nAsia/Shanghai\n\n```\n\nNow we need to create credential so that are assigned to DBMS_SCHEDULER jobs so that they can authenticate with a local/remote host operating system or a remote Oracle database.\n\n```SQL\nSQL> exec dbms_scheduler.create_credential(credential_name => 'oracle', username => 'oracle', password => 'oracle');\n\nPL/SQL procedure successfully completed.\n```\n\nNow its time to create DBMS_SCHEDULER job for RMAN incremental level 0 backup, Here in this procedure I am going to create *RMAN_INC0_BACKUP* job with required attributes.\n\n```SQL\nbegin\ndbms_scheduler.create_job(\njob_name            => 'RMAN_INC0_BACKUP',\njob_type            => 'EXECUTABLE',\njob_action          => '/bin/sh',\nnumber_of_arguments => 2,\nstart_date          => SYSTIMESTAMP,\ncredential_name     => 'oracle',\nauto_drop           => FALSE,\nenabled             => FALSE);\nend;\n/\n```\nSet argument_position & argument_value ( i.e. Path of the RMAN script ) for the same job:\n\n```SQL\nbegin\ndbms_scheduler.set_job_argument_value(\njob_name            => 'RMAN_INC0_BACKUP',\nargument_position   =>  1,\nargument_value      => '/home/oracle/rman.sh');\nend;\n/\n\nbegin\ndbms_scheduler.set_job_argument_value(\njob_name            => 'RMAN_INC0_BACKUP',\nargument_position   =>  2,\nargument_value      => 0);\nend;\n/\n\n```\n\n\nSet start_date for the same job, In my case *RMAN_INC0_BACKUP* job will execute every week on sunday @03am, so job start date and its first run timing would  according to my convenience.\n```SQL\nbegin\ndbms_scheduler.set_attribute(\nname      => 'RMAN_INC0_BACKUP',\nattribute => 'start_date',\nvalue     => trunc(sysdate)+3/24);\nend;\n/\n```\n\nTest your backup job manually in SQL prompt by instantiating *RMAN_INC0_BACKUP* job.\n\n```SQL\nSQL> exec dbms_scheduler.run_job('RMAN_INC0_BACKUP');\nPL/SQL procedure successfully completed.\n```\n\nVerify running RMAN backup status by issuing following SQL query, It will show you RMAN backup details with start time & end time.\n\n```SQL\nselect SESSION_KEY, INPUT_TYPE, STATUS,\nto_char(START_TIME,'mm/dd/yy hh24:mi') start_time,\nto_char(END_TIME,'mm/dd/yy hh24:mi') end_time,\nelapsed_seconds/3600 hrs\nfrom V$RMAN_BACKUP_JOB_DETAILS\norder by session_key;\n```\n\nIn case of any error while test run, you can make sure details of error by issuing the following query, OR You can also query to *dba_scheduler_job_run_details* dictionary view for more details.\n\n```SQL\nselect JOB_NAME,STATUS,STATE,ERROR#,CREDENTIAL_NAME from dba_scheduler_job_run_details where CREDENTIAL_NAME like 'RMAN%';\n```\n\nAfter successfully completion of test run, Enable & schedule it by following procedure by setting value to *repeat_interval* parameter, In my case *RMAN_INC0_BACKUP* job will execute every week on Sunday @03pm.\n\n```SQL\nbegin\ndbms_scheduler.set_attribute(\nname      => 'RMAN_INC0_BACKUP',\nattribute => 'repeat_interval',\nvalue     => 'freq=daily;byday=sun;byhour=03');\ndbms_scheduler.enable( 'RMAN_INC0_BACKUP' );\nend;\n/\n```\n\nEnsure dbms_scheduler job details by issuing the following query OR you can also query to *dba_scheduler_jobs* and *dba_scheduler_job_args*.\n\n```SQL\nSQL> select job_name,enabled,owner, state from dba_scheduler_jobs where job_name in ('RMAN_INC0_BACKUP');\n```\n\nKeep your eye on behavior of dbms_scheduler job by issuing the following query:\n\n```SQL\nSQL> select job_name,RUN_COUNT,LAST_START_DATE,NEXT_RUN_DATE from dba_scheduler_jobs where job_name in ('RMAN_INC0_BACKUP');\nSQL> select *  from dba_scheduler_job_args where job_name like 'RMAN%';\n```\nIn accordance with the above method to create a level 1 backup job *RMAN_INC1_BACKUP*，The only difference is the *repeat_interval*：\n\n```SQL\nbegin\ndbms_scheduler.set_attribute(\nname      => 'RMAN_INC1_BACKUP',\nattribute => 'repeat_interval',\nvalue     => 'freq=daily;byday=mon,tue,wed,thu,fri,sat;byhour=03');\ndbms_scheduler.enable( 'RMAN_INC1_BACKUP' );\nend;\n/\n```\n\n**Important Note:**\nDBMS_SCHEDULER is smart enough to start backup on the node where the last backup was successfully executed.\n\n**参考：**\n\n<https://dbatricksworld.com/how-to-backup-oracle-rac-11gr2-database-with-rman-backup-utility-with-the-help-of-dbms_scheduler-part-i-rman-full-database-backup/>\n\n<http://dbatricksworld.com/how-to-backup-oracle-rac-11gr2-database-with-rman-backup-utility-with-the-help-of-dbms_scheduler-part-ii-rman-incremental-database-backup/>\n","slug":"oracle/backup-restore/dbms_scheduler-for-rman-backup","published":1,"updated":"2019-07-21T04:43:08.312Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjych78ie0001f40e0bk7gpwk","content":"<h1 id=\"利用DBMS-SCHEDULER在Oracle-11gR2-RAC上执行rman备份\"><a href=\"#利用DBMS-SCHEDULER在Oracle-11gR2-RAC上执行rman备份\" class=\"headerlink\" title=\"利用DBMS_SCHEDULER在Oracle 11gR2 RAC上执行rman备份\"></a>利用DBMS_SCHEDULER在Oracle 11gR2 RAC上执行rman备份</h1><p>RMAN backup in Oracle 11gR2 RAC is exactly same like RMAN backup in Oracle 11gR2 single node.<br>The only difference is: Typically, in case of Oracle single node database, we will schedule RMAN scripts with the help of CRON job and it will run according to our convenience, but in case of Oracle RAC if we schedule RMAN script and if unfortunately that RAC node goes down ( where we configured RMAN scripts ), then RMAN backup won’t run obviously.</p>\n<p>So, Same strategy will not be work in Oracle RAC node. For RMAN consistent backups use dbms_scheduler &amp; we need to place RMAN scripts in shared directory. ( Or in my case, I have created identical scripts on both cluster node’s )</p>\n<p><strong>注意：</strong>  <em>需要将脚本放在共享位置或者每个节点的相同位置</em></p>\n<blockquote>\n<p>看一下rman的备份脚本，此脚本将备份放在ASM中，将日志放在节点本地</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">################################################################</span><br><span class=\"line\">#    rman_backup_rac.sh FOR RAC                                #</span><br><span class=\"line\">#    created by lp                                             #</span><br><span class=\"line\">#    2017/03/22                                                #</span><br><span class=\"line\">#    usage: rman_backup_rac.sh &lt;$BACKUP_LEVEL&gt;                 #</span><br><span class=\"line\">#           BACKUP_LEVEL:                                      #</span><br><span class=\"line\">#              F: full backup                                  #</span><br><span class=\"line\">#              0: level 0                                      #</span><br><span class=\"line\">#              1: level 1                                      #</span><br><span class=\"line\">################################################################</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#!/bin/bash</span><br><span class=\"line\"># User specific environment and startup programs</span><br><span class=\"line\">export ORACLE_HOME=/u01/app/oracle/product/11.2.0/dbhome_1</span><br><span class=\"line\">export RMAN_BAK_LOG_BASE=/home/oracle/DbBackup</span><br><span class=\"line\">export RMAN_BAK_DATA_BASE=+data/NXRAC/backup</span><br><span class=\"line\">export ORACLE_SID=`ps -ef|grep pmon|grep -v ASM|grep -v grep|awk -F&apos;_&apos; &apos;&#123;print $NF&#125;&apos;`</span><br><span class=\"line\">export TIMESTAMP=`date +%Y%m%d%H%M`;</span><br><span class=\"line\"></span><br><span class=\"line\">#the destination of rman backuppiece</span><br><span class=\"line\">export RMAN_DATA=$&#123;RMAN_BAK_DATA_BASE&#125;/rman</span><br><span class=\"line\"></span><br><span class=\"line\">#the destination of rman backup logs</span><br><span class=\"line\">export RMAN_LOG=$&#123;RMAN_BAK_LOG_BASE&#125;/logs</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">if [[ ! -z $1 ]] &amp;&amp; echo $1 |grep -Ew &quot;[01F]&quot; &gt;/dev/null 2&gt;&amp;1</span><br><span class=\"line\">then</span><br><span class=\"line\">                                export RMAN_LEVEL=$&#123;1&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                                # Check rman level</span><br><span class=\"line\">                                if [ &quot;$RMAN_LEVEL&quot; == &quot;F&quot; ];</span><br><span class=\"line\">                                        then  unset INCR_LVL</span><br><span class=\"line\">                                        BACKUP_TYPE=full</span><br><span class=\"line\">                                        else</span><br><span class=\"line\">                                        INCR_LVL=&quot;INCREMENTAL LEVEL $&#123;RMAN_LEVEL&#125;&quot;</span><br><span class=\"line\">                                        BACKUP_TYPE=lev$&#123;RMAN_LEVEL&#125;</span><br><span class=\"line\">                                fi</span><br><span class=\"line\">else</span><br><span class=\"line\">                                echo &quot;$&#123;1&#125; wrong argument!&quot; &gt;$&#123;RMAN_LOG&#125;/wrong_argument_$&#123;TIMESTAMP&#125;.log</span><br><span class=\"line\">                                exit 1</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#the prefix of rman backuppiece                                 </span><br><span class=\"line\">export RMAN_FILE=$&#123;RMAN_DATA&#125;/$&#123;BACKUP_TYPE&#125;_$&#123;TIMESTAMP&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#the logfile of shell script including the rman logs contents</span><br><span class=\"line\">export SSH_LOG=$&#123;RMAN_LOG&#125;/$&#123;BACKUP_TYPE&#125;_$&#123;TIMESTAMP&#125;.log</span><br><span class=\"line\"></span><br><span class=\"line\">#the size of backuppiece</span><br><span class=\"line\">export MAXPIECESIZE=4G</span><br><span class=\"line\"></span><br><span class=\"line\">####################################################################</span><br><span class=\"line\">#                                                                  #</span><br><span class=\"line\">#   the name of rman logs excluding the file expanded-name,        #</span><br><span class=\"line\">#   when the shell is complete,the content of this file will be    #</span><br><span class=\"line\">#   appended to the $SSH_LOG and the rman logfile will be deleted. #</span><br><span class=\"line\">#                                                                  #</span><br><span class=\"line\">####################################################################</span><br><span class=\"line\">export RMAN_LOG_FILE=$&#123;RMAN_LOG&#125;/$&#123;BACKUP_TYPE&#125;_$&#123;TIMESTAMP&#125;_1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#Check RMAN Backup Path</span><br><span class=\"line\"></span><br><span class=\"line\">if ! test -d $&#123;RMAN_LOG&#125;</span><br><span class=\"line\">then</span><br><span class=\"line\">mkdir -p $&#123;RMAN_LOG&#125;</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">echo &quot;---------------------------------&quot; &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class=\"line\">echo &quot;   &quot; &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class=\"line\">echo &quot;Rman Begin  to Working .........&quot; &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class=\"line\">echo &quot;Begin time at:&quot; `date` --`date +%Y%m%d%H%M` &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#Startup rman to backup</span><br><span class=\"line\"></span><br><span class=\"line\">$ORACLE_HOME/bin/rman log=$&#123;RMAN_LOG_FILE&#125;.log &lt;&lt;EOF</span><br><span class=\"line\">connect target /</span><br><span class=\"line\">run &#123;</span><br><span class=\"line\">CONFIGURE RETENTION POLICY TO RECOVERY WINDOW OF 7 DAYS;</span><br><span class=\"line\">CONFIGURE BACKUP OPTIMIZATION ON;</span><br><span class=\"line\">CONFIGURE CONTROLFILE AUTOBACKUP ON;</span><br><span class=\"line\">CONFIGURE DEVICE TYPE DISK PARALLELISM 4 BACKUP TYPE TO BACKUPSET;</span><br><span class=\"line\">CONFIGURE CONTROLFILE AUTOBACKUP FORMAT FOR DEVICE TYPE DISK TO &apos;$&#123;RMAN_DATA&#125;/control_auto_%F&apos;;</span><br><span class=\"line\">ALLOCATE CHANNEL &apos;ch1&apos; TYPE DISK maxpiecesize=$&#123;MAXPIECESIZE&#125; CONNECT &apos;SYS/passwd@node1&apos;;</span><br><span class=\"line\">ALLOCATE CHANNEL &apos;ch2&apos; TYPE DISK maxpiecesize=$&#123;MAXPIECESIZE&#125; CONNECT &apos;SYS/passwd@node1&apos;;</span><br><span class=\"line\">ALLOCATE CHANNEL &apos;ch3&apos; TYPE DISK maxpiecesize=$&#123;MAXPIECESIZE&#125; CONNECT &apos;SYS/passwd@mode2&apos;;</span><br><span class=\"line\">ALLOCATE CHANNEL &apos;ch4&apos; TYPE DISK maxpiecesize=$&#123;MAXPIECESIZE&#125; CONNECT &apos;SYS/passwd@node2&apos;;</span><br><span class=\"line\">CROSSCHECK ARCHIVELOG ALL;</span><br><span class=\"line\">DELETE NOPROMPT OBSOLETE;</span><br><span class=\"line\">DELETE NOPROMPT EXPIRED BACKUP;</span><br><span class=\"line\">BACKUP AS COMPRESSED BACKUPSET</span><br><span class=\"line\">$&#123;INCR_LVL&#125;</span><br><span class=\"line\">DATABASE FORMAT &apos;$&#123;RMAN_FILE&#125;_db_%U&apos; TAG &apos;$&#123;BACKUP_TYPE&#125;_$&#123;TIMESTAMP&#125;&apos;;</span><br><span class=\"line\">SQL &apos;ALTER SYSTEM ARCHIVE LOG CURRENT&apos;;</span><br><span class=\"line\">BACKUP FILESPERSET 20 ARCHIVELOG ALL FORMAT &apos;$&#123;RMAN_FILE&#125;_arc_%U&apos; TAG &apos;$&#123;ORACLE_SID&#125;_arc_$&#123;TIMESTAMP&#125;&apos;</span><br><span class=\"line\">DELETE  INPUT;  </span><br><span class=\"line\">RELEASE CHANNEL ch1;</span><br><span class=\"line\">RELEASE CHANNEL ch2;</span><br><span class=\"line\">RELEASE CHANNEL ch3;</span><br><span class=\"line\">RELEASE CHANNEL ch4;</span><br><span class=\"line\">ALLOCATE CHANNEL ch00 TYPE DISK;</span><br><span class=\"line\">BACKUP</span><br><span class=\"line\">    FORMAT &apos;$&#123;RMAN_DATA&#125;/cntrl_%U&apos;</span><br><span class=\"line\">    CURRENT CONTROLFILE;</span><br><span class=\"line\">RELEASE CHANNEL ch00;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">exit;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">RC=$?</span><br><span class=\"line\"></span><br><span class=\"line\">cat $&#123;RMAN_LOG_FILE&#125;.log &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class=\"line\">echo &quot;Rman Stop working @ time:&quot;`date` `date +%Y%m%d%H%M` &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">if [ $RC -ne &quot;0&quot; ]; then</span><br><span class=\"line\">    echo &quot;------ error ------&quot; &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class=\"line\">else</span><br><span class=\"line\">    echo &quot;------ Success during RMAN backup peroid------&quot; &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class=\"line\">    rm -rf $&#123;RMAN_LOG_FILE&#125;.log</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">exit</span><br></pre></td></tr></table></figure>\n\n<p><strong>DBMS_SCHEDULER:</strong></p>\n<p>Here we are using DBMS_SCHEDULER instead of DBMS_JOB, because DBMS_SCHEDULER is RAC aware.</p>\n<p><strong>Before jump into real DBMS_SCHEDULER configuration, we need to focus on an important thing, That:</strong></p>\n<p>Both RAC nodes local time zone must be identical with DBMS_SCHEDULER default time.</p>\n<p>On all RAC node, Ensure local time zone and set it accordingly.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[oracle@node2 ]$ cat /etc/sysconfig/clock</span><br><span class=\"line\">ZONE=\"Asia/Shanghai\"</span><br></pre></td></tr></table></figure>\n\n<p><strong>configure default time zone for DBMS_SCHEDULER</strong></p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select value from dba_scheduler_global_attribute where attribute_name = 'DEFAULT_TIMEZONE';</span><br><span class=\"line\"></span><br><span class=\"line\">VALUE</span><br><span class=\"line\"><span class=\"comment\">--------------------------------------------------------------------------------</span></span><br><span class=\"line\">PRC</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; exec dbms_scheduler.set_scheduler_attribute ('DEFAULT_TIMEZONE', 'Asia/Shanghai');</span><br><span class=\"line\"></span><br><span class=\"line\">PL/SQL procedure successfully completed.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; select value from dba_scheduler_global_attribute where attribute_name = 'DEFAULT_TIMEZONE';</span><br><span class=\"line\"></span><br><span class=\"line\">VALUE</span><br><span class=\"line\"><span class=\"comment\">--------------------------------------------------------------------------------</span></span><br><span class=\"line\">Asia/Shanghai</span><br></pre></td></tr></table></figure>\n\n<p>Now we need to create credential so that are assigned to DBMS_SCHEDULER jobs so that they can authenticate with a local/remote host operating system or a remote Oracle database.</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; exec dbms_scheduler.create_credential(credential_name =&gt; 'oracle', username =&gt; 'oracle', password =&gt; 'oracle');</span><br><span class=\"line\"></span><br><span class=\"line\">PL/SQL procedure successfully completed.</span><br></pre></td></tr></table></figure>\n\n<p>Now its time to create DBMS_SCHEDULER job for RMAN incremental level 0 backup, Here in this procedure I am going to create <em>RMAN_INC0_BACKUP</em> job with required attributes.</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">begin</span></span><br><span class=\"line\">dbms_scheduler.create_job(</span><br><span class=\"line\">job_name            =&gt; <span class=\"string\">'RMAN_INC0_BACKUP'</span>,</span><br><span class=\"line\">job_type            =&gt; <span class=\"string\">'EXECUTABLE'</span>,</span><br><span class=\"line\">job_action          =&gt; <span class=\"string\">'/bin/sh'</span>,</span><br><span class=\"line\">number_of_arguments =&gt; <span class=\"number\">2</span>,</span><br><span class=\"line\">start_date          =&gt; SYSTIMESTAMP,</span><br><span class=\"line\">credential_name     =&gt; <span class=\"string\">'oracle'</span>,</span><br><span class=\"line\">auto_drop           =&gt; <span class=\"literal\">FALSE</span>,</span><br><span class=\"line\">enabled             =&gt; <span class=\"literal\">FALSE</span>);</span><br><span class=\"line\"><span class=\"keyword\">end</span>;</span><br><span class=\"line\">/</span><br></pre></td></tr></table></figure>\n\n<p>Set argument_position &amp; argument_value ( i.e. Path of the RMAN script ) for the same job:</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">begin</span></span><br><span class=\"line\">dbms_scheduler.set_job_argument_value(</span><br><span class=\"line\">job_name            =&gt; <span class=\"string\">'RMAN_INC0_BACKUP'</span>,</span><br><span class=\"line\">argument_position   =&gt;  <span class=\"number\">1</span>,</span><br><span class=\"line\">argument_value      =&gt; <span class=\"string\">'/home/oracle/rman.sh'</span>);</span><br><span class=\"line\"><span class=\"keyword\">end</span>;</span><br><span class=\"line\">/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">begin</span></span><br><span class=\"line\">dbms_scheduler.set_job_argument_value(</span><br><span class=\"line\">job_name            =&gt; <span class=\"string\">'RMAN_INC0_BACKUP'</span>,</span><br><span class=\"line\">argument_position   =&gt;  <span class=\"number\">2</span>,</span><br><span class=\"line\">argument_value      =&gt; <span class=\"number\">0</span>);</span><br><span class=\"line\"><span class=\"keyword\">end</span>;</span><br><span class=\"line\">/</span><br></pre></td></tr></table></figure>\n\n<p>Set start_date for the same job, In my case <em>RMAN_INC0_BACKUP</em> job will execute every week on sunday @03am, so job start date and its first run timing would  according to my convenience.</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">begin</span></span><br><span class=\"line\">dbms_scheduler.set_attribute(</span><br><span class=\"line\"><span class=\"keyword\">name</span>      =&gt; <span class=\"string\">'RMAN_INC0_BACKUP'</span>,</span><br><span class=\"line\"><span class=\"keyword\">attribute</span> =&gt; <span class=\"string\">'start_date'</span>,</span><br><span class=\"line\"><span class=\"keyword\">value</span>     =&gt; trunc(<span class=\"keyword\">sysdate</span>)+<span class=\"number\">3</span>/<span class=\"number\">24</span>);</span><br><span class=\"line\"><span class=\"keyword\">end</span>;</span><br><span class=\"line\">/</span><br></pre></td></tr></table></figure>\n\n<p>Test your backup job manually in SQL prompt by instantiating <em>RMAN_INC0_BACKUP</em> job.</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; exec dbms_scheduler.run_job('RMAN_INC0_BACKUP');</span><br><span class=\"line\">PL/SQL procedure successfully completed.</span><br></pre></td></tr></table></figure>\n\n<p>Verify running RMAN backup status by issuing following SQL query, It will show you RMAN backup details with start time &amp; end time.</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> SESSION_KEY, INPUT_TYPE, <span class=\"keyword\">STATUS</span>,</span><br><span class=\"line\">to_char(START_TIME,<span class=\"string\">'mm/dd/yy hh24:mi'</span>) start_time,</span><br><span class=\"line\">to_char(END_TIME,<span class=\"string\">'mm/dd/yy hh24:mi'</span>) end_time,</span><br><span class=\"line\">elapsed_seconds/<span class=\"number\">3600</span> hrs</span><br><span class=\"line\"><span class=\"keyword\">from</span> V$RMAN_BACKUP_JOB_DETAILS</span><br><span class=\"line\"><span class=\"keyword\">order</span> <span class=\"keyword\">by</span> session_key;</span><br></pre></td></tr></table></figure>\n\n<p>In case of any error while test run, you can make sure details of error by issuing the following query, OR You can also query to <em>dba_scheduler_job_run_details</em> dictionary view for more details.</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> JOB_NAME,<span class=\"keyword\">STATUS</span>,STATE,<span class=\"keyword\">ERROR</span><span class=\"comment\">#,CREDENTIAL_NAME from dba_scheduler_job_run_details where CREDENTIAL_NAME like 'RMAN%';</span></span><br></pre></td></tr></table></figure>\n\n<p>After successfully completion of test run, Enable &amp; schedule it by following procedure by setting value to <em>repeat_interval</em> parameter, In my case <em>RMAN_INC0_BACKUP</em> job will execute every week on Sunday @03pm.</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">begin</span></span><br><span class=\"line\">dbms_scheduler.set_attribute(</span><br><span class=\"line\"><span class=\"keyword\">name</span>      =&gt; <span class=\"string\">'RMAN_INC0_BACKUP'</span>,</span><br><span class=\"line\"><span class=\"keyword\">attribute</span> =&gt; <span class=\"string\">'repeat_interval'</span>,</span><br><span class=\"line\"><span class=\"keyword\">value</span>     =&gt; <span class=\"string\">'freq=daily;byday=sun;byhour=03'</span>);</span><br><span class=\"line\">dbms_scheduler.enable( 'RMAN_INC0_BACKUP' );</span><br><span class=\"line\"><span class=\"keyword\">end</span>;</span><br><span class=\"line\">/</span><br></pre></td></tr></table></figure>\n\n<p>Ensure dbms_scheduler job details by issuing the following query OR you can also query to <em>dba_scheduler_jobs</em> and <em>dba_scheduler_job_args</em>.</p>\n<figure class=\"highlight\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select job_name,enabled,owner, state from dba_scheduler_jobs where job_name in ('RMAN_INC0_BACKUP');</span><br></pre></td></tr></table></figure>\n\n<p>Keep your eye on behavior of dbms_scheduler job by issuing the following query:</p>\n<figure class=\"highlight\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select job_name,RUN_COUNT,LAST_START_DATE,NEXT_RUN_DATE from dba_scheduler_jobs where job_name in ('RMAN_INC0_BACKUP');</span><br><span class=\"line\">SQL&gt; select *  from dba_scheduler_job_args where job_name like 'RMAN%';</span><br></pre></td></tr></table></figure>\n\n<p>In accordance with the above method to create a level 1 backup job <em>RMAN_INC1_BACKUP</em>，The only difference is the <em>repeat_interval</em>：</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">begin</span></span><br><span class=\"line\">dbms_scheduler.set_attribute(</span><br><span class=\"line\"><span class=\"keyword\">name</span>      =&gt; <span class=\"string\">'RMAN_INC1_BACKUP'</span>,</span><br><span class=\"line\"><span class=\"keyword\">attribute</span> =&gt; <span class=\"string\">'repeat_interval'</span>,</span><br><span class=\"line\"><span class=\"keyword\">value</span>     =&gt; <span class=\"string\">'freq=daily;byday=mon,tue,wed,thu,fri,sat;byhour=03'</span>);</span><br><span class=\"line\">dbms_scheduler.enable( 'RMAN_INC1_BACKUP' );</span><br><span class=\"line\"><span class=\"keyword\">end</span>;</span><br><span class=\"line\">/</span><br></pre></td></tr></table></figure>\n\n<p><strong>Important Note:</strong><br>DBMS_SCHEDULER is smart enough to start backup on the node where the last backup was successfully executed.</p>\n<p><strong>参考：</strong></p>\n<p>https://dbatricksworld.com/how-to-backup-oracle-rac-11gr2-database-with-rman-backup-utility-with-the-help-of-dbms_scheduler-part-i-rman-full-database-backup/</p>\n<p>http://dbatricksworld.com/how-to-backup-oracle-rac-11gr2-database-with-rman-backup-utility-with-the-help-of-dbms_scheduler-part-ii-rman-incremental-database-backup/</p>\n","site":{"data":{"styles":"","footer":"<div class=\"footer-custom\">\nTheme source code <span class=\"exturl theme-link\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvaGV4by10aGVtZS1uZXh0\">here</span><br>\nWebsite source code <span class=\"exturl theme-link\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvdGhlbWUtbmV4dC5vcmc=\">here</span>\n</div>\n"}},"excerpt":"","more":"<h1 id=\"利用DBMS-SCHEDULER在Oracle-11gR2-RAC上执行rman备份\"><a href=\"#利用DBMS-SCHEDULER在Oracle-11gR2-RAC上执行rman备份\" class=\"headerlink\" title=\"利用DBMS_SCHEDULER在Oracle 11gR2 RAC上执行rman备份\"></a>利用DBMS_SCHEDULER在Oracle 11gR2 RAC上执行rman备份</h1><p>RMAN backup in Oracle 11gR2 RAC is exactly same like RMAN backup in Oracle 11gR2 single node.<br>The only difference is: Typically, in case of Oracle single node database, we will schedule RMAN scripts with the help of CRON job and it will run according to our convenience, but in case of Oracle RAC if we schedule RMAN script and if unfortunately that RAC node goes down ( where we configured RMAN scripts ), then RMAN backup won’t run obviously.</p>\n<p>So, Same strategy will not be work in Oracle RAC node. For RMAN consistent backups use dbms_scheduler &amp; we need to place RMAN scripts in shared directory. ( Or in my case, I have created identical scripts on both cluster node’s )</p>\n<p><strong>注意：</strong>  <em>需要将脚本放在共享位置或者每个节点的相同位置</em></p>\n<blockquote>\n<p>看一下rman的备份脚本，此脚本将备份放在ASM中，将日志放在节点本地</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">################################################################</span><br><span class=\"line\">#    rman_backup_rac.sh FOR RAC                                #</span><br><span class=\"line\">#    created by lp                                             #</span><br><span class=\"line\">#    2017/03/22                                                #</span><br><span class=\"line\">#    usage: rman_backup_rac.sh &lt;$BACKUP_LEVEL&gt;                 #</span><br><span class=\"line\">#           BACKUP_LEVEL:                                      #</span><br><span class=\"line\">#              F: full backup                                  #</span><br><span class=\"line\">#              0: level 0                                      #</span><br><span class=\"line\">#              1: level 1                                      #</span><br><span class=\"line\">################################################################</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#!/bin/bash</span><br><span class=\"line\"># User specific environment and startup programs</span><br><span class=\"line\">export ORACLE_HOME=/u01/app/oracle/product/11.2.0/dbhome_1</span><br><span class=\"line\">export RMAN_BAK_LOG_BASE=/home/oracle/DbBackup</span><br><span class=\"line\">export RMAN_BAK_DATA_BASE=+data/NXRAC/backup</span><br><span class=\"line\">export ORACLE_SID=`ps -ef|grep pmon|grep -v ASM|grep -v grep|awk -F&apos;_&apos; &apos;&#123;print $NF&#125;&apos;`</span><br><span class=\"line\">export TIMESTAMP=`date +%Y%m%d%H%M`;</span><br><span class=\"line\"></span><br><span class=\"line\">#the destination of rman backuppiece</span><br><span class=\"line\">export RMAN_DATA=$&#123;RMAN_BAK_DATA_BASE&#125;/rman</span><br><span class=\"line\"></span><br><span class=\"line\">#the destination of rman backup logs</span><br><span class=\"line\">export RMAN_LOG=$&#123;RMAN_BAK_LOG_BASE&#125;/logs</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">if [[ ! -z $1 ]] &amp;&amp; echo $1 |grep -Ew &quot;[01F]&quot; &gt;/dev/null 2&gt;&amp;1</span><br><span class=\"line\">then</span><br><span class=\"line\">                                export RMAN_LEVEL=$&#123;1&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                                # Check rman level</span><br><span class=\"line\">                                if [ &quot;$RMAN_LEVEL&quot; == &quot;F&quot; ];</span><br><span class=\"line\">                                        then  unset INCR_LVL</span><br><span class=\"line\">                                        BACKUP_TYPE=full</span><br><span class=\"line\">                                        else</span><br><span class=\"line\">                                        INCR_LVL=&quot;INCREMENTAL LEVEL $&#123;RMAN_LEVEL&#125;&quot;</span><br><span class=\"line\">                                        BACKUP_TYPE=lev$&#123;RMAN_LEVEL&#125;</span><br><span class=\"line\">                                fi</span><br><span class=\"line\">else</span><br><span class=\"line\">                                echo &quot;$&#123;1&#125; wrong argument!&quot; &gt;$&#123;RMAN_LOG&#125;/wrong_argument_$&#123;TIMESTAMP&#125;.log</span><br><span class=\"line\">                                exit 1</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#the prefix of rman backuppiece                                 </span><br><span class=\"line\">export RMAN_FILE=$&#123;RMAN_DATA&#125;/$&#123;BACKUP_TYPE&#125;_$&#123;TIMESTAMP&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#the logfile of shell script including the rman logs contents</span><br><span class=\"line\">export SSH_LOG=$&#123;RMAN_LOG&#125;/$&#123;BACKUP_TYPE&#125;_$&#123;TIMESTAMP&#125;.log</span><br><span class=\"line\"></span><br><span class=\"line\">#the size of backuppiece</span><br><span class=\"line\">export MAXPIECESIZE=4G</span><br><span class=\"line\"></span><br><span class=\"line\">####################################################################</span><br><span class=\"line\">#                                                                  #</span><br><span class=\"line\">#   the name of rman logs excluding the file expanded-name,        #</span><br><span class=\"line\">#   when the shell is complete,the content of this file will be    #</span><br><span class=\"line\">#   appended to the $SSH_LOG and the rman logfile will be deleted. #</span><br><span class=\"line\">#                                                                  #</span><br><span class=\"line\">####################################################################</span><br><span class=\"line\">export RMAN_LOG_FILE=$&#123;RMAN_LOG&#125;/$&#123;BACKUP_TYPE&#125;_$&#123;TIMESTAMP&#125;_1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#Check RMAN Backup Path</span><br><span class=\"line\"></span><br><span class=\"line\">if ! test -d $&#123;RMAN_LOG&#125;</span><br><span class=\"line\">then</span><br><span class=\"line\">mkdir -p $&#123;RMAN_LOG&#125;</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">echo &quot;---------------------------------&quot; &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class=\"line\">echo &quot;   &quot; &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class=\"line\">echo &quot;Rman Begin  to Working .........&quot; &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class=\"line\">echo &quot;Begin time at:&quot; `date` --`date +%Y%m%d%H%M` &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#Startup rman to backup</span><br><span class=\"line\"></span><br><span class=\"line\">$ORACLE_HOME/bin/rman log=$&#123;RMAN_LOG_FILE&#125;.log &lt;&lt;EOF</span><br><span class=\"line\">connect target /</span><br><span class=\"line\">run &#123;</span><br><span class=\"line\">CONFIGURE RETENTION POLICY TO RECOVERY WINDOW OF 7 DAYS;</span><br><span class=\"line\">CONFIGURE BACKUP OPTIMIZATION ON;</span><br><span class=\"line\">CONFIGURE CONTROLFILE AUTOBACKUP ON;</span><br><span class=\"line\">CONFIGURE DEVICE TYPE DISK PARALLELISM 4 BACKUP TYPE TO BACKUPSET;</span><br><span class=\"line\">CONFIGURE CONTROLFILE AUTOBACKUP FORMAT FOR DEVICE TYPE DISK TO &apos;$&#123;RMAN_DATA&#125;/control_auto_%F&apos;;</span><br><span class=\"line\">ALLOCATE CHANNEL &apos;ch1&apos; TYPE DISK maxpiecesize=$&#123;MAXPIECESIZE&#125; CONNECT &apos;SYS/passwd@node1&apos;;</span><br><span class=\"line\">ALLOCATE CHANNEL &apos;ch2&apos; TYPE DISK maxpiecesize=$&#123;MAXPIECESIZE&#125; CONNECT &apos;SYS/passwd@node1&apos;;</span><br><span class=\"line\">ALLOCATE CHANNEL &apos;ch3&apos; TYPE DISK maxpiecesize=$&#123;MAXPIECESIZE&#125; CONNECT &apos;SYS/passwd@mode2&apos;;</span><br><span class=\"line\">ALLOCATE CHANNEL &apos;ch4&apos; TYPE DISK maxpiecesize=$&#123;MAXPIECESIZE&#125; CONNECT &apos;SYS/passwd@node2&apos;;</span><br><span class=\"line\">CROSSCHECK ARCHIVELOG ALL;</span><br><span class=\"line\">DELETE NOPROMPT OBSOLETE;</span><br><span class=\"line\">DELETE NOPROMPT EXPIRED BACKUP;</span><br><span class=\"line\">BACKUP AS COMPRESSED BACKUPSET</span><br><span class=\"line\">$&#123;INCR_LVL&#125;</span><br><span class=\"line\">DATABASE FORMAT &apos;$&#123;RMAN_FILE&#125;_db_%U&apos; TAG &apos;$&#123;BACKUP_TYPE&#125;_$&#123;TIMESTAMP&#125;&apos;;</span><br><span class=\"line\">SQL &apos;ALTER SYSTEM ARCHIVE LOG CURRENT&apos;;</span><br><span class=\"line\">BACKUP FILESPERSET 20 ARCHIVELOG ALL FORMAT &apos;$&#123;RMAN_FILE&#125;_arc_%U&apos; TAG &apos;$&#123;ORACLE_SID&#125;_arc_$&#123;TIMESTAMP&#125;&apos;</span><br><span class=\"line\">DELETE  INPUT;  </span><br><span class=\"line\">RELEASE CHANNEL ch1;</span><br><span class=\"line\">RELEASE CHANNEL ch2;</span><br><span class=\"line\">RELEASE CHANNEL ch3;</span><br><span class=\"line\">RELEASE CHANNEL ch4;</span><br><span class=\"line\">ALLOCATE CHANNEL ch00 TYPE DISK;</span><br><span class=\"line\">BACKUP</span><br><span class=\"line\">    FORMAT &apos;$&#123;RMAN_DATA&#125;/cntrl_%U&apos;</span><br><span class=\"line\">    CURRENT CONTROLFILE;</span><br><span class=\"line\">RELEASE CHANNEL ch00;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">exit;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">RC=$?</span><br><span class=\"line\"></span><br><span class=\"line\">cat $&#123;RMAN_LOG_FILE&#125;.log &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class=\"line\">echo &quot;Rman Stop working @ time:&quot;`date` `date +%Y%m%d%H%M` &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">if [ $RC -ne &quot;0&quot; ]; then</span><br><span class=\"line\">    echo &quot;------ error ------&quot; &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class=\"line\">else</span><br><span class=\"line\">    echo &quot;------ Success during RMAN backup peroid------&quot; &gt;&gt;$&#123;SSH_LOG&#125;</span><br><span class=\"line\">    rm -rf $&#123;RMAN_LOG_FILE&#125;.log</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">exit</span><br></pre></td></tr></table></figure>\n\n<p><strong>DBMS_SCHEDULER:</strong></p>\n<p>Here we are using DBMS_SCHEDULER instead of DBMS_JOB, because DBMS_SCHEDULER is RAC aware.</p>\n<p><strong>Before jump into real DBMS_SCHEDULER configuration, we need to focus on an important thing, That:</strong></p>\n<p>Both RAC nodes local time zone must be identical with DBMS_SCHEDULER default time.</p>\n<p>On all RAC node, Ensure local time zone and set it accordingly.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[oracle@node2 ]$ cat /etc/sysconfig/clock</span><br><span class=\"line\">ZONE=\"Asia/Shanghai\"</span><br></pre></td></tr></table></figure>\n\n<p><strong>configure default time zone for DBMS_SCHEDULER</strong></p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select value from dba_scheduler_global_attribute where attribute_name = 'DEFAULT_TIMEZONE';</span><br><span class=\"line\"></span><br><span class=\"line\">VALUE</span><br><span class=\"line\"><span class=\"comment\">--------------------------------------------------------------------------------</span></span><br><span class=\"line\">PRC</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; exec dbms_scheduler.set_scheduler_attribute ('DEFAULT_TIMEZONE', 'Asia/Shanghai');</span><br><span class=\"line\"></span><br><span class=\"line\">PL/SQL procedure successfully completed.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; select value from dba_scheduler_global_attribute where attribute_name = 'DEFAULT_TIMEZONE';</span><br><span class=\"line\"></span><br><span class=\"line\">VALUE</span><br><span class=\"line\"><span class=\"comment\">--------------------------------------------------------------------------------</span></span><br><span class=\"line\">Asia/Shanghai</span><br></pre></td></tr></table></figure>\n\n<p>Now we need to create credential so that are assigned to DBMS_SCHEDULER jobs so that they can authenticate with a local/remote host operating system or a remote Oracle database.</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; exec dbms_scheduler.create_credential(credential_name =&gt; 'oracle', username =&gt; 'oracle', password =&gt; 'oracle');</span><br><span class=\"line\"></span><br><span class=\"line\">PL/SQL procedure successfully completed.</span><br></pre></td></tr></table></figure>\n\n<p>Now its time to create DBMS_SCHEDULER job for RMAN incremental level 0 backup, Here in this procedure I am going to create <em>RMAN_INC0_BACKUP</em> job with required attributes.</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">begin</span></span><br><span class=\"line\">dbms_scheduler.create_job(</span><br><span class=\"line\">job_name            =&gt; <span class=\"string\">'RMAN_INC0_BACKUP'</span>,</span><br><span class=\"line\">job_type            =&gt; <span class=\"string\">'EXECUTABLE'</span>,</span><br><span class=\"line\">job_action          =&gt; <span class=\"string\">'/bin/sh'</span>,</span><br><span class=\"line\">number_of_arguments =&gt; <span class=\"number\">2</span>,</span><br><span class=\"line\">start_date          =&gt; SYSTIMESTAMP,</span><br><span class=\"line\">credential_name     =&gt; <span class=\"string\">'oracle'</span>,</span><br><span class=\"line\">auto_drop           =&gt; <span class=\"literal\">FALSE</span>,</span><br><span class=\"line\">enabled             =&gt; <span class=\"literal\">FALSE</span>);</span><br><span class=\"line\"><span class=\"keyword\">end</span>;</span><br><span class=\"line\">/</span><br></pre></td></tr></table></figure>\n\n<p>Set argument_position &amp; argument_value ( i.e. Path of the RMAN script ) for the same job:</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">begin</span></span><br><span class=\"line\">dbms_scheduler.set_job_argument_value(</span><br><span class=\"line\">job_name            =&gt; <span class=\"string\">'RMAN_INC0_BACKUP'</span>,</span><br><span class=\"line\">argument_position   =&gt;  <span class=\"number\">1</span>,</span><br><span class=\"line\">argument_value      =&gt; <span class=\"string\">'/home/oracle/rman.sh'</span>);</span><br><span class=\"line\"><span class=\"keyword\">end</span>;</span><br><span class=\"line\">/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">begin</span></span><br><span class=\"line\">dbms_scheduler.set_job_argument_value(</span><br><span class=\"line\">job_name            =&gt; <span class=\"string\">'RMAN_INC0_BACKUP'</span>,</span><br><span class=\"line\">argument_position   =&gt;  <span class=\"number\">2</span>,</span><br><span class=\"line\">argument_value      =&gt; <span class=\"number\">0</span>);</span><br><span class=\"line\"><span class=\"keyword\">end</span>;</span><br><span class=\"line\">/</span><br></pre></td></tr></table></figure>\n\n<p>Set start_date for the same job, In my case <em>RMAN_INC0_BACKUP</em> job will execute every week on sunday @03am, so job start date and its first run timing would  according to my convenience.</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">begin</span></span><br><span class=\"line\">dbms_scheduler.set_attribute(</span><br><span class=\"line\"><span class=\"keyword\">name</span>      =&gt; <span class=\"string\">'RMAN_INC0_BACKUP'</span>,</span><br><span class=\"line\"><span class=\"keyword\">attribute</span> =&gt; <span class=\"string\">'start_date'</span>,</span><br><span class=\"line\"><span class=\"keyword\">value</span>     =&gt; trunc(<span class=\"keyword\">sysdate</span>)+<span class=\"number\">3</span>/<span class=\"number\">24</span>);</span><br><span class=\"line\"><span class=\"keyword\">end</span>;</span><br><span class=\"line\">/</span><br></pre></td></tr></table></figure>\n\n<p>Test your backup job manually in SQL prompt by instantiating <em>RMAN_INC0_BACKUP</em> job.</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; exec dbms_scheduler.run_job('RMAN_INC0_BACKUP');</span><br><span class=\"line\">PL/SQL procedure successfully completed.</span><br></pre></td></tr></table></figure>\n\n<p>Verify running RMAN backup status by issuing following SQL query, It will show you RMAN backup details with start time &amp; end time.</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> SESSION_KEY, INPUT_TYPE, <span class=\"keyword\">STATUS</span>,</span><br><span class=\"line\">to_char(START_TIME,<span class=\"string\">'mm/dd/yy hh24:mi'</span>) start_time,</span><br><span class=\"line\">to_char(END_TIME,<span class=\"string\">'mm/dd/yy hh24:mi'</span>) end_time,</span><br><span class=\"line\">elapsed_seconds/<span class=\"number\">3600</span> hrs</span><br><span class=\"line\"><span class=\"keyword\">from</span> V$RMAN_BACKUP_JOB_DETAILS</span><br><span class=\"line\"><span class=\"keyword\">order</span> <span class=\"keyword\">by</span> session_key;</span><br></pre></td></tr></table></figure>\n\n<p>In case of any error while test run, you can make sure details of error by issuing the following query, OR You can also query to <em>dba_scheduler_job_run_details</em> dictionary view for more details.</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> JOB_NAME,<span class=\"keyword\">STATUS</span>,STATE,<span class=\"keyword\">ERROR</span><span class=\"comment\">#,CREDENTIAL_NAME from dba_scheduler_job_run_details where CREDENTIAL_NAME like 'RMAN%';</span></span><br></pre></td></tr></table></figure>\n\n<p>After successfully completion of test run, Enable &amp; schedule it by following procedure by setting value to <em>repeat_interval</em> parameter, In my case <em>RMAN_INC0_BACKUP</em> job will execute every week on Sunday @03pm.</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">begin</span></span><br><span class=\"line\">dbms_scheduler.set_attribute(</span><br><span class=\"line\"><span class=\"keyword\">name</span>      =&gt; <span class=\"string\">'RMAN_INC0_BACKUP'</span>,</span><br><span class=\"line\"><span class=\"keyword\">attribute</span> =&gt; <span class=\"string\">'repeat_interval'</span>,</span><br><span class=\"line\"><span class=\"keyword\">value</span>     =&gt; <span class=\"string\">'freq=daily;byday=sun;byhour=03'</span>);</span><br><span class=\"line\">dbms_scheduler.enable( 'RMAN_INC0_BACKUP' );</span><br><span class=\"line\"><span class=\"keyword\">end</span>;</span><br><span class=\"line\">/</span><br></pre></td></tr></table></figure>\n\n<p>Ensure dbms_scheduler job details by issuing the following query OR you can also query to <em>dba_scheduler_jobs</em> and <em>dba_scheduler_job_args</em>.</p>\n<figure class=\"highlight\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select job_name,enabled,owner, state from dba_scheduler_jobs where job_name in ('RMAN_INC0_BACKUP');</span><br></pre></td></tr></table></figure>\n\n<p>Keep your eye on behavior of dbms_scheduler job by issuing the following query:</p>\n<figure class=\"highlight\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select job_name,RUN_COUNT,LAST_START_DATE,NEXT_RUN_DATE from dba_scheduler_jobs where job_name in ('RMAN_INC0_BACKUP');</span><br><span class=\"line\">SQL&gt; select *  from dba_scheduler_job_args where job_name like 'RMAN%';</span><br></pre></td></tr></table></figure>\n\n<p>In accordance with the above method to create a level 1 backup job <em>RMAN_INC1_BACKUP</em>，The only difference is the <em>repeat_interval</em>：</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">begin</span></span><br><span class=\"line\">dbms_scheduler.set_attribute(</span><br><span class=\"line\"><span class=\"keyword\">name</span>      =&gt; <span class=\"string\">'RMAN_INC1_BACKUP'</span>,</span><br><span class=\"line\"><span class=\"keyword\">attribute</span> =&gt; <span class=\"string\">'repeat_interval'</span>,</span><br><span class=\"line\"><span class=\"keyword\">value</span>     =&gt; <span class=\"string\">'freq=daily;byday=mon,tue,wed,thu,fri,sat;byhour=03'</span>);</span><br><span class=\"line\">dbms_scheduler.enable( 'RMAN_INC1_BACKUP' );</span><br><span class=\"line\"><span class=\"keyword\">end</span>;</span><br><span class=\"line\">/</span><br></pre></td></tr></table></figure>\n\n<p><strong>Important Note:</strong><br>DBMS_SCHEDULER is smart enough to start backup on the node where the last backup was successfully executed.</p>\n<p><strong>参考：</strong></p>\n<p>https://dbatricksworld.com/how-to-backup-oracle-rac-11gr2-database-with-rman-backup-utility-with-the-help-of-dbms_scheduler-part-i-rman-full-database-backup/</p>\n<p>http://dbatricksworld.com/how-to-backup-oracle-rac-11gr2-database-with-rman-backup-utility-with-the-help-of-dbms_scheduler-part-ii-rman-incremental-database-backup/</p>\n"},{"date":"2016-07-20T10:48:00.000Z","title":"一次ORA-00600[13011]处理过程","_content":"\n>一次掉电后，DG主库启动alert中报如下错误\n\n```\nErrors in file /home/oracle/app/oracle/diag/rdbms/min/min/trace/min_m002_4099.trc  (incident=16328):\nORA-00600: internal error code, arguments: [13011], [6443], [8463760], [14], [8488694], [0], [], [], [], [], [], []\nIncident details in: /home/oracle/app/oracle/diag/rdbms/min/min/incident/incdir_16328/min_m002_4099_i16328.trc\nUse ADRCI or Support Workbench to package the incident.\nSee Note 411.1 at My Oracle Support for error and packaging details.\nErrors in file /home/oracle/app/oracle/diag/rdbms/min/min/trace/min_m002_4099.trc  (incident=16329):\nORA-00600: internal error code, arguments: [kewrose_1], [600], [ORA-00600: internal error code, arguments: [13011], [6443], [8463760], [14], [8488694], [0], [], [], [], [], [], []\n], [], [], [], [], [], [], [], [], []\nIncident details in: /home/oracle/app/oracle/diag/rdbms/min/min/incident/incdir_16329/min_m002_4099_i16329.trc\n```\n\n>查看trace文件，部分内容如下\n\n```\n\n*** 2016-07-20 18:21:04.185\n*** SESSION ID:(169.43) 2016-07-20 18:21:04.185\n*** CLIENT ID:() 2016-07-20 18:21:04.185\n*** SERVICE NAME:(SYS$BACKGROUND) 2016-07-20 18:21:04.185\n*** MODULE NAME:(MMON_SLAVE) 2016-07-20 18:21:04.185\n*** ACTION NAME:(Auto-Purge Slave Action) 2016-07-20 18:21:04.185\n\nDump continued from file: /home/oracle/app/oracle/diag/rdbms/min/min/trace/min_m000_2615.trc\nORA-00600: internal error code, arguments: [13011], [6665], [8395075], [14], [8462787], [0], [], [], [], [], [], []\n\n========= Dump for incident 14804 (ORA 600 [13011]) ========\n\n*** 2016-07-20 18:21:04.186\ndbkedDefDump(): Starting incident default dumps (flags=0x2, level=3, mask=0x0)\n----- Current SQL Statement for this session (sql_id=c8taax4bfzsjc) -----\ndelete from WRH$_RSRC_PLAN tab where (:beg_snap <= tab.snap_id and         tab.snap_id <= :end_snap and         dbid = :dbid)    and not exists (select 1 from WRM$_BASELINE b                    wh\nere (tab.dbid = b.dbid) and                          (tab.snap_id >= b.start_snap_id) and                          (tab.snap_id <= b.end_snap_id))\n```\n>MOS中关于ORA-600 [13013]描述\n\n```\nFormat: ORA-600 [13013] [a] [b] {c} [d] [e] [f]\nArg [a] Passcount\nArg [b] Data Object number\nArg {c} Tablespace Decimal Relative DBA (RDBA) of block containing the row to be updated\nArg [d] Row Slot number\nArg [e] Decimal RDBA of block being updated (Typically same as {c})\nArg [f] Code\n```\n>确定object\n\n```sql\nSQL> select owner,object_name,object_type  from dba_objects where object_id=6665;\n\nOWNER                          OBJECT_NAME                                                  OBJECT_TYPE\n------------------------------ ------------------------------------------------------------ -------------------\nSYS                            WRH$_RSRC_PLAN                                               TABLE\n```\n可见与trc文件中的sql中对象名吻合，都是**WRH$_RSRC_PLAN**\n查看trc文件中的**PLAN TABLE**\n\n```\n----- Plan Table -----\n\n============\nPlan Table\n============\n-----------------------------------------------------------+-----------------------------------+\n| Id  | Operation                       | Name             | Rows  | Bytes | Cost  | Time      |\n-----------------------------------------------------------+-----------------------------------+\n| 0   | DELETE STATEMENT                |                  |       |       |   626 |           |\n| 1   |  DELETE                         | WRH$_RSRC_PLAN   |       |       |       |           |\n| 2   |   FILTER                        |                  |       |       |       |           |\n| 3   |    INDEX RANGE SCAN             | WRH$_RSRC_PLAN_PK|    94 |  1598 |     8 |  00:00:01 |\n| 4   |     TABLE ACCESS BY INDEX ROWID | WRM$_BASELINE    |     1 |    33 |     2 |  00:00:01 |\n| 5   |      INDEX RANGE SCAN           | WRM$_BASELINE_PK |     1 |       |     1 |  00:00:01 |\n-----------------------------------------------------------+-----------------------------------+\n```\n1.The most common cause of this error is an index corruption. The first step is to check the indexes for corruption, i.e. run\n\n```SQL\nSQL> ANALYZE INDEX WRH$_RSRC_PLAN_PK VALIDATE STRUCTURE;\n\nIndex analyzed.\n```\n\n2.If the indexes do not report corruption, further test for corruption the base tables referenced in the execution plan or the statement producing the error:\n\n```SQL\nSQL> ANALYZE TABLE WRH$_RSRC_PLAN VALIDATE STRUCTURE CASCADE;\nANALYZE TABLE WRH$_RSRC_PLAN VALIDATE STRUCTURE CASCADE\n*\nERROR at line 1:\nORA-01499: table/index cross reference failure - see trace file\n```\n\n查看生成的trace文件内容\n\n```\n*** 2016-07-21 01:31:31.840\n*** SESSION ID:(52.5) 2016-07-21 01:31:31.840\n*** CLIENT ID:() 2016-07-21 01:31:31.840\n*** SERVICE NAME:(SYS$USERS) 2016-07-21 01:31:31.840\n*** MODULE NAME:(sqlplus@primary (TNS V1-V3)) 2016-07-21 01:31:31.840\n*** ACTION NAME:() 2016-07-21 01:31:31.840\n\nTable/Index row count mismatch\ntable 2901 : index 3203, 296\nIndex root = tsn: 1 rdba: 0x0080194a\n```\n\n对于文件内容，简单介绍如下：\n\n```\ntrace文件中包含：\n\n<description>: tsn: <tablespace number> rdba: <relative dba>\n\ndescription有以下值：\n\n\"row not found in index\"\n\"Table/Index row count mismatch\"\n\"row mismatch in index dba\"\n\"Table row count/Bitmap index bit count mismatch\"\n\"kdavls: kdcchk returns %d when checking cluster dba 0x%08lx objn %d\\n\"\n\ntsn:    Tablespace Number表示的是索引存储的表空间编号。\nrdba: 是索引段头相对于数据块的存储地址。\n```\n\n运行以下sql查询索引的文件和块号\n\n```sql\nSELECT dbms_utility.data_block_address_file(\n         to_number(trim(leading '0' from\nreplace('&&rdba','0x','')),'XXXXXXXX')\n       ) AS rfile#,\n       dbms_utility.data_block_address_block(\n         to_number(trim(leading '0' from\nreplace('&&rdba','0x','')),'XXXXXXXX')\n       ) AS block#\nFROM dual;\n```\n\n结果如下：\n\n```sql\nSQL> SELECT dbms_utility.data_block_address_file(\n  2           to_number(trim(leading '0' from\n  3  replace('&&rdba','0x','')),'XXXXXXXX')\n  4         ) AS rfile#,\n  5         dbms_utility.data_block_address_block(\n  6           to_number(trim(leading '0' from\n  7  replace('&&rdba','0x','')),'XXXXXXXX')\n  8         ) AS block#\n  9  FROM dual;\nEnter value for rdba: 0x0080194a\nold   3: replace('&&rdba','0x','')),'XXXXXXXX')\nnew   3: replace('0x0080194a','0x','')),'XXXXXXXX')\nold   7: replace('&&rdba','0x','')),'XXXXXXXX')\nnew   7: replace('0x0080194a','0x','')),'XXXXXXXX')\n\n    RFILE#     BLOCK#\n---------- ----------\n         2       6474\n```\n\n接下来运行如下查询，定位具体的segment\n\n```sql\nselect owner, segment_name, segment_type\nfrom  dba_segments\nwhere header_file = <rfile#>\n  and header_block = <block#>\n```\n\n结果如下：\n\n```sql\nSQL> select owner, segment_name, segment_type\n  2  from  dba_segments\n  3  where header_file = 2\n  4    and header_block = 6474;\nOWNER                          SEGMENT_NAME                                                                      SEGMENT_TYPE\n------------------------------ --------------------------------------------------------------------------------- ------------------\nSYS                            WRH$_RSRC_PLAN_PK                                                                 INDEX\n```\n\n看来仍然是上面分析过的索引，这里是因为表和索引的数据不一致，那么重建索引\n\n```sql\nalter table WRH$_RSRC_PLAN drop constraint WRH$_RSRC_PLAN_PK cascade;\n\nalter table WRH$_RSRC_PLAN\n  add constraint WRH$_RSRC_PLAN_PK primary key (DBID, SNAP_ID, INSTANCE_NUMBER, SEQUENCE#);\n```\n再次分析表，发现错误消失了\n\n```sql\nSQL> ANALYZE TABLE WRH$_RSRC_PLAN VALIDATE STRUCTURE CASCADE;\n\nTable analyzed.\n```\n\n>至此，问题解决\n\n掉电仍是数据库的大敌，而此次并非只在这一张表上有讹误，还有其他一些WRH$表，这些表均属于sysaux表空间，这些表都是awr系列表，写入频繁，掉电容易引起数据的不一致性，但是，正因为是awr数据，并不是特别重要，修复起来也相对容易。  \n\n>记录一下AWR Performance Tables介绍\n\n```\nThe Oracle10g dynamic performance tables constitute the foundation of sophisticated automations such as Automatic Memory Management  (AMM ) as well as intelligent advisory tools such as ADDM and the SQL Tuning   Advisor.\n\nRemember, the AWR is a core feature of the 10g database kernel and automatically collects and stores important run-time performance information for our historical analysis.\n\nThe tables that store this information are prefixed with wrh$ and are very similar in function to the STATSPACK tables.  This could make STATSPACK appear somewhat obsolete, although it is still available in the $ORACLE_HOME/rdbms/admin directory.\n\nUnlike the more cumbersome STATSPACK utility, which requires knowledge of the table structure and creation of complex query scripts, the 10g Enterprise Manager (OEM) automatically displays and interprets this valuable time-series performance data.\n\nThe wrh$ AWR tables store important historical statistical information about the database in the form of periodic snapshots. Each snapshot is a capture of the in–memory x$ fixed view and other control structures at a certain point in time. Each of the AWR table names is prefixed with wrm$ (Metadata tables), wrh$ (History tables), or wri$ (Advisory tables).\n\n 1. The wrm$ tables store metadata information for the Workload Repository.\n\n 2. The wrh$ tables store historical data or snapshots.\n\n 3. The wri$ tables: These 49 tables store data related to advisory functions.\n```\n","source":"_posts/oracle/backup-restore/ORA-00600[13011].md","raw":"---\ndate: 2016-07-20 18:48\ntags: oracle restore\ntitle: 一次ORA-00600[13011]处理过程\ncategories: oracle restore\n---\n\n>一次掉电后，DG主库启动alert中报如下错误\n\n```\nErrors in file /home/oracle/app/oracle/diag/rdbms/min/min/trace/min_m002_4099.trc  (incident=16328):\nORA-00600: internal error code, arguments: [13011], [6443], [8463760], [14], [8488694], [0], [], [], [], [], [], []\nIncident details in: /home/oracle/app/oracle/diag/rdbms/min/min/incident/incdir_16328/min_m002_4099_i16328.trc\nUse ADRCI or Support Workbench to package the incident.\nSee Note 411.1 at My Oracle Support for error and packaging details.\nErrors in file /home/oracle/app/oracle/diag/rdbms/min/min/trace/min_m002_4099.trc  (incident=16329):\nORA-00600: internal error code, arguments: [kewrose_1], [600], [ORA-00600: internal error code, arguments: [13011], [6443], [8463760], [14], [8488694], [0], [], [], [], [], [], []\n], [], [], [], [], [], [], [], [], []\nIncident details in: /home/oracle/app/oracle/diag/rdbms/min/min/incident/incdir_16329/min_m002_4099_i16329.trc\n```\n\n>查看trace文件，部分内容如下\n\n```\n\n*** 2016-07-20 18:21:04.185\n*** SESSION ID:(169.43) 2016-07-20 18:21:04.185\n*** CLIENT ID:() 2016-07-20 18:21:04.185\n*** SERVICE NAME:(SYS$BACKGROUND) 2016-07-20 18:21:04.185\n*** MODULE NAME:(MMON_SLAVE) 2016-07-20 18:21:04.185\n*** ACTION NAME:(Auto-Purge Slave Action) 2016-07-20 18:21:04.185\n\nDump continued from file: /home/oracle/app/oracle/diag/rdbms/min/min/trace/min_m000_2615.trc\nORA-00600: internal error code, arguments: [13011], [6665], [8395075], [14], [8462787], [0], [], [], [], [], [], []\n\n========= Dump for incident 14804 (ORA 600 [13011]) ========\n\n*** 2016-07-20 18:21:04.186\ndbkedDefDump(): Starting incident default dumps (flags=0x2, level=3, mask=0x0)\n----- Current SQL Statement for this session (sql_id=c8taax4bfzsjc) -----\ndelete from WRH$_RSRC_PLAN tab where (:beg_snap <= tab.snap_id and         tab.snap_id <= :end_snap and         dbid = :dbid)    and not exists (select 1 from WRM$_BASELINE b                    wh\nere (tab.dbid = b.dbid) and                          (tab.snap_id >= b.start_snap_id) and                          (tab.snap_id <= b.end_snap_id))\n```\n>MOS中关于ORA-600 [13013]描述\n\n```\nFormat: ORA-600 [13013] [a] [b] {c} [d] [e] [f]\nArg [a] Passcount\nArg [b] Data Object number\nArg {c} Tablespace Decimal Relative DBA (RDBA) of block containing the row to be updated\nArg [d] Row Slot number\nArg [e] Decimal RDBA of block being updated (Typically same as {c})\nArg [f] Code\n```\n>确定object\n\n```sql\nSQL> select owner,object_name,object_type  from dba_objects where object_id=6665;\n\nOWNER                          OBJECT_NAME                                                  OBJECT_TYPE\n------------------------------ ------------------------------------------------------------ -------------------\nSYS                            WRH$_RSRC_PLAN                                               TABLE\n```\n可见与trc文件中的sql中对象名吻合，都是**WRH$_RSRC_PLAN**\n查看trc文件中的**PLAN TABLE**\n\n```\n----- Plan Table -----\n\n============\nPlan Table\n============\n-----------------------------------------------------------+-----------------------------------+\n| Id  | Operation                       | Name             | Rows  | Bytes | Cost  | Time      |\n-----------------------------------------------------------+-----------------------------------+\n| 0   | DELETE STATEMENT                |                  |       |       |   626 |           |\n| 1   |  DELETE                         | WRH$_RSRC_PLAN   |       |       |       |           |\n| 2   |   FILTER                        |                  |       |       |       |           |\n| 3   |    INDEX RANGE SCAN             | WRH$_RSRC_PLAN_PK|    94 |  1598 |     8 |  00:00:01 |\n| 4   |     TABLE ACCESS BY INDEX ROWID | WRM$_BASELINE    |     1 |    33 |     2 |  00:00:01 |\n| 5   |      INDEX RANGE SCAN           | WRM$_BASELINE_PK |     1 |       |     1 |  00:00:01 |\n-----------------------------------------------------------+-----------------------------------+\n```\n1.The most common cause of this error is an index corruption. The first step is to check the indexes for corruption, i.e. run\n\n```SQL\nSQL> ANALYZE INDEX WRH$_RSRC_PLAN_PK VALIDATE STRUCTURE;\n\nIndex analyzed.\n```\n\n2.If the indexes do not report corruption, further test for corruption the base tables referenced in the execution plan or the statement producing the error:\n\n```SQL\nSQL> ANALYZE TABLE WRH$_RSRC_PLAN VALIDATE STRUCTURE CASCADE;\nANALYZE TABLE WRH$_RSRC_PLAN VALIDATE STRUCTURE CASCADE\n*\nERROR at line 1:\nORA-01499: table/index cross reference failure - see trace file\n```\n\n查看生成的trace文件内容\n\n```\n*** 2016-07-21 01:31:31.840\n*** SESSION ID:(52.5) 2016-07-21 01:31:31.840\n*** CLIENT ID:() 2016-07-21 01:31:31.840\n*** SERVICE NAME:(SYS$USERS) 2016-07-21 01:31:31.840\n*** MODULE NAME:(sqlplus@primary (TNS V1-V3)) 2016-07-21 01:31:31.840\n*** ACTION NAME:() 2016-07-21 01:31:31.840\n\nTable/Index row count mismatch\ntable 2901 : index 3203, 296\nIndex root = tsn: 1 rdba: 0x0080194a\n```\n\n对于文件内容，简单介绍如下：\n\n```\ntrace文件中包含：\n\n<description>: tsn: <tablespace number> rdba: <relative dba>\n\ndescription有以下值：\n\n\"row not found in index\"\n\"Table/Index row count mismatch\"\n\"row mismatch in index dba\"\n\"Table row count/Bitmap index bit count mismatch\"\n\"kdavls: kdcchk returns %d when checking cluster dba 0x%08lx objn %d\\n\"\n\ntsn:    Tablespace Number表示的是索引存储的表空间编号。\nrdba: 是索引段头相对于数据块的存储地址。\n```\n\n运行以下sql查询索引的文件和块号\n\n```sql\nSELECT dbms_utility.data_block_address_file(\n         to_number(trim(leading '0' from\nreplace('&&rdba','0x','')),'XXXXXXXX')\n       ) AS rfile#,\n       dbms_utility.data_block_address_block(\n         to_number(trim(leading '0' from\nreplace('&&rdba','0x','')),'XXXXXXXX')\n       ) AS block#\nFROM dual;\n```\n\n结果如下：\n\n```sql\nSQL> SELECT dbms_utility.data_block_address_file(\n  2           to_number(trim(leading '0' from\n  3  replace('&&rdba','0x','')),'XXXXXXXX')\n  4         ) AS rfile#,\n  5         dbms_utility.data_block_address_block(\n  6           to_number(trim(leading '0' from\n  7  replace('&&rdba','0x','')),'XXXXXXXX')\n  8         ) AS block#\n  9  FROM dual;\nEnter value for rdba: 0x0080194a\nold   3: replace('&&rdba','0x','')),'XXXXXXXX')\nnew   3: replace('0x0080194a','0x','')),'XXXXXXXX')\nold   7: replace('&&rdba','0x','')),'XXXXXXXX')\nnew   7: replace('0x0080194a','0x','')),'XXXXXXXX')\n\n    RFILE#     BLOCK#\n---------- ----------\n         2       6474\n```\n\n接下来运行如下查询，定位具体的segment\n\n```sql\nselect owner, segment_name, segment_type\nfrom  dba_segments\nwhere header_file = <rfile#>\n  and header_block = <block#>\n```\n\n结果如下：\n\n```sql\nSQL> select owner, segment_name, segment_type\n  2  from  dba_segments\n  3  where header_file = 2\n  4    and header_block = 6474;\nOWNER                          SEGMENT_NAME                                                                      SEGMENT_TYPE\n------------------------------ --------------------------------------------------------------------------------- ------------------\nSYS                            WRH$_RSRC_PLAN_PK                                                                 INDEX\n```\n\n看来仍然是上面分析过的索引，这里是因为表和索引的数据不一致，那么重建索引\n\n```sql\nalter table WRH$_RSRC_PLAN drop constraint WRH$_RSRC_PLAN_PK cascade;\n\nalter table WRH$_RSRC_PLAN\n  add constraint WRH$_RSRC_PLAN_PK primary key (DBID, SNAP_ID, INSTANCE_NUMBER, SEQUENCE#);\n```\n再次分析表，发现错误消失了\n\n```sql\nSQL> ANALYZE TABLE WRH$_RSRC_PLAN VALIDATE STRUCTURE CASCADE;\n\nTable analyzed.\n```\n\n>至此，问题解决\n\n掉电仍是数据库的大敌，而此次并非只在这一张表上有讹误，还有其他一些WRH$表，这些表均属于sysaux表空间，这些表都是awr系列表，写入频繁，掉电容易引起数据的不一致性，但是，正因为是awr数据，并不是特别重要，修复起来也相对容易。  \n\n>记录一下AWR Performance Tables介绍\n\n```\nThe Oracle10g dynamic performance tables constitute the foundation of sophisticated automations such as Automatic Memory Management  (AMM ) as well as intelligent advisory tools such as ADDM and the SQL Tuning   Advisor.\n\nRemember, the AWR is a core feature of the 10g database kernel and automatically collects and stores important run-time performance information for our historical analysis.\n\nThe tables that store this information are prefixed with wrh$ and are very similar in function to the STATSPACK tables.  This could make STATSPACK appear somewhat obsolete, although it is still available in the $ORACLE_HOME/rdbms/admin directory.\n\nUnlike the more cumbersome STATSPACK utility, which requires knowledge of the table structure and creation of complex query scripts, the 10g Enterprise Manager (OEM) automatically displays and interprets this valuable time-series performance data.\n\nThe wrh$ AWR tables store important historical statistical information about the database in the form of periodic snapshots. Each snapshot is a capture of the in–memory x$ fixed view and other control structures at a certain point in time. Each of the AWR table names is prefixed with wrm$ (Metadata tables), wrh$ (History tables), or wri$ (Advisory tables).\n\n 1. The wrm$ tables store metadata information for the Workload Repository.\n\n 2. The wrh$ tables store historical data or snapshots.\n\n 3. The wri$ tables: These 49 tables store data related to advisory functions.\n```\n","slug":"oracle/backup-restore/ORA-00600[13011]","published":1,"updated":"2019-07-21T04:52:02.799Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjychiv180000ix0e5c5ef3y4","content":"<blockquote>\n<p>一次掉电后，DG主库启动alert中报如下错误</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Errors in file /home/oracle/app/oracle/diag/rdbms/min/min/trace/min_m002_4099.trc  (incident=16328):</span><br><span class=\"line\">ORA-00600: internal error code, arguments: [13011], [6443], [8463760], [14], [8488694], [0], [], [], [], [], [], []</span><br><span class=\"line\">Incident details in: /home/oracle/app/oracle/diag/rdbms/min/min/incident/incdir_16328/min_m002_4099_i16328.trc</span><br><span class=\"line\">Use ADRCI or Support Workbench to package the incident.</span><br><span class=\"line\">See Note 411.1 at My Oracle Support for error and packaging details.</span><br><span class=\"line\">Errors in file /home/oracle/app/oracle/diag/rdbms/min/min/trace/min_m002_4099.trc  (incident=16329):</span><br><span class=\"line\">ORA-00600: internal error code, arguments: [kewrose_1], [600], [ORA-00600: internal error code, arguments: [13011], [6443], [8463760], [14], [8488694], [0], [], [], [], [], [], []</span><br><span class=\"line\">], [], [], [], [], [], [], [], [], []</span><br><span class=\"line\">Incident details in: /home/oracle/app/oracle/diag/rdbms/min/min/incident/incdir_16329/min_m002_4099_i16329.trc</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>查看trace文件，部分内容如下</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">*** 2016-07-20 18:21:04.185</span><br><span class=\"line\">*** SESSION ID:(169.43) 2016-07-20 18:21:04.185</span><br><span class=\"line\">*** CLIENT ID:() 2016-07-20 18:21:04.185</span><br><span class=\"line\">*** SERVICE NAME:(SYS$BACKGROUND) 2016-07-20 18:21:04.185</span><br><span class=\"line\">*** MODULE NAME:(MMON_SLAVE) 2016-07-20 18:21:04.185</span><br><span class=\"line\">*** ACTION NAME:(Auto-Purge Slave Action) 2016-07-20 18:21:04.185</span><br><span class=\"line\"></span><br><span class=\"line\">Dump continued from file: /home/oracle/app/oracle/diag/rdbms/min/min/trace/min_m000_2615.trc</span><br><span class=\"line\">ORA-00600: internal error code, arguments: [13011], [6665], [8395075], [14], [8462787], [0], [], [], [], [], [], []</span><br><span class=\"line\"></span><br><span class=\"line\">========= Dump for incident 14804 (ORA 600 [13011]) ========</span><br><span class=\"line\"></span><br><span class=\"line\">*** 2016-07-20 18:21:04.186</span><br><span class=\"line\">dbkedDefDump(): Starting incident default dumps (flags=0x2, level=3, mask=0x0)</span><br><span class=\"line\">----- Current SQL Statement for this session (sql_id=c8taax4bfzsjc) -----</span><br><span class=\"line\">delete from WRH$_RSRC_PLAN tab where (:beg_snap &lt;= tab.snap_id and         tab.snap_id &lt;= :end_snap and         dbid = :dbid)    and not exists (select 1 from WRM$_BASELINE b                    wh</span><br><span class=\"line\">ere (tab.dbid = b.dbid) and                          (tab.snap_id &gt;= b.start_snap_id) and                          (tab.snap_id &lt;= b.end_snap_id))</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>MOS中关于ORA-600 [13013]描述</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Format: ORA-600 [13013] [a] [b] &#123;c&#125; [d] [e] [f]</span><br><span class=\"line\">Arg [a] Passcount</span><br><span class=\"line\">Arg [b] Data Object number</span><br><span class=\"line\">Arg &#123;c&#125; Tablespace Decimal Relative DBA (RDBA) of block containing the row to be updated</span><br><span class=\"line\">Arg [d] Row Slot number</span><br><span class=\"line\">Arg [e] Decimal RDBA of block being updated (Typically same as &#123;c&#125;)</span><br><span class=\"line\">Arg [f] Code</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>确定object</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select owner,object_name,object_type  from dba_objects where object_id=6665;</span><br><span class=\"line\"></span><br><span class=\"line\">OWNER                          OBJECT_NAME                                                  OBJECT_TYPE</span><br><span class=\"line\"><span class=\"comment\">------------------------------ ------------------------------------------------------------ -------------------</span></span><br><span class=\"line\">SYS                            WRH$_RSRC_PLAN                                               TABLE</span><br></pre></td></tr></table></figure>\n\n<p>可见与trc文件中的sql中对象名吻合，都是<strong>WRH$_RSRC_PLAN</strong><br>查看trc文件中的<strong>PLAN TABLE</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">----- Plan Table -----</span><br><span class=\"line\"></span><br><span class=\"line\">============</span><br><span class=\"line\">Plan Table</span><br><span class=\"line\">============</span><br><span class=\"line\">-----------------------------------------------------------+-----------------------------------+</span><br><span class=\"line\">| Id  | Operation                       | Name             | Rows  | Bytes | Cost  | Time      |</span><br><span class=\"line\">-----------------------------------------------------------+-----------------------------------+</span><br><span class=\"line\">| 0   | DELETE STATEMENT                |                  |       |       |   626 |           |</span><br><span class=\"line\">| 1   |  DELETE                         | WRH$_RSRC_PLAN   |       |       |       |           |</span><br><span class=\"line\">| 2   |   FILTER                        |                  |       |       |       |           |</span><br><span class=\"line\">| 3   |    INDEX RANGE SCAN             | WRH$_RSRC_PLAN_PK|    94 |  1598 |     8 |  00:00:01 |</span><br><span class=\"line\">| 4   |     TABLE ACCESS BY INDEX ROWID | WRM$_BASELINE    |     1 |    33 |     2 |  00:00:01 |</span><br><span class=\"line\">| 5   |      INDEX RANGE SCAN           | WRM$_BASELINE_PK |     1 |       |     1 |  00:00:01 |</span><br><span class=\"line\">-----------------------------------------------------------+-----------------------------------+</span><br></pre></td></tr></table></figure>\n\n<p>1.The most common cause of this error is an index corruption. The first step is to check the indexes for corruption, i.e. run</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; ANALYZE INDEX WRH$_RSRC_PLAN_PK VALIDATE STRUCTURE;</span><br><span class=\"line\"></span><br><span class=\"line\">Index analyzed.</span><br></pre></td></tr></table></figure>\n\n<p>2.If the indexes do not report corruption, further test for corruption the base tables referenced in the execution plan or the statement producing the error:</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; ANALYZE TABLE WRH$_RSRC_PLAN VALIDATE STRUCTURE CASCADE;</span><br><span class=\"line\"><span class=\"keyword\">ANALYZE</span> <span class=\"keyword\">TABLE</span> WRH$_RSRC_PLAN <span class=\"keyword\">VALIDATE</span> STRUCTURE <span class=\"keyword\">CASCADE</span></span><br><span class=\"line\">*</span><br><span class=\"line\"><span class=\"keyword\">ERROR</span> <span class=\"keyword\">at</span> line <span class=\"number\">1</span>:</span><br><span class=\"line\">ORA<span class=\"number\">-01499</span>: <span class=\"keyword\">table</span>/<span class=\"keyword\">index</span> <span class=\"keyword\">cross</span> <span class=\"keyword\">reference</span> <span class=\"keyword\">failure</span> - see <span class=\"keyword\">trace</span> <span class=\"keyword\">file</span></span><br></pre></td></tr></table></figure>\n\n<p>查看生成的trace文件内容</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">*** 2016-07-21 01:31:31.840</span><br><span class=\"line\">*** SESSION ID:(52.5) 2016-07-21 01:31:31.840</span><br><span class=\"line\">*** CLIENT ID:() 2016-07-21 01:31:31.840</span><br><span class=\"line\">*** SERVICE NAME:(SYS$USERS) 2016-07-21 01:31:31.840</span><br><span class=\"line\">*** MODULE NAME:(sqlplus@primary (TNS V1-V3)) 2016-07-21 01:31:31.840</span><br><span class=\"line\">*** ACTION NAME:() 2016-07-21 01:31:31.840</span><br><span class=\"line\"></span><br><span class=\"line\">Table/Index row count mismatch</span><br><span class=\"line\">table 2901 : index 3203, 296</span><br><span class=\"line\">Index root = tsn: 1 rdba: 0x0080194a</span><br></pre></td></tr></table></figure>\n\n<p>对于文件内容，简单介绍如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">trace文件中包含：</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;description&gt;: tsn: &lt;tablespace number&gt; rdba: &lt;relative dba&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">description有以下值：</span><br><span class=\"line\"></span><br><span class=\"line\">&quot;row not found in index&quot;</span><br><span class=\"line\">&quot;Table/Index row count mismatch&quot;</span><br><span class=\"line\">&quot;row mismatch in index dba&quot;</span><br><span class=\"line\">&quot;Table row count/Bitmap index bit count mismatch&quot;</span><br><span class=\"line\">&quot;kdavls: kdcchk returns %d when checking cluster dba 0x%08lx objn %d\\n&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">tsn:    Tablespace Number表示的是索引存储的表空间编号。</span><br><span class=\"line\">rdba: 是索引段头相对于数据块的存储地址。</span><br></pre></td></tr></table></figure>\n\n<p>运行以下sql查询索引的文件和块号</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> dbms_utility.data_block_address_file(</span><br><span class=\"line\">         to_number(<span class=\"keyword\">trim</span>(<span class=\"keyword\">leading</span> <span class=\"string\">'0'</span> <span class=\"keyword\">from</span></span><br><span class=\"line\"><span class=\"keyword\">replace</span>(<span class=\"string\">'&amp;&amp;rdba'</span>,<span class=\"string\">'0x'</span>,<span class=\"string\">''</span>)),<span class=\"string\">'XXXXXXXX'</span>)</span><br><span class=\"line\">       ) <span class=\"keyword\">AS</span> rfile<span class=\"comment\">#,</span></span><br><span class=\"line\">       dbms_utility.data_block_address_block(</span><br><span class=\"line\">         to_number(<span class=\"keyword\">trim</span>(<span class=\"keyword\">leading</span> <span class=\"string\">'0'</span> <span class=\"keyword\">from</span></span><br><span class=\"line\"><span class=\"keyword\">replace</span>(<span class=\"string\">'&amp;&amp;rdba'</span>,<span class=\"string\">'0x'</span>,<span class=\"string\">''</span>)),<span class=\"string\">'XXXXXXXX'</span>)</span><br><span class=\"line\">       ) <span class=\"keyword\">AS</span> <span class=\"keyword\">block</span><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> dual;</span><br></pre></td></tr></table></figure>\n\n<p>结果如下：</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; SELECT dbms_utility.data_block_address_file(</span><br><span class=\"line\">  2           to_number(trim(leading '0' from</span><br><span class=\"line\">  3  <span class=\"keyword\">replace</span>(<span class=\"string\">'&amp;&amp;rdba'</span>,<span class=\"string\">'0x'</span>,<span class=\"string\">''</span>)),<span class=\"string\">'XXXXXXXX'</span>)</span><br><span class=\"line\">  <span class=\"number\">4</span>         ) <span class=\"keyword\">AS</span> rfile<span class=\"comment\">#,</span></span><br><span class=\"line\">  <span class=\"number\">5</span>         dbms_utility.data_block_address_block(</span><br><span class=\"line\">  <span class=\"number\">6</span>           to_number(<span class=\"keyword\">trim</span>(<span class=\"keyword\">leading</span> <span class=\"string\">'0'</span> <span class=\"keyword\">from</span></span><br><span class=\"line\">  <span class=\"number\">7</span>  <span class=\"keyword\">replace</span>(<span class=\"string\">'&amp;&amp;rdba'</span>,<span class=\"string\">'0x'</span>,<span class=\"string\">''</span>)),<span class=\"string\">'XXXXXXXX'</span>)</span><br><span class=\"line\">  <span class=\"number\">8</span>         ) <span class=\"keyword\">AS</span> <span class=\"keyword\">block</span><span class=\"comment\">#</span></span><br><span class=\"line\">  <span class=\"number\">9</span>  <span class=\"keyword\">FROM</span> dual;</span><br><span class=\"line\">Enter value for rdba: 0x0080194a</span><br><span class=\"line\">old   3: <span class=\"keyword\">replace</span>(<span class=\"string\">'&amp;&amp;rdba'</span>,<span class=\"string\">'0x'</span>,<span class=\"string\">''</span>)),<span class=\"string\">'XXXXXXXX'</span>)</span><br><span class=\"line\"><span class=\"keyword\">new</span>   <span class=\"number\">3</span>: <span class=\"keyword\">replace</span>(<span class=\"string\">'0x0080194a'</span>,<span class=\"string\">'0x'</span>,<span class=\"string\">''</span>)),<span class=\"string\">'XXXXXXXX'</span>)</span><br><span class=\"line\"><span class=\"keyword\">old</span>   <span class=\"number\">7</span>: <span class=\"keyword\">replace</span>(<span class=\"string\">'&amp;&amp;rdba'</span>,<span class=\"string\">'0x'</span>,<span class=\"string\">''</span>)),<span class=\"string\">'XXXXXXXX'</span>)</span><br><span class=\"line\"><span class=\"keyword\">new</span>   <span class=\"number\">7</span>: <span class=\"keyword\">replace</span>(<span class=\"string\">'0x0080194a'</span>,<span class=\"string\">'0x'</span>,<span class=\"string\">''</span>)),<span class=\"string\">'XXXXXXXX'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    RFILE<span class=\"comment\">#     BLOCK#</span></span><br><span class=\"line\"><span class=\"comment\">---------- ----------</span></span><br><span class=\"line\">         <span class=\"number\">2</span>       <span class=\"number\">6474</span></span><br></pre></td></tr></table></figure>\n\n<p>接下来运行如下查询，定位具体的segment</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> owner, segment_name, segment_type</span><br><span class=\"line\"><span class=\"keyword\">from</span>  dba_segments</span><br><span class=\"line\"><span class=\"keyword\">where</span> header_file = &lt;rfile<span class=\"comment\">#&gt;</span></span><br><span class=\"line\">  <span class=\"keyword\">and</span> header_block = &lt;<span class=\"keyword\">block</span><span class=\"comment\">#&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>结果如下：</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select owner, segment_name, segment_type</span><br><span class=\"line\">  2  from  dba_segments</span><br><span class=\"line\">  3  where header_file = 2</span><br><span class=\"line\">  4    and header_block = 6474;</span><br><span class=\"line\">OWNER                          SEGMENT_NAME                                                                      SEGMENT_TYPE</span><br><span class=\"line\"><span class=\"comment\">------------------------------ --------------------------------------------------------------------------------- ------------------</span></span><br><span class=\"line\">SYS                            WRH$_RSRC_PLAN_PK                                                                 INDEX</span><br></pre></td></tr></table></figure>\n\n<p>看来仍然是上面分析过的索引，这里是因为表和索引的数据不一致，那么重建索引</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">alter</span> <span class=\"keyword\">table</span> WRH$_RSRC_PLAN <span class=\"keyword\">drop</span> <span class=\"keyword\">constraint</span> WRH$_RSRC_PLAN_PK <span class=\"keyword\">cascade</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">alter</span> <span class=\"keyword\">table</span> WRH$_RSRC_PLAN</span><br><span class=\"line\">  <span class=\"keyword\">add</span> <span class=\"keyword\">constraint</span> WRH$_RSRC_PLAN_PK primary <span class=\"keyword\">key</span> (DBID, SNAP_ID, INSTANCE_NUMBER, <span class=\"keyword\">SEQUENCE</span><span class=\"comment\">#);</span></span><br></pre></td></tr></table></figure>\n\n<p>再次分析表，发现错误消失了</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; ANALYZE TABLE WRH$_RSRC_PLAN VALIDATE STRUCTURE CASCADE;</span><br><span class=\"line\"></span><br><span class=\"line\">Table analyzed.</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>至此，问题解决</p>\n</blockquote>\n<p>掉电仍是数据库的大敌，而此次并非只在这一张表上有讹误，还有其他一些WRH$表，这些表均属于sysaux表空间，这些表都是awr系列表，写入频繁，掉电容易引起数据的不一致性，但是，正因为是awr数据，并不是特别重要，修复起来也相对容易。  </p>\n<blockquote>\n<p>记录一下AWR Performance Tables介绍</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">The Oracle10g dynamic performance tables constitute the foundation of sophisticated automations such as Automatic Memory Management  (AMM ) as well as intelligent advisory tools such as ADDM and the SQL Tuning   Advisor.</span><br><span class=\"line\"></span><br><span class=\"line\">Remember, the AWR is a core feature of the 10g database kernel and automatically collects and stores important run-time performance information for our historical analysis.</span><br><span class=\"line\"></span><br><span class=\"line\">The tables that store this information are prefixed with wrh$ and are very similar in function to the STATSPACK tables.  This could make STATSPACK appear somewhat obsolete, although it is still available in the $ORACLE_HOME/rdbms/admin directory.</span><br><span class=\"line\"></span><br><span class=\"line\">Unlike the more cumbersome STATSPACK utility, which requires knowledge of the table structure and creation of complex query scripts, the 10g Enterprise Manager (OEM) automatically displays and interprets this valuable time-series performance data.</span><br><span class=\"line\"></span><br><span class=\"line\">The wrh$ AWR tables store important historical statistical information about the database in the form of periodic snapshots. Each snapshot is a capture of the in–memory x$ fixed view and other control structures at a certain point in time. Each of the AWR table names is prefixed with wrm$ (Metadata tables), wrh$ (History tables), or wri$ (Advisory tables).</span><br><span class=\"line\"></span><br><span class=\"line\"> 1. The wrm$ tables store metadata information for the Workload Repository.</span><br><span class=\"line\"></span><br><span class=\"line\"> 2. The wrh$ tables store historical data or snapshots.</span><br><span class=\"line\"></span><br><span class=\"line\"> 3. The wri$ tables: These 49 tables store data related to advisory functions.</span><br></pre></td></tr></table></figure>\n\n","site":{"data":{"styles":"","footer":"<div class=\"footer-custom\">\nTheme source code <span class=\"exturl theme-link\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvaGV4by10aGVtZS1uZXh0\">here</span><br>\nWebsite source code <span class=\"exturl theme-link\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvdGhlbWUtbmV4dC5vcmc=\">here</span>\n</div>\n"}},"excerpt":"","more":"<blockquote>\n<p>一次掉电后，DG主库启动alert中报如下错误</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Errors in file /home/oracle/app/oracle/diag/rdbms/min/min/trace/min_m002_4099.trc  (incident=16328):</span><br><span class=\"line\">ORA-00600: internal error code, arguments: [13011], [6443], [8463760], [14], [8488694], [0], [], [], [], [], [], []</span><br><span class=\"line\">Incident details in: /home/oracle/app/oracle/diag/rdbms/min/min/incident/incdir_16328/min_m002_4099_i16328.trc</span><br><span class=\"line\">Use ADRCI or Support Workbench to package the incident.</span><br><span class=\"line\">See Note 411.1 at My Oracle Support for error and packaging details.</span><br><span class=\"line\">Errors in file /home/oracle/app/oracle/diag/rdbms/min/min/trace/min_m002_4099.trc  (incident=16329):</span><br><span class=\"line\">ORA-00600: internal error code, arguments: [kewrose_1], [600], [ORA-00600: internal error code, arguments: [13011], [6443], [8463760], [14], [8488694], [0], [], [], [], [], [], []</span><br><span class=\"line\">], [], [], [], [], [], [], [], [], []</span><br><span class=\"line\">Incident details in: /home/oracle/app/oracle/diag/rdbms/min/min/incident/incdir_16329/min_m002_4099_i16329.trc</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>查看trace文件，部分内容如下</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">*** 2016-07-20 18:21:04.185</span><br><span class=\"line\">*** SESSION ID:(169.43) 2016-07-20 18:21:04.185</span><br><span class=\"line\">*** CLIENT ID:() 2016-07-20 18:21:04.185</span><br><span class=\"line\">*** SERVICE NAME:(SYS$BACKGROUND) 2016-07-20 18:21:04.185</span><br><span class=\"line\">*** MODULE NAME:(MMON_SLAVE) 2016-07-20 18:21:04.185</span><br><span class=\"line\">*** ACTION NAME:(Auto-Purge Slave Action) 2016-07-20 18:21:04.185</span><br><span class=\"line\"></span><br><span class=\"line\">Dump continued from file: /home/oracle/app/oracle/diag/rdbms/min/min/trace/min_m000_2615.trc</span><br><span class=\"line\">ORA-00600: internal error code, arguments: [13011], [6665], [8395075], [14], [8462787], [0], [], [], [], [], [], []</span><br><span class=\"line\"></span><br><span class=\"line\">========= Dump for incident 14804 (ORA 600 [13011]) ========</span><br><span class=\"line\"></span><br><span class=\"line\">*** 2016-07-20 18:21:04.186</span><br><span class=\"line\">dbkedDefDump(): Starting incident default dumps (flags=0x2, level=3, mask=0x0)</span><br><span class=\"line\">----- Current SQL Statement for this session (sql_id=c8taax4bfzsjc) -----</span><br><span class=\"line\">delete from WRH$_RSRC_PLAN tab where (:beg_snap &lt;= tab.snap_id and         tab.snap_id &lt;= :end_snap and         dbid = :dbid)    and not exists (select 1 from WRM$_BASELINE b                    wh</span><br><span class=\"line\">ere (tab.dbid = b.dbid) and                          (tab.snap_id &gt;= b.start_snap_id) and                          (tab.snap_id &lt;= b.end_snap_id))</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>MOS中关于ORA-600 [13013]描述</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Format: ORA-600 [13013] [a] [b] &#123;c&#125; [d] [e] [f]</span><br><span class=\"line\">Arg [a] Passcount</span><br><span class=\"line\">Arg [b] Data Object number</span><br><span class=\"line\">Arg &#123;c&#125; Tablespace Decimal Relative DBA (RDBA) of block containing the row to be updated</span><br><span class=\"line\">Arg [d] Row Slot number</span><br><span class=\"line\">Arg [e] Decimal RDBA of block being updated (Typically same as &#123;c&#125;)</span><br><span class=\"line\">Arg [f] Code</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>确定object</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select owner,object_name,object_type  from dba_objects where object_id=6665;</span><br><span class=\"line\"></span><br><span class=\"line\">OWNER                          OBJECT_NAME                                                  OBJECT_TYPE</span><br><span class=\"line\"><span class=\"comment\">------------------------------ ------------------------------------------------------------ -------------------</span></span><br><span class=\"line\">SYS                            WRH$_RSRC_PLAN                                               TABLE</span><br></pre></td></tr></table></figure>\n\n<p>可见与trc文件中的sql中对象名吻合，都是<strong>WRH$_RSRC_PLAN</strong><br>查看trc文件中的<strong>PLAN TABLE</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">----- Plan Table -----</span><br><span class=\"line\"></span><br><span class=\"line\">============</span><br><span class=\"line\">Plan Table</span><br><span class=\"line\">============</span><br><span class=\"line\">-----------------------------------------------------------+-----------------------------------+</span><br><span class=\"line\">| Id  | Operation                       | Name             | Rows  | Bytes | Cost  | Time      |</span><br><span class=\"line\">-----------------------------------------------------------+-----------------------------------+</span><br><span class=\"line\">| 0   | DELETE STATEMENT                |                  |       |       |   626 |           |</span><br><span class=\"line\">| 1   |  DELETE                         | WRH$_RSRC_PLAN   |       |       |       |           |</span><br><span class=\"line\">| 2   |   FILTER                        |                  |       |       |       |           |</span><br><span class=\"line\">| 3   |    INDEX RANGE SCAN             | WRH$_RSRC_PLAN_PK|    94 |  1598 |     8 |  00:00:01 |</span><br><span class=\"line\">| 4   |     TABLE ACCESS BY INDEX ROWID | WRM$_BASELINE    |     1 |    33 |     2 |  00:00:01 |</span><br><span class=\"line\">| 5   |      INDEX RANGE SCAN           | WRM$_BASELINE_PK |     1 |       |     1 |  00:00:01 |</span><br><span class=\"line\">-----------------------------------------------------------+-----------------------------------+</span><br></pre></td></tr></table></figure>\n\n<p>1.The most common cause of this error is an index corruption. The first step is to check the indexes for corruption, i.e. run</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; ANALYZE INDEX WRH$_RSRC_PLAN_PK VALIDATE STRUCTURE;</span><br><span class=\"line\"></span><br><span class=\"line\">Index analyzed.</span><br></pre></td></tr></table></figure>\n\n<p>2.If the indexes do not report corruption, further test for corruption the base tables referenced in the execution plan or the statement producing the error:</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; ANALYZE TABLE WRH$_RSRC_PLAN VALIDATE STRUCTURE CASCADE;</span><br><span class=\"line\"><span class=\"keyword\">ANALYZE</span> <span class=\"keyword\">TABLE</span> WRH$_RSRC_PLAN <span class=\"keyword\">VALIDATE</span> STRUCTURE <span class=\"keyword\">CASCADE</span></span><br><span class=\"line\">*</span><br><span class=\"line\"><span class=\"keyword\">ERROR</span> <span class=\"keyword\">at</span> line <span class=\"number\">1</span>:</span><br><span class=\"line\">ORA<span class=\"number\">-01499</span>: <span class=\"keyword\">table</span>/<span class=\"keyword\">index</span> <span class=\"keyword\">cross</span> <span class=\"keyword\">reference</span> <span class=\"keyword\">failure</span> - see <span class=\"keyword\">trace</span> <span class=\"keyword\">file</span></span><br></pre></td></tr></table></figure>\n\n<p>查看生成的trace文件内容</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">*** 2016-07-21 01:31:31.840</span><br><span class=\"line\">*** SESSION ID:(52.5) 2016-07-21 01:31:31.840</span><br><span class=\"line\">*** CLIENT ID:() 2016-07-21 01:31:31.840</span><br><span class=\"line\">*** SERVICE NAME:(SYS$USERS) 2016-07-21 01:31:31.840</span><br><span class=\"line\">*** MODULE NAME:(sqlplus@primary (TNS V1-V3)) 2016-07-21 01:31:31.840</span><br><span class=\"line\">*** ACTION NAME:() 2016-07-21 01:31:31.840</span><br><span class=\"line\"></span><br><span class=\"line\">Table/Index row count mismatch</span><br><span class=\"line\">table 2901 : index 3203, 296</span><br><span class=\"line\">Index root = tsn: 1 rdba: 0x0080194a</span><br></pre></td></tr></table></figure>\n\n<p>对于文件内容，简单介绍如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">trace文件中包含：</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;description&gt;: tsn: &lt;tablespace number&gt; rdba: &lt;relative dba&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">description有以下值：</span><br><span class=\"line\"></span><br><span class=\"line\">&quot;row not found in index&quot;</span><br><span class=\"line\">&quot;Table/Index row count mismatch&quot;</span><br><span class=\"line\">&quot;row mismatch in index dba&quot;</span><br><span class=\"line\">&quot;Table row count/Bitmap index bit count mismatch&quot;</span><br><span class=\"line\">&quot;kdavls: kdcchk returns %d when checking cluster dba 0x%08lx objn %d\\n&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">tsn:    Tablespace Number表示的是索引存储的表空间编号。</span><br><span class=\"line\">rdba: 是索引段头相对于数据块的存储地址。</span><br></pre></td></tr></table></figure>\n\n<p>运行以下sql查询索引的文件和块号</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> dbms_utility.data_block_address_file(</span><br><span class=\"line\">         to_number(<span class=\"keyword\">trim</span>(<span class=\"keyword\">leading</span> <span class=\"string\">'0'</span> <span class=\"keyword\">from</span></span><br><span class=\"line\"><span class=\"keyword\">replace</span>(<span class=\"string\">'&amp;&amp;rdba'</span>,<span class=\"string\">'0x'</span>,<span class=\"string\">''</span>)),<span class=\"string\">'XXXXXXXX'</span>)</span><br><span class=\"line\">       ) <span class=\"keyword\">AS</span> rfile<span class=\"comment\">#,</span></span><br><span class=\"line\">       dbms_utility.data_block_address_block(</span><br><span class=\"line\">         to_number(<span class=\"keyword\">trim</span>(<span class=\"keyword\">leading</span> <span class=\"string\">'0'</span> <span class=\"keyword\">from</span></span><br><span class=\"line\"><span class=\"keyword\">replace</span>(<span class=\"string\">'&amp;&amp;rdba'</span>,<span class=\"string\">'0x'</span>,<span class=\"string\">''</span>)),<span class=\"string\">'XXXXXXXX'</span>)</span><br><span class=\"line\">       ) <span class=\"keyword\">AS</span> <span class=\"keyword\">block</span><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> dual;</span><br></pre></td></tr></table></figure>\n\n<p>结果如下：</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; SELECT dbms_utility.data_block_address_file(</span><br><span class=\"line\">  2           to_number(trim(leading '0' from</span><br><span class=\"line\">  3  <span class=\"keyword\">replace</span>(<span class=\"string\">'&amp;&amp;rdba'</span>,<span class=\"string\">'0x'</span>,<span class=\"string\">''</span>)),<span class=\"string\">'XXXXXXXX'</span>)</span><br><span class=\"line\">  <span class=\"number\">4</span>         ) <span class=\"keyword\">AS</span> rfile<span class=\"comment\">#,</span></span><br><span class=\"line\">  <span class=\"number\">5</span>         dbms_utility.data_block_address_block(</span><br><span class=\"line\">  <span class=\"number\">6</span>           to_number(<span class=\"keyword\">trim</span>(<span class=\"keyword\">leading</span> <span class=\"string\">'0'</span> <span class=\"keyword\">from</span></span><br><span class=\"line\">  <span class=\"number\">7</span>  <span class=\"keyword\">replace</span>(<span class=\"string\">'&amp;&amp;rdba'</span>,<span class=\"string\">'0x'</span>,<span class=\"string\">''</span>)),<span class=\"string\">'XXXXXXXX'</span>)</span><br><span class=\"line\">  <span class=\"number\">8</span>         ) <span class=\"keyword\">AS</span> <span class=\"keyword\">block</span><span class=\"comment\">#</span></span><br><span class=\"line\">  <span class=\"number\">9</span>  <span class=\"keyword\">FROM</span> dual;</span><br><span class=\"line\">Enter value for rdba: 0x0080194a</span><br><span class=\"line\">old   3: <span class=\"keyword\">replace</span>(<span class=\"string\">'&amp;&amp;rdba'</span>,<span class=\"string\">'0x'</span>,<span class=\"string\">''</span>)),<span class=\"string\">'XXXXXXXX'</span>)</span><br><span class=\"line\"><span class=\"keyword\">new</span>   <span class=\"number\">3</span>: <span class=\"keyword\">replace</span>(<span class=\"string\">'0x0080194a'</span>,<span class=\"string\">'0x'</span>,<span class=\"string\">''</span>)),<span class=\"string\">'XXXXXXXX'</span>)</span><br><span class=\"line\"><span class=\"keyword\">old</span>   <span class=\"number\">7</span>: <span class=\"keyword\">replace</span>(<span class=\"string\">'&amp;&amp;rdba'</span>,<span class=\"string\">'0x'</span>,<span class=\"string\">''</span>)),<span class=\"string\">'XXXXXXXX'</span>)</span><br><span class=\"line\"><span class=\"keyword\">new</span>   <span class=\"number\">7</span>: <span class=\"keyword\">replace</span>(<span class=\"string\">'0x0080194a'</span>,<span class=\"string\">'0x'</span>,<span class=\"string\">''</span>)),<span class=\"string\">'XXXXXXXX'</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    RFILE<span class=\"comment\">#     BLOCK#</span></span><br><span class=\"line\"><span class=\"comment\">---------- ----------</span></span><br><span class=\"line\">         <span class=\"number\">2</span>       <span class=\"number\">6474</span></span><br></pre></td></tr></table></figure>\n\n<p>接下来运行如下查询，定位具体的segment</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> owner, segment_name, segment_type</span><br><span class=\"line\"><span class=\"keyword\">from</span>  dba_segments</span><br><span class=\"line\"><span class=\"keyword\">where</span> header_file = &lt;rfile<span class=\"comment\">#&gt;</span></span><br><span class=\"line\">  <span class=\"keyword\">and</span> header_block = &lt;<span class=\"keyword\">block</span><span class=\"comment\">#&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>结果如下：</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select owner, segment_name, segment_type</span><br><span class=\"line\">  2  from  dba_segments</span><br><span class=\"line\">  3  where header_file = 2</span><br><span class=\"line\">  4    and header_block = 6474;</span><br><span class=\"line\">OWNER                          SEGMENT_NAME                                                                      SEGMENT_TYPE</span><br><span class=\"line\"><span class=\"comment\">------------------------------ --------------------------------------------------------------------------------- ------------------</span></span><br><span class=\"line\">SYS                            WRH$_RSRC_PLAN_PK                                                                 INDEX</span><br></pre></td></tr></table></figure>\n\n<p>看来仍然是上面分析过的索引，这里是因为表和索引的数据不一致，那么重建索引</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">alter</span> <span class=\"keyword\">table</span> WRH$_RSRC_PLAN <span class=\"keyword\">drop</span> <span class=\"keyword\">constraint</span> WRH$_RSRC_PLAN_PK <span class=\"keyword\">cascade</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">alter</span> <span class=\"keyword\">table</span> WRH$_RSRC_PLAN</span><br><span class=\"line\">  <span class=\"keyword\">add</span> <span class=\"keyword\">constraint</span> WRH$_RSRC_PLAN_PK primary <span class=\"keyword\">key</span> (DBID, SNAP_ID, INSTANCE_NUMBER, <span class=\"keyword\">SEQUENCE</span><span class=\"comment\">#);</span></span><br></pre></td></tr></table></figure>\n\n<p>再次分析表，发现错误消失了</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; ANALYZE TABLE WRH$_RSRC_PLAN VALIDATE STRUCTURE CASCADE;</span><br><span class=\"line\"></span><br><span class=\"line\">Table analyzed.</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>至此，问题解决</p>\n</blockquote>\n<p>掉电仍是数据库的大敌，而此次并非只在这一张表上有讹误，还有其他一些WRH$表，这些表均属于sysaux表空间，这些表都是awr系列表，写入频繁，掉电容易引起数据的不一致性，但是，正因为是awr数据，并不是特别重要，修复起来也相对容易。  </p>\n<blockquote>\n<p>记录一下AWR Performance Tables介绍</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">The Oracle10g dynamic performance tables constitute the foundation of sophisticated automations such as Automatic Memory Management  (AMM ) as well as intelligent advisory tools such as ADDM and the SQL Tuning   Advisor.</span><br><span class=\"line\"></span><br><span class=\"line\">Remember, the AWR is a core feature of the 10g database kernel and automatically collects and stores important run-time performance information for our historical analysis.</span><br><span class=\"line\"></span><br><span class=\"line\">The tables that store this information are prefixed with wrh$ and are very similar in function to the STATSPACK tables.  This could make STATSPACK appear somewhat obsolete, although it is still available in the $ORACLE_HOME/rdbms/admin directory.</span><br><span class=\"line\"></span><br><span class=\"line\">Unlike the more cumbersome STATSPACK utility, which requires knowledge of the table structure and creation of complex query scripts, the 10g Enterprise Manager (OEM) automatically displays and interprets this valuable time-series performance data.</span><br><span class=\"line\"></span><br><span class=\"line\">The wrh$ AWR tables store important historical statistical information about the database in the form of periodic snapshots. Each snapshot is a capture of the in–memory x$ fixed view and other control structures at a certain point in time. Each of the AWR table names is prefixed with wrm$ (Metadata tables), wrh$ (History tables), or wri$ (Advisory tables).</span><br><span class=\"line\"></span><br><span class=\"line\"> 1. The wrm$ tables store metadata information for the Workload Repository.</span><br><span class=\"line\"></span><br><span class=\"line\"> 2. The wrh$ tables store historical data or snapshots.</span><br><span class=\"line\"></span><br><span class=\"line\"> 3. The wri$ tables: These 49 tables store data related to advisory functions.</span><br></pre></td></tr></table></figure>\n\n"},{"date":"2015-09-30T06:31:00.000Z","title":"ASSM三级位图结构与高水位的探究（下）","_content":"\n上一篇文章介绍了ASSM三级位图管理下的数据插入和高水位推进的关系，我们得出的结论是随着数据不断的插入，段大小的不断增长，L1中挂载的数据块的数量也会增长，而高水位是以L1中数据块大小的总和与区大小之间最小的一方为单位进行推进，而且我们知道要想应对大并发插入，就要使高水位之下的空闲块的数量尽可能多，但是如此一来就有可能造成空间的浪费，而oracle的初心也是本着节省空间的目的来设计的。\n之前我们用的是常规路径插入，能以L1和区的单位推动高水位，前提是要填满L1或区，而我们熟知的直接路径插入是在高水位之上插入，那是不是可以用直接路径插入快速增加高水位呢？我们来一探究竟。\n\n>首先构造测试的表空间和表，跟上一篇一样\n\n```sql\nSQL> drop tablespace lp including contents and datafiles;\n\nTablespace dropped.\n\nSQL> create tablespace lp datafile '/home/oracle/app/oracle/oradata/DG43/lp.dbf' size 2048M uniform size 1m;\ncreate table lp (id number,des1 char(2000),des2 char(2000),des3 char(2000),des4 char(500)) tablespace lp;\n\nTablespace created.\n\nSQL>\nTable created.\n\nSQL> alter table lp pctfree 24;\n\nTable altered.\n\n\nSQL> select object_id,object_name from dba_objects  where object_name='LP';\n\n OBJECT_ID OBJECT_NAME\n---------- ------------------------------\n     78760 LP\n```\n\n>首先看一下，78760这个对象在buffer里的数据块有哪些\n\n```sql\nSQL> select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        131 N      78760\n         5        129 N      78760\n         5        130 N      78760\n         5        128 N      78760\n```\n>有没有眼熟呢，128、129、130、131四个块刚好是两个L1、L2、L3\n我们定位段头块，看一下此时的高水位\n\n```sql\nSQL> select segment_name ,HEADER_FILE,HEADER_BLOCK from dba_segments where segment_name='LP';\n\nSEGMENT_NAME                   HEADER_FILE HEADER_BLOCK\n------------------------------ ----------- ------------\nLP                                       5          131\n\nExtent Control Header\n  -----------------------------------------------------------------\n  Extent Header:: spare1: 0      spare2: 0      #extents: 1      #blocks: 128   \n                  last map  0x00000000  #maps: 0      offset: 2716  \n      Highwater::  0x01400084  ext#: 0      blk#: 4      ext size: 128   \n  #blocks in seg. hdr's freelists: 0     \n  #blocks below: 0     \n  mapblk  0x00000000  offset: 0     \n\nSQL> select dbms_utility.data_block_address_file(to_number('01400084', 'xxxxxxxx')) file#,\n  2                      dbms_utility.data_block_address_block(to_number('01400084', 'xxxxxxxx')) block#\n  3  from dual;\n\n     FILE#     BLOCK#\n---------- ----------\n         5        132\n```\n\n>可以看出在没有任何数据的情况下，高水位是在第一个数据块上的，下面常规插入一行数据\n\n\n```sql\ninsert into lp values(1,'a','a','a','a');\n```\n\n>看一下高水位和buffer中的块\n\n\n```sql\nSQL> select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        165 Y      78760\n         5        131 Y      78760\n         5        173 Y      78760\n         5        160 Y      78760\n         5        168 Y      78760\n         5        163 Y      78760\n         5        129 N      78760\n         5        171 Y      78760\n         5        166 Y      78760\n         5        174 Y      78760\n         5        161 Y      78760\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        169 Y      78760\n         5        164 Y      78760\n         5        130 N      78760\n         5        172 Y      78760\n         5        167 Y      78760\n         5        175 Y      78760\n         5        162 Y      78760\n         5        128 Y      78760\n         5        170 Y      78760\n\n20 rows selected.\n\nSQL> select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp;\n\nDBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)\n------------------------------------ ------------------------------------\n                                   5                                  160\n```\n\n```\nExtent Control Header\n-----------------------------------------------------------------\nExtent Header:: spare1: 0 spare2: 0 #extents: 1 #blocks: 128\nlast map 0x00000000 #maps: 0 offset: 2716\nHighwater:: 0x014000c0 ext#: 0 blk#: 64 ext size: 128\n#blocks in seg. hdr's freelists: 0\n#blocks below: 60\nmapblk 0x00000000 offset: 0\n```\n\n>发现数据插入到160号块中，buffer中却多了16个块，高水位已移动到第二个L1中的第一个块上，看一下第一个L1\n\n```\nHWM Flag: HWM Set\n      Highwater::  0x014000c0  ext#: 0      blk#: 64     ext size: 128   \n  #blocks in seg. hdr's freelists: 0     \n  #blocks below: 60    \n  mapblk  0x00000000  offset: 0     \n  --------------------------------------------------------\n  DBA Ranges :\n  --------------------------------------------------------\n   0x01400080  Length: 64     Offset: 0      \n\n   0:Metadata   1:Metadata   2:Metadata   3:Metadata\n   4:unformatted   5:unformatted   6:unformatted   7:unformatted\n   8:unformatted   9:unformatted   10:unformatted   11:unformatted\n   12:unformatted   13:unformatted   14:unformatted   15:unformatted\n   16:unformatted   17:unformatted   18:unformatted   19:unformatted\n   20:unformatted   21:unformatted   22:unformatted   23:unformatted\n   24:unformatted   25:unformatted   26:unformatted   27:unformatted\n   28:unformatted   29:unformatted   30:unformatted   31:unformatted\n   32:FULL   33:75-100% free   34:75-100% free   35:75-100% free\n   36:75-100% free   37:75-100% free   38:75-100% free   39:75-100% free\n   40:75-100% free   41:75-100% free   42:75-100% free   43:75-100% free\n   44:75-100% free   45:75-100% free   46:75-100% free   47:75-100% free\n   48:unformatted   49:unformatted   50:unformatted   51:unformatted\n   52:unformatted   53:unformatted   54:unformatted   55:unformatted\n   56:unformatted   57:unformatted   58:unformatted   59:unformatted\n   60:unformatted   61:unformatted   62:unformatted   63:unformatted\n```\n\n```sql\n   SQL> select dbms_utility.data_block_address_file(to_number('014000c0', 'xxxxxxxx')) file#,\n  2                      dbms_utility.data_block_address_block(to_number('014000c0', 'xxxxxxxx')) block#\n  3  from dual;\n\n     FILE#     BLOCK#\n---------- ----------\n         5        192\n```\n\n>可以发现，buffer中新增的16个块是一次性格式化的这16个块，而高水位指在192号块上，直接路径插入一行\n\n```sql\nSQL> select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        165 N      78760\n         5        131 N      78760\n         5        173 N      78760\n         5        160 N      78760\n         5        168 N      78760\n         5        163 N      78760\n         5        129 N      78760\n         5        171 N      78760\n         5        166 N      78760\n         5        174 N      78760\n         5        161 N      78760\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        169 N      78760\n         5        164 N      78760\n         5        130 N      78760\n         5        172 N      78760\n         5        167 N      78760\n         5        175 N      78760\n         5        162 N      78760\n         5        128 N      78760\n         5        170 N      78760\n\n20 rows selected.\n\n\nSQL> insert /*+ append_values(lp)*/ into lp values(2,'b','b','b','b');\n\n1 row created.\n\nSQL> commit;\n\nCommit complete.\n\nSQL> select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp;\n\nDBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)\n------------------------------------ ------------------------------------\n                                   5                                  160\n                                   5                                  192\n\nSQL> select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        165 N      78760\n         5        131 Y      78760\n         5        173 N      78760\n         5        160 N      78760\n         5        168 N      78760\n         5        163 N      78760\n         5        129 Y      78760\n         5        171 N      78760\n         5        192 Y      78760\n         5        166 N      78760\n         5        174 N      78760\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        161 N      78760\n         5        169 N      78760\n         5        164 N      78760\n         5        130 N      78760\n         5        172 N      78760\n         5        167 N      78760\n         5        175 N      78760\n         5        162 N      78760\n         5        128 Y      78760\n         5        170 N      78760\n\n21 rows selected.\n\nSQL> alter system checkpoint;\n\nSystem altered.\n```\n\n>可以发现确实插入到了192号块，并且192号块已在buffer中，看一下此时的高水位\n\n```\nExtent Control Header\n  -----------------------------------------------------------------\n  Extent Header:: spare1: 0      spare2: 0      #extents: 1      #blocks: 128   \n                  last map  0x00000000  #maps: 0      offset: 2716  \n      Highwater::  0x014000c1  ext#: 0      blk#: 65     ext size: 128   \n  #blocks in seg. hdr's freelists: 0     \n  #blocks below: 65    \n  mapblk  0x00000000  offset: 0  \n\nHWM Flag: HWM Set\n      Highwater::  0x014000c1  ext#: 0      blk#: 65     ext size: 128   \n  #blocks in seg. hdr's freelists: 0     \n  #blocks below: 65    \n  mapblk  0x00000000  offset: 0     \n  --------------------------------------------------------\n  DBA Ranges :\n  --------------------------------------------------------\n   0x014000c0  Length: 64     Offset: 0      \n\n   0:FULL   1:unformatted   2:unformatted   3:unformatted\n   4:unformatted   5:unformatted   6:unformatted   7:unformatted\n   8:unformatted   9:unformatted   10:unformatted   11:unformatted\n   12:unformatted   13:unformatted   14:unformatted   15:unformatted\n   16:unformatted   17:unformatted   18:unformatted   19:unformatted\n   20:unformatted   21:unformatted   22:unformatted   23:unformatted\n   24:unformatted   25:unformatted   26:unformatted   27:unformatted\n   28:unformatted   29:unformatted   30:unformatted   31:unformatted\n   32:unformatted   33:unformatted   34:unformatted   35:unformatted\n   36:unformatted   37:unformatted   38:unformatted   39:unformatted\n   40:unformatted   41:unformatted   42:unformatted   43:unformatted\n   44:unformatted   45:unformatted   46:unformatted   47:unformatted\n   48:unformatted   49:unformatted   50:unformatted   51:unformatted\n   52:unformatted   53:unformatted   54:unformatted   55:unformatted\n   56:unformatted   57:unformatted   58:unformatted   59:unformatted\n   60:unformatted   61:unformatted   62:unformatted   63:unformatted\n  --------------------------------------------------------\nEnd dump data blocks tsn: 5 file#: 5 minblk 129 maxblk 129\n```\n\n>发现高水位仅仅移动了1个block，再试一遍\n\n```sql\nSQL> insert /*+ append_values(lp)*/ into lp values(3,'c','c','c','c');\n\n1 row created.\n\nSQL> commit;\n\nCommit complete.\n\nSQL> select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp;\n\nDBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)\n------------------------------------ ------------------------------------\n                                   5                                  160\n                                   5                                  192\n                                   5                                  193\n\nSQL> select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        165 N      78760\n         5        131 Y      78760\n         5        173 N      78760\n         5        160 N      78760\n         5        168 N      78760\n         5        163 N      78760\n         5        129 Y      78760\n         5        171 N      78760\n         5        192 N      78760\n         5        166 N      78760\n         5        174 N      78760\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        161 N      78760\n         5        169 N      78760\n         5        164 N      78760\n         5        130 N      78760\n         5        172 N      78760\n         5        193 Y      78760\n         5        167 N      78760\n         5        175 N      78760\n         5        162 N      78760\n         5        128 N      78760\n         5        170 N      78760\n\n22 rows selected.\n```\n\n```\nExtent Header:: spare1: 0      spare2: 0      #extents: 1      #blocks: 128   \n                  last map  0x00000000  #maps: 0      offset: 2716  \n      Highwater::  0x014000c2  ext#: 0      blk#: 66     ext size: 128   \n  #blocks in seg. hdr's freelists: 0     \n  #blocks below: 66    \n  mapblk  0x00000000  offset: 0     \n```\n\n  >仍然是只推动了一个block，但是发现为何每次直接路径插入的block都会出现在buffer里呢？难道是11g这个append_values新的hint的原因，再来试一下传统的append\n\n```sql\n  SQL> insert /*+ append*/ into lp select *  from lp where trim(des1)='a';\n\n1 row created.\n\nSQL> commit;\n\nCommit complete.\n\nSQL> select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp;\n\nDBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)\n------------------------------------ ------------------------------------\n                                   5                                  160\n                                   5                                  192\n                                   5                                  193\n                                   5                                  194\n\nSQL> select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        165 N      78760\n         5        131 Y      78760\n         5        173 N      78760\n         5        194 Y      78760\n         5        160 N      78760\n         5        168 N      78760\n         5        163 N      78760\n         5        129 Y      78760\n         5        171 N      78760\n         5        192 N      78760\n         5        166 N      78760\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        174 N      78760\n         5        161 N      78760\n         5        169 N      78760\n         5        164 N      78760\n         5        130 N      78760\n         5        172 N      78760\n         5        193 N      78760\n         5        167 N      78760\n         5        175 N      78760\n         5        162 N      78760\n         5        128 N      78760\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        170 N      78760\n\n23 rows selected.\n\nSQL> alter system checkpoint;\n\nSystem altered.\n```\n\n```\n  Extent Control Header\n  -----------------------------------------------------------------\n  Extent Header:: spare1: 0      spare2: 0      #extents: 1      #blocks: 128   \n                  last map  0x00000000  #maps: 0      offset: 2716  \n      Highwater::  0x014000c3  ext#: 0      blk#: 67     ext size: 128   \n  #blocks in seg. hdr's freelists: 0     \n  #blocks below: 67    \n  mapblk  0x00000000  offset: 0\n```\n\n>依然如故，不知道大家有没有发现，每次我执行完插入，都会执行一条select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp;\n这其实是全表扫描，本来块没在buffer里，一个FTS把块全给整进来了（小表buffer读，大表在11g中通常情况是直接路径读），知道原因了，再试一遍\n\n```sql\nSQL> insert /*+ append*/ into lp select *  from lp where trim(des1)='b';\n\n1 row created.\n\nSQL> commit;\n\nCommit complete.\n\nSQL> select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        165 N      78760\n         5        131 Y      78760\n         5        173 N      78760\n         5        194 N      78760\n         5        160 N      78760\n         5        168 N      78760\n         5        163 N      78760\n         5        129 Y      78760\n         5        171 N      78760\n         5        192 N      78760\n         5        166 N      78760\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        174 N      78760\n         5        161 N      78760\n         5        169 N      78760\n         5        164 N      78760\n         5        130 N      78760\n         5        172 N      78760\n         5        193 N      78760\n         5        167 N      78760\n         5        175 N      78760\n         5        162 N      78760\n         5        128 N      78760\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        170 N      78760\n\n23 rows selected.\n\nSQL> select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp;\n\nDBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)\n------------------------------------ ------------------------------------\n                                   5                                  160\n                                   5                                  192\n                                   5                                  193\n                                   5                                  194\n                                   5                                  195\n\nSQL> select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        165 N      78760\n         5        131 Y      78760\n         5        173 N      78760\n         5        194 N      78760\n         5        160 N      78760\n         5        168 N      78760\n         5        163 N      78760\n         5        129 Y      78760\n         5        171 N      78760\n         5        192 N      78760\n         5        166 N      78760\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        174 N      78760\n         5        195 Y      78760\n         5        161 N      78760\n         5        169 N      78760\n         5        164 N      78760\n         5        130 N      78760\n         5        172 N      78760\n         5        193 N      78760\n         5        167 N      78760\n         5        175 N      78760\n         5        162 N      78760\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        128 N      78760\n         5        170 N      78760\n\n24 rows selected.\n```\n\n>终于看到了想要的结果，总结一下吧，直接路径下高水位的推进大概如下图的样子：\n\n\n![](http://oaowhilvu.bkt.clouddn.com/direct.png)\n\n>不知道大家有没有注意到，直接路径插入完后再读入buffer中居然是个脏块，这是不是跟延迟提交清除有关呢？我们以后再慢慢分析！\n","source":"_posts/oracle/architecture/ASSM2.md","raw":"---\ndate: 2015-09-30 14:31\ntags: oracle\ntitle: ASSM三级位图结构与高水位的探究（下）\ncategories: oracle\n---\n\n上一篇文章介绍了ASSM三级位图管理下的数据插入和高水位推进的关系，我们得出的结论是随着数据不断的插入，段大小的不断增长，L1中挂载的数据块的数量也会增长，而高水位是以L1中数据块大小的总和与区大小之间最小的一方为单位进行推进，而且我们知道要想应对大并发插入，就要使高水位之下的空闲块的数量尽可能多，但是如此一来就有可能造成空间的浪费，而oracle的初心也是本着节省空间的目的来设计的。\n之前我们用的是常规路径插入，能以L1和区的单位推动高水位，前提是要填满L1或区，而我们熟知的直接路径插入是在高水位之上插入，那是不是可以用直接路径插入快速增加高水位呢？我们来一探究竟。\n\n>首先构造测试的表空间和表，跟上一篇一样\n\n```sql\nSQL> drop tablespace lp including contents and datafiles;\n\nTablespace dropped.\n\nSQL> create tablespace lp datafile '/home/oracle/app/oracle/oradata/DG43/lp.dbf' size 2048M uniform size 1m;\ncreate table lp (id number,des1 char(2000),des2 char(2000),des3 char(2000),des4 char(500)) tablespace lp;\n\nTablespace created.\n\nSQL>\nTable created.\n\nSQL> alter table lp pctfree 24;\n\nTable altered.\n\n\nSQL> select object_id,object_name from dba_objects  where object_name='LP';\n\n OBJECT_ID OBJECT_NAME\n---------- ------------------------------\n     78760 LP\n```\n\n>首先看一下，78760这个对象在buffer里的数据块有哪些\n\n```sql\nSQL> select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        131 N      78760\n         5        129 N      78760\n         5        130 N      78760\n         5        128 N      78760\n```\n>有没有眼熟呢，128、129、130、131四个块刚好是两个L1、L2、L3\n我们定位段头块，看一下此时的高水位\n\n```sql\nSQL> select segment_name ,HEADER_FILE,HEADER_BLOCK from dba_segments where segment_name='LP';\n\nSEGMENT_NAME                   HEADER_FILE HEADER_BLOCK\n------------------------------ ----------- ------------\nLP                                       5          131\n\nExtent Control Header\n  -----------------------------------------------------------------\n  Extent Header:: spare1: 0      spare2: 0      #extents: 1      #blocks: 128   \n                  last map  0x00000000  #maps: 0      offset: 2716  \n      Highwater::  0x01400084  ext#: 0      blk#: 4      ext size: 128   \n  #blocks in seg. hdr's freelists: 0     \n  #blocks below: 0     \n  mapblk  0x00000000  offset: 0     \n\nSQL> select dbms_utility.data_block_address_file(to_number('01400084', 'xxxxxxxx')) file#,\n  2                      dbms_utility.data_block_address_block(to_number('01400084', 'xxxxxxxx')) block#\n  3  from dual;\n\n     FILE#     BLOCK#\n---------- ----------\n         5        132\n```\n\n>可以看出在没有任何数据的情况下，高水位是在第一个数据块上的，下面常规插入一行数据\n\n\n```sql\ninsert into lp values(1,'a','a','a','a');\n```\n\n>看一下高水位和buffer中的块\n\n\n```sql\nSQL> select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        165 Y      78760\n         5        131 Y      78760\n         5        173 Y      78760\n         5        160 Y      78760\n         5        168 Y      78760\n         5        163 Y      78760\n         5        129 N      78760\n         5        171 Y      78760\n         5        166 Y      78760\n         5        174 Y      78760\n         5        161 Y      78760\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        169 Y      78760\n         5        164 Y      78760\n         5        130 N      78760\n         5        172 Y      78760\n         5        167 Y      78760\n         5        175 Y      78760\n         5        162 Y      78760\n         5        128 Y      78760\n         5        170 Y      78760\n\n20 rows selected.\n\nSQL> select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp;\n\nDBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)\n------------------------------------ ------------------------------------\n                                   5                                  160\n```\n\n```\nExtent Control Header\n-----------------------------------------------------------------\nExtent Header:: spare1: 0 spare2: 0 #extents: 1 #blocks: 128\nlast map 0x00000000 #maps: 0 offset: 2716\nHighwater:: 0x014000c0 ext#: 0 blk#: 64 ext size: 128\n#blocks in seg. hdr's freelists: 0\n#blocks below: 60\nmapblk 0x00000000 offset: 0\n```\n\n>发现数据插入到160号块中，buffer中却多了16个块，高水位已移动到第二个L1中的第一个块上，看一下第一个L1\n\n```\nHWM Flag: HWM Set\n      Highwater::  0x014000c0  ext#: 0      blk#: 64     ext size: 128   \n  #blocks in seg. hdr's freelists: 0     \n  #blocks below: 60    \n  mapblk  0x00000000  offset: 0     \n  --------------------------------------------------------\n  DBA Ranges :\n  --------------------------------------------------------\n   0x01400080  Length: 64     Offset: 0      \n\n   0:Metadata   1:Metadata   2:Metadata   3:Metadata\n   4:unformatted   5:unformatted   6:unformatted   7:unformatted\n   8:unformatted   9:unformatted   10:unformatted   11:unformatted\n   12:unformatted   13:unformatted   14:unformatted   15:unformatted\n   16:unformatted   17:unformatted   18:unformatted   19:unformatted\n   20:unformatted   21:unformatted   22:unformatted   23:unformatted\n   24:unformatted   25:unformatted   26:unformatted   27:unformatted\n   28:unformatted   29:unformatted   30:unformatted   31:unformatted\n   32:FULL   33:75-100% free   34:75-100% free   35:75-100% free\n   36:75-100% free   37:75-100% free   38:75-100% free   39:75-100% free\n   40:75-100% free   41:75-100% free   42:75-100% free   43:75-100% free\n   44:75-100% free   45:75-100% free   46:75-100% free   47:75-100% free\n   48:unformatted   49:unformatted   50:unformatted   51:unformatted\n   52:unformatted   53:unformatted   54:unformatted   55:unformatted\n   56:unformatted   57:unformatted   58:unformatted   59:unformatted\n   60:unformatted   61:unformatted   62:unformatted   63:unformatted\n```\n\n```sql\n   SQL> select dbms_utility.data_block_address_file(to_number('014000c0', 'xxxxxxxx')) file#,\n  2                      dbms_utility.data_block_address_block(to_number('014000c0', 'xxxxxxxx')) block#\n  3  from dual;\n\n     FILE#     BLOCK#\n---------- ----------\n         5        192\n```\n\n>可以发现，buffer中新增的16个块是一次性格式化的这16个块，而高水位指在192号块上，直接路径插入一行\n\n```sql\nSQL> select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        165 N      78760\n         5        131 N      78760\n         5        173 N      78760\n         5        160 N      78760\n         5        168 N      78760\n         5        163 N      78760\n         5        129 N      78760\n         5        171 N      78760\n         5        166 N      78760\n         5        174 N      78760\n         5        161 N      78760\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        169 N      78760\n         5        164 N      78760\n         5        130 N      78760\n         5        172 N      78760\n         5        167 N      78760\n         5        175 N      78760\n         5        162 N      78760\n         5        128 N      78760\n         5        170 N      78760\n\n20 rows selected.\n\n\nSQL> insert /*+ append_values(lp)*/ into lp values(2,'b','b','b','b');\n\n1 row created.\n\nSQL> commit;\n\nCommit complete.\n\nSQL> select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp;\n\nDBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)\n------------------------------------ ------------------------------------\n                                   5                                  160\n                                   5                                  192\n\nSQL> select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        165 N      78760\n         5        131 Y      78760\n         5        173 N      78760\n         5        160 N      78760\n         5        168 N      78760\n         5        163 N      78760\n         5        129 Y      78760\n         5        171 N      78760\n         5        192 Y      78760\n         5        166 N      78760\n         5        174 N      78760\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        161 N      78760\n         5        169 N      78760\n         5        164 N      78760\n         5        130 N      78760\n         5        172 N      78760\n         5        167 N      78760\n         5        175 N      78760\n         5        162 N      78760\n         5        128 Y      78760\n         5        170 N      78760\n\n21 rows selected.\n\nSQL> alter system checkpoint;\n\nSystem altered.\n```\n\n>可以发现确实插入到了192号块，并且192号块已在buffer中，看一下此时的高水位\n\n```\nExtent Control Header\n  -----------------------------------------------------------------\n  Extent Header:: spare1: 0      spare2: 0      #extents: 1      #blocks: 128   \n                  last map  0x00000000  #maps: 0      offset: 2716  \n      Highwater::  0x014000c1  ext#: 0      blk#: 65     ext size: 128   \n  #blocks in seg. hdr's freelists: 0     \n  #blocks below: 65    \n  mapblk  0x00000000  offset: 0  \n\nHWM Flag: HWM Set\n      Highwater::  0x014000c1  ext#: 0      blk#: 65     ext size: 128   \n  #blocks in seg. hdr's freelists: 0     \n  #blocks below: 65    \n  mapblk  0x00000000  offset: 0     \n  --------------------------------------------------------\n  DBA Ranges :\n  --------------------------------------------------------\n   0x014000c0  Length: 64     Offset: 0      \n\n   0:FULL   1:unformatted   2:unformatted   3:unformatted\n   4:unformatted   5:unformatted   6:unformatted   7:unformatted\n   8:unformatted   9:unformatted   10:unformatted   11:unformatted\n   12:unformatted   13:unformatted   14:unformatted   15:unformatted\n   16:unformatted   17:unformatted   18:unformatted   19:unformatted\n   20:unformatted   21:unformatted   22:unformatted   23:unformatted\n   24:unformatted   25:unformatted   26:unformatted   27:unformatted\n   28:unformatted   29:unformatted   30:unformatted   31:unformatted\n   32:unformatted   33:unformatted   34:unformatted   35:unformatted\n   36:unformatted   37:unformatted   38:unformatted   39:unformatted\n   40:unformatted   41:unformatted   42:unformatted   43:unformatted\n   44:unformatted   45:unformatted   46:unformatted   47:unformatted\n   48:unformatted   49:unformatted   50:unformatted   51:unformatted\n   52:unformatted   53:unformatted   54:unformatted   55:unformatted\n   56:unformatted   57:unformatted   58:unformatted   59:unformatted\n   60:unformatted   61:unformatted   62:unformatted   63:unformatted\n  --------------------------------------------------------\nEnd dump data blocks tsn: 5 file#: 5 minblk 129 maxblk 129\n```\n\n>发现高水位仅仅移动了1个block，再试一遍\n\n```sql\nSQL> insert /*+ append_values(lp)*/ into lp values(3,'c','c','c','c');\n\n1 row created.\n\nSQL> commit;\n\nCommit complete.\n\nSQL> select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp;\n\nDBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)\n------------------------------------ ------------------------------------\n                                   5                                  160\n                                   5                                  192\n                                   5                                  193\n\nSQL> select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        165 N      78760\n         5        131 Y      78760\n         5        173 N      78760\n         5        160 N      78760\n         5        168 N      78760\n         5        163 N      78760\n         5        129 Y      78760\n         5        171 N      78760\n         5        192 N      78760\n         5        166 N      78760\n         5        174 N      78760\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        161 N      78760\n         5        169 N      78760\n         5        164 N      78760\n         5        130 N      78760\n         5        172 N      78760\n         5        193 Y      78760\n         5        167 N      78760\n         5        175 N      78760\n         5        162 N      78760\n         5        128 N      78760\n         5        170 N      78760\n\n22 rows selected.\n```\n\n```\nExtent Header:: spare1: 0      spare2: 0      #extents: 1      #blocks: 128   \n                  last map  0x00000000  #maps: 0      offset: 2716  \n      Highwater::  0x014000c2  ext#: 0      blk#: 66     ext size: 128   \n  #blocks in seg. hdr's freelists: 0     \n  #blocks below: 66    \n  mapblk  0x00000000  offset: 0     \n```\n\n  >仍然是只推动了一个block，但是发现为何每次直接路径插入的block都会出现在buffer里呢？难道是11g这个append_values新的hint的原因，再来试一下传统的append\n\n```sql\n  SQL> insert /*+ append*/ into lp select *  from lp where trim(des1)='a';\n\n1 row created.\n\nSQL> commit;\n\nCommit complete.\n\nSQL> select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp;\n\nDBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)\n------------------------------------ ------------------------------------\n                                   5                                  160\n                                   5                                  192\n                                   5                                  193\n                                   5                                  194\n\nSQL> select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        165 N      78760\n         5        131 Y      78760\n         5        173 N      78760\n         5        194 Y      78760\n         5        160 N      78760\n         5        168 N      78760\n         5        163 N      78760\n         5        129 Y      78760\n         5        171 N      78760\n         5        192 N      78760\n         5        166 N      78760\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        174 N      78760\n         5        161 N      78760\n         5        169 N      78760\n         5        164 N      78760\n         5        130 N      78760\n         5        172 N      78760\n         5        193 N      78760\n         5        167 N      78760\n         5        175 N      78760\n         5        162 N      78760\n         5        128 N      78760\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        170 N      78760\n\n23 rows selected.\n\nSQL> alter system checkpoint;\n\nSystem altered.\n```\n\n```\n  Extent Control Header\n  -----------------------------------------------------------------\n  Extent Header:: spare1: 0      spare2: 0      #extents: 1      #blocks: 128   \n                  last map  0x00000000  #maps: 0      offset: 2716  \n      Highwater::  0x014000c3  ext#: 0      blk#: 67     ext size: 128   \n  #blocks in seg. hdr's freelists: 0     \n  #blocks below: 67    \n  mapblk  0x00000000  offset: 0\n```\n\n>依然如故，不知道大家有没有发现，每次我执行完插入，都会执行一条select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp;\n这其实是全表扫描，本来块没在buffer里，一个FTS把块全给整进来了（小表buffer读，大表在11g中通常情况是直接路径读），知道原因了，再试一遍\n\n```sql\nSQL> insert /*+ append*/ into lp select *  from lp where trim(des1)='b';\n\n1 row created.\n\nSQL> commit;\n\nCommit complete.\n\nSQL> select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        165 N      78760\n         5        131 Y      78760\n         5        173 N      78760\n         5        194 N      78760\n         5        160 N      78760\n         5        168 N      78760\n         5        163 N      78760\n         5        129 Y      78760\n         5        171 N      78760\n         5        192 N      78760\n         5        166 N      78760\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        174 N      78760\n         5        161 N      78760\n         5        169 N      78760\n         5        164 N      78760\n         5        130 N      78760\n         5        172 N      78760\n         5        193 N      78760\n         5        167 N      78760\n         5        175 N      78760\n         5        162 N      78760\n         5        128 N      78760\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        170 N      78760\n\n23 rows selected.\n\nSQL> select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp;\n\nDBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)\n------------------------------------ ------------------------------------\n                                   5                                  160\n                                   5                                  192\n                                   5                                  193\n                                   5                                  194\n                                   5                                  195\n\nSQL> select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        165 N      78760\n         5        131 Y      78760\n         5        173 N      78760\n         5        194 N      78760\n         5        160 N      78760\n         5        168 N      78760\n         5        163 N      78760\n         5        129 Y      78760\n         5        171 N      78760\n         5        192 N      78760\n         5        166 N      78760\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        174 N      78760\n         5        195 Y      78760\n         5        161 N      78760\n         5        169 N      78760\n         5        164 N      78760\n         5        130 N      78760\n         5        172 N      78760\n         5        193 N      78760\n         5        167 N      78760\n         5        175 N      78760\n         5        162 N      78760\n\n     FILE#     BLOCK# D       OBJD\n---------- ---------- - ----------\n         5        128 N      78760\n         5        170 N      78760\n\n24 rows selected.\n```\n\n>终于看到了想要的结果，总结一下吧，直接路径下高水位的推进大概如下图的样子：\n\n\n![](http://oaowhilvu.bkt.clouddn.com/direct.png)\n\n>不知道大家有没有注意到，直接路径插入完后再读入buffer中居然是个脏块，这是不是跟延迟提交清除有关呢？我们以后再慢慢分析！\n","slug":"oracle/architecture/ASSM2","published":1,"updated":"2019-07-21T05:03:54.650Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjychzpx00000fn0el8prijnt","content":"<p>上一篇文章介绍了ASSM三级位图管理下的数据插入和高水位推进的关系，我们得出的结论是随着数据不断的插入，段大小的不断增长，L1中挂载的数据块的数量也会增长，而高水位是以L1中数据块大小的总和与区大小之间最小的一方为单位进行推进，而且我们知道要想应对大并发插入，就要使高水位之下的空闲块的数量尽可能多，但是如此一来就有可能造成空间的浪费，而oracle的初心也是本着节省空间的目的来设计的。<br>之前我们用的是常规路径插入，能以L1和区的单位推动高水位，前提是要填满L1或区，而我们熟知的直接路径插入是在高水位之上插入，那是不是可以用直接路径插入快速增加高水位呢？我们来一探究竟。</p>\n<blockquote>\n<p>首先构造测试的表空间和表，跟上一篇一样</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; drop tablespace lp including contents and datafiles;</span><br><span class=\"line\"></span><br><span class=\"line\">Tablespace dropped.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; create tablespace lp datafile '/home/oracle/app/oracle/oradata/DG43/lp.dbf' size 2048M uniform size 1m;</span><br><span class=\"line\"><span class=\"keyword\">create</span> <span class=\"keyword\">table</span> lp (<span class=\"keyword\">id</span> <span class=\"built_in\">number</span>,des1 <span class=\"built_in\">char</span>(<span class=\"number\">2000</span>),des2 <span class=\"built_in\">char</span>(<span class=\"number\">2000</span>),des3 <span class=\"built_in\">char</span>(<span class=\"number\">2000</span>),des4 <span class=\"built_in\">char</span>(<span class=\"number\">500</span>)) <span class=\"keyword\">tablespace</span> lp;</span><br><span class=\"line\"></span><br><span class=\"line\">Tablespace created.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt;</span><br><span class=\"line\">Table created.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; alter table lp pctfree 24;</span><br><span class=\"line\"></span><br><span class=\"line\">Table altered.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; select object_id,object_name from dba_objects  where object_name='LP';</span><br><span class=\"line\"></span><br><span class=\"line\"> OBJECT_ID OBJECT_NAME</span><br><span class=\"line\"><span class=\"comment\">---------- ------------------------------</span></span><br><span class=\"line\">     78760 LP</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>首先看一下，78760这个对象在buffer里的数据块有哪些</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        131 N      78760</span><br><span class=\"line\">         5        129 N      78760</span><br><span class=\"line\">         5        130 N      78760</span><br><span class=\"line\">         5        128 N      78760</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>有没有眼熟呢，128、129、130、131四个块刚好是两个L1、L2、L3<br>我们定位段头块，看一下此时的高水位</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select segment_name ,HEADER_FILE,HEADER_BLOCK from dba_segments where segment_name='LP';</span><br><span class=\"line\"></span><br><span class=\"line\">SEGMENT_NAME                   HEADER_FILE HEADER_BLOCK</span><br><span class=\"line\"><span class=\"comment\">------------------------------ ----------- ------------</span></span><br><span class=\"line\">LP                                       5          131</span><br><span class=\"line\"></span><br><span class=\"line\">Extent Control Header</span><br><span class=\"line\">  <span class=\"comment\">-----------------------------------------------------------------</span></span><br><span class=\"line\">  Extent Header:: spare1: 0      spare2: 0      <span class=\"comment\">#extents: 1      #blocks: 128   </span></span><br><span class=\"line\">                  last map  0x00000000  <span class=\"comment\">#maps: 0      offset: 2716  </span></span><br><span class=\"line\">      Highwater::  0x01400084  ext<span class=\"comment\">#: 0      blk#: 4      ext size: 128   </span></span><br><span class=\"line\">  <span class=\"comment\">#blocks in seg. hdr's freelists: 0     </span></span><br><span class=\"line\">  <span class=\"comment\">#blocks below: 0     </span></span><br><span class=\"line\">  mapblk  0x00000000  offset: 0     </span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; select dbms_utility.data_block_address_file(to_number('01400084', 'xxxxxxxx')) file#,</span><br><span class=\"line\">  2                      dbms_utility.data_block_address_block(to_number('01400084', 'xxxxxxxx')) block<span class=\"comment\">#</span></span><br><span class=\"line\">  3  from dual;</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK#</span></span><br><span class=\"line\"><span class=\"comment\">---------- ----------</span></span><br><span class=\"line\">         5        132</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>可以看出在没有任何数据的情况下，高水位是在第一个数据块上的，下面常规插入一行数据</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">insert</span> <span class=\"keyword\">into</span> lp <span class=\"keyword\">values</span>(<span class=\"number\">1</span>,<span class=\"string\">'a'</span>,<span class=\"string\">'a'</span>,<span class=\"string\">'a'</span>,<span class=\"string\">'a'</span>);</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>看一下高水位和buffer中的块</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        165 Y      78760</span><br><span class=\"line\">         5        131 Y      78760</span><br><span class=\"line\">         5        173 Y      78760</span><br><span class=\"line\">         5        160 Y      78760</span><br><span class=\"line\">         5        168 Y      78760</span><br><span class=\"line\">         5        163 Y      78760</span><br><span class=\"line\">         5        129 N      78760</span><br><span class=\"line\">         5        171 Y      78760</span><br><span class=\"line\">         5        166 Y      78760</span><br><span class=\"line\">         5        174 Y      78760</span><br><span class=\"line\">         5        161 Y      78760</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        169 Y      78760</span><br><span class=\"line\">         5        164 Y      78760</span><br><span class=\"line\">         5        130 N      78760</span><br><span class=\"line\">         5        172 Y      78760</span><br><span class=\"line\">         5        167 Y      78760</span><br><span class=\"line\">         5        175 Y      78760</span><br><span class=\"line\">         5        162 Y      78760</span><br><span class=\"line\">         5        128 Y      78760</span><br><span class=\"line\">         5        170 Y      78760</span><br><span class=\"line\"></span><br><span class=\"line\">20 rows selected.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp;</span><br><span class=\"line\"></span><br><span class=\"line\">DBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)</span><br><span class=\"line\"><span class=\"comment\">------------------------------------ ------------------------------------</span></span><br><span class=\"line\">                                   5                                  160</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Extent Control Header</span><br><span class=\"line\">-----------------------------------------------------------------</span><br><span class=\"line\">Extent Header:: spare1: 0 spare2: 0 #extents: 1 #blocks: 128</span><br><span class=\"line\">last map 0x00000000 #maps: 0 offset: 2716</span><br><span class=\"line\">Highwater:: 0x014000c0 ext#: 0 blk#: 64 ext size: 128</span><br><span class=\"line\">#blocks in seg. hdr&apos;s freelists: 0</span><br><span class=\"line\">#blocks below: 60</span><br><span class=\"line\">mapblk 0x00000000 offset: 0</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>发现数据插入到160号块中，buffer中却多了16个块，高水位已移动到第二个L1中的第一个块上，看一下第一个L1</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">HWM Flag: HWM Set</span><br><span class=\"line\">      Highwater::  0x014000c0  ext#: 0      blk#: 64     ext size: 128   </span><br><span class=\"line\">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class=\"line\">  #blocks below: 60    </span><br><span class=\"line\">  mapblk  0x00000000  offset: 0     </span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">  DBA Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x01400080  Length: 64     Offset: 0      </span><br><span class=\"line\"></span><br><span class=\"line\">   0:Metadata   1:Metadata   2:Metadata   3:Metadata</span><br><span class=\"line\">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class=\"line\">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class=\"line\">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class=\"line\">   16:unformatted   17:unformatted   18:unformatted   19:unformatted</span><br><span class=\"line\">   20:unformatted   21:unformatted   22:unformatted   23:unformatted</span><br><span class=\"line\">   24:unformatted   25:unformatted   26:unformatted   27:unformatted</span><br><span class=\"line\">   28:unformatted   29:unformatted   30:unformatted   31:unformatted</span><br><span class=\"line\">   32:FULL   33:75-100% free   34:75-100% free   35:75-100% free</span><br><span class=\"line\">   36:75-100% free   37:75-100% free   38:75-100% free   39:75-100% free</span><br><span class=\"line\">   40:75-100% free   41:75-100% free   42:75-100% free   43:75-100% free</span><br><span class=\"line\">   44:75-100% free   45:75-100% free   46:75-100% free   47:75-100% free</span><br><span class=\"line\">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class=\"line\">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class=\"line\">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class=\"line\">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">   SQL&gt; select dbms_utility.data_block_address_file(to_number('014000c0', 'xxxxxxxx')) file#,</span><br><span class=\"line\">  2                      dbms_utility.data_block_address_block(to_number('014000c0', 'xxxxxxxx')) block<span class=\"comment\">#</span></span><br><span class=\"line\">  3  from dual;</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK#</span></span><br><span class=\"line\"><span class=\"comment\">---------- ----------</span></span><br><span class=\"line\">         5        192</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>可以发现，buffer中新增的16个块是一次性格式化的这16个块，而高水位指在192号块上，直接路径插入一行</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        165 N      78760</span><br><span class=\"line\">         5        131 N      78760</span><br><span class=\"line\">         5        173 N      78760</span><br><span class=\"line\">         5        160 N      78760</span><br><span class=\"line\">         5        168 N      78760</span><br><span class=\"line\">         5        163 N      78760</span><br><span class=\"line\">         5        129 N      78760</span><br><span class=\"line\">         5        171 N      78760</span><br><span class=\"line\">         5        166 N      78760</span><br><span class=\"line\">         5        174 N      78760</span><br><span class=\"line\">         5        161 N      78760</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        169 N      78760</span><br><span class=\"line\">         5        164 N      78760</span><br><span class=\"line\">         5        130 N      78760</span><br><span class=\"line\">         5        172 N      78760</span><br><span class=\"line\">         5        167 N      78760</span><br><span class=\"line\">         5        175 N      78760</span><br><span class=\"line\">         5        162 N      78760</span><br><span class=\"line\">         5        128 N      78760</span><br><span class=\"line\">         5        170 N      78760</span><br><span class=\"line\"></span><br><span class=\"line\">20 rows selected.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; insert /*+ append_values(lp)*/ into lp values(2,'b','b','b','b');</span><br><span class=\"line\"></span><br><span class=\"line\">1 row created.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; commit;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">Commit</span> complete.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">SQL</span>&gt; <span class=\"keyword\">select</span> dbms_rowid.ROWID_RELATIVE_FNO(<span class=\"keyword\">rowid</span>),dbms_rowid.ROWID_BLOCK_NUMBER(<span class=\"keyword\">rowid</span>) <span class=\"keyword\">from</span> lp;</span><br><span class=\"line\"></span><br><span class=\"line\">DBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)</span><br><span class=\"line\"><span class=\"comment\">------------------------------------ ------------------------------------</span></span><br><span class=\"line\">                                   5                                  160</span><br><span class=\"line\">                                   5                                  192</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        165 N      78760</span><br><span class=\"line\">         5        131 Y      78760</span><br><span class=\"line\">         5        173 N      78760</span><br><span class=\"line\">         5        160 N      78760</span><br><span class=\"line\">         5        168 N      78760</span><br><span class=\"line\">         5        163 N      78760</span><br><span class=\"line\">         5        129 Y      78760</span><br><span class=\"line\">         5        171 N      78760</span><br><span class=\"line\">         5        192 Y      78760</span><br><span class=\"line\">         5        166 N      78760</span><br><span class=\"line\">         5        174 N      78760</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        161 N      78760</span><br><span class=\"line\">         5        169 N      78760</span><br><span class=\"line\">         5        164 N      78760</span><br><span class=\"line\">         5        130 N      78760</span><br><span class=\"line\">         5        172 N      78760</span><br><span class=\"line\">         5        167 N      78760</span><br><span class=\"line\">         5        175 N      78760</span><br><span class=\"line\">         5        162 N      78760</span><br><span class=\"line\">         5        128 Y      78760</span><br><span class=\"line\">         5        170 N      78760</span><br><span class=\"line\"></span><br><span class=\"line\">21 rows selected.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; alter system checkpoint;</span><br><span class=\"line\"></span><br><span class=\"line\">System altered.</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>可以发现确实插入到了192号块，并且192号块已在buffer中，看一下此时的高水位</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Extent Control Header</span><br><span class=\"line\">  -----------------------------------------------------------------</span><br><span class=\"line\">  Extent Header:: spare1: 0      spare2: 0      #extents: 1      #blocks: 128   </span><br><span class=\"line\">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class=\"line\">      Highwater::  0x014000c1  ext#: 0      blk#: 65     ext size: 128   </span><br><span class=\"line\">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class=\"line\">  #blocks below: 65    </span><br><span class=\"line\">  mapblk  0x00000000  offset: 0  </span><br><span class=\"line\"></span><br><span class=\"line\">HWM Flag: HWM Set</span><br><span class=\"line\">      Highwater::  0x014000c1  ext#: 0      blk#: 65     ext size: 128   </span><br><span class=\"line\">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class=\"line\">  #blocks below: 65    </span><br><span class=\"line\">  mapblk  0x00000000  offset: 0     </span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">  DBA Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x014000c0  Length: 64     Offset: 0      </span><br><span class=\"line\"></span><br><span class=\"line\">   0:FULL   1:unformatted   2:unformatted   3:unformatted</span><br><span class=\"line\">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class=\"line\">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class=\"line\">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class=\"line\">   16:unformatted   17:unformatted   18:unformatted   19:unformatted</span><br><span class=\"line\">   20:unformatted   21:unformatted   22:unformatted   23:unformatted</span><br><span class=\"line\">   24:unformatted   25:unformatted   26:unformatted   27:unformatted</span><br><span class=\"line\">   28:unformatted   29:unformatted   30:unformatted   31:unformatted</span><br><span class=\"line\">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class=\"line\">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class=\"line\">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class=\"line\">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class=\"line\">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class=\"line\">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class=\"line\">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class=\"line\">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">End dump data blocks tsn: 5 file#: 5 minblk 129 maxblk 129</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>发现高水位仅仅移动了1个block，再试一遍</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; insert /*+ append_values(lp)*/ into lp values(3,'c','c','c','c');</span><br><span class=\"line\"></span><br><span class=\"line\">1 row created.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; commit;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">Commit</span> complete.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">SQL</span>&gt; <span class=\"keyword\">select</span> dbms_rowid.ROWID_RELATIVE_FNO(<span class=\"keyword\">rowid</span>),dbms_rowid.ROWID_BLOCK_NUMBER(<span class=\"keyword\">rowid</span>) <span class=\"keyword\">from</span> lp;</span><br><span class=\"line\"></span><br><span class=\"line\">DBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)</span><br><span class=\"line\"><span class=\"comment\">------------------------------------ ------------------------------------</span></span><br><span class=\"line\">                                   5                                  160</span><br><span class=\"line\">                                   5                                  192</span><br><span class=\"line\">                                   5                                  193</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        165 N      78760</span><br><span class=\"line\">         5        131 Y      78760</span><br><span class=\"line\">         5        173 N      78760</span><br><span class=\"line\">         5        160 N      78760</span><br><span class=\"line\">         5        168 N      78760</span><br><span class=\"line\">         5        163 N      78760</span><br><span class=\"line\">         5        129 Y      78760</span><br><span class=\"line\">         5        171 N      78760</span><br><span class=\"line\">         5        192 N      78760</span><br><span class=\"line\">         5        166 N      78760</span><br><span class=\"line\">         5        174 N      78760</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        161 N      78760</span><br><span class=\"line\">         5        169 N      78760</span><br><span class=\"line\">         5        164 N      78760</span><br><span class=\"line\">         5        130 N      78760</span><br><span class=\"line\">         5        172 N      78760</span><br><span class=\"line\">         5        193 Y      78760</span><br><span class=\"line\">         5        167 N      78760</span><br><span class=\"line\">         5        175 N      78760</span><br><span class=\"line\">         5        162 N      78760</span><br><span class=\"line\">         5        128 N      78760</span><br><span class=\"line\">         5        170 N      78760</span><br><span class=\"line\"></span><br><span class=\"line\">22 rows selected.</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Extent Header:: spare1: 0      spare2: 0      #extents: 1      #blocks: 128   </span><br><span class=\"line\">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class=\"line\">      Highwater::  0x014000c2  ext#: 0      blk#: 66     ext size: 128   </span><br><span class=\"line\">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class=\"line\">  #blocks below: 66    </span><br><span class=\"line\">  mapblk  0x00000000  offset: 0</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>仍然是只推动了一个block，但是发现为何每次直接路径插入的block都会出现在buffer里呢？难道是11g这个append_values新的hint的原因，再来试一下传统的append</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">  SQL&gt; insert /*+ append*/ into lp select *  from lp where trim(des1)='a';</span><br><span class=\"line\"></span><br><span class=\"line\">1 row created.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; commit;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">Commit</span> complete.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">SQL</span>&gt; <span class=\"keyword\">select</span> dbms_rowid.ROWID_RELATIVE_FNO(<span class=\"keyword\">rowid</span>),dbms_rowid.ROWID_BLOCK_NUMBER(<span class=\"keyword\">rowid</span>) <span class=\"keyword\">from</span> lp;</span><br><span class=\"line\"></span><br><span class=\"line\">DBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)</span><br><span class=\"line\"><span class=\"comment\">------------------------------------ ------------------------------------</span></span><br><span class=\"line\">                                   5                                  160</span><br><span class=\"line\">                                   5                                  192</span><br><span class=\"line\">                                   5                                  193</span><br><span class=\"line\">                                   5                                  194</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        165 N      78760</span><br><span class=\"line\">         5        131 Y      78760</span><br><span class=\"line\">         5        173 N      78760</span><br><span class=\"line\">         5        194 Y      78760</span><br><span class=\"line\">         5        160 N      78760</span><br><span class=\"line\">         5        168 N      78760</span><br><span class=\"line\">         5        163 N      78760</span><br><span class=\"line\">         5        129 Y      78760</span><br><span class=\"line\">         5        171 N      78760</span><br><span class=\"line\">         5        192 N      78760</span><br><span class=\"line\">         5        166 N      78760</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        174 N      78760</span><br><span class=\"line\">         5        161 N      78760</span><br><span class=\"line\">         5        169 N      78760</span><br><span class=\"line\">         5        164 N      78760</span><br><span class=\"line\">         5        130 N      78760</span><br><span class=\"line\">         5        172 N      78760</span><br><span class=\"line\">         5        193 N      78760</span><br><span class=\"line\">         5        167 N      78760</span><br><span class=\"line\">         5        175 N      78760</span><br><span class=\"line\">         5        162 N      78760</span><br><span class=\"line\">         5        128 N      78760</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        170 N      78760</span><br><span class=\"line\"></span><br><span class=\"line\">23 rows selected.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; alter system checkpoint;</span><br><span class=\"line\"></span><br><span class=\"line\">System altered.</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Extent Control Header</span><br><span class=\"line\">-----------------------------------------------------------------</span><br><span class=\"line\">Extent Header:: spare1: 0      spare2: 0      #extents: 1      #blocks: 128   </span><br><span class=\"line\">                last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class=\"line\">    Highwater::  0x014000c3  ext#: 0      blk#: 67     ext size: 128   </span><br><span class=\"line\">#blocks in seg. hdr&apos;s freelists: 0     </span><br><span class=\"line\">#blocks below: 67    </span><br><span class=\"line\">mapblk  0x00000000  offset: 0</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>依然如故，不知道大家有没有发现，每次我执行完插入，都会执行一条select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp;<br>这其实是全表扫描，本来块没在buffer里，一个FTS把块全给整进来了（小表buffer读，大表在11g中通常情况是直接路径读），知道原因了，再试一遍</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; insert /*+ append*/ into lp select *  from lp where trim(des1)='b';</span><br><span class=\"line\"></span><br><span class=\"line\">1 row created.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; commit;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">Commit</span> complete.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">SQL</span>&gt; <span class=\"keyword\">select</span> <span class=\"keyword\">file</span><span class=\"comment\">#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';</span></span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"keyword\">FILE</span><span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">165</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">131</span> Y      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">173</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">194</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">160</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">168</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">163</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">129</span> Y      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">171</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">192</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">166</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"keyword\">FILE</span><span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">174</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">161</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">169</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">164</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">130</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">172</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">193</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">167</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">175</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">162</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">128</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"keyword\">FILE</span><span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">170</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">23</span> <span class=\"keyword\">rows</span> selected.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">SQL</span>&gt; <span class=\"keyword\">select</span> dbms_rowid.ROWID_RELATIVE_FNO(<span class=\"keyword\">rowid</span>),dbms_rowid.ROWID_BLOCK_NUMBER(<span class=\"keyword\">rowid</span>) <span class=\"keyword\">from</span> lp;</span><br><span class=\"line\"></span><br><span class=\"line\">DBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)</span><br><span class=\"line\"><span class=\"comment\">------------------------------------ ------------------------------------</span></span><br><span class=\"line\">                                   5                                  160</span><br><span class=\"line\">                                   5                                  192</span><br><span class=\"line\">                                   5                                  193</span><br><span class=\"line\">                                   5                                  194</span><br><span class=\"line\">                                   5                                  195</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        165 N      78760</span><br><span class=\"line\">         5        131 Y      78760</span><br><span class=\"line\">         5        173 N      78760</span><br><span class=\"line\">         5        194 N      78760</span><br><span class=\"line\">         5        160 N      78760</span><br><span class=\"line\">         5        168 N      78760</span><br><span class=\"line\">         5        163 N      78760</span><br><span class=\"line\">         5        129 Y      78760</span><br><span class=\"line\">         5        171 N      78760</span><br><span class=\"line\">         5        192 N      78760</span><br><span class=\"line\">         5        166 N      78760</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        174 N      78760</span><br><span class=\"line\">         5        195 Y      78760</span><br><span class=\"line\">         5        161 N      78760</span><br><span class=\"line\">         5        169 N      78760</span><br><span class=\"line\">         5        164 N      78760</span><br><span class=\"line\">         5        130 N      78760</span><br><span class=\"line\">         5        172 N      78760</span><br><span class=\"line\">         5        193 N      78760</span><br><span class=\"line\">         5        167 N      78760</span><br><span class=\"line\">         5        175 N      78760</span><br><span class=\"line\">         5        162 N      78760</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        128 N      78760</span><br><span class=\"line\">         5        170 N      78760</span><br><span class=\"line\"></span><br><span class=\"line\">24 rows selected.</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>终于看到了想要的结果，总结一下吧，直接路径下高水位的推进大概如下图的样子：</p>\n</blockquote>\n<p><img alt data-src=\"http://oaowhilvu.bkt.clouddn.com/direct.png\"></p>\n<blockquote>\n<p>不知道大家有没有注意到，直接路径插入完后再读入buffer中居然是个脏块，这是不是跟延迟提交清除有关呢？我们以后再慢慢分析！</p>\n</blockquote>\n","site":{"data":{"styles":"","footer":"<div class=\"footer-custom\">\nTheme source code <span class=\"exturl theme-link\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvaGV4by10aGVtZS1uZXh0\">here</span><br>\nWebsite source code <span class=\"exturl theme-link\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvdGhlbWUtbmV4dC5vcmc=\">here</span>\n</div>\n"}},"excerpt":"","more":"<p>上一篇文章介绍了ASSM三级位图管理下的数据插入和高水位推进的关系，我们得出的结论是随着数据不断的插入，段大小的不断增长，L1中挂载的数据块的数量也会增长，而高水位是以L1中数据块大小的总和与区大小之间最小的一方为单位进行推进，而且我们知道要想应对大并发插入，就要使高水位之下的空闲块的数量尽可能多，但是如此一来就有可能造成空间的浪费，而oracle的初心也是本着节省空间的目的来设计的。<br>之前我们用的是常规路径插入，能以L1和区的单位推动高水位，前提是要填满L1或区，而我们熟知的直接路径插入是在高水位之上插入，那是不是可以用直接路径插入快速增加高水位呢？我们来一探究竟。</p>\n<blockquote>\n<p>首先构造测试的表空间和表，跟上一篇一样</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; drop tablespace lp including contents and datafiles;</span><br><span class=\"line\"></span><br><span class=\"line\">Tablespace dropped.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; create tablespace lp datafile '/home/oracle/app/oracle/oradata/DG43/lp.dbf' size 2048M uniform size 1m;</span><br><span class=\"line\"><span class=\"keyword\">create</span> <span class=\"keyword\">table</span> lp (<span class=\"keyword\">id</span> <span class=\"built_in\">number</span>,des1 <span class=\"built_in\">char</span>(<span class=\"number\">2000</span>),des2 <span class=\"built_in\">char</span>(<span class=\"number\">2000</span>),des3 <span class=\"built_in\">char</span>(<span class=\"number\">2000</span>),des4 <span class=\"built_in\">char</span>(<span class=\"number\">500</span>)) <span class=\"keyword\">tablespace</span> lp;</span><br><span class=\"line\"></span><br><span class=\"line\">Tablespace created.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt;</span><br><span class=\"line\">Table created.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; alter table lp pctfree 24;</span><br><span class=\"line\"></span><br><span class=\"line\">Table altered.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; select object_id,object_name from dba_objects  where object_name='LP';</span><br><span class=\"line\"></span><br><span class=\"line\"> OBJECT_ID OBJECT_NAME</span><br><span class=\"line\"><span class=\"comment\">---------- ------------------------------</span></span><br><span class=\"line\">     78760 LP</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>首先看一下，78760这个对象在buffer里的数据块有哪些</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        131 N      78760</span><br><span class=\"line\">         5        129 N      78760</span><br><span class=\"line\">         5        130 N      78760</span><br><span class=\"line\">         5        128 N      78760</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>有没有眼熟呢，128、129、130、131四个块刚好是两个L1、L2、L3<br>我们定位段头块，看一下此时的高水位</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select segment_name ,HEADER_FILE,HEADER_BLOCK from dba_segments where segment_name='LP';</span><br><span class=\"line\"></span><br><span class=\"line\">SEGMENT_NAME                   HEADER_FILE HEADER_BLOCK</span><br><span class=\"line\"><span class=\"comment\">------------------------------ ----------- ------------</span></span><br><span class=\"line\">LP                                       5          131</span><br><span class=\"line\"></span><br><span class=\"line\">Extent Control Header</span><br><span class=\"line\">  <span class=\"comment\">-----------------------------------------------------------------</span></span><br><span class=\"line\">  Extent Header:: spare1: 0      spare2: 0      <span class=\"comment\">#extents: 1      #blocks: 128   </span></span><br><span class=\"line\">                  last map  0x00000000  <span class=\"comment\">#maps: 0      offset: 2716  </span></span><br><span class=\"line\">      Highwater::  0x01400084  ext<span class=\"comment\">#: 0      blk#: 4      ext size: 128   </span></span><br><span class=\"line\">  <span class=\"comment\">#blocks in seg. hdr's freelists: 0     </span></span><br><span class=\"line\">  <span class=\"comment\">#blocks below: 0     </span></span><br><span class=\"line\">  mapblk  0x00000000  offset: 0     </span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; select dbms_utility.data_block_address_file(to_number('01400084', 'xxxxxxxx')) file#,</span><br><span class=\"line\">  2                      dbms_utility.data_block_address_block(to_number('01400084', 'xxxxxxxx')) block<span class=\"comment\">#</span></span><br><span class=\"line\">  3  from dual;</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK#</span></span><br><span class=\"line\"><span class=\"comment\">---------- ----------</span></span><br><span class=\"line\">         5        132</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>可以看出在没有任何数据的情况下，高水位是在第一个数据块上的，下面常规插入一行数据</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">insert</span> <span class=\"keyword\">into</span> lp <span class=\"keyword\">values</span>(<span class=\"number\">1</span>,<span class=\"string\">'a'</span>,<span class=\"string\">'a'</span>,<span class=\"string\">'a'</span>,<span class=\"string\">'a'</span>);</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>看一下高水位和buffer中的块</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        165 Y      78760</span><br><span class=\"line\">         5        131 Y      78760</span><br><span class=\"line\">         5        173 Y      78760</span><br><span class=\"line\">         5        160 Y      78760</span><br><span class=\"line\">         5        168 Y      78760</span><br><span class=\"line\">         5        163 Y      78760</span><br><span class=\"line\">         5        129 N      78760</span><br><span class=\"line\">         5        171 Y      78760</span><br><span class=\"line\">         5        166 Y      78760</span><br><span class=\"line\">         5        174 Y      78760</span><br><span class=\"line\">         5        161 Y      78760</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        169 Y      78760</span><br><span class=\"line\">         5        164 Y      78760</span><br><span class=\"line\">         5        130 N      78760</span><br><span class=\"line\">         5        172 Y      78760</span><br><span class=\"line\">         5        167 Y      78760</span><br><span class=\"line\">         5        175 Y      78760</span><br><span class=\"line\">         5        162 Y      78760</span><br><span class=\"line\">         5        128 Y      78760</span><br><span class=\"line\">         5        170 Y      78760</span><br><span class=\"line\"></span><br><span class=\"line\">20 rows selected.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp;</span><br><span class=\"line\"></span><br><span class=\"line\">DBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)</span><br><span class=\"line\"><span class=\"comment\">------------------------------------ ------------------------------------</span></span><br><span class=\"line\">                                   5                                  160</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Extent Control Header</span><br><span class=\"line\">-----------------------------------------------------------------</span><br><span class=\"line\">Extent Header:: spare1: 0 spare2: 0 #extents: 1 #blocks: 128</span><br><span class=\"line\">last map 0x00000000 #maps: 0 offset: 2716</span><br><span class=\"line\">Highwater:: 0x014000c0 ext#: 0 blk#: 64 ext size: 128</span><br><span class=\"line\">#blocks in seg. hdr&apos;s freelists: 0</span><br><span class=\"line\">#blocks below: 60</span><br><span class=\"line\">mapblk 0x00000000 offset: 0</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>发现数据插入到160号块中，buffer中却多了16个块，高水位已移动到第二个L1中的第一个块上，看一下第一个L1</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">HWM Flag: HWM Set</span><br><span class=\"line\">      Highwater::  0x014000c0  ext#: 0      blk#: 64     ext size: 128   </span><br><span class=\"line\">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class=\"line\">  #blocks below: 60    </span><br><span class=\"line\">  mapblk  0x00000000  offset: 0     </span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">  DBA Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x01400080  Length: 64     Offset: 0      </span><br><span class=\"line\"></span><br><span class=\"line\">   0:Metadata   1:Metadata   2:Metadata   3:Metadata</span><br><span class=\"line\">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class=\"line\">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class=\"line\">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class=\"line\">   16:unformatted   17:unformatted   18:unformatted   19:unformatted</span><br><span class=\"line\">   20:unformatted   21:unformatted   22:unformatted   23:unformatted</span><br><span class=\"line\">   24:unformatted   25:unformatted   26:unformatted   27:unformatted</span><br><span class=\"line\">   28:unformatted   29:unformatted   30:unformatted   31:unformatted</span><br><span class=\"line\">   32:FULL   33:75-100% free   34:75-100% free   35:75-100% free</span><br><span class=\"line\">   36:75-100% free   37:75-100% free   38:75-100% free   39:75-100% free</span><br><span class=\"line\">   40:75-100% free   41:75-100% free   42:75-100% free   43:75-100% free</span><br><span class=\"line\">   44:75-100% free   45:75-100% free   46:75-100% free   47:75-100% free</span><br><span class=\"line\">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class=\"line\">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class=\"line\">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class=\"line\">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">   SQL&gt; select dbms_utility.data_block_address_file(to_number('014000c0', 'xxxxxxxx')) file#,</span><br><span class=\"line\">  2                      dbms_utility.data_block_address_block(to_number('014000c0', 'xxxxxxxx')) block<span class=\"comment\">#</span></span><br><span class=\"line\">  3  from dual;</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK#</span></span><br><span class=\"line\"><span class=\"comment\">---------- ----------</span></span><br><span class=\"line\">         5        192</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>可以发现，buffer中新增的16个块是一次性格式化的这16个块，而高水位指在192号块上，直接路径插入一行</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        165 N      78760</span><br><span class=\"line\">         5        131 N      78760</span><br><span class=\"line\">         5        173 N      78760</span><br><span class=\"line\">         5        160 N      78760</span><br><span class=\"line\">         5        168 N      78760</span><br><span class=\"line\">         5        163 N      78760</span><br><span class=\"line\">         5        129 N      78760</span><br><span class=\"line\">         5        171 N      78760</span><br><span class=\"line\">         5        166 N      78760</span><br><span class=\"line\">         5        174 N      78760</span><br><span class=\"line\">         5        161 N      78760</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        169 N      78760</span><br><span class=\"line\">         5        164 N      78760</span><br><span class=\"line\">         5        130 N      78760</span><br><span class=\"line\">         5        172 N      78760</span><br><span class=\"line\">         5        167 N      78760</span><br><span class=\"line\">         5        175 N      78760</span><br><span class=\"line\">         5        162 N      78760</span><br><span class=\"line\">         5        128 N      78760</span><br><span class=\"line\">         5        170 N      78760</span><br><span class=\"line\"></span><br><span class=\"line\">20 rows selected.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; insert /*+ append_values(lp)*/ into lp values(2,'b','b','b','b');</span><br><span class=\"line\"></span><br><span class=\"line\">1 row created.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; commit;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">Commit</span> complete.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">SQL</span>&gt; <span class=\"keyword\">select</span> dbms_rowid.ROWID_RELATIVE_FNO(<span class=\"keyword\">rowid</span>),dbms_rowid.ROWID_BLOCK_NUMBER(<span class=\"keyword\">rowid</span>) <span class=\"keyword\">from</span> lp;</span><br><span class=\"line\"></span><br><span class=\"line\">DBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)</span><br><span class=\"line\"><span class=\"comment\">------------------------------------ ------------------------------------</span></span><br><span class=\"line\">                                   5                                  160</span><br><span class=\"line\">                                   5                                  192</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        165 N      78760</span><br><span class=\"line\">         5        131 Y      78760</span><br><span class=\"line\">         5        173 N      78760</span><br><span class=\"line\">         5        160 N      78760</span><br><span class=\"line\">         5        168 N      78760</span><br><span class=\"line\">         5        163 N      78760</span><br><span class=\"line\">         5        129 Y      78760</span><br><span class=\"line\">         5        171 N      78760</span><br><span class=\"line\">         5        192 Y      78760</span><br><span class=\"line\">         5        166 N      78760</span><br><span class=\"line\">         5        174 N      78760</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        161 N      78760</span><br><span class=\"line\">         5        169 N      78760</span><br><span class=\"line\">         5        164 N      78760</span><br><span class=\"line\">         5        130 N      78760</span><br><span class=\"line\">         5        172 N      78760</span><br><span class=\"line\">         5        167 N      78760</span><br><span class=\"line\">         5        175 N      78760</span><br><span class=\"line\">         5        162 N      78760</span><br><span class=\"line\">         5        128 Y      78760</span><br><span class=\"line\">         5        170 N      78760</span><br><span class=\"line\"></span><br><span class=\"line\">21 rows selected.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; alter system checkpoint;</span><br><span class=\"line\"></span><br><span class=\"line\">System altered.</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>可以发现确实插入到了192号块，并且192号块已在buffer中，看一下此时的高水位</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Extent Control Header</span><br><span class=\"line\">  -----------------------------------------------------------------</span><br><span class=\"line\">  Extent Header:: spare1: 0      spare2: 0      #extents: 1      #blocks: 128   </span><br><span class=\"line\">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class=\"line\">      Highwater::  0x014000c1  ext#: 0      blk#: 65     ext size: 128   </span><br><span class=\"line\">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class=\"line\">  #blocks below: 65    </span><br><span class=\"line\">  mapblk  0x00000000  offset: 0  </span><br><span class=\"line\"></span><br><span class=\"line\">HWM Flag: HWM Set</span><br><span class=\"line\">      Highwater::  0x014000c1  ext#: 0      blk#: 65     ext size: 128   </span><br><span class=\"line\">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class=\"line\">  #blocks below: 65    </span><br><span class=\"line\">  mapblk  0x00000000  offset: 0     </span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">  DBA Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x014000c0  Length: 64     Offset: 0      </span><br><span class=\"line\"></span><br><span class=\"line\">   0:FULL   1:unformatted   2:unformatted   3:unformatted</span><br><span class=\"line\">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class=\"line\">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class=\"line\">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class=\"line\">   16:unformatted   17:unformatted   18:unformatted   19:unformatted</span><br><span class=\"line\">   20:unformatted   21:unformatted   22:unformatted   23:unformatted</span><br><span class=\"line\">   24:unformatted   25:unformatted   26:unformatted   27:unformatted</span><br><span class=\"line\">   28:unformatted   29:unformatted   30:unformatted   31:unformatted</span><br><span class=\"line\">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class=\"line\">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class=\"line\">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class=\"line\">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class=\"line\">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class=\"line\">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class=\"line\">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class=\"line\">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">End dump data blocks tsn: 5 file#: 5 minblk 129 maxblk 129</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>发现高水位仅仅移动了1个block，再试一遍</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; insert /*+ append_values(lp)*/ into lp values(3,'c','c','c','c');</span><br><span class=\"line\"></span><br><span class=\"line\">1 row created.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; commit;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">Commit</span> complete.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">SQL</span>&gt; <span class=\"keyword\">select</span> dbms_rowid.ROWID_RELATIVE_FNO(<span class=\"keyword\">rowid</span>),dbms_rowid.ROWID_BLOCK_NUMBER(<span class=\"keyword\">rowid</span>) <span class=\"keyword\">from</span> lp;</span><br><span class=\"line\"></span><br><span class=\"line\">DBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)</span><br><span class=\"line\"><span class=\"comment\">------------------------------------ ------------------------------------</span></span><br><span class=\"line\">                                   5                                  160</span><br><span class=\"line\">                                   5                                  192</span><br><span class=\"line\">                                   5                                  193</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        165 N      78760</span><br><span class=\"line\">         5        131 Y      78760</span><br><span class=\"line\">         5        173 N      78760</span><br><span class=\"line\">         5        160 N      78760</span><br><span class=\"line\">         5        168 N      78760</span><br><span class=\"line\">         5        163 N      78760</span><br><span class=\"line\">         5        129 Y      78760</span><br><span class=\"line\">         5        171 N      78760</span><br><span class=\"line\">         5        192 N      78760</span><br><span class=\"line\">         5        166 N      78760</span><br><span class=\"line\">         5        174 N      78760</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        161 N      78760</span><br><span class=\"line\">         5        169 N      78760</span><br><span class=\"line\">         5        164 N      78760</span><br><span class=\"line\">         5        130 N      78760</span><br><span class=\"line\">         5        172 N      78760</span><br><span class=\"line\">         5        193 Y      78760</span><br><span class=\"line\">         5        167 N      78760</span><br><span class=\"line\">         5        175 N      78760</span><br><span class=\"line\">         5        162 N      78760</span><br><span class=\"line\">         5        128 N      78760</span><br><span class=\"line\">         5        170 N      78760</span><br><span class=\"line\"></span><br><span class=\"line\">22 rows selected.</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Extent Header:: spare1: 0      spare2: 0      #extents: 1      #blocks: 128   </span><br><span class=\"line\">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class=\"line\">      Highwater::  0x014000c2  ext#: 0      blk#: 66     ext size: 128   </span><br><span class=\"line\">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class=\"line\">  #blocks below: 66    </span><br><span class=\"line\">  mapblk  0x00000000  offset: 0</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>仍然是只推动了一个block，但是发现为何每次直接路径插入的block都会出现在buffer里呢？难道是11g这个append_values新的hint的原因，再来试一下传统的append</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">  SQL&gt; insert /*+ append*/ into lp select *  from lp where trim(des1)='a';</span><br><span class=\"line\"></span><br><span class=\"line\">1 row created.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; commit;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">Commit</span> complete.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">SQL</span>&gt; <span class=\"keyword\">select</span> dbms_rowid.ROWID_RELATIVE_FNO(<span class=\"keyword\">rowid</span>),dbms_rowid.ROWID_BLOCK_NUMBER(<span class=\"keyword\">rowid</span>) <span class=\"keyword\">from</span> lp;</span><br><span class=\"line\"></span><br><span class=\"line\">DBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)</span><br><span class=\"line\"><span class=\"comment\">------------------------------------ ------------------------------------</span></span><br><span class=\"line\">                                   5                                  160</span><br><span class=\"line\">                                   5                                  192</span><br><span class=\"line\">                                   5                                  193</span><br><span class=\"line\">                                   5                                  194</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        165 N      78760</span><br><span class=\"line\">         5        131 Y      78760</span><br><span class=\"line\">         5        173 N      78760</span><br><span class=\"line\">         5        194 Y      78760</span><br><span class=\"line\">         5        160 N      78760</span><br><span class=\"line\">         5        168 N      78760</span><br><span class=\"line\">         5        163 N      78760</span><br><span class=\"line\">         5        129 Y      78760</span><br><span class=\"line\">         5        171 N      78760</span><br><span class=\"line\">         5        192 N      78760</span><br><span class=\"line\">         5        166 N      78760</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        174 N      78760</span><br><span class=\"line\">         5        161 N      78760</span><br><span class=\"line\">         5        169 N      78760</span><br><span class=\"line\">         5        164 N      78760</span><br><span class=\"line\">         5        130 N      78760</span><br><span class=\"line\">         5        172 N      78760</span><br><span class=\"line\">         5        193 N      78760</span><br><span class=\"line\">         5        167 N      78760</span><br><span class=\"line\">         5        175 N      78760</span><br><span class=\"line\">         5        162 N      78760</span><br><span class=\"line\">         5        128 N      78760</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        170 N      78760</span><br><span class=\"line\"></span><br><span class=\"line\">23 rows selected.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; alter system checkpoint;</span><br><span class=\"line\"></span><br><span class=\"line\">System altered.</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Extent Control Header</span><br><span class=\"line\">-----------------------------------------------------------------</span><br><span class=\"line\">Extent Header:: spare1: 0      spare2: 0      #extents: 1      #blocks: 128   </span><br><span class=\"line\">                last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class=\"line\">    Highwater::  0x014000c3  ext#: 0      blk#: 67     ext size: 128   </span><br><span class=\"line\">#blocks in seg. hdr&apos;s freelists: 0     </span><br><span class=\"line\">#blocks below: 67    </span><br><span class=\"line\">mapblk  0x00000000  offset: 0</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>依然如故，不知道大家有没有发现，每次我执行完插入，都会执行一条select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp;<br>这其实是全表扫描，本来块没在buffer里，一个FTS把块全给整进来了（小表buffer读，大表在11g中通常情况是直接路径读），知道原因了，再试一遍</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; insert /*+ append*/ into lp select *  from lp where trim(des1)='b';</span><br><span class=\"line\"></span><br><span class=\"line\">1 row created.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; commit;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">Commit</span> complete.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">SQL</span>&gt; <span class=\"keyword\">select</span> <span class=\"keyword\">file</span><span class=\"comment\">#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';</span></span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"keyword\">FILE</span><span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">165</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">131</span> Y      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">173</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">194</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">160</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">168</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">163</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">129</span> Y      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">171</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">192</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">166</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"keyword\">FILE</span><span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">174</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">161</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">169</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">164</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">130</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">172</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">193</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">167</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">175</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">162</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">128</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"keyword\">FILE</span><span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         <span class=\"number\">5</span>        <span class=\"number\">170</span> N      <span class=\"number\">78760</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">23</span> <span class=\"keyword\">rows</span> selected.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">SQL</span>&gt; <span class=\"keyword\">select</span> dbms_rowid.ROWID_RELATIVE_FNO(<span class=\"keyword\">rowid</span>),dbms_rowid.ROWID_BLOCK_NUMBER(<span class=\"keyword\">rowid</span>) <span class=\"keyword\">from</span> lp;</span><br><span class=\"line\"></span><br><span class=\"line\">DBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)</span><br><span class=\"line\"><span class=\"comment\">------------------------------------ ------------------------------------</span></span><br><span class=\"line\">                                   5                                  160</span><br><span class=\"line\">                                   5                                  192</span><br><span class=\"line\">                                   5                                  193</span><br><span class=\"line\">                                   5                                  194</span><br><span class=\"line\">                                   5                                  195</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; select file#,BLOCK#,DIRTY,OBJD from v$bh where objd='78760';</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        165 N      78760</span><br><span class=\"line\">         5        131 Y      78760</span><br><span class=\"line\">         5        173 N      78760</span><br><span class=\"line\">         5        194 N      78760</span><br><span class=\"line\">         5        160 N      78760</span><br><span class=\"line\">         5        168 N      78760</span><br><span class=\"line\">         5        163 N      78760</span><br><span class=\"line\">         5        129 Y      78760</span><br><span class=\"line\">         5        171 N      78760</span><br><span class=\"line\">         5        192 N      78760</span><br><span class=\"line\">         5        166 N      78760</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        174 N      78760</span><br><span class=\"line\">         5        195 Y      78760</span><br><span class=\"line\">         5        161 N      78760</span><br><span class=\"line\">         5        169 N      78760</span><br><span class=\"line\">         5        164 N      78760</span><br><span class=\"line\">         5        130 N      78760</span><br><span class=\"line\">         5        172 N      78760</span><br><span class=\"line\">         5        193 N      78760</span><br><span class=\"line\">         5        167 N      78760</span><br><span class=\"line\">         5        175 N      78760</span><br><span class=\"line\">         5        162 N      78760</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\">#     BLOCK# D       OBJD</span></span><br><span class=\"line\"><span class=\"comment\">---------- ---------- - ----------</span></span><br><span class=\"line\">         5        128 N      78760</span><br><span class=\"line\">         5        170 N      78760</span><br><span class=\"line\"></span><br><span class=\"line\">24 rows selected.</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>终于看到了想要的结果，总结一下吧，直接路径下高水位的推进大概如下图的样子：</p>\n</blockquote>\n<p><img alt data-src=\"http://oaowhilvu.bkt.clouddn.com/direct.png\"></p>\n<blockquote>\n<p>不知道大家有没有注意到，直接路径插入完后再读入buffer中居然是个脏块，这是不是跟延迟提交清除有关呢？我们以后再慢慢分析！</p>\n</blockquote>\n"},{"date":"2014-07-22T07:10:00.000Z","title":"linux+oracle兼容列表","_content":"\n>linux+oracle兼容列表\n\n![](http://oaowhilvu.bkt.clouddn.com/linux+oracle%E5%85%BC%E5%AE%B9%E5%88%97%E8%A1%A8.png)\n","source":"_posts/oracle/architecture/linux+oracle-compatibility-list.md","raw":"---\ndate: 2014-07-22 15:10\ntags: oracle\ntitle: linux+oracle兼容列表\ncategories: oracle\n---\n\n>linux+oracle兼容列表\n\n![](http://oaowhilvu.bkt.clouddn.com/linux+oracle%E5%85%BC%E5%AE%B9%E5%88%97%E8%A1%A8.png)\n","slug":"oracle/architecture/linux+oracle-compatibility-list","published":1,"updated":"2019-07-21T05:01:58.585Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjychzpxc0001fn0ewt3mzsuu","content":"<blockquote>\n<p>linux+oracle兼容列表</p>\n</blockquote>\n<p><img alt data-src=\"http://oaowhilvu.bkt.clouddn.com/linux+oracle%E5%85%BC%E5%AE%B9%E5%88%97%E8%A1%A8.png\"></p>\n","site":{"data":{"styles":"","footer":"<div class=\"footer-custom\">\nTheme source code <span class=\"exturl theme-link\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvaGV4by10aGVtZS1uZXh0\">here</span><br>\nWebsite source code <span class=\"exturl theme-link\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvdGhlbWUtbmV4dC5vcmc=\">here</span>\n</div>\n"}},"excerpt":"","more":"<blockquote>\n<p>linux+oracle兼容列表</p>\n</blockquote>\n<p><img alt data-src=\"http://oaowhilvu.bkt.clouddn.com/linux+oracle%E5%85%BC%E5%AE%B9%E5%88%97%E8%A1%A8.png\"></p>\n"},{"date":"2015-09-25T06:51:00.000Z","title":"ASSM三级位图结构与高水位的探究（上）","_content":"\n#ASSM三级位图结构与高水位的探究\n>三级位图\n\nOracle9i在本地表空管理(LMT)的基础上，对段空间管理也引入了位图管理（Segment Space Management Auto）来取代原来的freelist管理方式（Segment Space Management Manual）。\n但是默认system和undo表空间仍然是MSSM的管理方式，本文主要探究ASSM管理方式下，段的三级位图结构和高水位推进的关系 先来看\nASSM管理方式下的三级位图结构图：\n\n![](http://oaowhilvu.bkt.clouddn.com/%E4%B8%89%E7%BA%A7%E4%BD%8D%E5%9B%BE.jpg)\n*注：此图来源于网络*\n一个段被创建之后，段头其实是一个L3块，在我的试验中，一个1M固定区大小，block为8K的表空间，创建的第一个段第0个区，前两个块是L1（128,129号块），第三个是L2（130号块），第四个是L3（131号块），前128个块是数据文件头，本文不讨论。\n当数据被插入的时候，oracle根据连接进来的session，做hash运算，随机选择一个L3（如果有多个的话），再随机选择一个L2，接下来在该L2下随机选择一个L1，再从L1中管理的block里面随机选择一个块将数据插入，不同的session经过hash之后，最后落到block时已经是很分散的了，不会产生很多和会话同时往一个block中插数据申请独占buffer pin，而造成大量buffer busy waits的情况，这就是ASSM号称支持大并发插入的原理所在，但是事实上真的如此么？我们来一探究竟！\n>实验环境\n\n```\nOS:REDHAT6.5 X64\nDB VERSION:11.2.0.4\n```\n>首先，创建一个1M区大小的表空间，并在上面创建一张表，此表创建了4个空间很大的字段，目的是要一行占满一个block，便于观察结果\n\n```sql\nSQL> select file#,NAME,BYTES/1024/1204 from v$datafile;\n\n     FILE# NAME                                                                             BYTES/1024/1204\n---------- -------------------------------------------------------------------------------- ---------------\n         1 +DATA/min/datafile/system.256.854775095                                               637.873754\n         2 +DATA/min/datafile/sysaux.257.854775097                                               484.784053\n         3 +DATA/min/datafile/undotbs1.258.854775097                                             187.109635\n         4 +DATA/min/datafile/users.259.854775097                                                103.122924\n\nSQL> create tablespace lp datafile '+DATA/min/datafile/lp.dbf' size 2048M uniform size 1m;\n\nTablespace created.\n\nSQL> select file#,NAME,BYTES/1024/1204 from v$datafile;\n\n     FILE# NAME                                                                             BYTES/1024/1204\n---------- -------------------------------------------------------------------------------- ---------------\n         1 +DATA/min/datafile/system.256.854775095                                               637.873754\n         2 +DATA/min/datafile/sysaux.257.854775097                                               484.784053\n         3 +DATA/min/datafile/undotbs1.258.854775097                                             187.109635\n         4 +DATA/min/datafile/users.259.854775097                                                103.122924\n         5 +DATA/min/datafile/lp.dbf                                                              1741.8206\n\nSQL> create table lp (id number,des1 char(2000),des2 char(2000),des3 char(2000),des4 char(500)) tablespace lp;\n\nTable created.\n```\n\n>观察新建的表所占区\n\n```sql\nSQL> col SEGMENT_NAME for a30\nSQL> col des1 for a1\nSQL> col des2 for a1\nSQL> col des3 for a1\nSQL> col des4 for a1\nSQL> set line 200\nSQL> select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID, BLOCKS from dba_extents where segment_name='LP';\n\nSEGMENT_NAME                    EXTENT_ID    FILE_ID   BLOCK_ID     BLOCKS\n------------------------------ ---------- ---------- ---------- ----------\nLP                                      0          5        128        128\n```\n\n>此表是5号文件，拥有1个区，block从128号开始，接下来我们插入一条数据，并dump出段头进行观察\n\n```sql\nSQL> insert into lp values(1,'a','a','a','a');\n\n1 row created.\n\nSQL> commit;\n\nCommit complete.\n\nSQL> select segment_name ,HEADER_FILE,HEADER_BLOCK from dba_segments where segment_name='LP';\n\nSEGMENT_NAME                   HEADER_FILE HEADER_BLOCK\n------------------------------ ----------- ------------\nLP                                       5          131\n\n\nSQL> alter system checkpoint;\n\nSystem altered.\n```\n\n>LP的段头是5号文件，131号块，进行dump\n\n```sql\nSQL> alter system dump datafile 5 block 131;\n\nSQL> col value for a65\nSQL> select *  from v$diag_info;\n\n   INST_ID NAME                                                                             VALUE\n---------- -------------------------------------------------------------------------------- -----------------------------------------------------------------\n         1 Diag Enabled                                                                     TRUE\n         1 ADR Base                                                                         /u01/app/oracle\n         1 ADR Home                                                                         /u01/app/oracle/diag/rdbms/min/min\n         1 Diag Trace                                                                       /u01/app/oracle/diag/rdbms/min/min/trace\n         1 Diag Alert                                                                       /u01/app/oracle/diag/rdbms/min/min/alert\n         1 Diag Incident                                                                    /u01/app/oracle/diag/rdbms/min/min/incident\n         1 Diag Cdump                                                                       /u01/app/oracle/diag/rdbms/min/min/cdump\n         1 Health Monitor                                                                   /u01/app/oracle/diag/rdbms/min/min/hm\n         1 Default Trace File                                                               /u01/app/oracle/diag/rdbms/min/min/trace/min_ora_2835.trc\n         1 Active Problem Count                                                             0\n         1 Active Incident Count                                                            0\n\n11 rows selected.\n```\n\n>观察trc文件min_ora_2835.trc\n\n```\nBlock dump from disk:\nbuffer tsn: 8 rdba: 0x01400083 (5/131)\nscn: 0x0000.00140d51 seq: 0x01 flg: 0x04 tail: 0x0d512301\nfrmt: 0x02 chkval: 0xfd8a type: 0x23=PAGETABLE SEGMENT HEADER\nHex dump of block: st=0, typ_found=1\n\n\n\nExtent Control Header\n  -----------------------------------------------------------------\n  Extent Header:: spare1: 0      spare2: 0      #extents: 1      #blocks: 128   \n                  last map  0x00000000  #maps: 0      offset: 2716  \n      Highwater::  0x014000c0  ext#: 0      blk#: 64     ext size: 128   \n  #blocks in seg. hdr's freelists: 0     \n  #blocks below: 60    \n  mapblk  0x00000000  offset: 0     \n                   Unlocked\n  --------------------------------------------------------\n  Low HighWater Mark :\n      Highwater::  0x01400084  ext#: 0      blk#: 4      ext size: 128   \n  #blocks in seg. hdr's freelists: 0     \n  #blocks below: 0     \n  mapblk  0x00000000  offset: 0     \n  Level 1 BMB for High HWM block: 0x01400080\n  Level 1 BMB for Low HWM block: 0x01400080\n  --------------------------------------------------------\n  Segment Type: 1 nl2: 1      blksz: 8192   fbsz: 0      \n  L2 Array start offset:  0x00001434\n  First Level 3 BMB:  0x00000000\n  L2 Hint for inserts:  0x01400082\n  Last Level 1 BMB:  0x01400081\n  Last Level II BMB:  0x01400082\n  Last Level III BMB:  0x00000000\n     Map Header:: next  0x00000000  #extents: 1    obj#: 87596  flag: 0x10000000\n  Inc # 0\n  Extent Map\n  -----------------------------------------------------------------\n   0x01400080  length: 128   \n\n  Auxillary Map\n  --------------------------------------------------------\n   Extent 0     :  L1 dba:  0x01400080 Data dba:  0x01400084\n  --------------------------------------------------------\n\nSecond Level Bitmap block DBAs\n   --------------------------------------------------------\n   DBA 1:   0x01400082\n\nEnd dump data blocks tsn: 8 file#: 5 minblk 131 maxblk 131\n```\n\n>很容易发现这是一个PAGETABLE SEGMENT HEADER块，Extent Map中只有一个区，另外在尾部有一个指向二级位图块的地址0x01400082，这是数据块地址的二进制用十六进制来表示，我们来将其转化成直观一点的信息\n\n```sql\nSQL> select dbms_utility.data_block_address_file(to_number('01400082', 'xxxxxxxx')) file#,\n  2 dbms_utility.data_block_address_block(to_number('01400082', 'xxxxxxxx')) block#\n  3 from dual;\n\n     FILE# BLOCK#\n---------- ----------\n         5 130\n```\n\n> 依样将5号文件130号块的内容dump出来\n\n```\nBlock dump from disk:\nbuffer tsn: 8 rdba: 0x01400082 (5/130)\nscn: 0x0000.00140a45 seq: 0x02 flg: 0x04 tail: 0x0a452102\nfrmt: 0x02 chkval: 0xd119 type: 0x21=SECOND LEVEL BITMAP BLOCK\nHex dump of block: st=0, typ_found=1\n\n\nDump of Second Level Bitmap Block\n   number: 2       nfree: 2       ffree: 0      pdba:     0x01400083\n   Inc #: 0 Objd: 87596\n  opcode:0\n xid:\n  L1 Ranges :\n  --------------------------------------------------------\n   0x01400080  Free: 5 Inst: 1\n   0x01400081  Free: 5 Inst: 1\n\n  --------------------------------------------------------\nEnd dump data blocks tsn: 8 file#: 5 minblk 130 maxblk 130\n```\n\n>可以发现这是一个二级位图块，并从其中找到了2个L1块的地址，我们来看第一个L1\n\n```\nBlock dump from disk:\nbuffer tsn: 8 rdba: 0x01400080 (5/128)\nscn: 0x0000.00140d51 seq: 0x03 flg: 0x04 tail: 0x0d512003\nfrmt: 0x02 chkval: 0xe697 type: 0x20=FIRST LEVEL BITMAP BLOCK\nHex dump of block: st=0, typ_found=1\n\nDBA Ranges :\n  --------------------------------------------------------\n   0x01400080  Length: 64     Offset: 0      \n\n   0:Metadata   1:Metadata   2:Metadata   3:Metadata\n   4:unformatted   5:unformatted   6:unformatted   7:unformatted\n   8:unformatted   9:unformatted   10:unformatted   11:unformatted\n   12:unformatted   13:unformatted   14:unformatted   15:unformatted\n   16:75-100% free   17:75-100% free   18:75-100% free   19:75-100% free\n   20:75-100% free   21:75-100% free   22:75-100% free   23:75-100% free\n   24:75-100% free   25:75-100% free   26:75-100% free   27:75-100% free\n   28:75-100% free   29:75-100% free   30:75-100% free   31:0-25% free\n   32:unformatted   33:unformatted   34:unformatted   35:unformatted\n   36:unformatted   37:unformatted   38:unformatted   39:unformatted\n   40:unformatted   41:unformatted   42:unformatted   43:unformatted\n   44:unformatted   45:unformatted   46:unformatted   47:unformatted\n   48:unformatted   49:unformatted   50:unformatted   51:unformatted\n   52:unformatted   53:unformatted   54:unformatted   55:unformatted\n   56:unformatted   57:unformatted   58:unformatted   59:unformatted\n   60:unformatted   61:unformatted   62:unformatted   63:unformatted\n  --------------------------------------------------------\nEnd dump data blocks tsn: 8 file#: 5 minblk 128 maxblk 128\n```\n\n>无疑这是一个L1块，里面挂了64个数据块，因为我之前插入了一行数据，oracle已经格式化了一部分，并向其中一个块插入了数据，但是没达到我们的效果，被插入的块还显示0-25%的空闲，我们要的是full的状态，说明我们构造的数据不够大，没关系，我们修改一下pctfree就可以了，另外我们可以发现这个区是1M，有2个L1，每个L1里有64个数据块，接下来修改pctfree\n\n```sql\nSQL> alter table lp pctfree 24;\n\nTable altered.\n\nSQL> select TABLE_NAME,PCT_FREE from dba_tables where table_name='LP';\n\nTABLE_NAME                       PCT_FREE\n------------------------------ ----------\nLP                                     24\n\nSQL> insert into lp values(2,'a','a','a','a');\n\n1 row created.\n\nSQL> commit;\n\nCommit complete.\n--手动触发检查点将内存中的块刷新到磁盘，本文每次dump之前都会做这个操作，以保证磁盘和内存的内容一致\nSQL> alter system checkpoint;\n\nSystem altered.\n```\n\n>我们再看128号块\n\n```\nDBA Ranges :\n  --------------------------------------------------------\n   0x01400080  Length: 64     Offset: 0      \n\n   0:Metadata   1:Metadata   2:Metadata   3:Metadata\n   4:unformatted   5:unformatted   6:unformatted   7:unformatted\n   8:unformatted   9:unformatted   10:unformatted   11:unformatted\n   12:unformatted   13:unformatted   14:unformatted   15:unformatted\n   16:75-100% free   17:75-100% free   18:75-100% free   19:75-100% free\n   20:75-100% free   21:75-100% free   22:75-100% free   23:75-100% free\n   24:75-100% free   25:75-100% free   26:75-100% free   27:75-100% free\n   28:75-100% free   29:75-100% free   30:75-100% free   31:0-25% free\n   32:75-100% free   33:75-100% free   34:75-100% free   <font color='red'>35:FULL</font>\n   36:75-100% free   37:75-100% free   38:75-100% free   39:75-100% free\n   40:75-100% free   41:75-100% free   42:75-100% free   43:75-100% free\n   44:75-100% free   45:75-100% free   46:75-100% free   47:75-100% free\n   48:unformatted   49:unformatted   50:unformatted   51:unformatted\n   52:unformatted   53:unformatted   54:unformatted   55:unformatted\n   56:unformatted   57:unformatted   58:unformatted   59:unformatted\n   60:unformatted   61:unformatted   62:unformatted   63:unformatted\n  --------------------------------------------------------\nEnd dump data blocks tsn: 8 file#: 5 minblk 128 maxblk 128\n```\n\n>已经是我们想的结果了，到这里我们再来看一下另外一个L1吧，dump129号块\n\n```\nDBA Ranges :\n  --------------------------------------------------------\n   0x014000c0  Length: 64     Offset: 0      \n\n   0:unformatted   1:unformatted   2:unformatted   3:unformatted\n   4:unformatted   5:unformatted   6:unformatted   7:unformatted\n   8:unformatted   9:unformatted   10:unformatted   11:unformatted\n   12:unformatted   13:unformatted   14:unformatted   15:unformatted\n   16:unformatted   17:unformatted   18:unformatted   19:unformatted\n   20:unformatted   21:unformatted   22:unformatted   23:unformatted\n   24:unformatted   25:unformatted   26:unformatted   27:unformatted\n   28:unformatted   29:unformatted   30:unformatted   31:unformatted\n   32:unformatted   33:unformatted   34:unformatted   35:unformatted\n   36:unformatted   37:unformatted   38:unformatted   39:unformatted\n   40:unformatted   41:unformatted   42:unformatted   43:unformatted\n   44:unformatted   45:unformatted   46:unformatted   47:unformatted\n   48:unformatted   49:unformatted   50:unformatted   51:unformatted\n   52:unformatted   53:unformatted   54:unformatted   55:unformatted\n   56:unformatted   57:unformatted   58:unformatted   59:unformatted\n   60:unformatted   61:unformatted   62:unformatted   63:unformatted\n  --------------------------------------------------------\nEnd dump data blocks tsn: 8 file#: 5 minblk 129 maxblk 129\n```\n\n>全是未格式化的块，试一试并发插入，这里不模拟真正的并发了，只是开不同的session来进行插入\n\n```sql\nSQL> insert into lp values(3,'a','a','a','a');\n\n1 row created.\n\nSQL> insert into lp values(4,'a','a','a','a');\n\n1 row created.\n\nSQL> insert into lp values(5,'a','a','a','a');\n\n1 row created.\n\nSQL> insert into lp values(6,'a','a','a','a');\n\n1 row created.\n\nSQL> insert into lp values(7,'a','a','a','a');\n\n1 row created.\n\n--单独session5条\n\nSQL> select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp;\n\nDBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)\n------------------------------------ ------------------------------------\n                                   5                                  158\n                                   5                                  159\n                                   5                                  163\n                                   5                                  167\n                                   5                                  171\n                                   5                                  172\n                                   5                                  174\n                                   5                                  175\n                                   5                                  179\n                                   5                                  183\n                                   5                                  187\n                                   5                                  191\n\n12 rows selected.\n```\n\n>一个单独的session里插入了5条，另外5个单独的session里各插一条，发现规律了么，插入的块只在132和192之间，我们分别看看两个L1\n\n```\nSQL> alter system checkpoint;\n\nSystem altered.\n\n\n  DBA Ranges :\n  --------------------------------------------------------\n   0x01400080  Length: 64     Offset: 0      \n\n   0:Metadata   1:Metadata   2:Metadata   3:Metadata\n   4:unformatted   5:unformatted   6:unformatted   7:unformatted\n   8:unformatted   9:unformatted   10:unformatted   11:unformatted\n   12:unformatted   13:unformatted   14:unformatted   15:unformatted\n   16:75-100% free   17:75-100% free   18:75-100% free   19:75-100% free\n   20:75-100% free   21:75-100% free   22:75-100% free   23:75-100% free\n   24:75-100% free   25:75-100% free   26:75-100% free   27:75-100% free\n   28:75-100% free   29:75-100% free   30:FULL   31:0-25% free\n   32:75-100% free   33:75-100% free   34:75-100% free   35:FULL\n   36:75-100% free   37:75-100% free   38:75-100% free   39:FULL\n   40:75-100% free   41:75-100% free   42:75-100% free   43:FULL\n   44:FULL   45:75-100% free   46:FULL   47:FULL\n   48:75-100% free   49:75-100% free   50:75-100% free   51:FULL\n   52:75-100% free   53:75-100% free   54:75-100% free   55:FULL\n   56:75-100% free   57:75-100% free   58:75-100% free   59:FULL\n   60:75-100% free   61:75-100% free   62:75-100% free   63:FULL\n  --------------------------------------------------------\nEnd dump data blocks tsn: 8 file#: 5 minblk 128 maxblk 128\n\n********************************************************************\n看一下第二个L1\n\nDBA Ranges :\n  --------------------------------------------------------\n   0x014000c0  Length: 64     Offset: 0      \n\n   0:unformatted   1:unformatted   2:unformatted   3:unformatted\n   4:unformatted   5:unformatted   6:unformatted   7:unformatted\n   8:unformatted   9:unformatted   10:unformatted   11:unformatted\n   12:unformatted   13:unformatted   14:unformatted   15:unformatted\n   16:unformatted   17:unformatted   18:unformatted   19:unformatted\n   20:unformatted   21:unformatted   22:unformatted   23:unformatted\n   24:unformatted   25:unformatted   26:unformatted   27:unformatted\n   28:unformatted   29:unformatted   30:unformatted   31:unformatted\n   32:unformatted   33:unformatted   34:unformatted   35:unformatted\n   36:unformatted   37:unformatted   38:unformatted   39:unformatted\n   40:unformatted   41:unformatted   42:unformatted   43:unformatted\n   44:unformatted   45:unformatted   46:unformatted   47:unformatted\n   48:unformatted   49:unformatted   50:unformatted   51:unformatted\n   52:unformatted   53:unformatted   54:unformatted   55:unformatted\n   56:unformatted   57:unformatted   58:unformatted   59:unformatted\n   60:unformatted   61:unformatted   62:unformatted   63:unformatted\n  --------------------------------------------------------\nEnd dump data blocks tsn: 8 file#: 5 minblk 129 maxblk 129\n```\n\n>这说明只在第一个L1里面随机，那为什么L2下挂了2个L1，我插入了10条却没有一条随机到第二个L1块呢？答案是高水位，这是vage大师已经论证过的了，偶在这里仅为见证一下~~，好了，还记得L3里的高水位信息么？\n\n\n```\nExtent Control Header\n  -----------------------------------------------------------------\n  Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928\n                  last map  0x00000000  #maps: 0      offset: 2716  \n      Highwater::  0x014000c0  ext#: 0      blk#: 64     ext size: 128   \n  #blocks in seg. hdr's freelists: 0     \n  #blocks below: 60    \n  mapblk  0x00000000  offset: 0\n```\n\n>Highwater::  0x014000c0是哪个块呢？\n\n```sql\n  SQL> select dbms_utility.data_block_address_file(to_number('014000c0', 'xxxxxxxx')) file#,\n  2 dbms_utility.data_block_address_block(to_number('014000c0', 'xxxxxxxx')) block#\n  3 from dual;\n\n     FILE# BLOCK#\n---------- ----------\n         5 192\n```\n\n >这是第二个L1管理的第一个块，可见数据的插入只在高水位之下进行（直接路径插入除外），此时的状态如下：\n\n\n![](http://oaowhilvu.bkt.clouddn.com/0%E4%B8%AAextent.png)\n\n>那么L1里面只会有64个块么？高水位永远都会指向L1的最后一个块么？我们继续剖析！\n首先给LP表多分配一些区\n\n```sql\nSQL> alter table lp allocate extent(size 100m);\n\nTable altered.\n\nSQL> select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID, BLOCKS from dba_extents where segment_name='LP';\n\nSEGMENT_NAME                    EXTENT_ID    FILE_ID   BLOCK_ID     BLOCKS\n------------------------------ ---------- ---------- ---------- ----------\nLP                                      0          5        128        128\nLP                                      1          5        256        128\nLP                                      2          5        384        128\nLP                                      3          5        512        128\nLP                                      4          5        640        128\nLP                                      5          5        768        128\nLP                                      6          5        896        128\nLP                                      7          5       1024        128\nLP                                      8          5       1152        128\nLP                                      9          5       1280        128\nLP                                     10          5       1408        128\nLP                                     11          5       1536        128\nLP                                     12          5       1664        128\nLP                                     13          5       1792        128\nLP                                     14          5       1920        128\nLP                                     15          5       2048        128\nLP                                     16          5       2176        128\nLP                                     17          5       2304        128\nLP                                     18          5       2432        128\nLP                                     19          5       2560        128\nLP                                     20          5       2688        128\nLP                                     21          5       2816        128\nLP                                     22          5       2944        128\nLP                                     23          5       3072        128\nLP                                     24          5       3200        128\nLP                                     25          5       3328        128\nLP                                     26          5       3456        128\nLP                                     27          5       3584        128\nLP                                     28          5       3712        128\nLP                                     29          5       3840        128\nLP                                     30          5       3968        128\nLP                                     31          5       4096        128\nLP                                     32          5       4224        128\nLP                                     33          5       4352        128\nLP                                     34          5       4480        128\nLP                                     35          5       4608        128\nLP                                     36          5       4736        128\nLP                                     37          5       4864        128\nLP                                     38          5       4992        128\nLP                                     39          5       5120        128\nLP                                     40          5       5248        128\nLP                                     41          5       5376        128\nLP                                     42          5       5504        128\nLP                                     43          5       5632        128\nLP                                     44          5       5760        128\nLP                                     45          5       5888        128\nLP                                     46          5       6016        128\nLP                                     47          5       6144        128\nLP                                     48          5       6272        128\nLP                                     49          5       6400        128\nLP                                     50          5       6528        128\nLP                                     51          5       6656        128\nLP                                     52          5       6784        128\nLP                                     53          5       6912        128\nLP                                     54          5       7040        128\nLP                                     55          5       7168        128\nLP                                     56          5       7296        128\nLP                                     57          5       7424        128\nLP                                     58          5       7552        128\nLP                                     59          5       7680        128\nLP                                     60          5       7808        128\nLP                                     61          5       7936        128\nLP                                     62          5       8064        128\nLP                                     63          5       8192        128\nLP                                     64          5       8320        128\nLP                                     65          5       8448        128\nLP                                     66          5       8576        128\nLP                                     67          5       8704        128\nLP                                     68          5       8832        128\nLP                                     69          5       8960        128\nLP                                     70          5       9088        128\nLP                                     71          5       9216        128\nLP                                     72          5       9344        128\nLP                                     73          5       9472        128\nLP                                     74          5       9600        128\nLP                                     75          5       9728        128\nLP                                     76          5       9856        128\nLP                                     77          5       9984        128\nLP                                     78          5      10112        128\nLP                                     79          5      10240        128\nLP                                     80          5      10368        128\nLP                                     81          5      10496        128\nLP                                     82          5      10624        128\nLP                                     83          5      10752        128\nLP                                     84          5      10880        128\nLP                                     85          5      11008        128\nLP                                     86          5      11136        128\nLP                                     87          5      11264        128\nLP                                     88          5      11392        128\nLP                                     89          5      11520        128\nLP                                     90          5      11648        128\nLP                                     91          5      11776        128\nLP                                     92          5      11904        128\nLP                                     93          5      12032        128\nLP                                     94          5      12160        128\nLP                                     95          5      12288        128\nLP                                     96          5      12416        128\nLP                                     97          5      12544        128\nLP                                     98          5      12672        128\nLP                                     99          5      12800        128\nLP                                    100          5      12928        128\n\n101 rows selected.\n```\n\n>我分配了100个区，加上原来的一共101个，现在我们看看L3段头里面的内容\n\n```\nExtent Control Header\n  -----------------------------------------------------------------\n  Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928\n                  last map  0x00000000  #maps: 0      offset: 2716  \n      Highwater::  0x014000c0  ext#: 0      blk#: 64     ext size: 128   \n  #blocks in seg. hdr's freelists: 0     \n  #blocks below: 60    \n  mapblk  0x00000000  offset: 0     \n\n\nExtent Map\n  -----------------------------------------------------------------\n   0x01400080  length: 128   \n   0x01400100  length: 128   \n   0x01400180  length: 128   \n   0x01400200  length: 128   \n   0x01400280  length: 128   \n   0x01400300  length: 128   \n   0x01400380  length: 128   \n   0x01400400  length: 128   \n   0x01400480  length: 128   \n   0x01400500  length: 128   \n   0x01400580  length: 128   \n   0x01400600  length: 128   \n   0x01400680  length: 128   \n   0x01400700  length: 128   \n   0x01400780  length: 128   \n   0x01400800  length: 128   \n   0x01400880  length: 128   \n   0x01400900  length: 128   \n   0x01400980  length: 128   \n   0x01400a00  length: 128   \n   0x01400a80  length: 128   \n   0x01400b00  length: 128   \n   0x01400b80  length: 128   \n   0x01400c00  length: 128   \n   0x01400c80  length: 128   \n   0x01400d00  length: 128   \n   0x01400d80  length: 128   \n   0x01400e00  length: 128   \n   0x01400e80  length: 128   \n   0x01400f00  length: 128   \n   0x01400f80  length: 128   \n   0x01401000  length: 128   \n   0x01401080  length: 128   \n   0x01401100  length: 128   \n   0x01401180  length: 128   \n   0x01401200  length: 128   \n   0x01401280  length: 128   \n   0x01401300  length: 128   \n   0x01401380  length: 128   \n   0x01401400  length: 128   \n   0x01401480  length: 128   \n   0x01401500  length: 128   \n   0x01401580  length: 128   \n   0x01401600  length: 128   \n   0x01401680  length: 128   \n   0x01401700  length: 128   \n   0x01401780  length: 128   \n   0x01401800  length: 128   \n   0x01401880  length: 128   \n   0x01401900  length: 128   \n   0x01401980  length: 128   \n   0x01401a00  length: 128   \n   0x01401a80  length: 128   \n   0x01401b00  length: 128   \n   0x01401b80  length: 128   \n   0x01401c00  length: 128   \n   0x01401c80  length: 128   \n   0x01401d00  length: 128   \n   0x01401d80  length: 128   \n   0x01401e00  length: 128   \n   0x01401e80  length: 128   \n   0x01401f00  length: 128   \n   0x01401f80  length: 128   \n   0x01402000  length: 128   \n   0x01402080  length: 128   \n   0x01402100  length: 128   \n   0x01402180  length: 128   \n   0x01402200  length: 128   \n   0x01402280  length: 128   \n   0x01402300  length: 128   \n   0x01402380  length: 128   \n   0x01402400  length: 128   \n   0x01402480  length: 128   \n   0x01402500  length: 128   \n   0x01402580  length: 128   \n   0x01402600  length: 128   \n   0x01402680  length: 128   \n   0x01402700  length: 128   \n   0x01402780  length: 128   \n   0x01402800  length: 128   \n   0x01402880  length: 128   \n   0x01402900  length: 128   \n   0x01402980  length: 128   \n   0x01402a00  length: 128   \n   0x01402a80  length: 128   \n   0x01402b00  length: 128   \n   0x01402b80  length: 128   \n   0x01402c00  length: 128   \n   0x01402c80  length: 128   \n   0x01402d00  length: 128   \n   0x01402d80  length: 128   \n   0x01402e00  length: 128   \n   0x01402e80  length: 128   \n   0x01402f00  length: 128   \n   0x01402f80  length: 128   \n   0x01403000  length: 128   \n   0x01403080  length: 128   \n   0x01403100  length: 128   \n   0x01403180  length: 128   \n   0x01403200  length: 128   \n   0x01403280  length: 128   \n\n  Auxillary Map\n  --------------------------------------------------------\n   Extent 0     :  L1 dba:  0x01400080 Data dba:  0x01400084\n   Extent 1     :  L1 dba:  0x01400100 Data dba:  0x01400102\n   Extent 2     :  L1 dba:  0x01400180 Data dba:  0x01400182\n   Extent 3     :  L1 dba:  0x01400200 Data dba:  0x01400202\n   Extent 4     :  L1 dba:  0x01400280 Data dba:  0x01400282\n   Extent 5     :  L1 dba:  0x01400300 Data dba:  0x01400302\n   Extent 6     :  L1 dba:  0x01400380 Data dba:  0x01400382\n   Extent 7     :  L1 dba:  0x01400400 Data dba:  0x01400402\n   Extent 8     :  L1 dba:  0x01400480 Data dba:  0x01400482\n   Extent 9     :  L1 dba:  0x01400500 Data dba:  0x01400502\n   Extent 10    :  L1 dba:  0x01400580 Data dba:  0x01400582\n   Extent 11    :  L1 dba:  0x01400600 Data dba:  0x01400602\n   Extent 12    :  L1 dba:  0x01400680 Data dba:  0x01400682\n   Extent 13    :  L1 dba:  0x01400700 Data dba:  0x01400702\n   Extent 14    :  L1 dba:  0x01400780 Data dba:  0x01400782\n   Extent 15    :  L1 dba:  0x01400800 Data dba:  0x01400802\n   Extent 16    :  L1 dba:  0x01400880 Data dba:  0x01400882\n   Extent 17    :  L1 dba:  0x01400900 Data dba:  0x01400902\n   Extent 18    :  L1 dba:  0x01400980 Data dba:  0x01400982\n   Extent 19    :  L1 dba:  0x01400a00 Data dba:  0x01400a02\n   Extent 20    :  L1 dba:  0x01400a80 Data dba:  0x01400a82\n   Extent 21    :  L1 dba:  0x01400b00 Data dba:  0x01400b02\n   Extent 22    :  L1 dba:  0x01400b80 Data dba:  0x01400b82\n   Extent 23    :  L1 dba:  0x01400c00 Data dba:  0x01400c02\n   Extent 24    :  L1 dba:  0x01400c80 Data dba:  0x01400c82\n   Extent 25    :  L1 dba:  0x01400d00 Data dba:  0x01400d02\n   Extent 26    :  L1 dba:  0x01400d80 Data dba:  0x01400d82\n   Extent 27    :  L1 dba:  0x01400e00 Data dba:  0x01400e02\n   Extent 28    :  L1 dba:  0x01400e80 Data dba:  0x01400e82\n   Extent 29    :  L1 dba:  0x01400f00 Data dba:  0x01400f02\n   Extent 30    :  L1 dba:  0x01400f80 Data dba:  0x01400f82\n   Extent 31    :  L1 dba:  0x01401000 Data dba:  0x01401002\n   Extent 32    :  L1 dba:  0x01401080 Data dba:  0x01401082\n   Extent 33    :  L1 dba:  0x01401100 Data dba:  0x01401102\n   Extent 34    :  L1 dba:  0x01401180 Data dba:  0x01401182\n   Extent 35    :  L1 dba:  0x01401200 Data dba:  0x01401202\n   Extent 36    :  L1 dba:  0x01401280 Data dba:  0x01401282\n   Extent 37    :  L1 dba:  0x01401300 Data dba:  0x01401302\n   Extent 38    :  L1 dba:  0x01401380 Data dba:  0x01401382\n   Extent 39    :  L1 dba:  0x01401400 Data dba:  0x01401402\n   Extent 40    :  L1 dba:  0x01401480 Data dba:  0x01401482\n   Extent 41    :  L1 dba:  0x01401500 Data dba:  0x01401502\n   Extent 42    :  L1 dba:  0x01401580 Data dba:  0x01401582\n   Extent 43    :  L1 dba:  0x01401600 Data dba:  0x01401602\n   Extent 44    :  L1 dba:  0x01401680 Data dba:  0x01401682\n   Extent 45    :  L1 dba:  0x01401700 Data dba:  0x01401702\n   Extent 46    :  L1 dba:  0x01401780 Data dba:  0x01401782\n   Extent 47    :  L1 dba:  0x01401800 Data dba:  0x01401802\n   Extent 48    :  L1 dba:  0x01401880 Data dba:  0x01401882\n   Extent 49    :  L1 dba:  0x01401900 Data dba:  0x01401902\n   Extent 50    :  L1 dba:  0x01401980 Data dba:  0x01401982\n   Extent 51    :  L1 dba:  0x01401a00 Data dba:  0x01401a02\n   Extent 52    :  L1 dba:  0x01401a80 Data dba:  0x01401a82\n   Extent 53    :  L1 dba:  0x01401b00 Data dba:  0x01401b02\n   Extent 54    :  L1 dba:  0x01401b80 Data dba:  0x01401b82\n   Extent 55    :  L1 dba:  0x01401c00 Data dba:  0x01401c02\n   Extent 56    :  L1 dba:  0x01401c80 Data dba:  0x01401c82\n   Extent 57    :  L1 dba:  0x01401d00 Data dba:  0x01401d02\n   Extent 58    :  L1 dba:  0x01401d80 Data dba:  0x01401d82\n   Extent 59    :  L1 dba:  0x01401e00 Data dba:  0x01401e02\n   Extent 60    :  L1 dba:  0x01401e80 Data dba:  0x01401e82\n   Extent 61    :  L1 dba:  0x01401f00 Data dba:  0x01401f02\n   Extent 62    :  L1 dba:  0x01401f80 Data dba:  0x01401f82\n   Extent 63    :  L1 dba:  0x01402000 Data dba:  0x01402001\n   Extent 64    :  L1 dba:  0x01402000 Data dba:  0x01402080\n   Extent 65    :  L1 dba:  0x01402100 Data dba:  0x01402101\n   Extent 66    :  L1 dba:  0x01402100 Data dba:  0x01402180\n   Extent 67    :  L1 dba:  0x01402200 Data dba:  0x01402201\n   Extent 68    :  L1 dba:  0x01402200 Data dba:  0x01402280\n   Extent 69    :  L1 dba:  0x01402300 Data dba:  0x01402301\n   Extent 70    :  L1 dba:  0x01402300 Data dba:  0x01402380\n   Extent 71    :  L1 dba:  0x01402400 Data dba:  0x01402401\n   Extent 72    :  L1 dba:  0x01402400 Data dba:  0x01402480\n   Extent 73    :  L1 dba:  0x01402500 Data dba:  0x01402501\n   Extent 74    :  L1 dba:  0x01402500 Data dba:  0x01402580\n   Extent 75    :  L1 dba:  0x01402600 Data dba:  0x01402601\n   Extent 76    :  L1 dba:  0x01402600 Data dba:  0x01402680\n   Extent 77    :  L1 dba:  0x01402700 Data dba:  0x01402701\n   Extent 78    :  L1 dba:  0x01402700 Data dba:  0x01402780\n   Extent 79    :  L1 dba:  0x01402800 Data dba:  0x01402801\n   Extent 80    :  L1 dba:  0x01402800 Data dba:  0x01402880\n   Extent 81    :  L1 dba:  0x01402900 Data dba:  0x01402901\n   Extent 82    :  L1 dba:  0x01402900 Data dba:  0x01402980\n   Extent 83    :  L1 dba:  0x01402a00 Data dba:  0x01402a01\n   Extent 84    :  L1 dba:  0x01402a00 Data dba:  0x01402a80\n   Extent 85    :  L1 dba:  0x01402b00 Data dba:  0x01402b01\n   Extent 86    :  L1 dba:  0x01402b00 Data dba:  0x01402b80\n   Extent 87    :  L1 dba:  0x01402c00 Data dba:  0x01402c01\n   Extent 88    :  L1 dba:  0x01402c00 Data dba:  0x01402c80\n   Extent 89    :  L1 dba:  0x01402d00 Data dba:  0x01402d01\n   Extent 90    :  L1 dba:  0x01402d00 Data dba:  0x01402d80\n   Extent 91    :  L1 dba:  0x01402e00 Data dba:  0x01402e01\n   Extent 92    :  L1 dba:  0x01402e00 Data dba:  0x01402e80\n   Extent 93    :  L1 dba:  0x01402f00 Data dba:  0x01402f01\n   Extent 94    :  L1 dba:  0x01402f00 Data dba:  0x01402f80\n   Extent 95    :  L1 dba:  0x01403000 Data dba:  0x01403001\n   Extent 96    :  L1 dba:  0x01403000 Data dba:  0x01403080\n   Extent 97    :  L1 dba:  0x01403100 Data dba:  0x01403101\n   Extent 98    :  L1 dba:  0x01403100 Data dba:  0x01403180\n   Extent 99    :  L1 dba:  0x01403200 Data dba:  0x01403201\n   Extent 100   :  L1 dba:  0x01403200 Data dba:  0x01403280\n  --------------------------------------------------------\n\n   Second Level Bitmap block DBAs\n   --------------------------------------------------------\n   DBA 1:   0x01400082\n\nEnd dump data blocks tsn: 8 file#: 5 minblk 131 maxblk 131   \n```\n\n>这里我们主要看Auxillary Map，里面记录了每个区所属的L1，不难发现从第64个区开始，64、65两个区的L1相同，这说明什么，说明L1下面挂了整整两个区的数据块，验证一下，将0x01402000块dump出来之后的内容：\n\n```sql\n  01402000  十进制 》20979712\n  SQL> select dbms_utility.data_block_address_file(20979712) Rfile#,dbms_utility.data_block_address_block(20979712) \"Block#\" from dual;\n\n    RFILE#     Block#\n---------- ----------\n         5       8192\n```\n\n```\n          DBA Ranges :\n  --------------------------------------------------------\n   0x01402000  Length: 128    Offset: 0      \n   0x01402080  Length: 128    Offset: 128    \n\n   0:Metadata   1:unformatted   2:unformatted   3:unformatted\n   4:unformatted   5:unformatted   6:unformatted   7:unformatted\n   8:unformatted   9:unformatted   10:unformatted   11:unformatted\n   12:unformatted   13:unformatted   14:unformatted   15:unformatted\n   16:unformatted   17:unformatted   18:unformatted   19:unformatted\n   20:unformatted   21:unformatted   22:unformatted   23:unformatted\n   24:unformatted   25:unformatted   26:unformatted   27:unformatted\n   28:unformatted   29:unformatted   30:unformatted   31:unformatted\n   32:unformatted   33:unformatted   34:unformatted   35:unformatted\n   36:unformatted   37:unformatted   38:unformatted   39:unformatted\n   40:unformatted   41:unformatted   42:unformatted   43:unformatted\n   44:unformatted   45:unformatted   46:unformatted   47:unformatted\n   48:unformatted   49:unformatted   50:unformatted   51:unformatted\n   52:unformatted   53:unformatted   54:unformatted   55:unformatted\n   56:unformatted   57:unformatted   58:unformatted   59:unformatted\n   60:unformatted   61:unformatted   62:unformatted   63:unformatted\n   64:unformatted   65:unformatted   66:unformatted   67:unformatted\n   68:unformatted   69:unformatted   70:unformatted   71:unformatted\n   72:unformatted   73:unformatted   74:unformatted   75:unformatted\n   76:unformatted   77:unformatted   78:unformatted   79:unformatted\n   80:unformatted   81:unformatted   82:unformatted   83:unformatted\n   84:unformatted   85:unformatted   86:unformatted   87:unformatted\n   88:unformatted   89:unformatted   90:unformatted   91:unformatted\n   92:unformatted   93:unformatted   94:unformatted   95:unformatted\n   96:unformatted   97:unformatted   98:unformatted   99:unformatted\n   100:unformatted   101:unformatted   102:unformatted   103:unformatted\n   104:unformatted   105:unformatted   106:unformatted   107:unformatted\n   108:unformatted   109:unformatted   110:unformatted   111:unformatted\n   112:unformatted   113:unformatted   114:unformatted   115:unformatted\n   116:unformatted   117:unformatted   118:unformatted   119:unformatted\n   120:unformatted   121:unformatted   122:unformatted   123:unformatted\n   124:unformatted   125:unformatted   126:unformatted   127:unformatted\n   128:unformatted   129:unformatted   130:unformatted   131:unformatted\n   132:unformatted   133:unformatted   134:unformatted   135:unformatted\n   136:unformatted   137:unformatted   138:unformatted   139:unformatted\n   140:unformatted   141:unformatted   142:unformatted   143:unformatted\n   144:unformatted   145:unformatted   146:unformatted   147:unformatted\n   148:unformatted   149:unformatted   150:unformatted   151:unformatted\n   152:unformatted   153:unformatted   154:unformatted   155:unformatted\n   156:unformatted   157:unformatted   158:unformatted   159:unformatted\n   160:unformatted   161:unformatted   162:unformatted   163:unformatted\n   164:unformatted   165:unformatted   166:unformatted   167:unformatted\n   168:unformatted   169:unformatted   170:unformatted   171:unformatted\n   172:unformatted   173:unformatted   174:unformatted   175:unformatted\n   176:unformatted   177:unformatted   178:unformatted   179:unformatted\n   180:unformatted   181:unformatted   182:unformatted   183:unformatted\n   184:unformatted   185:unformatted   186:unformatted   187:unformatted\n   188:unformatted   189:unformatted   190:unformatted   191:unformatted\n   192:unformatted   193:unformatted   194:unformatted   195:unformatted\n   196:unformatted   197:unformatted   198:unformatted   199:unformatted\n   200:unformatted   201:unformatted   202:unformatted   203:unformatted\n   204:unformatted   205:unformatted   206:unformatted   207:unformatted\n   208:unformatted   209:unformatted   210:unformatted   211:unformatted\n   212:unformatted   213:unformatted   214:unformatted   215:unformatted\n   216:unformatted   217:unformatted   218:unformatted   219:unformatted\n   220:unformatted   221:unformatted   222:unformatted   223:unformatted\n   224:unformatted   225:unformatted   226:unformatted   227:unformatted\n   228:unformatted   229:unformatted   230:unformatted   231:unformatted\n   232:unformatted   233:unformatted   234:unformatted   235:unformatted\n   236:unformatted   237:unformatted   238:unformatted   239:unformatted\n   240:unformatted   241:unformatted   242:unformatted   243:unformatted\n   244:unformatted   245:unformatted   246:unformatted   247:unformatted\n   248:unformatted   249:unformatted   250:unformatted   251:unformatted\n   252:unformatted   253:unformatted   254:unformatted   255:unformatted\n  --------------------------------------------------------\nEnd dump data blocks tsn: 8 file#: 5 minblk 8192 maxblk 8192\n```\n\n>256个块，2M 2个区，可见L1中块的数量会随着段大小的改变而做调整的，可以增大到1024个甚至更多，我在这里不去再做验证，将重点放在高水位上，根据我们之前观察到的现象，高水位在第二个L1的地一个块，也可说第一个L1的末端，那么现在的L1里有256个块，高水位是不是也会推进到这个L1的末端呢？很容易进行验证，将数据插满到这个L1的前几个块再去观察段头高水位的变化就行了，那么插多少条呢？再来计算一下，当前的L1是8192号块，前面一共63个区，每个区里面两个L1，加上第一个区里面的一个L2和L3，我们需要插满8192-63*2-2=8064\n\n```sql\ndeclare\ni number;\nbegin\nfor i in 1..8064 loop\ninsert into lp values(i,'a','a','a','a');\nend loop;\nend;\n/\n```\n\n>观察62号区的第二个L1，第一个L1的地址是0x01401f80，那么第二个就是01401f81，5号文件8065号块，dump出来的结果\n\n```\nDBA Ranges :\n  --------------------------------------------------------\n   0x01401fc0  Length: 64     Offset: 0      \n\n   0:FULL   1:FULL   2:FULL   3:FULL\n   4:FULL   5:FULL   6:FULL   7:FULL\n   8:FULL   9:FULL   10:FULL   11:FULL\n   12:FULL   13:FULL   14:FULL   15:FULL\n   16:FULL   17:FULL   18:FULL   19:FULL\n   20:FULL   21:FULL   22:FULL   23:FULL\n   24:FULL   25:FULL   26:FULL   27:FULL\n   28:FULL   29:FULL   30:FULL   31:FULL\n   32:FULL   33:FULL   34:FULL   35:FULL\n   36:FULL   37:FULL   38:FULL   39:FULL\n   40:FULL   41:FULL   42:FULL   43:FULL\n   44:FULL   45:FULL   46:FULL   47:FULL\n   48:FULL   49:FULL   50:FULL   51:FULL\n   52:FULL   53:FULL   54:FULL   55:FULL\n   56:FULL   57:FULL   58:FULL   59:FULL\n   60:FULL   61:FULL   62:FULL   63:FULL\n  --------------------------------------------------------\nEnd dump data blocks tsn: 8 file#: 5 minblk 8065 maxblk 8065\n```\n\n>居然全满了？再看8192号L1呢\n\n```\nDBA Ranges :\n  --------------------------------------------------------\n   0x01402000  Length: 128    Offset: 0      \n   0x01402080  Length: 128    Offset: 128    \n\n   0:Metadata   1:FULL   2:FULL   3:FULL\n   4:FULL   5:FULL   6:FULL   7:FULL\n   8:FULL   9:FULL   10:FULL   11:FULL\n   12:FULL   13:FULL   14:FULL   15:FULL\n   16:FULL   17:FULL   18:FULL   19:FULL\n   20:FULL   21:FULL   22:FULL   23:FULL\n   24:FULL   25:FULL   26:FULL   27:FULL\n   28:FULL   29:FULL   30:FULL   31:FULL\n   32:FULL   33:FULL   34:FULL   35:FULL\n   36:FULL   37:FULL   38:FULL   39:FULL\n   40:FULL   41:FULL   42:FULL   43:FULL\n   44:FULL   45:FULL   46:FULL   47:FULL\n   48:FULL   49:FULL   50:FULL   51:FULL\n   52:FULL   53:FULL   54:FULL   55:FULL\n   56:FULL   57:FULL   58:FULL   59:FULL\n   60:FULL   61:FULL   62:FULL   63:FULL\n   64:FULL   65:FULL   66:FULL   67:FULL\n   68:FULL   69:FULL   70:FULL   71:FULL\n   72:FULL   73:FULL   74:FULL   75:FULL\n   76:FULL   77:FULL   78:FULL   79:FULL\n   80:FULL   81:FULL   82:FULL   83:FULL\n   84:FULL   85:FULL   86:FULL   87:FULL\n   88:FULL   89:FULL   90:FULL   91:FULL\n   92:FULL   93:FULL   94:FULL   95:FULL\n   96:FULL   97:FULL   98:FULL   99:FULL\n   100:FULL   101:FULL   102:FULL   103:FULL\n   104:FULL   105:FULL   106:FULL   107:FULL\n   108:FULL   109:FULL   110:FULL   111:FULL\n   112:FULL   113:FULL   114:FULL   115:FULL\n   116:FULL   117:FULL   118:FULL   119:FULL\n   120:FULL   121:FULL   122:FULL   123:FULL\n   124:FULL   125:FULL   126:FULL   127:FULL\n   128:unformatted   129:unformatted   130:unformatted   131:unformatted\n   132:unformatted   133:unformatted   134:unformatted   135:unformatted\n   136:unformatted   137:unformatted   138:unformatted   139:unformatted\n   140:unformatted   141:unformatted   142:unformatted   143:unformatted\n   144:75-100% free   145:75-100% free   146:75-100% free   147:75-100% free\n   148:75-100% free   149:75-100% free   150:75-100% free   151:75-100% free\n   152:75-100% free   153:75-100% free   154:75-100% free   155:FULL\n   156:75-100% free   157:75-100% free   158:75-100% free   159:75-100% free\n   160:75-100% free   161:75-100% free   162:75-100% free   163:FULL\n   164:75-100% free   165:75-100% free   166:75-100% free   167:75-100% free\n   168:75-100% free   169:75-100% free   170:75-100% free   171:75-100% free\n   172:75-100% free   173:75-100% free   174:75-100% free   175:75-100% free\n   176:unformatted   177:unformatted   178:unformatted   179:unformatted\n   180:unformatted   181:unformatted   182:unformatted   183:unformatted\n   184:unformatted   185:unformatted   186:unformatted   187:unformatted\n   188:unformatted   189:unformatted   190:unformatted   191:unformatted\n   192:unformatted   193:unformatted   194:unformatted   195:unformatted\n   196:unformatted   197:unformatted   198:unformatted   199:unformatted\n   200:unformatted   201:unformatted   202:unformatted   203:unformatted\n   204:unformatted   205:unformatted   206:unformatted   207:unformatted\n   208:unformatted   209:unformatted   210:unformatted   211:unformatted\n   212:unformatted   213:unformatted   214:unformatted   215:unformatted\n   216:unformatted   217:unformatted   218:unformatted   219:unformatted\n   220:unformatted   221:unformatted   222:unformatted   223:unformatted\n   224:unformatted   225:unformatted   226:unformatted   227:unformatted\n   228:unformatted   229:unformatted   230:unformatted   231:unformatted\n   232:unformatted   233:unformatted   234:unformatted   235:unformatted\n   236:unformatted   237:unformatted   238:unformatted   239:unformatted\n   240:unformatted   241:unformatted   242:unformatted   243:unformatted\n   244:unformatted   245:unformatted   246:unformatted   247:unformatted\n   248:unformatted   249:unformatted   250:unformatted   251:unformatted\n   252:unformatted   253:unformatted   254:unformatted   255:unformatted\n  --------------------------------------------------------\nEnd dump data blocks tsn: 8 file#: 5 minblk 8192 maxblk 8192\n```\n\n>完蛋了，计算错误，L1下面的第二个区也已经被格式化了，看段头信息\n\n```\nExtent Control Header\n  -----------------------------------------------------------------\n  Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928\n                  last map  0x00000000  #maps: 0      offset: 2716  \n      Highwater::  0x01402100  ext#: 64     blk#: 128    ext size: 128   \n  #blocks in seg. hdr's freelists: 0     \n  #blocks below: 8191  \n  mapblk  0x00000000  offset: 64   \n```\n\n>果然高水位指到了第66个区的L1块地址，这会影响我们的判断，到底哪里出问题了呢？观察8192号块内容是后128个块里被插入了2条，前128个块全满，也就是说我多插了130个块，后来猛然醒悟，我使用DBA来计算的，忘记减去128个块的文件头了，这么一算结果相查差还是不大的，太马虎了，要不是因为马虎哥也能上清华北大了；然后该怎么办呢？重新来过？不用！既然这个L1推过头了，索性把它堆满，然后我们去观察下一个L1，这下就好计算了；\n\n```sql\ndeclare\ni number;\nbegin\nfor i in 1..126 loop\ninsert into lp values(i,'a','a','a','a');\nend loop;\nend;\n/\n```\n\n>观察8192号块\n\n```\n DBA Ranges :\n  --------------------------------------------------------\n   0x01402000  Length: 128    Offset: 0      \n   0x01402080  Length: 128    Offset: 128    \n\n   0:Metadata   1:FULL   2:FULL   3:FULL\n   4:FULL   5:FULL   6:FULL   7:FULL\n   8:FULL   9:FULL   10:FULL   11:FULL\n   12:FULL   13:FULL   14:FULL   15:FULL\n   16:FULL   17:FULL   18:FULL   19:FULL\n   20:FULL   21:FULL   22:FULL   23:FULL\n   24:FULL   25:FULL   26:FULL   27:FULL\n   28:FULL   29:FULL   30:FULL   31:FULL\n   32:FULL   33:FULL   34:FULL   35:FULL\n   36:FULL   37:FULL   38:FULL   39:FULL\n   40:FULL   41:FULL   42:FULL   43:FULL\n   44:FULL   45:FULL   46:FULL   47:FULL\n   48:FULL   49:FULL   50:FULL   51:FULL\n   52:FULL   53:FULL   54:FULL   55:FULL\n   56:FULL   57:FULL   58:FULL   59:FULL\n   60:FULL   61:FULL   62:FULL   63:FULL\n   64:FULL   65:FULL   66:FULL   67:FULL\n   68:FULL   69:FULL   70:FULL   71:FULL\n   72:FULL   73:FULL   74:FULL   75:FULL\n   76:FULL   77:FULL   78:FULL   79:FULL\n   80:FULL   81:FULL   82:FULL   83:FULL\n   84:FULL   85:FULL   86:FULL   87:FULL\n   88:FULL   89:FULL   90:FULL   91:FULL\n   92:FULL   93:FULL   94:FULL   95:FULL\n   96:FULL   97:FULL   98:FULL   99:FULL\n   100:FULL   101:FULL   102:FULL   103:FULL\n   104:FULL   105:FULL   106:FULL   107:FULL\n   108:FULL   109:FULL   110:FULL   111:FULL\n   112:FULL   113:FULL   114:FULL   115:FULL\n   116:FULL   117:FULL   118:FULL   119:FULL\n   120:FULL   121:FULL   122:FULL   123:FULL\n   124:FULL   125:FULL   126:FULL   127:FULL\n   128:FULL   129:FULL   130:FULL   131:FULL\n   132:FULL   133:FULL   134:FULL   135:FULL\n   136:FULL   137:FULL   138:FULL   139:FULL\n   140:FULL   141:FULL   142:FULL   143:FULL\n   144:FULL   145:FULL   146:FULL   147:FULL\n   148:FULL   149:FULL   150:FULL   151:FULL\n   152:FULL   153:FULL   154:FULL   155:FULL\n   156:FULL   157:FULL   158:FULL   159:FULL\n   160:FULL   161:FULL   162:FULL   163:FULL\n   164:FULL   165:FULL   166:FULL   167:FULL\n   168:FULL   169:FULL   170:FULL   171:FULL\n   172:FULL   173:FULL   174:FULL   175:FULL\n   176:FULL   177:FULL   178:FULL   179:FULL\n   180:FULL   181:FULL   182:FULL   183:FULL\n   184:FULL   185:FULL   186:FULL   187:FULL\n   188:FULL   189:FULL   190:FULL   191:FULL\n   192:FULL   193:FULL   194:FULL   195:FULL\n   196:FULL   197:FULL   198:FULL   199:FULL\n   200:FULL   201:FULL   202:FULL   203:FULL\n   204:FULL   205:FULL   206:FULL   207:FULL\n   208:FULL   209:FULL   210:FULL   211:FULL\n   212:FULL   213:FULL   214:FULL   215:FULL\n   216:FULL   217:FULL   218:FULL   219:FULL\n   220:FULL   221:FULL   222:FULL   223:FULL\n   224:FULL   225:FULL   226:FULL   227:FULL\n   228:FULL   229:FULL   230:FULL   231:FULL\n   232:FULL   233:FULL   234:FULL   235:FULL\n   236:FULL   237:FULL   238:FULL   239:FULL\n   240:FULL   241:FULL   242:FULL   243:FULL\n   244:FULL   245:FULL   246:FULL   247:FULL\n   248:FULL   249:FULL   250:FULL   251:FULL\n   252:FULL   253:FULL   254:FULL   255:FULL\n  --------------------------------------------------------\nEnd dump data blocks tsn: 8 file#: 5 minblk 8192 maxblk 8192\n```\n\n>已经全满了，这个时候我们再去看一下段头的高水位\n\n```\n Extent Control Header\n  -----------------------------------------------------------------\n  Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928\n                  last map  0x00000000  #maps: 0      offset: 2716  \n      Highwater::  0x01402100  ext#: 64     blk#: 128    ext size: 128   \n  #blocks in seg. hdr's freelists: 0     \n  #blocks below: 8191  \n  mapblk  0x00000000  offset: 64\n```\n\n>没有动，看来oracle也是事不到眼前不知道着急啊，来看一看下一个L1\n\n```sql\nSQL> select dbms_utility.data_block_address_file(to_number('01402100', 'xxxxxxxx')) file#,\n  2 dbms_utility.data_block_address_block(to_number('01402100', 'xxxxxxxx')) block#\n  3 from dual;\n\n     FILE# BLOCK#\n---------- ----------\n         5 8448\n```\n\n>这个L1是5号文件8448号块，dump出来\n\n```\n DBA Ranges :\n  --------------------------------------------------------\n   0x01402100  Length: 128    Offset: 0      \n   0x01402180  Length: 128    Offset: 128    \n\n   0:Metadata   1:unformatted   2:unformatted   3:unformatted\n   4:unformatted   5:unformatted   6:unformatted   7:unformatted\n   8:unformatted   9:unformatted   10:unformatted   11:unformatted\n   12:unformatted   13:unformatted   14:unformatted   15:unformatted\n   16:unformatted   17:unformatted   18:unformatted   19:unformatted\n   20:unformatted   21:unformatted   22:unformatted   23:unformatted\n   24:unformatted   25:unformatted   26:unformatted   27:unformatted\n   28:unformatted   29:unformatted   30:unformatted   31:unformatted\n   32:unformatted   33:unformatted   34:unformatted   35:unformatted\n   36:unformatted   37:unformatted   38:unformatted   39:unformatted\n   40:unformatted   41:unformatted   42:unformatted   43:unformatted\n   44:unformatted   45:unformatted   46:unformatted   47:unformatted\n   48:unformatted   49:unformatted   50:unformatted   51:unformatted\n   52:unformatted   53:unformatted   54:unformatted   55:unformatted\n   56:unformatted   57:unformatted   58:unformatted   59:unformatted\n   60:unformatted   61:unformatted   62:unformatted   63:unformatted\n   64:unformatted   65:unformatted   66:unformatted   67:unformatted\n   68:unformatted   69:unformatted   70:unformatted   71:unformatted\n   72:unformatted   73:unformatted   74:unformatted   75:unformatted\n   76:unformatted   77:unformatted   78:unformatted   79:unformatted\n   80:unformatted   81:unformatted   82:unformatted   83:unformatted\n   84:unformatted   85:unformatted   86:unformatted   87:unformatted\n   88:unformatted   89:unformatted   90:unformatted   91:unformatted\n   92:unformatted   93:unformatted   94:unformatted   95:unformatted\n   96:unformatted   97:unformatted   98:unformatted   99:unformatted\n   100:unformatted   101:unformatted   102:unformatted   103:unformatted\n   104:unformatted   105:unformatted   106:unformatted   107:unformatted\n   108:unformatted   109:unformatted   110:unformatted   111:unformatted\n   112:unformatted   113:unformatted   114:unformatted   115:unformatted\n   116:unformatted   117:unformatted   118:unformatted   119:unformatted\n   120:unformatted   121:unformatted   122:unformatted   123:unformatted\n   124:unformatted   125:unformatted   126:unformatted   127:unformatted\n   128:unformatted   129:unformatted   130:unformatted   131:unformatted\n   132:unformatted   133:unformatted   134:unformatted   135:unformatted\n   136:unformatted   137:unformatted   138:unformatted   139:unformatted\n   140:unformatted   141:unformatted   142:unformatted   143:unformatted\n   144:unformatted   145:unformatted   146:unformatted   147:unformatted\n   148:unformatted   149:unformatted   150:unformatted   151:unformatted\n   152:unformatted   153:unformatted   154:unformatted   155:unformatted\n   156:unformatted   157:unformatted   158:unformatted   159:unformatted\n   160:unformatted   161:unformatted   162:unformatted   163:unformatted\n   164:unformatted   165:unformatted   166:unformatted   167:unformatted\n   168:unformatted   169:unformatted   170:unformatted   171:unformatted\n   172:unformatted   173:unformatted   174:unformatted   175:unformatted\n   176:unformatted   177:unformatted   178:unformatted   179:unformatted\n   180:unformatted   181:unformatted   182:unformatted   183:unformatted\n   184:unformatted   185:unformatted   186:unformatted   187:unformatted\n   188:unformatted   189:unformatted   190:unformatted   191:unformatted\n   192:unformatted   193:unformatted   194:unformatted   195:unformatted\n   196:unformatted   197:unformatted   198:unformatted   199:unformatted\n   200:unformatted   201:unformatted   202:unformatted   203:unformatted\n   204:unformatted   205:unformatted   206:unformatted   207:unformatted\n   208:unformatted   209:unformatted   210:unformatted   211:unformatted\n   212:unformatted   213:unformatted   214:unformatted   215:unformatted\n   216:unformatted   217:unformatted   218:unformatted   219:unformatted\n   220:unformatted   221:unformatted   222:unformatted   223:unformatted\n   224:unformatted   225:unformatted   226:unformatted   227:unformatted\n   228:unformatted   229:unformatted   230:unformatted   231:unformatted\n   232:unformatted   233:unformatted   234:unformatted   235:unformatted\n   236:unformatted   237:unformatted   238:unformatted   239:unformatted\n   240:unformatted   241:unformatted   242:unformatted   243:unformatted\n   244:unformatted   245:unformatted   246:unformatted   247:unformatted\n   248:unformatted   249:unformatted   250:unformatted   251:unformatted\n   252:unformatted   253:unformatted   254:unformatted   255:unformatted\n  --------------------------------------------------------\nEnd dump data blocks tsn: 8 file#: 5 minblk 8448 maxblk 8448\n```\n\n>256个块，除了第一个是L1元数据之外，没有一个格式化的，这就达到了我们的目的，我现在要插入一条数据，迫使高水位推动，猜一下高水位会在哪？在L1管理的最后一个块后面么？\n看插入一行数据之后的8448号块\n\n```\nDBA Ranges :\n  --------------------------------------------------------\n   0x01402100  Length: 128    Offset: 0      \n   0x01402180  Length: 128    Offset: 128    \n\n   0:Metadata   1:unformatted   2:unformatted   3:unformatted\n   4:unformatted   5:unformatted   6:unformatted   7:unformatted\n   8:unformatted   9:unformatted   10:unformatted   11:unformatted\n   12:unformatted   13:unformatted   14:unformatted   15:unformatted\n   16:75-100% free   17:75-100% free   18:75-100% free   19:75-100% free\n   20:75-100% free   21:75-100% free   22:75-100% free   23:75-100% free\n   24:75-100% free   25:75-100% free   26:75-100% free   27:75-100% free\n   28:FULL   29:75-100% free   30:75-100% free   31:75-100% free\n   32:unformatted   33:unformatted   34:unformatted   35:unformatted\n   36:unformatted   37:unformatted   38:unformatted   39:unformatted\n   40:unformatted   41:unformatted   42:unformatted   43:unformatted\n   44:unformatted   45:unformatted   46:unformatted   47:unformatted\n   48:unformatted   49:unformatted   50:unformatted   51:unformatted\n   52:unformatted   53:unformatted   54:unformatted   55:unformatted\n   56:unformatted   57:unformatted   58:unformatted   59:unformatted\n   60:unformatted   61:unformatted   62:unformatted   63:unformatted\n   64:unformatted   65:unformatted   66:unformatted   67:unformatted\n   68:unformatted   69:unformatted   70:unformatted   71:unformatted\n   72:unformatted   73:unformatted   74:unformatted   75:unformatted\n   76:unformatted   77:unformatted   78:unformatted   79:unformatted\n   80:unformatted   81:unformatted   82:unformatted   83:unformatted\n   84:unformatted   85:unformatted   86:unformatted   87:unformatted\n   88:unformatted   89:unformatted   90:unformatted   91:unformatted\n   92:unformatted   93:unformatted   94:unformatted   95:unformatted\n   96:unformatted   97:unformatted   98:unformatted   99:unformatted\n   100:unformatted   101:unformatted   102:unformatted   103:unformatted\n   104:unformatted   105:unformatted   106:unformatted   107:unformatted\n   108:unformatted   109:unformatted   110:unformatted   111:unformatted\n   112:unformatted   113:unformatted   114:unformatted   115:unformatted\n   116:unformatted   117:unformatted   118:unformatted   119:unformatted\n   120:unformatted   121:unformatted   122:unformatted   123:unformatted\n   124:unformatted   125:unformatted   126:unformatted   127:unformatted\n   128:unformatted   129:unformatted   130:unformatted   131:unformatted\n   132:unformatted   133:unformatted   134:unformatted   135:unformatted\n   136:unformatted   137:unformatted   138:unformatted   139:unformatted\n   140:unformatted   141:unformatted   142:unformatted   143:unformatted\n   144:unformatted   145:unformatted   146:unformatted   147:unformatted\n   148:unformatted   149:unformatted   150:unformatted   151:unformatted\n   152:unformatted   153:unformatted   154:unformatted   155:unformatted\n   156:unformatted   157:unformatted   158:unformatted   159:unformatted\n   160:unformatted   161:unformatted   162:unformatted   163:unformatted\n   164:unformatted   165:unformatted   166:unformatted   167:unformatted\n   168:unformatted   169:unformatted   170:unformatted   171:unformatted\n   172:unformatted   173:unformatted   174:unformatted   175:unformatted\n   176:unformatted   177:unformatted   178:unformatted   179:unformatted\n   180:unformatted   181:unformatted   182:unformatted   183:unformatted\n   184:unformatted   185:unformatted   186:unformatted   187:unformatted\n   188:unformatted   189:unformatted   190:unformatted   191:unformatted\n   192:unformatted   193:unformatted   194:unformatted   195:unformatted\n   196:unformatted   197:unformatted   198:unformatted   199:unformatted\n   200:unformatted   201:unformatted   202:unformatted   203:unformatted\n   204:unformatted   205:unformatted   206:unformatted   207:unformatted\n   208:unformatted   209:unformatted   210:unformatted   211:unformatted\n   212:unformatted   213:unformatted   214:unformatted   215:unformatted\n   216:unformatted   217:unformatted   218:unformatted   219:unformatted\n   220:unformatted   221:unformatted   222:unformatted   223:unformatted\n   224:unformatted   225:unformatted   226:unformatted   227:unformatted\n   228:unformatted   229:unformatted   230:unformatted   231:unformatted\n   232:unformatted   233:unformatted   234:unformatted   235:unformatted\n   236:unformatted   237:unformatted   238:unformatted   239:unformatted\n   240:unformatted   241:unformatted   242:unformatted   243:unformatted\n   244:unformatted   245:unformatted   246:unformatted   247:unformatted\n   248:unformatted   249:unformatted   250:unformatted   251:unformatted\n   252:unformatted   253:unformatted   254:unformatted   255:unformatted\n  --------------------------------------------------------\nEnd dump data blocks tsn: 8 file#: 5 minblk 8448 maxblk 8448\n```\n\n>有一个块已经满了，揭晓答案的时候来了，dump出段头\n\n```\nExtent Control Header\n  -----------------------------------------------------------------\n  Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928\n                  last map  0x00000000  #maps: 0      offset: 2716  \n      Highwater::  0x01402180  ext#: 65     blk#: 128    ext size: 128   \n  #blocks in seg. hdr's freelists: 0     \n  #blocks below: 8318  \n  mapblk  0x00000000  offset: 65\n```\n\n>高水位是0x01402180，这个地址在哪呢？0x01402180比0x01402100多了十六进制80个块，就是十进制的128个块，仅仅是推动了一个区的大小，并不是一个L1的大小，这说明常规路径下插入高水位的推动是以L1和区中小的那个单位来推动的，就是L1小就推动L1里面所有块的大小，区小就推动一个区的大小，可见所谓的高并发并非像宣传的那样，还是受高水位的限制的，这个时候的区块大概像下面这个样子：\n\n![](http://oaowhilvu.bkt.clouddn.com/%E6%89%A9%E5%B1%95%E7%9A%84L1.png)\n\n>开几个session做下插入试试\n\n```sql\nSQL> select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp where trim(des1)='b';\n\n                                   5                                 8474\n                                   5                                 8482\n                                   5                                 8484\n                                   5                                 8488\n                                   5                                 8489\n                                   5                                 8490\n                                   5                                 8491\n                                   5                                 8492\n                                   5                                 8493\n                                   5                                 8494\n                                   5                                 8495\n                                   5                                 8496\n                                   5                                 8498\n                                   5                                 8500\n                                   5                                 8504\n                                   5                                 8506\n                                   5                                 8512\n                                   5                                 8514\n                                   5                                 8520\n                                   5                                 8522\n\n20 rows selected.\n```\n\n>全部是在高水位之下\n这个实验有一点值得思考，就是PCTFREE如何设置，在插入删除频繁的段，PCTFREE的值应该要远离三个百分比线，就是25%/50%/75%，避免频繁插入删除的时候块状态频繁改变，由full变为非full，如此就会修改L1块的内容，有可能造成buffer busy waits。\n而大家熟知的直接路径下的插入是直接在高水位之上插入并且绕过cache buffer的，这种情况下的高水位是如何推动的呢？我们再慢慢分析.\n","source":"_posts/oracle/architecture/ASSM1.md","raw":"---\ntags: oracle\ndate: 2015-09-25 14:51\ncategories: oracle\ntitle: ASSM三级位图结构与高水位的探究（上）\n---\n\n#ASSM三级位图结构与高水位的探究\n>三级位图\n\nOracle9i在本地表空管理(LMT)的基础上，对段空间管理也引入了位图管理（Segment Space Management Auto）来取代原来的freelist管理方式（Segment Space Management Manual）。\n但是默认system和undo表空间仍然是MSSM的管理方式，本文主要探究ASSM管理方式下，段的三级位图结构和高水位推进的关系 先来看\nASSM管理方式下的三级位图结构图：\n\n![](http://oaowhilvu.bkt.clouddn.com/%E4%B8%89%E7%BA%A7%E4%BD%8D%E5%9B%BE.jpg)\n*注：此图来源于网络*\n一个段被创建之后，段头其实是一个L3块，在我的试验中，一个1M固定区大小，block为8K的表空间，创建的第一个段第0个区，前两个块是L1（128,129号块），第三个是L2（130号块），第四个是L3（131号块），前128个块是数据文件头，本文不讨论。\n当数据被插入的时候，oracle根据连接进来的session，做hash运算，随机选择一个L3（如果有多个的话），再随机选择一个L2，接下来在该L2下随机选择一个L1，再从L1中管理的block里面随机选择一个块将数据插入，不同的session经过hash之后，最后落到block时已经是很分散的了，不会产生很多和会话同时往一个block中插数据申请独占buffer pin，而造成大量buffer busy waits的情况，这就是ASSM号称支持大并发插入的原理所在，但是事实上真的如此么？我们来一探究竟！\n>实验环境\n\n```\nOS:REDHAT6.5 X64\nDB VERSION:11.2.0.4\n```\n>首先，创建一个1M区大小的表空间，并在上面创建一张表，此表创建了4个空间很大的字段，目的是要一行占满一个block，便于观察结果\n\n```sql\nSQL> select file#,NAME,BYTES/1024/1204 from v$datafile;\n\n     FILE# NAME                                                                             BYTES/1024/1204\n---------- -------------------------------------------------------------------------------- ---------------\n         1 +DATA/min/datafile/system.256.854775095                                               637.873754\n         2 +DATA/min/datafile/sysaux.257.854775097                                               484.784053\n         3 +DATA/min/datafile/undotbs1.258.854775097                                             187.109635\n         4 +DATA/min/datafile/users.259.854775097                                                103.122924\n\nSQL> create tablespace lp datafile '+DATA/min/datafile/lp.dbf' size 2048M uniform size 1m;\n\nTablespace created.\n\nSQL> select file#,NAME,BYTES/1024/1204 from v$datafile;\n\n     FILE# NAME                                                                             BYTES/1024/1204\n---------- -------------------------------------------------------------------------------- ---------------\n         1 +DATA/min/datafile/system.256.854775095                                               637.873754\n         2 +DATA/min/datafile/sysaux.257.854775097                                               484.784053\n         3 +DATA/min/datafile/undotbs1.258.854775097                                             187.109635\n         4 +DATA/min/datafile/users.259.854775097                                                103.122924\n         5 +DATA/min/datafile/lp.dbf                                                              1741.8206\n\nSQL> create table lp (id number,des1 char(2000),des2 char(2000),des3 char(2000),des4 char(500)) tablespace lp;\n\nTable created.\n```\n\n>观察新建的表所占区\n\n```sql\nSQL> col SEGMENT_NAME for a30\nSQL> col des1 for a1\nSQL> col des2 for a1\nSQL> col des3 for a1\nSQL> col des4 for a1\nSQL> set line 200\nSQL> select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID, BLOCKS from dba_extents where segment_name='LP';\n\nSEGMENT_NAME                    EXTENT_ID    FILE_ID   BLOCK_ID     BLOCKS\n------------------------------ ---------- ---------- ---------- ----------\nLP                                      0          5        128        128\n```\n\n>此表是5号文件，拥有1个区，block从128号开始，接下来我们插入一条数据，并dump出段头进行观察\n\n```sql\nSQL> insert into lp values(1,'a','a','a','a');\n\n1 row created.\n\nSQL> commit;\n\nCommit complete.\n\nSQL> select segment_name ,HEADER_FILE,HEADER_BLOCK from dba_segments where segment_name='LP';\n\nSEGMENT_NAME                   HEADER_FILE HEADER_BLOCK\n------------------------------ ----------- ------------\nLP                                       5          131\n\n\nSQL> alter system checkpoint;\n\nSystem altered.\n```\n\n>LP的段头是5号文件，131号块，进行dump\n\n```sql\nSQL> alter system dump datafile 5 block 131;\n\nSQL> col value for a65\nSQL> select *  from v$diag_info;\n\n   INST_ID NAME                                                                             VALUE\n---------- -------------------------------------------------------------------------------- -----------------------------------------------------------------\n         1 Diag Enabled                                                                     TRUE\n         1 ADR Base                                                                         /u01/app/oracle\n         1 ADR Home                                                                         /u01/app/oracle/diag/rdbms/min/min\n         1 Diag Trace                                                                       /u01/app/oracle/diag/rdbms/min/min/trace\n         1 Diag Alert                                                                       /u01/app/oracle/diag/rdbms/min/min/alert\n         1 Diag Incident                                                                    /u01/app/oracle/diag/rdbms/min/min/incident\n         1 Diag Cdump                                                                       /u01/app/oracle/diag/rdbms/min/min/cdump\n         1 Health Monitor                                                                   /u01/app/oracle/diag/rdbms/min/min/hm\n         1 Default Trace File                                                               /u01/app/oracle/diag/rdbms/min/min/trace/min_ora_2835.trc\n         1 Active Problem Count                                                             0\n         1 Active Incident Count                                                            0\n\n11 rows selected.\n```\n\n>观察trc文件min_ora_2835.trc\n\n```\nBlock dump from disk:\nbuffer tsn: 8 rdba: 0x01400083 (5/131)\nscn: 0x0000.00140d51 seq: 0x01 flg: 0x04 tail: 0x0d512301\nfrmt: 0x02 chkval: 0xfd8a type: 0x23=PAGETABLE SEGMENT HEADER\nHex dump of block: st=0, typ_found=1\n\n\n\nExtent Control Header\n  -----------------------------------------------------------------\n  Extent Header:: spare1: 0      spare2: 0      #extents: 1      #blocks: 128   \n                  last map  0x00000000  #maps: 0      offset: 2716  \n      Highwater::  0x014000c0  ext#: 0      blk#: 64     ext size: 128   \n  #blocks in seg. hdr's freelists: 0     \n  #blocks below: 60    \n  mapblk  0x00000000  offset: 0     \n                   Unlocked\n  --------------------------------------------------------\n  Low HighWater Mark :\n      Highwater::  0x01400084  ext#: 0      blk#: 4      ext size: 128   \n  #blocks in seg. hdr's freelists: 0     \n  #blocks below: 0     \n  mapblk  0x00000000  offset: 0     \n  Level 1 BMB for High HWM block: 0x01400080\n  Level 1 BMB for Low HWM block: 0x01400080\n  --------------------------------------------------------\n  Segment Type: 1 nl2: 1      blksz: 8192   fbsz: 0      \n  L2 Array start offset:  0x00001434\n  First Level 3 BMB:  0x00000000\n  L2 Hint for inserts:  0x01400082\n  Last Level 1 BMB:  0x01400081\n  Last Level II BMB:  0x01400082\n  Last Level III BMB:  0x00000000\n     Map Header:: next  0x00000000  #extents: 1    obj#: 87596  flag: 0x10000000\n  Inc # 0\n  Extent Map\n  -----------------------------------------------------------------\n   0x01400080  length: 128   \n\n  Auxillary Map\n  --------------------------------------------------------\n   Extent 0     :  L1 dba:  0x01400080 Data dba:  0x01400084\n  --------------------------------------------------------\n\nSecond Level Bitmap block DBAs\n   --------------------------------------------------------\n   DBA 1:   0x01400082\n\nEnd dump data blocks tsn: 8 file#: 5 minblk 131 maxblk 131\n```\n\n>很容易发现这是一个PAGETABLE SEGMENT HEADER块，Extent Map中只有一个区，另外在尾部有一个指向二级位图块的地址0x01400082，这是数据块地址的二进制用十六进制来表示，我们来将其转化成直观一点的信息\n\n```sql\nSQL> select dbms_utility.data_block_address_file(to_number('01400082', 'xxxxxxxx')) file#,\n  2 dbms_utility.data_block_address_block(to_number('01400082', 'xxxxxxxx')) block#\n  3 from dual;\n\n     FILE# BLOCK#\n---------- ----------\n         5 130\n```\n\n> 依样将5号文件130号块的内容dump出来\n\n```\nBlock dump from disk:\nbuffer tsn: 8 rdba: 0x01400082 (5/130)\nscn: 0x0000.00140a45 seq: 0x02 flg: 0x04 tail: 0x0a452102\nfrmt: 0x02 chkval: 0xd119 type: 0x21=SECOND LEVEL BITMAP BLOCK\nHex dump of block: st=0, typ_found=1\n\n\nDump of Second Level Bitmap Block\n   number: 2       nfree: 2       ffree: 0      pdba:     0x01400083\n   Inc #: 0 Objd: 87596\n  opcode:0\n xid:\n  L1 Ranges :\n  --------------------------------------------------------\n   0x01400080  Free: 5 Inst: 1\n   0x01400081  Free: 5 Inst: 1\n\n  --------------------------------------------------------\nEnd dump data blocks tsn: 8 file#: 5 minblk 130 maxblk 130\n```\n\n>可以发现这是一个二级位图块，并从其中找到了2个L1块的地址，我们来看第一个L1\n\n```\nBlock dump from disk:\nbuffer tsn: 8 rdba: 0x01400080 (5/128)\nscn: 0x0000.00140d51 seq: 0x03 flg: 0x04 tail: 0x0d512003\nfrmt: 0x02 chkval: 0xe697 type: 0x20=FIRST LEVEL BITMAP BLOCK\nHex dump of block: st=0, typ_found=1\n\nDBA Ranges :\n  --------------------------------------------------------\n   0x01400080  Length: 64     Offset: 0      \n\n   0:Metadata   1:Metadata   2:Metadata   3:Metadata\n   4:unformatted   5:unformatted   6:unformatted   7:unformatted\n   8:unformatted   9:unformatted   10:unformatted   11:unformatted\n   12:unformatted   13:unformatted   14:unformatted   15:unformatted\n   16:75-100% free   17:75-100% free   18:75-100% free   19:75-100% free\n   20:75-100% free   21:75-100% free   22:75-100% free   23:75-100% free\n   24:75-100% free   25:75-100% free   26:75-100% free   27:75-100% free\n   28:75-100% free   29:75-100% free   30:75-100% free   31:0-25% free\n   32:unformatted   33:unformatted   34:unformatted   35:unformatted\n   36:unformatted   37:unformatted   38:unformatted   39:unformatted\n   40:unformatted   41:unformatted   42:unformatted   43:unformatted\n   44:unformatted   45:unformatted   46:unformatted   47:unformatted\n   48:unformatted   49:unformatted   50:unformatted   51:unformatted\n   52:unformatted   53:unformatted   54:unformatted   55:unformatted\n   56:unformatted   57:unformatted   58:unformatted   59:unformatted\n   60:unformatted   61:unformatted   62:unformatted   63:unformatted\n  --------------------------------------------------------\nEnd dump data blocks tsn: 8 file#: 5 minblk 128 maxblk 128\n```\n\n>无疑这是一个L1块，里面挂了64个数据块，因为我之前插入了一行数据，oracle已经格式化了一部分，并向其中一个块插入了数据，但是没达到我们的效果，被插入的块还显示0-25%的空闲，我们要的是full的状态，说明我们构造的数据不够大，没关系，我们修改一下pctfree就可以了，另外我们可以发现这个区是1M，有2个L1，每个L1里有64个数据块，接下来修改pctfree\n\n```sql\nSQL> alter table lp pctfree 24;\n\nTable altered.\n\nSQL> select TABLE_NAME,PCT_FREE from dba_tables where table_name='LP';\n\nTABLE_NAME                       PCT_FREE\n------------------------------ ----------\nLP                                     24\n\nSQL> insert into lp values(2,'a','a','a','a');\n\n1 row created.\n\nSQL> commit;\n\nCommit complete.\n--手动触发检查点将内存中的块刷新到磁盘，本文每次dump之前都会做这个操作，以保证磁盘和内存的内容一致\nSQL> alter system checkpoint;\n\nSystem altered.\n```\n\n>我们再看128号块\n\n```\nDBA Ranges :\n  --------------------------------------------------------\n   0x01400080  Length: 64     Offset: 0      \n\n   0:Metadata   1:Metadata   2:Metadata   3:Metadata\n   4:unformatted   5:unformatted   6:unformatted   7:unformatted\n   8:unformatted   9:unformatted   10:unformatted   11:unformatted\n   12:unformatted   13:unformatted   14:unformatted   15:unformatted\n   16:75-100% free   17:75-100% free   18:75-100% free   19:75-100% free\n   20:75-100% free   21:75-100% free   22:75-100% free   23:75-100% free\n   24:75-100% free   25:75-100% free   26:75-100% free   27:75-100% free\n   28:75-100% free   29:75-100% free   30:75-100% free   31:0-25% free\n   32:75-100% free   33:75-100% free   34:75-100% free   <font color='red'>35:FULL</font>\n   36:75-100% free   37:75-100% free   38:75-100% free   39:75-100% free\n   40:75-100% free   41:75-100% free   42:75-100% free   43:75-100% free\n   44:75-100% free   45:75-100% free   46:75-100% free   47:75-100% free\n   48:unformatted   49:unformatted   50:unformatted   51:unformatted\n   52:unformatted   53:unformatted   54:unformatted   55:unformatted\n   56:unformatted   57:unformatted   58:unformatted   59:unformatted\n   60:unformatted   61:unformatted   62:unformatted   63:unformatted\n  --------------------------------------------------------\nEnd dump data blocks tsn: 8 file#: 5 minblk 128 maxblk 128\n```\n\n>已经是我们想的结果了，到这里我们再来看一下另外一个L1吧，dump129号块\n\n```\nDBA Ranges :\n  --------------------------------------------------------\n   0x014000c0  Length: 64     Offset: 0      \n\n   0:unformatted   1:unformatted   2:unformatted   3:unformatted\n   4:unformatted   5:unformatted   6:unformatted   7:unformatted\n   8:unformatted   9:unformatted   10:unformatted   11:unformatted\n   12:unformatted   13:unformatted   14:unformatted   15:unformatted\n   16:unformatted   17:unformatted   18:unformatted   19:unformatted\n   20:unformatted   21:unformatted   22:unformatted   23:unformatted\n   24:unformatted   25:unformatted   26:unformatted   27:unformatted\n   28:unformatted   29:unformatted   30:unformatted   31:unformatted\n   32:unformatted   33:unformatted   34:unformatted   35:unformatted\n   36:unformatted   37:unformatted   38:unformatted   39:unformatted\n   40:unformatted   41:unformatted   42:unformatted   43:unformatted\n   44:unformatted   45:unformatted   46:unformatted   47:unformatted\n   48:unformatted   49:unformatted   50:unformatted   51:unformatted\n   52:unformatted   53:unformatted   54:unformatted   55:unformatted\n   56:unformatted   57:unformatted   58:unformatted   59:unformatted\n   60:unformatted   61:unformatted   62:unformatted   63:unformatted\n  --------------------------------------------------------\nEnd dump data blocks tsn: 8 file#: 5 minblk 129 maxblk 129\n```\n\n>全是未格式化的块，试一试并发插入，这里不模拟真正的并发了，只是开不同的session来进行插入\n\n```sql\nSQL> insert into lp values(3,'a','a','a','a');\n\n1 row created.\n\nSQL> insert into lp values(4,'a','a','a','a');\n\n1 row created.\n\nSQL> insert into lp values(5,'a','a','a','a');\n\n1 row created.\n\nSQL> insert into lp values(6,'a','a','a','a');\n\n1 row created.\n\nSQL> insert into lp values(7,'a','a','a','a');\n\n1 row created.\n\n--单独session5条\n\nSQL> select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp;\n\nDBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)\n------------------------------------ ------------------------------------\n                                   5                                  158\n                                   5                                  159\n                                   5                                  163\n                                   5                                  167\n                                   5                                  171\n                                   5                                  172\n                                   5                                  174\n                                   5                                  175\n                                   5                                  179\n                                   5                                  183\n                                   5                                  187\n                                   5                                  191\n\n12 rows selected.\n```\n\n>一个单独的session里插入了5条，另外5个单独的session里各插一条，发现规律了么，插入的块只在132和192之间，我们分别看看两个L1\n\n```\nSQL> alter system checkpoint;\n\nSystem altered.\n\n\n  DBA Ranges :\n  --------------------------------------------------------\n   0x01400080  Length: 64     Offset: 0      \n\n   0:Metadata   1:Metadata   2:Metadata   3:Metadata\n   4:unformatted   5:unformatted   6:unformatted   7:unformatted\n   8:unformatted   9:unformatted   10:unformatted   11:unformatted\n   12:unformatted   13:unformatted   14:unformatted   15:unformatted\n   16:75-100% free   17:75-100% free   18:75-100% free   19:75-100% free\n   20:75-100% free   21:75-100% free   22:75-100% free   23:75-100% free\n   24:75-100% free   25:75-100% free   26:75-100% free   27:75-100% free\n   28:75-100% free   29:75-100% free   30:FULL   31:0-25% free\n   32:75-100% free   33:75-100% free   34:75-100% free   35:FULL\n   36:75-100% free   37:75-100% free   38:75-100% free   39:FULL\n   40:75-100% free   41:75-100% free   42:75-100% free   43:FULL\n   44:FULL   45:75-100% free   46:FULL   47:FULL\n   48:75-100% free   49:75-100% free   50:75-100% free   51:FULL\n   52:75-100% free   53:75-100% free   54:75-100% free   55:FULL\n   56:75-100% free   57:75-100% free   58:75-100% free   59:FULL\n   60:75-100% free   61:75-100% free   62:75-100% free   63:FULL\n  --------------------------------------------------------\nEnd dump data blocks tsn: 8 file#: 5 minblk 128 maxblk 128\n\n********************************************************************\n看一下第二个L1\n\nDBA Ranges :\n  --------------------------------------------------------\n   0x014000c0  Length: 64     Offset: 0      \n\n   0:unformatted   1:unformatted   2:unformatted   3:unformatted\n   4:unformatted   5:unformatted   6:unformatted   7:unformatted\n   8:unformatted   9:unformatted   10:unformatted   11:unformatted\n   12:unformatted   13:unformatted   14:unformatted   15:unformatted\n   16:unformatted   17:unformatted   18:unformatted   19:unformatted\n   20:unformatted   21:unformatted   22:unformatted   23:unformatted\n   24:unformatted   25:unformatted   26:unformatted   27:unformatted\n   28:unformatted   29:unformatted   30:unformatted   31:unformatted\n   32:unformatted   33:unformatted   34:unformatted   35:unformatted\n   36:unformatted   37:unformatted   38:unformatted   39:unformatted\n   40:unformatted   41:unformatted   42:unformatted   43:unformatted\n   44:unformatted   45:unformatted   46:unformatted   47:unformatted\n   48:unformatted   49:unformatted   50:unformatted   51:unformatted\n   52:unformatted   53:unformatted   54:unformatted   55:unformatted\n   56:unformatted   57:unformatted   58:unformatted   59:unformatted\n   60:unformatted   61:unformatted   62:unformatted   63:unformatted\n  --------------------------------------------------------\nEnd dump data blocks tsn: 8 file#: 5 minblk 129 maxblk 129\n```\n\n>这说明只在第一个L1里面随机，那为什么L2下挂了2个L1，我插入了10条却没有一条随机到第二个L1块呢？答案是高水位，这是vage大师已经论证过的了，偶在这里仅为见证一下~~，好了，还记得L3里的高水位信息么？\n\n\n```\nExtent Control Header\n  -----------------------------------------------------------------\n  Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928\n                  last map  0x00000000  #maps: 0      offset: 2716  \n      Highwater::  0x014000c0  ext#: 0      blk#: 64     ext size: 128   \n  #blocks in seg. hdr's freelists: 0     \n  #blocks below: 60    \n  mapblk  0x00000000  offset: 0\n```\n\n>Highwater::  0x014000c0是哪个块呢？\n\n```sql\n  SQL> select dbms_utility.data_block_address_file(to_number('014000c0', 'xxxxxxxx')) file#,\n  2 dbms_utility.data_block_address_block(to_number('014000c0', 'xxxxxxxx')) block#\n  3 from dual;\n\n     FILE# BLOCK#\n---------- ----------\n         5 192\n```\n\n >这是第二个L1管理的第一个块，可见数据的插入只在高水位之下进行（直接路径插入除外），此时的状态如下：\n\n\n![](http://oaowhilvu.bkt.clouddn.com/0%E4%B8%AAextent.png)\n\n>那么L1里面只会有64个块么？高水位永远都会指向L1的最后一个块么？我们继续剖析！\n首先给LP表多分配一些区\n\n```sql\nSQL> alter table lp allocate extent(size 100m);\n\nTable altered.\n\nSQL> select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID, BLOCKS from dba_extents where segment_name='LP';\n\nSEGMENT_NAME                    EXTENT_ID    FILE_ID   BLOCK_ID     BLOCKS\n------------------------------ ---------- ---------- ---------- ----------\nLP                                      0          5        128        128\nLP                                      1          5        256        128\nLP                                      2          5        384        128\nLP                                      3          5        512        128\nLP                                      4          5        640        128\nLP                                      5          5        768        128\nLP                                      6          5        896        128\nLP                                      7          5       1024        128\nLP                                      8          5       1152        128\nLP                                      9          5       1280        128\nLP                                     10          5       1408        128\nLP                                     11          5       1536        128\nLP                                     12          5       1664        128\nLP                                     13          5       1792        128\nLP                                     14          5       1920        128\nLP                                     15          5       2048        128\nLP                                     16          5       2176        128\nLP                                     17          5       2304        128\nLP                                     18          5       2432        128\nLP                                     19          5       2560        128\nLP                                     20          5       2688        128\nLP                                     21          5       2816        128\nLP                                     22          5       2944        128\nLP                                     23          5       3072        128\nLP                                     24          5       3200        128\nLP                                     25          5       3328        128\nLP                                     26          5       3456        128\nLP                                     27          5       3584        128\nLP                                     28          5       3712        128\nLP                                     29          5       3840        128\nLP                                     30          5       3968        128\nLP                                     31          5       4096        128\nLP                                     32          5       4224        128\nLP                                     33          5       4352        128\nLP                                     34          5       4480        128\nLP                                     35          5       4608        128\nLP                                     36          5       4736        128\nLP                                     37          5       4864        128\nLP                                     38          5       4992        128\nLP                                     39          5       5120        128\nLP                                     40          5       5248        128\nLP                                     41          5       5376        128\nLP                                     42          5       5504        128\nLP                                     43          5       5632        128\nLP                                     44          5       5760        128\nLP                                     45          5       5888        128\nLP                                     46          5       6016        128\nLP                                     47          5       6144        128\nLP                                     48          5       6272        128\nLP                                     49          5       6400        128\nLP                                     50          5       6528        128\nLP                                     51          5       6656        128\nLP                                     52          5       6784        128\nLP                                     53          5       6912        128\nLP                                     54          5       7040        128\nLP                                     55          5       7168        128\nLP                                     56          5       7296        128\nLP                                     57          5       7424        128\nLP                                     58          5       7552        128\nLP                                     59          5       7680        128\nLP                                     60          5       7808        128\nLP                                     61          5       7936        128\nLP                                     62          5       8064        128\nLP                                     63          5       8192        128\nLP                                     64          5       8320        128\nLP                                     65          5       8448        128\nLP                                     66          5       8576        128\nLP                                     67          5       8704        128\nLP                                     68          5       8832        128\nLP                                     69          5       8960        128\nLP                                     70          5       9088        128\nLP                                     71          5       9216        128\nLP                                     72          5       9344        128\nLP                                     73          5       9472        128\nLP                                     74          5       9600        128\nLP                                     75          5       9728        128\nLP                                     76          5       9856        128\nLP                                     77          5       9984        128\nLP                                     78          5      10112        128\nLP                                     79          5      10240        128\nLP                                     80          5      10368        128\nLP                                     81          5      10496        128\nLP                                     82          5      10624        128\nLP                                     83          5      10752        128\nLP                                     84          5      10880        128\nLP                                     85          5      11008        128\nLP                                     86          5      11136        128\nLP                                     87          5      11264        128\nLP                                     88          5      11392        128\nLP                                     89          5      11520        128\nLP                                     90          5      11648        128\nLP                                     91          5      11776        128\nLP                                     92          5      11904        128\nLP                                     93          5      12032        128\nLP                                     94          5      12160        128\nLP                                     95          5      12288        128\nLP                                     96          5      12416        128\nLP                                     97          5      12544        128\nLP                                     98          5      12672        128\nLP                                     99          5      12800        128\nLP                                    100          5      12928        128\n\n101 rows selected.\n```\n\n>我分配了100个区，加上原来的一共101个，现在我们看看L3段头里面的内容\n\n```\nExtent Control Header\n  -----------------------------------------------------------------\n  Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928\n                  last map  0x00000000  #maps: 0      offset: 2716  \n      Highwater::  0x014000c0  ext#: 0      blk#: 64     ext size: 128   \n  #blocks in seg. hdr's freelists: 0     \n  #blocks below: 60    \n  mapblk  0x00000000  offset: 0     \n\n\nExtent Map\n  -----------------------------------------------------------------\n   0x01400080  length: 128   \n   0x01400100  length: 128   \n   0x01400180  length: 128   \n   0x01400200  length: 128   \n   0x01400280  length: 128   \n   0x01400300  length: 128   \n   0x01400380  length: 128   \n   0x01400400  length: 128   \n   0x01400480  length: 128   \n   0x01400500  length: 128   \n   0x01400580  length: 128   \n   0x01400600  length: 128   \n   0x01400680  length: 128   \n   0x01400700  length: 128   \n   0x01400780  length: 128   \n   0x01400800  length: 128   \n   0x01400880  length: 128   \n   0x01400900  length: 128   \n   0x01400980  length: 128   \n   0x01400a00  length: 128   \n   0x01400a80  length: 128   \n   0x01400b00  length: 128   \n   0x01400b80  length: 128   \n   0x01400c00  length: 128   \n   0x01400c80  length: 128   \n   0x01400d00  length: 128   \n   0x01400d80  length: 128   \n   0x01400e00  length: 128   \n   0x01400e80  length: 128   \n   0x01400f00  length: 128   \n   0x01400f80  length: 128   \n   0x01401000  length: 128   \n   0x01401080  length: 128   \n   0x01401100  length: 128   \n   0x01401180  length: 128   \n   0x01401200  length: 128   \n   0x01401280  length: 128   \n   0x01401300  length: 128   \n   0x01401380  length: 128   \n   0x01401400  length: 128   \n   0x01401480  length: 128   \n   0x01401500  length: 128   \n   0x01401580  length: 128   \n   0x01401600  length: 128   \n   0x01401680  length: 128   \n   0x01401700  length: 128   \n   0x01401780  length: 128   \n   0x01401800  length: 128   \n   0x01401880  length: 128   \n   0x01401900  length: 128   \n   0x01401980  length: 128   \n   0x01401a00  length: 128   \n   0x01401a80  length: 128   \n   0x01401b00  length: 128   \n   0x01401b80  length: 128   \n   0x01401c00  length: 128   \n   0x01401c80  length: 128   \n   0x01401d00  length: 128   \n   0x01401d80  length: 128   \n   0x01401e00  length: 128   \n   0x01401e80  length: 128   \n   0x01401f00  length: 128   \n   0x01401f80  length: 128   \n   0x01402000  length: 128   \n   0x01402080  length: 128   \n   0x01402100  length: 128   \n   0x01402180  length: 128   \n   0x01402200  length: 128   \n   0x01402280  length: 128   \n   0x01402300  length: 128   \n   0x01402380  length: 128   \n   0x01402400  length: 128   \n   0x01402480  length: 128   \n   0x01402500  length: 128   \n   0x01402580  length: 128   \n   0x01402600  length: 128   \n   0x01402680  length: 128   \n   0x01402700  length: 128   \n   0x01402780  length: 128   \n   0x01402800  length: 128   \n   0x01402880  length: 128   \n   0x01402900  length: 128   \n   0x01402980  length: 128   \n   0x01402a00  length: 128   \n   0x01402a80  length: 128   \n   0x01402b00  length: 128   \n   0x01402b80  length: 128   \n   0x01402c00  length: 128   \n   0x01402c80  length: 128   \n   0x01402d00  length: 128   \n   0x01402d80  length: 128   \n   0x01402e00  length: 128   \n   0x01402e80  length: 128   \n   0x01402f00  length: 128   \n   0x01402f80  length: 128   \n   0x01403000  length: 128   \n   0x01403080  length: 128   \n   0x01403100  length: 128   \n   0x01403180  length: 128   \n   0x01403200  length: 128   \n   0x01403280  length: 128   \n\n  Auxillary Map\n  --------------------------------------------------------\n   Extent 0     :  L1 dba:  0x01400080 Data dba:  0x01400084\n   Extent 1     :  L1 dba:  0x01400100 Data dba:  0x01400102\n   Extent 2     :  L1 dba:  0x01400180 Data dba:  0x01400182\n   Extent 3     :  L1 dba:  0x01400200 Data dba:  0x01400202\n   Extent 4     :  L1 dba:  0x01400280 Data dba:  0x01400282\n   Extent 5     :  L1 dba:  0x01400300 Data dba:  0x01400302\n   Extent 6     :  L1 dba:  0x01400380 Data dba:  0x01400382\n   Extent 7     :  L1 dba:  0x01400400 Data dba:  0x01400402\n   Extent 8     :  L1 dba:  0x01400480 Data dba:  0x01400482\n   Extent 9     :  L1 dba:  0x01400500 Data dba:  0x01400502\n   Extent 10    :  L1 dba:  0x01400580 Data dba:  0x01400582\n   Extent 11    :  L1 dba:  0x01400600 Data dba:  0x01400602\n   Extent 12    :  L1 dba:  0x01400680 Data dba:  0x01400682\n   Extent 13    :  L1 dba:  0x01400700 Data dba:  0x01400702\n   Extent 14    :  L1 dba:  0x01400780 Data dba:  0x01400782\n   Extent 15    :  L1 dba:  0x01400800 Data dba:  0x01400802\n   Extent 16    :  L1 dba:  0x01400880 Data dba:  0x01400882\n   Extent 17    :  L1 dba:  0x01400900 Data dba:  0x01400902\n   Extent 18    :  L1 dba:  0x01400980 Data dba:  0x01400982\n   Extent 19    :  L1 dba:  0x01400a00 Data dba:  0x01400a02\n   Extent 20    :  L1 dba:  0x01400a80 Data dba:  0x01400a82\n   Extent 21    :  L1 dba:  0x01400b00 Data dba:  0x01400b02\n   Extent 22    :  L1 dba:  0x01400b80 Data dba:  0x01400b82\n   Extent 23    :  L1 dba:  0x01400c00 Data dba:  0x01400c02\n   Extent 24    :  L1 dba:  0x01400c80 Data dba:  0x01400c82\n   Extent 25    :  L1 dba:  0x01400d00 Data dba:  0x01400d02\n   Extent 26    :  L1 dba:  0x01400d80 Data dba:  0x01400d82\n   Extent 27    :  L1 dba:  0x01400e00 Data dba:  0x01400e02\n   Extent 28    :  L1 dba:  0x01400e80 Data dba:  0x01400e82\n   Extent 29    :  L1 dba:  0x01400f00 Data dba:  0x01400f02\n   Extent 30    :  L1 dba:  0x01400f80 Data dba:  0x01400f82\n   Extent 31    :  L1 dba:  0x01401000 Data dba:  0x01401002\n   Extent 32    :  L1 dba:  0x01401080 Data dba:  0x01401082\n   Extent 33    :  L1 dba:  0x01401100 Data dba:  0x01401102\n   Extent 34    :  L1 dba:  0x01401180 Data dba:  0x01401182\n   Extent 35    :  L1 dba:  0x01401200 Data dba:  0x01401202\n   Extent 36    :  L1 dba:  0x01401280 Data dba:  0x01401282\n   Extent 37    :  L1 dba:  0x01401300 Data dba:  0x01401302\n   Extent 38    :  L1 dba:  0x01401380 Data dba:  0x01401382\n   Extent 39    :  L1 dba:  0x01401400 Data dba:  0x01401402\n   Extent 40    :  L1 dba:  0x01401480 Data dba:  0x01401482\n   Extent 41    :  L1 dba:  0x01401500 Data dba:  0x01401502\n   Extent 42    :  L1 dba:  0x01401580 Data dba:  0x01401582\n   Extent 43    :  L1 dba:  0x01401600 Data dba:  0x01401602\n   Extent 44    :  L1 dba:  0x01401680 Data dba:  0x01401682\n   Extent 45    :  L1 dba:  0x01401700 Data dba:  0x01401702\n   Extent 46    :  L1 dba:  0x01401780 Data dba:  0x01401782\n   Extent 47    :  L1 dba:  0x01401800 Data dba:  0x01401802\n   Extent 48    :  L1 dba:  0x01401880 Data dba:  0x01401882\n   Extent 49    :  L1 dba:  0x01401900 Data dba:  0x01401902\n   Extent 50    :  L1 dba:  0x01401980 Data dba:  0x01401982\n   Extent 51    :  L1 dba:  0x01401a00 Data dba:  0x01401a02\n   Extent 52    :  L1 dba:  0x01401a80 Data dba:  0x01401a82\n   Extent 53    :  L1 dba:  0x01401b00 Data dba:  0x01401b02\n   Extent 54    :  L1 dba:  0x01401b80 Data dba:  0x01401b82\n   Extent 55    :  L1 dba:  0x01401c00 Data dba:  0x01401c02\n   Extent 56    :  L1 dba:  0x01401c80 Data dba:  0x01401c82\n   Extent 57    :  L1 dba:  0x01401d00 Data dba:  0x01401d02\n   Extent 58    :  L1 dba:  0x01401d80 Data dba:  0x01401d82\n   Extent 59    :  L1 dba:  0x01401e00 Data dba:  0x01401e02\n   Extent 60    :  L1 dba:  0x01401e80 Data dba:  0x01401e82\n   Extent 61    :  L1 dba:  0x01401f00 Data dba:  0x01401f02\n   Extent 62    :  L1 dba:  0x01401f80 Data dba:  0x01401f82\n   Extent 63    :  L1 dba:  0x01402000 Data dba:  0x01402001\n   Extent 64    :  L1 dba:  0x01402000 Data dba:  0x01402080\n   Extent 65    :  L1 dba:  0x01402100 Data dba:  0x01402101\n   Extent 66    :  L1 dba:  0x01402100 Data dba:  0x01402180\n   Extent 67    :  L1 dba:  0x01402200 Data dba:  0x01402201\n   Extent 68    :  L1 dba:  0x01402200 Data dba:  0x01402280\n   Extent 69    :  L1 dba:  0x01402300 Data dba:  0x01402301\n   Extent 70    :  L1 dba:  0x01402300 Data dba:  0x01402380\n   Extent 71    :  L1 dba:  0x01402400 Data dba:  0x01402401\n   Extent 72    :  L1 dba:  0x01402400 Data dba:  0x01402480\n   Extent 73    :  L1 dba:  0x01402500 Data dba:  0x01402501\n   Extent 74    :  L1 dba:  0x01402500 Data dba:  0x01402580\n   Extent 75    :  L1 dba:  0x01402600 Data dba:  0x01402601\n   Extent 76    :  L1 dba:  0x01402600 Data dba:  0x01402680\n   Extent 77    :  L1 dba:  0x01402700 Data dba:  0x01402701\n   Extent 78    :  L1 dba:  0x01402700 Data dba:  0x01402780\n   Extent 79    :  L1 dba:  0x01402800 Data dba:  0x01402801\n   Extent 80    :  L1 dba:  0x01402800 Data dba:  0x01402880\n   Extent 81    :  L1 dba:  0x01402900 Data dba:  0x01402901\n   Extent 82    :  L1 dba:  0x01402900 Data dba:  0x01402980\n   Extent 83    :  L1 dba:  0x01402a00 Data dba:  0x01402a01\n   Extent 84    :  L1 dba:  0x01402a00 Data dba:  0x01402a80\n   Extent 85    :  L1 dba:  0x01402b00 Data dba:  0x01402b01\n   Extent 86    :  L1 dba:  0x01402b00 Data dba:  0x01402b80\n   Extent 87    :  L1 dba:  0x01402c00 Data dba:  0x01402c01\n   Extent 88    :  L1 dba:  0x01402c00 Data dba:  0x01402c80\n   Extent 89    :  L1 dba:  0x01402d00 Data dba:  0x01402d01\n   Extent 90    :  L1 dba:  0x01402d00 Data dba:  0x01402d80\n   Extent 91    :  L1 dba:  0x01402e00 Data dba:  0x01402e01\n   Extent 92    :  L1 dba:  0x01402e00 Data dba:  0x01402e80\n   Extent 93    :  L1 dba:  0x01402f00 Data dba:  0x01402f01\n   Extent 94    :  L1 dba:  0x01402f00 Data dba:  0x01402f80\n   Extent 95    :  L1 dba:  0x01403000 Data dba:  0x01403001\n   Extent 96    :  L1 dba:  0x01403000 Data dba:  0x01403080\n   Extent 97    :  L1 dba:  0x01403100 Data dba:  0x01403101\n   Extent 98    :  L1 dba:  0x01403100 Data dba:  0x01403180\n   Extent 99    :  L1 dba:  0x01403200 Data dba:  0x01403201\n   Extent 100   :  L1 dba:  0x01403200 Data dba:  0x01403280\n  --------------------------------------------------------\n\n   Second Level Bitmap block DBAs\n   --------------------------------------------------------\n   DBA 1:   0x01400082\n\nEnd dump data blocks tsn: 8 file#: 5 minblk 131 maxblk 131   \n```\n\n>这里我们主要看Auxillary Map，里面记录了每个区所属的L1，不难发现从第64个区开始，64、65两个区的L1相同，这说明什么，说明L1下面挂了整整两个区的数据块，验证一下，将0x01402000块dump出来之后的内容：\n\n```sql\n  01402000  十进制 》20979712\n  SQL> select dbms_utility.data_block_address_file(20979712) Rfile#,dbms_utility.data_block_address_block(20979712) \"Block#\" from dual;\n\n    RFILE#     Block#\n---------- ----------\n         5       8192\n```\n\n```\n          DBA Ranges :\n  --------------------------------------------------------\n   0x01402000  Length: 128    Offset: 0      \n   0x01402080  Length: 128    Offset: 128    \n\n   0:Metadata   1:unformatted   2:unformatted   3:unformatted\n   4:unformatted   5:unformatted   6:unformatted   7:unformatted\n   8:unformatted   9:unformatted   10:unformatted   11:unformatted\n   12:unformatted   13:unformatted   14:unformatted   15:unformatted\n   16:unformatted   17:unformatted   18:unformatted   19:unformatted\n   20:unformatted   21:unformatted   22:unformatted   23:unformatted\n   24:unformatted   25:unformatted   26:unformatted   27:unformatted\n   28:unformatted   29:unformatted   30:unformatted   31:unformatted\n   32:unformatted   33:unformatted   34:unformatted   35:unformatted\n   36:unformatted   37:unformatted   38:unformatted   39:unformatted\n   40:unformatted   41:unformatted   42:unformatted   43:unformatted\n   44:unformatted   45:unformatted   46:unformatted   47:unformatted\n   48:unformatted   49:unformatted   50:unformatted   51:unformatted\n   52:unformatted   53:unformatted   54:unformatted   55:unformatted\n   56:unformatted   57:unformatted   58:unformatted   59:unformatted\n   60:unformatted   61:unformatted   62:unformatted   63:unformatted\n   64:unformatted   65:unformatted   66:unformatted   67:unformatted\n   68:unformatted   69:unformatted   70:unformatted   71:unformatted\n   72:unformatted   73:unformatted   74:unformatted   75:unformatted\n   76:unformatted   77:unformatted   78:unformatted   79:unformatted\n   80:unformatted   81:unformatted   82:unformatted   83:unformatted\n   84:unformatted   85:unformatted   86:unformatted   87:unformatted\n   88:unformatted   89:unformatted   90:unformatted   91:unformatted\n   92:unformatted   93:unformatted   94:unformatted   95:unformatted\n   96:unformatted   97:unformatted   98:unformatted   99:unformatted\n   100:unformatted   101:unformatted   102:unformatted   103:unformatted\n   104:unformatted   105:unformatted   106:unformatted   107:unformatted\n   108:unformatted   109:unformatted   110:unformatted   111:unformatted\n   112:unformatted   113:unformatted   114:unformatted   115:unformatted\n   116:unformatted   117:unformatted   118:unformatted   119:unformatted\n   120:unformatted   121:unformatted   122:unformatted   123:unformatted\n   124:unformatted   125:unformatted   126:unformatted   127:unformatted\n   128:unformatted   129:unformatted   130:unformatted   131:unformatted\n   132:unformatted   133:unformatted   134:unformatted   135:unformatted\n   136:unformatted   137:unformatted   138:unformatted   139:unformatted\n   140:unformatted   141:unformatted   142:unformatted   143:unformatted\n   144:unformatted   145:unformatted   146:unformatted   147:unformatted\n   148:unformatted   149:unformatted   150:unformatted   151:unformatted\n   152:unformatted   153:unformatted   154:unformatted   155:unformatted\n   156:unformatted   157:unformatted   158:unformatted   159:unformatted\n   160:unformatted   161:unformatted   162:unformatted   163:unformatted\n   164:unformatted   165:unformatted   166:unformatted   167:unformatted\n   168:unformatted   169:unformatted   170:unformatted   171:unformatted\n   172:unformatted   173:unformatted   174:unformatted   175:unformatted\n   176:unformatted   177:unformatted   178:unformatted   179:unformatted\n   180:unformatted   181:unformatted   182:unformatted   183:unformatted\n   184:unformatted   185:unformatted   186:unformatted   187:unformatted\n   188:unformatted   189:unformatted   190:unformatted   191:unformatted\n   192:unformatted   193:unformatted   194:unformatted   195:unformatted\n   196:unformatted   197:unformatted   198:unformatted   199:unformatted\n   200:unformatted   201:unformatted   202:unformatted   203:unformatted\n   204:unformatted   205:unformatted   206:unformatted   207:unformatted\n   208:unformatted   209:unformatted   210:unformatted   211:unformatted\n   212:unformatted   213:unformatted   214:unformatted   215:unformatted\n   216:unformatted   217:unformatted   218:unformatted   219:unformatted\n   220:unformatted   221:unformatted   222:unformatted   223:unformatted\n   224:unformatted   225:unformatted   226:unformatted   227:unformatted\n   228:unformatted   229:unformatted   230:unformatted   231:unformatted\n   232:unformatted   233:unformatted   234:unformatted   235:unformatted\n   236:unformatted   237:unformatted   238:unformatted   239:unformatted\n   240:unformatted   241:unformatted   242:unformatted   243:unformatted\n   244:unformatted   245:unformatted   246:unformatted   247:unformatted\n   248:unformatted   249:unformatted   250:unformatted   251:unformatted\n   252:unformatted   253:unformatted   254:unformatted   255:unformatted\n  --------------------------------------------------------\nEnd dump data blocks tsn: 8 file#: 5 minblk 8192 maxblk 8192\n```\n\n>256个块，2M 2个区，可见L1中块的数量会随着段大小的改变而做调整的，可以增大到1024个甚至更多，我在这里不去再做验证，将重点放在高水位上，根据我们之前观察到的现象，高水位在第二个L1的地一个块，也可说第一个L1的末端，那么现在的L1里有256个块，高水位是不是也会推进到这个L1的末端呢？很容易进行验证，将数据插满到这个L1的前几个块再去观察段头高水位的变化就行了，那么插多少条呢？再来计算一下，当前的L1是8192号块，前面一共63个区，每个区里面两个L1，加上第一个区里面的一个L2和L3，我们需要插满8192-63*2-2=8064\n\n```sql\ndeclare\ni number;\nbegin\nfor i in 1..8064 loop\ninsert into lp values(i,'a','a','a','a');\nend loop;\nend;\n/\n```\n\n>观察62号区的第二个L1，第一个L1的地址是0x01401f80，那么第二个就是01401f81，5号文件8065号块，dump出来的结果\n\n```\nDBA Ranges :\n  --------------------------------------------------------\n   0x01401fc0  Length: 64     Offset: 0      \n\n   0:FULL   1:FULL   2:FULL   3:FULL\n   4:FULL   5:FULL   6:FULL   7:FULL\n   8:FULL   9:FULL   10:FULL   11:FULL\n   12:FULL   13:FULL   14:FULL   15:FULL\n   16:FULL   17:FULL   18:FULL   19:FULL\n   20:FULL   21:FULL   22:FULL   23:FULL\n   24:FULL   25:FULL   26:FULL   27:FULL\n   28:FULL   29:FULL   30:FULL   31:FULL\n   32:FULL   33:FULL   34:FULL   35:FULL\n   36:FULL   37:FULL   38:FULL   39:FULL\n   40:FULL   41:FULL   42:FULL   43:FULL\n   44:FULL   45:FULL   46:FULL   47:FULL\n   48:FULL   49:FULL   50:FULL   51:FULL\n   52:FULL   53:FULL   54:FULL   55:FULL\n   56:FULL   57:FULL   58:FULL   59:FULL\n   60:FULL   61:FULL   62:FULL   63:FULL\n  --------------------------------------------------------\nEnd dump data blocks tsn: 8 file#: 5 minblk 8065 maxblk 8065\n```\n\n>居然全满了？再看8192号L1呢\n\n```\nDBA Ranges :\n  --------------------------------------------------------\n   0x01402000  Length: 128    Offset: 0      \n   0x01402080  Length: 128    Offset: 128    \n\n   0:Metadata   1:FULL   2:FULL   3:FULL\n   4:FULL   5:FULL   6:FULL   7:FULL\n   8:FULL   9:FULL   10:FULL   11:FULL\n   12:FULL   13:FULL   14:FULL   15:FULL\n   16:FULL   17:FULL   18:FULL   19:FULL\n   20:FULL   21:FULL   22:FULL   23:FULL\n   24:FULL   25:FULL   26:FULL   27:FULL\n   28:FULL   29:FULL   30:FULL   31:FULL\n   32:FULL   33:FULL   34:FULL   35:FULL\n   36:FULL   37:FULL   38:FULL   39:FULL\n   40:FULL   41:FULL   42:FULL   43:FULL\n   44:FULL   45:FULL   46:FULL   47:FULL\n   48:FULL   49:FULL   50:FULL   51:FULL\n   52:FULL   53:FULL   54:FULL   55:FULL\n   56:FULL   57:FULL   58:FULL   59:FULL\n   60:FULL   61:FULL   62:FULL   63:FULL\n   64:FULL   65:FULL   66:FULL   67:FULL\n   68:FULL   69:FULL   70:FULL   71:FULL\n   72:FULL   73:FULL   74:FULL   75:FULL\n   76:FULL   77:FULL   78:FULL   79:FULL\n   80:FULL   81:FULL   82:FULL   83:FULL\n   84:FULL   85:FULL   86:FULL   87:FULL\n   88:FULL   89:FULL   90:FULL   91:FULL\n   92:FULL   93:FULL   94:FULL   95:FULL\n   96:FULL   97:FULL   98:FULL   99:FULL\n   100:FULL   101:FULL   102:FULL   103:FULL\n   104:FULL   105:FULL   106:FULL   107:FULL\n   108:FULL   109:FULL   110:FULL   111:FULL\n   112:FULL   113:FULL   114:FULL   115:FULL\n   116:FULL   117:FULL   118:FULL   119:FULL\n   120:FULL   121:FULL   122:FULL   123:FULL\n   124:FULL   125:FULL   126:FULL   127:FULL\n   128:unformatted   129:unformatted   130:unformatted   131:unformatted\n   132:unformatted   133:unformatted   134:unformatted   135:unformatted\n   136:unformatted   137:unformatted   138:unformatted   139:unformatted\n   140:unformatted   141:unformatted   142:unformatted   143:unformatted\n   144:75-100% free   145:75-100% free   146:75-100% free   147:75-100% free\n   148:75-100% free   149:75-100% free   150:75-100% free   151:75-100% free\n   152:75-100% free   153:75-100% free   154:75-100% free   155:FULL\n   156:75-100% free   157:75-100% free   158:75-100% free   159:75-100% free\n   160:75-100% free   161:75-100% free   162:75-100% free   163:FULL\n   164:75-100% free   165:75-100% free   166:75-100% free   167:75-100% free\n   168:75-100% free   169:75-100% free   170:75-100% free   171:75-100% free\n   172:75-100% free   173:75-100% free   174:75-100% free   175:75-100% free\n   176:unformatted   177:unformatted   178:unformatted   179:unformatted\n   180:unformatted   181:unformatted   182:unformatted   183:unformatted\n   184:unformatted   185:unformatted   186:unformatted   187:unformatted\n   188:unformatted   189:unformatted   190:unformatted   191:unformatted\n   192:unformatted   193:unformatted   194:unformatted   195:unformatted\n   196:unformatted   197:unformatted   198:unformatted   199:unformatted\n   200:unformatted   201:unformatted   202:unformatted   203:unformatted\n   204:unformatted   205:unformatted   206:unformatted   207:unformatted\n   208:unformatted   209:unformatted   210:unformatted   211:unformatted\n   212:unformatted   213:unformatted   214:unformatted   215:unformatted\n   216:unformatted   217:unformatted   218:unformatted   219:unformatted\n   220:unformatted   221:unformatted   222:unformatted   223:unformatted\n   224:unformatted   225:unformatted   226:unformatted   227:unformatted\n   228:unformatted   229:unformatted   230:unformatted   231:unformatted\n   232:unformatted   233:unformatted   234:unformatted   235:unformatted\n   236:unformatted   237:unformatted   238:unformatted   239:unformatted\n   240:unformatted   241:unformatted   242:unformatted   243:unformatted\n   244:unformatted   245:unformatted   246:unformatted   247:unformatted\n   248:unformatted   249:unformatted   250:unformatted   251:unformatted\n   252:unformatted   253:unformatted   254:unformatted   255:unformatted\n  --------------------------------------------------------\nEnd dump data blocks tsn: 8 file#: 5 minblk 8192 maxblk 8192\n```\n\n>完蛋了，计算错误，L1下面的第二个区也已经被格式化了，看段头信息\n\n```\nExtent Control Header\n  -----------------------------------------------------------------\n  Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928\n                  last map  0x00000000  #maps: 0      offset: 2716  \n      Highwater::  0x01402100  ext#: 64     blk#: 128    ext size: 128   \n  #blocks in seg. hdr's freelists: 0     \n  #blocks below: 8191  \n  mapblk  0x00000000  offset: 64   \n```\n\n>果然高水位指到了第66个区的L1块地址，这会影响我们的判断，到底哪里出问题了呢？观察8192号块内容是后128个块里被插入了2条，前128个块全满，也就是说我多插了130个块，后来猛然醒悟，我使用DBA来计算的，忘记减去128个块的文件头了，这么一算结果相查差还是不大的，太马虎了，要不是因为马虎哥也能上清华北大了；然后该怎么办呢？重新来过？不用！既然这个L1推过头了，索性把它堆满，然后我们去观察下一个L1，这下就好计算了；\n\n```sql\ndeclare\ni number;\nbegin\nfor i in 1..126 loop\ninsert into lp values(i,'a','a','a','a');\nend loop;\nend;\n/\n```\n\n>观察8192号块\n\n```\n DBA Ranges :\n  --------------------------------------------------------\n   0x01402000  Length: 128    Offset: 0      \n   0x01402080  Length: 128    Offset: 128    \n\n   0:Metadata   1:FULL   2:FULL   3:FULL\n   4:FULL   5:FULL   6:FULL   7:FULL\n   8:FULL   9:FULL   10:FULL   11:FULL\n   12:FULL   13:FULL   14:FULL   15:FULL\n   16:FULL   17:FULL   18:FULL   19:FULL\n   20:FULL   21:FULL   22:FULL   23:FULL\n   24:FULL   25:FULL   26:FULL   27:FULL\n   28:FULL   29:FULL   30:FULL   31:FULL\n   32:FULL   33:FULL   34:FULL   35:FULL\n   36:FULL   37:FULL   38:FULL   39:FULL\n   40:FULL   41:FULL   42:FULL   43:FULL\n   44:FULL   45:FULL   46:FULL   47:FULL\n   48:FULL   49:FULL   50:FULL   51:FULL\n   52:FULL   53:FULL   54:FULL   55:FULL\n   56:FULL   57:FULL   58:FULL   59:FULL\n   60:FULL   61:FULL   62:FULL   63:FULL\n   64:FULL   65:FULL   66:FULL   67:FULL\n   68:FULL   69:FULL   70:FULL   71:FULL\n   72:FULL   73:FULL   74:FULL   75:FULL\n   76:FULL   77:FULL   78:FULL   79:FULL\n   80:FULL   81:FULL   82:FULL   83:FULL\n   84:FULL   85:FULL   86:FULL   87:FULL\n   88:FULL   89:FULL   90:FULL   91:FULL\n   92:FULL   93:FULL   94:FULL   95:FULL\n   96:FULL   97:FULL   98:FULL   99:FULL\n   100:FULL   101:FULL   102:FULL   103:FULL\n   104:FULL   105:FULL   106:FULL   107:FULL\n   108:FULL   109:FULL   110:FULL   111:FULL\n   112:FULL   113:FULL   114:FULL   115:FULL\n   116:FULL   117:FULL   118:FULL   119:FULL\n   120:FULL   121:FULL   122:FULL   123:FULL\n   124:FULL   125:FULL   126:FULL   127:FULL\n   128:FULL   129:FULL   130:FULL   131:FULL\n   132:FULL   133:FULL   134:FULL   135:FULL\n   136:FULL   137:FULL   138:FULL   139:FULL\n   140:FULL   141:FULL   142:FULL   143:FULL\n   144:FULL   145:FULL   146:FULL   147:FULL\n   148:FULL   149:FULL   150:FULL   151:FULL\n   152:FULL   153:FULL   154:FULL   155:FULL\n   156:FULL   157:FULL   158:FULL   159:FULL\n   160:FULL   161:FULL   162:FULL   163:FULL\n   164:FULL   165:FULL   166:FULL   167:FULL\n   168:FULL   169:FULL   170:FULL   171:FULL\n   172:FULL   173:FULL   174:FULL   175:FULL\n   176:FULL   177:FULL   178:FULL   179:FULL\n   180:FULL   181:FULL   182:FULL   183:FULL\n   184:FULL   185:FULL   186:FULL   187:FULL\n   188:FULL   189:FULL   190:FULL   191:FULL\n   192:FULL   193:FULL   194:FULL   195:FULL\n   196:FULL   197:FULL   198:FULL   199:FULL\n   200:FULL   201:FULL   202:FULL   203:FULL\n   204:FULL   205:FULL   206:FULL   207:FULL\n   208:FULL   209:FULL   210:FULL   211:FULL\n   212:FULL   213:FULL   214:FULL   215:FULL\n   216:FULL   217:FULL   218:FULL   219:FULL\n   220:FULL   221:FULL   222:FULL   223:FULL\n   224:FULL   225:FULL   226:FULL   227:FULL\n   228:FULL   229:FULL   230:FULL   231:FULL\n   232:FULL   233:FULL   234:FULL   235:FULL\n   236:FULL   237:FULL   238:FULL   239:FULL\n   240:FULL   241:FULL   242:FULL   243:FULL\n   244:FULL   245:FULL   246:FULL   247:FULL\n   248:FULL   249:FULL   250:FULL   251:FULL\n   252:FULL   253:FULL   254:FULL   255:FULL\n  --------------------------------------------------------\nEnd dump data blocks tsn: 8 file#: 5 minblk 8192 maxblk 8192\n```\n\n>已经全满了，这个时候我们再去看一下段头的高水位\n\n```\n Extent Control Header\n  -----------------------------------------------------------------\n  Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928\n                  last map  0x00000000  #maps: 0      offset: 2716  \n      Highwater::  0x01402100  ext#: 64     blk#: 128    ext size: 128   \n  #blocks in seg. hdr's freelists: 0     \n  #blocks below: 8191  \n  mapblk  0x00000000  offset: 64\n```\n\n>没有动，看来oracle也是事不到眼前不知道着急啊，来看一看下一个L1\n\n```sql\nSQL> select dbms_utility.data_block_address_file(to_number('01402100', 'xxxxxxxx')) file#,\n  2 dbms_utility.data_block_address_block(to_number('01402100', 'xxxxxxxx')) block#\n  3 from dual;\n\n     FILE# BLOCK#\n---------- ----------\n         5 8448\n```\n\n>这个L1是5号文件8448号块，dump出来\n\n```\n DBA Ranges :\n  --------------------------------------------------------\n   0x01402100  Length: 128    Offset: 0      \n   0x01402180  Length: 128    Offset: 128    \n\n   0:Metadata   1:unformatted   2:unformatted   3:unformatted\n   4:unformatted   5:unformatted   6:unformatted   7:unformatted\n   8:unformatted   9:unformatted   10:unformatted   11:unformatted\n   12:unformatted   13:unformatted   14:unformatted   15:unformatted\n   16:unformatted   17:unformatted   18:unformatted   19:unformatted\n   20:unformatted   21:unformatted   22:unformatted   23:unformatted\n   24:unformatted   25:unformatted   26:unformatted   27:unformatted\n   28:unformatted   29:unformatted   30:unformatted   31:unformatted\n   32:unformatted   33:unformatted   34:unformatted   35:unformatted\n   36:unformatted   37:unformatted   38:unformatted   39:unformatted\n   40:unformatted   41:unformatted   42:unformatted   43:unformatted\n   44:unformatted   45:unformatted   46:unformatted   47:unformatted\n   48:unformatted   49:unformatted   50:unformatted   51:unformatted\n   52:unformatted   53:unformatted   54:unformatted   55:unformatted\n   56:unformatted   57:unformatted   58:unformatted   59:unformatted\n   60:unformatted   61:unformatted   62:unformatted   63:unformatted\n   64:unformatted   65:unformatted   66:unformatted   67:unformatted\n   68:unformatted   69:unformatted   70:unformatted   71:unformatted\n   72:unformatted   73:unformatted   74:unformatted   75:unformatted\n   76:unformatted   77:unformatted   78:unformatted   79:unformatted\n   80:unformatted   81:unformatted   82:unformatted   83:unformatted\n   84:unformatted   85:unformatted   86:unformatted   87:unformatted\n   88:unformatted   89:unformatted   90:unformatted   91:unformatted\n   92:unformatted   93:unformatted   94:unformatted   95:unformatted\n   96:unformatted   97:unformatted   98:unformatted   99:unformatted\n   100:unformatted   101:unformatted   102:unformatted   103:unformatted\n   104:unformatted   105:unformatted   106:unformatted   107:unformatted\n   108:unformatted   109:unformatted   110:unformatted   111:unformatted\n   112:unformatted   113:unformatted   114:unformatted   115:unformatted\n   116:unformatted   117:unformatted   118:unformatted   119:unformatted\n   120:unformatted   121:unformatted   122:unformatted   123:unformatted\n   124:unformatted   125:unformatted   126:unformatted   127:unformatted\n   128:unformatted   129:unformatted   130:unformatted   131:unformatted\n   132:unformatted   133:unformatted   134:unformatted   135:unformatted\n   136:unformatted   137:unformatted   138:unformatted   139:unformatted\n   140:unformatted   141:unformatted   142:unformatted   143:unformatted\n   144:unformatted   145:unformatted   146:unformatted   147:unformatted\n   148:unformatted   149:unformatted   150:unformatted   151:unformatted\n   152:unformatted   153:unformatted   154:unformatted   155:unformatted\n   156:unformatted   157:unformatted   158:unformatted   159:unformatted\n   160:unformatted   161:unformatted   162:unformatted   163:unformatted\n   164:unformatted   165:unformatted   166:unformatted   167:unformatted\n   168:unformatted   169:unformatted   170:unformatted   171:unformatted\n   172:unformatted   173:unformatted   174:unformatted   175:unformatted\n   176:unformatted   177:unformatted   178:unformatted   179:unformatted\n   180:unformatted   181:unformatted   182:unformatted   183:unformatted\n   184:unformatted   185:unformatted   186:unformatted   187:unformatted\n   188:unformatted   189:unformatted   190:unformatted   191:unformatted\n   192:unformatted   193:unformatted   194:unformatted   195:unformatted\n   196:unformatted   197:unformatted   198:unformatted   199:unformatted\n   200:unformatted   201:unformatted   202:unformatted   203:unformatted\n   204:unformatted   205:unformatted   206:unformatted   207:unformatted\n   208:unformatted   209:unformatted   210:unformatted   211:unformatted\n   212:unformatted   213:unformatted   214:unformatted   215:unformatted\n   216:unformatted   217:unformatted   218:unformatted   219:unformatted\n   220:unformatted   221:unformatted   222:unformatted   223:unformatted\n   224:unformatted   225:unformatted   226:unformatted   227:unformatted\n   228:unformatted   229:unformatted   230:unformatted   231:unformatted\n   232:unformatted   233:unformatted   234:unformatted   235:unformatted\n   236:unformatted   237:unformatted   238:unformatted   239:unformatted\n   240:unformatted   241:unformatted   242:unformatted   243:unformatted\n   244:unformatted   245:unformatted   246:unformatted   247:unformatted\n   248:unformatted   249:unformatted   250:unformatted   251:unformatted\n   252:unformatted   253:unformatted   254:unformatted   255:unformatted\n  --------------------------------------------------------\nEnd dump data blocks tsn: 8 file#: 5 minblk 8448 maxblk 8448\n```\n\n>256个块，除了第一个是L1元数据之外，没有一个格式化的，这就达到了我们的目的，我现在要插入一条数据，迫使高水位推动，猜一下高水位会在哪？在L1管理的最后一个块后面么？\n看插入一行数据之后的8448号块\n\n```\nDBA Ranges :\n  --------------------------------------------------------\n   0x01402100  Length: 128    Offset: 0      \n   0x01402180  Length: 128    Offset: 128    \n\n   0:Metadata   1:unformatted   2:unformatted   3:unformatted\n   4:unformatted   5:unformatted   6:unformatted   7:unformatted\n   8:unformatted   9:unformatted   10:unformatted   11:unformatted\n   12:unformatted   13:unformatted   14:unformatted   15:unformatted\n   16:75-100% free   17:75-100% free   18:75-100% free   19:75-100% free\n   20:75-100% free   21:75-100% free   22:75-100% free   23:75-100% free\n   24:75-100% free   25:75-100% free   26:75-100% free   27:75-100% free\n   28:FULL   29:75-100% free   30:75-100% free   31:75-100% free\n   32:unformatted   33:unformatted   34:unformatted   35:unformatted\n   36:unformatted   37:unformatted   38:unformatted   39:unformatted\n   40:unformatted   41:unformatted   42:unformatted   43:unformatted\n   44:unformatted   45:unformatted   46:unformatted   47:unformatted\n   48:unformatted   49:unformatted   50:unformatted   51:unformatted\n   52:unformatted   53:unformatted   54:unformatted   55:unformatted\n   56:unformatted   57:unformatted   58:unformatted   59:unformatted\n   60:unformatted   61:unformatted   62:unformatted   63:unformatted\n   64:unformatted   65:unformatted   66:unformatted   67:unformatted\n   68:unformatted   69:unformatted   70:unformatted   71:unformatted\n   72:unformatted   73:unformatted   74:unformatted   75:unformatted\n   76:unformatted   77:unformatted   78:unformatted   79:unformatted\n   80:unformatted   81:unformatted   82:unformatted   83:unformatted\n   84:unformatted   85:unformatted   86:unformatted   87:unformatted\n   88:unformatted   89:unformatted   90:unformatted   91:unformatted\n   92:unformatted   93:unformatted   94:unformatted   95:unformatted\n   96:unformatted   97:unformatted   98:unformatted   99:unformatted\n   100:unformatted   101:unformatted   102:unformatted   103:unformatted\n   104:unformatted   105:unformatted   106:unformatted   107:unformatted\n   108:unformatted   109:unformatted   110:unformatted   111:unformatted\n   112:unformatted   113:unformatted   114:unformatted   115:unformatted\n   116:unformatted   117:unformatted   118:unformatted   119:unformatted\n   120:unformatted   121:unformatted   122:unformatted   123:unformatted\n   124:unformatted   125:unformatted   126:unformatted   127:unformatted\n   128:unformatted   129:unformatted   130:unformatted   131:unformatted\n   132:unformatted   133:unformatted   134:unformatted   135:unformatted\n   136:unformatted   137:unformatted   138:unformatted   139:unformatted\n   140:unformatted   141:unformatted   142:unformatted   143:unformatted\n   144:unformatted   145:unformatted   146:unformatted   147:unformatted\n   148:unformatted   149:unformatted   150:unformatted   151:unformatted\n   152:unformatted   153:unformatted   154:unformatted   155:unformatted\n   156:unformatted   157:unformatted   158:unformatted   159:unformatted\n   160:unformatted   161:unformatted   162:unformatted   163:unformatted\n   164:unformatted   165:unformatted   166:unformatted   167:unformatted\n   168:unformatted   169:unformatted   170:unformatted   171:unformatted\n   172:unformatted   173:unformatted   174:unformatted   175:unformatted\n   176:unformatted   177:unformatted   178:unformatted   179:unformatted\n   180:unformatted   181:unformatted   182:unformatted   183:unformatted\n   184:unformatted   185:unformatted   186:unformatted   187:unformatted\n   188:unformatted   189:unformatted   190:unformatted   191:unformatted\n   192:unformatted   193:unformatted   194:unformatted   195:unformatted\n   196:unformatted   197:unformatted   198:unformatted   199:unformatted\n   200:unformatted   201:unformatted   202:unformatted   203:unformatted\n   204:unformatted   205:unformatted   206:unformatted   207:unformatted\n   208:unformatted   209:unformatted   210:unformatted   211:unformatted\n   212:unformatted   213:unformatted   214:unformatted   215:unformatted\n   216:unformatted   217:unformatted   218:unformatted   219:unformatted\n   220:unformatted   221:unformatted   222:unformatted   223:unformatted\n   224:unformatted   225:unformatted   226:unformatted   227:unformatted\n   228:unformatted   229:unformatted   230:unformatted   231:unformatted\n   232:unformatted   233:unformatted   234:unformatted   235:unformatted\n   236:unformatted   237:unformatted   238:unformatted   239:unformatted\n   240:unformatted   241:unformatted   242:unformatted   243:unformatted\n   244:unformatted   245:unformatted   246:unformatted   247:unformatted\n   248:unformatted   249:unformatted   250:unformatted   251:unformatted\n   252:unformatted   253:unformatted   254:unformatted   255:unformatted\n  --------------------------------------------------------\nEnd dump data blocks tsn: 8 file#: 5 minblk 8448 maxblk 8448\n```\n\n>有一个块已经满了，揭晓答案的时候来了，dump出段头\n\n```\nExtent Control Header\n  -----------------------------------------------------------------\n  Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928\n                  last map  0x00000000  #maps: 0      offset: 2716  \n      Highwater::  0x01402180  ext#: 65     blk#: 128    ext size: 128   \n  #blocks in seg. hdr's freelists: 0     \n  #blocks below: 8318  \n  mapblk  0x00000000  offset: 65\n```\n\n>高水位是0x01402180，这个地址在哪呢？0x01402180比0x01402100多了十六进制80个块，就是十进制的128个块，仅仅是推动了一个区的大小，并不是一个L1的大小，这说明常规路径下插入高水位的推动是以L1和区中小的那个单位来推动的，就是L1小就推动L1里面所有块的大小，区小就推动一个区的大小，可见所谓的高并发并非像宣传的那样，还是受高水位的限制的，这个时候的区块大概像下面这个样子：\n\n![](http://oaowhilvu.bkt.clouddn.com/%E6%89%A9%E5%B1%95%E7%9A%84L1.png)\n\n>开几个session做下插入试试\n\n```sql\nSQL> select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp where trim(des1)='b';\n\n                                   5                                 8474\n                                   5                                 8482\n                                   5                                 8484\n                                   5                                 8488\n                                   5                                 8489\n                                   5                                 8490\n                                   5                                 8491\n                                   5                                 8492\n                                   5                                 8493\n                                   5                                 8494\n                                   5                                 8495\n                                   5                                 8496\n                                   5                                 8498\n                                   5                                 8500\n                                   5                                 8504\n                                   5                                 8506\n                                   5                                 8512\n                                   5                                 8514\n                                   5                                 8520\n                                   5                                 8522\n\n20 rows selected.\n```\n\n>全部是在高水位之下\n这个实验有一点值得思考，就是PCTFREE如何设置，在插入删除频繁的段，PCTFREE的值应该要远离三个百分比线，就是25%/50%/75%，避免频繁插入删除的时候块状态频繁改变，由full变为非full，如此就会修改L1块的内容，有可能造成buffer busy waits。\n而大家熟知的直接路径下的插入是直接在高水位之上插入并且绕过cache buffer的，这种情况下的高水位是如何推动的呢？我们再慢慢分析.\n","slug":"oracle/architecture/ASSM1","published":1,"updated":"2019-07-21T05:04:46.580Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjychzpy00008fn0ea4k3rgs2","content":"<p>#ASSM三级位图结构与高水位的探究</p>\n<blockquote>\n<p>三级位图</p>\n</blockquote>\n<p>Oracle9i在本地表空管理(LMT)的基础上，对段空间管理也引入了位图管理（Segment Space Management Auto）来取代原来的freelist管理方式（Segment Space Management Manual）。<br>但是默认system和undo表空间仍然是MSSM的管理方式，本文主要探究ASSM管理方式下，段的三级位图结构和高水位推进的关系 先来看<br>ASSM管理方式下的三级位图结构图：</p>\n<p><img alt data-src=\"http://oaowhilvu.bkt.clouddn.com/%E4%B8%89%E7%BA%A7%E4%BD%8D%E5%9B%BE.jpg\"><br><em>注：此图来源于网络</em><br>一个段被创建之后，段头其实是一个L3块，在我的试验中，一个1M固定区大小，block为8K的表空间，创建的第一个段第0个区，前两个块是L1（128,129号块），第三个是L2（130号块），第四个是L3（131号块），前128个块是数据文件头，本文不讨论。<br>当数据被插入的时候，oracle根据连接进来的session，做hash运算，随机选择一个L3（如果有多个的话），再随机选择一个L2，接下来在该L2下随机选择一个L1，再从L1中管理的block里面随机选择一个块将数据插入，不同的session经过hash之后，最后落到block时已经是很分散的了，不会产生很多和会话同时往一个block中插数据申请独占buffer pin，而造成大量buffer busy waits的情况，这就是ASSM号称支持大并发插入的原理所在，但是事实上真的如此么？我们来一探究竟！</p>\n<blockquote>\n<p>实验环境</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">OS:REDHAT6.5 X64</span><br><span class=\"line\">DB VERSION:11.2.0.4</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>首先，创建一个1M区大小的表空间，并在上面创建一张表，此表创建了4个空间很大的字段，目的是要一行占满一个block，便于观察结果</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select file#,NAME,BYTES/1024/1204 from v$datafile;</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\"># NAME                                                                             BYTES/1024/1204</span></span><br><span class=\"line\"><span class=\"comment\">---------- -------------------------------------------------------------------------------- ---------------</span></span><br><span class=\"line\">         1 +DATA/min/datafile/system.256.854775095                                               637.873754</span><br><span class=\"line\">         2 +DATA/min/datafile/sysaux.257.854775097                                               484.784053</span><br><span class=\"line\">         3 +DATA/min/datafile/undotbs1.258.854775097                                             187.109635</span><br><span class=\"line\">         4 +DATA/min/datafile/users.259.854775097                                                103.122924</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; create tablespace lp datafile '+DATA/min/datafile/lp.dbf' size 2048M uniform size 1m;</span><br><span class=\"line\"></span><br><span class=\"line\">Tablespace created.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; select file#,NAME,BYTES/1024/1204 from v$datafile;</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\"># NAME                                                                             BYTES/1024/1204</span></span><br><span class=\"line\"><span class=\"comment\">---------- -------------------------------------------------------------------------------- ---------------</span></span><br><span class=\"line\">         1 +DATA/min/datafile/system.256.854775095                                               637.873754</span><br><span class=\"line\">         2 +DATA/min/datafile/sysaux.257.854775097                                               484.784053</span><br><span class=\"line\">         3 +DATA/min/datafile/undotbs1.258.854775097                                             187.109635</span><br><span class=\"line\">         4 +DATA/min/datafile/users.259.854775097                                                103.122924</span><br><span class=\"line\">         5 +DATA/min/datafile/lp.dbf                                                              1741.8206</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; create table lp (id number,des1 char(2000),des2 char(2000),des3 char(2000),des4 char(500)) tablespace lp;</span><br><span class=\"line\"></span><br><span class=\"line\">Table created.</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>观察新建的表所占区</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; col SEGMENT_NAME for a30</span><br><span class=\"line\">SQL&gt; col des1 for a1</span><br><span class=\"line\">SQL&gt; col des2 for a1</span><br><span class=\"line\">SQL&gt; col des3 for a1</span><br><span class=\"line\">SQL&gt; col des4 for a1</span><br><span class=\"line\">SQL&gt; set line 200</span><br><span class=\"line\">SQL&gt; select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID, BLOCKS from dba_extents where segment_name='LP';</span><br><span class=\"line\"></span><br><span class=\"line\">SEGMENT_NAME                    EXTENT_ID    FILE_ID   BLOCK_ID     BLOCKS</span><br><span class=\"line\"><span class=\"comment\">------------------------------ ---------- ---------- ---------- ----------</span></span><br><span class=\"line\">LP                                      0          5        128        128</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>此表是5号文件，拥有1个区，block从128号开始，接下来我们插入一条数据，并dump出段头进行观察</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; insert into lp values(1,'a','a','a','a');</span><br><span class=\"line\"></span><br><span class=\"line\">1 row created.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; commit;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">Commit</span> complete.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">SQL</span>&gt; <span class=\"keyword\">select</span> segment_name ,HEADER_FILE,HEADER_BLOCK <span class=\"keyword\">from</span> dba_segments <span class=\"keyword\">where</span> segment_name=<span class=\"string\">'LP'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">SEGMENT_NAME                   HEADER_FILE HEADER_BLOCK</span><br><span class=\"line\"><span class=\"comment\">------------------------------ ----------- ------------</span></span><br><span class=\"line\">LP                                       5          131</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; alter system checkpoint;</span><br><span class=\"line\"></span><br><span class=\"line\">System altered.</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>LP的段头是5号文件，131号块，进行dump</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; alter system dump datafile 5 block 131;</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; col value for a65</span><br><span class=\"line\">SQL&gt; select *  from v$diag_info;</span><br><span class=\"line\"></span><br><span class=\"line\">   INST_ID NAME                                                                             VALUE</span><br><span class=\"line\"><span class=\"comment\">---------- -------------------------------------------------------------------------------- -----------------------------------------------------------------</span></span><br><span class=\"line\">         1 Diag Enabled                                                                     TRUE</span><br><span class=\"line\">         1 ADR Base                                                                         /u01/app/oracle</span><br><span class=\"line\">         1 ADR Home                                                                         /u01/app/oracle/diag/rdbms/min/min</span><br><span class=\"line\">         1 Diag Trace                                                                       /u01/app/oracle/diag/rdbms/min/min/trace</span><br><span class=\"line\">         1 Diag Alert                                                                       /u01/app/oracle/diag/rdbms/min/min/alert</span><br><span class=\"line\">         1 Diag Incident                                                                    /u01/app/oracle/diag/rdbms/min/min/incident</span><br><span class=\"line\">         1 Diag Cdump                                                                       /u01/app/oracle/diag/rdbms/min/min/cdump</span><br><span class=\"line\">         1 Health Monitor                                                                   /u01/app/oracle/diag/rdbms/min/min/hm</span><br><span class=\"line\">         1 Default Trace File                                                               /u01/app/oracle/diag/rdbms/min/min/trace/min_ora_2835.trc</span><br><span class=\"line\">         1 Active Problem Count                                                             0</span><br><span class=\"line\">         1 Active Incident Count                                                            0</span><br><span class=\"line\"></span><br><span class=\"line\">11 rows selected.</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>观察trc文件min_ora_2835.trc</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Block dump from disk:</span><br><span class=\"line\">buffer tsn: 8 rdba: 0x01400083 (5/131)</span><br><span class=\"line\">scn: 0x0000.00140d51 seq: 0x01 flg: 0x04 tail: 0x0d512301</span><br><span class=\"line\">frmt: 0x02 chkval: 0xfd8a type: 0x23=PAGETABLE SEGMENT HEADER</span><br><span class=\"line\">Hex dump of block: st=0, typ_found=1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Extent Control Header</span><br><span class=\"line\">  -----------------------------------------------------------------</span><br><span class=\"line\">  Extent Header:: spare1: 0      spare2: 0      #extents: 1      #blocks: 128   </span><br><span class=\"line\">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class=\"line\">      Highwater::  0x014000c0  ext#: 0      blk#: 64     ext size: 128   </span><br><span class=\"line\">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class=\"line\">  #blocks below: 60    </span><br><span class=\"line\">  mapblk  0x00000000  offset: 0     </span><br><span class=\"line\">                   Unlocked</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">  Low HighWater Mark :</span><br><span class=\"line\">      Highwater::  0x01400084  ext#: 0      blk#: 4      ext size: 128   </span><br><span class=\"line\">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class=\"line\">  #blocks below: 0     </span><br><span class=\"line\">  mapblk  0x00000000  offset: 0     </span><br><span class=\"line\">  Level 1 BMB for High HWM block: 0x01400080</span><br><span class=\"line\">  Level 1 BMB for Low HWM block: 0x01400080</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">  Segment Type: 1 nl2: 1      blksz: 8192   fbsz: 0      </span><br><span class=\"line\">  L2 Array start offset:  0x00001434</span><br><span class=\"line\">  First Level 3 BMB:  0x00000000</span><br><span class=\"line\">  L2 Hint for inserts:  0x01400082</span><br><span class=\"line\">  Last Level 1 BMB:  0x01400081</span><br><span class=\"line\">  Last Level II BMB:  0x01400082</span><br><span class=\"line\">  Last Level III BMB:  0x00000000</span><br><span class=\"line\">     Map Header:: next  0x00000000  #extents: 1    obj#: 87596  flag: 0x10000000</span><br><span class=\"line\">  Inc # 0</span><br><span class=\"line\">  Extent Map</span><br><span class=\"line\">  -----------------------------------------------------------------</span><br><span class=\"line\">   0x01400080  length: 128   </span><br><span class=\"line\"></span><br><span class=\"line\">  Auxillary Map</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   Extent 0     :  L1 dba:  0x01400080 Data dba:  0x01400084</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">Second Level Bitmap block DBAs</span><br><span class=\"line\">   --------------------------------------------------------</span><br><span class=\"line\">   DBA 1:   0x01400082</span><br><span class=\"line\"></span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 131 maxblk 131</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>很容易发现这是一个PAGETABLE SEGMENT HEADER块，Extent Map中只有一个区，另外在尾部有一个指向二级位图块的地址0x01400082，这是数据块地址的二进制用十六进制来表示，我们来将其转化成直观一点的信息</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select dbms_utility.data_block_address_file(to_number('01400082', 'xxxxxxxx')) file#,</span><br><span class=\"line\">  2 dbms_utility.data_block_address_block(to_number('01400082', 'xxxxxxxx')) block<span class=\"comment\">#</span></span><br><span class=\"line\">  3 from dual;</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\"># BLOCK#</span></span><br><span class=\"line\"><span class=\"comment\">---------- ----------</span></span><br><span class=\"line\">         5 130</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>依样将5号文件130号块的内容dump出来</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Block dump from disk:</span><br><span class=\"line\">buffer tsn: 8 rdba: 0x01400082 (5/130)</span><br><span class=\"line\">scn: 0x0000.00140a45 seq: 0x02 flg: 0x04 tail: 0x0a452102</span><br><span class=\"line\">frmt: 0x02 chkval: 0xd119 type: 0x21=SECOND LEVEL BITMAP BLOCK</span><br><span class=\"line\">Hex dump of block: st=0, typ_found=1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Dump of Second Level Bitmap Block</span><br><span class=\"line\">   number: 2       nfree: 2       ffree: 0      pdba:     0x01400083</span><br><span class=\"line\">   Inc #: 0 Objd: 87596</span><br><span class=\"line\">  opcode:0</span><br><span class=\"line\"> xid:</span><br><span class=\"line\">  L1 Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x01400080  Free: 5 Inst: 1</span><br><span class=\"line\">   0x01400081  Free: 5 Inst: 1</span><br><span class=\"line\"></span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 130 maxblk 130</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>可以发现这是一个二级位图块，并从其中找到了2个L1块的地址，我们来看第一个L1</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Block dump from disk:</span><br><span class=\"line\">buffer tsn: 8 rdba: 0x01400080 (5/128)</span><br><span class=\"line\">scn: 0x0000.00140d51 seq: 0x03 flg: 0x04 tail: 0x0d512003</span><br><span class=\"line\">frmt: 0x02 chkval: 0xe697 type: 0x20=FIRST LEVEL BITMAP BLOCK</span><br><span class=\"line\">Hex dump of block: st=0, typ_found=1</span><br><span class=\"line\"></span><br><span class=\"line\">DBA Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x01400080  Length: 64     Offset: 0      </span><br><span class=\"line\"></span><br><span class=\"line\">   0:Metadata   1:Metadata   2:Metadata   3:Metadata</span><br><span class=\"line\">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class=\"line\">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class=\"line\">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class=\"line\">   16:75-100% free   17:75-100% free   18:75-100% free   19:75-100% free</span><br><span class=\"line\">   20:75-100% free   21:75-100% free   22:75-100% free   23:75-100% free</span><br><span class=\"line\">   24:75-100% free   25:75-100% free   26:75-100% free   27:75-100% free</span><br><span class=\"line\">   28:75-100% free   29:75-100% free   30:75-100% free   31:0-25% free</span><br><span class=\"line\">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class=\"line\">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class=\"line\">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class=\"line\">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class=\"line\">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class=\"line\">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class=\"line\">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class=\"line\">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 128 maxblk 128</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>无疑这是一个L1块，里面挂了64个数据块，因为我之前插入了一行数据，oracle已经格式化了一部分，并向其中一个块插入了数据，但是没达到我们的效果，被插入的块还显示0-25%的空闲，我们要的是full的状态，说明我们构造的数据不够大，没关系，我们修改一下pctfree就可以了，另外我们可以发现这个区是1M，有2个L1，每个L1里有64个数据块，接下来修改pctfree</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; alter table lp pctfree 24;</span><br><span class=\"line\"></span><br><span class=\"line\">Table altered.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; select TABLE_NAME,PCT_FREE from dba_tables where table_name='LP';</span><br><span class=\"line\"></span><br><span class=\"line\">TABLE_NAME                       PCT_FREE</span><br><span class=\"line\"><span class=\"comment\">------------------------------ ----------</span></span><br><span class=\"line\">LP                                     24</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; insert into lp values(2,'a','a','a','a');</span><br><span class=\"line\"></span><br><span class=\"line\">1 row created.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; commit;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">Commit</span> complete.</span><br><span class=\"line\"><span class=\"comment\">--手动触发检查点将内存中的块刷新到磁盘，本文每次dump之前都会做这个操作，以保证磁盘和内存的内容一致</span></span><br><span class=\"line\"><span class=\"keyword\">SQL</span>&gt; <span class=\"keyword\">alter</span> <span class=\"keyword\">system</span> checkpoint;</span><br><span class=\"line\"></span><br><span class=\"line\">System altered.</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>我们再看128号块</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">DBA Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x01400080  Length: 64     Offset: 0      </span><br><span class=\"line\"></span><br><span class=\"line\">   0:Metadata   1:Metadata   2:Metadata   3:Metadata</span><br><span class=\"line\">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class=\"line\">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class=\"line\">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class=\"line\">   16:75-100% free   17:75-100% free   18:75-100% free   19:75-100% free</span><br><span class=\"line\">   20:75-100% free   21:75-100% free   22:75-100% free   23:75-100% free</span><br><span class=\"line\">   24:75-100% free   25:75-100% free   26:75-100% free   27:75-100% free</span><br><span class=\"line\">   28:75-100% free   29:75-100% free   30:75-100% free   31:0-25% free</span><br><span class=\"line\">   32:75-100% free   33:75-100% free   34:75-100% free   &lt;font color=&apos;red&apos;&gt;35:FULL&lt;/font&gt;</span><br><span class=\"line\">   36:75-100% free   37:75-100% free   38:75-100% free   39:75-100% free</span><br><span class=\"line\">   40:75-100% free   41:75-100% free   42:75-100% free   43:75-100% free</span><br><span class=\"line\">   44:75-100% free   45:75-100% free   46:75-100% free   47:75-100% free</span><br><span class=\"line\">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class=\"line\">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class=\"line\">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class=\"line\">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 128 maxblk 128</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>已经是我们想的结果了，到这里我们再来看一下另外一个L1吧，dump129号块</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">DBA Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x014000c0  Length: 64     Offset: 0      </span><br><span class=\"line\"></span><br><span class=\"line\">   0:unformatted   1:unformatted   2:unformatted   3:unformatted</span><br><span class=\"line\">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class=\"line\">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class=\"line\">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class=\"line\">   16:unformatted   17:unformatted   18:unformatted   19:unformatted</span><br><span class=\"line\">   20:unformatted   21:unformatted   22:unformatted   23:unformatted</span><br><span class=\"line\">   24:unformatted   25:unformatted   26:unformatted   27:unformatted</span><br><span class=\"line\">   28:unformatted   29:unformatted   30:unformatted   31:unformatted</span><br><span class=\"line\">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class=\"line\">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class=\"line\">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class=\"line\">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class=\"line\">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class=\"line\">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class=\"line\">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class=\"line\">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 129 maxblk 129</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>全是未格式化的块，试一试并发插入，这里不模拟真正的并发了，只是开不同的session来进行插入</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; insert into lp values(3,'a','a','a','a');</span><br><span class=\"line\"></span><br><span class=\"line\">1 row created.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; insert into lp values(4,'a','a','a','a');</span><br><span class=\"line\"></span><br><span class=\"line\">1 row created.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; insert into lp values(5,'a','a','a','a');</span><br><span class=\"line\"></span><br><span class=\"line\">1 row created.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; insert into lp values(6,'a','a','a','a');</span><br><span class=\"line\"></span><br><span class=\"line\">1 row created.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; insert into lp values(7,'a','a','a','a');</span><br><span class=\"line\"></span><br><span class=\"line\">1 row created.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">--单独session5条</span></span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp;</span><br><span class=\"line\"></span><br><span class=\"line\">DBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)</span><br><span class=\"line\"><span class=\"comment\">------------------------------------ ------------------------------------</span></span><br><span class=\"line\">                                   5                                  158</span><br><span class=\"line\">                                   5                                  159</span><br><span class=\"line\">                                   5                                  163</span><br><span class=\"line\">                                   5                                  167</span><br><span class=\"line\">                                   5                                  171</span><br><span class=\"line\">                                   5                                  172</span><br><span class=\"line\">                                   5                                  174</span><br><span class=\"line\">                                   5                                  175</span><br><span class=\"line\">                                   5                                  179</span><br><span class=\"line\">                                   5                                  183</span><br><span class=\"line\">                                   5                                  187</span><br><span class=\"line\">                                   5                                  191</span><br><span class=\"line\"></span><br><span class=\"line\">12 rows selected.</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>一个单独的session里插入了5条，另外5个单独的session里各插一条，发现规律了么，插入的块只在132和192之间，我们分别看看两个L1</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; alter system checkpoint;</span><br><span class=\"line\"></span><br><span class=\"line\">System altered.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  DBA Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x01400080  Length: 64     Offset: 0      </span><br><span class=\"line\"></span><br><span class=\"line\">   0:Metadata   1:Metadata   2:Metadata   3:Metadata</span><br><span class=\"line\">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class=\"line\">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class=\"line\">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class=\"line\">   16:75-100% free   17:75-100% free   18:75-100% free   19:75-100% free</span><br><span class=\"line\">   20:75-100% free   21:75-100% free   22:75-100% free   23:75-100% free</span><br><span class=\"line\">   24:75-100% free   25:75-100% free   26:75-100% free   27:75-100% free</span><br><span class=\"line\">   28:75-100% free   29:75-100% free   30:FULL   31:0-25% free</span><br><span class=\"line\">   32:75-100% free   33:75-100% free   34:75-100% free   35:FULL</span><br><span class=\"line\">   36:75-100% free   37:75-100% free   38:75-100% free   39:FULL</span><br><span class=\"line\">   40:75-100% free   41:75-100% free   42:75-100% free   43:FULL</span><br><span class=\"line\">   44:FULL   45:75-100% free   46:FULL   47:FULL</span><br><span class=\"line\">   48:75-100% free   49:75-100% free   50:75-100% free   51:FULL</span><br><span class=\"line\">   52:75-100% free   53:75-100% free   54:75-100% free   55:FULL</span><br><span class=\"line\">   56:75-100% free   57:75-100% free   58:75-100% free   59:FULL</span><br><span class=\"line\">   60:75-100% free   61:75-100% free   62:75-100% free   63:FULL</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 128 maxblk 128</span><br><span class=\"line\"></span><br><span class=\"line\">********************************************************************</span><br><span class=\"line\">看一下第二个L1</span><br><span class=\"line\"></span><br><span class=\"line\">DBA Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x014000c0  Length: 64     Offset: 0      </span><br><span class=\"line\"></span><br><span class=\"line\">   0:unformatted   1:unformatted   2:unformatted   3:unformatted</span><br><span class=\"line\">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class=\"line\">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class=\"line\">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class=\"line\">   16:unformatted   17:unformatted   18:unformatted   19:unformatted</span><br><span class=\"line\">   20:unformatted   21:unformatted   22:unformatted   23:unformatted</span><br><span class=\"line\">   24:unformatted   25:unformatted   26:unformatted   27:unformatted</span><br><span class=\"line\">   28:unformatted   29:unformatted   30:unformatted   31:unformatted</span><br><span class=\"line\">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class=\"line\">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class=\"line\">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class=\"line\">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class=\"line\">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class=\"line\">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class=\"line\">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class=\"line\">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 129 maxblk 129</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这说明只在第一个L1里面随机，那为什么L2下挂了2个L1，我插入了10条却没有一条随机到第二个L1块呢？答案是高水位，这是vage大师已经论证过的了，偶在这里仅为见证一下~~，好了，还记得L3里的高水位信息么？</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Extent Control Header</span><br><span class=\"line\">  -----------------------------------------------------------------</span><br><span class=\"line\">  Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928</span><br><span class=\"line\">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class=\"line\">      Highwater::  0x014000c0  ext#: 0      blk#: 64     ext size: 128   </span><br><span class=\"line\">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class=\"line\">  #blocks below: 60    </span><br><span class=\"line\">  mapblk  0x00000000  offset: 0</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>Highwater::  0x014000c0是哪个块呢？</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">  SQL&gt; select dbms_utility.data_block_address_file(to_number('014000c0', 'xxxxxxxx')) file#,</span><br><span class=\"line\">  2 dbms_utility.data_block_address_block(to_number('014000c0', 'xxxxxxxx')) block<span class=\"comment\">#</span></span><br><span class=\"line\">  3 from dual;</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\"># BLOCK#</span></span><br><span class=\"line\"><span class=\"comment\">---------- ----------</span></span><br><span class=\"line\">         5 192</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这是第二个L1管理的第一个块，可见数据的插入只在高水位之下进行（直接路径插入除外），此时的状态如下：</p>\n</blockquote>\n<p><img alt data-src=\"http://oaowhilvu.bkt.clouddn.com/0%E4%B8%AAextent.png\"></p>\n<blockquote>\n<p>那么L1里面只会有64个块么？高水位永远都会指向L1的最后一个块么？我们继续剖析！<br>首先给LP表多分配一些区</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; alter table lp allocate extent(size 100m);</span><br><span class=\"line\"></span><br><span class=\"line\">Table altered.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID, BLOCKS from dba_extents where segment_name='LP';</span><br><span class=\"line\"></span><br><span class=\"line\">SEGMENT_NAME                    EXTENT_ID    FILE_ID   BLOCK_ID     BLOCKS</span><br><span class=\"line\"><span class=\"comment\">------------------------------ ---------- ---------- ---------- ----------</span></span><br><span class=\"line\">LP                                      0          5        128        128</span><br><span class=\"line\">LP                                      1          5        256        128</span><br><span class=\"line\">LP                                      2          5        384        128</span><br><span class=\"line\">LP                                      3          5        512        128</span><br><span class=\"line\">LP                                      4          5        640        128</span><br><span class=\"line\">LP                                      5          5        768        128</span><br><span class=\"line\">LP                                      6          5        896        128</span><br><span class=\"line\">LP                                      7          5       1024        128</span><br><span class=\"line\">LP                                      8          5       1152        128</span><br><span class=\"line\">LP                                      9          5       1280        128</span><br><span class=\"line\">LP                                     10          5       1408        128</span><br><span class=\"line\">LP                                     11          5       1536        128</span><br><span class=\"line\">LP                                     12          5       1664        128</span><br><span class=\"line\">LP                                     13          5       1792        128</span><br><span class=\"line\">LP                                     14          5       1920        128</span><br><span class=\"line\">LP                                     15          5       2048        128</span><br><span class=\"line\">LP                                     16          5       2176        128</span><br><span class=\"line\">LP                                     17          5       2304        128</span><br><span class=\"line\">LP                                     18          5       2432        128</span><br><span class=\"line\">LP                                     19          5       2560        128</span><br><span class=\"line\">LP                                     20          5       2688        128</span><br><span class=\"line\">LP                                     21          5       2816        128</span><br><span class=\"line\">LP                                     22          5       2944        128</span><br><span class=\"line\">LP                                     23          5       3072        128</span><br><span class=\"line\">LP                                     24          5       3200        128</span><br><span class=\"line\">LP                                     25          5       3328        128</span><br><span class=\"line\">LP                                     26          5       3456        128</span><br><span class=\"line\">LP                                     27          5       3584        128</span><br><span class=\"line\">LP                                     28          5       3712        128</span><br><span class=\"line\">LP                                     29          5       3840        128</span><br><span class=\"line\">LP                                     30          5       3968        128</span><br><span class=\"line\">LP                                     31          5       4096        128</span><br><span class=\"line\">LP                                     32          5       4224        128</span><br><span class=\"line\">LP                                     33          5       4352        128</span><br><span class=\"line\">LP                                     34          5       4480        128</span><br><span class=\"line\">LP                                     35          5       4608        128</span><br><span class=\"line\">LP                                     36          5       4736        128</span><br><span class=\"line\">LP                                     37          5       4864        128</span><br><span class=\"line\">LP                                     38          5       4992        128</span><br><span class=\"line\">LP                                     39          5       5120        128</span><br><span class=\"line\">LP                                     40          5       5248        128</span><br><span class=\"line\">LP                                     41          5       5376        128</span><br><span class=\"line\">LP                                     42          5       5504        128</span><br><span class=\"line\">LP                                     43          5       5632        128</span><br><span class=\"line\">LP                                     44          5       5760        128</span><br><span class=\"line\">LP                                     45          5       5888        128</span><br><span class=\"line\">LP                                     46          5       6016        128</span><br><span class=\"line\">LP                                     47          5       6144        128</span><br><span class=\"line\">LP                                     48          5       6272        128</span><br><span class=\"line\">LP                                     49          5       6400        128</span><br><span class=\"line\">LP                                     50          5       6528        128</span><br><span class=\"line\">LP                                     51          5       6656        128</span><br><span class=\"line\">LP                                     52          5       6784        128</span><br><span class=\"line\">LP                                     53          5       6912        128</span><br><span class=\"line\">LP                                     54          5       7040        128</span><br><span class=\"line\">LP                                     55          5       7168        128</span><br><span class=\"line\">LP                                     56          5       7296        128</span><br><span class=\"line\">LP                                     57          5       7424        128</span><br><span class=\"line\">LP                                     58          5       7552        128</span><br><span class=\"line\">LP                                     59          5       7680        128</span><br><span class=\"line\">LP                                     60          5       7808        128</span><br><span class=\"line\">LP                                     61          5       7936        128</span><br><span class=\"line\">LP                                     62          5       8064        128</span><br><span class=\"line\">LP                                     63          5       8192        128</span><br><span class=\"line\">LP                                     64          5       8320        128</span><br><span class=\"line\">LP                                     65          5       8448        128</span><br><span class=\"line\">LP                                     66          5       8576        128</span><br><span class=\"line\">LP                                     67          5       8704        128</span><br><span class=\"line\">LP                                     68          5       8832        128</span><br><span class=\"line\">LP                                     69          5       8960        128</span><br><span class=\"line\">LP                                     70          5       9088        128</span><br><span class=\"line\">LP                                     71          5       9216        128</span><br><span class=\"line\">LP                                     72          5       9344        128</span><br><span class=\"line\">LP                                     73          5       9472        128</span><br><span class=\"line\">LP                                     74          5       9600        128</span><br><span class=\"line\">LP                                     75          5       9728        128</span><br><span class=\"line\">LP                                     76          5       9856        128</span><br><span class=\"line\">LP                                     77          5       9984        128</span><br><span class=\"line\">LP                                     78          5      10112        128</span><br><span class=\"line\">LP                                     79          5      10240        128</span><br><span class=\"line\">LP                                     80          5      10368        128</span><br><span class=\"line\">LP                                     81          5      10496        128</span><br><span class=\"line\">LP                                     82          5      10624        128</span><br><span class=\"line\">LP                                     83          5      10752        128</span><br><span class=\"line\">LP                                     84          5      10880        128</span><br><span class=\"line\">LP                                     85          5      11008        128</span><br><span class=\"line\">LP                                     86          5      11136        128</span><br><span class=\"line\">LP                                     87          5      11264        128</span><br><span class=\"line\">LP                                     88          5      11392        128</span><br><span class=\"line\">LP                                     89          5      11520        128</span><br><span class=\"line\">LP                                     90          5      11648        128</span><br><span class=\"line\">LP                                     91          5      11776        128</span><br><span class=\"line\">LP                                     92          5      11904        128</span><br><span class=\"line\">LP                                     93          5      12032        128</span><br><span class=\"line\">LP                                     94          5      12160        128</span><br><span class=\"line\">LP                                     95          5      12288        128</span><br><span class=\"line\">LP                                     96          5      12416        128</span><br><span class=\"line\">LP                                     97          5      12544        128</span><br><span class=\"line\">LP                                     98          5      12672        128</span><br><span class=\"line\">LP                                     99          5      12800        128</span><br><span class=\"line\">LP                                    100          5      12928        128</span><br><span class=\"line\"></span><br><span class=\"line\">101 rows selected.</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>我分配了100个区，加上原来的一共101个，现在我们看看L3段头里面的内容</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Extent Control Header</span><br><span class=\"line\">  -----------------------------------------------------------------</span><br><span class=\"line\">  Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928</span><br><span class=\"line\">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class=\"line\">      Highwater::  0x014000c0  ext#: 0      blk#: 64     ext size: 128   </span><br><span class=\"line\">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class=\"line\">  #blocks below: 60    </span><br><span class=\"line\">  mapblk  0x00000000  offset: 0     </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Extent Map</span><br><span class=\"line\">  -----------------------------------------------------------------</span><br><span class=\"line\">   0x01400080  length: 128   </span><br><span class=\"line\">   0x01400100  length: 128   </span><br><span class=\"line\">   0x01400180  length: 128   </span><br><span class=\"line\">   0x01400200  length: 128   </span><br><span class=\"line\">   0x01400280  length: 128   </span><br><span class=\"line\">   0x01400300  length: 128   </span><br><span class=\"line\">   0x01400380  length: 128   </span><br><span class=\"line\">   0x01400400  length: 128   </span><br><span class=\"line\">   0x01400480  length: 128   </span><br><span class=\"line\">   0x01400500  length: 128   </span><br><span class=\"line\">   0x01400580  length: 128   </span><br><span class=\"line\">   0x01400600  length: 128   </span><br><span class=\"line\">   0x01400680  length: 128   </span><br><span class=\"line\">   0x01400700  length: 128   </span><br><span class=\"line\">   0x01400780  length: 128   </span><br><span class=\"line\">   0x01400800  length: 128   </span><br><span class=\"line\">   0x01400880  length: 128   </span><br><span class=\"line\">   0x01400900  length: 128   </span><br><span class=\"line\">   0x01400980  length: 128   </span><br><span class=\"line\">   0x01400a00  length: 128   </span><br><span class=\"line\">   0x01400a80  length: 128   </span><br><span class=\"line\">   0x01400b00  length: 128   </span><br><span class=\"line\">   0x01400b80  length: 128   </span><br><span class=\"line\">   0x01400c00  length: 128   </span><br><span class=\"line\">   0x01400c80  length: 128   </span><br><span class=\"line\">   0x01400d00  length: 128   </span><br><span class=\"line\">   0x01400d80  length: 128   </span><br><span class=\"line\">   0x01400e00  length: 128   </span><br><span class=\"line\">   0x01400e80  length: 128   </span><br><span class=\"line\">   0x01400f00  length: 128   </span><br><span class=\"line\">   0x01400f80  length: 128   </span><br><span class=\"line\">   0x01401000  length: 128   </span><br><span class=\"line\">   0x01401080  length: 128   </span><br><span class=\"line\">   0x01401100  length: 128   </span><br><span class=\"line\">   0x01401180  length: 128   </span><br><span class=\"line\">   0x01401200  length: 128   </span><br><span class=\"line\">   0x01401280  length: 128   </span><br><span class=\"line\">   0x01401300  length: 128   </span><br><span class=\"line\">   0x01401380  length: 128   </span><br><span class=\"line\">   0x01401400  length: 128   </span><br><span class=\"line\">   0x01401480  length: 128   </span><br><span class=\"line\">   0x01401500  length: 128   </span><br><span class=\"line\">   0x01401580  length: 128   </span><br><span class=\"line\">   0x01401600  length: 128   </span><br><span class=\"line\">   0x01401680  length: 128   </span><br><span class=\"line\">   0x01401700  length: 128   </span><br><span class=\"line\">   0x01401780  length: 128   </span><br><span class=\"line\">   0x01401800  length: 128   </span><br><span class=\"line\">   0x01401880  length: 128   </span><br><span class=\"line\">   0x01401900  length: 128   </span><br><span class=\"line\">   0x01401980  length: 128   </span><br><span class=\"line\">   0x01401a00  length: 128   </span><br><span class=\"line\">   0x01401a80  length: 128   </span><br><span class=\"line\">   0x01401b00  length: 128   </span><br><span class=\"line\">   0x01401b80  length: 128   </span><br><span class=\"line\">   0x01401c00  length: 128   </span><br><span class=\"line\">   0x01401c80  length: 128   </span><br><span class=\"line\">   0x01401d00  length: 128   </span><br><span class=\"line\">   0x01401d80  length: 128   </span><br><span class=\"line\">   0x01401e00  length: 128   </span><br><span class=\"line\">   0x01401e80  length: 128   </span><br><span class=\"line\">   0x01401f00  length: 128   </span><br><span class=\"line\">   0x01401f80  length: 128   </span><br><span class=\"line\">   0x01402000  length: 128   </span><br><span class=\"line\">   0x01402080  length: 128   </span><br><span class=\"line\">   0x01402100  length: 128   </span><br><span class=\"line\">   0x01402180  length: 128   </span><br><span class=\"line\">   0x01402200  length: 128   </span><br><span class=\"line\">   0x01402280  length: 128   </span><br><span class=\"line\">   0x01402300  length: 128   </span><br><span class=\"line\">   0x01402380  length: 128   </span><br><span class=\"line\">   0x01402400  length: 128   </span><br><span class=\"line\">   0x01402480  length: 128   </span><br><span class=\"line\">   0x01402500  length: 128   </span><br><span class=\"line\">   0x01402580  length: 128   </span><br><span class=\"line\">   0x01402600  length: 128   </span><br><span class=\"line\">   0x01402680  length: 128   </span><br><span class=\"line\">   0x01402700  length: 128   </span><br><span class=\"line\">   0x01402780  length: 128   </span><br><span class=\"line\">   0x01402800  length: 128   </span><br><span class=\"line\">   0x01402880  length: 128   </span><br><span class=\"line\">   0x01402900  length: 128   </span><br><span class=\"line\">   0x01402980  length: 128   </span><br><span class=\"line\">   0x01402a00  length: 128   </span><br><span class=\"line\">   0x01402a80  length: 128   </span><br><span class=\"line\">   0x01402b00  length: 128   </span><br><span class=\"line\">   0x01402b80  length: 128   </span><br><span class=\"line\">   0x01402c00  length: 128   </span><br><span class=\"line\">   0x01402c80  length: 128   </span><br><span class=\"line\">   0x01402d00  length: 128   </span><br><span class=\"line\">   0x01402d80  length: 128   </span><br><span class=\"line\">   0x01402e00  length: 128   </span><br><span class=\"line\">   0x01402e80  length: 128   </span><br><span class=\"line\">   0x01402f00  length: 128   </span><br><span class=\"line\">   0x01402f80  length: 128   </span><br><span class=\"line\">   0x01403000  length: 128   </span><br><span class=\"line\">   0x01403080  length: 128   </span><br><span class=\"line\">   0x01403100  length: 128   </span><br><span class=\"line\">   0x01403180  length: 128   </span><br><span class=\"line\">   0x01403200  length: 128   </span><br><span class=\"line\">   0x01403280  length: 128   </span><br><span class=\"line\"></span><br><span class=\"line\">  Auxillary Map</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   Extent 0     :  L1 dba:  0x01400080 Data dba:  0x01400084</span><br><span class=\"line\">   Extent 1     :  L1 dba:  0x01400100 Data dba:  0x01400102</span><br><span class=\"line\">   Extent 2     :  L1 dba:  0x01400180 Data dba:  0x01400182</span><br><span class=\"line\">   Extent 3     :  L1 dba:  0x01400200 Data dba:  0x01400202</span><br><span class=\"line\">   Extent 4     :  L1 dba:  0x01400280 Data dba:  0x01400282</span><br><span class=\"line\">   Extent 5     :  L1 dba:  0x01400300 Data dba:  0x01400302</span><br><span class=\"line\">   Extent 6     :  L1 dba:  0x01400380 Data dba:  0x01400382</span><br><span class=\"line\">   Extent 7     :  L1 dba:  0x01400400 Data dba:  0x01400402</span><br><span class=\"line\">   Extent 8     :  L1 dba:  0x01400480 Data dba:  0x01400482</span><br><span class=\"line\">   Extent 9     :  L1 dba:  0x01400500 Data dba:  0x01400502</span><br><span class=\"line\">   Extent 10    :  L1 dba:  0x01400580 Data dba:  0x01400582</span><br><span class=\"line\">   Extent 11    :  L1 dba:  0x01400600 Data dba:  0x01400602</span><br><span class=\"line\">   Extent 12    :  L1 dba:  0x01400680 Data dba:  0x01400682</span><br><span class=\"line\">   Extent 13    :  L1 dba:  0x01400700 Data dba:  0x01400702</span><br><span class=\"line\">   Extent 14    :  L1 dba:  0x01400780 Data dba:  0x01400782</span><br><span class=\"line\">   Extent 15    :  L1 dba:  0x01400800 Data dba:  0x01400802</span><br><span class=\"line\">   Extent 16    :  L1 dba:  0x01400880 Data dba:  0x01400882</span><br><span class=\"line\">   Extent 17    :  L1 dba:  0x01400900 Data dba:  0x01400902</span><br><span class=\"line\">   Extent 18    :  L1 dba:  0x01400980 Data dba:  0x01400982</span><br><span class=\"line\">   Extent 19    :  L1 dba:  0x01400a00 Data dba:  0x01400a02</span><br><span class=\"line\">   Extent 20    :  L1 dba:  0x01400a80 Data dba:  0x01400a82</span><br><span class=\"line\">   Extent 21    :  L1 dba:  0x01400b00 Data dba:  0x01400b02</span><br><span class=\"line\">   Extent 22    :  L1 dba:  0x01400b80 Data dba:  0x01400b82</span><br><span class=\"line\">   Extent 23    :  L1 dba:  0x01400c00 Data dba:  0x01400c02</span><br><span class=\"line\">   Extent 24    :  L1 dba:  0x01400c80 Data dba:  0x01400c82</span><br><span class=\"line\">   Extent 25    :  L1 dba:  0x01400d00 Data dba:  0x01400d02</span><br><span class=\"line\">   Extent 26    :  L1 dba:  0x01400d80 Data dba:  0x01400d82</span><br><span class=\"line\">   Extent 27    :  L1 dba:  0x01400e00 Data dba:  0x01400e02</span><br><span class=\"line\">   Extent 28    :  L1 dba:  0x01400e80 Data dba:  0x01400e82</span><br><span class=\"line\">   Extent 29    :  L1 dba:  0x01400f00 Data dba:  0x01400f02</span><br><span class=\"line\">   Extent 30    :  L1 dba:  0x01400f80 Data dba:  0x01400f82</span><br><span class=\"line\">   Extent 31    :  L1 dba:  0x01401000 Data dba:  0x01401002</span><br><span class=\"line\">   Extent 32    :  L1 dba:  0x01401080 Data dba:  0x01401082</span><br><span class=\"line\">   Extent 33    :  L1 dba:  0x01401100 Data dba:  0x01401102</span><br><span class=\"line\">   Extent 34    :  L1 dba:  0x01401180 Data dba:  0x01401182</span><br><span class=\"line\">   Extent 35    :  L1 dba:  0x01401200 Data dba:  0x01401202</span><br><span class=\"line\">   Extent 36    :  L1 dba:  0x01401280 Data dba:  0x01401282</span><br><span class=\"line\">   Extent 37    :  L1 dba:  0x01401300 Data dba:  0x01401302</span><br><span class=\"line\">   Extent 38    :  L1 dba:  0x01401380 Data dba:  0x01401382</span><br><span class=\"line\">   Extent 39    :  L1 dba:  0x01401400 Data dba:  0x01401402</span><br><span class=\"line\">   Extent 40    :  L1 dba:  0x01401480 Data dba:  0x01401482</span><br><span class=\"line\">   Extent 41    :  L1 dba:  0x01401500 Data dba:  0x01401502</span><br><span class=\"line\">   Extent 42    :  L1 dba:  0x01401580 Data dba:  0x01401582</span><br><span class=\"line\">   Extent 43    :  L1 dba:  0x01401600 Data dba:  0x01401602</span><br><span class=\"line\">   Extent 44    :  L1 dba:  0x01401680 Data dba:  0x01401682</span><br><span class=\"line\">   Extent 45    :  L1 dba:  0x01401700 Data dba:  0x01401702</span><br><span class=\"line\">   Extent 46    :  L1 dba:  0x01401780 Data dba:  0x01401782</span><br><span class=\"line\">   Extent 47    :  L1 dba:  0x01401800 Data dba:  0x01401802</span><br><span class=\"line\">   Extent 48    :  L1 dba:  0x01401880 Data dba:  0x01401882</span><br><span class=\"line\">   Extent 49    :  L1 dba:  0x01401900 Data dba:  0x01401902</span><br><span class=\"line\">   Extent 50    :  L1 dba:  0x01401980 Data dba:  0x01401982</span><br><span class=\"line\">   Extent 51    :  L1 dba:  0x01401a00 Data dba:  0x01401a02</span><br><span class=\"line\">   Extent 52    :  L1 dba:  0x01401a80 Data dba:  0x01401a82</span><br><span class=\"line\">   Extent 53    :  L1 dba:  0x01401b00 Data dba:  0x01401b02</span><br><span class=\"line\">   Extent 54    :  L1 dba:  0x01401b80 Data dba:  0x01401b82</span><br><span class=\"line\">   Extent 55    :  L1 dba:  0x01401c00 Data dba:  0x01401c02</span><br><span class=\"line\">   Extent 56    :  L1 dba:  0x01401c80 Data dba:  0x01401c82</span><br><span class=\"line\">   Extent 57    :  L1 dba:  0x01401d00 Data dba:  0x01401d02</span><br><span class=\"line\">   Extent 58    :  L1 dba:  0x01401d80 Data dba:  0x01401d82</span><br><span class=\"line\">   Extent 59    :  L1 dba:  0x01401e00 Data dba:  0x01401e02</span><br><span class=\"line\">   Extent 60    :  L1 dba:  0x01401e80 Data dba:  0x01401e82</span><br><span class=\"line\">   Extent 61    :  L1 dba:  0x01401f00 Data dba:  0x01401f02</span><br><span class=\"line\">   Extent 62    :  L1 dba:  0x01401f80 Data dba:  0x01401f82</span><br><span class=\"line\">   Extent 63    :  L1 dba:  0x01402000 Data dba:  0x01402001</span><br><span class=\"line\">   Extent 64    :  L1 dba:  0x01402000 Data dba:  0x01402080</span><br><span class=\"line\">   Extent 65    :  L1 dba:  0x01402100 Data dba:  0x01402101</span><br><span class=\"line\">   Extent 66    :  L1 dba:  0x01402100 Data dba:  0x01402180</span><br><span class=\"line\">   Extent 67    :  L1 dba:  0x01402200 Data dba:  0x01402201</span><br><span class=\"line\">   Extent 68    :  L1 dba:  0x01402200 Data dba:  0x01402280</span><br><span class=\"line\">   Extent 69    :  L1 dba:  0x01402300 Data dba:  0x01402301</span><br><span class=\"line\">   Extent 70    :  L1 dba:  0x01402300 Data dba:  0x01402380</span><br><span class=\"line\">   Extent 71    :  L1 dba:  0x01402400 Data dba:  0x01402401</span><br><span class=\"line\">   Extent 72    :  L1 dba:  0x01402400 Data dba:  0x01402480</span><br><span class=\"line\">   Extent 73    :  L1 dba:  0x01402500 Data dba:  0x01402501</span><br><span class=\"line\">   Extent 74    :  L1 dba:  0x01402500 Data dba:  0x01402580</span><br><span class=\"line\">   Extent 75    :  L1 dba:  0x01402600 Data dba:  0x01402601</span><br><span class=\"line\">   Extent 76    :  L1 dba:  0x01402600 Data dba:  0x01402680</span><br><span class=\"line\">   Extent 77    :  L1 dba:  0x01402700 Data dba:  0x01402701</span><br><span class=\"line\">   Extent 78    :  L1 dba:  0x01402700 Data dba:  0x01402780</span><br><span class=\"line\">   Extent 79    :  L1 dba:  0x01402800 Data dba:  0x01402801</span><br><span class=\"line\">   Extent 80    :  L1 dba:  0x01402800 Data dba:  0x01402880</span><br><span class=\"line\">   Extent 81    :  L1 dba:  0x01402900 Data dba:  0x01402901</span><br><span class=\"line\">   Extent 82    :  L1 dba:  0x01402900 Data dba:  0x01402980</span><br><span class=\"line\">   Extent 83    :  L1 dba:  0x01402a00 Data dba:  0x01402a01</span><br><span class=\"line\">   Extent 84    :  L1 dba:  0x01402a00 Data dba:  0x01402a80</span><br><span class=\"line\">   Extent 85    :  L1 dba:  0x01402b00 Data dba:  0x01402b01</span><br><span class=\"line\">   Extent 86    :  L1 dba:  0x01402b00 Data dba:  0x01402b80</span><br><span class=\"line\">   Extent 87    :  L1 dba:  0x01402c00 Data dba:  0x01402c01</span><br><span class=\"line\">   Extent 88    :  L1 dba:  0x01402c00 Data dba:  0x01402c80</span><br><span class=\"line\">   Extent 89    :  L1 dba:  0x01402d00 Data dba:  0x01402d01</span><br><span class=\"line\">   Extent 90    :  L1 dba:  0x01402d00 Data dba:  0x01402d80</span><br><span class=\"line\">   Extent 91    :  L1 dba:  0x01402e00 Data dba:  0x01402e01</span><br><span class=\"line\">   Extent 92    :  L1 dba:  0x01402e00 Data dba:  0x01402e80</span><br><span class=\"line\">   Extent 93    :  L1 dba:  0x01402f00 Data dba:  0x01402f01</span><br><span class=\"line\">   Extent 94    :  L1 dba:  0x01402f00 Data dba:  0x01402f80</span><br><span class=\"line\">   Extent 95    :  L1 dba:  0x01403000 Data dba:  0x01403001</span><br><span class=\"line\">   Extent 96    :  L1 dba:  0x01403000 Data dba:  0x01403080</span><br><span class=\"line\">   Extent 97    :  L1 dba:  0x01403100 Data dba:  0x01403101</span><br><span class=\"line\">   Extent 98    :  L1 dba:  0x01403100 Data dba:  0x01403180</span><br><span class=\"line\">   Extent 99    :  L1 dba:  0x01403200 Data dba:  0x01403201</span><br><span class=\"line\">   Extent 100   :  L1 dba:  0x01403200 Data dba:  0x01403280</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">   Second Level Bitmap block DBAs</span><br><span class=\"line\">   --------------------------------------------------------</span><br><span class=\"line\">   DBA 1:   0x01400082</span><br><span class=\"line\"></span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 131 maxblk 131</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这里我们主要看Auxillary Map，里面记录了每个区所属的L1，不难发现从第64个区开始，64、65两个区的L1相同，这说明什么，说明L1下面挂了整整两个区的数据块，验证一下，将0x01402000块dump出来之后的内容：</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">  01402000  十进制 》20979712</span><br><span class=\"line\">  SQL&gt; select dbms_utility.data_block_address_file(20979712) Rfile#,dbms_utility.data_block_address_block(20979712) \"Block#\" from dual;</span><br><span class=\"line\"></span><br><span class=\"line\">    RFILE<span class=\"comment\">#     Block#</span></span><br><span class=\"line\"><span class=\"comment\">---------- ----------</span></span><br><span class=\"line\">         5       8192</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">          DBA Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x01402000  Length: 128    Offset: 0      </span><br><span class=\"line\">   0x01402080  Length: 128    Offset: 128    </span><br><span class=\"line\"></span><br><span class=\"line\">   0:Metadata   1:unformatted   2:unformatted   3:unformatted</span><br><span class=\"line\">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class=\"line\">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class=\"line\">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class=\"line\">   16:unformatted   17:unformatted   18:unformatted   19:unformatted</span><br><span class=\"line\">   20:unformatted   21:unformatted   22:unformatted   23:unformatted</span><br><span class=\"line\">   24:unformatted   25:unformatted   26:unformatted   27:unformatted</span><br><span class=\"line\">   28:unformatted   29:unformatted   30:unformatted   31:unformatted</span><br><span class=\"line\">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class=\"line\">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class=\"line\">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class=\"line\">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class=\"line\">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class=\"line\">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class=\"line\">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class=\"line\">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class=\"line\">   64:unformatted   65:unformatted   66:unformatted   67:unformatted</span><br><span class=\"line\">   68:unformatted   69:unformatted   70:unformatted   71:unformatted</span><br><span class=\"line\">   72:unformatted   73:unformatted   74:unformatted   75:unformatted</span><br><span class=\"line\">   76:unformatted   77:unformatted   78:unformatted   79:unformatted</span><br><span class=\"line\">   80:unformatted   81:unformatted   82:unformatted   83:unformatted</span><br><span class=\"line\">   84:unformatted   85:unformatted   86:unformatted   87:unformatted</span><br><span class=\"line\">   88:unformatted   89:unformatted   90:unformatted   91:unformatted</span><br><span class=\"line\">   92:unformatted   93:unformatted   94:unformatted   95:unformatted</span><br><span class=\"line\">   96:unformatted   97:unformatted   98:unformatted   99:unformatted</span><br><span class=\"line\">   100:unformatted   101:unformatted   102:unformatted   103:unformatted</span><br><span class=\"line\">   104:unformatted   105:unformatted   106:unformatted   107:unformatted</span><br><span class=\"line\">   108:unformatted   109:unformatted   110:unformatted   111:unformatted</span><br><span class=\"line\">   112:unformatted   113:unformatted   114:unformatted   115:unformatted</span><br><span class=\"line\">   116:unformatted   117:unformatted   118:unformatted   119:unformatted</span><br><span class=\"line\">   120:unformatted   121:unformatted   122:unformatted   123:unformatted</span><br><span class=\"line\">   124:unformatted   125:unformatted   126:unformatted   127:unformatted</span><br><span class=\"line\">   128:unformatted   129:unformatted   130:unformatted   131:unformatted</span><br><span class=\"line\">   132:unformatted   133:unformatted   134:unformatted   135:unformatted</span><br><span class=\"line\">   136:unformatted   137:unformatted   138:unformatted   139:unformatted</span><br><span class=\"line\">   140:unformatted   141:unformatted   142:unformatted   143:unformatted</span><br><span class=\"line\">   144:unformatted   145:unformatted   146:unformatted   147:unformatted</span><br><span class=\"line\">   148:unformatted   149:unformatted   150:unformatted   151:unformatted</span><br><span class=\"line\">   152:unformatted   153:unformatted   154:unformatted   155:unformatted</span><br><span class=\"line\">   156:unformatted   157:unformatted   158:unformatted   159:unformatted</span><br><span class=\"line\">   160:unformatted   161:unformatted   162:unformatted   163:unformatted</span><br><span class=\"line\">   164:unformatted   165:unformatted   166:unformatted   167:unformatted</span><br><span class=\"line\">   168:unformatted   169:unformatted   170:unformatted   171:unformatted</span><br><span class=\"line\">   172:unformatted   173:unformatted   174:unformatted   175:unformatted</span><br><span class=\"line\">   176:unformatted   177:unformatted   178:unformatted   179:unformatted</span><br><span class=\"line\">   180:unformatted   181:unformatted   182:unformatted   183:unformatted</span><br><span class=\"line\">   184:unformatted   185:unformatted   186:unformatted   187:unformatted</span><br><span class=\"line\">   188:unformatted   189:unformatted   190:unformatted   191:unformatted</span><br><span class=\"line\">   192:unformatted   193:unformatted   194:unformatted   195:unformatted</span><br><span class=\"line\">   196:unformatted   197:unformatted   198:unformatted   199:unformatted</span><br><span class=\"line\">   200:unformatted   201:unformatted   202:unformatted   203:unformatted</span><br><span class=\"line\">   204:unformatted   205:unformatted   206:unformatted   207:unformatted</span><br><span class=\"line\">   208:unformatted   209:unformatted   210:unformatted   211:unformatted</span><br><span class=\"line\">   212:unformatted   213:unformatted   214:unformatted   215:unformatted</span><br><span class=\"line\">   216:unformatted   217:unformatted   218:unformatted   219:unformatted</span><br><span class=\"line\">   220:unformatted   221:unformatted   222:unformatted   223:unformatted</span><br><span class=\"line\">   224:unformatted   225:unformatted   226:unformatted   227:unformatted</span><br><span class=\"line\">   228:unformatted   229:unformatted   230:unformatted   231:unformatted</span><br><span class=\"line\">   232:unformatted   233:unformatted   234:unformatted   235:unformatted</span><br><span class=\"line\">   236:unformatted   237:unformatted   238:unformatted   239:unformatted</span><br><span class=\"line\">   240:unformatted   241:unformatted   242:unformatted   243:unformatted</span><br><span class=\"line\">   244:unformatted   245:unformatted   246:unformatted   247:unformatted</span><br><span class=\"line\">   248:unformatted   249:unformatted   250:unformatted   251:unformatted</span><br><span class=\"line\">   252:unformatted   253:unformatted   254:unformatted   255:unformatted</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 8192 maxblk 8192</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>256个块，2M 2个区，可见L1中块的数量会随着段大小的改变而做调整的，可以增大到1024个甚至更多，我在这里不去再做验证，将重点放在高水位上，根据我们之前观察到的现象，高水位在第二个L1的地一个块，也可说第一个L1的末端，那么现在的L1里有256个块，高水位是不是也会推进到这个L1的末端呢？很容易进行验证，将数据插满到这个L1的前几个块再去观察段头高水位的变化就行了，那么插多少条呢？再来计算一下，当前的L1是8192号块，前面一共63个区，每个区里面两个L1，加上第一个区里面的一个L2和L3，我们需要插满8192-63*2-2=8064</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">declare</span></span><br><span class=\"line\">i <span class=\"built_in\">number</span>;</span><br><span class=\"line\"><span class=\"keyword\">begin</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"number\">1.</span><span class=\"number\">.8064</span> <span class=\"keyword\">loop</span></span><br><span class=\"line\"><span class=\"keyword\">insert</span> <span class=\"keyword\">into</span> lp <span class=\"keyword\">values</span>(i,<span class=\"string\">'a'</span>,<span class=\"string\">'a'</span>,<span class=\"string\">'a'</span>,<span class=\"string\">'a'</span>);</span><br><span class=\"line\"><span class=\"keyword\">end</span> <span class=\"keyword\">loop</span>;</span><br><span class=\"line\"><span class=\"keyword\">end</span>;</span><br><span class=\"line\">/</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>观察62号区的第二个L1，第一个L1的地址是0x01401f80，那么第二个就是01401f81，5号文件8065号块，dump出来的结果</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">DBA Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x01401fc0  Length: 64     Offset: 0      </span><br><span class=\"line\"></span><br><span class=\"line\">   0:FULL   1:FULL   2:FULL   3:FULL</span><br><span class=\"line\">   4:FULL   5:FULL   6:FULL   7:FULL</span><br><span class=\"line\">   8:FULL   9:FULL   10:FULL   11:FULL</span><br><span class=\"line\">   12:FULL   13:FULL   14:FULL   15:FULL</span><br><span class=\"line\">   16:FULL   17:FULL   18:FULL   19:FULL</span><br><span class=\"line\">   20:FULL   21:FULL   22:FULL   23:FULL</span><br><span class=\"line\">   24:FULL   25:FULL   26:FULL   27:FULL</span><br><span class=\"line\">   28:FULL   29:FULL   30:FULL   31:FULL</span><br><span class=\"line\">   32:FULL   33:FULL   34:FULL   35:FULL</span><br><span class=\"line\">   36:FULL   37:FULL   38:FULL   39:FULL</span><br><span class=\"line\">   40:FULL   41:FULL   42:FULL   43:FULL</span><br><span class=\"line\">   44:FULL   45:FULL   46:FULL   47:FULL</span><br><span class=\"line\">   48:FULL   49:FULL   50:FULL   51:FULL</span><br><span class=\"line\">   52:FULL   53:FULL   54:FULL   55:FULL</span><br><span class=\"line\">   56:FULL   57:FULL   58:FULL   59:FULL</span><br><span class=\"line\">   60:FULL   61:FULL   62:FULL   63:FULL</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 8065 maxblk 8065</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>居然全满了？再看8192号L1呢</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">DBA Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x01402000  Length: 128    Offset: 0      </span><br><span class=\"line\">   0x01402080  Length: 128    Offset: 128    </span><br><span class=\"line\"></span><br><span class=\"line\">   0:Metadata   1:FULL   2:FULL   3:FULL</span><br><span class=\"line\">   4:FULL   5:FULL   6:FULL   7:FULL</span><br><span class=\"line\">   8:FULL   9:FULL   10:FULL   11:FULL</span><br><span class=\"line\">   12:FULL   13:FULL   14:FULL   15:FULL</span><br><span class=\"line\">   16:FULL   17:FULL   18:FULL   19:FULL</span><br><span class=\"line\">   20:FULL   21:FULL   22:FULL   23:FULL</span><br><span class=\"line\">   24:FULL   25:FULL   26:FULL   27:FULL</span><br><span class=\"line\">   28:FULL   29:FULL   30:FULL   31:FULL</span><br><span class=\"line\">   32:FULL   33:FULL   34:FULL   35:FULL</span><br><span class=\"line\">   36:FULL   37:FULL   38:FULL   39:FULL</span><br><span class=\"line\">   40:FULL   41:FULL   42:FULL   43:FULL</span><br><span class=\"line\">   44:FULL   45:FULL   46:FULL   47:FULL</span><br><span class=\"line\">   48:FULL   49:FULL   50:FULL   51:FULL</span><br><span class=\"line\">   52:FULL   53:FULL   54:FULL   55:FULL</span><br><span class=\"line\">   56:FULL   57:FULL   58:FULL   59:FULL</span><br><span class=\"line\">   60:FULL   61:FULL   62:FULL   63:FULL</span><br><span class=\"line\">   64:FULL   65:FULL   66:FULL   67:FULL</span><br><span class=\"line\">   68:FULL   69:FULL   70:FULL   71:FULL</span><br><span class=\"line\">   72:FULL   73:FULL   74:FULL   75:FULL</span><br><span class=\"line\">   76:FULL   77:FULL   78:FULL   79:FULL</span><br><span class=\"line\">   80:FULL   81:FULL   82:FULL   83:FULL</span><br><span class=\"line\">   84:FULL   85:FULL   86:FULL   87:FULL</span><br><span class=\"line\">   88:FULL   89:FULL   90:FULL   91:FULL</span><br><span class=\"line\">   92:FULL   93:FULL   94:FULL   95:FULL</span><br><span class=\"line\">   96:FULL   97:FULL   98:FULL   99:FULL</span><br><span class=\"line\">   100:FULL   101:FULL   102:FULL   103:FULL</span><br><span class=\"line\">   104:FULL   105:FULL   106:FULL   107:FULL</span><br><span class=\"line\">   108:FULL   109:FULL   110:FULL   111:FULL</span><br><span class=\"line\">   112:FULL   113:FULL   114:FULL   115:FULL</span><br><span class=\"line\">   116:FULL   117:FULL   118:FULL   119:FULL</span><br><span class=\"line\">   120:FULL   121:FULL   122:FULL   123:FULL</span><br><span class=\"line\">   124:FULL   125:FULL   126:FULL   127:FULL</span><br><span class=\"line\">   128:unformatted   129:unformatted   130:unformatted   131:unformatted</span><br><span class=\"line\">   132:unformatted   133:unformatted   134:unformatted   135:unformatted</span><br><span class=\"line\">   136:unformatted   137:unformatted   138:unformatted   139:unformatted</span><br><span class=\"line\">   140:unformatted   141:unformatted   142:unformatted   143:unformatted</span><br><span class=\"line\">   144:75-100% free   145:75-100% free   146:75-100% free   147:75-100% free</span><br><span class=\"line\">   148:75-100% free   149:75-100% free   150:75-100% free   151:75-100% free</span><br><span class=\"line\">   152:75-100% free   153:75-100% free   154:75-100% free   155:FULL</span><br><span class=\"line\">   156:75-100% free   157:75-100% free   158:75-100% free   159:75-100% free</span><br><span class=\"line\">   160:75-100% free   161:75-100% free   162:75-100% free   163:FULL</span><br><span class=\"line\">   164:75-100% free   165:75-100% free   166:75-100% free   167:75-100% free</span><br><span class=\"line\">   168:75-100% free   169:75-100% free   170:75-100% free   171:75-100% free</span><br><span class=\"line\">   172:75-100% free   173:75-100% free   174:75-100% free   175:75-100% free</span><br><span class=\"line\">   176:unformatted   177:unformatted   178:unformatted   179:unformatted</span><br><span class=\"line\">   180:unformatted   181:unformatted   182:unformatted   183:unformatted</span><br><span class=\"line\">   184:unformatted   185:unformatted   186:unformatted   187:unformatted</span><br><span class=\"line\">   188:unformatted   189:unformatted   190:unformatted   191:unformatted</span><br><span class=\"line\">   192:unformatted   193:unformatted   194:unformatted   195:unformatted</span><br><span class=\"line\">   196:unformatted   197:unformatted   198:unformatted   199:unformatted</span><br><span class=\"line\">   200:unformatted   201:unformatted   202:unformatted   203:unformatted</span><br><span class=\"line\">   204:unformatted   205:unformatted   206:unformatted   207:unformatted</span><br><span class=\"line\">   208:unformatted   209:unformatted   210:unformatted   211:unformatted</span><br><span class=\"line\">   212:unformatted   213:unformatted   214:unformatted   215:unformatted</span><br><span class=\"line\">   216:unformatted   217:unformatted   218:unformatted   219:unformatted</span><br><span class=\"line\">   220:unformatted   221:unformatted   222:unformatted   223:unformatted</span><br><span class=\"line\">   224:unformatted   225:unformatted   226:unformatted   227:unformatted</span><br><span class=\"line\">   228:unformatted   229:unformatted   230:unformatted   231:unformatted</span><br><span class=\"line\">   232:unformatted   233:unformatted   234:unformatted   235:unformatted</span><br><span class=\"line\">   236:unformatted   237:unformatted   238:unformatted   239:unformatted</span><br><span class=\"line\">   240:unformatted   241:unformatted   242:unformatted   243:unformatted</span><br><span class=\"line\">   244:unformatted   245:unformatted   246:unformatted   247:unformatted</span><br><span class=\"line\">   248:unformatted   249:unformatted   250:unformatted   251:unformatted</span><br><span class=\"line\">   252:unformatted   253:unformatted   254:unformatted   255:unformatted</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 8192 maxblk 8192</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>完蛋了，计算错误，L1下面的第二个区也已经被格式化了，看段头信息</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Extent Control Header</span><br><span class=\"line\">  -----------------------------------------------------------------</span><br><span class=\"line\">  Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928</span><br><span class=\"line\">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class=\"line\">      Highwater::  0x01402100  ext#: 64     blk#: 128    ext size: 128   </span><br><span class=\"line\">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class=\"line\">  #blocks below: 8191  </span><br><span class=\"line\">  mapblk  0x00000000  offset: 64</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>果然高水位指到了第66个区的L1块地址，这会影响我们的判断，到底哪里出问题了呢？观察8192号块内容是后128个块里被插入了2条，前128个块全满，也就是说我多插了130个块，后来猛然醒悟，我使用DBA来计算的，忘记减去128个块的文件头了，这么一算结果相查差还是不大的，太马虎了，要不是因为马虎哥也能上清华北大了；然后该怎么办呢？重新来过？不用！既然这个L1推过头了，索性把它堆满，然后我们去观察下一个L1，这下就好计算了；</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">declare</span></span><br><span class=\"line\">i <span class=\"built_in\">number</span>;</span><br><span class=\"line\"><span class=\"keyword\">begin</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"number\">1.</span><span class=\"number\">.126</span> <span class=\"keyword\">loop</span></span><br><span class=\"line\"><span class=\"keyword\">insert</span> <span class=\"keyword\">into</span> lp <span class=\"keyword\">values</span>(i,<span class=\"string\">'a'</span>,<span class=\"string\">'a'</span>,<span class=\"string\">'a'</span>,<span class=\"string\">'a'</span>);</span><br><span class=\"line\"><span class=\"keyword\">end</span> <span class=\"keyword\">loop</span>;</span><br><span class=\"line\"><span class=\"keyword\">end</span>;</span><br><span class=\"line\">/</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>观察8192号块</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\"> DBA Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x01402000  Length: 128    Offset: 0      </span><br><span class=\"line\">   0x01402080  Length: 128    Offset: 128    </span><br><span class=\"line\"></span><br><span class=\"line\">   0:Metadata   1:FULL   2:FULL   3:FULL</span><br><span class=\"line\">   4:FULL   5:FULL   6:FULL   7:FULL</span><br><span class=\"line\">   8:FULL   9:FULL   10:FULL   11:FULL</span><br><span class=\"line\">   12:FULL   13:FULL   14:FULL   15:FULL</span><br><span class=\"line\">   16:FULL   17:FULL   18:FULL   19:FULL</span><br><span class=\"line\">   20:FULL   21:FULL   22:FULL   23:FULL</span><br><span class=\"line\">   24:FULL   25:FULL   26:FULL   27:FULL</span><br><span class=\"line\">   28:FULL   29:FULL   30:FULL   31:FULL</span><br><span class=\"line\">   32:FULL   33:FULL   34:FULL   35:FULL</span><br><span class=\"line\">   36:FULL   37:FULL   38:FULL   39:FULL</span><br><span class=\"line\">   40:FULL   41:FULL   42:FULL   43:FULL</span><br><span class=\"line\">   44:FULL   45:FULL   46:FULL   47:FULL</span><br><span class=\"line\">   48:FULL   49:FULL   50:FULL   51:FULL</span><br><span class=\"line\">   52:FULL   53:FULL   54:FULL   55:FULL</span><br><span class=\"line\">   56:FULL   57:FULL   58:FULL   59:FULL</span><br><span class=\"line\">   60:FULL   61:FULL   62:FULL   63:FULL</span><br><span class=\"line\">   64:FULL   65:FULL   66:FULL   67:FULL</span><br><span class=\"line\">   68:FULL   69:FULL   70:FULL   71:FULL</span><br><span class=\"line\">   72:FULL   73:FULL   74:FULL   75:FULL</span><br><span class=\"line\">   76:FULL   77:FULL   78:FULL   79:FULL</span><br><span class=\"line\">   80:FULL   81:FULL   82:FULL   83:FULL</span><br><span class=\"line\">   84:FULL   85:FULL   86:FULL   87:FULL</span><br><span class=\"line\">   88:FULL   89:FULL   90:FULL   91:FULL</span><br><span class=\"line\">   92:FULL   93:FULL   94:FULL   95:FULL</span><br><span class=\"line\">   96:FULL   97:FULL   98:FULL   99:FULL</span><br><span class=\"line\">   100:FULL   101:FULL   102:FULL   103:FULL</span><br><span class=\"line\">   104:FULL   105:FULL   106:FULL   107:FULL</span><br><span class=\"line\">   108:FULL   109:FULL   110:FULL   111:FULL</span><br><span class=\"line\">   112:FULL   113:FULL   114:FULL   115:FULL</span><br><span class=\"line\">   116:FULL   117:FULL   118:FULL   119:FULL</span><br><span class=\"line\">   120:FULL   121:FULL   122:FULL   123:FULL</span><br><span class=\"line\">   124:FULL   125:FULL   126:FULL   127:FULL</span><br><span class=\"line\">   128:FULL   129:FULL   130:FULL   131:FULL</span><br><span class=\"line\">   132:FULL   133:FULL   134:FULL   135:FULL</span><br><span class=\"line\">   136:FULL   137:FULL   138:FULL   139:FULL</span><br><span class=\"line\">   140:FULL   141:FULL   142:FULL   143:FULL</span><br><span class=\"line\">   144:FULL   145:FULL   146:FULL   147:FULL</span><br><span class=\"line\">   148:FULL   149:FULL   150:FULL   151:FULL</span><br><span class=\"line\">   152:FULL   153:FULL   154:FULL   155:FULL</span><br><span class=\"line\">   156:FULL   157:FULL   158:FULL   159:FULL</span><br><span class=\"line\">   160:FULL   161:FULL   162:FULL   163:FULL</span><br><span class=\"line\">   164:FULL   165:FULL   166:FULL   167:FULL</span><br><span class=\"line\">   168:FULL   169:FULL   170:FULL   171:FULL</span><br><span class=\"line\">   172:FULL   173:FULL   174:FULL   175:FULL</span><br><span class=\"line\">   176:FULL   177:FULL   178:FULL   179:FULL</span><br><span class=\"line\">   180:FULL   181:FULL   182:FULL   183:FULL</span><br><span class=\"line\">   184:FULL   185:FULL   186:FULL   187:FULL</span><br><span class=\"line\">   188:FULL   189:FULL   190:FULL   191:FULL</span><br><span class=\"line\">   192:FULL   193:FULL   194:FULL   195:FULL</span><br><span class=\"line\">   196:FULL   197:FULL   198:FULL   199:FULL</span><br><span class=\"line\">   200:FULL   201:FULL   202:FULL   203:FULL</span><br><span class=\"line\">   204:FULL   205:FULL   206:FULL   207:FULL</span><br><span class=\"line\">   208:FULL   209:FULL   210:FULL   211:FULL</span><br><span class=\"line\">   212:FULL   213:FULL   214:FULL   215:FULL</span><br><span class=\"line\">   216:FULL   217:FULL   218:FULL   219:FULL</span><br><span class=\"line\">   220:FULL   221:FULL   222:FULL   223:FULL</span><br><span class=\"line\">   224:FULL   225:FULL   226:FULL   227:FULL</span><br><span class=\"line\">   228:FULL   229:FULL   230:FULL   231:FULL</span><br><span class=\"line\">   232:FULL   233:FULL   234:FULL   235:FULL</span><br><span class=\"line\">   236:FULL   237:FULL   238:FULL   239:FULL</span><br><span class=\"line\">   240:FULL   241:FULL   242:FULL   243:FULL</span><br><span class=\"line\">   244:FULL   245:FULL   246:FULL   247:FULL</span><br><span class=\"line\">   248:FULL   249:FULL   250:FULL   251:FULL</span><br><span class=\"line\">   252:FULL   253:FULL   254:FULL   255:FULL</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 8192 maxblk 8192</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>已经全满了，这个时候我们再去看一下段头的高水位</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Extent Control Header</span><br><span class=\"line\"> -----------------------------------------------------------------</span><br><span class=\"line\"> Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928</span><br><span class=\"line\">                 last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class=\"line\">     Highwater::  0x01402100  ext#: 64     blk#: 128    ext size: 128   </span><br><span class=\"line\"> #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class=\"line\"> #blocks below: 8191  </span><br><span class=\"line\"> mapblk  0x00000000  offset: 64</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>没有动，看来oracle也是事不到眼前不知道着急啊，来看一看下一个L1</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select dbms_utility.data_block_address_file(to_number('01402100', 'xxxxxxxx')) file#,</span><br><span class=\"line\">  2 dbms_utility.data_block_address_block(to_number('01402100', 'xxxxxxxx')) block<span class=\"comment\">#</span></span><br><span class=\"line\">  3 from dual;</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\"># BLOCK#</span></span><br><span class=\"line\"><span class=\"comment\">---------- ----------</span></span><br><span class=\"line\">         5 8448</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这个L1是5号文件8448号块，dump出来</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\"> DBA Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x01402100  Length: 128    Offset: 0      </span><br><span class=\"line\">   0x01402180  Length: 128    Offset: 128    </span><br><span class=\"line\"></span><br><span class=\"line\">   0:Metadata   1:unformatted   2:unformatted   3:unformatted</span><br><span class=\"line\">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class=\"line\">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class=\"line\">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class=\"line\">   16:unformatted   17:unformatted   18:unformatted   19:unformatted</span><br><span class=\"line\">   20:unformatted   21:unformatted   22:unformatted   23:unformatted</span><br><span class=\"line\">   24:unformatted   25:unformatted   26:unformatted   27:unformatted</span><br><span class=\"line\">   28:unformatted   29:unformatted   30:unformatted   31:unformatted</span><br><span class=\"line\">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class=\"line\">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class=\"line\">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class=\"line\">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class=\"line\">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class=\"line\">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class=\"line\">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class=\"line\">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class=\"line\">   64:unformatted   65:unformatted   66:unformatted   67:unformatted</span><br><span class=\"line\">   68:unformatted   69:unformatted   70:unformatted   71:unformatted</span><br><span class=\"line\">   72:unformatted   73:unformatted   74:unformatted   75:unformatted</span><br><span class=\"line\">   76:unformatted   77:unformatted   78:unformatted   79:unformatted</span><br><span class=\"line\">   80:unformatted   81:unformatted   82:unformatted   83:unformatted</span><br><span class=\"line\">   84:unformatted   85:unformatted   86:unformatted   87:unformatted</span><br><span class=\"line\">   88:unformatted   89:unformatted   90:unformatted   91:unformatted</span><br><span class=\"line\">   92:unformatted   93:unformatted   94:unformatted   95:unformatted</span><br><span class=\"line\">   96:unformatted   97:unformatted   98:unformatted   99:unformatted</span><br><span class=\"line\">   100:unformatted   101:unformatted   102:unformatted   103:unformatted</span><br><span class=\"line\">   104:unformatted   105:unformatted   106:unformatted   107:unformatted</span><br><span class=\"line\">   108:unformatted   109:unformatted   110:unformatted   111:unformatted</span><br><span class=\"line\">   112:unformatted   113:unformatted   114:unformatted   115:unformatted</span><br><span class=\"line\">   116:unformatted   117:unformatted   118:unformatted   119:unformatted</span><br><span class=\"line\">   120:unformatted   121:unformatted   122:unformatted   123:unformatted</span><br><span class=\"line\">   124:unformatted   125:unformatted   126:unformatted   127:unformatted</span><br><span class=\"line\">   128:unformatted   129:unformatted   130:unformatted   131:unformatted</span><br><span class=\"line\">   132:unformatted   133:unformatted   134:unformatted   135:unformatted</span><br><span class=\"line\">   136:unformatted   137:unformatted   138:unformatted   139:unformatted</span><br><span class=\"line\">   140:unformatted   141:unformatted   142:unformatted   143:unformatted</span><br><span class=\"line\">   144:unformatted   145:unformatted   146:unformatted   147:unformatted</span><br><span class=\"line\">   148:unformatted   149:unformatted   150:unformatted   151:unformatted</span><br><span class=\"line\">   152:unformatted   153:unformatted   154:unformatted   155:unformatted</span><br><span class=\"line\">   156:unformatted   157:unformatted   158:unformatted   159:unformatted</span><br><span class=\"line\">   160:unformatted   161:unformatted   162:unformatted   163:unformatted</span><br><span class=\"line\">   164:unformatted   165:unformatted   166:unformatted   167:unformatted</span><br><span class=\"line\">   168:unformatted   169:unformatted   170:unformatted   171:unformatted</span><br><span class=\"line\">   172:unformatted   173:unformatted   174:unformatted   175:unformatted</span><br><span class=\"line\">   176:unformatted   177:unformatted   178:unformatted   179:unformatted</span><br><span class=\"line\">   180:unformatted   181:unformatted   182:unformatted   183:unformatted</span><br><span class=\"line\">   184:unformatted   185:unformatted   186:unformatted   187:unformatted</span><br><span class=\"line\">   188:unformatted   189:unformatted   190:unformatted   191:unformatted</span><br><span class=\"line\">   192:unformatted   193:unformatted   194:unformatted   195:unformatted</span><br><span class=\"line\">   196:unformatted   197:unformatted   198:unformatted   199:unformatted</span><br><span class=\"line\">   200:unformatted   201:unformatted   202:unformatted   203:unformatted</span><br><span class=\"line\">   204:unformatted   205:unformatted   206:unformatted   207:unformatted</span><br><span class=\"line\">   208:unformatted   209:unformatted   210:unformatted   211:unformatted</span><br><span class=\"line\">   212:unformatted   213:unformatted   214:unformatted   215:unformatted</span><br><span class=\"line\">   216:unformatted   217:unformatted   218:unformatted   219:unformatted</span><br><span class=\"line\">   220:unformatted   221:unformatted   222:unformatted   223:unformatted</span><br><span class=\"line\">   224:unformatted   225:unformatted   226:unformatted   227:unformatted</span><br><span class=\"line\">   228:unformatted   229:unformatted   230:unformatted   231:unformatted</span><br><span class=\"line\">   232:unformatted   233:unformatted   234:unformatted   235:unformatted</span><br><span class=\"line\">   236:unformatted   237:unformatted   238:unformatted   239:unformatted</span><br><span class=\"line\">   240:unformatted   241:unformatted   242:unformatted   243:unformatted</span><br><span class=\"line\">   244:unformatted   245:unformatted   246:unformatted   247:unformatted</span><br><span class=\"line\">   248:unformatted   249:unformatted   250:unformatted   251:unformatted</span><br><span class=\"line\">   252:unformatted   253:unformatted   254:unformatted   255:unformatted</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 8448 maxblk 8448</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>256个块，除了第一个是L1元数据之外，没有一个格式化的，这就达到了我们的目的，我现在要插入一条数据，迫使高水位推动，猜一下高水位会在哪？在L1管理的最后一个块后面么？<br>看插入一行数据之后的8448号块</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">DBA Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x01402100  Length: 128    Offset: 0      </span><br><span class=\"line\">   0x01402180  Length: 128    Offset: 128    </span><br><span class=\"line\"></span><br><span class=\"line\">   0:Metadata   1:unformatted   2:unformatted   3:unformatted</span><br><span class=\"line\">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class=\"line\">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class=\"line\">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class=\"line\">   16:75-100% free   17:75-100% free   18:75-100% free   19:75-100% free</span><br><span class=\"line\">   20:75-100% free   21:75-100% free   22:75-100% free   23:75-100% free</span><br><span class=\"line\">   24:75-100% free   25:75-100% free   26:75-100% free   27:75-100% free</span><br><span class=\"line\">   28:FULL   29:75-100% free   30:75-100% free   31:75-100% free</span><br><span class=\"line\">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class=\"line\">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class=\"line\">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class=\"line\">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class=\"line\">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class=\"line\">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class=\"line\">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class=\"line\">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class=\"line\">   64:unformatted   65:unformatted   66:unformatted   67:unformatted</span><br><span class=\"line\">   68:unformatted   69:unformatted   70:unformatted   71:unformatted</span><br><span class=\"line\">   72:unformatted   73:unformatted   74:unformatted   75:unformatted</span><br><span class=\"line\">   76:unformatted   77:unformatted   78:unformatted   79:unformatted</span><br><span class=\"line\">   80:unformatted   81:unformatted   82:unformatted   83:unformatted</span><br><span class=\"line\">   84:unformatted   85:unformatted   86:unformatted   87:unformatted</span><br><span class=\"line\">   88:unformatted   89:unformatted   90:unformatted   91:unformatted</span><br><span class=\"line\">   92:unformatted   93:unformatted   94:unformatted   95:unformatted</span><br><span class=\"line\">   96:unformatted   97:unformatted   98:unformatted   99:unformatted</span><br><span class=\"line\">   100:unformatted   101:unformatted   102:unformatted   103:unformatted</span><br><span class=\"line\">   104:unformatted   105:unformatted   106:unformatted   107:unformatted</span><br><span class=\"line\">   108:unformatted   109:unformatted   110:unformatted   111:unformatted</span><br><span class=\"line\">   112:unformatted   113:unformatted   114:unformatted   115:unformatted</span><br><span class=\"line\">   116:unformatted   117:unformatted   118:unformatted   119:unformatted</span><br><span class=\"line\">   120:unformatted   121:unformatted   122:unformatted   123:unformatted</span><br><span class=\"line\">   124:unformatted   125:unformatted   126:unformatted   127:unformatted</span><br><span class=\"line\">   128:unformatted   129:unformatted   130:unformatted   131:unformatted</span><br><span class=\"line\">   132:unformatted   133:unformatted   134:unformatted   135:unformatted</span><br><span class=\"line\">   136:unformatted   137:unformatted   138:unformatted   139:unformatted</span><br><span class=\"line\">   140:unformatted   141:unformatted   142:unformatted   143:unformatted</span><br><span class=\"line\">   144:unformatted   145:unformatted   146:unformatted   147:unformatted</span><br><span class=\"line\">   148:unformatted   149:unformatted   150:unformatted   151:unformatted</span><br><span class=\"line\">   152:unformatted   153:unformatted   154:unformatted   155:unformatted</span><br><span class=\"line\">   156:unformatted   157:unformatted   158:unformatted   159:unformatted</span><br><span class=\"line\">   160:unformatted   161:unformatted   162:unformatted   163:unformatted</span><br><span class=\"line\">   164:unformatted   165:unformatted   166:unformatted   167:unformatted</span><br><span class=\"line\">   168:unformatted   169:unformatted   170:unformatted   171:unformatted</span><br><span class=\"line\">   172:unformatted   173:unformatted   174:unformatted   175:unformatted</span><br><span class=\"line\">   176:unformatted   177:unformatted   178:unformatted   179:unformatted</span><br><span class=\"line\">   180:unformatted   181:unformatted   182:unformatted   183:unformatted</span><br><span class=\"line\">   184:unformatted   185:unformatted   186:unformatted   187:unformatted</span><br><span class=\"line\">   188:unformatted   189:unformatted   190:unformatted   191:unformatted</span><br><span class=\"line\">   192:unformatted   193:unformatted   194:unformatted   195:unformatted</span><br><span class=\"line\">   196:unformatted   197:unformatted   198:unformatted   199:unformatted</span><br><span class=\"line\">   200:unformatted   201:unformatted   202:unformatted   203:unformatted</span><br><span class=\"line\">   204:unformatted   205:unformatted   206:unformatted   207:unformatted</span><br><span class=\"line\">   208:unformatted   209:unformatted   210:unformatted   211:unformatted</span><br><span class=\"line\">   212:unformatted   213:unformatted   214:unformatted   215:unformatted</span><br><span class=\"line\">   216:unformatted   217:unformatted   218:unformatted   219:unformatted</span><br><span class=\"line\">   220:unformatted   221:unformatted   222:unformatted   223:unformatted</span><br><span class=\"line\">   224:unformatted   225:unformatted   226:unformatted   227:unformatted</span><br><span class=\"line\">   228:unformatted   229:unformatted   230:unformatted   231:unformatted</span><br><span class=\"line\">   232:unformatted   233:unformatted   234:unformatted   235:unformatted</span><br><span class=\"line\">   236:unformatted   237:unformatted   238:unformatted   239:unformatted</span><br><span class=\"line\">   240:unformatted   241:unformatted   242:unformatted   243:unformatted</span><br><span class=\"line\">   244:unformatted   245:unformatted   246:unformatted   247:unformatted</span><br><span class=\"line\">   248:unformatted   249:unformatted   250:unformatted   251:unformatted</span><br><span class=\"line\">   252:unformatted   253:unformatted   254:unformatted   255:unformatted</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 8448 maxblk 8448</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>有一个块已经满了，揭晓答案的时候来了，dump出段头</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Extent Control Header</span><br><span class=\"line\">  -----------------------------------------------------------------</span><br><span class=\"line\">  Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928</span><br><span class=\"line\">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class=\"line\">      Highwater::  0x01402180  ext#: 65     blk#: 128    ext size: 128   </span><br><span class=\"line\">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class=\"line\">  #blocks below: 8318  </span><br><span class=\"line\">  mapblk  0x00000000  offset: 65</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>高水位是0x01402180，这个地址在哪呢？0x01402180比0x01402100多了十六进制80个块，就是十进制的128个块，仅仅是推动了一个区的大小，并不是一个L1的大小，这说明常规路径下插入高水位的推动是以L1和区中小的那个单位来推动的，就是L1小就推动L1里面所有块的大小，区小就推动一个区的大小，可见所谓的高并发并非像宣传的那样，还是受高水位的限制的，这个时候的区块大概像下面这个样子：</p>\n</blockquote>\n<p><img alt data-src=\"http://oaowhilvu.bkt.clouddn.com/%E6%89%A9%E5%B1%95%E7%9A%84L1.png\"></p>\n<blockquote>\n<p>开几个session做下插入试试</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp where trim(des1)='b';</span><br><span class=\"line\"></span><br><span class=\"line\">                                   5                                 8474</span><br><span class=\"line\">                                   5                                 8482</span><br><span class=\"line\">                                   5                                 8484</span><br><span class=\"line\">                                   5                                 8488</span><br><span class=\"line\">                                   5                                 8489</span><br><span class=\"line\">                                   5                                 8490</span><br><span class=\"line\">                                   5                                 8491</span><br><span class=\"line\">                                   5                                 8492</span><br><span class=\"line\">                                   5                                 8493</span><br><span class=\"line\">                                   5                                 8494</span><br><span class=\"line\">                                   5                                 8495</span><br><span class=\"line\">                                   5                                 8496</span><br><span class=\"line\">                                   5                                 8498</span><br><span class=\"line\">                                   5                                 8500</span><br><span class=\"line\">                                   5                                 8504</span><br><span class=\"line\">                                   5                                 8506</span><br><span class=\"line\">                                   5                                 8512</span><br><span class=\"line\">                                   5                                 8514</span><br><span class=\"line\">                                   5                                 8520</span><br><span class=\"line\">                                   5                                 8522</span><br><span class=\"line\"></span><br><span class=\"line\">20 rows selected.</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>全部是在高水位之下<br>这个实验有一点值得思考，就是PCTFREE如何设置，在插入删除频繁的段，PCTFREE的值应该要远离三个百分比线，就是25%/50%/75%，避免频繁插入删除的时候块状态频繁改变，由full变为非full，如此就会修改L1块的内容，有可能造成buffer busy waits。<br>而大家熟知的直接路径下的插入是直接在高水位之上插入并且绕过cache buffer的，这种情况下的高水位是如何推动的呢？我们再慢慢分析.</p>\n</blockquote>\n","site":{"data":{"styles":"","footer":"<div class=\"footer-custom\">\nTheme source code <span class=\"exturl theme-link\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvaGV4by10aGVtZS1uZXh0\">here</span><br>\nWebsite source code <span class=\"exturl theme-link\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvdGhlbWUtbmV4dC5vcmc=\">here</span>\n</div>\n"}},"excerpt":"","more":"<p>#ASSM三级位图结构与高水位的探究</p>\n<blockquote>\n<p>三级位图</p>\n</blockquote>\n<p>Oracle9i在本地表空管理(LMT)的基础上，对段空间管理也引入了位图管理（Segment Space Management Auto）来取代原来的freelist管理方式（Segment Space Management Manual）。<br>但是默认system和undo表空间仍然是MSSM的管理方式，本文主要探究ASSM管理方式下，段的三级位图结构和高水位推进的关系 先来看<br>ASSM管理方式下的三级位图结构图：</p>\n<p><img alt data-src=\"http://oaowhilvu.bkt.clouddn.com/%E4%B8%89%E7%BA%A7%E4%BD%8D%E5%9B%BE.jpg\"><br><em>注：此图来源于网络</em><br>一个段被创建之后，段头其实是一个L3块，在我的试验中，一个1M固定区大小，block为8K的表空间，创建的第一个段第0个区，前两个块是L1（128,129号块），第三个是L2（130号块），第四个是L3（131号块），前128个块是数据文件头，本文不讨论。<br>当数据被插入的时候，oracle根据连接进来的session，做hash运算，随机选择一个L3（如果有多个的话），再随机选择一个L2，接下来在该L2下随机选择一个L1，再从L1中管理的block里面随机选择一个块将数据插入，不同的session经过hash之后，最后落到block时已经是很分散的了，不会产生很多和会话同时往一个block中插数据申请独占buffer pin，而造成大量buffer busy waits的情况，这就是ASSM号称支持大并发插入的原理所在，但是事实上真的如此么？我们来一探究竟！</p>\n<blockquote>\n<p>实验环境</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">OS:REDHAT6.5 X64</span><br><span class=\"line\">DB VERSION:11.2.0.4</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>首先，创建一个1M区大小的表空间，并在上面创建一张表，此表创建了4个空间很大的字段，目的是要一行占满一个block，便于观察结果</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select file#,NAME,BYTES/1024/1204 from v$datafile;</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\"># NAME                                                                             BYTES/1024/1204</span></span><br><span class=\"line\"><span class=\"comment\">---------- -------------------------------------------------------------------------------- ---------------</span></span><br><span class=\"line\">         1 +DATA/min/datafile/system.256.854775095                                               637.873754</span><br><span class=\"line\">         2 +DATA/min/datafile/sysaux.257.854775097                                               484.784053</span><br><span class=\"line\">         3 +DATA/min/datafile/undotbs1.258.854775097                                             187.109635</span><br><span class=\"line\">         4 +DATA/min/datafile/users.259.854775097                                                103.122924</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; create tablespace lp datafile '+DATA/min/datafile/lp.dbf' size 2048M uniform size 1m;</span><br><span class=\"line\"></span><br><span class=\"line\">Tablespace created.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; select file#,NAME,BYTES/1024/1204 from v$datafile;</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\"># NAME                                                                             BYTES/1024/1204</span></span><br><span class=\"line\"><span class=\"comment\">---------- -------------------------------------------------------------------------------- ---------------</span></span><br><span class=\"line\">         1 +DATA/min/datafile/system.256.854775095                                               637.873754</span><br><span class=\"line\">         2 +DATA/min/datafile/sysaux.257.854775097                                               484.784053</span><br><span class=\"line\">         3 +DATA/min/datafile/undotbs1.258.854775097                                             187.109635</span><br><span class=\"line\">         4 +DATA/min/datafile/users.259.854775097                                                103.122924</span><br><span class=\"line\">         5 +DATA/min/datafile/lp.dbf                                                              1741.8206</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; create table lp (id number,des1 char(2000),des2 char(2000),des3 char(2000),des4 char(500)) tablespace lp;</span><br><span class=\"line\"></span><br><span class=\"line\">Table created.</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>观察新建的表所占区</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; col SEGMENT_NAME for a30</span><br><span class=\"line\">SQL&gt; col des1 for a1</span><br><span class=\"line\">SQL&gt; col des2 for a1</span><br><span class=\"line\">SQL&gt; col des3 for a1</span><br><span class=\"line\">SQL&gt; col des4 for a1</span><br><span class=\"line\">SQL&gt; set line 200</span><br><span class=\"line\">SQL&gt; select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID, BLOCKS from dba_extents where segment_name='LP';</span><br><span class=\"line\"></span><br><span class=\"line\">SEGMENT_NAME                    EXTENT_ID    FILE_ID   BLOCK_ID     BLOCKS</span><br><span class=\"line\"><span class=\"comment\">------------------------------ ---------- ---------- ---------- ----------</span></span><br><span class=\"line\">LP                                      0          5        128        128</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>此表是5号文件，拥有1个区，block从128号开始，接下来我们插入一条数据，并dump出段头进行观察</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; insert into lp values(1,'a','a','a','a');</span><br><span class=\"line\"></span><br><span class=\"line\">1 row created.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; commit;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">Commit</span> complete.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">SQL</span>&gt; <span class=\"keyword\">select</span> segment_name ,HEADER_FILE,HEADER_BLOCK <span class=\"keyword\">from</span> dba_segments <span class=\"keyword\">where</span> segment_name=<span class=\"string\">'LP'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">SEGMENT_NAME                   HEADER_FILE HEADER_BLOCK</span><br><span class=\"line\"><span class=\"comment\">------------------------------ ----------- ------------</span></span><br><span class=\"line\">LP                                       5          131</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; alter system checkpoint;</span><br><span class=\"line\"></span><br><span class=\"line\">System altered.</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>LP的段头是5号文件，131号块，进行dump</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; alter system dump datafile 5 block 131;</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; col value for a65</span><br><span class=\"line\">SQL&gt; select *  from v$diag_info;</span><br><span class=\"line\"></span><br><span class=\"line\">   INST_ID NAME                                                                             VALUE</span><br><span class=\"line\"><span class=\"comment\">---------- -------------------------------------------------------------------------------- -----------------------------------------------------------------</span></span><br><span class=\"line\">         1 Diag Enabled                                                                     TRUE</span><br><span class=\"line\">         1 ADR Base                                                                         /u01/app/oracle</span><br><span class=\"line\">         1 ADR Home                                                                         /u01/app/oracle/diag/rdbms/min/min</span><br><span class=\"line\">         1 Diag Trace                                                                       /u01/app/oracle/diag/rdbms/min/min/trace</span><br><span class=\"line\">         1 Diag Alert                                                                       /u01/app/oracle/diag/rdbms/min/min/alert</span><br><span class=\"line\">         1 Diag Incident                                                                    /u01/app/oracle/diag/rdbms/min/min/incident</span><br><span class=\"line\">         1 Diag Cdump                                                                       /u01/app/oracle/diag/rdbms/min/min/cdump</span><br><span class=\"line\">         1 Health Monitor                                                                   /u01/app/oracle/diag/rdbms/min/min/hm</span><br><span class=\"line\">         1 Default Trace File                                                               /u01/app/oracle/diag/rdbms/min/min/trace/min_ora_2835.trc</span><br><span class=\"line\">         1 Active Problem Count                                                             0</span><br><span class=\"line\">         1 Active Incident Count                                                            0</span><br><span class=\"line\"></span><br><span class=\"line\">11 rows selected.</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>观察trc文件min_ora_2835.trc</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Block dump from disk:</span><br><span class=\"line\">buffer tsn: 8 rdba: 0x01400083 (5/131)</span><br><span class=\"line\">scn: 0x0000.00140d51 seq: 0x01 flg: 0x04 tail: 0x0d512301</span><br><span class=\"line\">frmt: 0x02 chkval: 0xfd8a type: 0x23=PAGETABLE SEGMENT HEADER</span><br><span class=\"line\">Hex dump of block: st=0, typ_found=1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Extent Control Header</span><br><span class=\"line\">  -----------------------------------------------------------------</span><br><span class=\"line\">  Extent Header:: spare1: 0      spare2: 0      #extents: 1      #blocks: 128   </span><br><span class=\"line\">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class=\"line\">      Highwater::  0x014000c0  ext#: 0      blk#: 64     ext size: 128   </span><br><span class=\"line\">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class=\"line\">  #blocks below: 60    </span><br><span class=\"line\">  mapblk  0x00000000  offset: 0     </span><br><span class=\"line\">                   Unlocked</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">  Low HighWater Mark :</span><br><span class=\"line\">      Highwater::  0x01400084  ext#: 0      blk#: 4      ext size: 128   </span><br><span class=\"line\">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class=\"line\">  #blocks below: 0     </span><br><span class=\"line\">  mapblk  0x00000000  offset: 0     </span><br><span class=\"line\">  Level 1 BMB for High HWM block: 0x01400080</span><br><span class=\"line\">  Level 1 BMB for Low HWM block: 0x01400080</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">  Segment Type: 1 nl2: 1      blksz: 8192   fbsz: 0      </span><br><span class=\"line\">  L2 Array start offset:  0x00001434</span><br><span class=\"line\">  First Level 3 BMB:  0x00000000</span><br><span class=\"line\">  L2 Hint for inserts:  0x01400082</span><br><span class=\"line\">  Last Level 1 BMB:  0x01400081</span><br><span class=\"line\">  Last Level II BMB:  0x01400082</span><br><span class=\"line\">  Last Level III BMB:  0x00000000</span><br><span class=\"line\">     Map Header:: next  0x00000000  #extents: 1    obj#: 87596  flag: 0x10000000</span><br><span class=\"line\">  Inc # 0</span><br><span class=\"line\">  Extent Map</span><br><span class=\"line\">  -----------------------------------------------------------------</span><br><span class=\"line\">   0x01400080  length: 128   </span><br><span class=\"line\"></span><br><span class=\"line\">  Auxillary Map</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   Extent 0     :  L1 dba:  0x01400080 Data dba:  0x01400084</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">Second Level Bitmap block DBAs</span><br><span class=\"line\">   --------------------------------------------------------</span><br><span class=\"line\">   DBA 1:   0x01400082</span><br><span class=\"line\"></span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 131 maxblk 131</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>很容易发现这是一个PAGETABLE SEGMENT HEADER块，Extent Map中只有一个区，另外在尾部有一个指向二级位图块的地址0x01400082，这是数据块地址的二进制用十六进制来表示，我们来将其转化成直观一点的信息</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select dbms_utility.data_block_address_file(to_number('01400082', 'xxxxxxxx')) file#,</span><br><span class=\"line\">  2 dbms_utility.data_block_address_block(to_number('01400082', 'xxxxxxxx')) block<span class=\"comment\">#</span></span><br><span class=\"line\">  3 from dual;</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\"># BLOCK#</span></span><br><span class=\"line\"><span class=\"comment\">---------- ----------</span></span><br><span class=\"line\">         5 130</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>依样将5号文件130号块的内容dump出来</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Block dump from disk:</span><br><span class=\"line\">buffer tsn: 8 rdba: 0x01400082 (5/130)</span><br><span class=\"line\">scn: 0x0000.00140a45 seq: 0x02 flg: 0x04 tail: 0x0a452102</span><br><span class=\"line\">frmt: 0x02 chkval: 0xd119 type: 0x21=SECOND LEVEL BITMAP BLOCK</span><br><span class=\"line\">Hex dump of block: st=0, typ_found=1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Dump of Second Level Bitmap Block</span><br><span class=\"line\">   number: 2       nfree: 2       ffree: 0      pdba:     0x01400083</span><br><span class=\"line\">   Inc #: 0 Objd: 87596</span><br><span class=\"line\">  opcode:0</span><br><span class=\"line\"> xid:</span><br><span class=\"line\">  L1 Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x01400080  Free: 5 Inst: 1</span><br><span class=\"line\">   0x01400081  Free: 5 Inst: 1</span><br><span class=\"line\"></span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 130 maxblk 130</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>可以发现这是一个二级位图块，并从其中找到了2个L1块的地址，我们来看第一个L1</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Block dump from disk:</span><br><span class=\"line\">buffer tsn: 8 rdba: 0x01400080 (5/128)</span><br><span class=\"line\">scn: 0x0000.00140d51 seq: 0x03 flg: 0x04 tail: 0x0d512003</span><br><span class=\"line\">frmt: 0x02 chkval: 0xe697 type: 0x20=FIRST LEVEL BITMAP BLOCK</span><br><span class=\"line\">Hex dump of block: st=0, typ_found=1</span><br><span class=\"line\"></span><br><span class=\"line\">DBA Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x01400080  Length: 64     Offset: 0      </span><br><span class=\"line\"></span><br><span class=\"line\">   0:Metadata   1:Metadata   2:Metadata   3:Metadata</span><br><span class=\"line\">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class=\"line\">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class=\"line\">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class=\"line\">   16:75-100% free   17:75-100% free   18:75-100% free   19:75-100% free</span><br><span class=\"line\">   20:75-100% free   21:75-100% free   22:75-100% free   23:75-100% free</span><br><span class=\"line\">   24:75-100% free   25:75-100% free   26:75-100% free   27:75-100% free</span><br><span class=\"line\">   28:75-100% free   29:75-100% free   30:75-100% free   31:0-25% free</span><br><span class=\"line\">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class=\"line\">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class=\"line\">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class=\"line\">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class=\"line\">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class=\"line\">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class=\"line\">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class=\"line\">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 128 maxblk 128</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>无疑这是一个L1块，里面挂了64个数据块，因为我之前插入了一行数据，oracle已经格式化了一部分，并向其中一个块插入了数据，但是没达到我们的效果，被插入的块还显示0-25%的空闲，我们要的是full的状态，说明我们构造的数据不够大，没关系，我们修改一下pctfree就可以了，另外我们可以发现这个区是1M，有2个L1，每个L1里有64个数据块，接下来修改pctfree</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; alter table lp pctfree 24;</span><br><span class=\"line\"></span><br><span class=\"line\">Table altered.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; select TABLE_NAME,PCT_FREE from dba_tables where table_name='LP';</span><br><span class=\"line\"></span><br><span class=\"line\">TABLE_NAME                       PCT_FREE</span><br><span class=\"line\"><span class=\"comment\">------------------------------ ----------</span></span><br><span class=\"line\">LP                                     24</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; insert into lp values(2,'a','a','a','a');</span><br><span class=\"line\"></span><br><span class=\"line\">1 row created.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; commit;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">Commit</span> complete.</span><br><span class=\"line\"><span class=\"comment\">--手动触发检查点将内存中的块刷新到磁盘，本文每次dump之前都会做这个操作，以保证磁盘和内存的内容一致</span></span><br><span class=\"line\"><span class=\"keyword\">SQL</span>&gt; <span class=\"keyword\">alter</span> <span class=\"keyword\">system</span> checkpoint;</span><br><span class=\"line\"></span><br><span class=\"line\">System altered.</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>我们再看128号块</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">DBA Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x01400080  Length: 64     Offset: 0      </span><br><span class=\"line\"></span><br><span class=\"line\">   0:Metadata   1:Metadata   2:Metadata   3:Metadata</span><br><span class=\"line\">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class=\"line\">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class=\"line\">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class=\"line\">   16:75-100% free   17:75-100% free   18:75-100% free   19:75-100% free</span><br><span class=\"line\">   20:75-100% free   21:75-100% free   22:75-100% free   23:75-100% free</span><br><span class=\"line\">   24:75-100% free   25:75-100% free   26:75-100% free   27:75-100% free</span><br><span class=\"line\">   28:75-100% free   29:75-100% free   30:75-100% free   31:0-25% free</span><br><span class=\"line\">   32:75-100% free   33:75-100% free   34:75-100% free   &lt;font color=&apos;red&apos;&gt;35:FULL&lt;/font&gt;</span><br><span class=\"line\">   36:75-100% free   37:75-100% free   38:75-100% free   39:75-100% free</span><br><span class=\"line\">   40:75-100% free   41:75-100% free   42:75-100% free   43:75-100% free</span><br><span class=\"line\">   44:75-100% free   45:75-100% free   46:75-100% free   47:75-100% free</span><br><span class=\"line\">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class=\"line\">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class=\"line\">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class=\"line\">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 128 maxblk 128</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>已经是我们想的结果了，到这里我们再来看一下另外一个L1吧，dump129号块</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">DBA Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x014000c0  Length: 64     Offset: 0      </span><br><span class=\"line\"></span><br><span class=\"line\">   0:unformatted   1:unformatted   2:unformatted   3:unformatted</span><br><span class=\"line\">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class=\"line\">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class=\"line\">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class=\"line\">   16:unformatted   17:unformatted   18:unformatted   19:unformatted</span><br><span class=\"line\">   20:unformatted   21:unformatted   22:unformatted   23:unformatted</span><br><span class=\"line\">   24:unformatted   25:unformatted   26:unformatted   27:unformatted</span><br><span class=\"line\">   28:unformatted   29:unformatted   30:unformatted   31:unformatted</span><br><span class=\"line\">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class=\"line\">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class=\"line\">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class=\"line\">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class=\"line\">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class=\"line\">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class=\"line\">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class=\"line\">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 129 maxblk 129</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>全是未格式化的块，试一试并发插入，这里不模拟真正的并发了，只是开不同的session来进行插入</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; insert into lp values(3,'a','a','a','a');</span><br><span class=\"line\"></span><br><span class=\"line\">1 row created.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; insert into lp values(4,'a','a','a','a');</span><br><span class=\"line\"></span><br><span class=\"line\">1 row created.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; insert into lp values(5,'a','a','a','a');</span><br><span class=\"line\"></span><br><span class=\"line\">1 row created.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; insert into lp values(6,'a','a','a','a');</span><br><span class=\"line\"></span><br><span class=\"line\">1 row created.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; insert into lp values(7,'a','a','a','a');</span><br><span class=\"line\"></span><br><span class=\"line\">1 row created.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">--单独session5条</span></span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp;</span><br><span class=\"line\"></span><br><span class=\"line\">DBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID)</span><br><span class=\"line\"><span class=\"comment\">------------------------------------ ------------------------------------</span></span><br><span class=\"line\">                                   5                                  158</span><br><span class=\"line\">                                   5                                  159</span><br><span class=\"line\">                                   5                                  163</span><br><span class=\"line\">                                   5                                  167</span><br><span class=\"line\">                                   5                                  171</span><br><span class=\"line\">                                   5                                  172</span><br><span class=\"line\">                                   5                                  174</span><br><span class=\"line\">                                   5                                  175</span><br><span class=\"line\">                                   5                                  179</span><br><span class=\"line\">                                   5                                  183</span><br><span class=\"line\">                                   5                                  187</span><br><span class=\"line\">                                   5                                  191</span><br><span class=\"line\"></span><br><span class=\"line\">12 rows selected.</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>一个单独的session里插入了5条，另外5个单独的session里各插一条，发现规律了么，插入的块只在132和192之间，我们分别看看两个L1</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; alter system checkpoint;</span><br><span class=\"line\"></span><br><span class=\"line\">System altered.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  DBA Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x01400080  Length: 64     Offset: 0      </span><br><span class=\"line\"></span><br><span class=\"line\">   0:Metadata   1:Metadata   2:Metadata   3:Metadata</span><br><span class=\"line\">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class=\"line\">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class=\"line\">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class=\"line\">   16:75-100% free   17:75-100% free   18:75-100% free   19:75-100% free</span><br><span class=\"line\">   20:75-100% free   21:75-100% free   22:75-100% free   23:75-100% free</span><br><span class=\"line\">   24:75-100% free   25:75-100% free   26:75-100% free   27:75-100% free</span><br><span class=\"line\">   28:75-100% free   29:75-100% free   30:FULL   31:0-25% free</span><br><span class=\"line\">   32:75-100% free   33:75-100% free   34:75-100% free   35:FULL</span><br><span class=\"line\">   36:75-100% free   37:75-100% free   38:75-100% free   39:FULL</span><br><span class=\"line\">   40:75-100% free   41:75-100% free   42:75-100% free   43:FULL</span><br><span class=\"line\">   44:FULL   45:75-100% free   46:FULL   47:FULL</span><br><span class=\"line\">   48:75-100% free   49:75-100% free   50:75-100% free   51:FULL</span><br><span class=\"line\">   52:75-100% free   53:75-100% free   54:75-100% free   55:FULL</span><br><span class=\"line\">   56:75-100% free   57:75-100% free   58:75-100% free   59:FULL</span><br><span class=\"line\">   60:75-100% free   61:75-100% free   62:75-100% free   63:FULL</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 128 maxblk 128</span><br><span class=\"line\"></span><br><span class=\"line\">********************************************************************</span><br><span class=\"line\">看一下第二个L1</span><br><span class=\"line\"></span><br><span class=\"line\">DBA Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x014000c0  Length: 64     Offset: 0      </span><br><span class=\"line\"></span><br><span class=\"line\">   0:unformatted   1:unformatted   2:unformatted   3:unformatted</span><br><span class=\"line\">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class=\"line\">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class=\"line\">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class=\"line\">   16:unformatted   17:unformatted   18:unformatted   19:unformatted</span><br><span class=\"line\">   20:unformatted   21:unformatted   22:unformatted   23:unformatted</span><br><span class=\"line\">   24:unformatted   25:unformatted   26:unformatted   27:unformatted</span><br><span class=\"line\">   28:unformatted   29:unformatted   30:unformatted   31:unformatted</span><br><span class=\"line\">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class=\"line\">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class=\"line\">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class=\"line\">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class=\"line\">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class=\"line\">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class=\"line\">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class=\"line\">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 129 maxblk 129</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这说明只在第一个L1里面随机，那为什么L2下挂了2个L1，我插入了10条却没有一条随机到第二个L1块呢？答案是高水位，这是vage大师已经论证过的了，偶在这里仅为见证一下~~，好了，还记得L3里的高水位信息么？</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Extent Control Header</span><br><span class=\"line\">  -----------------------------------------------------------------</span><br><span class=\"line\">  Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928</span><br><span class=\"line\">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class=\"line\">      Highwater::  0x014000c0  ext#: 0      blk#: 64     ext size: 128   </span><br><span class=\"line\">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class=\"line\">  #blocks below: 60    </span><br><span class=\"line\">  mapblk  0x00000000  offset: 0</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>Highwater::  0x014000c0是哪个块呢？</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">  SQL&gt; select dbms_utility.data_block_address_file(to_number('014000c0', 'xxxxxxxx')) file#,</span><br><span class=\"line\">  2 dbms_utility.data_block_address_block(to_number('014000c0', 'xxxxxxxx')) block<span class=\"comment\">#</span></span><br><span class=\"line\">  3 from dual;</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\"># BLOCK#</span></span><br><span class=\"line\"><span class=\"comment\">---------- ----------</span></span><br><span class=\"line\">         5 192</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这是第二个L1管理的第一个块，可见数据的插入只在高水位之下进行（直接路径插入除外），此时的状态如下：</p>\n</blockquote>\n<p><img alt data-src=\"http://oaowhilvu.bkt.clouddn.com/0%E4%B8%AAextent.png\"></p>\n<blockquote>\n<p>那么L1里面只会有64个块么？高水位永远都会指向L1的最后一个块么？我们继续剖析！<br>首先给LP表多分配一些区</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; alter table lp allocate extent(size 100m);</span><br><span class=\"line\"></span><br><span class=\"line\">Table altered.</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; select SEGMENT_NAME,EXTENT_ID,FILE_ID,BLOCK_ID, BLOCKS from dba_extents where segment_name='LP';</span><br><span class=\"line\"></span><br><span class=\"line\">SEGMENT_NAME                    EXTENT_ID    FILE_ID   BLOCK_ID     BLOCKS</span><br><span class=\"line\"><span class=\"comment\">------------------------------ ---------- ---------- ---------- ----------</span></span><br><span class=\"line\">LP                                      0          5        128        128</span><br><span class=\"line\">LP                                      1          5        256        128</span><br><span class=\"line\">LP                                      2          5        384        128</span><br><span class=\"line\">LP                                      3          5        512        128</span><br><span class=\"line\">LP                                      4          5        640        128</span><br><span class=\"line\">LP                                      5          5        768        128</span><br><span class=\"line\">LP                                      6          5        896        128</span><br><span class=\"line\">LP                                      7          5       1024        128</span><br><span class=\"line\">LP                                      8          5       1152        128</span><br><span class=\"line\">LP                                      9          5       1280        128</span><br><span class=\"line\">LP                                     10          5       1408        128</span><br><span class=\"line\">LP                                     11          5       1536        128</span><br><span class=\"line\">LP                                     12          5       1664        128</span><br><span class=\"line\">LP                                     13          5       1792        128</span><br><span class=\"line\">LP                                     14          5       1920        128</span><br><span class=\"line\">LP                                     15          5       2048        128</span><br><span class=\"line\">LP                                     16          5       2176        128</span><br><span class=\"line\">LP                                     17          5       2304        128</span><br><span class=\"line\">LP                                     18          5       2432        128</span><br><span class=\"line\">LP                                     19          5       2560        128</span><br><span class=\"line\">LP                                     20          5       2688        128</span><br><span class=\"line\">LP                                     21          5       2816        128</span><br><span class=\"line\">LP                                     22          5       2944        128</span><br><span class=\"line\">LP                                     23          5       3072        128</span><br><span class=\"line\">LP                                     24          5       3200        128</span><br><span class=\"line\">LP                                     25          5       3328        128</span><br><span class=\"line\">LP                                     26          5       3456        128</span><br><span class=\"line\">LP                                     27          5       3584        128</span><br><span class=\"line\">LP                                     28          5       3712        128</span><br><span class=\"line\">LP                                     29          5       3840        128</span><br><span class=\"line\">LP                                     30          5       3968        128</span><br><span class=\"line\">LP                                     31          5       4096        128</span><br><span class=\"line\">LP                                     32          5       4224        128</span><br><span class=\"line\">LP                                     33          5       4352        128</span><br><span class=\"line\">LP                                     34          5       4480        128</span><br><span class=\"line\">LP                                     35          5       4608        128</span><br><span class=\"line\">LP                                     36          5       4736        128</span><br><span class=\"line\">LP                                     37          5       4864        128</span><br><span class=\"line\">LP                                     38          5       4992        128</span><br><span class=\"line\">LP                                     39          5       5120        128</span><br><span class=\"line\">LP                                     40          5       5248        128</span><br><span class=\"line\">LP                                     41          5       5376        128</span><br><span class=\"line\">LP                                     42          5       5504        128</span><br><span class=\"line\">LP                                     43          5       5632        128</span><br><span class=\"line\">LP                                     44          5       5760        128</span><br><span class=\"line\">LP                                     45          5       5888        128</span><br><span class=\"line\">LP                                     46          5       6016        128</span><br><span class=\"line\">LP                                     47          5       6144        128</span><br><span class=\"line\">LP                                     48          5       6272        128</span><br><span class=\"line\">LP                                     49          5       6400        128</span><br><span class=\"line\">LP                                     50          5       6528        128</span><br><span class=\"line\">LP                                     51          5       6656        128</span><br><span class=\"line\">LP                                     52          5       6784        128</span><br><span class=\"line\">LP                                     53          5       6912        128</span><br><span class=\"line\">LP                                     54          5       7040        128</span><br><span class=\"line\">LP                                     55          5       7168        128</span><br><span class=\"line\">LP                                     56          5       7296        128</span><br><span class=\"line\">LP                                     57          5       7424        128</span><br><span class=\"line\">LP                                     58          5       7552        128</span><br><span class=\"line\">LP                                     59          5       7680        128</span><br><span class=\"line\">LP                                     60          5       7808        128</span><br><span class=\"line\">LP                                     61          5       7936        128</span><br><span class=\"line\">LP                                     62          5       8064        128</span><br><span class=\"line\">LP                                     63          5       8192        128</span><br><span class=\"line\">LP                                     64          5       8320        128</span><br><span class=\"line\">LP                                     65          5       8448        128</span><br><span class=\"line\">LP                                     66          5       8576        128</span><br><span class=\"line\">LP                                     67          5       8704        128</span><br><span class=\"line\">LP                                     68          5       8832        128</span><br><span class=\"line\">LP                                     69          5       8960        128</span><br><span class=\"line\">LP                                     70          5       9088        128</span><br><span class=\"line\">LP                                     71          5       9216        128</span><br><span class=\"line\">LP                                     72          5       9344        128</span><br><span class=\"line\">LP                                     73          5       9472        128</span><br><span class=\"line\">LP                                     74          5       9600        128</span><br><span class=\"line\">LP                                     75          5       9728        128</span><br><span class=\"line\">LP                                     76          5       9856        128</span><br><span class=\"line\">LP                                     77          5       9984        128</span><br><span class=\"line\">LP                                     78          5      10112        128</span><br><span class=\"line\">LP                                     79          5      10240        128</span><br><span class=\"line\">LP                                     80          5      10368        128</span><br><span class=\"line\">LP                                     81          5      10496        128</span><br><span class=\"line\">LP                                     82          5      10624        128</span><br><span class=\"line\">LP                                     83          5      10752        128</span><br><span class=\"line\">LP                                     84          5      10880        128</span><br><span class=\"line\">LP                                     85          5      11008        128</span><br><span class=\"line\">LP                                     86          5      11136        128</span><br><span class=\"line\">LP                                     87          5      11264        128</span><br><span class=\"line\">LP                                     88          5      11392        128</span><br><span class=\"line\">LP                                     89          5      11520        128</span><br><span class=\"line\">LP                                     90          5      11648        128</span><br><span class=\"line\">LP                                     91          5      11776        128</span><br><span class=\"line\">LP                                     92          5      11904        128</span><br><span class=\"line\">LP                                     93          5      12032        128</span><br><span class=\"line\">LP                                     94          5      12160        128</span><br><span class=\"line\">LP                                     95          5      12288        128</span><br><span class=\"line\">LP                                     96          5      12416        128</span><br><span class=\"line\">LP                                     97          5      12544        128</span><br><span class=\"line\">LP                                     98          5      12672        128</span><br><span class=\"line\">LP                                     99          5      12800        128</span><br><span class=\"line\">LP                                    100          5      12928        128</span><br><span class=\"line\"></span><br><span class=\"line\">101 rows selected.</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>我分配了100个区，加上原来的一共101个，现在我们看看L3段头里面的内容</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Extent Control Header</span><br><span class=\"line\">  -----------------------------------------------------------------</span><br><span class=\"line\">  Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928</span><br><span class=\"line\">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class=\"line\">      Highwater::  0x014000c0  ext#: 0      blk#: 64     ext size: 128   </span><br><span class=\"line\">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class=\"line\">  #blocks below: 60    </span><br><span class=\"line\">  mapblk  0x00000000  offset: 0     </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Extent Map</span><br><span class=\"line\">  -----------------------------------------------------------------</span><br><span class=\"line\">   0x01400080  length: 128   </span><br><span class=\"line\">   0x01400100  length: 128   </span><br><span class=\"line\">   0x01400180  length: 128   </span><br><span class=\"line\">   0x01400200  length: 128   </span><br><span class=\"line\">   0x01400280  length: 128   </span><br><span class=\"line\">   0x01400300  length: 128   </span><br><span class=\"line\">   0x01400380  length: 128   </span><br><span class=\"line\">   0x01400400  length: 128   </span><br><span class=\"line\">   0x01400480  length: 128   </span><br><span class=\"line\">   0x01400500  length: 128   </span><br><span class=\"line\">   0x01400580  length: 128   </span><br><span class=\"line\">   0x01400600  length: 128   </span><br><span class=\"line\">   0x01400680  length: 128   </span><br><span class=\"line\">   0x01400700  length: 128   </span><br><span class=\"line\">   0x01400780  length: 128   </span><br><span class=\"line\">   0x01400800  length: 128   </span><br><span class=\"line\">   0x01400880  length: 128   </span><br><span class=\"line\">   0x01400900  length: 128   </span><br><span class=\"line\">   0x01400980  length: 128   </span><br><span class=\"line\">   0x01400a00  length: 128   </span><br><span class=\"line\">   0x01400a80  length: 128   </span><br><span class=\"line\">   0x01400b00  length: 128   </span><br><span class=\"line\">   0x01400b80  length: 128   </span><br><span class=\"line\">   0x01400c00  length: 128   </span><br><span class=\"line\">   0x01400c80  length: 128   </span><br><span class=\"line\">   0x01400d00  length: 128   </span><br><span class=\"line\">   0x01400d80  length: 128   </span><br><span class=\"line\">   0x01400e00  length: 128   </span><br><span class=\"line\">   0x01400e80  length: 128   </span><br><span class=\"line\">   0x01400f00  length: 128   </span><br><span class=\"line\">   0x01400f80  length: 128   </span><br><span class=\"line\">   0x01401000  length: 128   </span><br><span class=\"line\">   0x01401080  length: 128   </span><br><span class=\"line\">   0x01401100  length: 128   </span><br><span class=\"line\">   0x01401180  length: 128   </span><br><span class=\"line\">   0x01401200  length: 128   </span><br><span class=\"line\">   0x01401280  length: 128   </span><br><span class=\"line\">   0x01401300  length: 128   </span><br><span class=\"line\">   0x01401380  length: 128   </span><br><span class=\"line\">   0x01401400  length: 128   </span><br><span class=\"line\">   0x01401480  length: 128   </span><br><span class=\"line\">   0x01401500  length: 128   </span><br><span class=\"line\">   0x01401580  length: 128   </span><br><span class=\"line\">   0x01401600  length: 128   </span><br><span class=\"line\">   0x01401680  length: 128   </span><br><span class=\"line\">   0x01401700  length: 128   </span><br><span class=\"line\">   0x01401780  length: 128   </span><br><span class=\"line\">   0x01401800  length: 128   </span><br><span class=\"line\">   0x01401880  length: 128   </span><br><span class=\"line\">   0x01401900  length: 128   </span><br><span class=\"line\">   0x01401980  length: 128   </span><br><span class=\"line\">   0x01401a00  length: 128   </span><br><span class=\"line\">   0x01401a80  length: 128   </span><br><span class=\"line\">   0x01401b00  length: 128   </span><br><span class=\"line\">   0x01401b80  length: 128   </span><br><span class=\"line\">   0x01401c00  length: 128   </span><br><span class=\"line\">   0x01401c80  length: 128   </span><br><span class=\"line\">   0x01401d00  length: 128   </span><br><span class=\"line\">   0x01401d80  length: 128   </span><br><span class=\"line\">   0x01401e00  length: 128   </span><br><span class=\"line\">   0x01401e80  length: 128   </span><br><span class=\"line\">   0x01401f00  length: 128   </span><br><span class=\"line\">   0x01401f80  length: 128   </span><br><span class=\"line\">   0x01402000  length: 128   </span><br><span class=\"line\">   0x01402080  length: 128   </span><br><span class=\"line\">   0x01402100  length: 128   </span><br><span class=\"line\">   0x01402180  length: 128   </span><br><span class=\"line\">   0x01402200  length: 128   </span><br><span class=\"line\">   0x01402280  length: 128   </span><br><span class=\"line\">   0x01402300  length: 128   </span><br><span class=\"line\">   0x01402380  length: 128   </span><br><span class=\"line\">   0x01402400  length: 128   </span><br><span class=\"line\">   0x01402480  length: 128   </span><br><span class=\"line\">   0x01402500  length: 128   </span><br><span class=\"line\">   0x01402580  length: 128   </span><br><span class=\"line\">   0x01402600  length: 128   </span><br><span class=\"line\">   0x01402680  length: 128   </span><br><span class=\"line\">   0x01402700  length: 128   </span><br><span class=\"line\">   0x01402780  length: 128   </span><br><span class=\"line\">   0x01402800  length: 128   </span><br><span class=\"line\">   0x01402880  length: 128   </span><br><span class=\"line\">   0x01402900  length: 128   </span><br><span class=\"line\">   0x01402980  length: 128   </span><br><span class=\"line\">   0x01402a00  length: 128   </span><br><span class=\"line\">   0x01402a80  length: 128   </span><br><span class=\"line\">   0x01402b00  length: 128   </span><br><span class=\"line\">   0x01402b80  length: 128   </span><br><span class=\"line\">   0x01402c00  length: 128   </span><br><span class=\"line\">   0x01402c80  length: 128   </span><br><span class=\"line\">   0x01402d00  length: 128   </span><br><span class=\"line\">   0x01402d80  length: 128   </span><br><span class=\"line\">   0x01402e00  length: 128   </span><br><span class=\"line\">   0x01402e80  length: 128   </span><br><span class=\"line\">   0x01402f00  length: 128   </span><br><span class=\"line\">   0x01402f80  length: 128   </span><br><span class=\"line\">   0x01403000  length: 128   </span><br><span class=\"line\">   0x01403080  length: 128   </span><br><span class=\"line\">   0x01403100  length: 128   </span><br><span class=\"line\">   0x01403180  length: 128   </span><br><span class=\"line\">   0x01403200  length: 128   </span><br><span class=\"line\">   0x01403280  length: 128   </span><br><span class=\"line\"></span><br><span class=\"line\">  Auxillary Map</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   Extent 0     :  L1 dba:  0x01400080 Data dba:  0x01400084</span><br><span class=\"line\">   Extent 1     :  L1 dba:  0x01400100 Data dba:  0x01400102</span><br><span class=\"line\">   Extent 2     :  L1 dba:  0x01400180 Data dba:  0x01400182</span><br><span class=\"line\">   Extent 3     :  L1 dba:  0x01400200 Data dba:  0x01400202</span><br><span class=\"line\">   Extent 4     :  L1 dba:  0x01400280 Data dba:  0x01400282</span><br><span class=\"line\">   Extent 5     :  L1 dba:  0x01400300 Data dba:  0x01400302</span><br><span class=\"line\">   Extent 6     :  L1 dba:  0x01400380 Data dba:  0x01400382</span><br><span class=\"line\">   Extent 7     :  L1 dba:  0x01400400 Data dba:  0x01400402</span><br><span class=\"line\">   Extent 8     :  L1 dba:  0x01400480 Data dba:  0x01400482</span><br><span class=\"line\">   Extent 9     :  L1 dba:  0x01400500 Data dba:  0x01400502</span><br><span class=\"line\">   Extent 10    :  L1 dba:  0x01400580 Data dba:  0x01400582</span><br><span class=\"line\">   Extent 11    :  L1 dba:  0x01400600 Data dba:  0x01400602</span><br><span class=\"line\">   Extent 12    :  L1 dba:  0x01400680 Data dba:  0x01400682</span><br><span class=\"line\">   Extent 13    :  L1 dba:  0x01400700 Data dba:  0x01400702</span><br><span class=\"line\">   Extent 14    :  L1 dba:  0x01400780 Data dba:  0x01400782</span><br><span class=\"line\">   Extent 15    :  L1 dba:  0x01400800 Data dba:  0x01400802</span><br><span class=\"line\">   Extent 16    :  L1 dba:  0x01400880 Data dba:  0x01400882</span><br><span class=\"line\">   Extent 17    :  L1 dba:  0x01400900 Data dba:  0x01400902</span><br><span class=\"line\">   Extent 18    :  L1 dba:  0x01400980 Data dba:  0x01400982</span><br><span class=\"line\">   Extent 19    :  L1 dba:  0x01400a00 Data dba:  0x01400a02</span><br><span class=\"line\">   Extent 20    :  L1 dba:  0x01400a80 Data dba:  0x01400a82</span><br><span class=\"line\">   Extent 21    :  L1 dba:  0x01400b00 Data dba:  0x01400b02</span><br><span class=\"line\">   Extent 22    :  L1 dba:  0x01400b80 Data dba:  0x01400b82</span><br><span class=\"line\">   Extent 23    :  L1 dba:  0x01400c00 Data dba:  0x01400c02</span><br><span class=\"line\">   Extent 24    :  L1 dba:  0x01400c80 Data dba:  0x01400c82</span><br><span class=\"line\">   Extent 25    :  L1 dba:  0x01400d00 Data dba:  0x01400d02</span><br><span class=\"line\">   Extent 26    :  L1 dba:  0x01400d80 Data dba:  0x01400d82</span><br><span class=\"line\">   Extent 27    :  L1 dba:  0x01400e00 Data dba:  0x01400e02</span><br><span class=\"line\">   Extent 28    :  L1 dba:  0x01400e80 Data dba:  0x01400e82</span><br><span class=\"line\">   Extent 29    :  L1 dba:  0x01400f00 Data dba:  0x01400f02</span><br><span class=\"line\">   Extent 30    :  L1 dba:  0x01400f80 Data dba:  0x01400f82</span><br><span class=\"line\">   Extent 31    :  L1 dba:  0x01401000 Data dba:  0x01401002</span><br><span class=\"line\">   Extent 32    :  L1 dba:  0x01401080 Data dba:  0x01401082</span><br><span class=\"line\">   Extent 33    :  L1 dba:  0x01401100 Data dba:  0x01401102</span><br><span class=\"line\">   Extent 34    :  L1 dba:  0x01401180 Data dba:  0x01401182</span><br><span class=\"line\">   Extent 35    :  L1 dba:  0x01401200 Data dba:  0x01401202</span><br><span class=\"line\">   Extent 36    :  L1 dba:  0x01401280 Data dba:  0x01401282</span><br><span class=\"line\">   Extent 37    :  L1 dba:  0x01401300 Data dba:  0x01401302</span><br><span class=\"line\">   Extent 38    :  L1 dba:  0x01401380 Data dba:  0x01401382</span><br><span class=\"line\">   Extent 39    :  L1 dba:  0x01401400 Data dba:  0x01401402</span><br><span class=\"line\">   Extent 40    :  L1 dba:  0x01401480 Data dba:  0x01401482</span><br><span class=\"line\">   Extent 41    :  L1 dba:  0x01401500 Data dba:  0x01401502</span><br><span class=\"line\">   Extent 42    :  L1 dba:  0x01401580 Data dba:  0x01401582</span><br><span class=\"line\">   Extent 43    :  L1 dba:  0x01401600 Data dba:  0x01401602</span><br><span class=\"line\">   Extent 44    :  L1 dba:  0x01401680 Data dba:  0x01401682</span><br><span class=\"line\">   Extent 45    :  L1 dba:  0x01401700 Data dba:  0x01401702</span><br><span class=\"line\">   Extent 46    :  L1 dba:  0x01401780 Data dba:  0x01401782</span><br><span class=\"line\">   Extent 47    :  L1 dba:  0x01401800 Data dba:  0x01401802</span><br><span class=\"line\">   Extent 48    :  L1 dba:  0x01401880 Data dba:  0x01401882</span><br><span class=\"line\">   Extent 49    :  L1 dba:  0x01401900 Data dba:  0x01401902</span><br><span class=\"line\">   Extent 50    :  L1 dba:  0x01401980 Data dba:  0x01401982</span><br><span class=\"line\">   Extent 51    :  L1 dba:  0x01401a00 Data dba:  0x01401a02</span><br><span class=\"line\">   Extent 52    :  L1 dba:  0x01401a80 Data dba:  0x01401a82</span><br><span class=\"line\">   Extent 53    :  L1 dba:  0x01401b00 Data dba:  0x01401b02</span><br><span class=\"line\">   Extent 54    :  L1 dba:  0x01401b80 Data dba:  0x01401b82</span><br><span class=\"line\">   Extent 55    :  L1 dba:  0x01401c00 Data dba:  0x01401c02</span><br><span class=\"line\">   Extent 56    :  L1 dba:  0x01401c80 Data dba:  0x01401c82</span><br><span class=\"line\">   Extent 57    :  L1 dba:  0x01401d00 Data dba:  0x01401d02</span><br><span class=\"line\">   Extent 58    :  L1 dba:  0x01401d80 Data dba:  0x01401d82</span><br><span class=\"line\">   Extent 59    :  L1 dba:  0x01401e00 Data dba:  0x01401e02</span><br><span class=\"line\">   Extent 60    :  L1 dba:  0x01401e80 Data dba:  0x01401e82</span><br><span class=\"line\">   Extent 61    :  L1 dba:  0x01401f00 Data dba:  0x01401f02</span><br><span class=\"line\">   Extent 62    :  L1 dba:  0x01401f80 Data dba:  0x01401f82</span><br><span class=\"line\">   Extent 63    :  L1 dba:  0x01402000 Data dba:  0x01402001</span><br><span class=\"line\">   Extent 64    :  L1 dba:  0x01402000 Data dba:  0x01402080</span><br><span class=\"line\">   Extent 65    :  L1 dba:  0x01402100 Data dba:  0x01402101</span><br><span class=\"line\">   Extent 66    :  L1 dba:  0x01402100 Data dba:  0x01402180</span><br><span class=\"line\">   Extent 67    :  L1 dba:  0x01402200 Data dba:  0x01402201</span><br><span class=\"line\">   Extent 68    :  L1 dba:  0x01402200 Data dba:  0x01402280</span><br><span class=\"line\">   Extent 69    :  L1 dba:  0x01402300 Data dba:  0x01402301</span><br><span class=\"line\">   Extent 70    :  L1 dba:  0x01402300 Data dba:  0x01402380</span><br><span class=\"line\">   Extent 71    :  L1 dba:  0x01402400 Data dba:  0x01402401</span><br><span class=\"line\">   Extent 72    :  L1 dba:  0x01402400 Data dba:  0x01402480</span><br><span class=\"line\">   Extent 73    :  L1 dba:  0x01402500 Data dba:  0x01402501</span><br><span class=\"line\">   Extent 74    :  L1 dba:  0x01402500 Data dba:  0x01402580</span><br><span class=\"line\">   Extent 75    :  L1 dba:  0x01402600 Data dba:  0x01402601</span><br><span class=\"line\">   Extent 76    :  L1 dba:  0x01402600 Data dba:  0x01402680</span><br><span class=\"line\">   Extent 77    :  L1 dba:  0x01402700 Data dba:  0x01402701</span><br><span class=\"line\">   Extent 78    :  L1 dba:  0x01402700 Data dba:  0x01402780</span><br><span class=\"line\">   Extent 79    :  L1 dba:  0x01402800 Data dba:  0x01402801</span><br><span class=\"line\">   Extent 80    :  L1 dba:  0x01402800 Data dba:  0x01402880</span><br><span class=\"line\">   Extent 81    :  L1 dba:  0x01402900 Data dba:  0x01402901</span><br><span class=\"line\">   Extent 82    :  L1 dba:  0x01402900 Data dba:  0x01402980</span><br><span class=\"line\">   Extent 83    :  L1 dba:  0x01402a00 Data dba:  0x01402a01</span><br><span class=\"line\">   Extent 84    :  L1 dba:  0x01402a00 Data dba:  0x01402a80</span><br><span class=\"line\">   Extent 85    :  L1 dba:  0x01402b00 Data dba:  0x01402b01</span><br><span class=\"line\">   Extent 86    :  L1 dba:  0x01402b00 Data dba:  0x01402b80</span><br><span class=\"line\">   Extent 87    :  L1 dba:  0x01402c00 Data dba:  0x01402c01</span><br><span class=\"line\">   Extent 88    :  L1 dba:  0x01402c00 Data dba:  0x01402c80</span><br><span class=\"line\">   Extent 89    :  L1 dba:  0x01402d00 Data dba:  0x01402d01</span><br><span class=\"line\">   Extent 90    :  L1 dba:  0x01402d00 Data dba:  0x01402d80</span><br><span class=\"line\">   Extent 91    :  L1 dba:  0x01402e00 Data dba:  0x01402e01</span><br><span class=\"line\">   Extent 92    :  L1 dba:  0x01402e00 Data dba:  0x01402e80</span><br><span class=\"line\">   Extent 93    :  L1 dba:  0x01402f00 Data dba:  0x01402f01</span><br><span class=\"line\">   Extent 94    :  L1 dba:  0x01402f00 Data dba:  0x01402f80</span><br><span class=\"line\">   Extent 95    :  L1 dba:  0x01403000 Data dba:  0x01403001</span><br><span class=\"line\">   Extent 96    :  L1 dba:  0x01403000 Data dba:  0x01403080</span><br><span class=\"line\">   Extent 97    :  L1 dba:  0x01403100 Data dba:  0x01403101</span><br><span class=\"line\">   Extent 98    :  L1 dba:  0x01403100 Data dba:  0x01403180</span><br><span class=\"line\">   Extent 99    :  L1 dba:  0x01403200 Data dba:  0x01403201</span><br><span class=\"line\">   Extent 100   :  L1 dba:  0x01403200 Data dba:  0x01403280</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">   Second Level Bitmap block DBAs</span><br><span class=\"line\">   --------------------------------------------------------</span><br><span class=\"line\">   DBA 1:   0x01400082</span><br><span class=\"line\"></span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 131 maxblk 131</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这里我们主要看Auxillary Map，里面记录了每个区所属的L1，不难发现从第64个区开始，64、65两个区的L1相同，这说明什么，说明L1下面挂了整整两个区的数据块，验证一下，将0x01402000块dump出来之后的内容：</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">  01402000  十进制 》20979712</span><br><span class=\"line\">  SQL&gt; select dbms_utility.data_block_address_file(20979712) Rfile#,dbms_utility.data_block_address_block(20979712) \"Block#\" from dual;</span><br><span class=\"line\"></span><br><span class=\"line\">    RFILE<span class=\"comment\">#     Block#</span></span><br><span class=\"line\"><span class=\"comment\">---------- ----------</span></span><br><span class=\"line\">         5       8192</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">          DBA Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x01402000  Length: 128    Offset: 0      </span><br><span class=\"line\">   0x01402080  Length: 128    Offset: 128    </span><br><span class=\"line\"></span><br><span class=\"line\">   0:Metadata   1:unformatted   2:unformatted   3:unformatted</span><br><span class=\"line\">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class=\"line\">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class=\"line\">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class=\"line\">   16:unformatted   17:unformatted   18:unformatted   19:unformatted</span><br><span class=\"line\">   20:unformatted   21:unformatted   22:unformatted   23:unformatted</span><br><span class=\"line\">   24:unformatted   25:unformatted   26:unformatted   27:unformatted</span><br><span class=\"line\">   28:unformatted   29:unformatted   30:unformatted   31:unformatted</span><br><span class=\"line\">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class=\"line\">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class=\"line\">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class=\"line\">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class=\"line\">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class=\"line\">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class=\"line\">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class=\"line\">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class=\"line\">   64:unformatted   65:unformatted   66:unformatted   67:unformatted</span><br><span class=\"line\">   68:unformatted   69:unformatted   70:unformatted   71:unformatted</span><br><span class=\"line\">   72:unformatted   73:unformatted   74:unformatted   75:unformatted</span><br><span class=\"line\">   76:unformatted   77:unformatted   78:unformatted   79:unformatted</span><br><span class=\"line\">   80:unformatted   81:unformatted   82:unformatted   83:unformatted</span><br><span class=\"line\">   84:unformatted   85:unformatted   86:unformatted   87:unformatted</span><br><span class=\"line\">   88:unformatted   89:unformatted   90:unformatted   91:unformatted</span><br><span class=\"line\">   92:unformatted   93:unformatted   94:unformatted   95:unformatted</span><br><span class=\"line\">   96:unformatted   97:unformatted   98:unformatted   99:unformatted</span><br><span class=\"line\">   100:unformatted   101:unformatted   102:unformatted   103:unformatted</span><br><span class=\"line\">   104:unformatted   105:unformatted   106:unformatted   107:unformatted</span><br><span class=\"line\">   108:unformatted   109:unformatted   110:unformatted   111:unformatted</span><br><span class=\"line\">   112:unformatted   113:unformatted   114:unformatted   115:unformatted</span><br><span class=\"line\">   116:unformatted   117:unformatted   118:unformatted   119:unformatted</span><br><span class=\"line\">   120:unformatted   121:unformatted   122:unformatted   123:unformatted</span><br><span class=\"line\">   124:unformatted   125:unformatted   126:unformatted   127:unformatted</span><br><span class=\"line\">   128:unformatted   129:unformatted   130:unformatted   131:unformatted</span><br><span class=\"line\">   132:unformatted   133:unformatted   134:unformatted   135:unformatted</span><br><span class=\"line\">   136:unformatted   137:unformatted   138:unformatted   139:unformatted</span><br><span class=\"line\">   140:unformatted   141:unformatted   142:unformatted   143:unformatted</span><br><span class=\"line\">   144:unformatted   145:unformatted   146:unformatted   147:unformatted</span><br><span class=\"line\">   148:unformatted   149:unformatted   150:unformatted   151:unformatted</span><br><span class=\"line\">   152:unformatted   153:unformatted   154:unformatted   155:unformatted</span><br><span class=\"line\">   156:unformatted   157:unformatted   158:unformatted   159:unformatted</span><br><span class=\"line\">   160:unformatted   161:unformatted   162:unformatted   163:unformatted</span><br><span class=\"line\">   164:unformatted   165:unformatted   166:unformatted   167:unformatted</span><br><span class=\"line\">   168:unformatted   169:unformatted   170:unformatted   171:unformatted</span><br><span class=\"line\">   172:unformatted   173:unformatted   174:unformatted   175:unformatted</span><br><span class=\"line\">   176:unformatted   177:unformatted   178:unformatted   179:unformatted</span><br><span class=\"line\">   180:unformatted   181:unformatted   182:unformatted   183:unformatted</span><br><span class=\"line\">   184:unformatted   185:unformatted   186:unformatted   187:unformatted</span><br><span class=\"line\">   188:unformatted   189:unformatted   190:unformatted   191:unformatted</span><br><span class=\"line\">   192:unformatted   193:unformatted   194:unformatted   195:unformatted</span><br><span class=\"line\">   196:unformatted   197:unformatted   198:unformatted   199:unformatted</span><br><span class=\"line\">   200:unformatted   201:unformatted   202:unformatted   203:unformatted</span><br><span class=\"line\">   204:unformatted   205:unformatted   206:unformatted   207:unformatted</span><br><span class=\"line\">   208:unformatted   209:unformatted   210:unformatted   211:unformatted</span><br><span class=\"line\">   212:unformatted   213:unformatted   214:unformatted   215:unformatted</span><br><span class=\"line\">   216:unformatted   217:unformatted   218:unformatted   219:unformatted</span><br><span class=\"line\">   220:unformatted   221:unformatted   222:unformatted   223:unformatted</span><br><span class=\"line\">   224:unformatted   225:unformatted   226:unformatted   227:unformatted</span><br><span class=\"line\">   228:unformatted   229:unformatted   230:unformatted   231:unformatted</span><br><span class=\"line\">   232:unformatted   233:unformatted   234:unformatted   235:unformatted</span><br><span class=\"line\">   236:unformatted   237:unformatted   238:unformatted   239:unformatted</span><br><span class=\"line\">   240:unformatted   241:unformatted   242:unformatted   243:unformatted</span><br><span class=\"line\">   244:unformatted   245:unformatted   246:unformatted   247:unformatted</span><br><span class=\"line\">   248:unformatted   249:unformatted   250:unformatted   251:unformatted</span><br><span class=\"line\">   252:unformatted   253:unformatted   254:unformatted   255:unformatted</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 8192 maxblk 8192</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>256个块，2M 2个区，可见L1中块的数量会随着段大小的改变而做调整的，可以增大到1024个甚至更多，我在这里不去再做验证，将重点放在高水位上，根据我们之前观察到的现象，高水位在第二个L1的地一个块，也可说第一个L1的末端，那么现在的L1里有256个块，高水位是不是也会推进到这个L1的末端呢？很容易进行验证，将数据插满到这个L1的前几个块再去观察段头高水位的变化就行了，那么插多少条呢？再来计算一下，当前的L1是8192号块，前面一共63个区，每个区里面两个L1，加上第一个区里面的一个L2和L3，我们需要插满8192-63*2-2=8064</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">declare</span></span><br><span class=\"line\">i <span class=\"built_in\">number</span>;</span><br><span class=\"line\"><span class=\"keyword\">begin</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"number\">1.</span><span class=\"number\">.8064</span> <span class=\"keyword\">loop</span></span><br><span class=\"line\"><span class=\"keyword\">insert</span> <span class=\"keyword\">into</span> lp <span class=\"keyword\">values</span>(i,<span class=\"string\">'a'</span>,<span class=\"string\">'a'</span>,<span class=\"string\">'a'</span>,<span class=\"string\">'a'</span>);</span><br><span class=\"line\"><span class=\"keyword\">end</span> <span class=\"keyword\">loop</span>;</span><br><span class=\"line\"><span class=\"keyword\">end</span>;</span><br><span class=\"line\">/</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>观察62号区的第二个L1，第一个L1的地址是0x01401f80，那么第二个就是01401f81，5号文件8065号块，dump出来的结果</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">DBA Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x01401fc0  Length: 64     Offset: 0      </span><br><span class=\"line\"></span><br><span class=\"line\">   0:FULL   1:FULL   2:FULL   3:FULL</span><br><span class=\"line\">   4:FULL   5:FULL   6:FULL   7:FULL</span><br><span class=\"line\">   8:FULL   9:FULL   10:FULL   11:FULL</span><br><span class=\"line\">   12:FULL   13:FULL   14:FULL   15:FULL</span><br><span class=\"line\">   16:FULL   17:FULL   18:FULL   19:FULL</span><br><span class=\"line\">   20:FULL   21:FULL   22:FULL   23:FULL</span><br><span class=\"line\">   24:FULL   25:FULL   26:FULL   27:FULL</span><br><span class=\"line\">   28:FULL   29:FULL   30:FULL   31:FULL</span><br><span class=\"line\">   32:FULL   33:FULL   34:FULL   35:FULL</span><br><span class=\"line\">   36:FULL   37:FULL   38:FULL   39:FULL</span><br><span class=\"line\">   40:FULL   41:FULL   42:FULL   43:FULL</span><br><span class=\"line\">   44:FULL   45:FULL   46:FULL   47:FULL</span><br><span class=\"line\">   48:FULL   49:FULL   50:FULL   51:FULL</span><br><span class=\"line\">   52:FULL   53:FULL   54:FULL   55:FULL</span><br><span class=\"line\">   56:FULL   57:FULL   58:FULL   59:FULL</span><br><span class=\"line\">   60:FULL   61:FULL   62:FULL   63:FULL</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 8065 maxblk 8065</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>居然全满了？再看8192号L1呢</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">DBA Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x01402000  Length: 128    Offset: 0      </span><br><span class=\"line\">   0x01402080  Length: 128    Offset: 128    </span><br><span class=\"line\"></span><br><span class=\"line\">   0:Metadata   1:FULL   2:FULL   3:FULL</span><br><span class=\"line\">   4:FULL   5:FULL   6:FULL   7:FULL</span><br><span class=\"line\">   8:FULL   9:FULL   10:FULL   11:FULL</span><br><span class=\"line\">   12:FULL   13:FULL   14:FULL   15:FULL</span><br><span class=\"line\">   16:FULL   17:FULL   18:FULL   19:FULL</span><br><span class=\"line\">   20:FULL   21:FULL   22:FULL   23:FULL</span><br><span class=\"line\">   24:FULL   25:FULL   26:FULL   27:FULL</span><br><span class=\"line\">   28:FULL   29:FULL   30:FULL   31:FULL</span><br><span class=\"line\">   32:FULL   33:FULL   34:FULL   35:FULL</span><br><span class=\"line\">   36:FULL   37:FULL   38:FULL   39:FULL</span><br><span class=\"line\">   40:FULL   41:FULL   42:FULL   43:FULL</span><br><span class=\"line\">   44:FULL   45:FULL   46:FULL   47:FULL</span><br><span class=\"line\">   48:FULL   49:FULL   50:FULL   51:FULL</span><br><span class=\"line\">   52:FULL   53:FULL   54:FULL   55:FULL</span><br><span class=\"line\">   56:FULL   57:FULL   58:FULL   59:FULL</span><br><span class=\"line\">   60:FULL   61:FULL   62:FULL   63:FULL</span><br><span class=\"line\">   64:FULL   65:FULL   66:FULL   67:FULL</span><br><span class=\"line\">   68:FULL   69:FULL   70:FULL   71:FULL</span><br><span class=\"line\">   72:FULL   73:FULL   74:FULL   75:FULL</span><br><span class=\"line\">   76:FULL   77:FULL   78:FULL   79:FULL</span><br><span class=\"line\">   80:FULL   81:FULL   82:FULL   83:FULL</span><br><span class=\"line\">   84:FULL   85:FULL   86:FULL   87:FULL</span><br><span class=\"line\">   88:FULL   89:FULL   90:FULL   91:FULL</span><br><span class=\"line\">   92:FULL   93:FULL   94:FULL   95:FULL</span><br><span class=\"line\">   96:FULL   97:FULL   98:FULL   99:FULL</span><br><span class=\"line\">   100:FULL   101:FULL   102:FULL   103:FULL</span><br><span class=\"line\">   104:FULL   105:FULL   106:FULL   107:FULL</span><br><span class=\"line\">   108:FULL   109:FULL   110:FULL   111:FULL</span><br><span class=\"line\">   112:FULL   113:FULL   114:FULL   115:FULL</span><br><span class=\"line\">   116:FULL   117:FULL   118:FULL   119:FULL</span><br><span class=\"line\">   120:FULL   121:FULL   122:FULL   123:FULL</span><br><span class=\"line\">   124:FULL   125:FULL   126:FULL   127:FULL</span><br><span class=\"line\">   128:unformatted   129:unformatted   130:unformatted   131:unformatted</span><br><span class=\"line\">   132:unformatted   133:unformatted   134:unformatted   135:unformatted</span><br><span class=\"line\">   136:unformatted   137:unformatted   138:unformatted   139:unformatted</span><br><span class=\"line\">   140:unformatted   141:unformatted   142:unformatted   143:unformatted</span><br><span class=\"line\">   144:75-100% free   145:75-100% free   146:75-100% free   147:75-100% free</span><br><span class=\"line\">   148:75-100% free   149:75-100% free   150:75-100% free   151:75-100% free</span><br><span class=\"line\">   152:75-100% free   153:75-100% free   154:75-100% free   155:FULL</span><br><span class=\"line\">   156:75-100% free   157:75-100% free   158:75-100% free   159:75-100% free</span><br><span class=\"line\">   160:75-100% free   161:75-100% free   162:75-100% free   163:FULL</span><br><span class=\"line\">   164:75-100% free   165:75-100% free   166:75-100% free   167:75-100% free</span><br><span class=\"line\">   168:75-100% free   169:75-100% free   170:75-100% free   171:75-100% free</span><br><span class=\"line\">   172:75-100% free   173:75-100% free   174:75-100% free   175:75-100% free</span><br><span class=\"line\">   176:unformatted   177:unformatted   178:unformatted   179:unformatted</span><br><span class=\"line\">   180:unformatted   181:unformatted   182:unformatted   183:unformatted</span><br><span class=\"line\">   184:unformatted   185:unformatted   186:unformatted   187:unformatted</span><br><span class=\"line\">   188:unformatted   189:unformatted   190:unformatted   191:unformatted</span><br><span class=\"line\">   192:unformatted   193:unformatted   194:unformatted   195:unformatted</span><br><span class=\"line\">   196:unformatted   197:unformatted   198:unformatted   199:unformatted</span><br><span class=\"line\">   200:unformatted   201:unformatted   202:unformatted   203:unformatted</span><br><span class=\"line\">   204:unformatted   205:unformatted   206:unformatted   207:unformatted</span><br><span class=\"line\">   208:unformatted   209:unformatted   210:unformatted   211:unformatted</span><br><span class=\"line\">   212:unformatted   213:unformatted   214:unformatted   215:unformatted</span><br><span class=\"line\">   216:unformatted   217:unformatted   218:unformatted   219:unformatted</span><br><span class=\"line\">   220:unformatted   221:unformatted   222:unformatted   223:unformatted</span><br><span class=\"line\">   224:unformatted   225:unformatted   226:unformatted   227:unformatted</span><br><span class=\"line\">   228:unformatted   229:unformatted   230:unformatted   231:unformatted</span><br><span class=\"line\">   232:unformatted   233:unformatted   234:unformatted   235:unformatted</span><br><span class=\"line\">   236:unformatted   237:unformatted   238:unformatted   239:unformatted</span><br><span class=\"line\">   240:unformatted   241:unformatted   242:unformatted   243:unformatted</span><br><span class=\"line\">   244:unformatted   245:unformatted   246:unformatted   247:unformatted</span><br><span class=\"line\">   248:unformatted   249:unformatted   250:unformatted   251:unformatted</span><br><span class=\"line\">   252:unformatted   253:unformatted   254:unformatted   255:unformatted</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 8192 maxblk 8192</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>完蛋了，计算错误，L1下面的第二个区也已经被格式化了，看段头信息</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Extent Control Header</span><br><span class=\"line\">  -----------------------------------------------------------------</span><br><span class=\"line\">  Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928</span><br><span class=\"line\">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class=\"line\">      Highwater::  0x01402100  ext#: 64     blk#: 128    ext size: 128   </span><br><span class=\"line\">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class=\"line\">  #blocks below: 8191  </span><br><span class=\"line\">  mapblk  0x00000000  offset: 64</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>果然高水位指到了第66个区的L1块地址，这会影响我们的判断，到底哪里出问题了呢？观察8192号块内容是后128个块里被插入了2条，前128个块全满，也就是说我多插了130个块，后来猛然醒悟，我使用DBA来计算的，忘记减去128个块的文件头了，这么一算结果相查差还是不大的，太马虎了，要不是因为马虎哥也能上清华北大了；然后该怎么办呢？重新来过？不用！既然这个L1推过头了，索性把它堆满，然后我们去观察下一个L1，这下就好计算了；</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">declare</span></span><br><span class=\"line\">i <span class=\"built_in\">number</span>;</span><br><span class=\"line\"><span class=\"keyword\">begin</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"number\">1.</span><span class=\"number\">.126</span> <span class=\"keyword\">loop</span></span><br><span class=\"line\"><span class=\"keyword\">insert</span> <span class=\"keyword\">into</span> lp <span class=\"keyword\">values</span>(i,<span class=\"string\">'a'</span>,<span class=\"string\">'a'</span>,<span class=\"string\">'a'</span>,<span class=\"string\">'a'</span>);</span><br><span class=\"line\"><span class=\"keyword\">end</span> <span class=\"keyword\">loop</span>;</span><br><span class=\"line\"><span class=\"keyword\">end</span>;</span><br><span class=\"line\">/</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>观察8192号块</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\"> DBA Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x01402000  Length: 128    Offset: 0      </span><br><span class=\"line\">   0x01402080  Length: 128    Offset: 128    </span><br><span class=\"line\"></span><br><span class=\"line\">   0:Metadata   1:FULL   2:FULL   3:FULL</span><br><span class=\"line\">   4:FULL   5:FULL   6:FULL   7:FULL</span><br><span class=\"line\">   8:FULL   9:FULL   10:FULL   11:FULL</span><br><span class=\"line\">   12:FULL   13:FULL   14:FULL   15:FULL</span><br><span class=\"line\">   16:FULL   17:FULL   18:FULL   19:FULL</span><br><span class=\"line\">   20:FULL   21:FULL   22:FULL   23:FULL</span><br><span class=\"line\">   24:FULL   25:FULL   26:FULL   27:FULL</span><br><span class=\"line\">   28:FULL   29:FULL   30:FULL   31:FULL</span><br><span class=\"line\">   32:FULL   33:FULL   34:FULL   35:FULL</span><br><span class=\"line\">   36:FULL   37:FULL   38:FULL   39:FULL</span><br><span class=\"line\">   40:FULL   41:FULL   42:FULL   43:FULL</span><br><span class=\"line\">   44:FULL   45:FULL   46:FULL   47:FULL</span><br><span class=\"line\">   48:FULL   49:FULL   50:FULL   51:FULL</span><br><span class=\"line\">   52:FULL   53:FULL   54:FULL   55:FULL</span><br><span class=\"line\">   56:FULL   57:FULL   58:FULL   59:FULL</span><br><span class=\"line\">   60:FULL   61:FULL   62:FULL   63:FULL</span><br><span class=\"line\">   64:FULL   65:FULL   66:FULL   67:FULL</span><br><span class=\"line\">   68:FULL   69:FULL   70:FULL   71:FULL</span><br><span class=\"line\">   72:FULL   73:FULL   74:FULL   75:FULL</span><br><span class=\"line\">   76:FULL   77:FULL   78:FULL   79:FULL</span><br><span class=\"line\">   80:FULL   81:FULL   82:FULL   83:FULL</span><br><span class=\"line\">   84:FULL   85:FULL   86:FULL   87:FULL</span><br><span class=\"line\">   88:FULL   89:FULL   90:FULL   91:FULL</span><br><span class=\"line\">   92:FULL   93:FULL   94:FULL   95:FULL</span><br><span class=\"line\">   96:FULL   97:FULL   98:FULL   99:FULL</span><br><span class=\"line\">   100:FULL   101:FULL   102:FULL   103:FULL</span><br><span class=\"line\">   104:FULL   105:FULL   106:FULL   107:FULL</span><br><span class=\"line\">   108:FULL   109:FULL   110:FULL   111:FULL</span><br><span class=\"line\">   112:FULL   113:FULL   114:FULL   115:FULL</span><br><span class=\"line\">   116:FULL   117:FULL   118:FULL   119:FULL</span><br><span class=\"line\">   120:FULL   121:FULL   122:FULL   123:FULL</span><br><span class=\"line\">   124:FULL   125:FULL   126:FULL   127:FULL</span><br><span class=\"line\">   128:FULL   129:FULL   130:FULL   131:FULL</span><br><span class=\"line\">   132:FULL   133:FULL   134:FULL   135:FULL</span><br><span class=\"line\">   136:FULL   137:FULL   138:FULL   139:FULL</span><br><span class=\"line\">   140:FULL   141:FULL   142:FULL   143:FULL</span><br><span class=\"line\">   144:FULL   145:FULL   146:FULL   147:FULL</span><br><span class=\"line\">   148:FULL   149:FULL   150:FULL   151:FULL</span><br><span class=\"line\">   152:FULL   153:FULL   154:FULL   155:FULL</span><br><span class=\"line\">   156:FULL   157:FULL   158:FULL   159:FULL</span><br><span class=\"line\">   160:FULL   161:FULL   162:FULL   163:FULL</span><br><span class=\"line\">   164:FULL   165:FULL   166:FULL   167:FULL</span><br><span class=\"line\">   168:FULL   169:FULL   170:FULL   171:FULL</span><br><span class=\"line\">   172:FULL   173:FULL   174:FULL   175:FULL</span><br><span class=\"line\">   176:FULL   177:FULL   178:FULL   179:FULL</span><br><span class=\"line\">   180:FULL   181:FULL   182:FULL   183:FULL</span><br><span class=\"line\">   184:FULL   185:FULL   186:FULL   187:FULL</span><br><span class=\"line\">   188:FULL   189:FULL   190:FULL   191:FULL</span><br><span class=\"line\">   192:FULL   193:FULL   194:FULL   195:FULL</span><br><span class=\"line\">   196:FULL   197:FULL   198:FULL   199:FULL</span><br><span class=\"line\">   200:FULL   201:FULL   202:FULL   203:FULL</span><br><span class=\"line\">   204:FULL   205:FULL   206:FULL   207:FULL</span><br><span class=\"line\">   208:FULL   209:FULL   210:FULL   211:FULL</span><br><span class=\"line\">   212:FULL   213:FULL   214:FULL   215:FULL</span><br><span class=\"line\">   216:FULL   217:FULL   218:FULL   219:FULL</span><br><span class=\"line\">   220:FULL   221:FULL   222:FULL   223:FULL</span><br><span class=\"line\">   224:FULL   225:FULL   226:FULL   227:FULL</span><br><span class=\"line\">   228:FULL   229:FULL   230:FULL   231:FULL</span><br><span class=\"line\">   232:FULL   233:FULL   234:FULL   235:FULL</span><br><span class=\"line\">   236:FULL   237:FULL   238:FULL   239:FULL</span><br><span class=\"line\">   240:FULL   241:FULL   242:FULL   243:FULL</span><br><span class=\"line\">   244:FULL   245:FULL   246:FULL   247:FULL</span><br><span class=\"line\">   248:FULL   249:FULL   250:FULL   251:FULL</span><br><span class=\"line\">   252:FULL   253:FULL   254:FULL   255:FULL</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 8192 maxblk 8192</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>已经全满了，这个时候我们再去看一下段头的高水位</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Extent Control Header</span><br><span class=\"line\"> -----------------------------------------------------------------</span><br><span class=\"line\"> Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928</span><br><span class=\"line\">                 last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class=\"line\">     Highwater::  0x01402100  ext#: 64     blk#: 128    ext size: 128   </span><br><span class=\"line\"> #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class=\"line\"> #blocks below: 8191  </span><br><span class=\"line\"> mapblk  0x00000000  offset: 64</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>没有动，看来oracle也是事不到眼前不知道着急啊，来看一看下一个L1</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select dbms_utility.data_block_address_file(to_number('01402100', 'xxxxxxxx')) file#,</span><br><span class=\"line\">  2 dbms_utility.data_block_address_block(to_number('01402100', 'xxxxxxxx')) block<span class=\"comment\">#</span></span><br><span class=\"line\">  3 from dual;</span><br><span class=\"line\"></span><br><span class=\"line\">     FILE<span class=\"comment\"># BLOCK#</span></span><br><span class=\"line\"><span class=\"comment\">---------- ----------</span></span><br><span class=\"line\">         5 8448</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这个L1是5号文件8448号块，dump出来</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\"> DBA Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x01402100  Length: 128    Offset: 0      </span><br><span class=\"line\">   0x01402180  Length: 128    Offset: 128    </span><br><span class=\"line\"></span><br><span class=\"line\">   0:Metadata   1:unformatted   2:unformatted   3:unformatted</span><br><span class=\"line\">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class=\"line\">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class=\"line\">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class=\"line\">   16:unformatted   17:unformatted   18:unformatted   19:unformatted</span><br><span class=\"line\">   20:unformatted   21:unformatted   22:unformatted   23:unformatted</span><br><span class=\"line\">   24:unformatted   25:unformatted   26:unformatted   27:unformatted</span><br><span class=\"line\">   28:unformatted   29:unformatted   30:unformatted   31:unformatted</span><br><span class=\"line\">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class=\"line\">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class=\"line\">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class=\"line\">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class=\"line\">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class=\"line\">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class=\"line\">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class=\"line\">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class=\"line\">   64:unformatted   65:unformatted   66:unformatted   67:unformatted</span><br><span class=\"line\">   68:unformatted   69:unformatted   70:unformatted   71:unformatted</span><br><span class=\"line\">   72:unformatted   73:unformatted   74:unformatted   75:unformatted</span><br><span class=\"line\">   76:unformatted   77:unformatted   78:unformatted   79:unformatted</span><br><span class=\"line\">   80:unformatted   81:unformatted   82:unformatted   83:unformatted</span><br><span class=\"line\">   84:unformatted   85:unformatted   86:unformatted   87:unformatted</span><br><span class=\"line\">   88:unformatted   89:unformatted   90:unformatted   91:unformatted</span><br><span class=\"line\">   92:unformatted   93:unformatted   94:unformatted   95:unformatted</span><br><span class=\"line\">   96:unformatted   97:unformatted   98:unformatted   99:unformatted</span><br><span class=\"line\">   100:unformatted   101:unformatted   102:unformatted   103:unformatted</span><br><span class=\"line\">   104:unformatted   105:unformatted   106:unformatted   107:unformatted</span><br><span class=\"line\">   108:unformatted   109:unformatted   110:unformatted   111:unformatted</span><br><span class=\"line\">   112:unformatted   113:unformatted   114:unformatted   115:unformatted</span><br><span class=\"line\">   116:unformatted   117:unformatted   118:unformatted   119:unformatted</span><br><span class=\"line\">   120:unformatted   121:unformatted   122:unformatted   123:unformatted</span><br><span class=\"line\">   124:unformatted   125:unformatted   126:unformatted   127:unformatted</span><br><span class=\"line\">   128:unformatted   129:unformatted   130:unformatted   131:unformatted</span><br><span class=\"line\">   132:unformatted   133:unformatted   134:unformatted   135:unformatted</span><br><span class=\"line\">   136:unformatted   137:unformatted   138:unformatted   139:unformatted</span><br><span class=\"line\">   140:unformatted   141:unformatted   142:unformatted   143:unformatted</span><br><span class=\"line\">   144:unformatted   145:unformatted   146:unformatted   147:unformatted</span><br><span class=\"line\">   148:unformatted   149:unformatted   150:unformatted   151:unformatted</span><br><span class=\"line\">   152:unformatted   153:unformatted   154:unformatted   155:unformatted</span><br><span class=\"line\">   156:unformatted   157:unformatted   158:unformatted   159:unformatted</span><br><span class=\"line\">   160:unformatted   161:unformatted   162:unformatted   163:unformatted</span><br><span class=\"line\">   164:unformatted   165:unformatted   166:unformatted   167:unformatted</span><br><span class=\"line\">   168:unformatted   169:unformatted   170:unformatted   171:unformatted</span><br><span class=\"line\">   172:unformatted   173:unformatted   174:unformatted   175:unformatted</span><br><span class=\"line\">   176:unformatted   177:unformatted   178:unformatted   179:unformatted</span><br><span class=\"line\">   180:unformatted   181:unformatted   182:unformatted   183:unformatted</span><br><span class=\"line\">   184:unformatted   185:unformatted   186:unformatted   187:unformatted</span><br><span class=\"line\">   188:unformatted   189:unformatted   190:unformatted   191:unformatted</span><br><span class=\"line\">   192:unformatted   193:unformatted   194:unformatted   195:unformatted</span><br><span class=\"line\">   196:unformatted   197:unformatted   198:unformatted   199:unformatted</span><br><span class=\"line\">   200:unformatted   201:unformatted   202:unformatted   203:unformatted</span><br><span class=\"line\">   204:unformatted   205:unformatted   206:unformatted   207:unformatted</span><br><span class=\"line\">   208:unformatted   209:unformatted   210:unformatted   211:unformatted</span><br><span class=\"line\">   212:unformatted   213:unformatted   214:unformatted   215:unformatted</span><br><span class=\"line\">   216:unformatted   217:unformatted   218:unformatted   219:unformatted</span><br><span class=\"line\">   220:unformatted   221:unformatted   222:unformatted   223:unformatted</span><br><span class=\"line\">   224:unformatted   225:unformatted   226:unformatted   227:unformatted</span><br><span class=\"line\">   228:unformatted   229:unformatted   230:unformatted   231:unformatted</span><br><span class=\"line\">   232:unformatted   233:unformatted   234:unformatted   235:unformatted</span><br><span class=\"line\">   236:unformatted   237:unformatted   238:unformatted   239:unformatted</span><br><span class=\"line\">   240:unformatted   241:unformatted   242:unformatted   243:unformatted</span><br><span class=\"line\">   244:unformatted   245:unformatted   246:unformatted   247:unformatted</span><br><span class=\"line\">   248:unformatted   249:unformatted   250:unformatted   251:unformatted</span><br><span class=\"line\">   252:unformatted   253:unformatted   254:unformatted   255:unformatted</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 8448 maxblk 8448</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>256个块，除了第一个是L1元数据之外，没有一个格式化的，这就达到了我们的目的，我现在要插入一条数据，迫使高水位推动，猜一下高水位会在哪？在L1管理的最后一个块后面么？<br>看插入一行数据之后的8448号块</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">DBA Ranges :</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">   0x01402100  Length: 128    Offset: 0      </span><br><span class=\"line\">   0x01402180  Length: 128    Offset: 128    </span><br><span class=\"line\"></span><br><span class=\"line\">   0:Metadata   1:unformatted   2:unformatted   3:unformatted</span><br><span class=\"line\">   4:unformatted   5:unformatted   6:unformatted   7:unformatted</span><br><span class=\"line\">   8:unformatted   9:unformatted   10:unformatted   11:unformatted</span><br><span class=\"line\">   12:unformatted   13:unformatted   14:unformatted   15:unformatted</span><br><span class=\"line\">   16:75-100% free   17:75-100% free   18:75-100% free   19:75-100% free</span><br><span class=\"line\">   20:75-100% free   21:75-100% free   22:75-100% free   23:75-100% free</span><br><span class=\"line\">   24:75-100% free   25:75-100% free   26:75-100% free   27:75-100% free</span><br><span class=\"line\">   28:FULL   29:75-100% free   30:75-100% free   31:75-100% free</span><br><span class=\"line\">   32:unformatted   33:unformatted   34:unformatted   35:unformatted</span><br><span class=\"line\">   36:unformatted   37:unformatted   38:unformatted   39:unformatted</span><br><span class=\"line\">   40:unformatted   41:unformatted   42:unformatted   43:unformatted</span><br><span class=\"line\">   44:unformatted   45:unformatted   46:unformatted   47:unformatted</span><br><span class=\"line\">   48:unformatted   49:unformatted   50:unformatted   51:unformatted</span><br><span class=\"line\">   52:unformatted   53:unformatted   54:unformatted   55:unformatted</span><br><span class=\"line\">   56:unformatted   57:unformatted   58:unformatted   59:unformatted</span><br><span class=\"line\">   60:unformatted   61:unformatted   62:unformatted   63:unformatted</span><br><span class=\"line\">   64:unformatted   65:unformatted   66:unformatted   67:unformatted</span><br><span class=\"line\">   68:unformatted   69:unformatted   70:unformatted   71:unformatted</span><br><span class=\"line\">   72:unformatted   73:unformatted   74:unformatted   75:unformatted</span><br><span class=\"line\">   76:unformatted   77:unformatted   78:unformatted   79:unformatted</span><br><span class=\"line\">   80:unformatted   81:unformatted   82:unformatted   83:unformatted</span><br><span class=\"line\">   84:unformatted   85:unformatted   86:unformatted   87:unformatted</span><br><span class=\"line\">   88:unformatted   89:unformatted   90:unformatted   91:unformatted</span><br><span class=\"line\">   92:unformatted   93:unformatted   94:unformatted   95:unformatted</span><br><span class=\"line\">   96:unformatted   97:unformatted   98:unformatted   99:unformatted</span><br><span class=\"line\">   100:unformatted   101:unformatted   102:unformatted   103:unformatted</span><br><span class=\"line\">   104:unformatted   105:unformatted   106:unformatted   107:unformatted</span><br><span class=\"line\">   108:unformatted   109:unformatted   110:unformatted   111:unformatted</span><br><span class=\"line\">   112:unformatted   113:unformatted   114:unformatted   115:unformatted</span><br><span class=\"line\">   116:unformatted   117:unformatted   118:unformatted   119:unformatted</span><br><span class=\"line\">   120:unformatted   121:unformatted   122:unformatted   123:unformatted</span><br><span class=\"line\">   124:unformatted   125:unformatted   126:unformatted   127:unformatted</span><br><span class=\"line\">   128:unformatted   129:unformatted   130:unformatted   131:unformatted</span><br><span class=\"line\">   132:unformatted   133:unformatted   134:unformatted   135:unformatted</span><br><span class=\"line\">   136:unformatted   137:unformatted   138:unformatted   139:unformatted</span><br><span class=\"line\">   140:unformatted   141:unformatted   142:unformatted   143:unformatted</span><br><span class=\"line\">   144:unformatted   145:unformatted   146:unformatted   147:unformatted</span><br><span class=\"line\">   148:unformatted   149:unformatted   150:unformatted   151:unformatted</span><br><span class=\"line\">   152:unformatted   153:unformatted   154:unformatted   155:unformatted</span><br><span class=\"line\">   156:unformatted   157:unformatted   158:unformatted   159:unformatted</span><br><span class=\"line\">   160:unformatted   161:unformatted   162:unformatted   163:unformatted</span><br><span class=\"line\">   164:unformatted   165:unformatted   166:unformatted   167:unformatted</span><br><span class=\"line\">   168:unformatted   169:unformatted   170:unformatted   171:unformatted</span><br><span class=\"line\">   172:unformatted   173:unformatted   174:unformatted   175:unformatted</span><br><span class=\"line\">   176:unformatted   177:unformatted   178:unformatted   179:unformatted</span><br><span class=\"line\">   180:unformatted   181:unformatted   182:unformatted   183:unformatted</span><br><span class=\"line\">   184:unformatted   185:unformatted   186:unformatted   187:unformatted</span><br><span class=\"line\">   188:unformatted   189:unformatted   190:unformatted   191:unformatted</span><br><span class=\"line\">   192:unformatted   193:unformatted   194:unformatted   195:unformatted</span><br><span class=\"line\">   196:unformatted   197:unformatted   198:unformatted   199:unformatted</span><br><span class=\"line\">   200:unformatted   201:unformatted   202:unformatted   203:unformatted</span><br><span class=\"line\">   204:unformatted   205:unformatted   206:unformatted   207:unformatted</span><br><span class=\"line\">   208:unformatted   209:unformatted   210:unformatted   211:unformatted</span><br><span class=\"line\">   212:unformatted   213:unformatted   214:unformatted   215:unformatted</span><br><span class=\"line\">   216:unformatted   217:unformatted   218:unformatted   219:unformatted</span><br><span class=\"line\">   220:unformatted   221:unformatted   222:unformatted   223:unformatted</span><br><span class=\"line\">   224:unformatted   225:unformatted   226:unformatted   227:unformatted</span><br><span class=\"line\">   228:unformatted   229:unformatted   230:unformatted   231:unformatted</span><br><span class=\"line\">   232:unformatted   233:unformatted   234:unformatted   235:unformatted</span><br><span class=\"line\">   236:unformatted   237:unformatted   238:unformatted   239:unformatted</span><br><span class=\"line\">   240:unformatted   241:unformatted   242:unformatted   243:unformatted</span><br><span class=\"line\">   244:unformatted   245:unformatted   246:unformatted   247:unformatted</span><br><span class=\"line\">   248:unformatted   249:unformatted   250:unformatted   251:unformatted</span><br><span class=\"line\">   252:unformatted   253:unformatted   254:unformatted   255:unformatted</span><br><span class=\"line\">  --------------------------------------------------------</span><br><span class=\"line\">End dump data blocks tsn: 8 file#: 5 minblk 8448 maxblk 8448</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>有一个块已经满了，揭晓答案的时候来了，dump出段头</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Extent Control Header</span><br><span class=\"line\">  -----------------------------------------------------------------</span><br><span class=\"line\">  Extent Header:: spare1: 0      spare2: 0      #extents: 101    #blocks: 12928</span><br><span class=\"line\">                  last map  0x00000000  #maps: 0      offset: 2716  </span><br><span class=\"line\">      Highwater::  0x01402180  ext#: 65     blk#: 128    ext size: 128   </span><br><span class=\"line\">  #blocks in seg. hdr&apos;s freelists: 0     </span><br><span class=\"line\">  #blocks below: 8318  </span><br><span class=\"line\">  mapblk  0x00000000  offset: 65</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>高水位是0x01402180，这个地址在哪呢？0x01402180比0x01402100多了十六进制80个块，就是十进制的128个块，仅仅是推动了一个区的大小，并不是一个L1的大小，这说明常规路径下插入高水位的推动是以L1和区中小的那个单位来推动的，就是L1小就推动L1里面所有块的大小，区小就推动一个区的大小，可见所谓的高并发并非像宣传的那样，还是受高水位的限制的，这个时候的区块大概像下面这个样子：</p>\n</blockquote>\n<p><img alt data-src=\"http://oaowhilvu.bkt.clouddn.com/%E6%89%A9%E5%B1%95%E7%9A%84L1.png\"></p>\n<blockquote>\n<p>开几个session做下插入试试</p>\n</blockquote>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; select dbms_rowid.ROWID_RELATIVE_FNO(rowid),dbms_rowid.ROWID_BLOCK_NUMBER(rowid) from lp where trim(des1)='b';</span><br><span class=\"line\"></span><br><span class=\"line\">                                   5                                 8474</span><br><span class=\"line\">                                   5                                 8482</span><br><span class=\"line\">                                   5                                 8484</span><br><span class=\"line\">                                   5                                 8488</span><br><span class=\"line\">                                   5                                 8489</span><br><span class=\"line\">                                   5                                 8490</span><br><span class=\"line\">                                   5                                 8491</span><br><span class=\"line\">                                   5                                 8492</span><br><span class=\"line\">                                   5                                 8493</span><br><span class=\"line\">                                   5                                 8494</span><br><span class=\"line\">                                   5                                 8495</span><br><span class=\"line\">                                   5                                 8496</span><br><span class=\"line\">                                   5                                 8498</span><br><span class=\"line\">                                   5                                 8500</span><br><span class=\"line\">                                   5                                 8504</span><br><span class=\"line\">                                   5                                 8506</span><br><span class=\"line\">                                   5                                 8512</span><br><span class=\"line\">                                   5                                 8514</span><br><span class=\"line\">                                   5                                 8520</span><br><span class=\"line\">                                   5                                 8522</span><br><span class=\"line\"></span><br><span class=\"line\">20 rows selected.</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>全部是在高水位之下<br>这个实验有一点值得思考，就是PCTFREE如何设置，在插入删除频繁的段，PCTFREE的值应该要远离三个百分比线，就是25%/50%/75%，避免频繁插入删除的时候块状态频繁改变，由full变为非full，如此就会修改L1块的内容，有可能造成buffer busy waits。<br>而大家熟知的直接路径下的插入是直接在高水位之上插入并且绕过cache buffer的，这种情况下的高水位是如何推动的呢？我们再慢慢分析.</p>\n</blockquote>\n"},{"title":"enq之TM-contention解决之道——外键无索引导致锁争用（上）","date":"2016-07-25T08:21:00.000Z","_content":"\n近日，开发负责人反映某生产环境业务处理缓慢，主要业务操作就是修改会员信息，登录查询后发现大量的session正在等待enq: TM - contention，且waiting的语句几乎都是update\nsession的即时信息没有保留，现在附上ash视图的一些统计信息，可以大概了解一下当时争用的场景\n\n```sql\nSQL> @ash_wait_chains.sql username||':'||program2||event2 session_type='FOREGROUND' sysdate-6/24 sysdate-5/24\n\n-- Display ASH Wait Chain Signatures script v0.2 BETA by Tanel Poder ( http://blog.tanelpoder.com )\n\n%This     SECONDS        AAS\n------ ---------- ----------\nWAIT_CHAIN\n------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n  72%       20073        5.6\n-> JSCHPROD:(JDBC Thin Client) ON CPU\n\n   8%        2293         .6\n-> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) ON CPU\n\n   8%        2141         .6\n-> JSCHPROD:(JDBC Thin Client) log file sync  -> SYS:(LGWR) log file parallel write\n\n   7%        1879         .5\n-> JSCHPROD:(JDBC Thin Client) log file sync  -> SYS:(LGWR) LGWR-LNS wait on channel\n\n   2%         654         .2\n-> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) ON CPU\n\n   1%         288         .1\n-> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) ON CPU\n\n   1%         149          0\n-> JSCHPROD:(JDBC Thin Client) log file sync  -> SYS:(LGWR) ON CPU\n\n   0%         128          0\n-> JSCHPROD:(JDBC Thin Client) enq: TM - contention\n\n   0%         112          0\n-> JSCHPROD:(JDBC Thin Client) log file sync\n\n   0%          86          0\n-> JSCHPROD:(JDBC Thin Client) db file scattered read\n\n   0%          43          0\n-> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) ON CPU\n\n   0%          37          0\n-> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) enq: TM - contention\n\n   0%          25          0\n-> JSCHPROD:(JDBC Thin Client) log file sync  -> SYS:(LGWR) LGWR wait on LNS\n\n   0%          13          0\n-> JSCHPROD:(plsqldev.exe) ON CPU\n\n   0%          11          0\n-> SYS:(plsqldev.exe) ON CPU\n\n   0%          10          0\n-> JSCHPROD:(JDBC Thin Client) SQL*Net more data from client\n\n   0%           9          0\n-> JSCHPROD:(JDBC Thin Client) db file sequential read\n\n   0%           9          0\n-> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) ON\nCPU\n\n   0%           6          0\n-> JSCHPROD:(JDBC Thin Client) read by other session  -> JSCHPROD:(JDBC Thin Client) ON CPU\n\n   0%           4          0\n-> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) enq: TM - contention\n\n   0%           3          0\n-> JSCHPROD:(JDBC Thin Client) SQL*Net more data to client\n\n   0%           3          0\n-> JSCHPROD:(JDBC Thin Client) buffer busy waits [data block]\n\n   0%           3          0\n-> SYS:(oraagent.bin) Disk file operations I/O\n\n   0%           3          0\n-> JSCHPROD:(JDBC Thin Client) log file sync  -> SYS:(LGWR) LGWR wait for redo copy\n\n   0%           2          0\n-> JSCHPROD:(JDBC Thin Client) enq: TX - row lock contention\n\n   0%           2          0\n-> JSCHPROD:(JDBC Thin Client) log file sync  -> SYS:(LGWR) LGWR wait for redo copy  -> JSCHPROD:(JDBC Thin Client) ON CPU\n\n   0%           2          0\n-> JSCHPROD:(JDBC Thin Client) enq: TX - index contention  -> JSCHPROD:(JDBC Thin Client) ON CPU\n\n   0%           1          0\n-> JSCHPROD:(plsqldev.exe) log file sync  -> SYS:(LGWR) log file parallel write\n\n   0%           1          0\n-> SYS:(plsqldev.exe) Disk file operations I/O\n\n   0%           1          0\n-> JSCHPROD:(JDBC Thin Client) enq: TX - row lock contention  -> JSCHPROD:(JDBC Thin Client) ON CPU\n\n\n30 rows selected.\n\n```\n\n可以看到，TM锁的争用很多，再看一份当时awr报告的top10\n\n![](https://liupzminblog.files.wordpress.com/2016/12/qq20161218-02x.png)\n\n虽然占DBTIME不多，但本来是很快的操作，短时间内给人的感觉就是业务处理缓慢\n查一下当时等待事件的p1,p2,p3的值\n\n```sql\nselect ash.SAMPLE_TIME,\n       ash.EVENT,\n       ash.SESSION_ID,\n       ash.BLOCKING_SESSION,\n       ash.P1TEXT,\n       ash.P1,\n       ash.P2TEXT,\n       ash.p2,\n       ash.p3text,\n       ash.p3,\n       ash.SESSION_STATE,\n       ash.SQL_OPNAME,\n       ash.SQL_ID\n       --ash.*\n  from v$active_session_history ash\n where ash.SAMPLE_TIME >\n       to_date('20160425 10:00:00', 'yyyymmdd HH24:MI:SS')\n   and ash.SAMPLE_TIME <\n       to_date('20160425 12:10:00', 'yyyymmdd HH24:MI:SS')\n   and ash.WAIT_CLASS <> 'Idle'\n   and ash.EVENT like 'enq: TM - contention'\n order by sample_time desc;\n```\n\n下面是部分结果\n\n```\nenq: TM - contention\t1828\t2401\tname|mode\t1414332421\tobject #\t110417\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd\nenq: TM - contention\t1873\t2504\tname|mode\t1414332419\tobject #\t110415\ttable/partition\t0\tWAITING\tINSERT\t7w0tma5up32wt\nenq: TM - contention\t2504\t1828\tname|mode\t1414332421\tobject #\t110415\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd\nenq: TM - contention\t772\t4\tname|mode\t1414332421\tobject #\t110417\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd\nenq: TM - contention\t1781\t1828\tname|mode\t1414332419\tobject #\t110415\ttable/partition\t0\tWAITING\tINSERT\t7w0tma5up32wt\nenq: TM - contention\t1828\t772\tname|mode\t1414332421\tobject #\t110415\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd\nenq: TM - contention\t2401\t1828\tname|mode\t1414332419\tobject #\t110415\ttable/partition\t0\tWAITING\tINSERT\t7w0tma5up32wt\nenq: TM - contention\t2504\t772\tname|mode\t1414332421\tobject #\t110415\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd\nenq: TM - contention\t4\t772\tname|mode\t1414332419\tobject #\t110415\ttable/partition\t0\tWAITING\tINSERT\t7w0tma5up32wt\nenq: TM - contention\t148\t1781\tname|mode\t1414332420\tobject #\t110428\ttable/partition\t0\tWAITING\tUPDATE\t9gd6xhd0xyhph\nenq: TM - contention\t772\t148\tname|mode\t1414332421\tobject #\t110415\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd\nenq: TM - contention\t1828\t148\tname|mode\t1414332421\tobject #\t110415\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd\nenq: TM - contention\t1873\t772\tname|mode\t1414332419\tobject #\t110415\ttable/partition\t0\tWAITING\tINSERT\t7w0tma5up32wt\n```\n\n可以看到p2的值为产生TM争用的对象id，经过查证，这些object均是session正在更新的表的子表，而且通过v$sql查看update语句均更改了主表的主键，问题到这里已经很明朗了，由于外键没加索引，导致了主表在更新主表主键或删除主表记录时对子表的锁定，而且这张主表被大量的子表引用，此时子表上也同时进行事务处理，所以造成了更新主表的session 不时hang住。\n\n通过对所有子表的外键加索引，消除了争用，检测未加索引的外键语句：\n\n```sql\nSELECT TABLE_NAME,\n       CONSTRAINT_NAME,\n       CNAME1 || NVL2(CNAME2, ',' || CNAME2, NULL) ||\n       NVL2(CNAME3, ',' || CNAME3, NULL) ||\n       NVL2(CNAME4, ',' || CNAME4, NULL) ||\n       NVL2(CNAME5, ',' || CNAME5, NULL) ||\n       NVL2(CNAME6, ',' || CNAME6, NULL) ||\n       NVL2(CNAME7, ',' || CNAME7, NULL) ||\n       NVL2(CNAME8, ',' || CNAME8, NULL) COLUMNS\n  FROM (SELECT B.TABLE_NAME,\n               B.CONSTRAINT_NAME,\n               MAX(DECODE(POSITION, 1, COLUMN_NAME, NULL)) CNAME1,\n               MAX(DECODE(POSITION, 2, COLUMN_NAME, NULL)) CNAME2,\n               MAX(DECODE(POSITION, 3, COLUMN_NAME, NULL)) CNAME3,\n               MAX(DECODE(POSITION, 4, COLUMN_NAME, NULL)) CNAME4,\n               MAX(DECODE(POSITION, 5, COLUMN_NAME, NULL)) CNAME5,\n               MAX(DECODE(POSITION, 6, COLUMN_NAME, NULL)) CNAME6,\n               MAX(DECODE(POSITION, 7, COLUMN_NAME, NULL)) CNAME7,\n               MAX(DECODE(POSITION, 8, COLUMN_NAME, NULL)) CNAME8,\n               COUNT(*) COL_CNT\n          FROM (SELECT SUBSTR(TABLE_NAME, 1, 30) TABLE_NAME,\n                       SUBSTR(CONSTRAINT_NAME, 1, 30) CONSTRAINT_NAME,\n                       SUBSTR(COLUMN_NAME, 1, 30) COLUMN_NAME,\n                       POSITION\n                  FROM USER_CONS_COLUMNS) A,\n               USER_CONSTRAINTS B\n         WHERE A.CONSTRAINT_NAME = B.CONSTRAINT_NAME\n           AND B.CONSTRAINT_TYPE = 'R'\n         GROUP BY B.TABLE_NAME, B.CONSTRAINT_NAME) CONS\n WHERE COL_CNT > ALL\n (SELECT COUNT(*)\n          FROM USER_IND_COLUMNS I\n         WHERE I.TABLE_NAME = CONS.TABLE_NAME\n           AND I.COLUMN_NAME IN (CNAME1, CNAME2, CNAME3, CNAME4, CNAME5,\n                CNAME6, CNAME7, CNAME8)\n           AND I.COLUMN_POSITION <= CONS.COL_CNT\n         GROUP BY I.INDEX_NAME);\n```\n\n这是摘自TOM大师的语句，外键不加索引也是导致死锁的常见原因之一，因此对于主表经常进行更新删除操作的情况，外键一定要加索引。\n至于外键未加索引是如何导致锁定的，以及为何加了索引后争用就消失了? 敬请关注enq: TM - contention解决之道——外键无索引导致锁争用 （下）\n","source":"_posts/oracle/lock-latch/enq-TM-1.md","raw":"---\ntitle: enq之TM-contention解决之道——外键无索引导致锁争用（上）\ntags: oracle \ndate: 2016-07-25 16:21\n---\n\n近日，开发负责人反映某生产环境业务处理缓慢，主要业务操作就是修改会员信息，登录查询后发现大量的session正在等待enq: TM - contention，且waiting的语句几乎都是update\nsession的即时信息没有保留，现在附上ash视图的一些统计信息，可以大概了解一下当时争用的场景\n\n```sql\nSQL> @ash_wait_chains.sql username||':'||program2||event2 session_type='FOREGROUND' sysdate-6/24 sysdate-5/24\n\n-- Display ASH Wait Chain Signatures script v0.2 BETA by Tanel Poder ( http://blog.tanelpoder.com )\n\n%This     SECONDS        AAS\n------ ---------- ----------\nWAIT_CHAIN\n------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n  72%       20073        5.6\n-> JSCHPROD:(JDBC Thin Client) ON CPU\n\n   8%        2293         .6\n-> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) ON CPU\n\n   8%        2141         .6\n-> JSCHPROD:(JDBC Thin Client) log file sync  -> SYS:(LGWR) log file parallel write\n\n   7%        1879         .5\n-> JSCHPROD:(JDBC Thin Client) log file sync  -> SYS:(LGWR) LGWR-LNS wait on channel\n\n   2%         654         .2\n-> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) ON CPU\n\n   1%         288         .1\n-> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) ON CPU\n\n   1%         149          0\n-> JSCHPROD:(JDBC Thin Client) log file sync  -> SYS:(LGWR) ON CPU\n\n   0%         128          0\n-> JSCHPROD:(JDBC Thin Client) enq: TM - contention\n\n   0%         112          0\n-> JSCHPROD:(JDBC Thin Client) log file sync\n\n   0%          86          0\n-> JSCHPROD:(JDBC Thin Client) db file scattered read\n\n   0%          43          0\n-> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) ON CPU\n\n   0%          37          0\n-> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) enq: TM - contention\n\n   0%          25          0\n-> JSCHPROD:(JDBC Thin Client) log file sync  -> SYS:(LGWR) LGWR wait on LNS\n\n   0%          13          0\n-> JSCHPROD:(plsqldev.exe) ON CPU\n\n   0%          11          0\n-> SYS:(plsqldev.exe) ON CPU\n\n   0%          10          0\n-> JSCHPROD:(JDBC Thin Client) SQL*Net more data from client\n\n   0%           9          0\n-> JSCHPROD:(JDBC Thin Client) db file sequential read\n\n   0%           9          0\n-> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) ON\nCPU\n\n   0%           6          0\n-> JSCHPROD:(JDBC Thin Client) read by other session  -> JSCHPROD:(JDBC Thin Client) ON CPU\n\n   0%           4          0\n-> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) enq: TM - contention  -> JSCHPROD:(JDBC Thin Client) enq: TM - contention\n\n   0%           3          0\n-> JSCHPROD:(JDBC Thin Client) SQL*Net more data to client\n\n   0%           3          0\n-> JSCHPROD:(JDBC Thin Client) buffer busy waits [data block]\n\n   0%           3          0\n-> SYS:(oraagent.bin) Disk file operations I/O\n\n   0%           3          0\n-> JSCHPROD:(JDBC Thin Client) log file sync  -> SYS:(LGWR) LGWR wait for redo copy\n\n   0%           2          0\n-> JSCHPROD:(JDBC Thin Client) enq: TX - row lock contention\n\n   0%           2          0\n-> JSCHPROD:(JDBC Thin Client) log file sync  -> SYS:(LGWR) LGWR wait for redo copy  -> JSCHPROD:(JDBC Thin Client) ON CPU\n\n   0%           2          0\n-> JSCHPROD:(JDBC Thin Client) enq: TX - index contention  -> JSCHPROD:(JDBC Thin Client) ON CPU\n\n   0%           1          0\n-> JSCHPROD:(plsqldev.exe) log file sync  -> SYS:(LGWR) log file parallel write\n\n   0%           1          0\n-> SYS:(plsqldev.exe) Disk file operations I/O\n\n   0%           1          0\n-> JSCHPROD:(JDBC Thin Client) enq: TX - row lock contention  -> JSCHPROD:(JDBC Thin Client) ON CPU\n\n\n30 rows selected.\n\n```\n\n可以看到，TM锁的争用很多，再看一份当时awr报告的top10\n\n![](https://liupzminblog.files.wordpress.com/2016/12/qq20161218-02x.png)\n\n虽然占DBTIME不多，但本来是很快的操作，短时间内给人的感觉就是业务处理缓慢\n查一下当时等待事件的p1,p2,p3的值\n\n```sql\nselect ash.SAMPLE_TIME,\n       ash.EVENT,\n       ash.SESSION_ID,\n       ash.BLOCKING_SESSION,\n       ash.P1TEXT,\n       ash.P1,\n       ash.P2TEXT,\n       ash.p2,\n       ash.p3text,\n       ash.p3,\n       ash.SESSION_STATE,\n       ash.SQL_OPNAME,\n       ash.SQL_ID\n       --ash.*\n  from v$active_session_history ash\n where ash.SAMPLE_TIME >\n       to_date('20160425 10:00:00', 'yyyymmdd HH24:MI:SS')\n   and ash.SAMPLE_TIME <\n       to_date('20160425 12:10:00', 'yyyymmdd HH24:MI:SS')\n   and ash.WAIT_CLASS <> 'Idle'\n   and ash.EVENT like 'enq: TM - contention'\n order by sample_time desc;\n```\n\n下面是部分结果\n\n```\nenq: TM - contention\t1828\t2401\tname|mode\t1414332421\tobject #\t110417\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd\nenq: TM - contention\t1873\t2504\tname|mode\t1414332419\tobject #\t110415\ttable/partition\t0\tWAITING\tINSERT\t7w0tma5up32wt\nenq: TM - contention\t2504\t1828\tname|mode\t1414332421\tobject #\t110415\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd\nenq: TM - contention\t772\t4\tname|mode\t1414332421\tobject #\t110417\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd\nenq: TM - contention\t1781\t1828\tname|mode\t1414332419\tobject #\t110415\ttable/partition\t0\tWAITING\tINSERT\t7w0tma5up32wt\nenq: TM - contention\t1828\t772\tname|mode\t1414332421\tobject #\t110415\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd\nenq: TM - contention\t2401\t1828\tname|mode\t1414332419\tobject #\t110415\ttable/partition\t0\tWAITING\tINSERT\t7w0tma5up32wt\nenq: TM - contention\t2504\t772\tname|mode\t1414332421\tobject #\t110415\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd\nenq: TM - contention\t4\t772\tname|mode\t1414332419\tobject #\t110415\ttable/partition\t0\tWAITING\tINSERT\t7w0tma5up32wt\nenq: TM - contention\t148\t1781\tname|mode\t1414332420\tobject #\t110428\ttable/partition\t0\tWAITING\tUPDATE\t9gd6xhd0xyhph\nenq: TM - contention\t772\t148\tname|mode\t1414332421\tobject #\t110415\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd\nenq: TM - contention\t1828\t148\tname|mode\t1414332421\tobject #\t110415\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd\nenq: TM - contention\t1873\t772\tname|mode\t1414332419\tobject #\t110415\ttable/partition\t0\tWAITING\tINSERT\t7w0tma5up32wt\n```\n\n可以看到p2的值为产生TM争用的对象id，经过查证，这些object均是session正在更新的表的子表，而且通过v$sql查看update语句均更改了主表的主键，问题到这里已经很明朗了，由于外键没加索引，导致了主表在更新主表主键或删除主表记录时对子表的锁定，而且这张主表被大量的子表引用，此时子表上也同时进行事务处理，所以造成了更新主表的session 不时hang住。\n\n通过对所有子表的外键加索引，消除了争用，检测未加索引的外键语句：\n\n```sql\nSELECT TABLE_NAME,\n       CONSTRAINT_NAME,\n       CNAME1 || NVL2(CNAME2, ',' || CNAME2, NULL) ||\n       NVL2(CNAME3, ',' || CNAME3, NULL) ||\n       NVL2(CNAME4, ',' || CNAME4, NULL) ||\n       NVL2(CNAME5, ',' || CNAME5, NULL) ||\n       NVL2(CNAME6, ',' || CNAME6, NULL) ||\n       NVL2(CNAME7, ',' || CNAME7, NULL) ||\n       NVL2(CNAME8, ',' || CNAME8, NULL) COLUMNS\n  FROM (SELECT B.TABLE_NAME,\n               B.CONSTRAINT_NAME,\n               MAX(DECODE(POSITION, 1, COLUMN_NAME, NULL)) CNAME1,\n               MAX(DECODE(POSITION, 2, COLUMN_NAME, NULL)) CNAME2,\n               MAX(DECODE(POSITION, 3, COLUMN_NAME, NULL)) CNAME3,\n               MAX(DECODE(POSITION, 4, COLUMN_NAME, NULL)) CNAME4,\n               MAX(DECODE(POSITION, 5, COLUMN_NAME, NULL)) CNAME5,\n               MAX(DECODE(POSITION, 6, COLUMN_NAME, NULL)) CNAME6,\n               MAX(DECODE(POSITION, 7, COLUMN_NAME, NULL)) CNAME7,\n               MAX(DECODE(POSITION, 8, COLUMN_NAME, NULL)) CNAME8,\n               COUNT(*) COL_CNT\n          FROM (SELECT SUBSTR(TABLE_NAME, 1, 30) TABLE_NAME,\n                       SUBSTR(CONSTRAINT_NAME, 1, 30) CONSTRAINT_NAME,\n                       SUBSTR(COLUMN_NAME, 1, 30) COLUMN_NAME,\n                       POSITION\n                  FROM USER_CONS_COLUMNS) A,\n               USER_CONSTRAINTS B\n         WHERE A.CONSTRAINT_NAME = B.CONSTRAINT_NAME\n           AND B.CONSTRAINT_TYPE = 'R'\n         GROUP BY B.TABLE_NAME, B.CONSTRAINT_NAME) CONS\n WHERE COL_CNT > ALL\n (SELECT COUNT(*)\n          FROM USER_IND_COLUMNS I\n         WHERE I.TABLE_NAME = CONS.TABLE_NAME\n           AND I.COLUMN_NAME IN (CNAME1, CNAME2, CNAME3, CNAME4, CNAME5,\n                CNAME6, CNAME7, CNAME8)\n           AND I.COLUMN_POSITION <= CONS.COL_CNT\n         GROUP BY I.INDEX_NAME);\n```\n\n这是摘自TOM大师的语句，外键不加索引也是导致死锁的常见原因之一，因此对于主表经常进行更新删除操作的情况，外键一定要加索引。\n至于外键未加索引是如何导致锁定的，以及为何加了索引后争用就消失了? 敬请关注enq: TM - contention解决之道——外键无索引导致锁争用 （下）\n","slug":"oracle/lock-latch/enq-TM-1","published":1,"updated":"2019-07-21T04:58:37.300Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjychzpy10009fn0e4xcz3p54","content":"<p>近日，开发负责人反映某生产环境业务处理缓慢，主要业务操作就是修改会员信息，登录查询后发现大量的session正在等待enq: TM - contention，且waiting的语句几乎都是update<br>session的即时信息没有保留，现在附上ash视图的一些统计信息，可以大概了解一下当时争用的场景</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; @ash_wait_chains.sql username||':'||program2||event2 session_type='FOREGROUND' sysdate-6/24 sysdate-5/24</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- Display ASH Wait Chain Signatures script v0.2 BETA by Tanel Poder ( http://blog.tanelpoder.com )</span></span><br><span class=\"line\"></span><br><span class=\"line\">%This     SECONDS        AAS</span><br><span class=\"line\"><span class=\"comment\">------ ---------- ----------</span></span><br><span class=\"line\">WAIT_CHAIN</span><br><span class=\"line\"><span class=\"comment\">------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span></span><br><span class=\"line\">  72%       20073        5.6</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) ON CPU</span><br><span class=\"line\"></span><br><span class=\"line\">   8%        2293         .6</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) ON CPU</span><br><span class=\"line\"></span><br><span class=\"line\">   8%        2141         .6</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) log file sync  -&gt; SYS:(LGWR) log file parallel write</span><br><span class=\"line\"></span><br><span class=\"line\">   7%        1879         .5</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) log file sync  -&gt; SYS:(LGWR) LGWR-LNS wait on channel</span><br><span class=\"line\"></span><br><span class=\"line\">   2%         654         .2</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) ON CPU</span><br><span class=\"line\"></span><br><span class=\"line\">   1%         288         .1</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) ON CPU</span><br><span class=\"line\"></span><br><span class=\"line\">   1%         149          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) log file sync  -&gt; SYS:(LGWR) ON CPU</span><br><span class=\"line\"></span><br><span class=\"line\">   0%         128          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention</span><br><span class=\"line\"></span><br><span class=\"line\">   0%         112          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) log file sync</span><br><span class=\"line\"></span><br><span class=\"line\">   0%          86          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) db file scattered read</span><br><span class=\"line\"></span><br><span class=\"line\">   0%          43          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) ON CPU</span><br><span class=\"line\"></span><br><span class=\"line\">   0%          37          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention</span><br><span class=\"line\"></span><br><span class=\"line\">   0%          25          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) log file sync  -&gt; SYS:(LGWR) LGWR wait on LNS</span><br><span class=\"line\"></span><br><span class=\"line\">   0%          13          0</span><br><span class=\"line\">-&gt; JSCHPROD:(plsqldev.exe) ON CPU</span><br><span class=\"line\"></span><br><span class=\"line\">   0%          11          0</span><br><span class=\"line\">-&gt; SYS:(plsqldev.exe) ON CPU</span><br><span class=\"line\"></span><br><span class=\"line\">   0%          10          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) SQL*Net more data from client</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           9          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) db file sequential read</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           9          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) ON</span><br><span class=\"line\">CPU</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           6          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) read by other session  -&gt; JSCHPROD:(JDBC Thin Client) ON CPU</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           4          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           3          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) SQL*Net more data to client</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           3          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) buffer busy waits [data block]</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           3          0</span><br><span class=\"line\">-&gt; SYS:(oraagent.bin) Disk file operations I/O</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           3          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) log file sync  -&gt; SYS:(LGWR) LGWR wait for redo copy</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           2          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) enq: TX - row lock contention</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           2          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) log file sync  -&gt; SYS:(LGWR) LGWR wait for redo copy  -&gt; JSCHPROD:(JDBC Thin Client) ON CPU</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           2          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) enq: TX - index contention  -&gt; JSCHPROD:(JDBC Thin Client) ON CPU</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           1          0</span><br><span class=\"line\">-&gt; JSCHPROD:(plsqldev.exe) log file sync  -&gt; SYS:(LGWR) log file parallel write</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           1          0</span><br><span class=\"line\">-&gt; SYS:(plsqldev.exe) Disk file operations I/O</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           1          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) enq: TX - row lock contention  -&gt; JSCHPROD:(JDBC Thin Client) ON CPU</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">30 rows selected.</span><br></pre></td></tr></table></figure>\n\n<p>可以看到，TM锁的争用很多，再看一份当时awr报告的top10</p>\n<p><img alt data-src=\"https://liupzminblog.files.wordpress.com/2016/12/qq20161218-02x.png\"></p>\n<p>虽然占DBTIME不多，但本来是很快的操作，短时间内给人的感觉就是业务处理缓慢<br>查一下当时等待事件的p1,p2,p3的值</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> ash.SAMPLE_TIME,</span><br><span class=\"line\">       ash.EVENT,</span><br><span class=\"line\">       ash.SESSION_ID,</span><br><span class=\"line\">       ash.BLOCKING_SESSION,</span><br><span class=\"line\">       ash.P1TEXT,</span><br><span class=\"line\">       ash.P1,</span><br><span class=\"line\">       ash.P2TEXT,</span><br><span class=\"line\">       ash.p2,</span><br><span class=\"line\">       ash.p3text,</span><br><span class=\"line\">       ash.p3,</span><br><span class=\"line\">       ash.SESSION_STATE,</span><br><span class=\"line\">       ash.SQL_OPNAME,</span><br><span class=\"line\">       ash.SQL_ID</span><br><span class=\"line\">       <span class=\"comment\">--ash.*</span></span><br><span class=\"line\">  <span class=\"keyword\">from</span> v$active_session_history ash</span><br><span class=\"line\"> <span class=\"keyword\">where</span> ash.SAMPLE_TIME &gt;</span><br><span class=\"line\">       <span class=\"keyword\">to_date</span>(<span class=\"string\">'20160425 10:00:00'</span>, <span class=\"string\">'yyyymmdd HH24:MI:SS'</span>)</span><br><span class=\"line\">   <span class=\"keyword\">and</span> ash.SAMPLE_TIME &lt;</span><br><span class=\"line\">       <span class=\"keyword\">to_date</span>(<span class=\"string\">'20160425 12:10:00'</span>, <span class=\"string\">'yyyymmdd HH24:MI:SS'</span>)</span><br><span class=\"line\">   <span class=\"keyword\">and</span> ash.WAIT_CLASS &lt;&gt; <span class=\"string\">'Idle'</span></span><br><span class=\"line\">   <span class=\"keyword\">and</span> ash.EVENT <span class=\"keyword\">like</span> <span class=\"string\">'enq: TM - contention'</span></span><br><span class=\"line\"> <span class=\"keyword\">order</span> <span class=\"keyword\">by</span> sample_time <span class=\"keyword\">desc</span>;</span><br></pre></td></tr></table></figure>\n\n<p>下面是部分结果</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">enq: TM - contention\t1828\t2401\tname|mode\t1414332421\tobject #\t110417\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd</span><br><span class=\"line\">enq: TM - contention\t1873\t2504\tname|mode\t1414332419\tobject #\t110415\ttable/partition\t0\tWAITING\tINSERT\t7w0tma5up32wt</span><br><span class=\"line\">enq: TM - contention\t2504\t1828\tname|mode\t1414332421\tobject #\t110415\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd</span><br><span class=\"line\">enq: TM - contention\t772\t4\tname|mode\t1414332421\tobject #\t110417\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd</span><br><span class=\"line\">enq: TM - contention\t1781\t1828\tname|mode\t1414332419\tobject #\t110415\ttable/partition\t0\tWAITING\tINSERT\t7w0tma5up32wt</span><br><span class=\"line\">enq: TM - contention\t1828\t772\tname|mode\t1414332421\tobject #\t110415\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd</span><br><span class=\"line\">enq: TM - contention\t2401\t1828\tname|mode\t1414332419\tobject #\t110415\ttable/partition\t0\tWAITING\tINSERT\t7w0tma5up32wt</span><br><span class=\"line\">enq: TM - contention\t2504\t772\tname|mode\t1414332421\tobject #\t110415\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd</span><br><span class=\"line\">enq: TM - contention\t4\t772\tname|mode\t1414332419\tobject #\t110415\ttable/partition\t0\tWAITING\tINSERT\t7w0tma5up32wt</span><br><span class=\"line\">enq: TM - contention\t148\t1781\tname|mode\t1414332420\tobject #\t110428\ttable/partition\t0\tWAITING\tUPDATE\t9gd6xhd0xyhph</span><br><span class=\"line\">enq: TM - contention\t772\t148\tname|mode\t1414332421\tobject #\t110415\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd</span><br><span class=\"line\">enq: TM - contention\t1828\t148\tname|mode\t1414332421\tobject #\t110415\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd</span><br><span class=\"line\">enq: TM - contention\t1873\t772\tname|mode\t1414332419\tobject #\t110415\ttable/partition\t0\tWAITING\tINSERT\t7w0tma5up32wt</span><br></pre></td></tr></table></figure>\n\n<p>可以看到p2的值为产生TM争用的对象id，经过查证，这些object均是session正在更新的表的子表，而且通过v$sql查看update语句均更改了主表的主键，问题到这里已经很明朗了，由于外键没加索引，导致了主表在更新主表主键或删除主表记录时对子表的锁定，而且这张主表被大量的子表引用，此时子表上也同时进行事务处理，所以造成了更新主表的session 不时hang住。</p>\n<p>通过对所有子表的外键加索引，消除了争用，检测未加索引的外键语句：</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> TABLE_NAME,</span><br><span class=\"line\">       CONSTRAINT_NAME,</span><br><span class=\"line\">       CNAME1 || NVL2(CNAME2, <span class=\"string\">','</span> || CNAME2, <span class=\"literal\">NULL</span>) ||</span><br><span class=\"line\">       NVL2(CNAME3, <span class=\"string\">','</span> || CNAME3, <span class=\"literal\">NULL</span>) ||</span><br><span class=\"line\">       NVL2(CNAME4, <span class=\"string\">','</span> || CNAME4, <span class=\"literal\">NULL</span>) ||</span><br><span class=\"line\">       NVL2(CNAME5, <span class=\"string\">','</span> || CNAME5, <span class=\"literal\">NULL</span>) ||</span><br><span class=\"line\">       NVL2(CNAME6, <span class=\"string\">','</span> || CNAME6, <span class=\"literal\">NULL</span>) ||</span><br><span class=\"line\">       NVL2(CNAME7, <span class=\"string\">','</span> || CNAME7, <span class=\"literal\">NULL</span>) ||</span><br><span class=\"line\">       NVL2(CNAME8, <span class=\"string\">','</span> || CNAME8, <span class=\"literal\">NULL</span>) <span class=\"keyword\">COLUMNS</span></span><br><span class=\"line\">  <span class=\"keyword\">FROM</span> (<span class=\"keyword\">SELECT</span> B.TABLE_NAME,</span><br><span class=\"line\">               B.CONSTRAINT_NAME,</span><br><span class=\"line\">               <span class=\"keyword\">MAX</span>(<span class=\"keyword\">DECODE</span>(<span class=\"keyword\">POSITION</span>, <span class=\"number\">1</span>, COLUMN_NAME, <span class=\"literal\">NULL</span>)) CNAME1,</span><br><span class=\"line\">               <span class=\"keyword\">MAX</span>(<span class=\"keyword\">DECODE</span>(<span class=\"keyword\">POSITION</span>, <span class=\"number\">2</span>, COLUMN_NAME, <span class=\"literal\">NULL</span>)) CNAME2,</span><br><span class=\"line\">               <span class=\"keyword\">MAX</span>(<span class=\"keyword\">DECODE</span>(<span class=\"keyword\">POSITION</span>, <span class=\"number\">3</span>, COLUMN_NAME, <span class=\"literal\">NULL</span>)) CNAME3,</span><br><span class=\"line\">               <span class=\"keyword\">MAX</span>(<span class=\"keyword\">DECODE</span>(<span class=\"keyword\">POSITION</span>, <span class=\"number\">4</span>, COLUMN_NAME, <span class=\"literal\">NULL</span>)) CNAME4,</span><br><span class=\"line\">               <span class=\"keyword\">MAX</span>(<span class=\"keyword\">DECODE</span>(<span class=\"keyword\">POSITION</span>, <span class=\"number\">5</span>, COLUMN_NAME, <span class=\"literal\">NULL</span>)) CNAME5,</span><br><span class=\"line\">               <span class=\"keyword\">MAX</span>(<span class=\"keyword\">DECODE</span>(<span class=\"keyword\">POSITION</span>, <span class=\"number\">6</span>, COLUMN_NAME, <span class=\"literal\">NULL</span>)) CNAME6,</span><br><span class=\"line\">               <span class=\"keyword\">MAX</span>(<span class=\"keyword\">DECODE</span>(<span class=\"keyword\">POSITION</span>, <span class=\"number\">7</span>, COLUMN_NAME, <span class=\"literal\">NULL</span>)) CNAME7,</span><br><span class=\"line\">               <span class=\"keyword\">MAX</span>(<span class=\"keyword\">DECODE</span>(<span class=\"keyword\">POSITION</span>, <span class=\"number\">8</span>, COLUMN_NAME, <span class=\"literal\">NULL</span>)) CNAME8,</span><br><span class=\"line\">               <span class=\"keyword\">COUNT</span>(*) COL_CNT</span><br><span class=\"line\">          <span class=\"keyword\">FROM</span> (<span class=\"keyword\">SELECT</span> <span class=\"keyword\">SUBSTR</span>(TABLE_NAME, <span class=\"number\">1</span>, <span class=\"number\">30</span>) TABLE_NAME,</span><br><span class=\"line\">                       <span class=\"keyword\">SUBSTR</span>(CONSTRAINT_NAME, <span class=\"number\">1</span>, <span class=\"number\">30</span>) CONSTRAINT_NAME,</span><br><span class=\"line\">                       <span class=\"keyword\">SUBSTR</span>(COLUMN_NAME, <span class=\"number\">1</span>, <span class=\"number\">30</span>) COLUMN_NAME,</span><br><span class=\"line\">                       <span class=\"keyword\">POSITION</span></span><br><span class=\"line\">                  <span class=\"keyword\">FROM</span> USER_CONS_COLUMNS) A,</span><br><span class=\"line\">               USER_CONSTRAINTS B</span><br><span class=\"line\">         <span class=\"keyword\">WHERE</span> A.CONSTRAINT_NAME = B.CONSTRAINT_NAME</span><br><span class=\"line\">           <span class=\"keyword\">AND</span> B.CONSTRAINT_TYPE = <span class=\"string\">'R'</span></span><br><span class=\"line\">         <span class=\"keyword\">GROUP</span> <span class=\"keyword\">BY</span> B.TABLE_NAME, B.CONSTRAINT_NAME) CONS</span><br><span class=\"line\"> <span class=\"keyword\">WHERE</span> COL_CNT &gt; <span class=\"keyword\">ALL</span></span><br><span class=\"line\"> (<span class=\"keyword\">SELECT</span> <span class=\"keyword\">COUNT</span>(*)</span><br><span class=\"line\">          <span class=\"keyword\">FROM</span> USER_IND_COLUMNS I</span><br><span class=\"line\">         <span class=\"keyword\">WHERE</span> I.TABLE_NAME = CONS.TABLE_NAME</span><br><span class=\"line\">           <span class=\"keyword\">AND</span> I.COLUMN_NAME <span class=\"keyword\">IN</span> (CNAME1, CNAME2, CNAME3, CNAME4, CNAME5,</span><br><span class=\"line\">                CNAME6, CNAME7, CNAME8)</span><br><span class=\"line\">           <span class=\"keyword\">AND</span> I.COLUMN_POSITION &lt;= CONS.COL_CNT</span><br><span class=\"line\">         <span class=\"keyword\">GROUP</span> <span class=\"keyword\">BY</span> I.INDEX_NAME);</span><br></pre></td></tr></table></figure>\n\n<p>这是摘自TOM大师的语句，外键不加索引也是导致死锁的常见原因之一，因此对于主表经常进行更新删除操作的情况，外键一定要加索引。<br>至于外键未加索引是如何导致锁定的，以及为何加了索引后争用就消失了? 敬请关注enq: TM - contention解决之道——外键无索引导致锁争用 （下）</p>\n","site":{"data":{"styles":"","footer":"<div class=\"footer-custom\">\nTheme source code <span class=\"exturl theme-link\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvaGV4by10aGVtZS1uZXh0\">here</span><br>\nWebsite source code <span class=\"exturl theme-link\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RoZW1lLW5leHQvdGhlbWUtbmV4dC5vcmc=\">here</span>\n</div>\n"}},"excerpt":"","more":"<p>近日，开发负责人反映某生产环境业务处理缓慢，主要业务操作就是修改会员信息，登录查询后发现大量的session正在等待enq: TM - contention，且waiting的语句几乎都是update<br>session的即时信息没有保留，现在附上ash视图的一些统计信息，可以大概了解一下当时争用的场景</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">SQL&gt; @ash_wait_chains.sql username||':'||program2||event2 session_type='FOREGROUND' sysdate-6/24 sysdate-5/24</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-- Display ASH Wait Chain Signatures script v0.2 BETA by Tanel Poder ( http://blog.tanelpoder.com )</span></span><br><span class=\"line\"></span><br><span class=\"line\">%This     SECONDS        AAS</span><br><span class=\"line\"><span class=\"comment\">------ ---------- ----------</span></span><br><span class=\"line\">WAIT_CHAIN</span><br><span class=\"line\"><span class=\"comment\">------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span></span><br><span class=\"line\">  72%       20073        5.6</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) ON CPU</span><br><span class=\"line\"></span><br><span class=\"line\">   8%        2293         .6</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) ON CPU</span><br><span class=\"line\"></span><br><span class=\"line\">   8%        2141         .6</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) log file sync  -&gt; SYS:(LGWR) log file parallel write</span><br><span class=\"line\"></span><br><span class=\"line\">   7%        1879         .5</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) log file sync  -&gt; SYS:(LGWR) LGWR-LNS wait on channel</span><br><span class=\"line\"></span><br><span class=\"line\">   2%         654         .2</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) ON CPU</span><br><span class=\"line\"></span><br><span class=\"line\">   1%         288         .1</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) ON CPU</span><br><span class=\"line\"></span><br><span class=\"line\">   1%         149          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) log file sync  -&gt; SYS:(LGWR) ON CPU</span><br><span class=\"line\"></span><br><span class=\"line\">   0%         128          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention</span><br><span class=\"line\"></span><br><span class=\"line\">   0%         112          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) log file sync</span><br><span class=\"line\"></span><br><span class=\"line\">   0%          86          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) db file scattered read</span><br><span class=\"line\"></span><br><span class=\"line\">   0%          43          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) ON CPU</span><br><span class=\"line\"></span><br><span class=\"line\">   0%          37          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention</span><br><span class=\"line\"></span><br><span class=\"line\">   0%          25          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) log file sync  -&gt; SYS:(LGWR) LGWR wait on LNS</span><br><span class=\"line\"></span><br><span class=\"line\">   0%          13          0</span><br><span class=\"line\">-&gt; JSCHPROD:(plsqldev.exe) ON CPU</span><br><span class=\"line\"></span><br><span class=\"line\">   0%          11          0</span><br><span class=\"line\">-&gt; SYS:(plsqldev.exe) ON CPU</span><br><span class=\"line\"></span><br><span class=\"line\">   0%          10          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) SQL*Net more data from client</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           9          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) db file sequential read</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           9          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) ON</span><br><span class=\"line\">CPU</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           6          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) read by other session  -&gt; JSCHPROD:(JDBC Thin Client) ON CPU</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           4          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention  -&gt; JSCHPROD:(JDBC Thin Client) enq: TM - contention</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           3          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) SQL*Net more data to client</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           3          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) buffer busy waits [data block]</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           3          0</span><br><span class=\"line\">-&gt; SYS:(oraagent.bin) Disk file operations I/O</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           3          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) log file sync  -&gt; SYS:(LGWR) LGWR wait for redo copy</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           2          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) enq: TX - row lock contention</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           2          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) log file sync  -&gt; SYS:(LGWR) LGWR wait for redo copy  -&gt; JSCHPROD:(JDBC Thin Client) ON CPU</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           2          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) enq: TX - index contention  -&gt; JSCHPROD:(JDBC Thin Client) ON CPU</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           1          0</span><br><span class=\"line\">-&gt; JSCHPROD:(plsqldev.exe) log file sync  -&gt; SYS:(LGWR) log file parallel write</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           1          0</span><br><span class=\"line\">-&gt; SYS:(plsqldev.exe) Disk file operations I/O</span><br><span class=\"line\"></span><br><span class=\"line\">   0%           1          0</span><br><span class=\"line\">-&gt; JSCHPROD:(JDBC Thin Client) enq: TX - row lock contention  -&gt; JSCHPROD:(JDBC Thin Client) ON CPU</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">30 rows selected.</span><br></pre></td></tr></table></figure>\n\n<p>可以看到，TM锁的争用很多，再看一份当时awr报告的top10</p>\n<p><img alt data-src=\"https://liupzminblog.files.wordpress.com/2016/12/qq20161218-02x.png\"></p>\n<p>虽然占DBTIME不多，但本来是很快的操作，短时间内给人的感觉就是业务处理缓慢<br>查一下当时等待事件的p1,p2,p3的值</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> ash.SAMPLE_TIME,</span><br><span class=\"line\">       ash.EVENT,</span><br><span class=\"line\">       ash.SESSION_ID,</span><br><span class=\"line\">       ash.BLOCKING_SESSION,</span><br><span class=\"line\">       ash.P1TEXT,</span><br><span class=\"line\">       ash.P1,</span><br><span class=\"line\">       ash.P2TEXT,</span><br><span class=\"line\">       ash.p2,</span><br><span class=\"line\">       ash.p3text,</span><br><span class=\"line\">       ash.p3,</span><br><span class=\"line\">       ash.SESSION_STATE,</span><br><span class=\"line\">       ash.SQL_OPNAME,</span><br><span class=\"line\">       ash.SQL_ID</span><br><span class=\"line\">       <span class=\"comment\">--ash.*</span></span><br><span class=\"line\">  <span class=\"keyword\">from</span> v$active_session_history ash</span><br><span class=\"line\"> <span class=\"keyword\">where</span> ash.SAMPLE_TIME &gt;</span><br><span class=\"line\">       <span class=\"keyword\">to_date</span>(<span class=\"string\">'20160425 10:00:00'</span>, <span class=\"string\">'yyyymmdd HH24:MI:SS'</span>)</span><br><span class=\"line\">   <span class=\"keyword\">and</span> ash.SAMPLE_TIME &lt;</span><br><span class=\"line\">       <span class=\"keyword\">to_date</span>(<span class=\"string\">'20160425 12:10:00'</span>, <span class=\"string\">'yyyymmdd HH24:MI:SS'</span>)</span><br><span class=\"line\">   <span class=\"keyword\">and</span> ash.WAIT_CLASS &lt;&gt; <span class=\"string\">'Idle'</span></span><br><span class=\"line\">   <span class=\"keyword\">and</span> ash.EVENT <span class=\"keyword\">like</span> <span class=\"string\">'enq: TM - contention'</span></span><br><span class=\"line\"> <span class=\"keyword\">order</span> <span class=\"keyword\">by</span> sample_time <span class=\"keyword\">desc</span>;</span><br></pre></td></tr></table></figure>\n\n<p>下面是部分结果</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">enq: TM - contention\t1828\t2401\tname|mode\t1414332421\tobject #\t110417\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd</span><br><span class=\"line\">enq: TM - contention\t1873\t2504\tname|mode\t1414332419\tobject #\t110415\ttable/partition\t0\tWAITING\tINSERT\t7w0tma5up32wt</span><br><span class=\"line\">enq: TM - contention\t2504\t1828\tname|mode\t1414332421\tobject #\t110415\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd</span><br><span class=\"line\">enq: TM - contention\t772\t4\tname|mode\t1414332421\tobject #\t110417\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd</span><br><span class=\"line\">enq: TM - contention\t1781\t1828\tname|mode\t1414332419\tobject #\t110415\ttable/partition\t0\tWAITING\tINSERT\t7w0tma5up32wt</span><br><span class=\"line\">enq: TM - contention\t1828\t772\tname|mode\t1414332421\tobject #\t110415\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd</span><br><span class=\"line\">enq: TM - contention\t2401\t1828\tname|mode\t1414332419\tobject #\t110415\ttable/partition\t0\tWAITING\tINSERT\t7w0tma5up32wt</span><br><span class=\"line\">enq: TM - contention\t2504\t772\tname|mode\t1414332421\tobject #\t110415\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd</span><br><span class=\"line\">enq: TM - contention\t4\t772\tname|mode\t1414332419\tobject #\t110415\ttable/partition\t0\tWAITING\tINSERT\t7w0tma5up32wt</span><br><span class=\"line\">enq: TM - contention\t148\t1781\tname|mode\t1414332420\tobject #\t110428\ttable/partition\t0\tWAITING\tUPDATE\t9gd6xhd0xyhph</span><br><span class=\"line\">enq: TM - contention\t772\t148\tname|mode\t1414332421\tobject #\t110415\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd</span><br><span class=\"line\">enq: TM - contention\t1828\t148\tname|mode\t1414332421\tobject #\t110415\ttable/partition\t0\tWAITING\tUPDATE\tak25v8q8p6fzd</span><br><span class=\"line\">enq: TM - contention\t1873\t772\tname|mode\t1414332419\tobject #\t110415\ttable/partition\t0\tWAITING\tINSERT\t7w0tma5up32wt</span><br></pre></td></tr></table></figure>\n\n<p>可以看到p2的值为产生TM争用的对象id，经过查证，这些object均是session正在更新的表的子表，而且通过v$sql查看update语句均更改了主表的主键，问题到这里已经很明朗了，由于外键没加索引，导致了主表在更新主表主键或删除主表记录时对子表的锁定，而且这张主表被大量的子表引用，此时子表上也同时进行事务处理，所以造成了更新主表的session 不时hang住。</p>\n<p>通过对所有子表的外键加索引，消除了争用，检测未加索引的外键语句：</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> TABLE_NAME,</span><br><span class=\"line\">       CONSTRAINT_NAME,</span><br><span class=\"line\">       CNAME1 || NVL2(CNAME2, <span class=\"string\">','</span> || CNAME2, <span class=\"literal\">NULL</span>) ||</span><br><span class=\"line\">       NVL2(CNAME3, <span class=\"string\">','</span> || CNAME3, <span class=\"literal\">NULL</span>) ||</span><br><span class=\"line\">       NVL2(CNAME4, <span class=\"string\">','</span> || CNAME4, <span class=\"literal\">NULL</span>) ||</span><br><span class=\"line\">       NVL2(CNAME5, <span class=\"string\">','</span> || CNAME5, <span class=\"literal\">NULL</span>) ||</span><br><span class=\"line\">       NVL2(CNAME6, <span class=\"string\">','</span> || CNAME6, <span class=\"literal\">NULL</span>) ||</span><br><span class=\"line\">       NVL2(CNAME7, <span class=\"string\">','</span> || CNAME7, <span class=\"literal\">NULL</span>) ||</span><br><span class=\"line\">       NVL2(CNAME8, <span class=\"string\">','</span> || CNAME8, <span class=\"literal\">NULL</span>) <span class=\"keyword\">COLUMNS</span></span><br><span class=\"line\">  <span class=\"keyword\">FROM</span> (<span class=\"keyword\">SELECT</span> B.TABLE_NAME,</span><br><span class=\"line\">               B.CONSTRAINT_NAME,</span><br><span class=\"line\">               <span class=\"keyword\">MAX</span>(<span class=\"keyword\">DECODE</span>(<span class=\"keyword\">POSITION</span>, <span class=\"number\">1</span>, COLUMN_NAME, <span class=\"literal\">NULL</span>)) CNAME1,</span><br><span class=\"line\">               <span class=\"keyword\">MAX</span>(<span class=\"keyword\">DECODE</span>(<span class=\"keyword\">POSITION</span>, <span class=\"number\">2</span>, COLUMN_NAME, <span class=\"literal\">NULL</span>)) CNAME2,</span><br><span class=\"line\">               <span class=\"keyword\">MAX</span>(<span class=\"keyword\">DECODE</span>(<span class=\"keyword\">POSITION</span>, <span class=\"number\">3</span>, COLUMN_NAME, <span class=\"literal\">NULL</span>)) CNAME3,</span><br><span class=\"line\">               <span class=\"keyword\">MAX</span>(<span class=\"keyword\">DECODE</span>(<span class=\"keyword\">POSITION</span>, <span class=\"number\">4</span>, COLUMN_NAME, <span class=\"literal\">NULL</span>)) CNAME4,</span><br><span class=\"line\">               <span class=\"keyword\">MAX</span>(<span class=\"keyword\">DECODE</span>(<span class=\"keyword\">POSITION</span>, <span class=\"number\">5</span>, COLUMN_NAME, <span class=\"literal\">NULL</span>)) CNAME5,</span><br><span class=\"line\">               <span class=\"keyword\">MAX</span>(<span class=\"keyword\">DECODE</span>(<span class=\"keyword\">POSITION</span>, <span class=\"number\">6</span>, COLUMN_NAME, <span class=\"literal\">NULL</span>)) CNAME6,</span><br><span class=\"line\">               <span class=\"keyword\">MAX</span>(<span class=\"keyword\">DECODE</span>(<span class=\"keyword\">POSITION</span>, <span class=\"number\">7</span>, COLUMN_NAME, <span class=\"literal\">NULL</span>)) CNAME7,</span><br><span class=\"line\">               <span class=\"keyword\">MAX</span>(<span class=\"keyword\">DECODE</span>(<span class=\"keyword\">POSITION</span>, <span class=\"number\">8</span>, COLUMN_NAME, <span class=\"literal\">NULL</span>)) CNAME8,</span><br><span class=\"line\">               <span class=\"keyword\">COUNT</span>(*) COL_CNT</span><br><span class=\"line\">          <span class=\"keyword\">FROM</span> (<span class=\"keyword\">SELECT</span> <span class=\"keyword\">SUBSTR</span>(TABLE_NAME, <span class=\"number\">1</span>, <span class=\"number\">30</span>) TABLE_NAME,</span><br><span class=\"line\">                       <span class=\"keyword\">SUBSTR</span>(CONSTRAINT_NAME, <span class=\"number\">1</span>, <span class=\"number\">30</span>) CONSTRAINT_NAME,</span><br><span class=\"line\">                       <span class=\"keyword\">SUBSTR</span>(COLUMN_NAME, <span class=\"number\">1</span>, <span class=\"number\">30</span>) COLUMN_NAME,</span><br><span class=\"line\">                       <span class=\"keyword\">POSITION</span></span><br><span class=\"line\">                  <span class=\"keyword\">FROM</span> USER_CONS_COLUMNS) A,</span><br><span class=\"line\">               USER_CONSTRAINTS B</span><br><span class=\"line\">         <span class=\"keyword\">WHERE</span> A.CONSTRAINT_NAME = B.CONSTRAINT_NAME</span><br><span class=\"line\">           <span class=\"keyword\">AND</span> B.CONSTRAINT_TYPE = <span class=\"string\">'R'</span></span><br><span class=\"line\">         <span class=\"keyword\">GROUP</span> <span class=\"keyword\">BY</span> B.TABLE_NAME, B.CONSTRAINT_NAME) CONS</span><br><span class=\"line\"> <span class=\"keyword\">WHERE</span> COL_CNT &gt; <span class=\"keyword\">ALL</span></span><br><span class=\"line\"> (<span class=\"keyword\">SELECT</span> <span class=\"keyword\">COUNT</span>(*)</span><br><span class=\"line\">          <span class=\"keyword\">FROM</span> USER_IND_COLUMNS I</span><br><span class=\"line\">         <span class=\"keyword\">WHERE</span> I.TABLE_NAME = CONS.TABLE_NAME</span><br><span class=\"line\">           <span class=\"keyword\">AND</span> I.COLUMN_NAME <span class=\"keyword\">IN</span> (CNAME1, CNAME2, CNAME3, CNAME4, CNAME5,</span><br><span class=\"line\">                CNAME6, CNAME7, CNAME8)</span><br><span class=\"line\">           <span class=\"keyword\">AND</span> I.COLUMN_POSITION &lt;= CONS.COL_CNT</span><br><span class=\"line\">         <span class=\"keyword\">GROUP</span> <span class=\"keyword\">BY</span> I.INDEX_NAME);</span><br></pre></td></tr></table></figure>\n\n<p>这是摘自TOM大师的语句，外键不加索引也是导致死锁的常见原因之一，因此对于主表经常进行更新删除操作的情况，外键一定要加索引。<br>至于外键未加索引是如何导致锁定的，以及为何加了索引后争用就消失了? 敬请关注enq: TM - contention解决之道——外键无索引导致锁争用 （下）</p>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"cjych78i90000f40eumrgqa5e","category_id":"cjych78ij0002f40et03sp1am","_id":"cjych78is0007f40euftf05wx"},{"post_id":"cjych78ie0001f40e0bk7gpwk","category_id":"cjych78ij0002f40et03sp1am","_id":"cjych78it0009f40e644jxcea"},{"post_id":"cjychiv180000ix0e5c5ef3y4","category_id":"cjychiv1c0001ix0epc19b6ta","_id":"cjychiv1i0004ix0ejs9ohtro"},{"post_id":"cjychzpx00000fn0el8prijnt","category_id":"cjychzpxf0002fn0ejgvyyu1f","_id":"cjychzpxl0006fn0egz30yb8e"},{"post_id":"cjychzpxc0001fn0ewt3mzsuu","category_id":"cjychzpxf0002fn0ejgvyyu1f","_id":"cjychzpxm0007fn0ezqo5g5f3"},{"post_id":"cjychzpy00008fn0ea4k3rgs2","category_id":"cjychzpxf0002fn0ejgvyyu1f","_id":"cjychzpy2000cfn0efzsqinal"}],"PostTag":[{"post_id":"cjyceelss0002e20e6dp50an7","tag_id":"cjyceelsy0006e20eo95d0mmj","_id":"cjyceelt00008e20etuep7iy4"},{"post_id":"cjych78i90000f40eumrgqa5e","tag_id":"cjych78in0003f40e8ru6mtpj","_id":"cjych78ir0006f40ep5ldvq9u"},{"post_id":"cjych78ie0001f40e0bk7gpwk","tag_id":"cjych78in0003f40e8ru6mtpj","_id":"cjych78is0008f40elp260zui"},{"post_id":"cjychiv180000ix0e5c5ef3y4","tag_id":"cjychiv1h0002ix0eu964fv36","_id":"cjychiv1i0003ix0eb0q5vm6s"},{"post_id":"cjychzpx00000fn0el8prijnt","tag_id":"cjyceelsv0004e20e5zzn37ju","_id":"cjychzpxh0003fn0eel5n8o0c"},{"post_id":"cjychzpxc0001fn0ewt3mzsuu","tag_id":"cjyceelsv0004e20e5zzn37ju","_id":"cjychzpxh0004fn0ejb2et60e"},{"post_id":"cjychzpy00008fn0ea4k3rgs2","tag_id":"cjyceelsv0004e20e5zzn37ju","_id":"cjychzpy2000afn0eiz45qk4l"},{"post_id":"cjychzpy10009fn0e4xcz3p54","tag_id":"cjyceelsv0004e20e5zzn37ju","_id":"cjychzpy2000bfn0e52jmzna0"}],"Tag":[{"name":"oracle","_id":"cjyceelsv0004e20e5zzn37ju"},{"name":"test","_id":"cjyceelsy0006e20eo95d0mmj"},{"name":"oracle backup","_id":"cjych78in0003f40e8ru6mtpj"},{"name":"oracle restore","_id":"cjychiv1h0002ix0eu964fv36"}]}}